# Comparing `tmp/tinybird-cli-3.8.1.dev1.tar.gz` & `tmp/tinybird-cli-3.8.2.dev1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "tinybird-cli-3.8.1.dev1.tar", last modified: Mon Apr 15 08:36:57 2024, max compression
+gzip compressed data, was "tinybird-cli-3.8.2.dev1.tar", last modified: Wed Apr 17 19:14:24 2024, max compression
```

## Comparing `tinybird-cli-3.8.1.dev1.tar` & `tinybird-cli-3.8.2.dev1.tar`

### file list

```diff
@@ -1,52 +1,52 @@
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 08:36:57.838098 tinybird-cli-3.8.1.dev1/
--rw-r--r--   0 root         (0) root         (0)    68035 2024-04-15 08:36:57.838098 tinybird-cli-3.8.1.dev1/PKG-INFO
--rw-r--r--   0 root         (0) root         (0)       38 2024-04-15 08:36:57.838098 tinybird-cli-3.8.1.dev1/setup.cfg
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 08:36:57.835098 tinybird-cli-3.8.1.dev1/tinybird/
--rw-rw-rw-   0 root         (0) root         (0)      254 2024-04-15 08:36:57.000000 tinybird-cli-3.8.1.dev1/tinybird/__cli__.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 08:36:57.835098 tinybird-cli-3.8.1.dev1/tinybird/ch_utils/
--rw-rw-rw-   0 root         (0) root         (0)     3657 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/ch_utils/constants.py
--rw-rw-rw-   0 root         (0) root         (0)    39699 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/ch_utils/engine.py
--rw-rw-rw-   0 root         (0) root         (0)      975 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/check_pypi.py
--rw-rw-rw-   0 root         (0) root         (0)    46575 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/client.py
--rw-rw-rw-   0 root         (0) root         (0)     2003 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/config.py
--rw-rw-rw-   0 root         (0) root         (0)    15244 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/connectors.py
--rw-rw-rw-   0 root         (0) root         (0)      845 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/context.py
--rw-rw-rw-   0 root         (0) root         (0)   212073 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/datafile.py
--rw-rw-rw-   0 root         (0) root         (0)     7060 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/datatypes.py
--rw-rw-rw-   0 root         (0) root         (0)    59111 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/feedback_manager.py
--rw-rw-rw-   0 root         (0) root         (0)     4707 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/git_settings.py
--rw-rw-rw-   0 root         (0) root         (0)    41181 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/sql.py
--rw-rw-rw-   0 root         (0) root         (0)    76994 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/sql_template.py
--rw-rw-rw-   0 root         (0) root         (0)    10196 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/sql_template_fmt.py
--rw-rw-rw-   0 root         (0) root         (0)    11523 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/sql_toolset.py
--rw-rw-rw-   0 root         (0) root         (0)    27763 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/syncasync.py
--rw-rw-rw-   0 root         (0) root         (0)      674 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 08:36:57.837098 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/
--rw-rw-rw-   0 root         (0) root         (0)     8601 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/auth.py
--rw-rw-rw-   0 root         (0) root         (0)    37863 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/branch.py
--rw-rw-rw-   0 root         (0) root         (0)    14087 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/cicd.py
--rw-rw-rw-   0 root         (0) root         (0)    64836 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/cli.py
--rw-rw-rw-   0 root         (0) root         (0)    78344 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/common.py
--rw-rw-rw-   0 root         (0) root         (0)    11484 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/config.py
--rw-rw-rw-   0 root         (0) root         (0)    29931 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/connection.py
--rw-rw-rw-   0 root         (0) root         (0)    31944 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/datasource.py
--rw-rw-rw-   0 root         (0) root         (0)     3367 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/exceptions.py
--rw-rw-rw-   0 root         (0) root         (0)     2964 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/job.py
--rw-rw-rw-   0 root         (0) root         (0)    26155 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/pipe.py
--rw-rw-rw-   0 root         (0) root         (0)     2010 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/regions.py
--rw-rw-rw-   0 root         (0) root         (0)    10490 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/telemetry.py
--rw-rw-rw-   0 root         (0) root         (0)     4223 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/test.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 08:36:57.837098 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/tinyunit/
--rw-rw-rw-   0 root         (0) root         (0)    11667 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/tinyunit/tinyunit.py
--rw-rw-rw-   0 root         (0) root         (0)     1868 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/tinyunit/tinyunit_lib.py
--rw-rw-rw-   0 root         (0) root         (0)     4383 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/token.py
--rw-rw-rw-   0 root         (0) root         (0)    10081 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/workspace.py
--rw-rw-rw-   0 root         (0) root         (0)     8268 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/workspace_members.py
--rw-rw-rw-   0 root         (0) root         (0)    41982 2024-04-15 08:36:52.000000 tinybird-cli-3.8.1.dev1/tinybird/tornado_template.py
-drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-15 08:36:57.838098 tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/
--rw-r--r--   0 root         (0) root         (0)    68035 2024-04-15 08:36:57.000000 tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/PKG-INFO
--rw-r--r--   0 root         (0) root         (0)     1348 2024-04-15 08:36:57.000000 tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/SOURCES.txt
--rw-r--r--   0 root         (0) root         (0)        1 2024-04-15 08:36:57.000000 tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/dependency_links.txt
--rw-r--r--   0 root         (0) root         (0)       43 2024-04-15 08:36:57.000000 tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/entry_points.txt
--rw-r--r--   0 root         (0) root         (0)      732 2024-04-15 08:36:57.000000 tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/requires.txt
--rw-r--r--   0 root         (0) root         (0)       45 2024-04-15 08:36:57.000000 tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/top_level.txt
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-17 19:14:24.289412 tinybird-cli-3.8.2.dev1/
+-rw-r--r--   0 root         (0) root         (0)    68195 2024-04-17 19:14:24.289412 tinybird-cli-3.8.2.dev1/PKG-INFO
+-rw-r--r--   0 root         (0) root         (0)       38 2024-04-17 19:14:24.289412 tinybird-cli-3.8.2.dev1/setup.cfg
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-17 19:14:24.286412 tinybird-cli-3.8.2.dev1/tinybird/
+-rw-rw-rw-   0 root         (0) root         (0)      254 2024-04-17 19:14:23.000000 tinybird-cli-3.8.2.dev1/tinybird/__cli__.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-17 19:14:24.287412 tinybird-cli-3.8.2.dev1/tinybird/ch_utils/
+-rw-rw-rw-   0 root         (0) root         (0)     3657 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/ch_utils/constants.py
+-rw-rw-rw-   0 root         (0) root         (0)    39699 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/ch_utils/engine.py
+-rw-rw-rw-   0 root         (0) root         (0)      975 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/check_pypi.py
+-rw-rw-rw-   0 root         (0) root         (0)    46575 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/client.py
+-rw-rw-rw-   0 root         (0) root         (0)     2003 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/config.py
+-rw-rw-rw-   0 root         (0) root         (0)    15244 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/connectors.py
+-rw-rw-rw-   0 root         (0) root         (0)      845 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/context.py
+-rw-rw-rw-   0 root         (0) root         (0)   212510 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/datafile.py
+-rw-rw-rw-   0 root         (0) root         (0)     7060 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/datatypes.py
+-rw-rw-rw-   0 root         (0) root         (0)    59111 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/feedback_manager.py
+-rw-rw-rw-   0 root         (0) root         (0)     4707 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/git_settings.py
+-rw-rw-rw-   0 root         (0) root         (0)    41181 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/sql.py
+-rw-rw-rw-   0 root         (0) root         (0)    76994 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/sql_template.py
+-rw-rw-rw-   0 root         (0) root         (0)    10196 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/sql_template_fmt.py
+-rw-rw-rw-   0 root         (0) root         (0)    11523 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/sql_toolset.py
+-rw-rw-rw-   0 root         (0) root         (0)    27763 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/syncasync.py
+-rw-rw-rw-   0 root         (0) root         (0)      674 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-17 19:14:24.288412 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/
+-rw-rw-rw-   0 root         (0) root         (0)     8601 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/auth.py
+-rw-rw-rw-   0 root         (0) root         (0)    37863 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/branch.py
+-rw-rw-rw-   0 root         (0) root         (0)    14087 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/cicd.py
+-rw-rw-rw-   0 root         (0) root         (0)    64868 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/cli.py
+-rw-rw-rw-   0 root         (0) root         (0)    78344 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/common.py
+-rw-rw-rw-   0 root         (0) root         (0)    11484 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/config.py
+-rw-rw-rw-   0 root         (0) root         (0)    29931 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/connection.py
+-rw-rw-rw-   0 root         (0) root         (0)    31944 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/datasource.py
+-rw-rw-rw-   0 root         (0) root         (0)     3367 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/exceptions.py
+-rw-rw-rw-   0 root         (0) root         (0)     2964 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/job.py
+-rw-rw-rw-   0 root         (0) root         (0)    26155 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/pipe.py
+-rw-rw-rw-   0 root         (0) root         (0)     2010 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/regions.py
+-rw-rw-rw-   0 root         (0) root         (0)    10490 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/telemetry.py
+-rw-rw-rw-   0 root         (0) root         (0)     4223 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/test.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-17 19:14:24.288412 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/tinyunit/
+-rw-rw-rw-   0 root         (0) root         (0)    11667 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/tinyunit/tinyunit.py
+-rw-rw-rw-   0 root         (0) root         (0)     1868 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/tinyunit/tinyunit_lib.py
+-rw-rw-rw-   0 root         (0) root         (0)     4383 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/token.py
+-rw-rw-rw-   0 root         (0) root         (0)    10081 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/workspace.py
+-rw-rw-rw-   0 root         (0) root         (0)     8268 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/workspace_members.py
+-rw-rw-rw-   0 root         (0) root         (0)    41982 2024-04-17 19:14:18.000000 tinybird-cli-3.8.2.dev1/tinybird/tornado_template.py
+drwxr-xr-x   0 root         (0) root         (0)        0 2024-04-17 19:14:24.289412 tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/
+-rw-r--r--   0 root         (0) root         (0)    68195 2024-04-17 19:14:24.000000 tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/PKG-INFO
+-rw-r--r--   0 root         (0) root         (0)     1348 2024-04-17 19:14:24.000000 tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/SOURCES.txt
+-rw-r--r--   0 root         (0) root         (0)        1 2024-04-17 19:14:24.000000 tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/dependency_links.txt
+-rw-r--r--   0 root         (0) root         (0)       43 2024-04-17 19:14:24.000000 tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/entry_points.txt
+-rw-r--r--   0 root         (0) root         (0)      732 2024-04-17 19:14:24.000000 tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/requires.txt
+-rw-r--r--   0 root         (0) root         (0)       45 2024-04-17 19:14:24.000000 tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/top_level.txt
```

### Comparing `tinybird-cli-3.8.1.dev1/PKG-INFO` & `tinybird-cli-3.8.2.dev1/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: tinybird-cli
-Version: 3.8.1.dev1
+Version: 3.8.2.dev1
 Summary: Tinybird Command Line Tool
 Home-page: https://www.tinybird.co/docs/cli/introduction.html
 Author: Tinybird
 Author-email: support@tinybird.co
 Requires-Python: >=3.8, <3.12
 Description-Content-Type: text/x-rst
 Provides-Extra: bigquery
@@ -15,14 +15,20 @@
 
 The Tinybird command-line tool allows you to use all the Tinybird functionality directly from the command line. Additionally, it includes several functions to create and manage data projects easily.
 
 Changelog
 
 ---------
 
+3.8.1
+************
+
+- `Fixed` Avoid system vars evaluation when doing `tb fmt`
+- `Fixed` environment variables substitution for Data Source engine parameters.
+
 3.8.0
 ************
 
 - `Added` Support for S3IAM role for ingest
 - `Changed` Upgrade clickhouse-toolset to 0.30dev0
 - `Changed` Decouple cli from connector_settings module
```

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/ch_utils/constants.py` & `tinybird-cli-3.8.2.dev1/tinybird/ch_utils/constants.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/ch_utils/engine.py` & `tinybird-cli-3.8.2.dev1/tinybird/ch_utils/engine.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/check_pypi.py` & `tinybird-cli-3.8.2.dev1/tinybird/check_pypi.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/client.py` & `tinybird-cli-3.8.2.dev1/tinybird/client.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/config.py` & `tinybird-cli-3.8.2.dev1/tinybird/config.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/connectors.py` & `tinybird-cli-3.8.2.dev1/tinybird/connectors.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/context.py` & `tinybird-cli-3.8.2.dev1/tinybird/context.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/datafile.py` & `tinybird-cli-3.8.2.dev1/tinybird/datafile.py`

 * *Files 1% similar despite different names*

```diff
@@ -1818,11438 +1818,11465 @@
 00007190: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
 000071a0: 6966 2073 656c 662e 6e6f 6465 735b 695d  if self.nodes[i]
 000071b0: 2021 3d20 6f74 6865 722e 6e6f 6465 735b   != other.nodes[
 000071c0: 695d 3a0a 2020 2020 2020 2020 2020 2020  i]:.            
 000071d0: 2020 2020 7265 7475 726e 2046 616c 7365      return False
 000071e0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
 000071f0: 2054 7275 650a 0a0a 6465 6620 7061 7273   True...def pars
-00007200: 655f 6461 7461 736f 7572 6365 2866 696c  e_datasource(fil
-00007210: 656e 616d 653a 2073 7472 2c20 7265 706c  ename: str, repl
-00007220: 6163 655f 696e 636c 7564 6573 3a20 626f  ace_includes: bo
-00007230: 6f6c 203d 2054 7275 652c 2063 6f6e 7465  ol = True, conte
-00007240: 6e74 3a20 4f70 7469 6f6e 616c 5b73 7472  nt: Optional[str
-00007250: 5d20 3d20 4e6f 6e65 2920 2d3e 2044 6174  ] = None) -> Dat
-00007260: 6166 696c 653a 0a20 2020 2062 6173 6570  afile:.    basep
-00007270: 6174 6820 3d20 2222 0a20 2020 2069 6620  ath = "".    if 
-00007280: 6e6f 7420 636f 6e74 656e 743a 0a20 2020  not content:.   
-00007290: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
-000072a0: 696c 656e 616d 6529 2061 7320 6669 6c65  ilename) as file
-000072b0: 3a0a 2020 2020 2020 2020 2020 2020 7320  :.            s 
-000072c0: 3d20 6669 6c65 2e72 6561 6428 290a 2020  = file.read().  
-000072d0: 2020 2020 2020 6261 7365 7061 7468 203d        basepath =
-000072e0: 206f 732e 7061 7468 2e64 6972 6e61 6d65   os.path.dirname
-000072f0: 2866 696c 656e 616d 6529 0a20 2020 2065  (filename).    e
-00007300: 6c73 653a 0a20 2020 2020 2020 2073 203d  lse:.        s =
-00007310: 2063 6f6e 7465 6e74 0a0a 2020 2020 7472   content..    tr
-00007320: 793a 0a20 2020 2020 2020 2064 6f63 203d  y:.        doc =
-00007330: 2070 6172 7365 2873 2c20 2264 6566 6175   parse(s, "defau
-00007340: 6c74 222c 2062 6173 6570 6174 682c 2072  lt", basepath, r
-00007350: 6570 6c61 6365 5f69 6e63 6c75 6465 733d  eplace_includes=
-00007360: 7265 706c 6163 655f 696e 636c 7564 6573  replace_includes
-00007370: 290a 2020 2020 6578 6365 7074 2050 6172  ).    except Par
-00007380: 7365 4578 6365 7074 696f 6e20 6173 2065  seException as e
-00007390: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-000073a0: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
-000073b0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-000073c0: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
-000073d0: 722e 6572 726f 725f 7061 7273 696e 675f  r.error_parsing_
-000073e0: 6669 6c65 2866 696c 656e 616d 653d 6669  file(filename=fi
-000073f0: 6c65 6e61 6d65 2c20 6c69 6e65 6e6f 3d65  lename, lineno=e
-00007400: 2e6c 696e 656e 6f2c 2065 7272 6f72 3d65  .lineno, error=e
-00007410: 290a 2020 2020 2020 2020 2920 6672 6f6d  ).        ) from
-00007420: 204e 6f6e 650a 0a20 2020 2069 6620 6c65   None..    if le
-00007430: 6e28 646f 632e 6e6f 6465 7329 203e 2031  n(doc.nodes) > 1
-00007440: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00007450: 5661 6c75 6545 7272 6f72 2866 227b 6669  ValueError(f"{fi
-00007460: 6c65 6e61 6d65 7d3a 2064 6174 6173 6f75  lename}: datasou
-00007470: 7263 6573 2063 616e 2774 2068 6176 6520  rces can't have 
-00007480: 6d6f 7265 2074 6861 6e20 6f6e 6520 6e6f  more than one no
-00007490: 6465 2229 0a0a 2020 2020 7265 7475 726e  de")..    return
-000074a0: 2064 6f63 0a0a 0a64 6566 2070 6172 7365   doc...def parse
-000074b0: 5f70 6970 6528 6669 6c65 6e61 6d65 3a20  _pipe(filename: 
-000074c0: 7374 722c 2072 6570 6c61 6365 5f69 6e63  str, replace_inc
-000074d0: 6c75 6465 733a 2062 6f6f 6c20 3d20 5472  ludes: bool = Tr
-000074e0: 7565 2c20 636f 6e74 656e 743a 204f 7074  ue, content: Opt
-000074f0: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00007500: 6529 202d 3e20 4461 7461 6669 6c65 3a0a  e) -> Datafile:.
-00007510: 2020 2020 6261 7365 7061 7468 203d 2022      basepath = "
-00007520: 220a 2020 2020 6966 206e 6f74 2063 6f6e  ".    if not con
-00007530: 7465 6e74 3a0a 2020 2020 2020 2020 7769  tent:.        wi
-00007540: 7468 206f 7065 6e28 6669 6c65 6e61 6d65  th open(filename
-00007550: 2920 6173 2066 696c 653a 0a20 2020 2020  ) as file:.     
-00007560: 2020 2020 2020 2073 203d 2066 696c 652e         s = file.
-00007570: 7265 6164 2829 0a20 2020 2020 2020 2062  read().        b
-00007580: 6173 6570 6174 6820 3d20 6f73 2e70 6174  asepath = os.pat
-00007590: 682e 6469 726e 616d 6528 6669 6c65 6e61  h.dirname(filena
-000075a0: 6d65 290a 2020 2020 656c 7365 3a0a 2020  me).    else:.  
-000075b0: 2020 2020 2020 7320 3d20 636f 6e74 656e        s = conten
-000075c0: 740a 0a20 2020 2074 7279 3a0a 2020 2020  t..    try:.    
-000075d0: 2020 2020 7371 6c20 3d20 2222 0a20 2020      sql = "".   
-000075e0: 2020 2020 2064 6f63 203d 2070 6172 7365       doc = parse
-000075f0: 2873 2c20 6261 7365 7061 7468 3d62 6173  (s, basepath=bas
-00007600: 6570 6174 682c 2072 6570 6c61 6365 5f69  epath, replace_i
-00007610: 6e63 6c75 6465 733d 7265 706c 6163 655f  ncludes=replace_
-00007620: 696e 636c 7564 6573 290a 2020 2020 2020  includes).      
-00007630: 2020 666f 7220 6e6f 6465 2069 6e20 646f    for node in do
-00007640: 632e 6e6f 6465 733a 0a20 2020 2020 2020  c.nodes:.       
-00007650: 2020 2020 2073 716c 203d 206e 6f64 652e       sql = node.
-00007660: 6765 7428 2273 716c 222c 2022 2229 0a20  get("sql", ""). 
-00007670: 2020 2020 2020 2020 2020 2069 6620 7371             if sq
-00007680: 6c2e 7374 7269 7028 295b 305d 203d 3d20  l.strip()[0] == 
-00007690: 2225 223a 0a20 2020 2020 2020 2020 2020  "%":.           
-000076a0: 2020 2020 2073 716c 2c20 5f20 3d20 7265       sql, _ = re
-000076b0: 6e64 6572 5f73 716c 5f74 656d 706c 6174  nder_sql_templat
-000076c0: 6528 7371 6c5b 313a 5d2c 2074 6573 745f  e(sql[1:], test_
-000076d0: 6d6f 6465 3d54 7275 652c 206e 616d 653d  mode=True, name=
-000076e0: 6e6f 6465 5b22 6e61 6d65 225d 290a 2020  node["name"]).  
-000076f0: 2020 2020 2020 2020 2020 2320 6974 276c            # it'l
-00007700: 6c20 6661 696c 2077 6974 6820 6120 4d6f  l fail with a Mo
-00007710: 6475 6c65 4e6f 7446 6f75 6e64 4572 726f  duleNotFoundErro
-00007720: 7220 7768 656e 2074 6865 2074 6f6f 6c73  r when the tools
-00007730: 6574 2069 7320 6e6f 7420 6176 6169 6c61  et is not availa
-00007740: 626c 6520 6275 7420 6974 2072 6574 7572  ble but it retur
-00007750: 6e73 2074 6865 2070 6172 7365 6420 646f  ns the parsed do
-00007760: 630a 2020 2020 2020 2020 2020 2020 6672  c.            fr
-00007770: 6f6d 2074 696e 7962 6972 642e 7371 6c5f  om tinybird.sql_
-00007780: 746f 6f6c 7365 7420 696d 706f 7274 2066  toolset import f
-00007790: 6f72 6d61 745f 7371 6c20 6173 2074 6f6f  ormat_sql as too
-000077a0: 6c73 6574 5f66 6f72 6d61 745f 7371 6c0a  lset_format_sql.
-000077b0: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-000077c0: 6c73 6574 5f66 6f72 6d61 745f 7371 6c28  lset_format_sql(
-000077d0: 7371 6c29 0a20 2020 2065 7863 6570 7420  sql).    except 
-000077e0: 5061 7273 6545 7863 6570 7469 6f6e 2061  ParseException a
-000077f0: 7320 653a 0a20 2020 2020 2020 2072 6169  s e:.        rai
-00007800: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
-00007810: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
-00007820: 2020 2020 2046 6565 6462 6163 6b4d 616e       FeedbackMan
-00007830: 6167 6572 2e65 7272 6f72 5f70 6172 7369  ager.error_parsi
-00007840: 6e67 5f66 696c 6528 0a20 2020 2020 2020  ng_file(.       
-00007850: 2020 2020 2020 2020 2066 696c 656e 616d           filenam
-00007860: 653d 6669 6c65 6e61 6d65 2c20 6c69 6e65  e=filename, line
-00007870: 6e6f 3d65 2e6c 696e 656e 6f2c 2065 7272  no=e.lineno, err
-00007880: 6f72 3d66 227b 7374 7228 6529 7d20 2b20  or=f"{str(e)} + 
-00007890: 5351 4c28 7061 7273 6520 6578 6365 7074  SQL(parse except
-000078a0: 696f 6e29 3a20 7b73 716c 7d22 0a20 2020  ion): {sql}".   
-000078b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000078c0: 2020 2029 0a20 2020 2065 7863 6570 7420     ).    except 
-000078d0: 5661 6c75 6545 7272 6f72 2061 7320 653a  ValueError as e:
-000078e0: 0a20 2020 2020 2020 2074 2c20 7465 6d70  .        t, temp
-000078f0: 6c61 7465 5f76 6172 6961 626c 6573 203d  late_variables =
-00007900: 2067 6574 5f74 656d 706c 6174 655f 616e   get_template_an
-00007910: 645f 7661 7269 6162 6c65 7328 7371 6c2c  d_variables(sql,
-00007920: 206e 616d 653d 6e6f 6465 5b22 6e61 6d65   name=node["name
-00007930: 225d 290a 0a20 2020 2020 2020 2069 6620  "])..        if 
-00007940: 7371 6c2e 7374 7269 7028 295b 305d 2021  sql.strip()[0] !
-00007950: 3d20 2225 2220 616e 6420 6c65 6e28 7465  = "%" and len(te
-00007960: 6d70 6c61 7465 5f76 6172 6961 626c 6573  mplate_variables
-00007970: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-00007980: 2020 2072 6169 7365 2063 6c69 636b 2e43     raise click.C
-00007990: 6c69 636b 4578 6365 7074 696f 6e28 4665  lickException(Fe
-000079a0: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
-000079b0: 726f 725f 7465 6d70 6c61 7465 5f73 7461  ror_template_sta
-000079c0: 7274 2866 696c 656e 616d 653d 6669 6c65  rt(filename=file
-000079d0: 6e61 6d65 2929 0a20 2020 2020 2020 2072  name)).        r
-000079e0: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
-000079f0: 4578 6365 7074 696f 6e28 0a20 2020 2020  Exception(.     
-00007a00: 2020 2020 2020 2046 6565 6462 6163 6b4d         FeedbackM
-00007a10: 616e 6167 6572 2e65 7272 6f72 5f70 6172  anager.error_par
-00007a20: 7369 6e67 5f66 696c 6528 0a20 2020 2020  sing_file(.     
-00007a30: 2020 2020 2020 2020 2020 2066 696c 656e             filen
-00007a40: 616d 653d 6669 6c65 6e61 6d65 2c20 6c69  ame=filename, li
-00007a50: 6e65 6e6f 3d22 222c 2065 7272 6f72 3d66  neno="", error=f
-00007a60: 227b 7374 7228 6529 7d20 2b20 5351 4c28  "{str(e)} + SQL(
-00007a70: 7661 6c75 6520 6572 726f 7229 3a20 7b73  value error): {s
-00007a80: 716c 7d22 0a20 2020 2020 2020 2020 2020  ql}".           
-00007a90: 2029 0a20 2020 2020 2020 2029 0a20 2020   ).        ).   
-00007aa0: 2065 7863 6570 7420 556e 436c 6f73 6564   except UnClosed
-00007ab0: 4966 4572 726f 7220 6173 2065 3a0a 2020  IfError as e:.  
-00007ac0: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
-00007ad0: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
-00007ae0: 280a 2020 2020 2020 2020 2020 2020 4665  (.            Fe
-00007af0: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
-00007b00: 726f 725f 7061 7273 696e 675f 6e6f 6465  ror_parsing_node
-00007b10: 5f77 6974 685f 756e 636c 6f73 6564 5f69  _with_unclosed_i
-00007b20: 6628 6e6f 6465 3d65 2e6e 6f64 652c 2070  f(node=e.node, p
-00007b30: 6970 653d 6669 6c65 6e61 6d65 2c20 6c69  ipe=filename, li
-00007b40: 6e65 6e6f 3d65 2e6c 696e 656e 6f2c 2073  neno=e.lineno, s
-00007b50: 716c 3d65 2e73 716c 290a 2020 2020 2020  ql=e.sql).      
-00007b60: 2020 290a 2020 2020 6578 6365 7074 204d    ).    except M
-00007b70: 6f64 756c 654e 6f74 466f 756e 6445 7272  oduleNotFoundErr
-00007b80: 6f72 3a0a 2020 2020 2020 2020 7061 7373  or:.        pass
-00007b90: 0a0a 2020 2020 7265 7475 726e 2064 6f63  ..    return doc
-00007ba0: 0a0a 0a64 6566 2070 6172 7365 5f74 6f6b  ...def parse_tok
-00007bb0: 656e 2866 696c 656e 616d 653a 2073 7472  en(filename: str
-00007bc0: 2c20 7265 706c 6163 655f 696e 636c 7564  , replace_includ
-00007bd0: 6573 3a20 626f 6f6c 203d 2054 7275 652c  es: bool = True,
-00007be0: 2063 6f6e 7465 6e74 3a20 4f70 7469 6f6e   content: Option
-00007bf0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2920  al[str] = None) 
-00007c00: 2d3e 2044 6174 6166 696c 653a 0a20 2020  -> Datafile:.   
-00007c10: 2069 6620 6e6f 7420 636f 6e74 656e 743a   if not content:
-00007c20: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
-00007c30: 656e 2866 696c 656e 616d 6529 2061 7320  en(filename) as 
-00007c40: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
-00007c50: 2020 7320 3d20 6669 6c65 2e72 6561 6428    s = file.read(
-00007c60: 290a 2020 2020 2020 2020 6261 7365 7061  ).        basepa
-00007c70: 7468 203d 206f 732e 7061 7468 2e64 6972  th = os.path.dir
-00007c80: 6e61 6d65 2866 696c 656e 616d 6529 0a20  name(filename). 
-00007c90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00007ca0: 2073 203d 2063 6f6e 7465 6e74 0a0a 2020   s = content..  
-00007cb0: 2020 7472 793a 0a20 2020 2020 2020 2073    try:.        s
-00007cc0: 716c 203d 2022 220a 2020 2020 2020 2020  ql = "".        
-00007cd0: 646f 6320 3d20 7061 7273 6528 732c 2062  doc = parse(s, b
-00007ce0: 6173 6570 6174 683d 6261 7365 7061 7468  asepath=basepath
-00007cf0: 2c20 7265 706c 6163 655f 696e 636c 7564  , replace_includ
-00007d00: 6573 3d72 6570 6c61 6365 5f69 6e63 6c75  es=replace_inclu
-00007d10: 6465 7329 0a20 2020 2065 7863 6570 7420  des).    except 
-00007d20: 5061 7273 6545 7863 6570 7469 6f6e 2061  ParseException a
-00007d30: 7320 653a 0a20 2020 2020 2020 2072 6169  s e:.        rai
-00007d40: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
-00007d50: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
-00007d60: 2020 2020 2046 6565 6462 6163 6b4d 616e       FeedbackMan
-00007d70: 6167 6572 2e65 7272 6f72 5f70 6172 7369  ager.error_parsi
-00007d80: 6e67 5f66 696c 6528 0a20 2020 2020 2020  ng_file(.       
-00007d90: 2020 2020 2020 2020 2066 696c 656e 616d           filenam
-00007da0: 653d 6669 6c65 6e61 6d65 2c20 6c69 6e65  e=filename, line
-00007db0: 6e6f 3d65 2e6c 696e 656e 6f2c 2065 7272  no=e.lineno, err
-00007dc0: 6f72 3d66 227b 7374 7228 6529 7d20 2b20  or=f"{str(e)} + 
-00007dd0: 5351 4c28 7061 7273 6520 6578 6365 7074  SQL(parse except
-00007de0: 696f 6e29 3a20 7b73 716c 7d22 0a20 2020  ion): {sql}".   
-00007df0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00007e00: 2020 2029 0a20 2020 2065 7863 6570 7420     ).    except 
-00007e10: 5661 6c75 6545 7272 6f72 2061 7320 653a  ValueError as e:
-00007e20: 0a20 2020 2020 2020 2072 6169 7365 2063  .        raise c
-00007e30: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
-00007e40: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-00007e50: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
-00007e60: 2e65 7272 6f72 5f70 6172 7369 6e67 5f66  .error_parsing_f
-00007e70: 696c 6528 0a20 2020 2020 2020 2020 2020  ile(.           
-00007e80: 2020 2020 2066 696c 656e 616d 653d 6669       filename=fi
-00007e90: 6c65 6e61 6d65 2c20 6c69 6e65 6e6f 3d22  lename, lineno="
-00007ea0: 222c 2065 7272 6f72 3d66 227b 7374 7228  ", error=f"{str(
-00007eb0: 6529 7d20 2b20 5351 4c28 7661 6c75 6520  e)} + SQL(value 
-00007ec0: 6572 726f 7229 3a20 7b73 716c 7d22 0a20  error): {sql}". 
-00007ed0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00007ee0: 2020 2020 2029 0a20 2020 2065 7863 6570       ).    excep
-00007ef0: 7420 556e 436c 6f73 6564 4966 4572 726f  t UnClosedIfErro
-00007f00: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
-00007f10: 7261 6973 6520 636c 6963 6b2e 436c 6963  raise click.Clic
-00007f20: 6b45 7863 6570 7469 6f6e 280a 2020 2020  kException(.    
-00007f30: 2020 2020 2020 2020 4665 6564 6261 636b          Feedback
-00007f40: 4d61 6e61 6765 722e 6572 726f 725f 7061  Manager.error_pa
-00007f50: 7273 696e 675f 6e6f 6465 5f77 6974 685f  rsing_node_with_
-00007f60: 756e 636c 6f73 6564 5f69 6628 6e6f 6465  unclosed_if(node
-00007f70: 3d65 2e6e 6f64 652c 2070 6970 653d 6669  =e.node, pipe=fi
-00007f80: 6c65 6e61 6d65 2c20 6c69 6e65 6e6f 3d65  lename, lineno=e
-00007f90: 2e6c 696e 656e 6f2c 2073 716c 3d65 2e73  .lineno, sql=e.s
-00007fa0: 716c 290a 2020 2020 2020 2020 290a 2020  ql).        ).  
-00007fb0: 2020 6578 6365 7074 204d 6f64 756c 654e    except ModuleN
-00007fc0: 6f74 466f 756e 6445 7272 6f72 3a0a 2020  otFoundError:.  
-00007fd0: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00007fe0: 7265 7475 726e 2064 6f63 0a0a 0a64 6566  return doc...def
-00007ff0: 205f 756e 7175 6f74 6528 783a 2073 7472   _unquote(x: str
-00008000: 293a 0a20 2020 2051 554f 5445 5320 3d20  ):.    QUOTES = 
-00008010: 2827 2227 2c20 2227 2229 0a20 2020 2069  ('"', "'").    i
-00008020: 6620 785b 305d 2069 6e20 5155 4f54 4553  f x[0] in QUOTES
-00008030: 2061 6e64 2078 5b2d 315d 2069 6e20 5155   and x[-1] in QU
-00008040: 4f54 4553 3a0a 2020 2020 2020 2020 7820  OTES:.        x 
-00008050: 3d20 785b 313a 2d31 5d0a 2020 2020 7265  = x[1:-1].    re
-00008060: 7475 726e 2078 0a0a 0a64 6566 2065 7661  turn x...def eva
-00008070: 6c5f 7661 7228 733a 2073 7472 2920 2d3e  l_var(s: str) ->
-00008080: 2073 7472 3a0a 2020 2020 2320 7265 706c   str:.    # repl
-00008090: 6163 6520 454e 5620 7661 7269 6162 6c65  ace ENV variable
-000080a0: 730a 2020 2020 2320 6974 2773 2070 726f  s.    # it's pro
-000080b0: 6261 626c 7920 6120 6261 6420 6964 6561  bably a bad idea
-000080c0: 2074 6f20 616c 6c6f 7720 746f 2067 6574   to allow to get
-000080d0: 2061 6e79 2065 6e76 2076 6172 0a20 2020   any env var.   
-000080e0: 2072 6574 7572 6e20 5465 6d70 6c61 7465   return Template
-000080f0: 2873 292e 7361 6665 5f73 7562 7374 6974  (s).safe_substit
-00008100: 7574 6528 6f73 2e65 6e76 6972 6f6e 290a  ute(os.environ).
-00008110: 0a0a 6465 6620 7061 7273 6528 0a20 2020  ..def parse(.   
-00008120: 2073 3a20 7374 722c 2064 6566 6175 6c74   s: str, default
-00008130: 5f6e 6f64 653a 204f 7074 696f 6e61 6c5b  _node: Optional[
-00008140: 7374 725d 203d 204e 6f6e 652c 2062 6173  str] = None, bas
-00008150: 6570 6174 683a 2073 7472 203d 2022 2e22  epath: str = "."
-00008160: 2c20 7265 706c 6163 655f 696e 636c 7564  , replace_includ
-00008170: 6573 3a20 626f 6f6c 203d 2054 7275 650a  es: bool = True.
-00008180: 2920 2d3e 2044 6174 6166 696c 653a 2020  ) -> Datafile:  
-00008190: 2320 6e6f 7161 3a20 4339 3031 0a20 2020  # noqa: C901.   
-000081a0: 2022 2222 0a20 2020 2050 6172 7365 7320   """.    Parses 
-000081b0: 6073 6020 7374 7269 6e67 2069 6e74 6f20  `s` string into 
-000081c0: 6120 646f 6375 6d65 6e74 0a20 2020 203e  a document.    >
-000081d0: 3e3e 2064 203d 2070 6172 7365 2822 4652  >> d = parse("FR
-000081e0: 4f4d 2053 4352 4154 4348 5c5c 6e53 4f55  OM SCRATCH\\nSOU
-000081f0: 5243 4520 2768 7474 7073 3a2f 2f65 7861  RCE 'https://exa
-00008200: 6d70 6c65 2e63 6f6d 275c 5c6e 2374 6869  mple.com'\\n#thi
-00008210: 7320 6973 2061 2063 6f6d 6d65 6e74 5c5c  s is a comment\\
-00008220: 6e4d 4149 4e54 4149 4e45 5220 2772 616d  nMAINTAINER 'ram
-00008230: 626f 2720 2374 6869 7320 6973 206d 655c  bo' #this is me\
-00008240: 5c6e 4e4f 4445 205c 5c22 7465 7374 5f30  \nNODE \\"test_0
-00008250: 315c 5c22 5c5c 6e20 2020 2044 4553 4352  1\\"\\n    DESCR
-00008260: 4950 5449 4f4e 2074 6869 7320 6973 2061  IPTION this is a
-00008270: 206e 6f64 6520 7468 6174 2064 6f65 7320   node that does 
-00008280: 7768 6174 6576 6572 5c5c 6e53 514c 203e  whatever\\nSQL >
-00008290: 5c5c 6e5c 5c6e 2020 2020 2020 2020 5345  \\n\\n        SE
-000082a0: 4c45 4354 202a 2066 726f 6d20 7465 7374  LECT * from test
-000082b0: 5f30 305c 5c6e 5c5c 6e5c 5c6e 4e4f 4445  _00\\n\\n\\nNODE
-000082c0: 205c 5c22 7465 7374 5f30 325c 5c22 5c5c   \\"test_02\\"\\
-000082d0: 6e20 2020 2044 4553 4352 4950 5449 4f4e  n    DESCRIPTION
-000082e0: 2074 6869 7320 6973 2061 206e 6f64 6520   this is a node 
-000082f0: 7468 6174 2064 6f65 7320 7768 6174 6576  that does whatev
-00008300: 6572 5c5c 6e53 514c 203e 5c5c 6e5c 5c6e  er\\nSQL >\\n\\n
-00008310: 2020 2020 5345 4c45 4354 202a 2066 726f      SELECT * fro
-00008320: 6d20 7465 7374 5f30 315c 5c6e 2020 2020  m test_01\\n    
-00008330: 5748 4552 4520 6120 3e20 315c 5c6e 2020  WHERE a > 1\\n  
-00008340: 2020 4752 4f55 5020 6279 2061 5c5c 6e22    GROUP by a\\n"
-00008350: 290a 2020 2020 3e3e 3e20 642e 6d61 696e  ).    >>> d.main
-00008360: 7461 696e 6572 0a20 2020 2027 7261 6d62  tainer.    'ramb
-00008370: 6f27 0a20 2020 203e 3e3e 2064 2e73 6f75  o'.    >>> d.sou
-00008380: 7263 6573 0a20 2020 205b 2768 7474 7073  rces.    ['https
-00008390: 3a2f 2f65 7861 6d70 6c65 2e63 6f6d 275d  ://example.com']
-000083a0: 0a20 2020 203e 3e3e 206c 656e 2864 2e6e  .    >>> len(d.n
-000083b0: 6f64 6573 290a 2020 2020 320a 2020 2020  odes).    2.    
-000083c0: 3e3e 3e20 642e 6e6f 6465 735b 305d 0a20  >>> d.nodes[0]. 
-000083d0: 2020 207b 276e 616d 6527 3a20 2774 6573     {'name': 'tes
-000083e0: 745f 3031 272c 2027 6465 7363 7269 7074  t_01', 'descript
-000083f0: 696f 6e27 3a20 2774 6869 7320 6973 2061  ion': 'this is a
-00008400: 206e 6f64 6520 7468 6174 2064 6f65 7320   node that does 
-00008410: 7768 6174 6576 6572 272c 2027 7371 6c27  whatever', 'sql'
-00008420: 3a20 2753 454c 4543 5420 2a20 6672 6f6d  : 'SELECT * from
-00008430: 2074 6573 745f 3030 277d 0a20 2020 203e   test_00'}.    >
-00008440: 3e3e 2064 2e6e 6f64 6573 5b31 5d0a 2020  >> d.nodes[1].  
-00008450: 2020 7b27 6e61 6d65 273a 2027 7465 7374    {'name': 'test
-00008460: 5f30 3227 2c20 2764 6573 6372 6970 7469  _02', 'descripti
-00008470: 6f6e 273a 2027 7468 6973 2069 7320 6120  on': 'this is a 
-00008480: 6e6f 6465 2074 6861 7420 646f 6573 2077  node that does w
-00008490: 6861 7465 7665 7227 2c20 2773 716c 273a  hatever', 'sql':
-000084a0: 2027 5345 4c45 4354 202a 2066 726f 6d20   'SELECT * from 
-000084b0: 7465 7374 5f30 315c 5c6e 5748 4552 4520  test_01\\nWHERE 
-000084c0: 6120 3e20 315c 5c6e 4752 4f55 5020 6279  a > 1\\nGROUP by
-000084d0: 2061 277d 0a20 2020 2022 2222 0a20 2020   a'}.    """.   
-000084e0: 206c 696e 6573 203d 206c 6973 7428 5374   lines = list(St
-000084f0: 7269 6e67 494f 2873 2c20 6e65 776c 696e  ringIO(s, newlin
-00008500: 653d 4e6f 6e65 2929 0a0a 2020 2020 646f  e=None))..    do
-00008510: 6320 3d20 4461 7461 6669 6c65 2829 0a20  c = Datafile(). 
-00008520: 2020 2064 6f63 2e72 6177 203d 206c 6973     doc.raw = lis
-00008530: 7428 5374 7269 6e67 494f 2873 2c20 6e65  t(StringIO(s, ne
-00008540: 776c 696e 653d 4e6f 6e65 2929 0a0a 2020  wline=None))..  
-00008550: 2020 7061 7273 6572 5f73 7461 7465 203d    parser_state =
-00008560: 206e 616d 6564 7475 706c 6528 2270 6172   namedtuple("par
-00008570: 7365 725f 7374 6174 6522 2c20 5b22 6d75  ser_state", ["mu
-00008580: 6c74 696c 696e 6522 2c20 2263 7572 7265  ltiline", "curre
-00008590: 6e74 5f6e 6f64 6522 2c20 2263 6f6d 6d61  nt_node", "comma
-000085a0: 6e64 222c 2022 6d75 6c74 696c 696e 655f  nd", "multiline_
-000085b0: 7374 7269 6e67 222c 2022 6973 5f73 716c  string", "is_sql
-000085c0: 225d 290a 0a20 2020 2070 6172 7365 725f  "])..    parser_
-000085d0: 7374 6174 652e 6d75 6c74 696c 696e 6520  state.multiline 
-000085e0: 3d20 4661 6c73 650a 2020 2020 7061 7273  = False.    pars
-000085f0: 6572 5f73 7461 7465 2e63 7572 7265 6e74  er_state.current
-00008600: 5f6e 6f64 6520 3d20 4661 6c73 650a 0a20  _node = False.. 
-00008610: 2020 2064 6566 2061 7373 6967 6e28 6174     def assign(at
-00008620: 7472 293a 0a20 2020 2020 2020 2064 6566  tr):.        def
-00008630: 205f 666e 2878 2c20 2a2a 6b77 6172 6773   _fn(x, **kwargs
-00008640: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00008650: 6574 6174 7472 2864 6f63 2c20 6174 7472  etattr(doc, attr
-00008660: 2c20 5f75 6e71 756f 7465 2878 2929 0a0a  , _unquote(x))..
-00008670: 2020 2020 2020 2020 7265 7475 726e 205f          return _
-00008680: 666e 0a0a 2020 2020 6465 6620 7363 6865  fn..    def sche
-00008690: 6d61 282a 6172 6773 2c20 2a2a 6b77 6172  ma(*args, **kwar
-000086a0: 6773 293a 0a20 2020 2020 2020 2073 203d  gs):.        s =
-000086b0: 205f 756e 7175 6f74 6528 2222 2e6a 6f69   _unquote("".joi
-000086c0: 6e28 6172 6773 2929 0a20 2020 2020 2020  n(args)).       
-000086d0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000086e0: 2020 7368 203d 2070 6172 7365 5f74 6162    sh = parse_tab
-000086f0: 6c65 5f73 7472 7563 7475 7265 2873 290a  le_structure(s).
-00008700: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00008710: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-00008720: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00008730: 2050 6172 7365 4578 6365 7074 696f 6e28   ParseException(
-00008740: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-00008750: 6572 726f 725f 7061 7273 696e 675f 7363  error_parsing_sc
-00008760: 6865 6d61 286c 696e 653d 6b77 6172 6773  hema(line=kwargs
-00008770: 5b22 6c69 6e65 6e6f 225d 2c20 6572 726f  ["lineno"], erro
-00008780: 723d 6529 290a 0a20 2020 2020 2020 2070  r=e))..        p
-00008790: 6172 7365 725f 7374 6174 652e 6375 7272  arser_state.curr
-000087a0: 656e 745f 6e6f 6465 5b22 7363 6865 6d61  ent_node["schema
-000087b0: 225d 203d 2022 2c22 2e6a 6f69 6e28 7363  "] = ",".join(sc
-000087c0: 6865 6d61 5f74 6f5f 7371 6c5f 636f 6c75  hema_to_sql_colu
-000087d0: 6d6e 7328 7368 2929 0a20 2020 2020 2020  mns(sh)).       
-000087e0: 2070 6172 7365 725f 7374 6174 652e 6375   parser_state.cu
-000087f0: 7272 656e 745f 6e6f 6465 5b22 636f 6c75  rrent_node["colu
-00008800: 6d6e 7322 5d20 3d20 7368 0a0a 2020 2020  mns"] = sh..    
-00008810: 6465 6620 696e 6465 7865 7328 2a61 7267  def indexes(*arg
-00008820: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-00008830: 2020 2020 2020 7320 3d20 5f75 6e71 756f        s = _unquo
-00008840: 7465 2822 222e 6a6f 696e 2861 7267 7329  te("".join(args)
-00008850: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-00008860: 2073 3a0a 2020 2020 2020 2020 2020 2020   s:.            
-00008870: 7265 7475 726e 0a20 2020 2020 2020 2074  return.        t
-00008880: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00008890: 696e 6465 7865 7320 3d20 7061 7273 655f  indexes = parse_
-000088a0: 696e 6465 7865 735f 7374 7275 6374 7572  indexes_structur
-000088b0: 6528 732e 7370 6c69 746c 696e 6573 2829  e(s.splitlines()
-000088c0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-000088d0: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-000088e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000088f0: 7365 2050 6172 7365 4578 6365 7074 696f  se ParseExceptio
-00008900: 6e28 4665 6564 6261 636b 4d61 6e61 6765  n(FeedbackManage
-00008910: 722e 6572 726f 725f 7061 7273 696e 675f  r.error_parsing_
-00008920: 696e 6469 6365 7328 6c69 6e65 3d6b 7761  indices(line=kwa
-00008930: 7267 735b 226c 696e 656e 6f22 5d2c 2065  rgs["lineno"], e
-00008940: 7272 6f72 3d65 2929 0a0a 2020 2020 2020  rror=e))..      
-00008950: 2020 7061 7273 6572 5f73 7461 7465 2e63    parser_state.c
-00008960: 7572 7265 6e74 5f6e 6f64 655b 2269 6e64  urrent_node["ind
-00008970: 6578 6573 225d 203d 2069 6e64 6578 6573  exes"] = indexes
-00008980: 0a0a 2020 2020 6465 6620 6173 7369 676e  ..    def assign
-00008990: 5f76 6172 2876 3a20 7374 7229 202d 3e20  _var(v: str) -> 
-000089a0: 4361 6c6c 6162 6c65 5b5b 5661 7241 7267  Callable[[VarArg
-000089b0: 2873 7472 292c 204b 7741 7267 2841 6e79  (str), KwArg(Any
-000089c0: 295d 2c20 4e6f 6e65 5d3a 0a20 2020 2020  )], None]:.     
-000089d0: 2020 2064 6566 205f 6628 2a61 7267 733a     def _f(*args:
-000089e0: 2073 7472 2c20 2a2a 6b77 6172 6773 3a20   str, **kwargs: 
-000089f0: 416e 7929 3a0a 2020 2020 2020 2020 2020  Any):.          
-00008a00: 2020 7320 3d20 5f75 6e71 756f 7465 2828    s = _unquote((
-00008a10: 2220 222e 6a6f 696e 2861 7267 7329 292e  " ".join(args)).
-00008a20: 7374 7269 7028 2929 0a20 2020 2020 2020  strip()).       
-00008a30: 2020 2020 2070 6172 7365 725f 7374 6174       parser_stat
-00008a40: 652e 6375 7272 656e 745f 6e6f 6465 5b76  e.current_node[v
-00008a50: 2e6c 6f77 6572 2829 5d20 3d20 6576 616c  .lower()] = eval
-00008a60: 5f76 6172 2873 290a 0a20 2020 2020 2020  _var(s)..       
-00008a70: 2072 6574 7572 6e20 5f66 0a0a 2020 2020   return _f..    
-00008a80: 6465 6620 736f 7572 6365 7328 783a 2073  def sources(x: s
-00008a90: 7472 2c20 2a2a 6b77 6172 6773 3a20 416e  tr, **kwargs: An
-00008aa0: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
-00008ab0: 2020 2020 646f 632e 736f 7572 6365 732e      doc.sources.
-00008ac0: 6170 7065 6e64 285f 756e 7175 6f74 6528  append(_unquote(
-00008ad0: 7829 290a 0a20 2020 2064 6566 206e 6f64  x))..    def nod
-00008ae0: 6528 2a61 7267 733a 2073 7472 2c20 2a2a  e(*args: str, **
-00008af0: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
-00008b00: 4e6f 6e65 3a0a 2020 2020 2020 2020 6e6f  None:.        no
-00008b10: 6465 203d 207b 226e 616d 6522 3a20 6576  de = {"name": ev
-00008b20: 616c 5f76 6172 285f 756e 7175 6f74 6528  al_var(_unquote(
-00008b30: 6172 6773 5b30 5d29 297d 0a20 2020 2020  args[0]))}.     
-00008b40: 2020 2064 6f63 2e6e 6f64 6573 2e61 7070     doc.nodes.app
-00008b50: 656e 6428 6e6f 6465 290a 2020 2020 2020  end(node).      
-00008b60: 2020 7061 7273 6572 5f73 7461 7465 2e63    parser_state.c
-00008b70: 7572 7265 6e74 5f6e 6f64 6520 3d20 6e6f  urrent_node = no
-00008b80: 6465 0a0a 2020 2020 6465 6620 7363 6f70  de..    def scop
-00008b90: 6528 2a61 7267 733a 2073 7472 2c20 2a2a  e(*args: str, **
-00008ba0: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
-00008bb0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7363  None:.        sc
-00008bc0: 6f70 6520 3d20 7b22 6e61 6d65 223a 2065  ope = {"name": e
-00008bd0: 7661 6c5f 7661 7228 5f75 6e71 756f 7465  val_var(_unquote
-00008be0: 2861 7267 735b 305d 2929 7d0a 2020 2020  (args[0]))}.    
-00008bf0: 2020 2020 646f 632e 6e6f 6465 732e 6170      doc.nodes.ap
-00008c00: 7065 6e64 2873 636f 7065 290a 2020 2020  pend(scope).    
-00008c10: 2020 2020 7061 7273 6572 5f73 7461 7465      parser_state
-00008c20: 2e63 7572 7265 6e74 5f6e 6f64 6520 3d20  .current_node = 
-00008c30: 7363 6f70 650a 0a20 2020 2064 6566 2064  scope..    def d
-00008c40: 6573 6372 6970 7469 6f6e 282a 6172 6773  escription(*args
-00008c50: 3a20 7374 722c 202a 2a6b 7761 7267 733a  : str, **kwargs:
-00008c60: 2041 6e79 2920 2d3e 204e 6f6e 653a 0a20   Any) -> None:. 
-00008c70: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-00008c80: 6f6e 203d 2028 2220 222e 6a6f 696e 2861  on = (" ".join(a
-00008c90: 7267 7329 292e 7374 7269 7028 290a 0a20  rgs)).strip().. 
-00008ca0: 2020 2020 2020 2069 6620 7061 7273 6572         if parser
-00008cb0: 5f73 7461 7465 2e63 7572 7265 6e74 5f6e  _state.current_n
-00008cc0: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
-00008cd0: 2070 6172 7365 725f 7374 6174 652e 6375   parser_state.cu
-00008ce0: 7272 656e 745f 6e6f 6465 5b22 6465 7363  rrent_node["desc
-00008cf0: 7269 7074 696f 6e22 5d20 3d20 6465 7363  ription"] = desc
-00008d00: 7269 7074 696f 6e0a 2020 2020 2020 2020  ription.        
-00008d10: 2020 2020 6966 2070 6172 7365 725f 7374      if parser_st
-00008d20: 6174 652e 6375 7272 656e 745f 6e6f 6465  ate.current_node
-00008d30: 2e67 6574 2822 6e61 6d65 222c 2022 2229  .get("name", "")
-00008d40: 203d 3d20 2264 6566 6175 6c74 223a 0a20   == "default":. 
-00008d50: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00008d60: 6f63 2e64 6573 6372 6970 7469 6f6e 203d  oc.description =
-00008d70: 2064 6573 6372 6970 7469 6f6e 0a20 2020   description.   
-00008d80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00008d90: 2020 2020 2020 2064 6f63 2e64 6573 6372         doc.descr
-00008da0: 6970 7469 6f6e 203d 2064 6573 6372 6970  iption = descrip
-00008db0: 7469 6f6e 0a0a 2020 2020 6465 6620 7371  tion..    def sq
-00008dc0: 6c28 7661 725f 6e61 6d65 3a20 7374 722c  l(var_name: str,
-00008dd0: 202a 2a6b 7761 7267 733a 2041 6e79 2920   **kwargs: Any) 
-00008de0: 2d3e 2043 616c 6c61 626c 655b 5b73 7472  -> Callable[[str
-00008df0: 2c20 4b77 4172 6728 416e 7929 5d2c 204e  , KwArg(Any)], N
-00008e00: 6f6e 655d 3a0a 2020 2020 2020 2020 6465  one]:.        de
-00008e10: 6620 5f66 2873 716c 3a20 7374 722c 202a  f _f(sql: str, *
-00008e20: 2a6b 7761 7267 733a 2041 6e79 2920 2d3e  *kwargs: Any) ->
-00008e30: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00008e40: 2020 2069 6620 6e6f 7420 7061 7273 6572     if not parser
-00008e50: 5f73 7461 7465 2e63 7572 7265 6e74 5f6e  _state.current_n
-00008e60: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
-00008e70: 2020 2020 2072 6169 7365 2050 6172 7365       raise Parse
-00008e80: 4578 6365 7074 696f 6e28 2253 514c 206d  Exception("SQL m
-00008e90: 7573 7420 6265 2063 616c 6c65 6420 6166  ust be called af
-00008ea0: 7465 7220 6120 4e4f 4445 2063 6f6d 6d61  ter a NODE comma
-00008eb0: 6e64 2229 0a20 2020 2020 2020 2020 2020  nd").           
-00008ec0: 2070 6172 7365 725f 7374 6174 652e 6375   parser_state.cu
-00008ed0: 7272 656e 745f 6e6f 6465 5b76 6172 5f6e  rrent_node[var_n
-00008ee0: 616d 655d 203d 2028 0a20 2020 2020 2020  ame] = (.       
-00008ef0: 2020 2020 2020 2020 2074 6578 7477 7261           textwra
-00008f00: 702e 6465 6465 6e74 2873 716c 292e 7273  p.dedent(sql).rs
-00008f10: 7472 6970 2829 2069 6620 2225 2220 6e6f  trip() if "%" no
-00008f20: 7420 696e 2073 716c 2e73 7472 6970 2829  t in sql.strip()
-00008f30: 5b30 5d20 656c 7365 2073 716c 2e73 7472  [0] else sql.str
-00008f40: 6970 2829 0a20 2020 2020 2020 2020 2020  ip().           
-00008f50: 2029 0a0a 2020 2020 2020 2020 2320 4841   )..        # HA
-00008f60: 434b 2074 6869 7320 6361 7374 2069 7320  CK this cast is 
-00008f70: 6e65 6564 6564 2062 6563 6175 7365 204d  needed because M
-00008f80: 7970 790a 2020 2020 2020 2020 7265 7475  ypy.        retu
-00008f90: 726e 2063 6173 7428 4361 6c6c 6162 6c65  rn cast(Callable
-00008fa0: 5b5b 7374 722c 204b 7741 7267 2841 6e79  [[str, KwArg(Any
-00008fb0: 295d 2c20 4e6f 6e65 5d2c 205f 6629 0a0a  )], None], _f)..
-00008fc0: 2020 2020 6465 6620 6173 7369 676e 5f6e      def assign_n
-00008fd0: 6f64 655f 7661 7228 763a 2073 7472 2920  ode_var(v: str) 
-00008fe0: 2d3e 2043 616c 6c61 626c 655b 5b56 6172  -> Callable[[Var
-00008ff0: 4172 6728 7374 7229 2c20 4b77 4172 6728  Arg(str), KwArg(
-00009000: 416e 7929 5d2c 204e 6f6e 655d 3a0a 2020  Any)], None]:.  
-00009010: 2020 2020 2020 6465 6620 5f66 282a 6172        def _f(*ar
-00009020: 6773 3a20 7374 722c 202a 2a6b 7761 7267  gs: str, **kwarg
-00009030: 733a 2041 6e79 2920 2d3e 204e 6f6e 653a  s: Any) -> None:
-00009040: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00009050: 6e6f 7420 7061 7273 6572 5f73 7461 7465  not parser_state
-00009060: 2e63 7572 7265 6e74 5f6e 6f64 653a 0a20  .current_node:. 
-00009070: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00009080: 6169 7365 2050 6172 7365 4578 6365 7074  aise ParseExcept
-00009090: 696f 6e28 2225 7320 6d75 7374 2062 6520  ion("%s must be 
-000090a0: 6361 6c6c 6564 2061 6674 6572 2061 204e  called after a N
-000090b0: 4f44 4520 636f 6d6d 616e 6422 2025 2076  ODE command" % v
-000090c0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-000090d0: 7475 726e 2061 7373 6967 6e5f 7661 7228  turn assign_var(
-000090e0: 7629 282a 6172 6773 2c20 2a2a 6b77 6172  v)(*args, **kwar
-000090f0: 6773 290a 0a20 2020 2020 2020 2072 6574  gs)..        ret
-00009100: 7572 6e20 5f66 0a0a 2020 2020 6465 6620  urn _f..    def 
-00009110: 6164 645f 746f 6b65 6e28 2a61 7267 733a  add_token(*args:
-00009120: 2073 7472 2c20 2a2a 6b77 6172 6773 3a20   str, **kwargs: 
-00009130: 416e 7929 202d 3e20 4e6f 6e65 3a20 2023  Any) -> None:  #
-00009140: 2074 6f6b 656e 5f6e 616d 652c 2070 6572   token_name, per
-00009150: 6d69 7373 696f 6e73 293a 0a20 2020 2020  missions):.     
-00009160: 2020 2069 6620 6c65 6e28 6172 6773 2920     if len(args) 
-00009170: 3c20 323a 0a20 2020 2020 2020 2020 2020  < 2:.           
-00009180: 2072 6169 7365 2050 6172 7365 4578 6365   raise ParseExce
-00009190: 7074 696f 6e28 2754 4f4b 454e 2067 6574  ption('TOKEN get
-000091a0: 7320 7477 6f20 7061 7261 6d73 2c20 746f  s two params, to
-000091b0: 6b65 6e20 6e61 6d65 2061 6e64 2070 6572  ken name and per
-000091c0: 6d69 7373 696f 6e73 2065 2e67 2054 4f4b  missions e.g TOK
-000091d0: 454e 2022 7265 6164 2061 7069 2074 6f6b  EN "read api tok
-000091e0: 656e 2220 5245 4144 2729 0a20 2020 2020  en" READ').     
-000091f0: 2020 2064 6f63 2e74 6f6b 656e 732e 6170     doc.tokens.ap
-00009200: 7065 6e64 287b 2274 6f6b 656e 5f6e 616d  pend({"token_nam
-00009210: 6522 3a20 5f75 6e71 756f 7465 2861 7267  e": _unquote(arg
-00009220: 735b 305d 292c 2022 7065 726d 6973 7369  s[0]), "permissi
-00009230: 6f6e 7322 3a20 6172 6773 5b31 5d7d 290a  ons": args[1]}).
-00009240: 0a20 2020 2064 6566 2061 6464 5f6b 6579  .    def add_key
-00009250: 282a 6172 6773 3a20 7374 722c 202a 2a6b  (*args: str, **k
-00009260: 7761 7267 733a 2041 6e79 2920 2d3e 204e  wargs: Any) -> N
-00009270: 6f6e 653a 2020 2320 746f 6b65 6e5f 6e61  one:  # token_na
-00009280: 6d65 2c20 7065 726d 6973 7369 6f6e 7329  me, permissions)
-00009290: 3a0a 2020 2020 2020 2020 6966 206c 656e  :.        if len
-000092a0: 2861 7267 7329 203c 2031 3a0a 2020 2020  (args) < 1:.    
-000092b0: 2020 2020 2020 2020 7261 6973 6520 5061          raise Pa
-000092c0: 7273 6545 7863 6570 7469 6f6e 2822 4b45  rseException("KE
-000092d0: 5920 6765 7473 206f 6e65 2070 6172 616d  Y gets one param
-000092e0: 7322 290a 2020 2020 2020 2020 646f 632e  s").        doc.
-000092f0: 6b65 7973 2e61 7070 656e 6428 7b22 636f  keys.append({"co
-00009300: 6c75 6d6e 223a 205f 756e 7175 6f74 6528  lumn": _unquote(
-00009310: 6172 6773 5b30 5d29 7d29 0a0a 2020 2020  args[0])})..    
-00009320: 6465 6620 7465 7374 282a 6172 6773 3a20  def test(*args: 
-00009330: 7374 722c 202a 2a6b 7761 7267 733a 2041  str, **kwargs: A
-00009340: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
-00009350: 2020 2020 2070 7269 6e74 2822 7465 7374       print("test
-00009360: 222c 2061 7267 732c 206b 7761 7267 7329  ", args, kwargs)
-00009370: 0a0a 2020 2020 6465 6620 696e 636c 7564  ..    def includ
-00009380: 6528 2a61 7267 733a 2073 7472 2c20 2a2a  e(*args: str, **
-00009390: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
-000093a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6620  None:.        f 
-000093b0: 3d20 5f75 6e71 756f 7465 2861 7267 735b  = _unquote(args[
-000093c0: 305d 290a 2020 2020 2020 2020 6620 3d20  0]).        f = 
-000093d0: 6576 616c 5f76 6172 2866 290a 2020 2020  eval_var(f).    
-000093e0: 2020 2020 6174 7472 7320 3d20 6469 6374      attrs = dict
-000093f0: 285f 756e 7175 6f74 6528 7829 2e73 706c  (_unquote(x).spl
-00009400: 6974 2822 3d22 2c20 3129 2066 6f72 2078  it("=", 1) for x
-00009410: 2069 6e20 6172 6773 5b31 3a5d 290a 2020   in args[1:]).  
-00009420: 2020 2020 2020 6e6f 6e6c 6f63 616c 206c        nonlocal l
-00009430: 696e 6573 0a20 2020 2020 2020 206c 696e  ines.        lin
-00009440: 656e 6f20 3d20 6b77 6172 6773 5b22 6c69  eno = kwargs["li
-00009450: 6e65 6e6f 225d 0a20 2020 2020 2020 2072  neno"].        r
-00009460: 6570 6c61 6365 5f69 6e63 6c75 6465 7320  eplace_includes 
-00009470: 3d20 6b77 6172 6773 5b22 7265 706c 6163  = kwargs["replac
-00009480: 655f 696e 636c 7564 6573 225d 0a20 2020  e_includes"].   
-00009490: 2020 2020 206e 203d 206c 696e 656e 6f0a       n = lineno.
-000094a0: 2020 2020 2020 2020 6172 6773 5f77 6974          args_wit
-000094b0: 685f 6174 7472 7320 3d20 2220 222e 6a6f  h_attrs = " ".jo
-000094c0: 696e 2861 7267 7329 0a0a 2020 2020 2020  in(args)..      
-000094d0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000094e0: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
-000094f0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00009500: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-00009510: 2020 2020 2020 6966 206c 656e 286c 696e        if len(lin
-00009520: 6573 2920 3c3d 206e 3a0a 2020 2020 2020  es) <= n:.      
-00009530: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00009540: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-00009550: 2020 2020 6966 2022 4e4f 4445 2220 696e      if "NODE" in
-00009560: 206c 696e 6573 5b6e 5d3a 0a20 2020 2020   lines[n]:.     
-00009570: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00009580: 6f63 2e69 6e63 6c75 6465 735b 6172 6773  oc.includes[args
-00009590: 5f77 6974 685f 6174 7472 735d 203d 206c  _with_attrs] = l
-000095a0: 696e 6573 5b6e 5d0a 2020 2020 2020 2020  ines[n].        
-000095b0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-000095c0: 6b0a 2020 2020 2020 2020 2020 2020 6966  k.            if
-000095d0: 2061 7267 735f 7769 7468 5f61 7474 7273   args_with_attrs
-000095e0: 206e 6f74 2069 6e20 646f 632e 696e 636c   not in doc.incl
-000095f0: 7564 6573 3a0a 2020 2020 2020 2020 2020  udes:.          
-00009600: 2020 2020 2020 646f 632e 696e 636c 7564        doc.includ
-00009610: 6573 5b61 7267 735f 7769 7468 5f61 7474  es[args_with_att
-00009620: 7273 5d20 3d20 2222 0a20 2020 2020 2020  rs] = "".       
-00009630: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00009640: 6e3a 0a20 2020 2020 2020 2020 2020 2070  n:.            p
-00009650: 6173 730a 0a20 2020 2020 2020 2023 2049  ass..        # I
-00009660: 6620 7468 6973 2070 6172 7365 2077 6173  f this parse was
-00009670: 2074 7269 6767 6572 6564 2062 7920 666f   triggered by fo
-00009680: 726d 6174 2c20 7765 2064 6f6e 2774 2077  rmat, we don't w
-00009690: 616e 7420 746f 2072 6570 6c61 6365 2074  ant to replace t
-000096a0: 6865 2066 696c 650a 2020 2020 2020 2020  he file.        
-000096b0: 6966 206e 6f74 2072 6570 6c61 6365 5f69  if not replace_i
-000096c0: 6e63 6c75 6465 733a 0a20 2020 2020 2020  ncludes:.       
-000096d0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-000096e0: 2020 2020 2023 2062 6520 7375 7265 2074       # be sure t
-000096f0: 6f20 7265 706c 6163 6520 7468 6520 696e  o replace the in
-00009700: 636c 7564 6520 6c69 6e65 0a20 2020 2020  clude line.     
-00009710: 2020 2070 203d 2050 6174 6828 6261 7365     p = Path(base
-00009720: 7061 7468 290a 0a20 2020 2020 2020 2074  path)..        t
-00009730: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00009740: 7769 7468 206f 7065 6e28 7020 2f20 6629  with open(p / f)
-00009750: 2061 7320 6669 6c65 3a0a 2020 2020 2020   as file:.      
-00009760: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00009770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009780: 2020 206c 6c20 3d20 6c69 7374 2853 7472     ll = list(Str
-00009790: 696e 6749 4f28 6669 6c65 2e72 6561 6428  ingIO(file.read(
-000097a0: 292c 206e 6577 6c69 6e65 3d4e 6f6e 6529  ), newline=None)
-000097b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000097c0: 2020 2020 2020 6e6f 6465 5f6c 696e 6520        node_line 
-000097d0: 3d20 5b6c 696e 6520 666f 7220 6c69 6e65  = [line for line
-000097e0: 2069 6e20 6c6c 2069 6620 224e 4f44 4522   in ll if "NODE"
-000097f0: 2069 6e20 6c69 6e65 5d0a 2020 2020 2020   in line].      
-00009800: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00009810: 206e 6f64 655f 6c69 6e65 2061 6e64 2064   node_line and d
-00009820: 6f63 2e69 6e63 6c75 6465 735b 6172 6773  oc.includes[args
-00009830: 5f77 6974 685f 6174 7472 735d 3a0a 2020  _with_attrs]:.  
-00009840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009850: 2020 2020 2020 646f 632e 696e 636c 7564        doc.includ
-00009860: 6573 5b6e 6f64 655f 6c69 6e65 5b30 5d2e  es[node_line[0].
-00009870: 7370 6c69 7428 224e 4f44 4522 295b 2d31  split("NODE")[-1
-00009880: 5d2e 7370 6c69 7428 225c 6e22 295b 305d  ].split("\n")[0]
-00009890: 2e73 7472 6970 2829 5d20 3d20 2222 0a20  .strip()] = "". 
-000098a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000098b0: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-000098c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000098d0: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-000098e0: 2020 2020 2020 2020 2020 6669 6e61 6c6c            finall
-000098f0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00009900: 2020 2020 2020 2066 696c 652e 7365 656b         file.seek
-00009910: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
-00009920: 2020 2020 6c69 6e65 735b 6c69 6e65 6e6f      lines[lineno
-00009930: 203a 206c 696e 656e 6f20 2b20 315d 203d   : lineno + 1] =
-00009940: 205b 2222 5d20 2b20 6c69 7374 280a 2020   [""] + list(.  
-00009950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009960: 2020 5374 7269 6e67 494f 2854 656d 706c    StringIO(Templ
-00009970: 6174 6528 6669 6c65 2e72 6561 6428 2929  ate(file.read())
-00009980: 2e73 6166 655f 7375 6273 7469 7475 7465  .safe_substitute
-00009990: 2861 7474 7273 292c 206e 6577 6c69 6e65  (attrs), newline
-000099a0: 3d4e 6f6e 6529 0a20 2020 2020 2020 2020  =None).         
-000099b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000099c0: 2065 7863 6570 7420 4669 6c65 4e6f 7446   except FileNotF
-000099d0: 6f75 6e64 4572 726f 723a 0a20 2020 2020  oundError:.     
-000099e0: 2020 2020 2020 2072 6169 7365 2049 6e63         raise Inc
-000099f0: 6c75 6465 4669 6c65 4e6f 7446 6f75 6e64  ludeFileNotFound
-00009a00: 4578 6365 7074 696f 6e28 6629 0a0a 2020  Exception(f)..  
-00009a10: 2020 6465 6620 7665 7273 696f 6e28 2a61    def version(*a
-00009a20: 7267 733a 2073 7472 2c20 2a2a 6b77 6172  rgs: str, **kwar
-00009a30: 6773 3a20 416e 7929 202d 3e20 4e6f 6e65  gs: Any) -> None
-00009a40: 3a0a 2020 2020 2020 2020 6966 206c 656e  :.        if len
-00009a50: 2861 7267 7329 203c 2031 3a0a 2020 2020  (args) < 1:.    
-00009a60: 2020 2020 2020 2020 7261 6973 6520 5061          raise Pa
-00009a70: 7273 6545 7863 6570 7469 6f6e 2822 5645  rseException("VE
-00009a80: 5253 494f 4e20 6765 7473 206f 6e65 2070  RSION gets one p
-00009a90: 6f73 6974 6976 6520 696e 7465 6765 7220  ositive integer 
-00009aa0: 7061 7261 6d22 290a 2020 2020 2020 2020  param").        
-00009ab0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00009ac0: 2076 6572 7369 6f6e 203d 2069 6e74 2861   version = int(a
-00009ad0: 7267 735b 305d 290a 2020 2020 2020 2020  rgs[0]).        
-00009ae0: 2020 2020 6966 2076 6572 7369 6f6e 203c      if version <
-00009af0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00009b00: 2020 2020 7261 6973 6520 5661 6c69 6461      raise Valida
-00009b10: 7469 6f6e 4578 6365 7074 696f 6e28 2276  tionException("v
-00009b20: 6572 7369 6f6e 206d 7573 7420 6265 2061  ersion must be a
-00009b30: 2070 6f73 6974 6976 6520 696e 7465 6765   positive intege
-00009b40: 7220 652e 6720 5645 5253 494f 4e20 3222  r e.g VERSION 2"
-00009b50: 290a 2020 2020 2020 2020 2020 2020 646f  ).            do
-00009b60: 632e 7665 7273 696f 6e20 3d20 7665 7273  c.version = vers
-00009b70: 696f 6e0a 2020 2020 2020 2020 6578 6365  ion.        exce
-00009b80: 7074 2056 616c 7565 4572 726f 723a 0a20  pt ValueError:. 
-00009b90: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00009ba0: 2056 616c 6964 6174 696f 6e45 7863 6570   ValidationExcep
-00009bb0: 7469 6f6e 2822 7665 7273 696f 6e20 6d75  tion("version mu
-00009bc0: 7374 2062 6520 6120 706f 7369 7469 7665  st be a positive
-00009bd0: 2069 6e74 6567 6572 2065 2e67 2056 4552   integer e.g VER
-00009be0: 5349 4f4e 2032 2229 0a0a 2020 2020 6465  SION 2")..    de
-00009bf0: 6620 7368 6172 6564 5f77 6974 6828 2a61  f shared_with(*a
-00009c00: 7267 733a 2073 7472 2c20 2a2a 6b77 6172  rgs: str, **kwar
-00009c10: 6773 3a20 416e 7929 202d 3e20 4e6f 6e65  gs: Any) -> None
-00009c20: 3a0a 2020 2020 2020 2020 666f 7220 656e  :.        for en
-00009c30: 7472 6965 7320 696e 2061 7267 733a 0a20  tries in args:. 
-00009c40: 2020 2020 2020 2020 2020 2023 2049 6e20             # In 
-00009c50: 6361 7365 2074 6865 7920 7370 6563 6966  case they specif
-00009c60: 7920 6d75 6c74 6970 6c65 2077 6f72 6b73  y multiple works
-00009c70: 7061 6365 730a 2020 2020 2020 2020 2020  paces.          
-00009c80: 2020 646f 632e 7368 6172 6564 5f77 6974    doc.shared_wit
-00009c90: 6820 2b3d 205b 776f 726b 7370 6163 652e  h += [workspace.
-00009ca0: 7374 7269 7028 2920 666f 7220 776f 726b  strip() for work
-00009cb0: 7370 6163 6520 696e 2065 6e74 7269 6573  space in entries
-00009cc0: 2e73 706c 6974 6c69 6e65 7328 295d 0a0a  .splitlines()]..
-00009cd0: 2020 2020 6465 6620 5f5f 696e 6974 5f65      def __init_e
-00009ce0: 6e67 696e 6528 763a 2073 7472 293a 0a20  ngine(v: str):. 
-00009cf0: 2020 2020 2020 2069 6620 6e6f 7420 7061         if not pa
-00009d00: 7273 6572 5f73 7461 7465 2e63 7572 7265  rser_state.curre
-00009d10: 6e74 5f6e 6f64 653a 0a20 2020 2020 2020  nt_node:.       
-00009d20: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-00009d30: 7469 6f6e 2866 227b 767d 206d 7573 7420  tion(f"{v} must 
-00009d40: 6265 2063 616c 6c65 6420 6166 7465 7220  be called after 
-00009d50: 6120 4e4f 4445 2063 6f6d 6d61 6e64 2229  a NODE command")
-00009d60: 0a20 2020 2020 2020 2069 6620 2265 6e67  .        if "eng
-00009d70: 696e 6522 206e 6f74 2069 6e20 7061 7273  ine" not in pars
-00009d80: 6572 5f73 7461 7465 2e63 7572 7265 6e74  er_state.current
-00009d90: 5f6e 6f64 653a 0a20 2020 2020 2020 2020  _node:.         
-00009da0: 2020 2070 6172 7365 725f 7374 6174 652e     parser_state.
-00009db0: 6375 7272 656e 745f 6e6f 6465 5b22 656e  current_node["en
-00009dc0: 6769 6e65 225d 203d 207b 2274 7970 6522  gine"] = {"type"
-00009dd0: 3a20 4e6f 6e65 2c20 2261 7267 7322 3a20  : None, "args": 
-00009de0: 5b5d 7d0a 0a20 2020 2064 6566 2073 6574  []}..    def set
-00009df0: 5f65 6e67 696e 6528 2a61 7267 733a 2073  _engine(*args: s
-00009e00: 7472 2c20 2a2a 6b77 6172 6773 3a20 416e  tr, **kwargs: An
-00009e10: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
-00009e20: 2020 2020 5f5f 696e 6974 5f65 6e67 696e      __init_engin
-00009e30: 6528 2245 4e47 494e 4522 290a 2020 2020  e("ENGINE").    
-00009e40: 2020 2020 656e 6769 6e65 5f74 7970 6520      engine_type 
-00009e50: 3d20 5f75 6e71 756f 7465 2828 2220 222e  = _unquote((" ".
-00009e60: 6a6f 696e 2861 7267 7329 292e 7374 7269  join(args)).stri
-00009e70: 7028 2929 0a20 2020 2020 2020 2070 6172  p()).        par
-00009e80: 7365 725f 7374 6174 652e 6375 7272 656e  ser_state.curren
-00009e90: 745f 6e6f 6465 5b22 656e 6769 6e65 225d  t_node["engine"]
-00009ea0: 5b22 7479 7065 225d 203d 2065 6e67 696e  ["type"] = engin
-00009eb0: 655f 7479 7065 0a0a 2020 2020 6465 6620  e_type..    def 
-00009ec0: 6164 645f 656e 6769 6e65 5f76 6172 2876  add_engine_var(v
-00009ed0: 3a20 7374 7229 202d 3e20 4361 6c6c 6162  : str) -> Callab
-00009ee0: 6c65 5b5b 5661 7241 7267 2873 7472 292c  le[[VarArg(str),
-00009ef0: 204b 7741 7267 2841 6e79 295d 2c20 4e6f   KwArg(Any)], No
-00009f00: 6e65 5d3a 0a20 2020 2020 2020 2064 6566  ne]:.        def
-00009f10: 205f 6628 2a61 7267 733a 2073 7472 2c20   _f(*args: str, 
-00009f20: 2a2a 6b77 6172 6773 3a20 416e 7929 3a0a  **kwargs: Any):.
-00009f30: 2020 2020 2020 2020 2020 2020 5f5f 696e              __in
-00009f40: 6974 5f65 6e67 696e 6528 6622 454e 4749  it_engine(f"ENGI
-00009f50: 4e45 5f7b 767d 222e 7570 7065 7228 2929  NE_{v}".upper())
-00009f60: 0a20 2020 2020 2020 2020 2020 2065 6e67  .            eng
-00009f70: 696e 655f 6172 6720 3d20 5f75 6e71 756f  ine_arg = _unquo
-00009f80: 7465 2828 2220 222e 6a6f 696e 2861 7267  te((" ".join(arg
-00009f90: 7329 292e 7374 7269 7028 2929 0a20 2020  s)).strip()).   
-00009fa0: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
-00009fb0: 7374 6174 652e 6375 7272 656e 745f 6e6f  state.current_no
-00009fc0: 6465 5b22 656e 6769 6e65 225d 5b22 6172  de["engine"]["ar
-00009fd0: 6773 225d 2e61 7070 656e 6428 2876 2c20  gs"].append((v, 
-00009fe0: 656e 6769 6e65 5f61 7267 2929 0a0a 2020  engine_arg))..  
-00009ff0: 2020 2020 2020 7265 7475 726e 205f 660a        return _f.
-0000a000: 0a20 2020 2063 6d64 7320 3d20 7b0a 2020  .    cmds = {.  
-0000a010: 2020 2020 2020 2266 726f 6d22 3a20 6173        "from": as
-0000a020: 7369 676e 2822 6672 6f6d 2229 2c0a 2020  sign("from"),.  
-0000a030: 2020 2020 2020 2273 6f75 7263 6522 3a20        "source": 
-0000a040: 736f 7572 6365 732c 0a20 2020 2020 2020  sources,.       
-0000a050: 2022 6d61 696e 7461 696e 6572 223a 2061   "maintainer": a
-0000a060: 7373 6967 6e28 226d 6169 6e74 6169 6e65  ssign("maintaine
-0000a070: 7222 292c 0a20 2020 2020 2020 2022 7363  r"),.        "sc
-0000a080: 6865 6d61 223a 2073 6368 656d 612c 0a20  hema": schema,. 
-0000a090: 2020 2020 2020 2022 696e 6465 7865 7322         "indexes"
-0000a0a0: 3a20 696e 6465 7865 732c 0a20 2020 2020  : indexes,.     
-0000a0b0: 2020 2023 2054 4f44 4f3a 2041 6464 6564     # TODO: Added
-0000a0c0: 2074 6f20 6265 2061 626c 6520 746f 206d   to be able to m
-0000a0d0: 6572 6765 204d 5220 3131 3334 372c 206c  erge MR 11347, l
-0000a0e0: 6574 2773 2072 656d 6f76 6520 6974 2061  et's remove it a
-0000a0f0: 6674 6572 7761 7264 730a 2020 2020 2020  fterwards.      
-0000a100: 2020 2269 6e64 6963 6573 223a 2069 6e64    "indices": ind
-0000a110: 6578 6573 2c0a 2020 2020 2020 2020 2265  exes,.        "e
-0000a120: 6e67 696e 6522 3a20 7365 745f 656e 6769  ngine": set_engi
-0000a130: 6e65 2c0a 2020 2020 2020 2020 2270 6172  ne,.        "par
-0000a140: 7469 7469 6f6e 5f6b 6579 223a 2061 7373  tition_key": ass
-0000a150: 6967 6e5f 7661 7228 2270 6172 7469 7469  ign_var("partiti
-0000a160: 6f6e 5f6b 6579 2229 2c0a 2020 2020 2020  on_key"),.      
-0000a170: 2020 2273 6f72 7469 6e67 5f6b 6579 223a    "sorting_key":
-0000a180: 2061 7373 6967 6e5f 7661 7228 2273 6f72   assign_var("sor
-0000a190: 7469 6e67 5f6b 6579 2229 2c0a 2020 2020  ting_key"),.    
-0000a1a0: 2020 2020 2270 7269 6d61 7279 5f6b 6579      "primary_key
-0000a1b0: 223a 2061 7373 6967 6e5f 7661 7228 2270  ": assign_var("p
-0000a1c0: 7269 6d61 7279 5f6b 6579 2229 2c0a 2020  rimary_key"),.  
-0000a1d0: 2020 2020 2020 2273 616d 706c 696e 675f        "sampling_
-0000a1e0: 6b65 7922 3a20 6173 7369 676e 5f76 6172  key": assign_var
-0000a1f0: 2822 7361 6d70 6c69 6e67 5f6b 6579 2229  ("sampling_key")
-0000a200: 2c0a 2020 2020 2020 2020 2274 746c 223a  ,.        "ttl":
-0000a210: 2061 7373 6967 6e5f 7661 7228 2274 746c   assign_var("ttl
-0000a220: 2229 2c0a 2020 2020 2020 2020 2273 6574  "),.        "set
-0000a230: 7469 6e67 7322 3a20 6173 7369 676e 5f76  tings": assign_v
-0000a240: 6172 2822 7365 7474 696e 6773 2229 2c0a  ar("settings"),.
-0000a250: 2020 2020 2020 2020 226e 6f64 6522 3a20          "node": 
-0000a260: 6e6f 6465 2c0a 2020 2020 2020 2020 2273  node,.        "s
-0000a270: 636f 7065 223a 2073 636f 7065 2c0a 2020  cope": scope,.  
-0000a280: 2020 2020 2020 2264 6573 6372 6970 7469        "descripti
-0000a290: 6f6e 223a 2064 6573 6372 6970 7469 6f6e  on": description
-0000a2a0: 2c0a 2020 2020 2020 2020 2274 7970 6522  ,.        "type"
-0000a2b0: 3a20 6173 7369 676e 5f6e 6f64 655f 7661  : assign_node_va
-0000a2c0: 7228 2274 7970 6522 292c 0a20 2020 2020  r("type"),.     
-0000a2d0: 2020 2022 6461 7461 736f 7572 6365 223a     "datasource":
-0000a2e0: 2061 7373 6967 6e5f 6e6f 6465 5f76 6172   assign_node_var
-0000a2f0: 2822 6461 7461 736f 7572 6365 2229 2c0a  ("datasource"),.
-0000a300: 2020 2020 2020 2020 2274 6167 7322 3a20          "tags": 
-0000a310: 6173 7369 676e 5f6e 6f64 655f 7661 7228  assign_node_var(
-0000a320: 2274 6167 7322 292c 0a20 2020 2020 2020  "tags"),.       
-0000a330: 2022 7461 7267 6574 5f64 6174 6173 6f75   "target_datasou
-0000a340: 7263 6522 3a20 6173 7369 676e 5f6e 6f64  rce": assign_nod
-0000a350: 655f 7661 7228 2274 6172 6765 745f 6461  e_var("target_da
-0000a360: 7461 736f 7572 6365 2229 2c0a 2020 2020  tasource"),.    
-0000a370: 2020 2020 2263 6f70 795f 7363 6865 6475      "copy_schedu
-0000a380: 6c65 223a 2061 7373 6967 6e5f 6e6f 6465  le": assign_node
-0000a390: 5f76 6172 2843 6f70 7950 6172 616d 6574  _var(CopyParamet
-0000a3a0: 6572 732e 434f 5059 5f53 4348 4544 554c  ers.COPY_SCHEDUL
-0000a3b0: 4529 2c0a 2020 2020 2020 2020 2272 6573  E),.        "res
-0000a3c0: 6f75 7263 6522 3a20 6173 7369 676e 5f6e  ource": assign_n
-0000a3d0: 6f64 655f 7661 7228 2272 6573 6f75 7263  ode_var("resourc
-0000a3e0: 6522 292c 0a20 2020 2020 2020 2022 6669  e"),.        "fi
-0000a3f0: 6c74 6572 223a 2061 7373 6967 6e5f 6e6f  lter": assign_no
-0000a400: 6465 5f76 6172 2822 6669 6c74 6572 2229  de_var("filter")
-0000a410: 2c0a 2020 2020 2020 2020 2274 6f6b 656e  ,.        "token
-0000a420: 223a 2061 6464 5f74 6f6b 656e 2c0a 2020  ": add_token,.  
-0000a430: 2020 2020 2020 226b 6579 223a 2061 6464        "key": add
-0000a440: 5f6b 6579 2c0a 2020 2020 2020 2020 2274  _key,.        "t
-0000a450: 6573 7422 3a20 7465 7374 2c0a 2020 2020  est": test,.    
-0000a460: 2020 2020 2269 6e63 6c75 6465 223a 2069      "include": i
-0000a470: 6e63 6c75 6465 2c0a 2020 2020 2020 2020  nclude,.        
-0000a480: 2273 716c 223a 2073 716c 2822 7371 6c22  "sql": sql("sql"
-0000a490: 292c 0a20 2020 2020 2020 2022 7665 7273  ),.        "vers
-0000a4a0: 696f 6e22 3a20 7665 7273 696f 6e2c 0a20  ion": version,. 
-0000a4b0: 2020 2020 2020 2022 6b61 666b 615f 636f         "kafka_co
-0000a4c0: 6e6e 6563 7469 6f6e 5f6e 616d 6522 3a20  nnection_name": 
-0000a4d0: 6173 7369 676e 5f76 6172 2822 6b61 666b  assign_var("kafk
-0000a4e0: 615f 636f 6e6e 6563 7469 6f6e 5f6e 616d  a_connection_nam
-0000a4f0: 6522 292c 0a20 2020 2020 2020 2022 6b61  e"),.        "ka
-0000a500: 666b 615f 746f 7069 6322 3a20 6173 7369  fka_topic": assi
-0000a510: 676e 5f76 6172 2822 6b61 666b 615f 746f  gn_var("kafka_to
-0000a520: 7069 6322 292c 0a20 2020 2020 2020 2022  pic"),.        "
-0000a530: 6b61 666b 615f 6772 6f75 705f 6964 223a  kafka_group_id":
-0000a540: 2061 7373 6967 6e5f 7661 7228 226b 6166   assign_var("kaf
-0000a550: 6b61 5f67 726f 7570 5f69 6422 292c 0a20  ka_group_id"),. 
-0000a560: 2020 2020 2020 2022 6b61 666b 615f 626f         "kafka_bo
-0000a570: 6f74 7374 7261 705f 7365 7276 6572 7322  otstrap_servers"
-0000a580: 3a20 6173 7369 676e 5f76 6172 2822 6b61  : assign_var("ka
-0000a590: 666b 615f 626f 6f74 7374 7261 705f 7365  fka_bootstrap_se
-0000a5a0: 7276 6572 7322 292c 0a20 2020 2020 2020  rvers"),.       
-0000a5b0: 2022 6b61 666b 615f 6b65 7922 3a20 6173   "kafka_key": as
-0000a5c0: 7369 676e 5f76 6172 2822 6b61 666b 615f  sign_var("kafka_
-0000a5d0: 6b65 7922 292c 0a20 2020 2020 2020 2022  key"),.        "
-0000a5e0: 6b61 666b 615f 7365 6372 6574 223a 2061  kafka_secret": a
-0000a5f0: 7373 6967 6e5f 7661 7228 226b 6166 6b61  ssign_var("kafka
-0000a600: 5f73 6563 7265 7422 292c 0a20 2020 2020  _secret"),.     
-0000a610: 2020 2022 6b61 666b 615f 7363 6865 6d61     "kafka_schema
-0000a620: 5f72 6567 6973 7472 795f 7572 6c22 3a20  _registry_url": 
-0000a630: 6173 7369 676e 5f76 6172 2822 6b61 666b  assign_var("kafk
-0000a640: 615f 7363 6865 6d61 5f72 6567 6973 7472  a_schema_registr
-0000a650: 795f 7572 6c22 292c 0a20 2020 2020 2020  y_url"),.       
-0000a660: 2022 6b61 666b 615f 7461 7267 6574 5f70   "kafka_target_p
-0000a670: 6172 7469 7469 6f6e 7322 3a20 6173 7369  artitions": assi
-0000a680: 676e 5f76 6172 2822 6b61 666b 615f 7461  gn_var("kafka_ta
-0000a690: 7267 6574 5f70 6172 7469 7469 6f6e 7322  rget_partitions"
-0000a6a0: 292c 0a20 2020 2020 2020 2022 6b61 666b  ),.        "kafk
-0000a6b0: 615f 6175 746f 5f6f 6666 7365 745f 7265  a_auto_offset_re
-0000a6c0: 7365 7422 3a20 6173 7369 676e 5f76 6172  set": assign_var
-0000a6d0: 2822 6b61 666b 615f 6175 746f 5f6f 6666  ("kafka_auto_off
-0000a6e0: 7365 745f 7265 7365 7422 292c 0a20 2020  set_reset"),.   
-0000a6f0: 2020 2020 2022 6b61 666b 615f 7374 6f72       "kafka_stor
-0000a700: 655f 7261 775f 7661 6c75 6522 3a20 6173  e_raw_value": as
-0000a710: 7369 676e 5f76 6172 2822 6b61 666b 615f  sign_var("kafka_
-0000a720: 7374 6f72 655f 7261 775f 7661 6c75 6522  store_raw_value"
-0000a730: 292c 0a20 2020 2020 2020 2022 6b61 666b  ),.        "kafk
-0000a740: 615f 7374 6f72 655f 6865 6164 6572 7322  a_store_headers"
-0000a750: 3a20 6173 7369 676e 5f76 6172 2822 6b61  : assign_var("ka
-0000a760: 666b 615f 7374 6f72 655f 6865 6164 6572  fka_store_header
-0000a770: 7322 292c 0a20 2020 2020 2020 2022 6b61  s"),.        "ka
-0000a780: 666b 615f 6b65 795f 6176 726f 5f64 6573  fka_key_avro_des
-0000a790: 6572 6961 6c69 7a61 7469 6f6e 223a 2061  erialization": a
-0000a7a0: 7373 6967 6e5f 7661 7228 226b 6166 6b61  ssign_var("kafka
-0000a7b0: 5f6b 6579 5f61 7672 6f5f 6465 7365 7269  _key_avro_deseri
-0000a7c0: 616c 697a 6174 696f 6e22 292c 0a20 2020  alization"),.   
-0000a7d0: 2020 2020 2022 696d 706f 7274 5f73 6572       "import_ser
-0000a7e0: 7669 6365 223a 2061 7373 6967 6e5f 7661  vice": assign_va
-0000a7f0: 7228 2269 6d70 6f72 745f 7365 7276 6963  r("import_servic
-0000a800: 6522 292c 0a20 2020 2020 2020 2022 696d  e"),.        "im
-0000a810: 706f 7274 5f63 6f6e 6e65 6374 696f 6e5f  port_connection_
-0000a820: 6e61 6d65 223a 2061 7373 6967 6e5f 7661  name": assign_va
-0000a830: 7228 2269 6d70 6f72 745f 636f 6e6e 6563  r("import_connec
-0000a840: 7469 6f6e 5f6e 616d 6522 292c 0a20 2020  tion_name"),.   
-0000a850: 2020 2020 2022 696d 706f 7274 5f73 6368       "import_sch
-0000a860: 6564 756c 6522 3a20 6173 7369 676e 5f76  edule": assign_v
-0000a870: 6172 2822 696d 706f 7274 5f73 6368 6564  ar("import_sched
-0000a880: 756c 6522 292c 0a20 2020 2020 2020 2022  ule"),.        "
-0000a890: 696d 706f 7274 5f73 7472 6174 6567 7922  import_strategy"
-0000a8a0: 3a20 6173 7369 676e 5f76 6172 2822 696d  : assign_var("im
-0000a8b0: 706f 7274 5f73 7472 6174 6567 7922 292c  port_strategy"),
-0000a8c0: 0a20 2020 2020 2020 2022 696d 706f 7274  .        "import
-0000a8d0: 5f65 7874 6572 6e61 6c5f 6461 7461 736f  _external_dataso
-0000a8e0: 7572 6365 223a 2061 7373 6967 6e5f 7661  urce": assign_va
-0000a8f0: 7228 2269 6d70 6f72 745f 6578 7465 726e  r("import_extern
-0000a900: 616c 5f64 6174 6173 6f75 7263 6522 292c  al_datasource"),
-0000a910: 0a20 2020 2020 2020 2022 696d 706f 7274  .        "import
-0000a920: 5f62 7563 6b65 745f 7572 6922 3a20 6173  _bucket_uri": as
-0000a930: 7369 676e 5f76 6172 2822 696d 706f 7274  sign_var("import
-0000a940: 5f62 7563 6b65 745f 7572 6922 292c 0a20  _bucket_uri"),. 
-0000a950: 2020 2020 2020 2022 696d 706f 7274 5f71         "import_q
-0000a960: 7565 7279 223a 2061 7373 6967 6e5f 7661  uery": assign_va
-0000a970: 7228 2269 6d70 6f72 745f 7175 6572 7922  r("import_query"
-0000a980: 292c 0a20 2020 2020 2020 2022 7368 6172  ),.        "shar
-0000a990: 6564 5f77 6974 6822 3a20 7368 6172 6564  ed_with": shared
-0000a9a0: 5f77 6974 682c 0a20 2020 2020 2020 2022  _with,.        "
-0000a9b0: 6578 706f 7274 5f73 6572 7669 6365 223a  export_service":
-0000a9c0: 2061 7373 6967 6e5f 7661 7228 2265 7870   assign_var("exp
-0000a9d0: 6f72 745f 7365 7276 6963 6522 292c 0a20  ort_service"),. 
-0000a9e0: 2020 2020 2020 2022 6578 706f 7274 5f63         "export_c
-0000a9f0: 6f6e 6e65 6374 696f 6e5f 6e61 6d65 223a  onnection_name":
-0000aa00: 2061 7373 6967 6e5f 7661 7228 2265 7870   assign_var("exp
-0000aa10: 6f72 745f 636f 6e6e 6563 7469 6f6e 5f6e  ort_connection_n
-0000aa20: 616d 6522 292c 0a20 2020 2020 2020 2022  ame"),.        "
-0000aa30: 6578 706f 7274 5f73 6368 6564 756c 6522  export_schedule"
-0000aa40: 3a20 6173 7369 676e 5f76 6172 2822 6578  : assign_var("ex
-0000aa50: 706f 7274 5f73 6368 6564 756c 6522 292c  port_schedule"),
-0000aa60: 0a20 2020 2020 2020 2022 6578 706f 7274  .        "export
-0000aa70: 5f62 7563 6b65 745f 7572 6922 3a20 6173  _bucket_uri": as
-0000aa80: 7369 676e 5f76 6172 2822 6578 706f 7274  sign_var("export
-0000aa90: 5f62 7563 6b65 745f 7572 6922 292c 0a20  _bucket_uri"),. 
-0000aaa0: 2020 2020 2020 2022 6578 706f 7274 5f66         "export_f
-0000aab0: 696c 655f 7465 6d70 6c61 7465 223a 2061  ile_template": a
-0000aac0: 7373 6967 6e5f 7661 7228 2265 7870 6f72  ssign_var("expor
-0000aad0: 745f 6669 6c65 5f74 656d 706c 6174 6522  t_file_template"
-0000aae0: 292c 0a20 2020 2020 2020 2022 6578 706f  ),.        "expo
-0000aaf0: 7274 5f66 6f72 6d61 7422 3a20 6173 7369  rt_format": assi
-0000ab00: 676e 5f76 6172 2822 6578 706f 7274 5f66  gn_var("export_f
-0000ab10: 6f72 6d61 7422 292c 0a20 2020 2020 2020  ormat"),.       
-0000ab20: 2022 6578 706f 7274 5f73 7472 6174 6567   "export_strateg
-0000ab30: 7922 3a20 6173 7369 676e 5f76 6172 2822  y": assign_var("
-0000ab40: 6578 706f 7274 5f73 7472 6174 6567 7922  export_strategy"
-0000ab50: 292c 0a20 2020 2020 2020 2022 6578 706f  ),.        "expo
-0000ab60: 7274 5f63 6f6d 7072 6573 7369 6f6e 223a  rt_compression":
-0000ab70: 2061 7373 6967 6e5f 7661 7228 2265 7870   assign_var("exp
-0000ab80: 6f72 745f 636f 6d70 7265 7373 696f 6e22  ort_compression"
-0000ab90: 292c 0a20 2020 207d 0a0a 2020 2020 656e  ),.    }..    en
-0000aba0: 6769 6e65 5f76 6172 7320 3d20 7365 7428  gine_vars = set(
-0000abb0: 290a 0a20 2020 2066 6f72 205f 656e 6769  )..    for _engi
-0000abc0: 6e65 2c20 2870 6172 616d 732c 206f 7074  ne, (params, opt
-0000abd0: 696f 6e73 2920 696e 2045 4e41 424c 4544  ions) in ENABLED
-0000abe0: 5f45 4e47 494e 4553 3a0a 2020 2020 2020  _ENGINES:.      
-0000abf0: 2020 666f 7220 7020 696e 2070 6172 616d    for p in param
-0000ac00: 733a 0a20 2020 2020 2020 2020 2020 2065  s:.            e
-0000ac10: 6e67 696e 655f 7661 7273 2e61 6464 2870  ngine_vars.add(p
-0000ac20: 2e6e 616d 6529 0a20 2020 2020 2020 2066  .name).        f
-0000ac30: 6f72 206f 2069 6e20 6f70 7469 6f6e 733a  or o in options:
-0000ac40: 0a20 2020 2020 2020 2020 2020 2065 6e67  .            eng
-0000ac50: 696e 655f 7661 7273 2e61 6464 286f 2e6e  ine_vars.add(o.n
-0000ac60: 616d 6529 0a20 2020 2066 6f72 2076 2069  ame).    for v i
-0000ac70: 6e20 656e 6769 6e65 5f76 6172 733a 0a20  n engine_vars:. 
-0000ac80: 2020 2020 2020 2063 6d64 735b 6622 656e         cmds[f"en
-0000ac90: 6769 6e65 5f7b 767d 225d 203d 2061 6464  gine_{v}"] = add
-0000aca0: 5f65 6e67 696e 655f 7661 7228 7629 0a0a  _engine_var(v)..
-0000acb0: 2020 2020 6966 2064 6566 6175 6c74 5f6e      if default_n
-0000acc0: 6f64 653a 0a20 2020 2020 2020 206e 6f64  ode:.        nod
-0000acd0: 6528 6465 6661 756c 745f 6e6f 6465 290a  e(default_node).
-0000ace0: 0a20 2020 206c 696e 656e 6f20 3d20 300a  .    lineno = 0.
-0000acf0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000ad00: 2077 6869 6c65 206c 696e 656e 6f20 3c20   while lineno < 
-0000ad10: 6c65 6e28 6c69 6e65 7329 3a0a 2020 2020  len(lines):.    
-0000ad20: 2020 2020 2020 2020 6c69 6e65 203d 206c          line = l
-0000ad30: 696e 6573 5b6c 696e 656e 6f5d 0a20 2020  ines[lineno].   
-0000ad40: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0000ad50: 2020 2020 2020 2020 2020 2020 2020 7361                sa
-0000ad60: 203d 2073 686c 6578 2e73 686c 6578 286c   = shlex.shlex(l
-0000ad70: 696e 6529 0a20 2020 2020 2020 2020 2020  ine).           
-0000ad80: 2020 2020 2073 612e 7768 6974 6573 7061       sa.whitespa
-0000ad90: 6365 5f73 706c 6974 203d 2054 7275 650a  ce_split = True.
-0000ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adb0: 6c65 7865 7220 3d20 6c69 7374 2873 6129  lexer = list(sa)
-0000adc0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000add0: 6570 7420 5661 6c75 6545 7272 6f72 3a0a  ept ValueError:.
-0000ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adf0: 7361 203d 2073 686c 6578 2e73 686c 6578  sa = shlex.shlex
-0000ae00: 2873 686c 6578 2e71 756f 7465 286c 696e  (shlex.quote(lin
-0000ae10: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-0000ae20: 2020 2020 7361 2e77 6869 7465 7370 6163      sa.whitespac
-0000ae30: 655f 7370 6c69 7420 3d20 5472 7565 0a20  e_split = True. 
-0000ae40: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000ae50: 6578 6572 203d 206c 6973 7428 7361 290a  exer = list(sa).
-0000ae60: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0000ae70: 6578 6572 3a0a 2020 2020 2020 2020 2020  exer:.          
-0000ae80: 2020 2020 2020 636d 642c 2061 7267 7320        cmd, args 
-0000ae90: 3d20 6c65 7865 725b 305d 2c20 6c65 7865  = lexer[0], lexe
-0000aea0: 725b 313a 5d0a 2020 2020 2020 2020 2020  r[1:].          
-0000aeb0: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-0000aec0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000aed0: 6172 7365 725f 7374 6174 652e 6d75 6c74  arser_state.mult
-0000aee0: 696c 696e 650a 2020 2020 2020 2020 2020  iline.          
-0000aef0: 2020 2020 2020 2020 2020 616e 6420 636d            and cm
-0000af00: 642e 6c6f 7765 7228 2920 696e 2063 6d64  d.lower() in cmd
-0000af10: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0000af20: 2020 2020 2020 616e 6420 6e6f 7420 286c        and not (l
-0000af30: 696e 652e 7374 6172 7473 7769 7468 2822  ine.startswith("
-0000af40: 2022 2920 6f72 206c 696e 652e 7374 6172   ") or line.star
-0000af50: 7473 7769 7468 2822 5c74 2229 206f 7220  tswith("\t") or 
-0000af60: 6c69 6e65 2e6c 6f77 6572 2829 2e73 7461  line.lower().sta
-0000af70: 7274 7377 6974 6828 2266 726f 6d22 2929  rtswith("from"))
-0000af80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000af90: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-0000afa0: 2020 2020 2020 2020 7061 7273 6572 5f73          parser_s
-0000afb0: 7461 7465 2e6d 756c 7469 6c69 6e65 203d  tate.multiline =
-0000afc0: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-0000afd0: 2020 2020 2020 2020 2020 2063 6d64 735b             cmds[
-0000afe0: 7061 7273 6572 5f73 7461 7465 2e63 6f6d  parser_state.com
-0000aff0: 6d61 6e64 5d28 0a20 2020 2020 2020 2020  mand](.         
-0000b000: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000b010: 6172 7365 725f 7374 6174 652e 6d75 6c74  arser_state.mult
-0000b020: 696c 696e 655f 7374 7269 6e67 2c20 6c69  iline_string, li
-0000b030: 6e65 6e6f 3d6c 696e 656e 6f2c 2072 6570  neno=lineno, rep
-0000b040: 6c61 6365 5f69 6e63 6c75 6465 733d 7265  lace_includes=re
-0000b050: 706c 6163 655f 696e 636c 7564 6573 0a20  place_includes. 
-0000b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b070: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0000b080: 2020 2020 2020 6966 206e 6f74 2070 6172        if not par
-0000b090: 7365 725f 7374 6174 652e 6d75 6c74 696c  ser_state.multil
-0000b0a0: 696e 653a 0a20 2020 2020 2020 2020 2020  ine:.           
-0000b0b0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-0000b0c0: 6172 6773 2920 3e3d 2031 2061 6e64 2061  args) >= 1 and a
-0000b0d0: 7267 735b 305d 203d 3d20 223e 223a 0a20  rgs[0] == ">":. 
-0000b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0f0: 2020 2020 2020 2070 6172 7365 725f 7374         parser_st
-0000b100: 6174 652e 6d75 6c74 696c 696e 6520 3d20  ate.multiline = 
-0000b110: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0000b120: 2020 2020 2020 2020 2020 2020 2070 6172               par
-0000b130: 7365 725f 7374 6174 652e 636f 6d6d 616e  ser_state.comman
-0000b140: 6420 3d20 636d 642e 6c6f 7765 7228 290a  d = cmd.lower().
-0000b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b160: 2020 2020 2020 2020 7061 7273 6572 5f73          parser_s
-0000b170: 7461 7465 2e6d 756c 7469 6c69 6e65 5f73  tate.multiline_s
-0000b180: 7472 696e 6720 3d20 2222 0a20 2020 2020  tring = "".     
-0000b190: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000b1a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000b1b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000b1c0: 636d 642e 6c6f 7765 7228 2920 696e 2063  cmd.lower() in c
-0000b1d0: 6d64 733a 0a20 2020 2020 2020 2020 2020  mds:.           
-0000b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1f0: 2063 6d64 735b 636d 642e 6c6f 7765 7228   cmds[cmd.lower(
-0000b200: 295d 282a 6172 6773 2c20 6c69 6e65 6e6f  )](*args, lineno
-0000b210: 3d6c 696e 656e 6f2c 2072 6570 6c61 6365  =lineno, replace
-0000b220: 5f69 6e63 6c75 6465 733d 7265 706c 6163  _includes=replac
-0000b230: 655f 696e 636c 7564 6573 290a 2020 2020  e_includes).    
-0000b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b250: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b270: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
-0000b280: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
-0000b290: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-0000b2a0: 2e65 7272 6f72 5f6f 7074 696f 6e28 6f70  .error_option(op
-0000b2b0: 7469 6f6e 3d63 6d64 2e75 7070 6572 2829  tion=cmd.upper()
-0000b2c0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0000b2d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000b2e0: 2020 2020 2020 2020 2020 2020 2070 6172               par
-0000b2f0: 7365 725f 7374 6174 652e 6d75 6c74 696c  ser_state.multil
-0000b300: 696e 655f 7374 7269 6e67 202b 3d20 6c69  ine_string += li
-0000b310: 6e65 0a20 2020 2020 2020 2020 2020 206c  ne.            l
-0000b320: 696e 656e 6f20 2b3d 2031 0a20 2020 2020  ineno += 1.     
-0000b330: 2020 2023 2063 6c6f 7365 2066 696e 616c     # close final
-0000b340: 2073 7461 7465 0a20 2020 2020 2020 2069   state.        i
-0000b350: 6620 7061 7273 6572 5f73 7461 7465 2e6d  f parser_state.m
-0000b360: 756c 7469 6c69 6e65 3a0a 2020 2020 2020  ultiline:.      
-0000b370: 2020 2020 2020 636d 6473 5b70 6172 7365        cmds[parse
-0000b380: 725f 7374 6174 652e 636f 6d6d 616e 645d  r_state.command]
-0000b390: 2870 6172 7365 725f 7374 6174 652e 6d75  (parser_state.mu
-0000b3a0: 6c74 696c 696e 655f 7374 7269 6e67 2c20  ltiline_string, 
-0000b3b0: 6c69 6e65 6e6f 3d6c 696e 656e 6f2c 2072  lineno=lineno, r
-0000b3c0: 6570 6c61 6365 5f69 6e63 6c75 6465 733d  eplace_includes=
-0000b3d0: 7265 706c 6163 655f 696e 636c 7564 6573  replace_includes
-0000b3e0: 290a 2020 2020 6578 6365 7074 2050 6172  ).    except Par
-0000b3f0: 7365 4578 6365 7074 696f 6e20 6173 2065  seException as e
-0000b400: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-0000b410: 5061 7273 6545 7863 6570 7469 6f6e 2873  ParseException(s
-0000b420: 7472 2865 292c 206c 696e 656e 6f3d 6c69  tr(e), lineno=li
-0000b430: 6e65 6e6f 290a 2020 2020 6578 6365 7074  neno).    except
-0000b440: 2056 616c 6964 6174 696f 6e45 7863 6570   ValidationExcep
-0000b450: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0000b460: 2020 2072 6169 7365 2056 616c 6964 6174     raise Validat
-0000b470: 696f 6e45 7863 6570 7469 6f6e 2873 7472  ionException(str
-0000b480: 2865 292c 206c 696e 656e 6f3d 6c69 6e65  (e), lineno=line
-0000b490: 6e6f 290a 2020 2020 6578 6365 7074 2049  no).    except I
-0000b4a0: 6e64 6578 4572 726f 7220 6173 2065 3a0a  ndexError as e:.
-0000b4b0: 2020 2020 2020 2020 6966 2022 6e6f 6465          if "node
-0000b4c0: 2220 696e 206c 696e 652e 6c6f 7765 7228  " in line.lower(
-0000b4d0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0000b4e0: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
-0000b4f0: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
-0000b500: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-0000b510: 6d69 7373 696e 675f 6e6f 6465 5f6e 616d  missing_node_nam
-0000b520: 6528 2929 0a20 2020 2020 2020 2065 6c69  e()).        eli
-0000b530: 6620 2273 716c 2220 696e 206c 696e 652e  f "sql" in line.
-0000b540: 6c6f 7765 7228 293a 0a20 2020 2020 2020  lower():.       
-0000b550: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
-0000b560: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
-0000b570: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-0000b580: 6572 726f 725f 6d69 7373 696e 675f 7371  error_missing_sq
-0000b590: 6c5f 636f 6d6d 616e 6428 2929 0a20 2020  l_command()).   
-0000b5a0: 2020 2020 2065 6c69 6620 2264 6174 6173       elif "datas
-0000b5b0: 6f75 7263 6522 2069 6e20 6c69 6e65 2e6c  ource" in line.l
-0000b5c0: 6f77 6572 2829 3a0a 2020 2020 2020 2020  ower():.        
-0000b5d0: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
-0000b5e0: 436c 6963 6b45 7863 6570 7469 6f6e 2846  ClickException(F
-0000b5f0: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
-0000b600: 7272 6f72 5f6d 6973 7369 6e67 5f64 6174  rror_missing_dat
-0000b610: 6173 6f75 7263 655f 6e61 6d65 2829 290a  asource_name()).
-0000b620: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000b630: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000b640: 5661 6c69 6461 7469 6f6e 4578 6365 7074  ValidationExcept
-0000b650: 696f 6e28 6622 5661 6c69 6461 7469 6f6e  ion(f"Validation
-0000b660: 2065 7272 6f72 2c20 666f 756e 6420 7b6c   error, found {l
-0000b670: 696e 657d 2069 6e20 6c69 6e65 207b 7374  ine} in line {st
-0000b680: 7228 6c69 6e65 6e6f 297d 3a20 7b73 7472  r(lineno)}: {str
-0000b690: 2865 297d 222c 206c 696e 656e 6f3d 6c69  (e)}", lineno=li
-0000b6a0: 6e65 6e6f 290a 2020 2020 6578 6365 7074  neno).    except
-0000b6b0: 2049 6e63 6c75 6465 4669 6c65 4e6f 7446   IncludeFileNotF
-0000b6c0: 6f75 6e64 4578 6365 7074 696f 6e20 6173  oundException as
-0000b6d0: 2065 3a0a 2020 2020 2020 2020 7261 6973   e:.        rais
-0000b6e0: 6520 650a 2020 2020 6578 6365 7074 2045  e e.    except E
-0000b6f0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-0000b700: 2020 2020 2020 2074 7261 6365 6261 636b         traceback
-0000b710: 2e70 7269 6e74 5f74 6228 652e 5f5f 7472  .print_tb(e.__tr
-0000b720: 6163 6562 6163 6b5f 5f29 0a20 2020 2020  aceback__).     
-0000b730: 2020 2072 6169 7365 2050 6172 7365 4578     raise ParseEx
-0000b740: 6365 7074 696f 6e28 6622 556e 6578 7065  ception(f"Unexpe
-0000b750: 6374 6564 2065 7272 6f72 3a20 7b65 7d22  cted error: {e}"
-0000b760: 2c20 6c69 6e65 6e6f 3d6c 696e 656e 6f29  , lineno=lineno)
-0000b770: 0a0a 2020 2020 7265 7475 726e 2064 6f63  ..    return doc
-0000b780: 0a0a 0a64 6566 2067 656e 6572 6174 655f  ...def generate_
-0000b790: 7265 736f 7572 6365 5f66 6f72 5f6b 6579  resource_for_key
-0000b7a0: 286b 6579 3a20 7374 722c 206e 616d 653a  (key: str, name:
-0000b7b0: 2073 7472 2c20 7363 6865 6d61 3a20 7374   str, schema: st
-0000b7c0: 722c 2076 6572 7369 6f6e 3a20 7374 722c  r, version: str,
-0000b7d0: 2072 6573 5f6e 616d 653a 2073 7472 2920   res_name: str) 
-0000b7e0: 2d3e 204c 6973 745b 4469 6374 5b73 7472  -> List[Dict[str
-0000b7f0: 2c20 416e 795d 5d3a 0a20 2020 2072 6573  , Any]]:.    res
-0000b800: 6f75 7263 6573 3a20 4c69 7374 5b44 6963  ources: List[Dic
-0000b810: 745b 7374 722c 2041 6e79 5d5d 203d 205b  t[str, Any]] = [
-0000b820: 5d0a 2020 2020 2320 6461 7461 736f 7572  ].    # datasour
-0000b830: 6365 0a20 2020 2064 735f 6e61 6d65 203d  ce.    ds_name =
-0000b840: 2066 227b 6e61 6d65 7d5f 6a6f 696e 5f62   f"{name}_join_b
-0000b850: 795f 7b6b 6579 7d7b 7665 7273 696f 6e7d  y_{key}{version}
-0000b860: 220a 2020 2020 7061 7261 6d73 203d 207b  ".    params = {
-0000b870: 0a20 2020 2020 2020 2022 6e61 6d65 223a  .        "name":
-0000b880: 2064 735f 6e61 6d65 2c0a 2020 2020 2020   ds_name,.      
-0000b890: 2020 2273 6368 656d 6122 3a20 7363 6865    "schema": sche
-0000b8a0: 6d61 2c0a 2020 2020 2020 2020 2265 6e67  ma,.        "eng
-0000b8b0: 696e 6522 3a20 224a 6f69 6e22 2c0a 2020  ine": "Join",.  
-0000b8c0: 2020 2020 2020 2265 6e67 696e 655f 6a6f        "engine_jo
-0000b8d0: 696e 5f73 7472 6963 746e 6573 7322 3a20  in_strictness": 
-0000b8e0: 2241 4e59 222c 0a20 2020 2020 2020 2022  "ANY",.        "
-0000b8f0: 656e 6769 6e65 5f6a 6f69 6e5f 7479 7065  engine_join_type
-0000b900: 223a 2022 4c45 4654 222c 0a20 2020 2020  ": "LEFT",.     
-0000b910: 2020 2022 656e 6769 6e65 5f6b 6579 5f63     "engine_key_c
-0000b920: 6f6c 756d 6e73 223a 206b 6579 2c0a 2020  olumns": key,.  
-0000b930: 2020 7d0a 2020 2020 7265 736f 7572 6365    }.    resource
-0000b940: 732e 6170 7065 6e64 280a 2020 2020 2020  s.append(.      
-0000b950: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0000b960: 2272 6573 6f75 7263 655f 6e61 6d65 223a  "resource_name":
-0000b970: 2066 227b 6e61 6d65 7d5f 6a6f 696e 5f62   f"{name}_join_b
-0000b980: 795f 7b6b 6579 7d22 2c0a 2020 2020 2020  y_{key}",.      
-0000b990: 2020 2020 2020 2272 6573 6f75 7263 6522        "resource"
-0000b9a0: 3a20 2264 6174 6173 6f75 7263 6573 222c  : "datasources",
-0000b9b0: 0a20 2020 2020 2020 2020 2020 2022 7061  .            "pa
-0000b9c0: 7261 6d73 223a 2070 6172 616d 732c 0a20  rams": params,. 
-0000b9d0: 2020 2020 2020 2020 2020 2022 6669 6c65             "file
-0000b9e0: 6e61 6d65 223a 2066 227b 7061 7261 6d73  name": f"{params
-0000b9f0: 5b27 6e61 6d65 275d 7d2e 6461 7461 736f  ['name']}.dataso
-0000ba00: 7572 6365 222c 0a20 2020 2020 2020 207d  urce",.        }
-0000ba10: 0a20 2020 2029 0a20 2020 2072 6573 6f75  .    ).    resou
-0000ba20: 7263 6573 2e61 7070 656e 6428 0a20 2020  rces.append(.   
-0000ba30: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0000ba40: 2020 2022 7265 736f 7572 6365 5f6e 616d     "resource_nam
-0000ba50: 6522 3a20 6622 7b6e 616d 657d 5f6a 6f69  e": f"{name}_joi
-0000ba60: 6e5f 6279 5f7b 6b65 797d 5f70 6970 6522  n_by_{key}_pipe"
-0000ba70: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
-0000ba80: 6573 6f75 7263 6522 3a20 2270 6970 6573  esource": "pipes
-0000ba90: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-0000baa0: 6669 6c65 6e61 6d65 223a 2066 227b 7061  filename": f"{pa
-0000bab0: 7261 6d73 5b27 6e61 6d65 275d 7d2e 7069  rams['name']}.pi
-0000bac0: 7065 222c 0a20 2020 2020 2020 2020 2020  pe",.           
-0000bad0: 2022 6e61 6d65 223a 2066 227b 6e61 6d65   "name": f"{name
-0000bae0: 7d5f 6a6f 696e 5f62 795f 7b6b 6579 7d5f  }_join_by_{key}_
-0000baf0: 7069 7065 7b76 6572 7369 6f6e 7d22 2c0a  pipe{version}",.
-0000bb00: 2020 2020 2020 2020 2020 2020 2273 6368              "sch
-0000bb10: 656d 6122 3a20 7363 6865 6d61 2c0a 2020  ema": schema,.  
-0000bb20: 2020 2020 2020 2020 2020 226e 6f64 6573            "nodes
-0000bb30: 223a 205b 0a20 2020 2020 2020 2020 2020  ": [.           
-0000bb40: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0000bb50: 2020 2020 2020 2020 2020 2022 7371 6c22             "sql"
-0000bb60: 3a20 6622 7365 6c65 6374 202a 2066 726f  : f"select * fro
-0000bb70: 6d20 7b6e 616d 657d 7b76 6572 7369 6f6e  m {name}{version
-0000bb80: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-0000bb90: 2020 2020 2020 2020 2270 6172 616d 7322          "params"
-0000bba0: 3a20 7b22 6e61 6d65 223a 2066 227b 6e61  : {"name": f"{na
-0000bbb0: 6d65 7d5f 6a6f 696e 5f62 795f 7b6b 6579  me}_join_by_{key
-0000bbc0: 7d5f 7669 6577 222c 2022 7479 7065 223a  }_view", "type":
-0000bbd0: 2022 6d61 7465 7269 616c 697a 6564 222c   "materialized",
-0000bbe0: 2022 6461 7461 736f 7572 6365 223a 2064   "datasource": d
-0000bbf0: 735f 6e61 6d65 7d2c 0a20 2020 2020 2020  s_name},.       
-0000bc00: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0000bc10: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000bc20: 2020 2020 2020 2264 6570 7322 3a20 5b72        "deps": [r
-0000bc30: 6573 5f6e 616d 655d 2c20 2023 205b 6473  es_name],  # [ds
-0000bc40: 5f6e 616d 655d 2c0a 2020 2020 2020 2020  _name],.        
-0000bc50: 2020 2020 2274 6f6b 656e 7322 3a20 5b5d      "tokens": []
-0000bc60: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
-0000bc70: 290a 2020 2020 7265 7475 726e 2072 6573  ).    return res
-0000bc80: 6f75 7263 6573 0a0a 0a61 7379 6e63 2064  ources...async d
-0000bc90: 6566 2070 726f 6365 7373 5f66 696c 6528  ef process_file(
-0000bca0: 0a20 2020 2066 696c 656e 616d 653a 2073  .    filename: s
-0000bcb0: 7472 2c0a 2020 2020 7462 5f63 6c69 656e  tr,.    tb_clien
-0000bcc0: 743a 2054 696e 7942 2c0a 2020 2020 7265  t: TinyB,.    re
-0000bcd0: 736f 7572 6365 5f76 6572 7369 6f6e 733a  source_versions:
-0000bce0: 204f 7074 696f 6e61 6c5b 4469 6374 5d20   Optional[Dict] 
-0000bcf0: 3d20 4e6f 6e65 2c0a 2020 2020 736b 6970  = None,.    skip
-0000bd00: 5f63 6f6e 6e65 6374 6f72 733a 2062 6f6f  _connectors: boo
-0000bd10: 6c20 3d20 4661 6c73 652c 0a20 2020 2077  l = False,.    w
-0000bd20: 6f72 6b73 7061 6365 5f6d 6170 3a20 4f70  orkspace_map: Op
-0000bd30: 7469 6f6e 616c 5b44 6963 745d 203d 204e  tional[Dict] = N
-0000bd40: 6f6e 652c 0a20 2020 2077 6f72 6b73 7061  one,.    workspa
-0000bd50: 6365 5f6c 6962 5f70 6174 6873 3a20 4f70  ce_lib_paths: Op
-0000bd60: 7469 6f6e 616c 5b4c 6973 745b 5475 706c  tional[List[Tupl
-0000bd70: 655b 7374 722c 2073 7472 5d5d 5d20 3d20  e[str, str]]] = 
-0000bd80: 4e6f 6e65 2c0a 2020 2020 6375 7272 656e  None,.    curren
-0000bd90: 745f 7773 3a20 4f70 7469 6f6e 616c 5b44  t_ws: Optional[D
-0000bda0: 6963 745b 7374 722c 2041 6e79 5d5d 203d  ict[str, Any]] =
-0000bdb0: 204e 6f6e 652c 0a29 3a20 2023 206e 6f71   None,.):  # noq
-0000bdc0: 613a 2043 3930 3120 4230 3036 0a20 2020  a: C901 B006.   
-0000bdd0: 2069 6620 776f 726b 7370 6163 655f 6d61   if workspace_ma
-0000bde0: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
-0000bdf0: 2020 2077 6f72 6b73 7061 6365 5f6d 6170     workspace_map
-0000be00: 203d 207b 7d0a 0a20 2020 2069 6620 7265   = {}..    if re
-0000be10: 736f 7572 6365 5f76 6572 7369 6f6e 7320  source_versions 
-0000be20: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0000be30: 2072 6573 6f75 7263 655f 7665 7273 696f   resource_versio
-0000be40: 6e73 203d 207b 7d0a 2020 2020 7265 736f  ns = {}.    reso
-0000be50: 7572 6365 5f76 6572 7369 6f6e 735f 7374  urce_versions_st
-0000be60: 7269 6e67 203d 207b 6b3a 2066 225f 5f76  ring = {k: f"__v
-0000be70: 7b76 7d22 2066 6f72 206b 2c20 7620 696e  {v}" for k, v in
-0000be80: 2072 6573 6f75 7263 655f 7665 7273 696f   resource_versio
-0000be90: 6e73 2e69 7465 6d73 2829 2069 6620 7620  ns.items() if v 
-0000bea0: 3e3d 2030 7d0a 0a20 2020 2064 6566 2067  >= 0}..    def g
-0000beb0: 6574 5f65 6e67 696e 655f 7061 7261 6d73  et_engine_params
-0000bec0: 286e 6f64 653a 2044 6963 745b 7374 722c  (node: Dict[str,
-0000bed0: 2041 6e79 5d29 202d 3e20 4469 6374 5b73   Any]) -> Dict[s
-0000bee0: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
-0000bef0: 2020 7061 7261 6d73 203d 207b 7d0a 0a20    params = {}.. 
-0000bf00: 2020 2020 2020 2069 6620 2265 6e67 696e         if "engin
-0000bf10: 6522 2069 6e20 6e6f 6465 3a0a 2020 2020  e" in node:.    
-0000bf20: 2020 2020 2020 2020 656e 6769 6e65 203d          engine =
-0000bf30: 206e 6f64 655b 2265 6e67 696e 6522 5d5b   node["engine"][
-0000bf40: 2274 7970 6522 5d0a 2020 2020 2020 2020  "type"].        
-0000bf50: 2020 2020 7061 7261 6d73 5b22 656e 6769      params["engi
-0000bf60: 6e65 225d 203d 2065 6e67 696e 650a 2020  ne"] = engine.  
-0000bf70: 2020 2020 2020 2020 2020 6172 6773 203d            args =
-0000bf80: 206e 6f64 655b 2265 6e67 696e 6522 5d5b   node["engine"][
-0000bf90: 2261 7267 7322 5d0a 2020 2020 2020 2020  "args"].        
-0000bfa0: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
-0000bfb0: 6172 6773 3a0a 2020 2020 2020 2020 2020  args:.          
-0000bfc0: 2020 2020 2020 7061 7261 6d73 5b66 2265        params[f"e
-0000bfd0: 6e67 696e 655f 7b6b 7d22 5d20 3d20 760a  ngine_{k}"] = v.
-0000bfe0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0000bff0: 6172 616d 730a 0a20 2020 2061 7379 6e63  arams..    async
-0000c000: 2064 6566 2067 6574 5f6b 6166 6b61 5f70   def get_kafka_p
-0000c010: 6172 616d 7328 6e6f 6465 3a20 4469 6374  arams(node: Dict
-0000c020: 5b73 7472 2c20 416e 795d 293a 0a20 2020  [str, Any]):.   
-0000c030: 2020 2020 2070 6172 616d 7320 3d20 7b6b       params = {k
-0000c040: 6579 3a20 7661 6c75 6520 666f 7220 6b65  ey: value for ke
-0000c050: 792c 2076 616c 7565 2069 6e20 6e6f 6465  y, value in node
-0000c060: 2e69 7465 6d73 2829 2069 6620 6b65 792e  .items() if key.
-0000c070: 7374 6172 7473 7769 7468 2822 6b61 666b  startswith("kafk
-0000c080: 6122 297d 0a0a 2020 2020 2020 2020 6966  a")}..        if
-0000c090: 206e 6f74 2073 6b69 705f 636f 6e6e 6563   not skip_connec
-0000c0a0: 746f 7273 3a0a 2020 2020 2020 2020 2020  tors:.          
-0000c0b0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000c0c0: 2020 2020 2020 2063 6f6e 6e65 6374 6f72         connector
-0000c0d0: 5f70 6172 616d 7320 3d20 7b0a 2020 2020  _params = {.    
-0000c0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0f0: 226b 6166 6b61 5f62 6f6f 7473 7472 6170  "kafka_bootstrap
-0000c100: 5f73 6572 7665 7273 223a 2070 6172 616d  _servers": param
-0000c110: 732e 6765 7428 226b 6166 6b61 5f62 6f6f  s.get("kafka_boo
-0000c120: 7473 7472 6170 5f73 6572 7665 7273 222c  tstrap_servers",
-0000c130: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-0000c140: 2020 2020 2020 2020 2020 2020 226b 6166              "kaf
-0000c150: 6b61 5f6b 6579 223a 2070 6172 616d 732e  ka_key": params.
-0000c160: 6765 7428 226b 6166 6b61 5f6b 6579 222c  get("kafka_key",
-0000c170: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
-0000c180: 2020 2020 2020 2020 2020 2020 226b 6166              "kaf
-0000c190: 6b61 5f73 6563 7265 7422 3a20 7061 7261  ka_secret": para
-0000c1a0: 6d73 2e67 6574 2822 6b61 666b 615f 7365  ms.get("kafka_se
-0000c1b0: 6372 6574 222c 204e 6f6e 6529 2c0a 2020  cret", None),.  
-0000c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c1d0: 2020 226b 6166 6b61 5f63 6f6e 6e65 6374    "kafka_connect
-0000c1e0: 696f 6e5f 6e61 6d65 223a 2070 6172 616d  ion_name": param
-0000c1f0: 732e 6765 7428 226b 6166 6b61 5f63 6f6e  s.get("kafka_con
-0000c200: 6e65 6374 696f 6e5f 6e61 6d65 222c 204e  nection_name", N
-0000c210: 6f6e 6529 2c0a 2020 2020 2020 2020 2020  one),.          
-0000c220: 2020 2020 2020 2020 2020 226b 6166 6b61            "kafka
-0000c230: 5f61 7574 6f5f 6f66 6673 6574 5f72 6573  _auto_offset_res
-0000c240: 6574 223a 2070 6172 616d 732e 6765 7428  et": params.get(
-0000c250: 226b 6166 6b61 5f61 7574 6f5f 6f66 6673  "kafka_auto_offs
-0000c260: 6574 5f72 6573 6574 222c 204e 6f6e 6529  et_reset", None)
-0000c270: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c280: 2020 2020 2020 226b 6166 6b61 5f73 6368        "kafka_sch
-0000c290: 656d 615f 7265 6769 7374 7279 5f75 726c  ema_registry_url
-0000c2a0: 223a 2070 6172 616d 732e 6765 7428 226b  ": params.get("k
-0000c2b0: 6166 6b61 5f73 6368 656d 615f 7265 6769  afka_schema_regi
-0000c2c0: 7374 7279 5f75 726c 222c 204e 6f6e 6529  stry_url", None)
-0000c2d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c2e0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-0000c2f0: 2020 2020 2063 6f6e 6e65 6374 6f72 203d       connector =
-0000c300: 2061 7761 6974 2074 625f 636c 6965 6e74   await tb_client
-0000c310: 2e67 6574 5f63 6f6e 6e65 6374 696f 6e28  .get_connection(
-0000c320: 2a2a 636f 6e6e 6563 746f 725f 7061 7261  **connector_para
-0000c330: 6d73 290a 2020 2020 2020 2020 2020 2020  ms).            
-0000c340: 2020 2020 6966 206e 6f74 2063 6f6e 6e65      if not conne
-0000c350: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
-0000c360: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-0000c370: 6563 686f 280a 2020 2020 2020 2020 2020  echo(.          
-0000c380: 2020 2020 2020 2020 2020 2020 2020 4665                Fe
-0000c390: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
-0000c3a0: 666f 5f63 7265 6174 696e 675f 6b61 666b  fo_creating_kafk
-0000c3b0: 615f 636f 6e6e 6563 7469 6f6e 2863 6f6e  a_connection(con
-0000c3c0: 6e65 6374 696f 6e5f 6e61 6d65 3d70 6172  nection_name=par
-0000c3d0: 616d 735b 226b 6166 6b61 5f63 6f6e 6e65  ams["kafka_conne
-0000c3e0: 6374 696f 6e5f 6e61 6d65 225d 290a 2020  ction_name"]).  
-0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c400: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000c410: 2020 2020 2020 2020 7265 7175 6972 6564          required
-0000c420: 5f70 6172 616d 7320 3d20 5b0a 2020 2020  _params = [.    
-0000c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c440: 2020 2020 636f 6e6e 6563 746f 725f 7061      connector_pa
-0000c450: 7261 6d73 5b22 6b61 666b 615f 626f 6f74  rams["kafka_boot
-0000c460: 7374 7261 705f 7365 7276 6572 7322 5d2c  strap_servers"],
-0000c470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c480: 2020 2020 2020 2020 2063 6f6e 6e65 6374           connect
-0000c490: 6f72 5f70 6172 616d 735b 226b 6166 6b61  or_params["kafka
-0000c4a0: 5f6b 6579 225d 2c0a 2020 2020 2020 2020  _key"],.        
-0000c4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4c0: 636f 6e6e 6563 746f 725f 7061 7261 6d73  connector_params
-0000c4d0: 5b22 6b61 666b 615f 7365 6372 6574 225d  ["kafka_secret"]
-0000c4e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c4f0: 2020 2020 2020 5d0a 0a20 2020 2020 2020        ]..       
-0000c500: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000c510: 6e6f 7420 616c 6c28 7265 7175 6972 6564  not all(required
-0000c520: 5f70 6172 616d 7329 3a0a 2020 2020 2020  _params):.      
-0000c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c540: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
-0000c550: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
-0000c560: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-0000c570: 6f72 5f75 6e6b 6e6f 776e 5f6b 6166 6b61  or_unknown_kafka
-0000c580: 5f63 6f6e 6e65 6374 696f 6e28 6461 7461  _connection(data
-0000c590: 736f 7572 6365 3d6e 616d 6529 290a 0a20  source=name)).. 
-0000c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5b0: 2020 2063 6f6e 6e65 6374 6f72 203d 2061     connector = a
-0000c5c0: 7761 6974 2074 625f 636c 6965 6e74 2e63  wait tb_client.c
-0000c5d0: 6f6e 6e65 6374 696f 6e5f 6372 6561 7465  onnection_create
-0000c5e0: 5f6b 6166 6b61 282a 2a63 6f6e 6e65 6374  _kafka(**connect
-0000c5f0: 6f72 5f70 6172 616d 7329 0a20 2020 2020  or_params).     
-0000c600: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0000c610: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-0000c620: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000c630: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
-0000c640: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
-0000c650: 2020 2020 2020 2020 2020 2020 2020 4665                Fe
-0000c660: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
-0000c670: 726f 725f 636f 6e6e 6563 7469 6f6e 5f63  ror_connection_c
-0000c680: 7265 6174 6528 0a20 2020 2020 2020 2020  reate(.         
-0000c690: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000c6a0: 6f6e 6e65 6374 696f 6e5f 6e61 6d65 3d70  onnection_name=p
-0000c6b0: 6172 616d 735b 226b 6166 6b61 5f63 6f6e  arams["kafka_con
-0000c6c0: 6e65 6374 696f 6e5f 6e61 6d65 225d 2c20  nection_name"], 
-0000c6d0: 6572 726f 723d 7374 7228 6529 0a20 2020  error=str(e).   
-0000c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c6f0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0000c700: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0000c710: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
-0000c720: 6462 6163 6b4d 616e 6167 6572 2e73 7563  dbackManager.suc
-0000c730: 6365 7373 5f63 6f6e 6e65 6374 696f 6e5f  cess_connection_
-0000c740: 7573 696e 6728 636f 6e6e 6563 7469 6f6e  using(connection
-0000c750: 5f6e 616d 653d 636f 6e6e 6563 746f 725b  _name=connector[
-0000c760: 226e 616d 6522 5d29 290a 0a20 2020 2020  "name"]))..     
-0000c770: 2020 2020 2020 2070 6172 616d 732e 7570         params.up
-0000c780: 6461 7465 280a 2020 2020 2020 2020 2020  date(.          
-0000c790: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0000c7a0: 2020 2020 2020 2020 2020 2020 2263 6f6e              "con
-0000c7b0: 6e65 6374 6f72 223a 2063 6f6e 6e65 6374  nector": connect
-0000c7c0: 6f72 5b22 6964 225d 2c0a 2020 2020 2020  or["id"],.      
-0000c7d0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0000c7e0: 6572 7669 6365 223a 2022 6b61 666b 6122  ervice": "kafka"
-0000c7f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000c800: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0000c810: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0000c820: 6e20 7061 7261 6d73 0a0a 2020 2020 6173  n params..    as
-0000c830: 796e 6320 6465 6620 6765 745f 696d 706f  ync def get_impo
-0000c840: 7274 5f70 6172 616d 7328 6461 7461 736f  rt_params(dataso
-0000c850: 7572 6365 3a20 4469 6374 5b73 7472 2c20  urce: Dict[str, 
-0000c860: 416e 795d 2c20 6e6f 6465 3a20 4469 6374  Any], node: Dict
-0000c870: 5b73 7472 2c20 416e 795d 2920 2d3e 2044  [str, Any]) -> D
-0000c880: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-0000c890: 2020 2020 2020 2070 6172 616d 733a 2044         params: D
-0000c8a0: 6963 745b 7374 722c 2041 6e79 5d20 3d20  ict[str, Any] = 
-0000c8b0: 7b6b 6579 3a20 7661 6c75 6520 666f 7220  {key: value for 
-0000c8c0: 6b65 792c 2076 616c 7565 2069 6e20 6e6f  key, value in no
-0000c8d0: 6465 2e69 7465 6d73 2829 2069 6620 6b65  de.items() if ke
-0000c8e0: 792e 7374 6172 7473 7769 7468 2822 696d  y.startswith("im
-0000c8f0: 706f 7274 5f22 297d 0a0a 2020 2020 2020  port_")}..      
-0000c900: 2020 6966 206c 656e 2870 6172 616d 7329    if len(params)
-0000c910: 203d 3d20 3020 6f72 2073 6b69 705f 636f   == 0 or skip_co
-0000c920: 6e6e 6563 746f 7273 3a0a 2020 2020 2020  nnectors:.      
-0000c930: 2020 2020 2020 7265 7475 726e 2070 6172        return par
-0000c940: 616d 730a 0a20 2020 2020 2020 2073 6572  ams..        ser
-0000c950: 7669 6365 3a20 4f70 7469 6f6e 616c 5b73  vice: Optional[s
-0000c960: 7472 5d20 3d20 6e6f 6465 2e67 6574 2822  tr] = node.get("
-0000c970: 696d 706f 7274 5f73 6572 7669 6365 222c  import_service",
-0000c980: 204e 6f6e 6529 0a0a 2020 2020 2020 2020   None)..        
-0000c990: 6966 2073 6572 7669 6365 2061 6e64 2073  if service and s
-0000c9a0: 6572 7669 6365 2e6c 6f77 6572 2829 203d  ervice.lower() =
-0000c9b0: 3d20 2262 6967 7175 6572 7922 3a0a 2020  = "bigquery":.  
-0000c9c0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0000c9d0: 2061 7761 6974 2074 625f 636c 6965 6e74   await tb_client
-0000c9e0: 2e63 6865 636b 5f67 6370 5f72 6561 645f  .check_gcp_read_
-0000c9f0: 7065 726d 6973 7369 6f6e 7328 293a 0a20  permissions():. 
-0000ca00: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000ca10: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
-0000ca20: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
-0000ca30: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-0000ca40: 756e 6b6e 6f77 6e5f 6271 5f63 6f6e 6e65  unknown_bq_conne
-0000ca50: 6374 696f 6e28 6461 7461 736f 7572 6365  ction(datasource
-0000ca60: 3d64 6174 6173 6f75 7263 655b 226e 616d  =datasource["nam
-0000ca70: 6522 5d29 290a 0a20 2020 2020 2020 2020  e"]))..         
-0000ca80: 2020 2023 2042 6967 7175 6572 7920 646f     # Bigquery do
-0000ca90: 6573 6e27 7420 6861 7665 2061 2064 6174  esn't have a dat
-0000caa0: 616c 696e 6b2c 2073 6f20 7765 2063 616e  alink, so we can
-0000cab0: 2073 746f 7020 6865 7265 0a20 2020 2020   stop here.     
-0000cac0: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
-0000cad0: 7261 6d73 0a0a 2020 2020 2020 2020 2320  rams..        # 
-0000cae0: 5265 7374 206f 6620 636f 6e6e 6563 746f  Rest of connecto
-0000caf0: 7273 0a0a 2020 2020 2020 2020 636f 6e6e  rs..        conn
-0000cb00: 6563 746f 725f 6964 3a20 4f70 7469 6f6e  ector_id: Option
-0000cb10: 616c 5b73 7472 5d20 3d20 6e6f 6465 2e67  al[str] = node.g
-0000cb20: 6574 2822 696d 706f 7274 5f63 6f6e 6e65  et("import_conne
-0000cb30: 6374 6f72 222c 204e 6f6e 6529 0a20 2020  ctor", None).   
-0000cb40: 2020 2020 2063 6f6e 6e65 6374 6f72 5f6e       connector_n
-0000cb50: 616d 653a 204f 7074 696f 6e61 6c5b 7374  ame: Optional[st
-0000cb60: 725d 203d 206e 6f64 652e 6765 7428 2269  r] = node.get("i
-0000cb70: 6d70 6f72 745f 636f 6e6e 6563 7469 6f6e  mport_connection
-0000cb80: 5f6e 616d 6522 2c20 4e6f 6e65 290a 2020  _name", None).  
-0000cb90: 2020 2020 2020 6966 206e 6f74 2063 6f6e        if not con
-0000cba0: 6e65 6374 6f72 5f6e 616d 6520 616e 6420  nector_name and 
-0000cbb0: 6e6f 7420 636f 6e6e 6563 746f 725f 6964  not connector_id
-0000cbc0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000cbd0: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
-0000cbe0: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
-0000cbf0: 6b4d 616e 6167 6572 2e65 7272 6f72 5f6d  kManager.error_m
-0000cc00: 6973 7369 6e67 5f63 6f6e 6e65 6374 696f  issing_connectio
-0000cc10: 6e5f 6e61 6d65 2864 6174 6173 6f75 7263  n_name(datasourc
-0000cc20: 653d 6461 7461 736f 7572 6365 5b22 6e61  e=datasource["na
-0000cc30: 6d65 225d 2929 0a0a 2020 2020 2020 2020  me"]))..        
-0000cc40: 6966 206e 6f74 2063 6f6e 6e65 6374 6f72  if not connector
-0000cc50: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
-0000cc60: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-0000cc70: 6365 2863 6f6e 6e65 6374 6f72 5f6e 616d  ce(connector_nam
-0000cc80: 652c 2073 7472 290a 0a20 2020 2020 2020  e, str)..       
-0000cc90: 2020 2020 2063 6f6e 6e65 6374 6f72 3a20       connector: 
-0000cca0: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
-0000ccb0: 722c 2041 6e79 5d5d 203d 2061 7761 6974  r, Any]] = await
-0000ccc0: 2074 625f 636c 6965 6e74 2e67 6574 5f63   tb_client.get_c
-0000ccd0: 6f6e 6e65 6374 6f72 2863 6f6e 6e65 6374  onnector(connect
-0000cce0: 6f72 5f6e 616d 652c 2073 6572 7669 6365  or_name, service
-0000ccf0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-0000cd00: 6620 6e6f 7420 636f 6e6e 6563 746f 723a  f not connector:
-0000cd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cd20: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-0000cd30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000cd40: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
-0000cd50: 6e61 6765 722e 6572 726f 725f 756e 6b6e  nager.error_unkn
-0000cd60: 6f77 6e5f 636f 6e6e 6563 7469 6f6e 2864  own_connection(d
-0000cd70: 6174 6173 6f75 7263 653d 6461 7461 736f  atasource=dataso
-0000cd80: 7572 6365 5b22 6e61 6d65 225d 2c20 636f  urce["name"], co
-0000cd90: 6e6e 6563 7469 6f6e 3d63 6f6e 6e65 6374  nnection=connect
-0000cda0: 6f72 5f6e 616d 6529 0a20 2020 2020 2020  or_name).       
-0000cdb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000cdc0: 2020 2020 2020 2063 6f6e 6e65 6374 6f72         connector
-0000cdd0: 5f69 6420 3d20 636f 6e6e 6563 746f 725b  _id = connector[
-0000cde0: 2269 6422 5d0a 2020 2020 2020 2020 2020  "id"].          
-0000cdf0: 2020 7365 7276 6963 6520 3d20 636f 6e6e    service = conn
-0000ce00: 6563 746f 725b 2273 6572 7669 6365 225d  ector["service"]
-0000ce10: 0a0a 2020 2020 2020 2020 2320 5468 6520  ..        # The 
-0000ce20: 4150 4920 6e65 6564 7320 7468 6520 636f  API needs the co
-0000ce30: 6e6e 6563 746f 7220 4944 2074 6f20 6372  nnector ID to cr
-0000ce40: 6561 7465 2074 6865 2064 6174 6173 6f75  eate the datasou
-0000ce50: 7263 652e 0a20 2020 2020 2020 2070 6172  rce..        par
-0000ce60: 616d 735b 2269 6d70 6f72 745f 636f 6e6e  ams["import_conn
-0000ce70: 6563 746f 7222 5d20 3d20 636f 6e6e 6563  ector"] = connec
-0000ce80: 746f 725f 6964 0a20 2020 2020 2020 2069  tor_id.        i
-0000ce90: 6620 7365 7276 6963 653a 0a20 2020 2020  f service:.     
-0000cea0: 2020 2020 2020 2070 6172 616d 735b 2269         params["i
-0000ceb0: 6d70 6f72 745f 7365 7276 6963 6522 5d20  mport_service"] 
-0000cec0: 3d20 7365 7276 6963 650a 0a20 2020 2020  = service..     
-0000ced0: 2020 2069 6620 7365 7276 6963 6520 696e     if service in
-0000cee0: 2050 5245 5649 4557 5f43 4f4e 4e45 4354   PREVIEW_CONNECT
-0000cef0: 4f52 5f53 4552 5649 4345 533a 0a20 2020  OR_SERVICES:.   
-0000cf00: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0000cf10: 7061 7261 6d73 2e67 6574 2822 696d 706f  params.get("impo
-0000cf20: 7274 5f62 7563 6b65 745f 7572 6922 2c20  rt_bucket_uri", 
-0000cf30: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
-0000cf40: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
-0000cf50: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
-0000cf60: 6e28 4665 6564 6261 636b 4d61 6e61 6765  n(FeedbackManage
-0000cf70: 722e 6572 726f 725f 6d69 7373 696e 675f  r.error_missing_
-0000cf80: 6275 636b 6574 5f75 7269 2864 6174 6173  bucket_uri(datas
-0000cf90: 6f75 7263 653d 6461 7461 736f 7572 6365  ource=datasource
-0000cfa0: 5b22 6e61 6d65 225d 2929 0a20 2020 2020  ["name"])).     
-0000cfb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000cfc0: 2020 2020 2069 6620 6e6f 7420 7061 7261       if not para
-0000cfd0: 6d73 2e67 6574 2822 696d 706f 7274 5f65  ms.get("import_e
-0000cfe0: 7874 6572 6e61 6c5f 6461 7461 736f 7572  xternal_datasour
-0000cff0: 6365 222c 204e 6f6e 6529 3a0a 2020 2020  ce", None):.    
-0000d000: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000d010: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
-0000d020: 6570 7469 6f6e 280a 2020 2020 2020 2020  eption(.        
-0000d030: 2020 2020 2020 2020 2020 2020 4665 6564              Feed
-0000d040: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
-0000d050: 725f 6d69 7373 696e 675f 6578 7465 726e  r_missing_extern
-0000d060: 616c 5f64 6174 6173 6f75 7263 6528 6461  al_datasource(da
-0000d070: 7461 736f 7572 6365 3d64 6174 6173 6f75  tasource=datasou
-0000d080: 7263 655b 226e 616d 6522 5d29 0a20 2020  rce["name"]).   
-0000d090: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-0000d0a0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0000d0b0: 6172 616d 730a 0a20 2020 2069 6620 4461  arams..    if Da
-0000d0c0: 7461 4669 6c65 4578 7465 6e73 696f 6e73  taFileExtensions
-0000d0d0: 2e44 4154 4153 4f55 5243 4520 696e 2066  .DATASOURCE in f
-0000d0e0: 696c 656e 616d 653a 0a20 2020 2020 2020  ilename:.       
-0000d0f0: 2064 6f63 203d 2070 6172 7365 5f64 6174   doc = parse_dat
-0000d100: 6173 6f75 7263 6528 6669 6c65 6e61 6d65  asource(filename
-0000d110: 290a 2020 2020 2020 2020 6e6f 6465 203d  ).        node =
-0000d120: 2064 6f63 2e6e 6f64 6573 5b30 5d0a 2020   doc.nodes[0].  
-0000d130: 2020 2020 2020 6465 7073 3a20 4c69 7374        deps: List
-0000d140: 5b73 7472 5d20 3d20 5b5d 0a20 2020 2020  [str] = [].     
-0000d150: 2020 2023 2072 6565 6d70 6c61 6365 2074     # reemplace t
-0000d160: 6162 6c65 7320 6f6e 206d 6174 6572 6961  ables on materia
-0000d170: 6c69 7a65 6420 636f 6c75 6d6e 730a 2020  lized columns.  
-0000d180: 2020 2020 2020 636f 6c75 6d6e 7320 3d20        columns = 
-0000d190: 7061 7273 655f 7461 626c 655f 7374 7275  parse_table_stru
-0000d1a0: 6374 7572 6528 6e6f 6465 5b22 7363 6865  cture(node["sche
-0000d1b0: 6d61 225d 290a 0a20 2020 2020 2020 205f  ma"])..        _
-0000d1c0: 666f 726d 6174 203d 2022 6373 7622 0a20  format = "csv". 
-0000d1d0: 2020 2020 2020 2066 6f72 2078 2069 6e20         for x in 
-0000d1e0: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-0000d1f0: 2020 2020 2069 6620 785b 2264 6566 6175       if x["defau
-0000d200: 6c74 5f76 616c 7565 225d 2061 6e64 2078  lt_value"] and x
-0000d210: 5b22 6465 6661 756c 745f 7661 6c75 6522  ["default_value"
-0000d220: 5d2e 6c6f 7765 7228 292e 7374 6172 7473  ].lower().starts
-0000d230: 7769 7468 2822 6d61 7465 7269 616c 697a  with("materializ
-0000d240: 6564 2229 3a0a 2020 2020 2020 2020 2020  ed"):.          
-0000d250: 2020 2020 2020 2320 7475 726e 2065 7870        # turn exp
-0000d260: 7265 7373 696f 6e20 746f 2061 2073 656c  ression to a sel
-0000d270: 6563 7420 7175 6572 7920 746f 2073 716c  ect query to sql
-0000d280: 5f67 6574 5f75 7365 645f 7461 626c 6573  _get_used_tables
-0000d290: 2063 616e 2067 6574 2074 6865 2075 7365   can get the use
-0000d2a0: 6420 7461 626c 6573 0a20 2020 2020 2020  d tables.       
-0000d2b0: 2020 2020 2020 2020 2071 203d 2022 7365           q = "se
-0000d2c0: 6c65 6374 2022 202b 2078 5b22 6465 6661  lect " + x["defa
-0000d2d0: 756c 745f 7661 6c75 6522 5d5b 6c65 6e28  ult_value"][len(
-0000d2e0: 226d 6174 6572 6961 6c69 7a65 6422 2920  "materialized") 
-0000d2f0: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
-0000d300: 2020 2074 6162 6c65 7320 3d20 6177 6169     tables = awai
-0000d310: 7420 7462 5f63 6c69 656e 742e 7371 6c5f  t tb_client.sql_
-0000d320: 6765 745f 7573 6564 5f74 6162 6c65 7328  get_used_tables(
-0000d330: 7129 0a20 2020 2020 2020 2020 2020 2020  q).             
-0000d340: 2020 2023 206d 6174 6572 6961 6c69 7a65     # materialize
-0000d350: 6420 636f 6c75 6d6e 7320 6578 7072 6573  d columns expres
-0000d360: 7369 6f6e 7320 636f 756c 6420 6861 7665  sions could have
-0000d370: 206a 6f69 6e73 2073 6f20 7765 206e 6565   joins so we nee
-0000d380: 6420 746f 2061 6464 2074 6865 6d20 6173  d to add them as
-0000d390: 2061 2064 6570 0a20 2020 2020 2020 2020   a dep.         
-0000d3a0: 2020 2020 2020 2064 6570 7320 2b3d 2074         deps += t
-0000d3b0: 6162 6c65 730a 2020 2020 2020 2020 2020  ables.          
-0000d3c0: 2020 2020 2020 2320 6765 6e65 7261 7465        # generate
-0000d3d0: 2072 6570 6c61 6365 6d65 6e74 7320 616e   replacements an
-0000d3e0: 6420 7265 706c 6163 6520 7468 6520 7175  d replace the qu
-0000d3f0: 6572 790a 2020 2020 2020 2020 2020 2020  ery.            
-0000d400: 2020 2020 7265 706c 6163 656d 656e 7473      replacements
-0000d410: 203d 207b 743a 2074 202b 2072 6573 6f75   = {t: t + resou
-0000d420: 7263 655f 7665 7273 696f 6e73 5f73 7472  rce_versions_str
-0000d430: 696e 672e 6765 7428 742c 2022 2229 2066  ing.get(t, "") f
-0000d440: 6f72 2074 2069 6e20 7461 626c 6573 7d0a  or t in tables}.
-0000d450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d460: 2072 6570 6c61 6365 645f 7265 7375 6c74   replaced_result
-0000d470: 7320 3d20 6177 6169 7420 7462 5f63 6c69  s = await tb_cli
-0000d480: 656e 742e 7265 706c 6163 655f 7461 626c  ent.replace_tabl
-0000d490: 6573 2871 2c20 7265 706c 6163 656d 656e  es(q, replacemen
-0000d4a0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-0000d4b0: 2020 2020 785b 2264 6566 6175 6c74 5f76      x["default_v
-0000d4c0: 616c 7565 225d 203d 2072 6570 6c61 6365  alue"] = replace
-0000d4d0: 645f 7265 7375 6c74 732e 7265 706c 6163  d_results.replac
-0000d4e0: 6528 2253 454c 4543 5422 2c20 226d 6174  e("SELECT", "mat
-0000d4f0: 6572 6961 6c69 7a65 6422 2c20 3129 0a20  erialized", 1). 
-0000d500: 2020 2020 2020 2020 2020 2069 6620 782e             if x.
-0000d510: 6765 7428 226a 736f 6e70 6174 6822 2c20  get("jsonpath", 
-0000d520: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
-0000d530: 2020 2020 2020 205f 666f 726d 6174 203d         _format =
-0000d540: 2022 6e64 6a73 6f6e 220a 0a20 2020 2020   "ndjson"..     
-0000d550: 2020 2073 6368 656d 6120 3d20 222c 222e     schema = ",".
-0000d560: 6a6f 696e 2873 6368 656d 615f 746f 5f73  join(schema_to_s
-0000d570: 716c 5f63 6f6c 756d 6e73 2863 6f6c 756d  ql_columns(colum
-0000d580: 6e73 2929 0a0a 2020 2020 2020 2020 6e61  ns))..        na
-0000d590: 6d65 203d 206f 732e 7061 7468 2e62 6173  me = os.path.bas
-0000d5a0: 656e 616d 6528 6669 6c65 6e61 6d65 292e  ename(filename).
-0000d5b0: 7273 706c 6974 2822 2e22 2c20 3129 5b30  rsplit(".", 1)[0
-0000d5c0: 5d0a 0a20 2020 2020 2020 2069 6620 776f  ]..        if wo
-0000d5d0: 726b 7370 6163 655f 6c69 625f 7061 7468  rkspace_lib_path
-0000d5e0: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
-0000d5f0: 6f72 2077 6b5f 6e61 6d65 2c20 776b 5f70  or wk_name, wk_p
-0000d600: 6174 6820 696e 2077 6f72 6b73 7061 6365  ath in workspace
-0000d610: 5f6c 6962 5f70 6174 6873 3a0a 2020 2020  _lib_paths:.    
-0000d620: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000d630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d640: 2020 2020 2050 6174 6828 6669 6c65 6e61       Path(filena
-0000d650: 6d65 292e 7265 6c61 7469 7665 5f74 6f28  me).relative_to(
-0000d660: 776b 5f70 6174 6829 0a20 2020 2020 2020  wk_path).       
-0000d670: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-0000d680: 6520 3d20 6622 7b77 6f72 6b73 7061 6365  e = f"{workspace
-0000d690: 5f6d 6170 2e67 6574 2877 6b5f 6e61 6d65  _map.get(wk_name
-0000d6a0: 2c20 776b 5f6e 616d 6529 7d2e 7b6e 616d  , wk_name)}.{nam
-0000d6b0: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
-0000d6c0: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
-0000d6d0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0000d6e0: 2020 2020 2020 2020 2020 2023 2074 6865             # the
-0000d6f0: 2070 6174 6820 7761 7320 6e6f 7420 7265   path was not re
-0000d700: 6c61 7469 7665 2c20 6e6f 7420 696e 7369  lative, not insi
-0000d710: 6465 2077 6f72 6b73 7061 6365 0a20 2020  de workspace.   
-0000d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d730: 2070 6173 730a 0a20 2020 2020 2020 2072   pass..        r
-0000d740: 6573 5f6e 616d 6520 3d20 6e61 6d65 0a20  es_name = name. 
-0000d750: 2020 2020 2020 2076 6572 7369 6f6e 203d         version =
-0000d760: 2066 225f 5f76 7b64 6f63 2e76 6572 7369   f"__v{doc.versi
-0000d770: 6f6e 7d22 2069 6620 646f 632e 7665 7273  on}" if doc.vers
-0000d780: 696f 6e20 6973 206e 6f74 204e 6f6e 6520  ion is not None 
-0000d790: 656c 7365 2022 220a 0a20 2020 2020 2020  else ""..       
-0000d7a0: 2064 6566 2061 7070 656e 645f 7665 7273   def append_vers
-0000d7b0: 696f 6e5f 746f 5f6e 616d 6528 6e61 6d65  ion_to_name(name
-0000d7c0: 3a20 7374 722c 2076 6572 7369 6f6e 3a20  : str, version: 
-0000d7d0: 7374 7229 202d 3e20 7374 723a 0a20 2020  str) -> str:.   
-0000d7e0: 2020 2020 2020 2020 2069 6620 7665 7273           if vers
-0000d7f0: 696f 6e20 213d 2022 223a 0a20 2020 2020  ion != "":.     
-0000d800: 2020 2020 2020 2020 2020 206e 616d 6520             name 
-0000d810: 3d20 6e61 6d65 2e72 6570 6c61 6365 2822  = name.replace("
-0000d820: 2e22 2c20 225f 2229 0a20 2020 2020 2020  .", "_").       
-0000d830: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000d840: 6e61 6d65 202b 2076 6572 7369 6f6e 0a20  name + version. 
-0000d850: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000d860: 6e20 6e61 6d65 0a0a 2020 2020 2020 2020  n name..        
-0000d870: 6465 7363 7269 7074 696f 6e20 3d20 6e6f  description = no
-0000d880: 6465 2e67 6574 2822 6465 7363 7269 7074  de.get("descript
-0000d890: 696f 6e22 2c20 2222 290a 2020 2020 2020  ion", "").      
-0000d8a0: 2020 696e 6465 7865 735f 6c69 7374 203d    indexes_list =
-0000d8b0: 206e 6f64 652e 6765 7428 2269 6e64 6578   node.get("index
-0000d8c0: 6573 222c 205b 5d29 0a20 2020 2020 2020  es", []).       
-0000d8d0: 2069 6e64 6578 6573 203d 204e 6f6e 650a   indexes = None.
-0000d8e0: 2020 2020 2020 2020 6966 2069 6e64 6578          if index
-0000d8f0: 6573 5f6c 6973 743a 0a20 2020 2020 2020  es_list:.       
-0000d900: 2020 2020 2069 6e64 6578 6573 203d 2022       indexes = "
-0000d910: 5c6e 222e 6a6f 696e 285b 696e 6465 782e  \n".join([index.
-0000d920: 746f 5f73 716c 2829 2066 6f72 2069 6e64  to_sql() for ind
-0000d930: 6578 2069 6e20 696e 6465 7865 735f 6c69  ex in indexes_li
-0000d940: 7374 5d29 0a20 2020 2020 2020 2070 6172  st]).        par
-0000d950: 616d 7320 3d20 7b0a 2020 2020 2020 2020  ams = {.        
-0000d960: 2020 2020 226e 616d 6522 3a20 6170 7065      "name": appe
-0000d970: 6e64 5f76 6572 7369 6f6e 5f74 6f5f 6e61  nd_version_to_na
-0000d980: 6d65 286e 616d 652c 2076 6572 7369 6f6e  me(name, version
-0000d990: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
-0000d9a0: 6465 7363 7269 7074 696f 6e22 3a20 6465  description": de
-0000d9b0: 7363 7269 7074 696f 6e2c 0a20 2020 2020  scription,.     
-0000d9c0: 2020 2020 2020 2022 7363 6865 6d61 223a         "schema":
-0000d9d0: 2073 6368 656d 612c 0a20 2020 2020 2020   schema,.       
-0000d9e0: 2020 2020 2022 696e 6465 7865 7322 3a20       "indexes": 
-0000d9f0: 696e 6465 7865 732c 0a20 2020 2020 2020  indexes,.       
-0000da00: 2020 2020 2022 696e 6465 7865 735f 6c69       "indexes_li
-0000da10: 7374 223a 2069 6e64 6578 6573 5f6c 6973  st": indexes_lis
-0000da20: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
-0000da30: 666f 726d 6174 223a 205f 666f 726d 6174  format": _format
-0000da40: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-0000da50: 2020 2020 2070 6172 616d 732e 7570 6461       params.upda
-0000da60: 7465 2867 6574 5f65 6e67 696e 655f 7061  te(get_engine_pa
-0000da70: 7261 6d73 286e 6f64 6529 290a 0a20 2020  rams(node))..   
-0000da80: 2020 2020 2069 6620 2269 6d70 6f72 745f       if "import_
-0000da90: 7365 7276 6963 6522 2069 6e20 6e6f 6465  service" in node
-0000daa0: 206f 7220 2269 6d70 6f72 745f 636f 6e6e   or "import_conn
-0000dab0: 6563 7469 6f6e 5f6e 616d 6522 2069 6e20  ection_name" in 
-0000dac0: 6e6f 6465 3a0a 2020 2020 2020 2020 2020  node:.          
-0000dad0: 2020 5641 4c49 445f 5345 5256 4943 4553    VALID_SERVICES
-0000dae0: 3a20 5475 706c 655b 7374 722c 202e 2e2e  : Tuple[str, ...
-0000daf0: 5d20 3d20 2822 6269 6771 7565 7279 222c  ] = ("bigquery",
-0000db00: 2022 736e 6f77 666c 616b 6522 2c20 2273   "snowflake", "s
-0000db10: 3322 2c20 2273 335f 6961 6d72 6f6c 6522  3", "s3_iamrole"
-0000db20: 2c20 2267 6373 2229 0a0a 2020 2020 2020  , "gcs")..      
-0000db30: 2020 2020 2020 696d 706f 7274 5f70 6172        import_par
-0000db40: 616d 7320 3d20 6177 6169 7420 6765 745f  ams = await get_
-0000db50: 696d 706f 7274 5f70 6172 616d 7328 7061  import_params(pa
-0000db60: 7261 6d73 2c20 6e6f 6465 290a 0a20 2020  rams, node)..   
-0000db70: 2020 2020 2020 2020 2073 6572 7669 6365           service
-0000db80: 203d 2069 6d70 6f72 745f 7061 7261 6d73   = import_params
-0000db90: 2e67 6574 2822 696d 706f 7274 5f73 6572  .get("import_ser
-0000dba0: 7669 6365 222c 204e 6f6e 6529 0a20 2020  vice", None).   
-0000dbb0: 2020 2020 2020 2020 2069 6620 7365 7276           if serv
-0000dbc0: 6963 6520 616e 6420 7365 7276 6963 6520  ice and service 
-0000dbd0: 6e6f 7420 696e 2056 414c 4944 5f53 4552  not in VALID_SER
-0000dbe0: 5649 4345 533a 0a20 2020 2020 2020 2020  VICES:.         
-0000dbf0: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-0000dc00: 6570 7469 6f6e 2866 2255 6e6b 6e6f 776e  eption(f"Unknown
-0000dc10: 2069 6d70 6f72 7420 7365 7276 6963 653a   import service:
-0000dc20: 207b 7365 7276 6963 657d 2229 0a0a 2020   {service}")..  
-0000dc30: 2020 2020 2020 2020 2020 6966 2073 6572            if ser
-0000dc40: 7669 6365 2069 6e20 5052 4556 4945 575f  vice in PREVIEW_
-0000dc50: 434f 4e4e 4543 544f 525f 5345 5256 4943  CONNECTOR_SERVIC
-0000dc60: 4553 3a0a 2020 2020 2020 2020 2020 2020  ES:.            
-0000dc70: 2020 2020 4f4e 5f44 454d 414e 445f 4352      ON_DEMAND_CR
-0000dc80: 4f4e 203d 204f 4e5f 4445 4d41 4e44 0a20  ON = ON_DEMAND. 
-0000dc90: 2020 2020 2020 2020 2020 2020 2020 2041                 A
-0000dca0: 5554 4f5f 4352 4f4e 203d 2022 4061 7574  UTO_CRON = "@aut
-0000dcb0: 6f22 0a20 2020 2020 2020 2020 2020 2020  o".             
-0000dcc0: 2020 204f 4e5f 4445 4d41 4e44 5f43 524f     ON_DEMAND_CRO
-0000dcd0: 4e5f 4558 5045 4354 4544 5f42 595f 5448  N_EXPECTED_BY_TH
-0000dce0: 455f 4150 4920 3d20 2240 6f6e 6365 220a  E_API = "@once".
-0000dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd00: 5641 4c49 445f 4352 4f4e 533a 2054 7570  VALID_CRONS: Tup
-0000dd10: 6c65 5b73 7472 2c20 2e2e 2e5d 203d 2028  le[str, ...] = (
-0000dd20: 4f4e 5f44 454d 414e 445f 4352 4f4e 2c20  ON_DEMAND_CRON, 
-0000dd30: 4155 544f 5f43 524f 4e29 0a20 2020 2020  AUTO_CRON).     
-0000dd40: 2020 2020 2020 2020 2020 2063 726f 6e20             cron 
-0000dd50: 3d20 6e6f 6465 2e67 6574 2822 696d 706f  = node.get("impo
-0000dd60: 7274 5f73 6368 6564 756c 6522 2c20 4f4e  rt_schedule", ON
-0000dd70: 5f44 454d 414e 445f 4352 4f4e 290a 0a20  _DEMAND_CRON).. 
-0000dd80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000dd90: 6620 6372 6f6e 206e 6f74 2069 6e20 5641  f cron not in VA
-0000dda0: 4c49 445f 4352 4f4e 533a 0a20 2020 2020  LID_CRONS:.     
-0000ddb0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0000ddc0: 616c 6964 5f76 616c 7565 7320 3d20 222c  alid_values = ",
-0000ddd0: 2022 2e6a 6f69 6e28 5641 4c49 445f 4352   ".join(VALID_CR
-0000dde0: 4f4e 5329 0a20 2020 2020 2020 2020 2020  ONS).           
-0000ddf0: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
-0000de00: 7863 6570 7469 6f6e 2866 2249 6e76 616c  xception(f"Inval
-0000de10: 6964 2069 6d70 6f72 7420 7363 6865 6475  id import schedu
-0000de20: 6c65 3a20 277b 6372 6f6e 7d27 2e20 5661  le: '{cron}'. Va
-0000de30: 6c69 6420 7661 6c75 6573 2061 7265 3a20  lid values are: 
-0000de40: 7b76 616c 6964 5f76 616c 7565 737d 2229  {valid_values}")
-0000de50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000de60: 2020 6966 2063 726f 6e20 3d3d 204f 4e5f    if cron == ON_
-0000de70: 4445 4d41 4e44 5f43 524f 4e3a 0a20 2020  DEMAND_CRON:.   
-0000de80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de90: 2069 6d70 6f72 745f 7061 7261 6d73 5b22   import_params["
-0000dea0: 696d 706f 7274 5f73 6368 6564 756c 6522  import_schedule"
-0000deb0: 5d20 3d20 4f4e 5f44 454d 414e 445f 4352  ] = ON_DEMAND_CR
-0000dec0: 4f4e 5f45 5850 4543 5445 445f 4259 5f54  ON_EXPECTED_BY_T
-0000ded0: 4845 5f41 5049 0a20 2020 2020 2020 2020  HE_API.         
-0000dee0: 2020 2020 2020 2069 6620 6372 6f6e 203d         if cron =
-0000def0: 3d20 4155 544f 5f43 524f 4e20 616e 6420  = AUTO_CRON and 
-0000df00: 6375 7272 656e 745f 7773 3a0a 2020 2020  current_ws:.    
-0000df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df20: 776f 726b 7370 6163 6573 203d 2028 6177  workspaces = (aw
-0000df30: 6169 7420 7462 5f63 6c69 656e 742e 7573  ait tb_client.us
-0000df40: 6572 5f77 6f72 6b73 7061 6365 7328 2929  er_workspaces())
-0000df50: 2e67 6574 2822 776f 726b 7370 6163 6573  .get("workspaces
-0000df60: 222c 205b 5d29 0a20 2020 2020 2020 2020  ", []).         
-0000df70: 2020 2020 2020 2020 2020 2072 6174 655f             rate_
-0000df80: 6c69 6d69 7473 3a20 4469 6374 5b73 7472  limits: Dict[str
-0000df90: 2c20 4469 6374 5b73 7472 2c20 696e 745d  , Dict[str, int]
-0000dfa0: 5d20 3d20 6e65 7874 280a 2020 2020 2020  ] = next(.      
-0000dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dfc0: 2020 2877 2e67 6574 2822 7261 7465 5f6c    (w.get("rate_l
-0000dfd0: 696d 6974 7322 2c20 7b7d 2920 666f 7220  imits", {}) for 
-0000dfe0: 7720 696e 2077 6f72 6b73 7061 6365 7320  w in workspaces 
-0000dff0: 6966 2077 5b22 6964 225d 203d 3d20 6375  if w["id"] == cu
-0000e000: 7272 656e 745f 7773 5b22 6964 225d 292c  rrent_ws["id"]),
-0000e010: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
-0000e020: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000e030: 2020 2020 2020 2020 2020 2020 2020 7065                pe
-0000e040: 7269 6f64 3a20 696e 7420 3d20 7261 7465  riod: int = rate
-0000e050: 5f6c 696d 6974 732e 6765 7428 2261 7069  _limits.get("api
-0000e060: 5f64 6174 6173 6f75 7263 6573 5f63 7265  _datasources_cre
-0000e070: 6174 655f 6170 7065 6e64 5f72 6570 6c61  ate_append_repla
-0000e080: 6365 222c 207b 7d29 2e67 6574 2822 7065  ce", {}).get("pe
-0000e090: 7269 6f64 222c 2036 3029 0a0a 2020 2020  riod", 60)..    
-0000e0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e0b0: 6465 6620 7365 636f 6e64 735f 746f 5f63  def seconds_to_c
-0000e0c0: 726f 6e5f 6578 7072 6573 7369 6f6e 2873  ron_expression(s
-0000e0d0: 6563 6f6e 6473 3a20 696e 7429 202d 3e20  econds: int) -> 
-0000e0e0: 7374 723a 0a20 2020 2020 2020 2020 2020  str:.           
-0000e0f0: 2020 2020 2020 2020 2020 2020 206d 696e               min
-0000e100: 7574 6573 203d 2073 6563 6f6e 6473 202f  utes = seconds /
-0000e110: 2f20 3630 0a20 2020 2020 2020 2020 2020  / 60.           
-0000e120: 2020 2020 2020 2020 2020 2020 2068 6f75               hou
-0000e130: 7273 203d 206d 696e 7574 6573 202f 2f20  rs = minutes // 
-0000e140: 3630 0a20 2020 2020 2020 2020 2020 2020  60.             
-0000e150: 2020 2020 2020 2020 2020 2064 6179 7320             days 
-0000e160: 3d20 686f 7572 7320 2f2f 2032 340a 2020  = hours // 24.  
-0000e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e180: 2020 2020 2020 6966 2064 6179 7320 3e20        if days > 
-0000e190: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0000e1a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000e1b0: 6574 7572 6e20 6622 3020 3020 2a2f 7b64  eturn f"0 0 */{d
-0000e1c0: 6179 737d 202a 202a 220a 2020 2020 2020  ays} * *".      
-0000e1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1e0: 2020 6966 2068 6f75 7273 203e 2030 3a0a    if hours > 0:.
-0000e1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e200: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000e210: 726e 2066 2230 202a 2f7b 686f 7572 737d  rn f"0 */{hours}
-0000e220: 202a 202a 202a 220a 2020 2020 2020 2020   * * *".        
-0000e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e240: 6966 206d 696e 7574 6573 203e 2030 3a0a  if minutes > 0:.
-0000e250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e260: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000e270: 726e 2066 222a 2f7b 6d69 6e75 7465 737d  rn f"*/{minutes}
-0000e280: 202a 202a 202a 202a 220a 2020 2020 2020   * * * *".      
-0000e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e2a0: 2020 7265 7475 726e 2066 222a 2f7b 7365    return f"*/{se
-0000e2b0: 636f 6e64 737d 202a 202a 202a 202a 220a  conds} * * * *".
-0000e2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e2d0: 2020 2020 2069 6d70 6f72 745f 7061 7261       import_para
-0000e2e0: 6d73 5b22 696d 706f 7274 5f73 6368 6564  ms["import_sched
-0000e2f0: 756c 6522 5d20 3d20 7365 636f 6e64 735f  ule"] = seconds_
-0000e300: 746f 5f63 726f 6e5f 6578 7072 6573 7369  to_cron_expressi
-0000e310: 6f6e 2870 6572 696f 6429 0a0a 2020 2020  on(period)..    
-0000e320: 2020 2020 2020 2020 2320 496e 636c 7564          # Includ
-0000e330: 6520 616c 6c20 696d 706f 7274 5f20 7061  e all import_ pa
-0000e340: 7261 6d65 7465 7273 2069 6e20 7468 6520  rameters in the 
-0000e350: 6461 7461 736f 7572 6365 2070 6172 616d  datasource param
-0000e360: 730a 2020 2020 2020 2020 2020 2020 7061  s.            pa
-0000e370: 7261 6d73 2e75 7064 6174 6528 696d 706f  rams.update(impo
-0000e380: 7274 5f70 6172 616d 7329 0a0a 2020 2020  rt_params)..    
-0000e390: 2020 2020 2020 2020 2320 5375 6273 7469          # Substi
-0000e3a0: 7475 7465 2074 6865 2069 6d70 6f72 7420  tute the import 
-0000e3b0: 7061 7261 6d65 7465 7273 2077 6974 6820  parameters with 
-0000e3c0: 7468 6520 6f6e 6573 2075 7365 6420 6279  the ones used by
-0000e3d0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-0000e3e0: 2023 2069 6d70 6f72 7420 4150 493a 0a20   # import API:. 
-0000e3f0: 2020 2020 2020 2020 2020 2023 202d 2049             # - I
-0000e400: 6620 616e 2069 6d70 6f72 7420 7061 7261  f an import para
-0000e410: 6d65 7465 7220 6973 206e 6f74 2070 7265  meter is not pre
-0000e420: 7365 6e74 2061 6e64 2074 6865 7265 2773  sent and there's
-0000e430: 2061 2064 6566 6175 6c74 0a20 2020 2020   a default.     
-0000e440: 2020 2020 2020 2023 2020 2076 616c 7565         #   value
-0000e450: 2c20 7573 6520 7468 6520 6465 6661 756c  , use the defaul
-0000e460: 7420 7661 6c75 652e 0a20 2020 2020 2020  t value..       
-0000e470: 2020 2020 2023 202d 2049 6620 7468 6520       # - If the 
-0000e480: 7265 7375 6c74 696e 6720 7661 6c75 6520  resulting value 
-0000e490: 6973 204e 6f6e 652c 2064 6f20 6e6f 7420  is None, do not 
-0000e4a0: 6164 6420 7468 6520 7061 7261 6d65 7465  add the paramete
-0000e4b0: 722e 0a20 2020 2020 2020 2020 2020 2023  r..            #
-0000e4c0: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-0000e4d0: 6f74 653a 2061 6e79 2075 6e6b 6e6f 776e  ote: any unknown
-0000e4e0: 2069 6d70 6f72 745f 2070 6172 616d 6574   import_ paramet
-0000e4f0: 6572 2069 7320 6c65 6176 6564 2061 7320  er is leaved as 
-0000e500: 6973 2e0a 2020 2020 2020 2020 2020 2020  is..            
-0000e510: 666f 7220 6b65 7920 696e 2049 6d70 6f72  for key in Impor
-0000e520: 7452 6570 6c61 6365 6d65 6e74 732e 6765  tReplacements.ge
-0000e530: 745f 6461 7461 6669 6c65 5f70 6172 616d  t_datafile_param
-0000e540: 6574 6572 5f6b 6579 7328 293a 0a20 2020  eter_keys():.   
-0000e550: 2020 2020 2020 2020 2020 2020 2072 6570               rep
-0000e560: 6c61 6365 6d65 6e74 2c20 6465 6661 756c  lacement, defaul
-0000e570: 745f 7661 6c75 6520 3d20 496d 706f 7274  t_value = Import
-0000e580: 5265 706c 6163 656d 656e 7473 2e67 6574  Replacements.get
-0000e590: 5f61 7069 5f70 6172 616d 5f66 6f72 5f64  _api_param_for_d
-0000e5a0: 6174 6166 696c 655f 7061 7261 6d28 7365  atafile_param(se
-0000e5b0: 7276 6963 652c 206b 6579 290a 2020 2020  rvice, key).    
-0000e5c0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000e5d0: 6f74 2072 6570 6c61 6365 6d65 6e74 3a0a  ot replacement:.
-0000e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5f0: 2020 2020 636f 6e74 696e 7565 2020 2320      continue  # 
-0000e600: 5765 2073 686f 756c 6420 6e6f 7420 7265  We should not re
-0000e610: 6163 6820 7468 6973 206e 6576 6572 2c20  ach this never, 
-0000e620: 6275 7420 6a75 7374 2069 6e20 6361 7365  but just in case
-0000e630: 2e2e 2e0a 0a20 2020 2020 2020 2020 2020  .....           
-0000e640: 2020 2020 2076 616c 7565 3a20 416e 790a       value: Any.
-0000e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e660: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000e670: 2020 2020 2020 2020 2076 616c 7565 203d           value =
-0000e680: 2070 6172 616d 735b 6b65 795d 0a20 2020   params[key].   
-0000e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e6a0: 2064 656c 2070 6172 616d 735b 6b65 795d   del params[key]
-0000e6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e6c0: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-0000e6d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e6e0: 2020 2020 2020 7661 6c75 6520 3d20 6465        value = de
-0000e6f0: 6661 756c 745f 7661 6c75 650a 0a20 2020  fault_value..   
-0000e700: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000e710: 7661 6c75 653a 0a20 2020 2020 2020 2020  value:.         
-0000e720: 2020 2020 2020 2020 2020 2070 6172 616d             param
-0000e730: 735b 7265 706c 6163 656d 656e 745d 203d  s[replacement] =
-0000e740: 2076 616c 7565 0a0a 2020 2020 2020 2020   value..        
-0000e750: 6966 2022 6b61 666b 615f 636f 6e6e 6563  if "kafka_connec
-0000e760: 7469 6f6e 5f6e 616d 6522 2069 6e20 6e6f  tion_name" in no
-0000e770: 6465 3a0a 2020 2020 2020 2020 2020 2020  de:.            
-0000e780: 6b61 666b 615f 7061 7261 6d73 203d 2061  kafka_params = a
-0000e790: 7761 6974 2067 6574 5f6b 6166 6b61 5f70  wait get_kafka_p
-0000e7a0: 6172 616d 7328 6e6f 6465 290a 2020 2020  arams(node).    
-0000e7b0: 2020 2020 2020 2020 7061 7261 6d73 2e75          params.u
-0000e7c0: 7064 6174 6528 6b61 666b 615f 7061 7261  pdate(kafka_para
-0000e7d0: 6d73 290a 2020 2020 2020 2020 2020 2020  ms).            
-0000e7e0: 6465 6c20 7061 7261 6d73 5b22 666f 726d  del params["form
-0000e7f0: 6174 225d 0a0a 2020 2020 2020 2020 6966  at"]..        if
-0000e800: 2022 7461 6773 2220 696e 206e 6f64 653a   "tags" in node:
-0000e810: 0a20 2020 2020 2020 2020 2020 2074 6167  .            tag
-0000e820: 7320 3d20 7b6b 3a20 765b 305d 2066 6f72  s = {k: v[0] for
-0000e830: 206b 2c20 7620 696e 2075 726c 6c69 622e   k, v in urllib.
-0000e840: 7061 7273 652e 7061 7273 655f 7173 286e  parse.parse_qs(n
-0000e850: 6f64 655b 2274 6167 7322 5d29 2e69 7465  ode["tags"]).ite
-0000e860: 6d73 2829 7d0a 2020 2020 2020 2020 2020  ms()}.          
-0000e870: 2020 7061 7261 6d73 2e75 7064 6174 6528    params.update(
-0000e880: 7461 6773 290a 0a20 2020 2020 2020 2072  tags)..        r
-0000e890: 6573 6f75 7263 6573 3a20 4c69 7374 5b44  esources: List[D
-0000e8a0: 6963 745b 7374 722c 2041 6e79 5d5d 203d  ict[str, Any]] =
-0000e8b0: 205b 5d0a 0a20 2020 2020 2020 2072 6573   []..        res
-0000e8c0: 6f75 7263 6573 2e61 7070 656e 6428 0a20  ources.append(. 
-0000e8d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0000e8e0: 2020 2020 2020 2020 2020 2020 2022 7265               "re
-0000e8f0: 736f 7572 6365 223a 2022 6461 7461 736f  source": "dataso
-0000e900: 7572 6365 7322 2c0a 2020 2020 2020 2020  urces",.        
-0000e910: 2020 2020 2020 2020 2272 6573 6f75 7263          "resourc
-0000e920: 655f 6e61 6d65 223a 206e 616d 652c 0a20  e_name": name,. 
-0000e930: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000e940: 7665 7273 696f 6e22 3a20 646f 632e 7665  version": doc.ve
-0000e950: 7273 696f 6e2c 0a20 2020 2020 2020 2020  rsion,.         
-0000e960: 2020 2020 2020 2022 7061 7261 6d73 223a         "params":
-0000e970: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-0000e980: 2020 2020 2020 2020 2022 6669 6c65 6e61           "filena
-0000e990: 6d65 223a 2066 696c 656e 616d 652c 0a20  me": filename,. 
-0000e9a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000e9b0: 6b65 7973 223a 2064 6f63 2e6b 6579 732c  keys": doc.keys,
-0000e9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e9d0: 2022 6465 7073 223a 2064 6570 732c 0a20   "deps": deps,. 
-0000e9e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000e9f0: 746f 6b65 6e73 223a 2064 6f63 2e74 6f6b  tokens": doc.tok
-0000ea00: 656e 732c 0a20 2020 2020 2020 2020 2020  ens,.           
-0000ea10: 2020 2020 2022 7368 6172 6564 5f77 6974       "shared_wit
-0000ea20: 6822 3a20 646f 632e 7368 6172 6564 5f77  h": doc.shared_w
-0000ea30: 6974 682c 0a20 2020 2020 2020 2020 2020  ith,.           
-0000ea40: 207d 0a20 2020 2020 2020 2029 0a0a 2020   }.        )..  
-0000ea50: 2020 2020 2020 2320 6765 6e65 7261 7465        # generate
-0000ea60: 2065 7874 7261 2072 6573 6f75 7263 6573   extra resources
-0000ea70: 2069 6e20 6361 7365 206f 6620 7468 6520   in case of the 
-0000ea80: 6b65 790a 2020 2020 2020 2020 6966 2064  key.        if d
-0000ea90: 6f63 2e6b 6579 733a 0a20 2020 2020 2020  oc.keys:.       
-0000eaa0: 2020 2020 2066 6f72 206b 2069 6e20 646f       for k in do
-0000eab0: 632e 6b65 7973 3a0a 2020 2020 2020 2020  c.keys:.        
-0000eac0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-0000ead0: 7320 2b3d 2067 656e 6572 6174 655f 7265  s += generate_re
-0000eae0: 736f 7572 6365 5f66 6f72 5f6b 6579 286b  source_for_key(k
-0000eaf0: 5b22 636f 6c75 6d6e 225d 2c20 6e61 6d65  ["column"], name
-0000eb00: 2c20 7061 7261 6d73 5b22 7363 6865 6d61  , params["schema
-0000eb10: 225d 2c20 7665 7273 696f 6e2c 2072 6573  "], version, res
-0000eb20: 5f6e 616d 6529 0a20 2020 2020 2020 2020  _name).         
-0000eb30: 2020 2020 2020 2023 2073 6574 2064 6572         # set der
-0000eb40: 6976 6564 2072 6573 6f75 7263 6573 2076  ived resources v
-0000eb50: 6572 7369 6f6e 2074 6865 2073 616d 6520  ersion the same 
-0000eb60: 7468 6520 7061 7265 6e74 0a20 2020 2020  the parent.     
-0000eb70: 2020 2020 2020 2020 2020 2066 6f72 2078             for x
-0000eb80: 2069 6e20 7265 736f 7572 6365 733a 0a20   in resources:. 
-0000eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eba0: 2020 2078 5b22 7665 7273 696f 6e22 5d20     x["version"] 
-0000ebb0: 3d20 646f 632e 7665 7273 696f 6e0a 0a20  = doc.version.. 
-0000ebc0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-0000ebd0: 736f 7572 6365 730a 0a20 2020 2065 6c69  sources..    eli
-0000ebe0: 6620 4461 7461 4669 6c65 4578 7465 6e73  f DataFileExtens
-0000ebf0: 696f 6e73 2e50 4950 4520 696e 2066 696c  ions.PIPE in fil
-0000ec00: 656e 616d 653a 0a20 2020 2020 2020 2064  ename:.        d
-0000ec10: 6f63 203d 2070 6172 7365 5f70 6970 6528  oc = parse_pipe(
-0000ec20: 6669 6c65 6e61 6d65 290a 2020 2020 2020  filename).      
-0000ec30: 2020 7665 7273 696f 6e20 3d20 6622 5f5f    version = f"__
-0000ec40: 767b 646f 632e 7665 7273 696f 6e7d 2220  v{doc.version}" 
-0000ec50: 6966 2064 6f63 2e76 6572 7369 6f6e 2069  if doc.version i
-0000ec60: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
-0000ec70: 2222 0a20 2020 2020 2020 206e 616d 6520  "".        name 
-0000ec80: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-0000ec90: 6d65 2866 696c 656e 616d 6529 2e73 706c  me(filename).spl
-0000eca0: 6974 2822 2e22 295b 305d 0a20 2020 2020  it(".")[0].     
-0000ecb0: 2020 2064 6573 6372 6970 7469 6f6e 203d     description =
-0000ecc0: 2064 6f63 2e64 6573 6372 6970 7469 6f6e   doc.description
-0000ecd0: 2069 6620 646f 632e 6465 7363 7269 7074   if doc.descript
-0000ece0: 696f 6e20 6973 206e 6f74 204e 6f6e 6520  ion is not None 
-0000ecf0: 656c 7365 2022 220a 0a20 2020 2020 2020  else ""..       
-0000ed00: 2064 6570 7320 3d20 5b5d 0a20 2020 2020   deps = [].     
-0000ed10: 2020 206e 6f64 6573 3a20 4c69 7374 5b44     nodes: List[D
-0000ed20: 6963 745b 7374 722c 2041 6e79 5d5d 203d  ict[str, Any]] =
-0000ed30: 205b 5d0a 0a20 2020 2020 2020 2066 6f72   []..        for
-0000ed40: 206e 6f64 6520 696e 2064 6f63 2e6e 6f64   node in doc.nod
-0000ed50: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0000ed60: 7371 6c20 3d20 6e6f 6465 5b22 7371 6c22  sql = node["sql"
-0000ed70: 5d0a 2020 2020 2020 2020 2020 2020 6e6f  ].            no
-0000ed80: 6465 5f74 7970 6520 3d20 6e6f 6465 2e67  de_type = node.g
-0000ed90: 6574 2822 7479 7065 222c 2022 7374 616e  et("type", "stan
-0000eda0: 6461 7264 2229 2e6c 6f77 6572 2829 0a20  dard").lower(). 
-0000edb0: 2020 2020 2020 2020 2020 2070 6172 616d             param
-0000edc0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-0000edd0: 2020 2020 2020 226e 616d 6522 3a20 6e6f        "name": no
-0000ede0: 6465 5b22 6e61 6d65 225d 2c0a 2020 2020  de["name"],.    
-0000edf0: 2020 2020 2020 2020 2020 2020 2274 7970              "typ
-0000ee00: 6522 3a20 6e6f 6465 5f74 7970 652c 0a20  e": node_type,. 
-0000ee10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000ee20: 6465 7363 7269 7074 696f 6e22 3a20 6e6f  description": no
-0000ee30: 6465 2e67 6574 2822 6465 7363 7269 7074  de.get("descript
-0000ee40: 696f 6e22 2c20 2222 292c 0a20 2020 2020  ion", ""),.     
-0000ee50: 2020 2020 2020 2020 2020 2022 7461 7267             "targ
-0000ee60: 6574 5f64 6174 6173 6f75 7263 6522 3a20  et_datasource": 
-0000ee70: 6e6f 6465 2e67 6574 2822 7461 7267 6574  node.get("target
-0000ee80: 5f64 6174 6173 6f75 7263 6522 2c20 4e6f  _datasource", No
-0000ee90: 6e65 292c 0a20 2020 2020 2020 2020 2020  ne),.           
-0000eea0: 2020 2020 2022 636f 7079 5f73 6368 6564       "copy_sched
-0000eeb0: 756c 6522 3a20 6e6f 6465 2e67 6574 2843  ule": node.get(C
-0000eec0: 6f70 7950 6172 616d 6574 6572 732e 434f  opyParameters.CO
-0000eed0: 5059 5f53 4348 4544 554c 452c 204e 6f6e  PY_SCHEDULE, Non
-0000eee0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-0000eef0: 7d0a 0a20 2020 2020 2020 2020 2020 2069  }..            i
-0000ef00: 735f 6578 706f 7274 5f6e 6f64 6520 3d20  s_export_node = 
-0000ef10: 4578 706f 7274 5265 706c 6163 656d 656e  ExportReplacemen
-0000ef20: 7473 2e69 735f 6578 706f 7274 5f6e 6f64  ts.is_export_nod
-0000ef30: 6528 6e6f 6465 290a 2020 2020 2020 2020  e(node).        
-0000ef40: 2020 2020 6578 706f 7274 5f70 6172 616d      export_param
-0000ef50: 7320 3d20 4578 706f 7274 5265 706c 6163  s = ExportReplac
-0000ef60: 656d 656e 7473 2e67 6574 5f70 6172 616d  ements.get_param
-0000ef70: 735f 6672 6f6d 5f64 6174 6166 696c 6528  s_from_datafile(
-0000ef80: 6e6f 6465 2920 6966 2069 735f 6578 706f  node) if is_expo
-0000ef90: 7274 5f6e 6f64 6520 656c 7365 204e 6f6e  rt_node else Non
-0000efa0: 650a 0a20 2020 2020 2020 2020 2020 2073  e..            s
-0000efb0: 716c 203d 2073 716c 2e73 7472 6970 2829  ql = sql.strip()
-0000efc0: 0a20 2020 2020 2020 2020 2020 2069 735f  .            is_
-0000efd0: 7465 6d70 6c61 7465 203d 2046 616c 7365  template = False
-0000efe0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000eff0: 7371 6c5b 305d 203d 3d20 2225 223a 0a20  sql[0] == "%":. 
-0000f000: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000f010: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000f020: 2020 2020 2020 2020 7371 6c5f 7265 6e64          sql_rend
-0000f030: 6572 6564 2c20 5f20 3d20 7265 6e64 6572  ered, _ = render
-0000f040: 5f73 716c 5f74 656d 706c 6174 6528 7371  _sql_template(sq
-0000f050: 6c5b 313a 5d2c 2074 6573 745f 6d6f 6465  l[1:], test_mode
-0000f060: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-0000f070: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0000f080: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-0000f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0a0: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
-0000f0b0: 6963 6b45 7863 6570 7469 6f6e 280a 2020  ickException(.  
-0000f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0d0: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
-0000f0e0: 6e61 6765 722e 6572 726f 725f 7061 7273  nager.error_pars
-0000f0f0: 696e 675f 6e6f 6465 286e 6f64 653d 6e6f  ing_node(node=no
-0000f100: 6465 5b22 6e61 6d65 225d 2c20 7069 7065  de["name"], pipe
-0000f110: 3d6e 616d 652c 2065 7272 6f72 3d73 7472  =name, error=str
-0000f120: 2865 2929 0a20 2020 2020 2020 2020 2020  (e)).           
-0000f130: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0000f140: 2020 2020 2020 2020 2020 2069 735f 7465             is_te
-0000f150: 6d70 6c61 7465 203d 2054 7275 650a 2020  mplate = True.  
-0000f160: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f180: 7371 6c5f 7265 6e64 6572 6564 203d 2073  sql_rendered = s
-0000f190: 716c 0a0a 2020 2020 2020 2020 2020 2020  ql..            
-0000f1a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000f1b0: 2020 2020 2064 6570 656e 6465 6e63 6965       dependencie
-0000f1c0: 7320 3d20 6177 6169 7420 7462 5f63 6c69  s = await tb_cli
-0000f1d0: 656e 742e 7371 6c5f 6765 745f 7573 6564  ent.sql_get_used
-0000f1e0: 5f74 6162 6c65 7328 7371 6c5f 7265 6e64  _tables(sql_rend
-0000f1f0: 6572 6564 2c20 7261 6973 696e 673d 5472  ered, raising=Tr
-0000f200: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-0000f210: 2020 2020 6465 7073 202b 3d20 5b74 2066      deps += [t f
-0000f220: 6f72 2074 2069 6e20 6465 7065 6e64 656e  or t in dependen
-0000f230: 6369 6573 2069 6620 7420 6e6f 7420 696e  cies if t not in
-0000f240: 205b 6e5b 226e 616d 6522 5d20 666f 7220   [n["name"] for 
-0000f250: 6e20 696e 2064 6f63 2e6e 6f64 6573 5d5d  n in doc.nodes]]
-0000f260: 0a0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
-0000f270: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-0000f280: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-0000f290: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
-0000f2a0: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
-0000f2b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f2c0: 2020 2020 2046 6565 6462 6163 6b4d 616e       FeedbackMan
-0000f2d0: 6167 6572 2e65 7272 6f72 5f70 6172 7369  ager.error_parsi
-0000f2e0: 6e67 5f6e 6f64 6528 6e6f 6465 3d6e 6f64  ng_node(node=nod
-0000f2f0: 655b 226e 616d 6522 5d2c 2070 6970 653d  e["name"], pipe=
-0000f300: 6e61 6d65 2c20 6572 726f 723d 7374 7228  name, error=str(
-0000f310: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-0000f320: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000f330: 2020 2069 6620 6973 5f74 656d 706c 6174     if is_templat
-0000f340: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000f350: 2020 2064 6570 7320 2b3d 2067 6574 5f75     deps += get_u
-0000f360: 7365 645f 7461 626c 6573 5f69 6e5f 7465  sed_tables_in_te
-0000f370: 6d70 6c61 7465 2873 716c 5b31 3a5d 290a  mplate(sql[1:]).
-0000f380: 0a20 2020 2020 2020 2020 2020 2069 735f  .            is_
-0000f390: 6e65 6974 6865 725f 636f 7079 5f6e 6f72  neither_copy_nor
-0000f3a0: 5f6d 6174 6572 6961 6c69 7a65 6420 3d20  _materialized = 
-0000f3b0: 2264 6174 6173 6f75 7263 6522 206e 6f74  "datasource" not
-0000f3c0: 2069 6e20 6e6f 6465 2061 6e64 2022 7461   in node and "ta
-0000f3d0: 7267 6574 5f64 6174 6173 6f75 7263 6522  rget_datasource"
-0000f3e0: 206e 6f74 2069 6e20 6e6f 6465 0a20 2020   not in node.   
-0000f3f0: 2020 2020 2020 2020 2069 6620 2265 6e67           if "eng
-0000f400: 696e 6522 2069 6e20 6e6f 6465 2061 6e64  ine" in node and
-0000f410: 2069 735f 6e65 6974 6865 725f 636f 7079   is_neither_copy
-0000f420: 5f6e 6f72 5f6d 6174 6572 6961 6c69 7a65  _nor_materialize
-0000f430: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-0000f440: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0000f450: 726f 7228 2244 6566 696e 696e 6720 454e  ror("Defining EN
-0000f460: 4749 4e45 206f 7074 696f 6e73 2069 6e20  GINE options in 
-0000f470: 6120 6e6f 6465 2072 6571 7569 7265 7320  a node requires 
-0000f480: 6120 4441 5441 534f 5552 4345 2229 0a0a  a DATASOURCE")..
-0000f490: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-0000f4a0: 6461 7461 736f 7572 6365 2220 696e 206e  datasource" in n
-0000f4b0: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
-0000f4c0: 2020 2020 2070 6172 616d 735b 2264 6174       params["dat
-0000f4d0: 6173 6f75 7263 6522 5d20 3d20 6e6f 6465  asource"] = node
-0000f4e0: 5b22 6461 7461 736f 7572 6365 225d 202b  ["datasource"] +
-0000f4f0: 2072 6573 6f75 7263 655f 7665 7273 696f   resource_versio
-0000f500: 6e73 5f73 7472 696e 672e 6765 7428 6e6f  ns_string.get(no
-0000f510: 6465 5b22 6461 7461 736f 7572 6365 225d  de["datasource"]
-0000f520: 2c20 2222 290a 2020 2020 2020 2020 2020  , "").          
-0000f530: 2020 2020 2020 6465 7073 202b 3d20 5b6e        deps += [n
-0000f540: 6f64 655b 2264 6174 6173 6f75 7263 6522  ode["datasource"
-0000f550: 5d5d 0a0a 2020 2020 2020 2020 2020 2020  ]]..            
-0000f560: 6966 2022 7461 7267 6574 5f64 6174 6173  if "target_datas
-0000f570: 6f75 7263 6522 2069 6e20 6e6f 6465 3a0a  ource" in node:.
-0000f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f590: 7061 7261 6d73 5b22 7461 7267 6574 5f64  params["target_d
-0000f5a0: 6174 6173 6f75 7263 6522 5d20 3d20 6e6f  atasource"] = no
-0000f5b0: 6465 5b22 7461 7267 6574 5f64 6174 6173  de["target_datas
-0000f5c0: 6f75 7263 6522 5d20 2b20 7265 736f 7572  ource"] + resour
-0000f5d0: 6365 5f76 6572 7369 6f6e 735f 7374 7269  ce_versions_stri
-0000f5e0: 6e67 2e67 6574 280a 2020 2020 2020 2020  ng.get(.        
-0000f5f0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-0000f600: 5b22 7461 7267 6574 5f64 6174 6173 6f75  ["target_datasou
-0000f610: 7263 6522 5d2c 2022 220a 2020 2020 2020  rce"], "".      
-0000f620: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0000f630: 2020 2020 2020 2020 2020 2020 6465 7073              deps
-0000f640: 202b 3d20 5b6e 6f64 655b 2274 6172 6765   += [node["targe
-0000f650: 745f 6461 7461 736f 7572 6365 225d 5d0a  t_datasource"]].
-0000f660: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-0000f670: 616d 732e 7570 6461 7465 2867 6574 5f65  ams.update(get_e
-0000f680: 6e67 696e 655f 7061 7261 6d73 286e 6f64  ngine_params(nod
-0000f690: 6529 290a 0a20 2020 2020 2020 2020 2020  e))..           
-0000f6a0: 2064 6566 2063 7265 6174 655f 7265 706c   def create_repl
-0000f6b0: 6163 656d 656e 745f 666f 725f 7265 736f  acement_for_reso
-0000f6c0: 7572 6365 286e 616d 653a 2073 7472 2920  urce(name: str) 
-0000f6d0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-0000f6e0: 2020 2020 2020 2020 666f 7220 6f6c 645f          for old_
-0000f6f0: 7773 2c20 6e65 775f 7773 2069 6e20 776f  ws, new_ws in wo
-0000f700: 726b 7370 6163 655f 6d61 702e 6974 656d  rkspace_map.item
-0000f710: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000f720: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
-0000f730: 6e61 6d65 2e72 6570 6c61 6365 2866 227b  name.replace(f"{
-0000f740: 6f6c 645f 7773 7d2e 222c 2066 227b 6e65  old_ws}.", f"{ne
-0000f750: 775f 7773 7d2e 2229 0a20 2020 2020 2020  w_ws}.").       
-0000f760: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000f770: 6e61 6d65 202b 2072 6573 6f75 7263 655f  name + resource_
-0000f780: 7665 7273 696f 6e73 5f73 7472 696e 672e  versions_string.
-0000f790: 6765 7428 6e61 6d65 2c20 2222 290a 0a20  get(name, "").. 
-0000f7a0: 2020 2020 2020 2020 2020 2072 6570 6c61             repla
-0000f7b0: 6365 6d65 6e74 7320 3d20 7b0a 2020 2020  cements = {.    
-0000f7c0: 2020 2020 2020 2020 2020 2020 783a 2063              x: c
-0000f7d0: 7265 6174 655f 7265 706c 6163 656d 656e  reate_replacemen
-0000f7e0: 745f 666f 725f 7265 736f 7572 6365 2878  t_for_resource(x
-0000f7f0: 2920 666f 7220 7820 696e 2064 6570 7320  ) for x in deps 
-0000f800: 6966 2078 206e 6f74 2069 6e20 5b6e 5b22  if x not in [n["
-0000f810: 6e61 6d65 225d 2066 6f72 206e 2069 6e20  name"] for n in 
-0000f820: 646f 632e 6e6f 6465 735d 0a20 2020 2020  doc.nodes].     
-0000f830: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0000f840: 2020 2020 2020 2320 4649 584d 453a 2049        # FIXME: I
-0000f850: 6465 616c 6c79 2077 6520 7368 6f75 6c64  deally we should
-0000f860: 2075 7365 2061 7761 6974 2074 625f 636c   use await tb_cl
-0000f870: 6965 6e74 2e72 6570 6c61 6365 5f74 6162  ient.replace_tab
-0000f880: 6c65 7328 7371 6c2c 2072 6570 6c61 6365  les(sql, replace
-0000f890: 6d65 6e74 7329 0a20 2020 2020 2020 2020  ments).         
-0000f8a0: 2020 2066 6f72 206f 6c64 2c20 6e65 7720     for old, new 
-0000f8b0: 696e 2072 6570 6c61 6365 6d65 6e74 732e  in replacements.
-0000f8c0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0000f8d0: 2020 2020 2020 2020 2073 716c 203d 2072           sql = r
-0000f8e0: 652e 7375 6228 2228 5b5c 7420 5c5c 6e27  e.sub("([\t \\n'
-0000f8f0: 5d2b 7c5e 2922 202b 206f 6c64 202b 2022  ]+|^)" + old + "
-0000f900: 285b 5c74 205c 5c6e 275c 5c29 5d2b 7c24  ([\t \\n'\\)]+|$
-0000f910: 2922 2c20 225c 5c31 2220 2b20 6e65 7720  )", "\\1" + new 
-0000f920: 2b20 225c 5c32 222c 2073 716c 290a 0a20  + "\\2", sql).. 
-0000f930: 2020 2020 2020 2020 2020 2069 6620 2274             if "t
-0000f940: 6167 7322 2069 6e20 6e6f 6465 3a0a 2020  ags" in node:.  
-0000f950: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-0000f960: 6773 203d 207b 6b3a 2076 5b30 5d20 666f  gs = {k: v[0] fo
-0000f970: 7220 6b2c 2076 2069 6e20 7572 6c6c 6962  r k, v in urllib
-0000f980: 2e70 6172 7365 2e70 6172 7365 5f71 7328  .parse.parse_qs(
-0000f990: 6e6f 6465 5b22 7461 6773 225d 292e 6974  node["tags"]).it
-0000f9a0: 656d 7328 297d 0a20 2020 2020 2020 2020  ems()}.         
-0000f9b0: 2020 2020 2020 2070 6172 616d 732e 7570         params.up
-0000f9c0: 6461 7465 2874 6167 7329 0a0a 2020 2020  date(tags)..    
-0000f9d0: 2020 2020 2020 2020 6e6f 6465 732e 6170          nodes.ap
-0000f9e0: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
-0000f9f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0000fa00: 2020 2020 2020 2020 2020 2020 2273 716c              "sql
-0000fa10: 223a 2073 716c 2c0a 2020 2020 2020 2020  ": sql,.        
-0000fa20: 2020 2020 2020 2020 2020 2020 2270 6172              "par
-0000fa30: 616d 7322 3a20 7061 7261 6d73 2c0a 2020  ams": params,.  
-0000fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fa50: 2020 2265 7870 6f72 745f 7061 7261 6d73    "export_params
-0000fa60: 223a 2065 7870 6f72 745f 7061 7261 6d73  ": export_params
-0000fa70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fa80: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0000fa90: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0000faa0: 6e20 5b0a 2020 2020 2020 2020 2020 2020  n [.            
-0000fab0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0000fac0: 2020 2272 6573 6f75 7263 6522 3a20 2270    "resource": "p
-0000fad0: 6970 6573 222c 0a20 2020 2020 2020 2020  ipes",.         
-0000fae0: 2020 2020 2020 2022 7265 736f 7572 6365         "resource
-0000faf0: 5f6e 616d 6522 3a20 6e61 6d65 2c0a 2020  _name": name,.  
-0000fb00: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-0000fb10: 6572 7369 6f6e 223a 2064 6f63 2e76 6572  ersion": doc.ver
-0000fb20: 7369 6f6e 2c0a 2020 2020 2020 2020 2020  sion,.          
-0000fb30: 2020 2020 2020 2266 696c 656e 616d 6522        "filename"
-0000fb40: 3a20 6669 6c65 6e61 6d65 2c0a 2020 2020  : filename,.    
-0000fb50: 2020 2020 2020 2020 2020 2020 226e 616d              "nam
-0000fb60: 6522 3a20 6e61 6d65 202b 2076 6572 7369  e": name + versi
-0000fb70: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-0000fb80: 2020 2020 226e 6f64 6573 223a 206e 6f64      "nodes": nod
-0000fb90: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0000fba0: 2020 2020 2264 6570 7322 3a20 5b78 2066      "deps": [x f
-0000fbb0: 6f72 2078 2069 6e20 7365 7428 6465 7073  or x in set(deps
-0000fbc0: 295d 2c0a 2020 2020 2020 2020 2020 2020  )],.            
-0000fbd0: 2020 2020 2274 6f6b 656e 7322 3a20 646f      "tokens": do
-0000fbe0: 632e 746f 6b65 6e73 2c0a 2020 2020 2020  c.tokens,.      
-0000fbf0: 2020 2020 2020 2020 2020 2264 6573 6372            "descr
-0000fc00: 6970 7469 6f6e 223a 2064 6573 6372 6970  iption": descrip
-0000fc10: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-0000fc20: 2020 7d0a 2020 2020 2020 2020 5d0a 2020    }.        ].  
-0000fc30: 2020 656c 6966 2044 6174 6146 696c 6545    elif DataFileE
-0000fc40: 7874 656e 7369 6f6e 732e 544f 4b45 4e20  xtensions.TOKEN 
-0000fc50: 696e 2066 696c 656e 616d 653a 0a20 2020  in filename:.   
-0000fc60: 2020 2020 2064 6f63 203d 2070 6172 7365       doc = parse
-0000fc70: 5f74 6f6b 656e 2866 696c 656e 616d 6529  _token(filename)
-0000fc80: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
-0000fc90: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-0000fca0: 2866 696c 656e 616d 6529 2e73 706c 6974  (filename).split
-0000fcb0: 2844 6174 6146 696c 6545 7874 656e 7369  (DataFileExtensi
-0000fcc0: 6f6e 732e 544f 4b45 4e29 5b30 5d0a 2020  ons.TOKEN)[0].  
-0000fcd0: 2020 2020 2020 6465 7363 7269 7074 696f        descriptio
-0000fce0: 6e20 3d20 646f 632e 6465 7363 7269 7074  n = doc.descript
-0000fcf0: 696f 6e20 6f72 2022 220a 2020 2020 2020  ion or "".      
-0000fd00: 2020 7665 7273 696f 6e20 3d20 6622 5f5f    version = f"__
-0000fd10: 767b 646f 632e 7665 7273 696f 6e7d 2220  v{doc.version}" 
-0000fd20: 6966 2064 6f63 2e76 6572 7369 6f6e 2069  if doc.version i
-0000fd30: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
-0000fd40: 2222 0a20 2020 2020 2020 2073 636f 7065  "".        scope
-0000fd50: 7320 3d20 646f 632e 6e6f 6465 7320 6f72  s = doc.nodes or
-0000fd60: 205b 5d0a 2020 2020 2020 2020 7265 7475   [].        retu
-0000fd70: 726e 205b 0a20 2020 2020 2020 2020 2020  rn [.           
-0000fd80: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0000fd90: 2020 2022 7265 736f 7572 6365 223a 2022     "resource": "
-0000fda0: 746f 6b65 6e73 222c 0a20 2020 2020 2020  tokens",.       
-0000fdb0: 2020 2020 2020 2020 2022 7265 736f 7572           "resour
-0000fdc0: 6365 5f6e 616d 6522 3a20 6e61 6d65 2c0a  ce_name": name,.
-0000fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fde0: 2276 6572 7369 6f6e 223a 2064 6f63 2e76  "version": doc.v
-0000fdf0: 6572 7369 6f6e 2c0a 2020 2020 2020 2020  ersion,.        
-0000fe00: 2020 2020 2020 2020 2266 696c 656e 616d          "filenam
-0000fe10: 6522 3a20 6669 6c65 6e61 6d65 2c0a 2020  e": filename,.  
-0000fe20: 2020 2020 2020 2020 2020 2020 2020 226e                "n
-0000fe30: 616d 6522 3a20 6e61 6d65 202b 2076 6572  ame": name + ver
-0000fe40: 7369 6f6e 2c0a 2020 2020 2020 2020 2020  sion,.          
-0000fe50: 2020 2020 2020 2273 636f 7065 7322 3a20        "scopes": 
-0000fe60: 7363 6f70 6573 2c0a 2020 2020 2020 2020  scopes,.        
-0000fe70: 2020 2020 2020 2020 2264 6573 6372 6970          "descrip
-0000fe80: 7469 6f6e 223a 2064 6573 6372 6970 7469  tion": descripti
-0000fe90: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-0000fea0: 7d0a 2020 2020 2020 2020 5d0a 2020 2020  }.        ].    
-0000feb0: 656c 7365 3a0a 2020 2020 2020 2020 7261  else:.        ra
-0000fec0: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
-0000fed0: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
-0000fee0: 6b4d 616e 6167 6572 2e65 7272 6f72 5f66  kManager.error_f
-0000fef0: 696c 655f 6578 7465 6e73 696f 6e28 6669  ile_extension(fi
-0000ff00: 6c65 6e61 6d65 3d66 696c 656e 616d 6529  lename=filename)
-0000ff10: 290a 0a0a 6465 6620 6675 6c6c 5f70 6174  )...def full_pat
-0000ff20: 685f 6279 5f6e 616d 6528 0a20 2020 2066  h_by_name(.    f
-0000ff30: 6f6c 6465 723a 2073 7472 2c20 6e61 6d65  older: str, name
-0000ff40: 3a20 7374 722c 2077 6f72 6b73 7061 6365  : str, workspace
-0000ff50: 5f6c 6962 5f70 6174 6873 3a20 4f70 7469  _lib_paths: Opti
-0000ff60: 6f6e 616c 5b4c 6973 745b 5475 706c 655b  onal[List[Tuple[
-0000ff70: 7374 722c 2073 7472 5d5d 5d20 3d20 4e6f  str, str]]] = No
-0000ff80: 6e65 0a29 202d 3e20 4f70 7469 6f6e 616c  ne.) -> Optional
-0000ff90: 5b50 6174 685d 3a0a 2020 2020 6620 3d20  [Path]:.    f = 
-0000ffa0: 5061 7468 2866 6f6c 6465 7229 0a20 2020  Path(folder).   
-0000ffb0: 2064 7320 3d20 6e61 6d65 202b 2022 2e64   ds = name + ".d
-0000ffc0: 6174 6173 6f75 7263 6522 0a20 2020 2069  atasource".    i
-0000ffd0: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
-0000ffe0: 286f 732e 7061 7468 2e6a 6f69 6e28 666f  (os.path.join(fo
-0000fff0: 6c64 6572 2c20 6473 2929 3a0a 2020 2020  lder, ds)):.    
-00010000: 2020 2020 7265 7475 726e 2066 202f 2064      return f / d
-00010010: 730a 2020 2020 6966 206f 732e 7061 7468  s.    if os.path
-00010020: 2e69 7366 696c 6528 6620 2f20 2264 6174  .isfile(f / "dat
-00010030: 6173 6f75 7263 6573 2220 2f20 6473 293a  asources" / ds):
-00010040: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00010050: 6620 2f20 2264 6174 6173 6f75 7263 6573  f / "datasources
-00010060: 2220 2f20 6473 0a0a 2020 2020 7069 7065  " / ds..    pipe
-00010070: 203d 206e 616d 6520 2b20 222e 7069 7065   = name + ".pipe
-00010080: 220a 2020 2020 6966 206f 732e 7061 7468  ".    if os.path
-00010090: 2e69 7366 696c 6528 6f73 2e70 6174 682e  .isfile(os.path.
-000100a0: 6a6f 696e 2866 6f6c 6465 722c 2070 6970  join(folder, pip
-000100b0: 6529 293a 0a20 2020 2020 2020 2072 6574  e)):.        ret
-000100c0: 7572 6e20 6620 2f20 7069 7065 0a0a 2020  urn f / pipe..  
-000100d0: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
-000100e0: 696c 6528 6620 2f20 2265 6e64 706f 696e  ile(f / "endpoin
-000100f0: 7473 2220 2f20 7069 7065 293a 0a20 2020  ts" / pipe):.   
-00010100: 2020 2020 2072 6574 7572 6e20 6620 2f20       return f / 
-00010110: 2265 6e64 706f 696e 7473 2220 2f20 7069  "endpoints" / pi
-00010120: 7065 0a0a 2020 2020 6966 206f 732e 7061  pe..    if os.pa
-00010130: 7468 2e69 7366 696c 6528 6620 2f20 2270  th.isfile(f / "p
-00010140: 6970 6573 2220 2f20 7069 7065 293a 0a20  ipes" / pipe):. 
-00010150: 2020 2020 2020 2072 6574 7572 6e20 6620         return f 
-00010160: 2f20 2270 6970 6573 2220 2f20 7069 7065  / "pipes" / pipe
-00010170: 0a0a 2020 2020 746f 6b65 6e20 3d20 6e61  ..    token = na
-00010180: 6d65 202b 2022 2e74 6f6b 656e 220a 2020  me + ".token".  
-00010190: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
-000101a0: 696c 6528 6620 2f20 2274 6f6b 656e 7322  ile(f / "tokens"
-000101b0: 202f 2074 6f6b 656e 293a 0a20 2020 2020   / token):.     
-000101c0: 2020 2072 6574 7572 6e20 6620 2f20 2274     return f / "t
-000101d0: 6f6b 656e 7322 202f 2074 6f6b 656e 0a0a  okens" / token..
-000101e0: 2020 2020 6966 2077 6f72 6b73 7061 6365      if workspace
-000101f0: 5f6c 6962 5f70 6174 6873 3a0a 2020 2020  _lib_paths:.    
-00010200: 2020 2020 666f 7220 776b 5f6e 616d 652c      for wk_name,
-00010210: 2077 6b5f 7061 7468 2069 6e20 776f 726b   wk_path in work
-00010220: 7370 6163 655f 6c69 625f 7061 7468 733a  space_lib_paths:
-00010230: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00010240: 6e61 6d65 2e73 7461 7274 7377 6974 6828  name.startswith(
-00010250: 6622 7b77 6b5f 6e61 6d65 7d2e 2229 3a0a  f"{wk_name}."):.
-00010260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010270: 7220 3d20 6675 6c6c 5f70 6174 685f 6279  r = full_path_by
-00010280: 5f6e 616d 6528 776b 5f70 6174 682c 206e  _name(wk_path, n
-00010290: 616d 652e 7265 706c 6163 6528 6622 7b77  ame.replace(f"{w
-000102a0: 6b5f 6e61 6d65 7d2e 222c 2022 2229 290a  k_name}.", "")).
-000102b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102c0: 6966 2072 3a0a 2020 2020 2020 2020 2020  if r:.          
-000102d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000102e0: 2072 0a20 2020 2072 6574 7572 6e20 4e6f   r.    return No
-000102f0: 6e65 0a0a 0a64 6566 2066 696e 645f 6669  ne...def find_fi
-00010300: 6c65 5f62 795f 6e61 6d65 280a 2020 2020  le_by_name(.    
-00010310: 666f 6c64 6572 3a20 7374 722c 0a20 2020  folder: str,.   
-00010320: 206e 616d 653a 2073 7472 2c0a 2020 2020   name: str,.    
-00010330: 7665 7262 6f73 653a 2062 6f6f 6c20 3d20  verbose: bool = 
-00010340: 4661 6c73 652c 0a20 2020 2069 735f 7261  False,.    is_ra
-00010350: 773a 2062 6f6f 6c20 3d20 4661 6c73 652c  w: bool = False,
-00010360: 0a20 2020 2077 6f72 6b73 7061 6365 5f6c  .    workspace_l
-00010370: 6962 5f70 6174 6873 3a20 4f70 7469 6f6e  ib_paths: Option
-00010380: 616c 5b4c 6973 745b 5475 706c 655b 7374  al[List[Tuple[st
-00010390: 722c 2073 7472 5d5d 5d20 3d20 4e6f 6e65  r, str]]] = None
-000103a0: 2c0a 2020 2020 7265 736f 7572 6365 3a20  ,.    resource: 
-000103b0: 4f70 7469 6f6e 616c 5b44 6963 745d 203d  Optional[Dict] =
-000103c0: 204e 6f6e 652c 0a29 3a0a 2020 2020 6620   None,.):.    f 
-000103d0: 3d20 5061 7468 2866 6f6c 6465 7229 0a20  = Path(folder). 
-000103e0: 2020 2064 7320 3d20 6e61 6d65 202b 2022     ds = name + "
-000103f0: 2e64 6174 6173 6f75 7263 6522 0a20 2020  .datasource".   
-00010400: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
-00010410: 6c65 286f 732e 7061 7468 2e6a 6f69 6e28  le(os.path.join(
-00010420: 666f 6c64 6572 2c20 6473 2929 3a0a 2020  folder, ds)):.  
-00010430: 2020 2020 2020 7265 7475 726e 2064 732c        return ds,
-00010440: 204e 6f6e 650a 2020 2020 6966 206f 732e   None.    if os.
-00010450: 7061 7468 2e69 7366 696c 6528 6620 2f20  path.isfile(f / 
-00010460: 2264 6174 6173 6f75 7263 6573 2220 2f20  "datasources" / 
-00010470: 6473 293a 0a20 2020 2020 2020 2072 6574  ds):.        ret
-00010480: 7572 6e20 6473 2c20 4e6f 6e65 0a0a 2020  urn ds, None..  
-00010490: 2020 7069 7065 203d 206e 616d 6520 2b20    pipe = name + 
-000104a0: 222e 7069 7065 220a 2020 2020 6966 206f  ".pipe".    if o
-000104b0: 732e 7061 7468 2e69 7366 696c 6528 6f73  s.path.isfile(os
-000104c0: 2e70 6174 682e 6a6f 696e 2866 6f6c 6465  .path.join(folde
-000104d0: 722c 2070 6970 6529 293a 0a20 2020 2020  r, pipe)):.     
-000104e0: 2020 2072 6574 7572 6e20 7069 7065 2c20     return pipe, 
-000104f0: 4e6f 6e65 0a0a 2020 2020 6966 206f 732e  None..    if os.
-00010500: 7061 7468 2e69 7366 696c 6528 6620 2f20  path.isfile(f / 
-00010510: 2265 6e64 706f 696e 7473 2220 2f20 7069  "endpoints" / pi
-00010520: 7065 293a 0a20 2020 2020 2020 2072 6574  pe):.        ret
-00010530: 7572 6e20 7069 7065 2c20 4e6f 6e65 0a0a  urn pipe, None..
-00010540: 2020 2020 6966 206f 732e 7061 7468 2e69      if os.path.i
-00010550: 7366 696c 6528 6620 2f20 2270 6970 6573  sfile(f / "pipes
-00010560: 2220 2f20 7069 7065 293a 0a20 2020 2020  " / pipe):.     
-00010570: 2020 2072 6574 7572 6e20 7069 7065 2c20     return pipe, 
-00010580: 4e6f 6e65 0a0a 2020 2020 746f 6b65 6e20  None..    token 
-00010590: 3d20 6e61 6d65 202b 2022 2e74 6f6b 656e  = name + ".token
-000105a0: 220a 2020 2020 6966 206f 732e 7061 7468  ".    if os.path
-000105b0: 2e69 7366 696c 6528 6620 2f20 2274 6f6b  .isfile(f / "tok
-000105c0: 656e 7322 202f 2074 6f6b 656e 293a 0a20  ens" / token):. 
-000105d0: 2020 2020 2020 2072 6574 7572 6e20 746f         return to
-000105e0: 6b65 6e2c 204e 6f6e 650a 0a20 2020 2023  ken, None..    #
-000105f0: 206c 6f6f 6b20 666f 7220 7468 6520 6669   look for the fi
-00010600: 6c65 2069 6e20 7375 6264 6972 6563 746f  le in subdirecto
-00010610: 7269 6573 2069 6620 6974 2773 206e 6f74  ries if it's not
-00010620: 2066 6f75 6e64 2069 6e20 6461 7461 736f   found in dataso
-00010630: 7572 6365 7320 666f 6c64 6572 0a20 2020  urces folder.   
-00010640: 2069 6620 776f 726b 7370 6163 655f 6c69   if workspace_li
-00010650: 625f 7061 7468 733a 0a20 2020 2020 2020  b_paths:.       
-00010660: 205f 7265 736f 7572 6365 203d 204e 6f6e   _resource = Non
-00010670: 650a 2020 2020 2020 2020 666f 7220 776b  e.        for wk
-00010680: 5f6e 616d 652c 2077 6b5f 7061 7468 2069  _name, wk_path i
-00010690: 6e20 776f 726b 7370 6163 655f 6c69 625f  n workspace_lib_
-000106a0: 7061 7468 733a 0a20 2020 2020 2020 2020  paths:.         
-000106b0: 2020 2066 696c 6520 3d20 4e6f 6e65 0a20     file = None. 
-000106c0: 2020 2020 2020 2020 2020 2069 6620 6e61             if na
-000106d0: 6d65 2e73 7461 7274 7377 6974 6828 6622  me.startswith(f"
-000106e0: 7b77 6b5f 6e61 6d65 7d2e 2229 3a0a 2020  {wk_name}."):.  
-000106f0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00010700: 6c65 2c20 5f72 6573 6f75 7263 6520 3d20  le, _resource = 
-00010710: 6669 6e64 5f66 696c 655f 6279 5f6e 616d  find_file_by_nam
-00010720: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00010730: 2020 2020 2020 2077 6b5f 7061 7468 2c20         wk_path, 
-00010740: 6e61 6d65 2e72 6570 6c61 6365 2866 227b  name.replace(f"{
-00010750: 776b 5f6e 616d 657d 2e22 2c20 2222 292c  wk_name}.", ""),
-00010760: 2076 6572 626f 7365 2c20 6973 5f72 6177   verbose, is_raw
-00010770: 2c20 7265 736f 7572 6365 3d72 6573 6f75  , resource=resou
-00010780: 7263 650a 2020 2020 2020 2020 2020 2020  rce.            
-00010790: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000107a0: 2020 6966 2066 696c 653a 0a20 2020 2020    if file:.     
-000107b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000107c0: 6e20 6669 6c65 2c20 5f72 6573 6f75 7263  n file, _resourc
-000107d0: 650a 0a20 2020 2069 6620 6e6f 7420 6973  e..    if not is
-000107e0: 5f72 6177 3a0a 2020 2020 2020 2020 662c  _raw:.        f,
-000107f0: 2072 6177 203d 2066 696e 645f 6669 6c65   raw = find_file
-00010800: 5f62 795f 6e61 6d65 280a 2020 2020 2020  _by_name(.      
-00010810: 2020 2020 2020 666f 6c64 6572 2c0a 2020        folder,.  
-00010820: 2020 2020 2020 2020 2020 6765 745f 6465            get_de
-00010830: 705f 6672 6f6d 5f72 6177 5f74 6162 6c65  p_from_raw_table
-00010840: 7328 6e61 6d65 292c 0a20 2020 2020 2020  s(name),.       
-00010850: 2020 2020 2076 6572 626f 7365 3d76 6572       verbose=ver
-00010860: 626f 7365 2c0a 2020 2020 2020 2020 2020  bose,.          
-00010870: 2020 6973 5f72 6177 3d54 7275 652c 0a20    is_raw=True,. 
-00010880: 2020 2020 2020 2020 2020 2077 6f72 6b73             works
-00010890: 7061 6365 5f6c 6962 5f70 6174 6873 3d77  pace_lib_paths=w
-000108a0: 6f72 6b73 7061 6365 5f6c 6962 5f70 6174  orkspace_lib_pat
-000108b0: 6873 2c0a 2020 2020 2020 2020 2020 2020  hs,.            
-000108c0: 7265 736f 7572 6365 3d72 6573 6f75 7263  resource=resourc
-000108d0: 652c 0a20 2020 2020 2020 2029 0a20 2020  e,.        ).   
-000108e0: 2020 2020 2072 6574 7572 6e20 662c 2072       return f, r
-000108f0: 6177 0a0a 2020 2020 2320 6d61 7465 7269  aw..    # materi
-00010900: 616c 697a 6564 206e 6f64 6520 7769 7468  alized node with
-00010910: 2044 4154 4153 4f55 5243 4520 6465 6669   DATASOURCE defi
-00010920: 6e69 7469 6f6e 0a20 2020 2069 6620 7265  nition.    if re
-00010930: 736f 7572 6365 2061 6e64 2022 6e6f 6465  source and "node
-00010940: 7322 2069 6e20 7265 736f 7572 6365 3a0a  s" in resource:.
-00010950: 2020 2020 2020 2020 666f 7220 6e6f 6465          for node
-00010960: 2069 6e20 7265 736f 7572 6365 5b22 6e6f   in resource["no
-00010970: 6465 7322 5d3a 0a20 2020 2020 2020 2020  des"]:.         
-00010980: 2020 2070 6172 616d 7320 3d20 6e6f 6465     params = node
-00010990: 2e67 6574 2822 7061 7261 6d73 222c 207b  .get("params", {
-000109a0: 7d29 0a20 2020 2020 2020 2020 2020 2069  }).            i
-000109b0: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-000109c0: 2020 2020 7061 7261 6d73 2e67 6574 2822      params.get("
-000109d0: 7479 7065 222c 204e 6f6e 6529 203d 3d20  type", None) == 
-000109e0: 226d 6174 6572 6961 6c69 7a65 6422 0a20  "materialized". 
-000109f0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00010a00: 6e64 2070 6172 616d 732e 6765 7428 2265  nd params.get("e
-00010a10: 6e67 696e 6522 2c20 4e6f 6e65 290a 2020  ngine", None).  
-00010a20: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00010a30: 6420 7061 7261 6d73 2e67 6574 2822 6461  d params.get("da
-00010a40: 7461 736f 7572 6365 222c 204e 6f6e 6529  tasource", None)
-00010a50: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
-00010a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a70: 7069 7065 203d 2072 6573 6f75 7263 655b  pipe = resource[
-00010a80: 2272 6573 6f75 7263 655f 6e61 6d65 225d  "resource_name"]
-00010a90: 202b 2022 2e70 6970 6522 0a20 2020 2020   + ".pipe".     
-00010aa0: 2020 2020 2020 2020 2020 2070 6970 655f             pipe_
-00010ab0: 6669 6c65 5f65 7869 7374 7320 3d20 280a  file_exists = (.
-00010ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ad0: 2020 2020 6f73 2e70 6174 682e 6973 6669      os.path.isfi
-00010ae0: 6c65 286f 732e 7061 7468 2e6a 6f69 6e28  le(os.path.join(
-00010af0: 666f 6c64 6572 2c20 7069 7065 2929 0a20  folder, pipe)). 
-00010b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b10: 2020 206f 7220 6f73 2e70 6174 682e 6973     or os.path.is
-00010b20: 6669 6c65 2866 202f 2022 656e 6470 6f69  file(f / "endpoi
-00010b30: 6e74 7322 202f 2070 6970 6529 0a20 2020  nts" / pipe).   
-00010b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b50: 206f 7220 6f73 2e70 6174 682e 6973 6669   or os.path.isfi
-00010b60: 6c65 2866 202f 2022 7069 7065 7322 202f  le(f / "pipes" /
-00010b70: 2070 6970 6529 0a20 2020 2020 2020 2020   pipe).         
-00010b80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010b90: 2020 2020 2020 2020 2069 735f 7461 7267           is_targ
-00010ba0: 6574 5f64 6174 6173 6f75 7263 6520 3d20  et_datasource = 
-00010bb0: 7061 7261 6d73 5b22 6461 7461 736f 7572  params["datasour
-00010bc0: 6365 225d 203d 3d20 6e61 6d65 0a20 2020  ce"] == name.   
-00010bd0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00010be0: 7069 7065 5f66 696c 655f 6578 6973 7473  pipe_file_exists
-00010bf0: 2061 6e64 2069 735f 7461 7267 6574 5f64   and is_target_d
-00010c00: 6174 6173 6f75 7263 653a 0a20 2020 2020  atasource:.     
-00010c10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00010c20: 6574 7572 6e20 7069 7065 2c20 7b22 7265  eturn pipe, {"re
-00010c30: 736f 7572 6365 5f6e 616d 6522 3a20 7061  source_name": pa
-00010c40: 7261 6d73 2e67 6574 2822 6461 7461 736f  rams.get("dataso
-00010c50: 7572 6365 2229 7d0a 0a20 2020 2069 6620  urce")}..    if 
-00010c60: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-00010c70: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
-00010c80: 6261 636b 4d61 6e61 6765 722e 7761 726e  backManager.warn
-00010c90: 696e 675f 6669 6c65 5f6e 6f74 5f66 6f75  ing_file_not_fou
-00010ca0: 6e64 5f69 6e73 6964 6528 6e61 6d65 3d6e  nd_inside(name=n
-00010cb0: 616d 652c 2066 6f6c 6465 723d 666f 6c64  ame, folder=fold
-00010cc0: 6572 2929 0a0a 2020 2020 7265 7475 726e  er))..    return
-00010cd0: 204e 6f6e 652c 204e 6f6e 650a 0a0a 6465   None, None...de
-00010ce0: 6620 6472 6f70 5f74 6f6b 656e 2875 726c  f drop_token(url
-00010cf0: 3a20 7374 7229 202d 3e20 7374 723a 0a20  : str) -> str:. 
-00010d00: 2020 2022 2222 0a20 2020 2064 726f 7073     """.    drops
-00010d10: 2074 6f6b 656e 2070 6172 616d 2066 726f   token param fro
-00010d20: 6d20 7468 6520 7572 6c20 7175 6572 7920  m the url query 
-00010d30: 7374 7269 6e67 0a20 2020 203e 3e3e 2064  string.    >>> d
-00010d40: 726f 705f 746f 6b65 6e28 2768 7474 7073  rop_token('https
-00010d50: 3a2f 2f61 7069 2e74 696e 7962 6972 642e  ://api.tinybird.
-00010d60: 636f 2f76 302f 7069 7065 732f 6161 612e  co/v0/pipes/aaa.
-00010d70: 6a73 6f6e 3f74 6f6b 656e 3d61 6263 6426  json?token=abcd&
-00010d80: 613d 3127 290a 2020 2020 2768 7474 7073  a=1').    'https
-00010d90: 3a2f 2f61 7069 2e74 696e 7962 6972 642e  ://api.tinybird.
-00010da0: 636f 2f76 302f 7069 7065 732f 6161 612e  co/v0/pipes/aaa.
-00010db0: 6a73 6f6e 3f61 3d31 270a 2020 2020 3e3e  json?a=1'.    >>
-00010dc0: 3e20 6472 6f70 5f74 6f6b 656e 2827 6874  > drop_token('ht
-00010dd0: 7470 733a 2f2f 6170 692e 7469 6e79 6269  tps://api.tinybi
-00010de0: 7264 2e63 6f2f 7630 2f70 6970 6573 2f61  rd.co/v0/pipes/a
-00010df0: 6161 2e6a 736f 6e3f 613d 3127 290a 2020  aa.json?a=1').  
-00010e00: 2020 2768 7474 7073 3a2f 2f61 7069 2e74    'https://api.t
-00010e10: 696e 7962 6972 642e 636f 2f76 302f 7069  inybird.co/v0/pi
-00010e20: 7065 732f 6161 612e 6a73 6f6e 3f61 3d31  pes/aaa.json?a=1
-00010e30: 270a 2020 2020 2222 220a 2020 2020 7061  '.    """.    pa
-00010e40: 7273 6564 203d 2075 726c 7061 7273 6528  rsed = urlparse(
-00010e50: 7572 6c29 0a20 2020 2071 7320 3d20 7061  url).    qs = pa
-00010e60: 7273 655f 7173 2870 6172 7365 642e 7175  rse_qs(parsed.qu
-00010e70: 6572 7929 0a20 2020 2071 735f 7369 6d70  ery).    qs_simp
-00010e80: 6c69 6679 203d 207b 6b3a 2076 5b30 5d20  lify = {k: v[0] 
-00010e90: 666f 7220 6b2c 2076 2069 6e20 7173 2e69  for k, v in qs.i
-00010ea0: 7465 6d73 2829 7d20 2023 2063 6861 6e67  tems()}  # chang
-00010eb0: 6520 7365 7665 7261 6c20 6172 6775 6d65  e several argume
-00010ec0: 6e74 7320 746f 2073 696e 676c 6520 6f6e  nts to single on
-00010ed0: 650a 2020 2020 6966 2022 746f 6b65 6e22  e.    if "token"
-00010ee0: 2069 6e20 7173 5f73 696d 706c 6966 793a   in qs_simplify:
-00010ef0: 0a20 2020 2020 2020 2064 656c 2071 735f  .        del qs_
-00010f00: 7369 6d70 6c69 6679 5b22 746f 6b65 6e22  simplify["token"
-00010f10: 5d0a 2020 2020 7265 7475 726e 2066 227b  ].    return f"{
-00010f20: 7061 7273 6564 2e73 6368 656d 657d 3a2f  parsed.scheme}:/
-00010f30: 2f7b 7061 7273 6564 2e6e 6574 6c6f 637d  /{parsed.netloc}
-00010f40: 7b70 6172 7365 642e 7061 7468 7d3f 7b75  {parsed.path}?{u
-00010f50: 726c 656e 636f 6465 2871 735f 7369 6d70  rlencode(qs_simp
-00010f60: 6c69 6679 297d 220a 0a0a 6465 6620 6e6f  lify)}"...def no
-00010f70: 726d 616c 697a 655f 6172 7261 7928 6974  rmalize_array(it
-00010f80: 656d 733a 204c 6973 745b 4469 6374 5b73  ems: List[Dict[s
-00010f90: 7472 2c20 4f70 7469 6f6e 616c 5b41 6e79  tr, Optional[Any
-00010fa0: 5d5d 5d29 202d 3e20 4c69 7374 5b44 6963  ]]]) -> List[Dic
-00010fb0: 745d 3a0a 2020 2020 2222 220a 2020 2020  t]:.    """.    
-00010fc0: 2020 2020 536f 7274 6564 2829 2064 6f65      Sorted() doe
-00010fd0: 736e 2774 206e 6f74 2073 7570 706f 7274  sn't not support
-00010fe0: 2076 616c 7565 7320 7769 7468 2064 6966   values with dif
-00010ff0: 6665 7265 6e74 2074 7970 6573 2066 6f72  ferent types for
-00011000: 2074 6865 2073 616d 6520 636f 6c75 6d6e   the same column
-00011010: 206c 696b 6520 4e6f 6e65 2076 7320 7374   like None vs st
-00011020: 722e 0a20 2020 2020 2020 2053 6f2c 2077  r..        So, w
-00011030: 6520 6e65 6564 2074 6f20 6361 7374 2061  e need to cast a
-00011040: 6c6c 204e 6f6e 6520 746f 2064 6566 6175  ll None to defau
-00011050: 6c74 2076 616c 7565 206f 6620 7468 6520  lt value of the 
-00011060: 7479 7065 206f 6620 7468 6520 636f 6c75  type of the colu
-00011070: 6d6e 2069 6620 6578 6973 7420 616e 6420  mn if exist and 
-00011080: 6966 2061 6c6c 2074 6865 2076 616c 7565  if all the value
-00011090: 7320 6172 6520 4e6f 6e65 2c20 7765 2063  s are None, we c
-000110a0: 616e 206c 6561 7665 2074 6865 6d20 6173  an leave them as
-000110b0: 204e 6f6e 650a 2020 2020 3e3e 3e20 6e6f   None.    >>> no
-000110c0: 726d 616c 697a 655f 6172 7261 7928 5b7b  rmalize_array([{
-000110d0: 2778 273a 2027 6865 6c6c 6f20 576f 726c  'x': 'hello Worl
-000110e0: 6427 7d2c 207b 2778 273a 204e 6f6e 657d  d'}, {'x': None}
-000110f0: 5d29 0a20 2020 205b 7b27 7827 3a20 2768  ]).    [{'x': 'h
-00011100: 656c 6c6f 2057 6f72 6c64 277d 2c20 7b27  ello World'}, {'
-00011110: 7827 3a20 2727 7d5d 0a20 2020 203e 3e3e  x': ''}].    >>>
-00011120: 206e 6f72 6d61 6c69 7a65 5f61 7272 6179   normalize_array
-00011130: 285b 7b27 7827 3a20 337d 2c20 7b27 7827  ([{'x': 3}, {'x'
-00011140: 3a20 4e6f 6e65 7d5d 290a 2020 2020 5b7b  : None}]).    [{
-00011150: 2778 273a 2033 7d2c 207b 2778 273a 2030  'x': 3}, {'x': 0
-00011160: 7d5d 0a20 2020 203e 3e3e 206e 6f72 6d61  }].    >>> norma
-00011170: 6c69 7a65 5f61 7272 6179 285b 7b27 7827  lize_array([{'x'
-00011180: 3a20 7b27 7927 3a20 5b31 2c32 2c33 2c34  : {'y': [1,2,3,4
-00011190: 5d7d 7d2c 207b 2778 273a 207b 277a 273a  ]}}, {'x': {'z':
-000111a0: 2022 4865 6c6c 6f22 207d 7d5d 290a 2020   "Hello" }}]).  
-000111b0: 2020 5b7b 2778 273a 207b 2779 273a 205b    [{'x': {'y': [
-000111c0: 312c 2032 2c20 332c 2034 5d7d 7d2c 207b  1, 2, 3, 4]}}, {
-000111d0: 2778 273a 207b 277a 273a 2027 4865 6c6c  'x': {'z': 'Hell
-000111e0: 6f27 7d7d 5d0a 2020 2020 2222 220a 2020  o'}}].    """.  
-000111f0: 2020 7479 7065 733a 2044 6963 745b 7374    types: Dict[st
-00011200: 722c 2074 7970 655d 203d 207b 7d0a 2020  r, type] = {}.  
-00011210: 2020 6966 206c 656e 2869 7465 6d73 2920    if len(items) 
-00011220: 3d3d 2030 3a0a 2020 2020 2020 2020 7265  == 0:.        re
-00011230: 7475 726e 2069 7465 6d73 0a0a 2020 2020  turn items..    
-00011240: 636f 6c75 6d6e 7320 3d20 6974 656d 735b  columns = items[
-00011250: 305d 2e6b 6579 7328 290a 2020 2020 666f  0].keys().    fo
-00011260: 7220 636f 6c75 6d6e 2069 6e20 636f 6c75  r column in colu
-00011270: 6d6e 733a 0a20 2020 2020 2020 2066 6f72  mns:.        for
-00011280: 206f 626a 6563 7420 696e 2069 7465 6d73   object in items
-00011290: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000112a0: 206f 626a 6563 745b 636f 6c75 6d6e 5d20   object[column] 
-000112b0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000112c0: 2020 2020 2020 2020 2020 2020 2074 7970               typ
-000112d0: 6573 5b63 6f6c 756d 6e5d 203d 2074 7970  es[column] = typ
-000112e0: 6528 6f62 6a65 6374 5b63 6f6c 756d 6e5d  e(object[column]
-000112f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011300: 2020 6272 6561 6b0a 0a20 2020 2066 6f72    break..    for
-00011310: 206f 626a 6563 7420 696e 2069 7465 6d73   object in items
-00011320: 3a0a 2020 2020 2020 2020 666f 7220 636f  :.        for co
-00011330: 6c75 6d6e 2069 6e20 636f 6c75 6d6e 733a  lumn in columns:
-00011340: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00011350: 6f62 6a65 6374 5b63 6f6c 756d 6e5d 2069  object[column] i
-00011360: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00011370: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00011380: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-00011390: 2020 2320 4966 204e 6f6e 652c 2077 6520    # If None, we 
-000113a0: 7265 706c 6163 6520 6974 2066 6f72 2074  replace it for t
-000113b0: 6865 2064 6566 6175 6c74 2076 616c 7565  he default value
-000113c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000113d0: 7479 7065 732e 6765 7428 636f 6c75 6d6e  types.get(column
-000113e0: 2c20 4e6f 6e65 293a 0a20 2020 2020 2020  , None):.       
-000113f0: 2020 2020 2020 2020 206f 626a 6563 745b           object[
-00011400: 636f 6c75 6d6e 5d20 3d20 7479 7065 735b  column] = types[
-00011410: 636f 6c75 6d6e 5d28 290a 0a20 2020 2072  column]()..    r
-00011420: 6574 7572 6e20 6974 656d 730a 0a0a 636c  eturn items...cl
-00011430: 6173 7320 5069 7065 4368 6563 6b65 7228  ass PipeChecker(
-00011440: 756e 6974 7465 7374 2e54 6573 7443 6173  unittest.TestCas
-00011450: 6529 3a0a 2020 2020 5245 5452 4945 535f  e):.    RETRIES_
-00011460: 4c49 4d49 5420 3d20 5049 5045 5f43 4845  LIMIT = PIPE_CHE
-00011470: 434b 4552 5f52 4554 5249 4553 0a0a 2020  CKER_RETRIES..  
-00011480: 2020 6375 7272 656e 745f 7265 7370 6f6e    current_respon
-00011490: 7365 5f74 696d 653a 2066 6c6f 6174 203d  se_time: float =
-000114a0: 2030 0a20 2020 2063 6865 636b 6572 5f72   0.    checker_r
-000114b0: 6573 706f 6e73 655f 7469 6d65 3a20 666c  esponse_time: fl
-000114c0: 6f61 7420 3d20 300a 0a20 2020 2063 7572  oat = 0..    cur
-000114d0: 7265 6e74 5f72 6561 645f 6279 7465 733a  rent_read_bytes:
-000114e0: 2069 6e74 203d 2030 0a20 2020 2063 6865   int = 0.    che
-000114f0: 636b 6572 5f72 6561 645f 6279 7465 733a  cker_read_bytes:
-00011500: 2069 6e74 203d 2030 0a0a 2020 2020 6465   int = 0..    de
-00011510: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
-00011520: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00011530: 2020 7265 7175 6573 743a 2044 6963 745b    request: Dict[
-00011540: 7374 722c 2041 6e79 5d2c 0a20 2020 2020  str, Any],.     
-00011550: 2020 2070 6970 655f 6e61 6d65 3a20 7374     pipe_name: st
-00011560: 722c 0a20 2020 2020 2020 2063 6865 636b  r,.        check
-00011570: 6572 5f70 6970 655f 6e61 6d65 3a20 7374  er_pipe_name: st
-00011580: 722c 0a20 2020 2020 2020 2074 6f6b 656e  r,.        token
-00011590: 3a20 7374 722c 0a20 2020 2020 2020 206f  : str,.        o
-000115a0: 6e6c 795f 7265 7370 6f6e 7365 5f74 696d  nly_response_tim
-000115b0: 6573 3a20 626f 6f6c 2c0a 2020 2020 2020  es: bool,.      
-000115c0: 2020 6967 6e6f 7265 5f6f 7264 6572 3a20    ignore_order: 
-000115d0: 626f 6f6c 2c0a 2020 2020 2020 2020 7661  bool,.        va
-000115e0: 6c69 6461 7465 5f70 726f 6365 7373 6564  lidate_processed
-000115f0: 5f62 7974 6573 3a20 626f 6f6c 2c0a 2020  _bytes: bool,.  
-00011600: 2020 2020 2020 2a61 7267 732c 0a20 2020        *args,.   
-00011610: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
-00011620: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-00011630: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
-00011640: 696e 6974 5f5f 282a 6172 6773 2c20 2a2a  init__(*args, **
-00011650: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-00011660: 6966 2072 6571 7565 7374 2e67 6574 2822  if request.get("
-00011670: 6874 7470 5f6d 6574 686f 6422 2920 3d3d  http_method") ==
-00011680: 2022 504f 5354 223a 0a20 2020 2020 2020   "POST":.       
-00011690: 2020 2020 2073 656c 662e 6874 7470 5f6d       self.http_m
-000116a0: 6574 686f 6420 3d20 2250 4f53 5422 0a20  ethod = "POST". 
-000116b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000116c0: 6375 7272 656e 745f 7069 7065 5f75 726c  current_pipe_url
-000116d0: 2c20 7365 6c66 2e70 6970 655f 7265 7175  , self.pipe_requ
-000116e0: 6573 745f 7061 7261 6d73 203d 2073 656c  est_params = sel
-000116f0: 662e 5f70 7265 7061 7265 5f63 7572 7265  f._prepare_curre
-00011700: 6e74 5f70 6970 655f 666f 725f 706f 7374  nt_pipe_for_post
-00011710: 5f72 6571 7565 7374 2872 6571 7565 7374  _request(request
-00011720: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00011730: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00011740: 2e68 7474 705f 6d65 7468 6f64 203d 2022  .http_method = "
-00011750: 4745 5422 0a20 2020 2020 2020 2020 2020  GET".           
-00011760: 2073 656c 662e 6375 7272 656e 745f 7069   self.current_pi
-00011770: 7065 5f75 726c 2c20 7365 6c66 2e70 6970  pe_url, self.pip
-00011780: 655f 7265 7175 6573 745f 7061 7261 6d73  e_request_params
-00011790: 203d 2073 656c 662e 5f70 7265 7061 7265   = self._prepare
-000117a0: 5f63 7572 7265 6e74 5f70 6970 655f 7572  _current_pipe_ur
-000117b0: 6c5f 666f 725f 6765 745f 7265 7175 6573  l_for_get_reques
-000117c0: 7428 7265 7175 6573 7429 0a0a 2020 2020  t(request)..    
-000117d0: 2020 2020 7365 6c66 2e5f 7072 6f63 6573      self._proces
-000117e0: 735f 7061 7261 6d73 2829 0a20 2020 2020  s_params().     
-000117f0: 2020 2073 656c 662e 6368 6563 6b65 725f     self.checker_
-00011800: 7069 7065 5f6e 616d 6520 3d20 6368 6563  pipe_name = chec
-00011810: 6b65 725f 7069 7065 5f6e 616d 650a 2020  ker_pipe_name.  
-00011820: 2020 2020 2020 7365 6c66 2e70 6970 655f        self.pipe_
-00011830: 6e61 6d65 203d 2070 6970 655f 6e61 6d65  name = pipe_name
-00011840: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
-00011850: 6b65 6e20 3d20 746f 6b65 6e0a 2020 2020  ken = token.    
-00011860: 2020 2020 7365 6c66 2e6f 6e6c 795f 7265      self.only_re
-00011870: 7370 6f6e 7365 5f74 696d 6573 203d 206f  sponse_times = o
-00011880: 6e6c 795f 7265 7370 6f6e 7365 5f74 696d  nly_response_tim
-00011890: 6573 0a20 2020 2020 2020 2073 656c 662e  es.        self.
-000118a0: 6967 6e6f 7265 5f6f 7264 6572 203d 2069  ignore_order = i
-000118b0: 676e 6f72 655f 6f72 6465 720a 2020 2020  gnore_order.    
-000118c0: 2020 2020 7365 6c66 2e76 616c 6964 6174      self.validat
-000118d0: 655f 7072 6f63 6573 7365 645f 6279 7465  e_processed_byte
-000118e0: 7320 3d20 7661 6c69 6461 7465 5f70 726f  s = validate_pro
-000118f0: 6365 7373 6564 5f62 7974 6573 0a0a 2020  cessed_bytes..  
-00011900: 2020 2020 2020 7061 7273 6564 203d 2075        parsed = u
-00011910: 726c 7061 7273 6528 7365 6c66 2e63 7572  rlparse(self.cur
-00011920: 7265 6e74 5f70 6970 655f 7572 6c29 0a20  rent_pipe_url). 
-00011930: 2020 2020 2020 2073 656c 662e 6368 6563         self.chec
-00011940: 6b65 725f 7069 7065 5f75 726c 203d 2066  ker_pipe_url = f
-00011950: 227b 7061 7273 6564 2e73 6368 656d 657d  "{parsed.scheme}
-00011960: 3a2f 2f7b 7061 7273 6564 2e6e 6574 6c6f  ://{parsed.netlo
-00011970: 637d 2f76 302f 7069 7065 732f 7b73 656c  c}/v0/pipes/{sel
-00011980: 662e 6368 6563 6b65 725f 7069 7065 5f6e  f.checker_pipe_n
-00011990: 616d 657d 2e6a 736f 6e22 0a20 2020 2020  ame}.json".     
-000119a0: 2020 2073 656c 662e 6368 6563 6b65 725f     self.checker_
-000119b0: 7069 7065 5f75 726c 202b 3d20 6622 3f7b  pipe_url += f"?{
-000119c0: 7061 7273 6564 2e71 7565 7279 7d22 2069  parsed.query}" i
-000119d0: 6620 7061 7273 6564 2e71 7565 7279 2069  f parsed.query i
-000119e0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2070  s not None and p
-000119f0: 6172 7365 642e 7175 6572 7920 213d 2022  arsed.query != "
-00011a00: 2220 656c 7365 2022 220a 0a20 2020 2064  " else ""..    d
-00011a10: 6566 205f 7072 6f63 6573 735f 7061 7261  ef _process_para
-00011a20: 6d73 2873 656c 6629 202d 3e20 4e6f 6e65  ms(self) -> None
-00011a30: 3a0a 2020 2020 2020 2020 666f 7220 6b65  :.        for ke
-00011a40: 7920 696e 2073 656c 662e 7069 7065 5f72  y in self.pipe_r
-00011a50: 6571 7565 7374 5f70 6172 616d 732e 6b65  equest_params.ke
-00011a60: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
-00011a70: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00011a80: 2020 2020 2020 2073 656c 662e 7069 7065         self.pipe
-00011a90: 5f72 6571 7565 7374 5f70 6172 616d 735b  _request_params[
-00011aa0: 6b65 795d 203d 206a 736f 6e2e 6c6f 6164  key] = json.load
-00011ab0: 7328 7365 6c66 2e70 6970 655f 7265 7175  s(self.pipe_requ
-00011ac0: 6573 745f 7061 7261 6d73 5b6b 6579 5d29  est_params[key])
-00011ad0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00011ae0: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-00011af0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00011b00: 6173 730a 0a20 2020 2064 6566 205f 7072  ass..    def _pr
-00011b10: 6570 6172 655f 6375 7272 656e 745f 7069  epare_current_pi
-00011b20: 7065 5f75 726c 5f66 6f72 5f67 6574 5f72  pe_url_for_get_r
-00011b30: 6571 7565 7374 2873 656c 662c 2072 6571  equest(self, req
-00011b40: 7565 7374 2920 2d3e 2054 7570 6c65 5b73  uest) -> Tuple[s
-00011b50: 7472 2c20 4469 6374 5b73 7472 2c20 7374  tr, Dict[str, st
-00011b60: 725d 5d3a 0a20 2020 2020 2020 2063 7572  r]]:.        cur
-00011b70: 7265 6e74 5f70 6970 655f 7572 6c20 3d20  rent_pipe_url = 
-00011b80: 7265 7175 6573 742e 6765 7428 2265 6e64  request.get("end
-00011b90: 706f 696e 745f 7572 6c22 2c20 2222 290a  point_url", "").
-00011ba0: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-00011bb0: 7069 7065 5f75 726c 203d 2028 0a20 2020  pipe_url = (.   
-00011bc0: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00011bd0: 5f70 6970 655f 7572 6c2e 7265 706c 6163  _pipe_url.replac
-00011be0: 6528 222e 6e64 6a73 6f6e 222c 2022 2e6a  e(".ndjson", ".j
-00011bf0: 736f 6e22 292e 7265 706c 6163 6528 222e  son").replace(".
-00011c00: 6373 7622 2c20 222e 6a73 6f6e 2229 2e72  csv", ".json").r
-00011c10: 6570 6c61 6365 2822 2e70 6172 7175 6574  eplace(".parquet
-00011c20: 222c 2022 2e6a 736f 6e22 290a 2020 2020  ", ".json").    
-00011c30: 2020 2020 290a 2020 2020 2020 2020 6375      ).        cu
-00011c40: 7272 656e 745f 7069 7065 5f75 726c 203d  rrent_pipe_url =
-00011c50: 2064 726f 705f 746f 6b65 6e28 6375 7272   drop_token(curr
-00011c60: 656e 745f 7069 7065 5f75 726c 290a 2020  ent_pipe_url).  
-00011c70: 2020 2020 2020 6375 7272 656e 745f 7069        current_pi
-00011c80: 7065 5f75 726c 202b 3d20 2822 2622 2069  pe_url += ("&" i
-00011c90: 6620 223f 2220 696e 2063 7572 7265 6e74  f "?" in current
-00011ca0: 5f70 6970 655f 7572 6c20 656c 7365 2022  _pipe_url else "
-00011cb0: 3f22 2920 2b20 2270 6970 655f 6368 6563  ?") + "pipe_chec
-00011cc0: 6b65 723d 7472 7565 220a 2020 2020 2020  ker=true".      
-00011cd0: 2020 7265 7475 726e 2063 7572 7265 6e74    return current
-00011ce0: 5f70 6970 655f 7572 6c2c 2072 6571 7565  _pipe_url, reque
-00011cf0: 7374 2e67 6574 2822 7069 7065 5f72 6571  st.get("pipe_req
-00011d00: 7565 7374 5f70 6172 616d 7322 2c20 7b7d  uest_params", {}
-00011d10: 290a 0a20 2020 2064 6566 205f 7072 6570  )..    def _prep
-00011d20: 6172 655f 6375 7272 656e 745f 7069 7065  are_current_pipe
-00011d30: 5f66 6f72 5f70 6f73 745f 7265 7175 6573  _for_post_reques
-00011d40: 7428 7365 6c66 2c20 7265 7175 6573 7429  t(self, request)
-00011d50: 202d 3e20 5475 706c 655b 7374 722c 2044   -> Tuple[str, D
-00011d60: 6963 745b 7374 722c 2073 7472 5d5d 3a0a  ict[str, str]]:.
-00011d70: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-00011d80: 7069 7065 5f75 726c 203d 2072 6571 7565  pipe_url = reque
-00011d90: 7374 2e67 6574 2822 656e 6470 6f69 6e74  st.get("endpoint
-00011da0: 5f75 726c 222c 2022 2229 0a20 2020 2020  _url", "").     
-00011db0: 2020 2063 7572 7265 6e74 5f70 6970 655f     current_pipe_
-00011dc0: 7572 6c20 3d20 280a 2020 2020 2020 2020  url = (.        
-00011dd0: 2020 2020 6375 7272 656e 745f 7069 7065      current_pipe
-00011de0: 5f75 726c 2e72 6570 6c61 6365 2822 2e6e  _url.replace(".n
-00011df0: 646a 736f 6e22 2c20 222e 6a73 6f6e 2229  djson", ".json")
-00011e00: 2e72 6570 6c61 6365 2822 2e63 7376 222c  .replace(".csv",
-00011e10: 2022 2e6a 736f 6e22 292e 7265 706c 6163   ".json").replac
-00011e20: 6528 222e 7061 7271 7565 7422 2c20 222e  e(".parquet", ".
-00011e30: 6a73 6f6e 2229 0a20 2020 2020 2020 2029  json").        )
-00011e40: 0a20 2020 2020 2020 2061 6c6c 5f70 6172  .        all_par
-00011e50: 616d 6574 6572 7320 3d20 7265 7175 6573  ameters = reques
-00011e60: 742e 6765 7428 2270 6970 655f 7265 7175  t.get("pipe_requ
-00011e70: 6573 745f 7061 7261 6d73 2229 0a20 2020  est_params").   
-00011e80: 2020 2020 2061 6c6c 5f70 6172 616d 6574       all_paramet
-00011e90: 6572 732e 706f 7028 2274 6f6b 656e 222c  ers.pop("token",
-00011ea0: 204e 6f6e 6529 0a20 2020 2020 2020 2061   None).        a
-00011eb0: 6c6c 5f70 6172 616d 6574 6572 735b 2270  ll_parameters["p
-00011ec0: 6970 655f 6368 6563 6b65 7222 5d20 3d20  ipe_checker"] = 
-00011ed0: 2274 7275 6522 0a0a 2020 2020 2020 2020  "true"..        
-00011ee0: 7265 7475 726e 2063 7572 7265 6e74 5f70  return current_p
-00011ef0: 6970 655f 7572 6c2c 2061 6c6c 5f70 6172  ipe_url, all_par
-00011f00: 616d 6574 6572 730a 0a20 2020 2064 6566  ameters..    def
-00011f10: 205f 5f73 7472 5f5f 2873 656c 6629 3a0a   __str__(self):.
-00011f20: 2020 2020 2020 2020 706f 7374 5f76 616c          post_val
-00011f30: 7565 7320 3d20 6622 202d 2050 4f53 5420  ues = f" - POST 
-00011f40: 426f 6479 3a20 7b73 656c 662e 7069 7065  Body: {self.pipe
-00011f50: 5f72 6571 7565 7374 5f70 6172 616d 737d  _request_params}
-00011f60: 2220 6966 2073 656c 662e 6874 7470 5f6d  " if self.http_m
-00011f70: 6574 686f 6420 3d3d 2022 504f 5354 2220  ethod == "POST" 
-00011f80: 656c 7365 2022 220a 0a20 2020 2020 2020  else ""..       
-00011f90: 2072 6574 7572 6e20 6622 6375 7272 656e   return f"curren
-00011fa0: 7420 7b73 656c 662e 6375 7272 656e 745f  t {self.current_
-00011fb0: 7069 7065 5f75 726c 7d7b 706f 7374 5f76  pipe_url}{post_v
-00011fc0: 616c 7565 737d 5c6e 2020 2020 6e65 7720  alues}\n    new 
-00011fd0: 7b73 656c 662e 6368 6563 6b65 725f 7069  {self.checker_pi
-00011fe0: 7065 5f75 726c 7d7b 706f 7374 5f76 616c  pe_url}{post_val
-00011ff0: 7565 737d 220a 0a20 2020 2064 6566 2064  ues}"..    def d
-00012000: 6966 6628 7365 6c66 2c20 613a 2044 6963  iff(self, a: Dic
-00012010: 745b 7374 722c 2041 6e79 5d2c 2062 3a20  t[str, Any], b: 
-00012020: 4469 6374 5b73 7472 2c20 416e 795d 2920  Dict[str, Any]) 
-00012030: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-00012040: 615f 7072 6f70 6572 7469 6573 203d 206c  a_properties = l
-00012050: 6973 7428 6d61 7028 6c61 6d62 6461 2078  ist(map(lambda x
-00012060: 3a20 6622 7b78 7d3a 7b61 5b78 5d7d 5c6e  : f"{x}:{a[x]}\n
-00012070: 222c 2061 2e6b 6579 7328 2929 290a 2020  ", a.keys())).  
-00012080: 2020 2020 2020 625f 7072 6f70 6572 7469        b_properti
-00012090: 6573 203d 206c 6973 7428 6d61 7028 6c61  es = list(map(la
-000120a0: 6d62 6461 2078 3a20 6622 7b78 7d3a 7b62  mbda x: f"{x}:{b
-000120b0: 5b78 5d7d 5c6e 222c 2062 2e6b 6579 7328  [x]}\n", b.keys(
-000120c0: 2929 290a 0a20 2020 2020 2020 2072 6574  )))..        ret
-000120d0: 7572 6e20 2222 2e6a 6f69 6e28 6469 6666  urn "".join(diff
-000120e0: 6c69 622e 636f 6e74 6578 745f 6469 6666  lib.context_diff
-000120f0: 2861 5f70 726f 7065 7274 6965 732c 2062  (a_properties, b
-00012100: 5f70 726f 7065 7274 6965 732c 2073 656c  _properties, sel
-00012110: 662e 7069 7065 5f6e 616d 652c 2073 656c  f.pipe_name, sel
-00012120: 662e 6368 6563 6b65 725f 7069 7065 5f6e  f.checker_pipe_n
-00012130: 616d 6529 290a 0a20 2020 2064 6566 205f  ame))..    def _
-00012140: 646f 5f72 6571 7565 7374 5f74 6f5f 7069  do_request_to_pi
-00012150: 7065 2873 656c 662c 2070 6970 655f 7572  pe(self, pipe_ur
-00012160: 6c3a 2073 7472 2920 2d3e 2052 6573 706f  l: str) -> Respo
-00012170: 6e73 653a 0a20 2020 2020 2020 2068 6561  nse:.        hea
-00012180: 6465 7273 203d 207b 2241 7574 686f 7269  ders = {"Authori
-00012190: 7a61 7469 6f6e 223a 2066 2242 6561 7265  zation": f"Beare
-000121a0: 7220 7b73 656c 662e 746f 6b65 6e7d 227d  r {self.token}"}
-000121b0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000121c0: 2e68 7474 705f 6d65 7468 6f64 203d 3d20  .http_method == 
-000121d0: 2247 4554 223a 0a20 2020 2020 2020 2020  "GET":.         
-000121e0: 2020 2072 6574 7572 6e20 7265 7175 6573     return reques
-000121f0: 7473 2e67 6574 2870 6970 655f 7572 6c2c  ts.get(pipe_url,
-00012200: 2068 6561 6465 7273 3d68 6561 6465 7273   headers=headers
-00012210: 2c20 7665 7269 6679 3d6e 6f74 2067 6574  , verify=not get
-00012220: 656e 765f 626f 6f6c 2822 5442 5f44 4953  env_bool("TB_DIS
-00012230: 4142 4c45 5f53 534c 5f43 4845 434b 5322  ABLE_SSL_CHECKS"
-00012240: 2c20 4661 6c73 6529 290a 2020 2020 2020  , False)).      
-00012250: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00012260: 2020 2020 7265 7475 726e 2072 6571 7565      return reque
-00012270: 7374 732e 706f 7374 280a 2020 2020 2020  sts.post(.      
-00012280: 2020 2020 2020 2020 2020 7069 7065 5f75            pipe_u
-00012290: 726c 2c0a 2020 2020 2020 2020 2020 2020  rl,.            
-000122a0: 2020 2020 6865 6164 6572 733d 6865 6164      headers=head
-000122b0: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
-000122c0: 2020 2020 2076 6572 6966 793d 6e6f 7420       verify=not 
-000122d0: 6765 7465 6e76 5f62 6f6f 6c28 2254 425f  getenv_bool("TB_
-000122e0: 4449 5341 424c 455f 5353 4c5f 4348 4543  DISABLE_SSL_CHEC
-000122f0: 4b53 222c 2046 616c 7365 292c 0a20 2020  KS", False),.   
-00012300: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00012310: 613d 7365 6c66 2e70 6970 655f 7265 7175  a=self.pipe_requ
-00012320: 6573 745f 7061 7261 6d73 2c0a 2020 2020  est_params,.    
-00012330: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-00012340: 6566 205f 7772 6974 655f 7065 7266 6f72  ef _write_perfor
-00012350: 6d61 6e63 6528 7365 6c66 293a 0a20 2020  mance(self):.   
-00012360: 2020 2020 2072 6574 7572 6e20 2222 0a0a       return ""..
-00012370: 2020 2020 6465 6620 5f72 756e 5465 7374      def _runTest
-00012380: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
-00012390: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-000123a0: 7220 3d20 7365 6c66 2e5f 646f 5f72 6571  r = self._do_req
-000123b0: 7565 7374 5f74 6f5f 7069 7065 2873 656c  uest_to_pipe(sel
-000123c0: 662e 6375 7272 656e 745f 7069 7065 5f75  f.current_pipe_u
-000123d0: 726c 290a 2020 2020 2020 2020 6368 6563  rl).        chec
-000123e0: 6b65 725f 7220 3d20 7365 6c66 2e5f 646f  ker_r = self._do
-000123f0: 5f72 6571 7565 7374 5f74 6f5f 7069 7065  _request_to_pipe
-00012400: 2873 656c 662e 6368 6563 6b65 725f 7069  (self.checker_pi
-00012410: 7065 5f75 726c 290a 0a20 2020 2020 2020  pe_url)..       
-00012420: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00012430: 2020 7365 6c66 2e63 7572 7265 6e74 5f72    self.current_r
-00012440: 6573 706f 6e73 655f 7469 6d65 203d 2063  esponse_time = c
-00012450: 7572 7265 6e74 5f72 2e65 6c61 7073 6564  urrent_r.elapsed
-00012460: 2e74 6f74 616c 5f73 6563 6f6e 6473 2829  .total_seconds()
-00012470: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00012480: 662e 6368 6563 6b65 725f 7265 7370 6f6e  f.checker_respon
-00012490: 7365 5f74 696d 6520 3d20 6368 6563 6b65  se_time = checke
-000124a0: 725f 722e 656c 6170 7365 642e 746f 7461  r_r.elapsed.tota
-000124b0: 6c5f 7365 636f 6e64 7328 290a 2020 2020  l_seconds().    
-000124c0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000124d0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-000124e0: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
-000124f0: 6375 7272 656e 745f 7265 7370 6f6e 7365  current_response
-00012500: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
-00012510: 203d 2063 7572 7265 6e74 5f72 2e6a 736f   = current_r.jso
-00012520: 6e28 290a 2020 2020 2020 2020 6368 6563  n().        chec
-00012530: 6b65 725f 7265 7370 6f6e 7365 3a20 4469  ker_response: Di
-00012540: 6374 5b73 7472 2c20 416e 795d 203d 2063  ct[str, Any] = c
-00012550: 6865 636b 6572 5f72 2e6a 736f 6e28 290a  hecker_r.json().
-00012560: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
-00012570: 5f64 6174 613a 204c 6973 745b 4469 6374  _data: List[Dict
-00012580: 5b73 7472 2c20 416e 795d 5d20 3d20 6375  [str, Any]] = cu
-00012590: 7272 656e 745f 7265 7370 6f6e 7365 2e67  rrent_response.g
-000125a0: 6574 2822 6461 7461 222c 205b 5d29 0a20  et("data", []). 
-000125b0: 2020 2020 2020 2063 6865 636b 6572 5f64         checker_d
-000125c0: 6174 613a 204c 6973 745b 4469 6374 5b73  ata: List[Dict[s
-000125d0: 7472 2c20 416e 795d 5d20 3d20 6368 6563  tr, Any]] = chec
-000125e0: 6b65 725f 7265 7370 6f6e 7365 2e67 6574  ker_response.get
-000125f0: 2822 6461 7461 222c 205b 5d29 0a0a 2020  ("data", [])..  
-00012600: 2020 2020 2020 7365 6c66 2e63 7572 7265        self.curre
-00012610: 6e74 5f72 6561 645f 6279 7465 7320 3d20  nt_read_bytes = 
-00012620: 6375 7272 656e 745f 7265 7370 6f6e 7365  current_response
-00012630: 2e67 6574 2822 7374 6174 6973 7469 6373  .get("statistics
-00012640: 222c 207b 7d29 2e67 6574 2822 6279 7465  ", {}).get("byte
-00012650: 735f 7265 6164 222c 2030 290a 2020 2020  s_read", 0).    
-00012660: 2020 2020 7365 6c66 2e63 6865 636b 6572      self.checker
-00012670: 5f72 6561 645f 6279 7465 7320 3d20 6368  _read_bytes = ch
-00012680: 6563 6b65 725f 7265 7370 6f6e 7365 2e67  ecker_response.g
-00012690: 6574 2822 7374 6174 6973 7469 6373 222c  et("statistics",
-000126a0: 207b 7d29 2e67 6574 2822 6279 7465 735f   {}).get("bytes_
-000126b0: 7265 6164 222c 2030 290a 0a20 2020 2020  read", 0)..     
-000126c0: 2020 2065 7272 6f72 5f63 6865 636b 5f66     error_check_f
-000126d0: 6978 7475 7265 735f 6461 7461 3a20 4f70  ixtures_data: Op
-000126e0: 7469 6f6e 616c 5b73 7472 5d20 3d20 6368  tional[str] = ch
-000126f0: 6563 6b65 725f 7265 7370 6f6e 7365 2e67  ecker_response.g
-00012700: 6574 2822 6572 726f 7222 2c20 4e6f 6e65  et("error", None
-00012710: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00012720: 7373 6572 7449 734e 6f6e 6528 0a20 2020  ssertIsNone(.   
-00012730: 2020 2020 2020 2020 2065 7272 6f72 5f63           error_c
-00012740: 6865 636b 5f66 6978 7475 7265 735f 6461  heck_fixtures_da
-00012750: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-00012760: 2259 6f75 2061 7265 2074 7279 696e 6720  "You are trying 
-00012770: 746f 2070 7573 6820 6120 7069 7065 2077  to push a pipe w
-00012780: 6974 6820 6572 726f 7273 2c20 706c 6561  ith errors, plea
-00012790: 7365 2063 6865 636b 2074 6865 206f 7574  se check the out
-000127a0: 7075 7420 6f72 2072 756e 2077 6974 6820  put or run with 
-000127b0: 2d2d 6e6f 2d63 6865 636b 222c 0a20 2020  --no-check",.   
-000127c0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000127d0: 696e 6372 6561 7365 5f72 6573 706f 6e73  increase_respons
-000127e0: 655f 7469 6d65 203d 2028 0a20 2020 2020  e_time = (.     
-000127f0: 2020 2020 2020 2063 6865 636b 6572 5f72         checker_r
-00012800: 2e65 6c61 7073 6564 2e74 6f74 616c 5f73  .elapsed.total_s
-00012810: 6563 6f6e 6473 2829 202d 2063 7572 7265  econds() - curre
-00012820: 6e74 5f72 2e65 6c61 7073 6564 2e74 6f74  nt_r.elapsed.tot
-00012830: 616c 5f73 6563 6f6e 6473 2829 0a20 2020  al_seconds().   
-00012840: 2020 2020 2029 202f 2063 7572 7265 6e74       ) / current
-00012850: 5f72 2e65 6c61 7073 6564 2e74 6f74 616c  _r.elapsed.total
-00012860: 5f73 6563 6f6e 6473 2829 0a20 2020 2020  _seconds().     
-00012870: 2020 2069 6620 7365 6c66 2e6f 6e6c 795f     if self.only_
-00012880: 7265 7370 6f6e 7365 5f74 696d 6573 3a0a  response_times:.
-00012890: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000128a0: 2e61 7373 6572 744c 6573 7328 0a20 2020  .assertLess(.   
-000128b0: 2020 2020 2020 2020 2020 2020 2069 6e63               inc
-000128c0: 7265 6173 655f 7265 7370 6f6e 7365 5f74  rease_response_t
-000128d0: 696d 652c 2030 2e32 352c 206d 7367 3d66  ime, 0.25, msg=f
-000128e0: 2272 6573 706f 6e73 6520 7469 6d65 2068  "response time h
-000128f0: 6173 2069 6e63 7265 6173 6564 207b 726f  as increased {ro
-00012900: 756e 6428 696e 6372 6561 7365 5f72 6573  und(increase_res
-00012910: 706f 6e73 655f 7469 6d65 202a 2031 3030  ponse_time * 100
-00012920: 297d 2522 0a20 2020 2020 2020 2020 2020  )}%".           
-00012930: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
-00012940: 6574 7572 6e0a 0a20 2020 2020 2020 2073  eturn..        s
-00012950: 656c 662e 6173 7365 7274 4571 7561 6c28  elf.assertEqual(
-00012960: 6c65 6e28 6375 7272 656e 745f 6461 7461  len(current_data
-00012970: 292c 206c 656e 2863 6865 636b 6572 5f64  ), len(checker_d
-00012980: 6174 6129 2c20 224e 756d 6265 7220 6f66  ata), "Number of
-00012990: 2065 6c65 6d65 6e74 7320 646f 6573 206e   elements does n
-000129a0: 6f74 206d 6174 6368 2229 0a0a 2020 2020  ot match")..    
-000129b0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-000129c0: 6461 7465 5f70 726f 6365 7373 6564 5f62  date_processed_b
-000129d0: 7974 6573 3a0a 2020 2020 2020 2020 2020  ytes:.          
-000129e0: 2020 696e 6372 6561 7365 5f72 6561 645f    increase_read_
-000129f0: 6279 7465 7320 3d20 2873 656c 662e 6368  bytes = (self.ch
-00012a00: 6563 6b65 725f 7265 6164 5f62 7974 6573  ecker_read_bytes
-00012a10: 202d 2073 656c 662e 6375 7272 656e 745f   - self.current_
-00012a20: 7265 6164 5f62 7974 6573 2920 2f20 7365  read_bytes) / se
-00012a30: 6c66 2e63 7572 7265 6e74 5f72 6561 645f  lf.current_read_
-00012a40: 6279 7465 730a 2020 2020 2020 2020 2020  bytes.          
-00012a50: 2020 7365 6c66 2e61 7373 6572 744c 6573    self.assertLes
-00012a60: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00012a70: 2020 2072 6f75 6e64 2869 6e63 7265 6173     round(increas
-00012a80: 655f 7265 6164 5f62 7974 6573 2c20 3229  e_read_bytes, 2)
-00012a90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012aa0: 2020 302e 3235 2c0a 2020 2020 2020 2020    0.25,.        
-00012ab0: 2020 2020 2020 2020 6d73 673d 6622 5468          msg=f"Th
-00012ac0: 6520 6e75 6d62 6572 206f 6620 7072 6f63  e number of proc
-00012ad0: 6573 7365 6420 6279 7465 7320 6861 7320  essed bytes has 
-00012ae0: 696e 6372 6561 7365 6420 7b72 6f75 6e64  increased {round
-00012af0: 2869 6e63 7265 6173 655f 7265 6164 5f62  (increase_read_b
-00012b00: 7974 6573 202a 2031 3030 297d 2522 2c0a  ytes * 100)}%",.
-00012b10: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00012b20: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00012b30: 676e 6f72 655f 6f72 6465 723a 0a20 2020  gnore_order:.   
-00012b40: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00012b50: 5f64 6174 6120 3d20 280a 2020 2020 2020  _data = (.      
-00012b60: 2020 2020 2020 2020 2020 736f 7274 6564            sorted
-00012b70: 286e 6f72 6d61 6c69 7a65 5f61 7272 6179  (normalize_array
-00012b80: 2863 7572 7265 6e74 5f64 6174 6129 2c20  (current_data), 
-00012b90: 6b65 793d 6974 656d 6765 7474 6572 282a  key=itemgetter(*
-00012ba0: 5b6b 2066 6f72 206b 2069 6e20 6375 7272  [k for k in curr
-00012bb0: 656e 745f 6461 7461 5b30 5d2e 6b65 7973  ent_data[0].keys
-00012bc0: 2829 5d29 290a 2020 2020 2020 2020 2020  ()])).          
-00012bd0: 2020 2020 2020 6966 206c 656e 2863 7572        if len(cur
-00012be0: 7265 6e74 5f64 6174 6129 203e 2030 0a20  rent_data) > 0. 
-00012bf0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00012c00: 6c73 6520 6375 7272 656e 745f 6461 7461  lse current_data
-00012c10: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00012c20: 2020 2020 2020 2020 2020 2063 6865 636b             check
-00012c30: 6572 5f64 6174 6120 3d20 280a 2020 2020  er_data = (.    
-00012c40: 2020 2020 2020 2020 2020 2020 736f 7274              sort
-00012c50: 6564 286e 6f72 6d61 6c69 7a65 5f61 7272  ed(normalize_arr
-00012c60: 6179 2863 6865 636b 6572 5f64 6174 6129  ay(checker_data)
-00012c70: 2c20 6b65 793d 6974 656d 6765 7474 6572  , key=itemgetter
-00012c80: 282a 5b6b 2066 6f72 206b 2069 6e20 6368  (*[k for k in ch
-00012c90: 6563 6b65 725f 6461 7461 5b30 5d2e 6b65  ecker_data[0].ke
-00012ca0: 7973 2829 5d29 290a 2020 2020 2020 2020  ys()])).        
-00012cb0: 2020 2020 2020 2020 6966 206c 656e 2863          if len(c
-00012cc0: 6865 636b 6572 5f64 6174 6129 203e 2030  hecker_data) > 0
-00012cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012ce0: 2065 6c73 6520 6368 6563 6b65 725f 6461   else checker_da
-00012cf0: 7461 0a20 2020 2020 2020 2020 2020 2029  ta.            )
-00012d00: 0a0a 2020 2020 2020 2020 666f 7220 5f2c  ..        for _,
-00012d10: 2028 6375 7272 656e 745f 6461 7461 5f65   (current_data_e
-00012d20: 2c20 6368 6563 6b5f 6669 7874 7572 6573  , check_fixtures
-00012d30: 5f64 6174 615f 6529 2069 6e20 656e 756d  _data_e) in enum
-00012d40: 6572 6174 6528 7a69 7028 6375 7272 656e  erate(zip(curren
-00012d50: 745f 6461 7461 2c20 6368 6563 6b65 725f  t_data, checker_
-00012d60: 6461 7461 2929 3a0a 2020 2020 2020 2020  data)):.        
-00012d70: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00012d80: 7175 616c 286c 6973 7428 6375 7272 656e  qual(list(curren
-00012d90: 745f 6461 7461 5f65 2e6b 6579 7328 2929  t_data_e.keys())
-00012da0: 2c20 6c69 7374 2863 6865 636b 5f66 6978  , list(check_fix
-00012db0: 7475 7265 735f 6461 7461 5f65 2e6b 6579  tures_data_e.key
-00012dc0: 7328 2929 290a 2020 2020 2020 2020 2020  s())).          
-00012dd0: 2020 666f 7220 7820 696e 2063 7572 7265    for x in curre
-00012de0: 6e74 5f64 6174 615f 652e 6b65 7973 2829  nt_data_e.keys()
-00012df0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012e00: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00012e10: 6375 7272 656e 745f 6461 7461 5f65 5b78  current_data_e[x
-00012e20: 5d2c 2066 6c6f 6174 293a 0a20 2020 2020  ], float):.     
-00012e30: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00012e40: 203d 2061 6273 2863 7572 7265 6e74 5f64   = abs(current_d
-00012e50: 6174 615f 655b 785d 202d 2063 6865 636b  ata_e[x] - check
-00012e60: 5f66 6978 7475 7265 735f 6461 7461 5f65  _fixtures_data_e
-00012e70: 5b78 5d29 0a20 2020 2020 2020 2020 2020  [x]).           
-00012e80: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00012e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ea0: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
-00012eb0: 744c 6573 7345 7175 616c 280a 2020 2020  tLessEqual(.    
-00012ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ed0: 2020 2020 2020 2020 6420 2f20 6375 7272          d / curr
-00012ee0: 656e 745f 6461 7461 5f65 5b78 5d2c 0a20  ent_data_e[x],. 
-00012ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f00: 2020 2020 2020 2020 2020 2030 2e30 312c             0.01,
-00012f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012f20: 2020 2020 2020 2020 2020 2020 2066 226b               f"k
-00012f30: 6579 207b 787d 2e20 6f6c 6420 7661 6c75  ey {x}. old valu
-00012f40: 653a 207b 6375 7272 656e 745f 6461 7461  e: {current_data
-00012f50: 5f65 5b78 5d7d 2c20 6e65 7720 7661 6c75  _e[x]}, new valu
-00012f60: 653a 207b 6368 6563 6b5f 6669 7874 7572  e: {check_fixtur
-00012f70: 6573 5f64 6174 615f 655b 785d 7d5c 6e7b  es_data_e[x]}\n{
-00012f80: 7365 6c66 2e64 6966 6628 6375 7272 656e  self.diff(curren
-00012f90: 745f 6461 7461 5f65 2c20 6368 6563 6b5f  t_data_e, check_
-00012fa0: 6669 7874 7572 6573 5f64 6174 615f 6529  fixtures_data_e)
-00012fb0: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-00012fc0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00007200: 655f 6461 7461 736f 7572 6365 280a 2020  e_datasource(.  
+00007210: 2020 6669 6c65 6e61 6d65 3a20 7374 722c    filename: str,
+00007220: 2072 6570 6c61 6365 5f69 6e63 6c75 6465   replace_include
+00007230: 733a 2062 6f6f 6c20 3d20 5472 7565 2c20  s: bool = True, 
+00007240: 636f 6e74 656e 743a 204f 7074 696f 6e61  content: Optiona
+00007250: 6c5b 7374 725d 203d 204e 6f6e 652c 2073  l[str] = None, s
+00007260: 6b69 705f 6576 616c 3a20 626f 6f6c 203d  kip_eval: bool =
+00007270: 2046 616c 7365 0a29 202d 3e20 4461 7461   False.) -> Data
+00007280: 6669 6c65 3a0a 2020 2020 6261 7365 7061  file:.    basepa
+00007290: 7468 203d 2022 220a 2020 2020 6966 206e  th = "".    if n
+000072a0: 6f74 2063 6f6e 7465 6e74 3a0a 2020 2020  ot content:.    
+000072b0: 2020 2020 7769 7468 206f 7065 6e28 6669      with open(fi
+000072c0: 6c65 6e61 6d65 2920 6173 2066 696c 653a  lename) as file:
+000072d0: 0a20 2020 2020 2020 2020 2020 2073 203d  .            s =
+000072e0: 2066 696c 652e 7265 6164 2829 0a20 2020   file.read().   
+000072f0: 2020 2020 2062 6173 6570 6174 6820 3d20       basepath = 
+00007300: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
+00007310: 6669 6c65 6e61 6d65 290a 2020 2020 656c  filename).    el
+00007320: 7365 3a0a 2020 2020 2020 2020 7320 3d20  se:.        s = 
+00007330: 636f 6e74 656e 740a 0a20 2020 2074 7279  content..    try
+00007340: 3a0a 2020 2020 2020 2020 646f 6320 3d20  :.        doc = 
+00007350: 7061 7273 6528 732c 2022 6465 6661 756c  parse(s, "defaul
+00007360: 7422 2c20 6261 7365 7061 7468 2c20 7265  t", basepath, re
+00007370: 706c 6163 655f 696e 636c 7564 6573 3d72  place_includes=r
+00007380: 6570 6c61 6365 5f69 6e63 6c75 6465 732c  eplace_includes,
+00007390: 2073 6b69 705f 6576 616c 3d73 6b69 705f   skip_eval=skip_
+000073a0: 6576 616c 290a 2020 2020 6578 6365 7074  eval).    except
+000073b0: 2050 6172 7365 4578 6365 7074 696f 6e20   ParseException 
+000073c0: 6173 2065 3a0a 2020 2020 2020 2020 7261  as e:.        ra
+000073d0: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
+000073e0: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
+000073f0: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
+00007400: 6e61 6765 722e 6572 726f 725f 7061 7273  nager.error_pars
+00007410: 696e 675f 6669 6c65 2866 696c 656e 616d  ing_file(filenam
+00007420: 653d 6669 6c65 6e61 6d65 2c20 6c69 6e65  e=filename, line
+00007430: 6e6f 3d65 2e6c 696e 656e 6f2c 2065 7272  no=e.lineno, err
+00007440: 6f72 3d65 290a 2020 2020 2020 2020 2920  or=e).        ) 
+00007450: 6672 6f6d 204e 6f6e 650a 0a20 2020 2069  from None..    i
+00007460: 6620 6c65 6e28 646f 632e 6e6f 6465 7329  f len(doc.nodes)
+00007470: 203e 2031 3a0a 2020 2020 2020 2020 7261   > 1:.        ra
+00007480: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00007490: 227b 6669 6c65 6e61 6d65 7d3a 2064 6174  "{filename}: dat
+000074a0: 6173 6f75 7263 6573 2063 616e 2774 2068  asources can't h
+000074b0: 6176 6520 6d6f 7265 2074 6861 6e20 6f6e  ave more than on
+000074c0: 6520 6e6f 6465 2229 0a0a 2020 2020 7265  e node")..    re
+000074d0: 7475 726e 2064 6f63 0a0a 0a64 6566 2070  turn doc...def p
+000074e0: 6172 7365 5f70 6970 6528 0a20 2020 2066  arse_pipe(.    f
+000074f0: 696c 656e 616d 653a 2073 7472 2c20 7265  ilename: str, re
+00007500: 706c 6163 655f 696e 636c 7564 6573 3a20  place_includes: 
+00007510: 626f 6f6c 203d 2054 7275 652c 2063 6f6e  bool = True, con
+00007520: 7465 6e74 3a20 4f70 7469 6f6e 616c 5b73  tent: Optional[s
+00007530: 7472 5d20 3d20 4e6f 6e65 2c20 736b 6970  tr] = None, skip
+00007540: 5f65 7661 6c3a 2062 6f6f 6c20 3d20 4661  _eval: bool = Fa
+00007550: 6c73 650a 2920 2d3e 2044 6174 6166 696c  lse.) -> Datafil
+00007560: 653a 0a20 2020 2062 6173 6570 6174 6820  e:.    basepath 
+00007570: 3d20 2222 0a20 2020 2069 6620 6e6f 7420  = "".    if not 
+00007580: 636f 6e74 656e 743a 0a20 2020 2020 2020  content:.       
+00007590: 2077 6974 6820 6f70 656e 2866 696c 656e   with open(filen
+000075a0: 616d 6529 2061 7320 6669 6c65 3a0a 2020  ame) as file:.  
+000075b0: 2020 2020 2020 2020 2020 7320 3d20 6669            s = fi
+000075c0: 6c65 2e72 6561 6428 290a 2020 2020 2020  le.read().      
+000075d0: 2020 6261 7365 7061 7468 203d 206f 732e    basepath = os.
+000075e0: 7061 7468 2e64 6972 6e61 6d65 2866 696c  path.dirname(fil
+000075f0: 656e 616d 6529 0a20 2020 2065 6c73 653a  ename).    else:
+00007600: 0a20 2020 2020 2020 2073 203d 2063 6f6e  .        s = con
+00007610: 7465 6e74 0a0a 2020 2020 7472 793a 0a20  tent..    try:. 
+00007620: 2020 2020 2020 2073 716c 203d 2022 220a         sql = "".
+00007630: 2020 2020 2020 2020 646f 6320 3d20 7061          doc = pa
+00007640: 7273 6528 732c 2062 6173 6570 6174 683d  rse(s, basepath=
+00007650: 6261 7365 7061 7468 2c20 7265 706c 6163  basepath, replac
+00007660: 655f 696e 636c 7564 6573 3d72 6570 6c61  e_includes=repla
+00007670: 6365 5f69 6e63 6c75 6465 732c 2073 6b69  ce_includes, ski
+00007680: 705f 6576 616c 3d73 6b69 705f 6576 616c  p_eval=skip_eval
+00007690: 290a 2020 2020 2020 2020 666f 7220 6e6f  ).        for no
+000076a0: 6465 2069 6e20 646f 632e 6e6f 6465 733a  de in doc.nodes:
+000076b0: 0a20 2020 2020 2020 2020 2020 2073 716c  .            sql
+000076c0: 203d 206e 6f64 652e 6765 7428 2273 716c   = node.get("sql
+000076d0: 222c 2022 2229 0a20 2020 2020 2020 2020  ", "").         
+000076e0: 2020 2069 6620 7371 6c2e 7374 7269 7028     if sql.strip(
+000076f0: 295b 305d 203d 3d20 2225 223a 0a20 2020  )[0] == "%":.   
+00007700: 2020 2020 2020 2020 2020 2020 2073 716c               sql
+00007710: 2c20 5f20 3d20 7265 6e64 6572 5f73 716c  , _ = render_sql
+00007720: 5f74 656d 706c 6174 6528 7371 6c5b 313a  _template(sql[1:
+00007730: 5d2c 2074 6573 745f 6d6f 6465 3d54 7275  ], test_mode=Tru
+00007740: 652c 206e 616d 653d 6e6f 6465 5b22 6e61  e, name=node["na
+00007750: 6d65 225d 290a 2020 2020 2020 2020 2020  me"]).          
+00007760: 2020 2320 6974 276c 6c20 6661 696c 2077    # it'll fail w
+00007770: 6974 6820 6120 4d6f 6475 6c65 4e6f 7446  ith a ModuleNotF
+00007780: 6f75 6e64 4572 726f 7220 7768 656e 2074  oundError when t
+00007790: 6865 2074 6f6f 6c73 6574 2069 7320 6e6f  he toolset is no
+000077a0: 7420 6176 6169 6c61 626c 6520 6275 7420  t available but 
+000077b0: 6974 2072 6574 7572 6e73 2074 6865 2070  it returns the p
+000077c0: 6172 7365 6420 646f 630a 2020 2020 2020  arsed doc.      
+000077d0: 2020 2020 2020 6672 6f6d 2074 696e 7962        from tinyb
+000077e0: 6972 642e 7371 6c5f 746f 6f6c 7365 7420  ird.sql_toolset 
+000077f0: 696d 706f 7274 2066 6f72 6d61 745f 7371  import format_sq
+00007800: 6c20 6173 2074 6f6f 6c73 6574 5f66 6f72  l as toolset_for
+00007810: 6d61 745f 7371 6c0a 0a20 2020 2020 2020  mat_sql..       
+00007820: 2020 2020 2074 6f6f 6c73 6574 5f66 6f72       toolset_for
+00007830: 6d61 745f 7371 6c28 7371 6c29 0a20 2020  mat_sql(sql).   
+00007840: 2065 7863 6570 7420 5061 7273 6545 7863   except ParseExc
+00007850: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00007860: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
+00007870: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
+00007880: 0a20 2020 2020 2020 2020 2020 2046 6565  .            Fee
+00007890: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+000078a0: 6f72 5f70 6172 7369 6e67 5f66 696c 6528  or_parsing_file(
+000078b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000078c0: 2066 696c 656e 616d 653d 6669 6c65 6e61   filename=filena
+000078d0: 6d65 2c20 6c69 6e65 6e6f 3d65 2e6c 696e  me, lineno=e.lin
+000078e0: 656e 6f2c 2065 7272 6f72 3d66 227b 7374  eno, error=f"{st
+000078f0: 7228 6529 7d20 2b20 5351 4c28 7061 7273  r(e)} + SQL(pars
+00007900: 6520 6578 6365 7074 696f 6e29 3a20 7b73  e exception): {s
+00007910: 716c 7d22 0a20 2020 2020 2020 2020 2020  ql}".           
+00007920: 2029 0a20 2020 2020 2020 2029 0a20 2020   ).        ).   
+00007930: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
+00007940: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
+00007950: 2074 2c20 7465 6d70 6c61 7465 5f76 6172   t, template_var
+00007960: 6961 626c 6573 203d 2067 6574 5f74 656d  iables = get_tem
+00007970: 706c 6174 655f 616e 645f 7661 7269 6162  plate_and_variab
+00007980: 6c65 7328 7371 6c2c 206e 616d 653d 6e6f  les(sql, name=no
+00007990: 6465 5b22 6e61 6d65 225d 290a 0a20 2020  de["name"])..   
+000079a0: 2020 2020 2069 6620 7371 6c2e 7374 7269       if sql.stri
+000079b0: 7028 295b 305d 2021 3d20 2225 2220 616e  p()[0] != "%" an
+000079c0: 6420 6c65 6e28 7465 6d70 6c61 7465 5f76  d len(template_v
+000079d0: 6172 6961 626c 6573 2920 3e20 303a 0a20  ariables) > 0:. 
+000079e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000079f0: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
+00007a00: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+00007a10: 6e61 6765 722e 6572 726f 725f 7465 6d70  nager.error_temp
+00007a20: 6c61 7465 5f73 7461 7274 2866 696c 656e  late_start(filen
+00007a30: 616d 653d 6669 6c65 6e61 6d65 2929 0a20  ame=filename)). 
+00007a40: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
+00007a50: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
+00007a60: 6e28 0a20 2020 2020 2020 2020 2020 2046  n(.            F
+00007a70: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
+00007a80: 7272 6f72 5f70 6172 7369 6e67 5f66 696c  rror_parsing_fil
+00007a90: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00007aa0: 2020 2066 696c 656e 616d 653d 6669 6c65     filename=file
+00007ab0: 6e61 6d65 2c20 6c69 6e65 6e6f 3d22 222c  name, lineno="",
+00007ac0: 2065 7272 6f72 3d66 227b 7374 7228 6529   error=f"{str(e)
+00007ad0: 7d20 2b20 5351 4c28 7661 6c75 6520 6572  } + SQL(value er
+00007ae0: 726f 7229 3a20 7b73 716c 7d22 0a20 2020  ror): {sql}".   
+00007af0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00007b00: 2020 2029 0a20 2020 2065 7863 6570 7420     ).    except 
+00007b10: 556e 436c 6f73 6564 4966 4572 726f 7220  UnClosedIfError 
+00007b20: 6173 2065 3a0a 2020 2020 2020 2020 7261  as e:.        ra
+00007b30: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
+00007b40: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
+00007b50: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
+00007b60: 6e61 6765 722e 6572 726f 725f 7061 7273  nager.error_pars
+00007b70: 696e 675f 6e6f 6465 5f77 6974 685f 756e  ing_node_with_un
+00007b80: 636c 6f73 6564 5f69 6628 6e6f 6465 3d65  closed_if(node=e
+00007b90: 2e6e 6f64 652c 2070 6970 653d 6669 6c65  .node, pipe=file
+00007ba0: 6e61 6d65 2c20 6c69 6e65 6e6f 3d65 2e6c  name, lineno=e.l
+00007bb0: 696e 656e 6f2c 2073 716c 3d65 2e73 716c  ineno, sql=e.sql
+00007bc0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+00007bd0: 6578 6365 7074 204d 6f64 756c 654e 6f74  except ModuleNot
+00007be0: 466f 756e 6445 7272 6f72 3a0a 2020 2020  FoundError:.    
+00007bf0: 2020 2020 7061 7373 0a0a 2020 2020 7265      pass..    re
+00007c00: 7475 726e 2064 6f63 0a0a 0a64 6566 2070  turn doc...def p
+00007c10: 6172 7365 5f74 6f6b 656e 280a 2020 2020  arse_token(.    
+00007c20: 6669 6c65 6e61 6d65 3a20 7374 722c 2072  filename: str, r
+00007c30: 6570 6c61 6365 5f69 6e63 6c75 6465 733a  eplace_includes:
+00007c40: 2062 6f6f 6c20 3d20 5472 7565 2c20 636f   bool = True, co
+00007c50: 6e74 656e 743a 204f 7074 696f 6e61 6c5b  ntent: Optional[
+00007c60: 7374 725d 203d 204e 6f6e 652c 2073 6b69  str] = None, ski
+00007c70: 705f 6576 616c 3a20 626f 6f6c 203d 2046  p_eval: bool = F
+00007c80: 616c 7365 0a29 202d 3e20 4461 7461 6669  alse.) -> Datafi
+00007c90: 6c65 3a0a 2020 2020 6966 206e 6f74 2063  le:.    if not c
+00007ca0: 6f6e 7465 6e74 3a0a 2020 2020 2020 2020  ontent:.        
+00007cb0: 7769 7468 206f 7065 6e28 6669 6c65 6e61  with open(filena
+00007cc0: 6d65 2920 6173 2066 696c 653a 0a20 2020  me) as file:.   
+00007cd0: 2020 2020 2020 2020 2073 203d 2066 696c           s = fil
+00007ce0: 652e 7265 6164 2829 0a20 2020 2020 2020  e.read().       
+00007cf0: 2062 6173 6570 6174 6820 3d20 6f73 2e70   basepath = os.p
+00007d00: 6174 682e 6469 726e 616d 6528 6669 6c65  ath.dirname(file
+00007d10: 6e61 6d65 290a 2020 2020 656c 7365 3a0a  name).    else:.
+00007d20: 2020 2020 2020 2020 7320 3d20 636f 6e74          s = cont
+00007d30: 656e 740a 0a20 2020 2074 7279 3a0a 2020  ent..    try:.  
+00007d40: 2020 2020 2020 7371 6c20 3d20 2222 0a20        sql = "". 
+00007d50: 2020 2020 2020 2064 6f63 203d 2070 6172         doc = par
+00007d60: 7365 2873 2c20 6261 7365 7061 7468 3d62  se(s, basepath=b
+00007d70: 6173 6570 6174 682c 2072 6570 6c61 6365  asepath, replace
+00007d80: 5f69 6e63 6c75 6465 733d 7265 706c 6163  _includes=replac
+00007d90: 655f 696e 636c 7564 6573 2c20 736b 6970  e_includes, skip
+00007da0: 5f65 7661 6c3d 736b 6970 5f65 7661 6c29  _eval=skip_eval)
+00007db0: 0a20 2020 2065 7863 6570 7420 5061 7273  .    except Pars
+00007dc0: 6545 7863 6570 7469 6f6e 2061 7320 653a  eException as e:
+00007dd0: 0a20 2020 2020 2020 2072 6169 7365 2063  .        raise c
+00007de0: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
+00007df0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+00007e00: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
+00007e10: 2e65 7272 6f72 5f70 6172 7369 6e67 5f66  .error_parsing_f
+00007e20: 696c 6528 0a20 2020 2020 2020 2020 2020  ile(.           
+00007e30: 2020 2020 2066 696c 656e 616d 653d 6669       filename=fi
+00007e40: 6c65 6e61 6d65 2c20 6c69 6e65 6e6f 3d65  lename, lineno=e
+00007e50: 2e6c 696e 656e 6f2c 2065 7272 6f72 3d66  .lineno, error=f
+00007e60: 227b 7374 7228 6529 7d20 2b20 5351 4c28  "{str(e)} + SQL(
+00007e70: 7061 7273 6520 6578 6365 7074 696f 6e29  parse exception)
+00007e80: 3a20 7b73 716c 7d22 0a20 2020 2020 2020  : {sql}".       
+00007e90: 2020 2020 2029 0a20 2020 2020 2020 2029       ).        )
+00007ea0: 0a20 2020 2065 7863 6570 7420 5661 6c75  .    except Valu
+00007eb0: 6545 7272 6f72 2061 7320 653a 0a20 2020  eError as e:.   
+00007ec0: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
+00007ed0: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
+00007ee0: 0a20 2020 2020 2020 2020 2020 2046 6565  .            Fee
+00007ef0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+00007f00: 6f72 5f70 6172 7369 6e67 5f66 696c 6528  or_parsing_file(
+00007f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007f20: 2066 696c 656e 616d 653d 6669 6c65 6e61   filename=filena
+00007f30: 6d65 2c20 6c69 6e65 6e6f 3d22 222c 2065  me, lineno="", e
+00007f40: 7272 6f72 3d66 227b 7374 7228 6529 7d20  rror=f"{str(e)} 
+00007f50: 2b20 5351 4c28 7661 6c75 6520 6572 726f  + SQL(value erro
+00007f60: 7229 3a20 7b73 716c 7d22 0a20 2020 2020  r): {sql}".     
+00007f70: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00007f80: 2029 0a20 2020 2065 7863 6570 7420 556e   ).    except Un
+00007f90: 436c 6f73 6564 4966 4572 726f 7220 6173  ClosedIfError as
+00007fa0: 2065 3a0a 2020 2020 2020 2020 7261 6973   e:.        rais
+00007fb0: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
+00007fc0: 6570 7469 6f6e 280a 2020 2020 2020 2020  eption(.        
+00007fd0: 2020 2020 4665 6564 6261 636b 4d61 6e61      FeedbackMana
+00007fe0: 6765 722e 6572 726f 725f 7061 7273 696e  ger.error_parsin
+00007ff0: 675f 6e6f 6465 5f77 6974 685f 756e 636c  g_node_with_uncl
+00008000: 6f73 6564 5f69 6628 6e6f 6465 3d65 2e6e  osed_if(node=e.n
+00008010: 6f64 652c 2070 6970 653d 6669 6c65 6e61  ode, pipe=filena
+00008020: 6d65 2c20 6c69 6e65 6e6f 3d65 2e6c 696e  me, lineno=e.lin
+00008030: 656e 6f2c 2073 716c 3d65 2e73 716c 290a  eno, sql=e.sql).
+00008040: 2020 2020 2020 2020 290a 2020 2020 6578          ).    ex
+00008050: 6365 7074 204d 6f64 756c 654e 6f74 466f  cept ModuleNotFo
+00008060: 756e 6445 7272 6f72 3a0a 2020 2020 2020  undError:.      
+00008070: 2020 7061 7373 0a0a 2020 2020 7265 7475    pass..    retu
+00008080: 726e 2064 6f63 0a0a 0a64 6566 205f 756e  rn doc...def _un
+00008090: 7175 6f74 6528 783a 2073 7472 293a 0a20  quote(x: str):. 
+000080a0: 2020 2051 554f 5445 5320 3d20 2827 2227     QUOTES = ('"'
+000080b0: 2c20 2227 2229 0a20 2020 2069 6620 785b  , "'").    if x[
+000080c0: 305d 2069 6e20 5155 4f54 4553 2061 6e64  0] in QUOTES and
+000080d0: 2078 5b2d 315d 2069 6e20 5155 4f54 4553   x[-1] in QUOTES
+000080e0: 3a0a 2020 2020 2020 2020 7820 3d20 785b  :.        x = x[
+000080f0: 313a 2d31 5d0a 2020 2020 7265 7475 726e  1:-1].    return
+00008100: 2078 0a0a 0a64 6566 2065 7661 6c5f 7661   x...def eval_va
+00008110: 7228 733a 2073 7472 2c20 736b 6970 3a20  r(s: str, skip: 
+00008120: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
+00008130: 2073 7472 3a0a 2020 2020 6966 2073 6b69   str:.    if ski
+00008140: 703a 0a20 2020 2020 2020 2072 6574 7572  p:.        retur
+00008150: 6e20 730a 2020 2020 2320 7265 706c 6163  n s.    # replac
+00008160: 6520 454e 5620 7661 7269 6162 6c65 730a  e ENV variables.
+00008170: 2020 2020 2320 6974 2773 2070 726f 6261      # it's proba
+00008180: 626c 7920 6120 6261 6420 6964 6561 2074  bly a bad idea t
+00008190: 6f20 616c 6c6f 7720 746f 2067 6574 2061  o allow to get a
+000081a0: 6e79 2065 6e76 2076 6172 0a20 2020 2072  ny env var.    r
+000081b0: 6574 7572 6e20 5465 6d70 6c61 7465 2873  eturn Template(s
+000081c0: 292e 7361 6665 5f73 7562 7374 6974 7574  ).safe_substitut
+000081d0: 6528 6f73 2e65 6e76 6972 6f6e 290a 0a0a  e(os.environ)...
+000081e0: 6465 6620 7061 7273 6528 0a20 2020 2073  def parse(.    s
+000081f0: 3a20 7374 722c 0a20 2020 2064 6566 6175  : str,.    defau
+00008200: 6c74 5f6e 6f64 653a 204f 7074 696f 6e61  lt_node: Optiona
+00008210: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
+00008220: 2020 2062 6173 6570 6174 683a 2073 7472     basepath: str
+00008230: 203d 2022 2e22 2c0a 2020 2020 7265 706c   = ".",.    repl
+00008240: 6163 655f 696e 636c 7564 6573 3a20 626f  ace_includes: bo
+00008250: 6f6c 203d 2054 7275 652c 0a20 2020 2073  ol = True,.    s
+00008260: 6b69 705f 6576 616c 3a20 626f 6f6c 203d  kip_eval: bool =
+00008270: 2046 616c 7365 2c0a 2920 2d3e 2044 6174   False,.) -> Dat
+00008280: 6166 696c 653a 2020 2320 6e6f 7161 3a20  afile:  # noqa: 
+00008290: 4339 3031 0a20 2020 2022 2222 0a20 2020  C901.    """.   
+000082a0: 2050 6172 7365 7320 6073 6020 7374 7269   Parses `s` stri
+000082b0: 6e67 2069 6e74 6f20 6120 646f 6375 6d65  ng into a docume
+000082c0: 6e74 0a20 2020 203e 3e3e 2064 203d 2070  nt.    >>> d = p
+000082d0: 6172 7365 2822 4652 4f4d 2053 4352 4154  arse("FROM SCRAT
+000082e0: 4348 5c5c 6e53 4f55 5243 4520 2768 7474  CH\\nSOURCE 'htt
+000082f0: 7073 3a2f 2f65 7861 6d70 6c65 2e63 6f6d  ps://example.com
+00008300: 275c 5c6e 2374 6869 7320 6973 2061 2063  '\\n#this is a c
+00008310: 6f6d 6d65 6e74 5c5c 6e4d 4149 4e54 4149  omment\\nMAINTAI
+00008320: 4e45 5220 2772 616d 626f 2720 2374 6869  NER 'rambo' #thi
+00008330: 7320 6973 206d 655c 5c6e 4e4f 4445 205c  s is me\\nNODE \
+00008340: 5c22 7465 7374 5f30 315c 5c22 5c5c 6e20  \"test_01\\"\\n 
+00008350: 2020 2044 4553 4352 4950 5449 4f4e 2074     DESCRIPTION t
+00008360: 6869 7320 6973 2061 206e 6f64 6520 7468  his is a node th
+00008370: 6174 2064 6f65 7320 7768 6174 6576 6572  at does whatever
+00008380: 5c5c 6e53 514c 203e 5c5c 6e5c 5c6e 2020  \\nSQL >\\n\\n  
+00008390: 2020 2020 2020 5345 4c45 4354 202a 2066        SELECT * f
+000083a0: 726f 6d20 7465 7374 5f30 305c 5c6e 5c5c  rom test_00\\n\\
+000083b0: 6e5c 5c6e 4e4f 4445 205c 5c22 7465 7374  n\\nNODE \\"test
+000083c0: 5f30 325c 5c22 5c5c 6e20 2020 2044 4553  _02\\"\\n    DES
+000083d0: 4352 4950 5449 4f4e 2074 6869 7320 6973  CRIPTION this is
+000083e0: 2061 206e 6f64 6520 7468 6174 2064 6f65   a node that doe
+000083f0: 7320 7768 6174 6576 6572 5c5c 6e53 514c  s whatever\\nSQL
+00008400: 203e 5c5c 6e5c 5c6e 2020 2020 5345 4c45   >\\n\\n    SELE
+00008410: 4354 202a 2066 726f 6d20 7465 7374 5f30  CT * from test_0
+00008420: 315c 5c6e 2020 2020 5748 4552 4520 6120  1\\n    WHERE a 
+00008430: 3e20 315c 5c6e 2020 2020 4752 4f55 5020  > 1\\n    GROUP 
+00008440: 6279 2061 5c5c 6e22 290a 2020 2020 3e3e  by a\\n").    >>
+00008450: 3e20 642e 6d61 696e 7461 696e 6572 0a20  > d.maintainer. 
+00008460: 2020 2027 7261 6d62 6f27 0a20 2020 203e     'rambo'.    >
+00008470: 3e3e 2064 2e73 6f75 7263 6573 0a20 2020  >> d.sources.   
+00008480: 205b 2768 7474 7073 3a2f 2f65 7861 6d70   ['https://examp
+00008490: 6c65 2e63 6f6d 275d 0a20 2020 203e 3e3e  le.com'].    >>>
+000084a0: 206c 656e 2864 2e6e 6f64 6573 290a 2020   len(d.nodes).  
+000084b0: 2020 320a 2020 2020 3e3e 3e20 642e 6e6f    2.    >>> d.no
+000084c0: 6465 735b 305d 0a20 2020 207b 276e 616d  des[0].    {'nam
+000084d0: 6527 3a20 2774 6573 745f 3031 272c 2027  e': 'test_01', '
+000084e0: 6465 7363 7269 7074 696f 6e27 3a20 2774  description': 't
+000084f0: 6869 7320 6973 2061 206e 6f64 6520 7468  his is a node th
+00008500: 6174 2064 6f65 7320 7768 6174 6576 6572  at does whatever
+00008510: 272c 2027 7371 6c27 3a20 2753 454c 4543  ', 'sql': 'SELEC
+00008520: 5420 2a20 6672 6f6d 2074 6573 745f 3030  T * from test_00
+00008530: 277d 0a20 2020 203e 3e3e 2064 2e6e 6f64  '}.    >>> d.nod
+00008540: 6573 5b31 5d0a 2020 2020 7b27 6e61 6d65  es[1].    {'name
+00008550: 273a 2027 7465 7374 5f30 3227 2c20 2764  ': 'test_02', 'd
+00008560: 6573 6372 6970 7469 6f6e 273a 2027 7468  escription': 'th
+00008570: 6973 2069 7320 6120 6e6f 6465 2074 6861  is is a node tha
+00008580: 7420 646f 6573 2077 6861 7465 7665 7227  t does whatever'
+00008590: 2c20 2773 716c 273a 2027 5345 4c45 4354  , 'sql': 'SELECT
+000085a0: 202a 2066 726f 6d20 7465 7374 5f30 315c   * from test_01\
+000085b0: 5c6e 5748 4552 4520 6120 3e20 315c 5c6e  \nWHERE a > 1\\n
+000085c0: 4752 4f55 5020 6279 2061 277d 0a20 2020  GROUP by a'}.   
+000085d0: 2022 2222 0a20 2020 206c 696e 6573 203d   """.    lines =
+000085e0: 206c 6973 7428 5374 7269 6e67 494f 2873   list(StringIO(s
+000085f0: 2c20 6e65 776c 696e 653d 4e6f 6e65 2929  , newline=None))
+00008600: 0a0a 2020 2020 646f 6320 3d20 4461 7461  ..    doc = Data
+00008610: 6669 6c65 2829 0a20 2020 2064 6f63 2e72  file().    doc.r
+00008620: 6177 203d 206c 6973 7428 5374 7269 6e67  aw = list(String
+00008630: 494f 2873 2c20 6e65 776c 696e 653d 4e6f  IO(s, newline=No
+00008640: 6e65 2929 0a0a 2020 2020 7061 7273 6572  ne))..    parser
+00008650: 5f73 7461 7465 203d 206e 616d 6564 7475  _state = namedtu
+00008660: 706c 6528 2270 6172 7365 725f 7374 6174  ple("parser_stat
+00008670: 6522 2c20 5b22 6d75 6c74 696c 696e 6522  e", ["multiline"
+00008680: 2c20 2263 7572 7265 6e74 5f6e 6f64 6522  , "current_node"
+00008690: 2c20 2263 6f6d 6d61 6e64 222c 2022 6d75  , "command", "mu
+000086a0: 6c74 696c 696e 655f 7374 7269 6e67 222c  ltiline_string",
+000086b0: 2022 6973 5f73 716c 225d 290a 0a20 2020   "is_sql"])..   
+000086c0: 2070 6172 7365 725f 7374 6174 652e 6d75   parser_state.mu
+000086d0: 6c74 696c 696e 6520 3d20 4661 6c73 650a  ltiline = False.
+000086e0: 2020 2020 7061 7273 6572 5f73 7461 7465      parser_state
+000086f0: 2e63 7572 7265 6e74 5f6e 6f64 6520 3d20  .current_node = 
+00008700: 4661 6c73 650a 0a20 2020 2064 6566 2061  False..    def a
+00008710: 7373 6967 6e28 6174 7472 293a 0a20 2020  ssign(attr):.   
+00008720: 2020 2020 2064 6566 205f 666e 2878 2c20       def _fn(x, 
+00008730: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00008740: 2020 2020 2020 2073 6574 6174 7472 2864         setattr(d
+00008750: 6f63 2c20 6174 7472 2c20 5f75 6e71 756f  oc, attr, _unquo
+00008760: 7465 2878 2929 0a0a 2020 2020 2020 2020  te(x))..        
+00008770: 7265 7475 726e 205f 666e 0a0a 2020 2020  return _fn..    
+00008780: 6465 6620 7363 6865 6d61 282a 6172 6773  def schema(*args
+00008790: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+000087a0: 2020 2020 2073 203d 205f 756e 7175 6f74       s = _unquot
+000087b0: 6528 2222 2e6a 6f69 6e28 6172 6773 2929  e("".join(args))
+000087c0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+000087d0: 2020 2020 2020 2020 2020 7368 203d 2070            sh = p
+000087e0: 6172 7365 5f74 6162 6c65 5f73 7472 7563  arse_table_struc
+000087f0: 7475 7265 2873 290a 2020 2020 2020 2020  ture(s).        
+00008800: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00008810: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00008820: 2020 2072 6169 7365 2050 6172 7365 4578     raise ParseEx
+00008830: 6365 7074 696f 6e28 4665 6564 6261 636b  ception(Feedback
+00008840: 4d61 6e61 6765 722e 6572 726f 725f 7061  Manager.error_pa
+00008850: 7273 696e 675f 7363 6865 6d61 286c 696e  rsing_schema(lin
+00008860: 653d 6b77 6172 6773 5b22 6c69 6e65 6e6f  e=kwargs["lineno
+00008870: 225d 2c20 6572 726f 723d 6529 290a 0a20  "], error=e)).. 
+00008880: 2020 2020 2020 2070 6172 7365 725f 7374         parser_st
+00008890: 6174 652e 6375 7272 656e 745f 6e6f 6465  ate.current_node
+000088a0: 5b22 7363 6865 6d61 225d 203d 2022 2c22  ["schema"] = ","
+000088b0: 2e6a 6f69 6e28 7363 6865 6d61 5f74 6f5f  .join(schema_to_
+000088c0: 7371 6c5f 636f 6c75 6d6e 7328 7368 2929  sql_columns(sh))
+000088d0: 0a20 2020 2020 2020 2070 6172 7365 725f  .        parser_
+000088e0: 7374 6174 652e 6375 7272 656e 745f 6e6f  state.current_no
+000088f0: 6465 5b22 636f 6c75 6d6e 7322 5d20 3d20  de["columns"] = 
+00008900: 7368 0a0a 2020 2020 6465 6620 696e 6465  sh..    def inde
+00008910: 7865 7328 2a61 7267 732c 202a 2a6b 7761  xes(*args, **kwa
+00008920: 7267 7329 3a0a 2020 2020 2020 2020 7320  rgs):.        s 
+00008930: 3d20 5f75 6e71 756f 7465 2822 222e 6a6f  = _unquote("".jo
+00008940: 696e 2861 7267 7329 290a 2020 2020 2020  in(args)).      
+00008950: 2020 6966 206e 6f74 2073 3a0a 2020 2020    if not s:.    
+00008960: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+00008970: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00008980: 2020 2020 2020 2020 696e 6465 7865 7320          indexes 
+00008990: 3d20 7061 7273 655f 696e 6465 7865 735f  = parse_indexes_
+000089a0: 7374 7275 6374 7572 6528 732e 7370 6c69  structure(s.spli
+000089b0: 746c 696e 6573 2829 290a 2020 2020 2020  tlines()).      
+000089c0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+000089d0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+000089e0: 2020 2020 2072 6169 7365 2050 6172 7365       raise Parse
+000089f0: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
+00008a00: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+00008a10: 7061 7273 696e 675f 696e 6469 6365 7328  parsing_indices(
+00008a20: 6c69 6e65 3d6b 7761 7267 735b 226c 696e  line=kwargs["lin
+00008a30: 656e 6f22 5d2c 2065 7272 6f72 3d65 2929  eno"], error=e))
+00008a40: 0a0a 2020 2020 2020 2020 7061 7273 6572  ..        parser
+00008a50: 5f73 7461 7465 2e63 7572 7265 6e74 5f6e  _state.current_n
+00008a60: 6f64 655b 2269 6e64 6578 6573 225d 203d  ode["indexes"] =
+00008a70: 2069 6e64 6578 6573 0a0a 2020 2020 6465   indexes..    de
+00008a80: 6620 6173 7369 676e 5f76 6172 2876 3a20  f assign_var(v: 
+00008a90: 7374 7229 202d 3e20 4361 6c6c 6162 6c65  str) -> Callable
+00008aa0: 5b5b 5661 7241 7267 2873 7472 292c 204b  [[VarArg(str), K
+00008ab0: 7741 7267 2841 6e79 295d 2c20 4e6f 6e65  wArg(Any)], None
+00008ac0: 5d3a 0a20 2020 2020 2020 2064 6566 205f  ]:.        def _
+00008ad0: 6628 2a61 7267 733a 2073 7472 2c20 2a2a  f(*args: str, **
+00008ae0: 6b77 6172 6773 3a20 416e 7929 3a0a 2020  kwargs: Any):.  
+00008af0: 2020 2020 2020 2020 2020 7320 3d20 5f75            s = _u
+00008b00: 6e71 756f 7465 2828 2220 222e 6a6f 696e  nquote((" ".join
+00008b10: 2861 7267 7329 292e 7374 7269 7028 2929  (args)).strip())
+00008b20: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
+00008b30: 7365 725f 7374 6174 652e 6375 7272 656e  ser_state.curren
+00008b40: 745f 6e6f 6465 5b76 2e6c 6f77 6572 2829  t_node[v.lower()
+00008b50: 5d20 3d20 6576 616c 5f76 6172 2873 2c20  ] = eval_var(s, 
+00008b60: 736b 6970 3d73 6b69 705f 6576 616c 290a  skip=skip_eval).
+00008b70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00008b80: 5f66 0a0a 2020 2020 6465 6620 736f 7572  _f..    def sour
+00008b90: 6365 7328 783a 2073 7472 2c20 2a2a 6b77  ces(x: str, **kw
+00008ba0: 6172 6773 3a20 416e 7929 202d 3e20 4e6f  args: Any) -> No
+00008bb0: 6e65 3a0a 2020 2020 2020 2020 646f 632e  ne:.        doc.
+00008bc0: 736f 7572 6365 732e 6170 7065 6e64 285f  sources.append(_
+00008bd0: 756e 7175 6f74 6528 7829 290a 0a20 2020  unquote(x))..   
+00008be0: 2064 6566 206e 6f64 6528 2a61 7267 733a   def node(*args:
+00008bf0: 2073 7472 2c20 2a2a 6b77 6172 6773 3a20   str, **kwargs: 
+00008c00: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
+00008c10: 2020 2020 2020 6e6f 6465 203d 207b 226e        node = {"n
+00008c20: 616d 6522 3a20 6576 616c 5f76 6172 285f  ame": eval_var(_
+00008c30: 756e 7175 6f74 6528 6172 6773 5b30 5d29  unquote(args[0])
+00008c40: 297d 0a20 2020 2020 2020 2064 6f63 2e6e  )}.        doc.n
+00008c50: 6f64 6573 2e61 7070 656e 6428 6e6f 6465  odes.append(node
+00008c60: 290a 2020 2020 2020 2020 7061 7273 6572  ).        parser
+00008c70: 5f73 7461 7465 2e63 7572 7265 6e74 5f6e  _state.current_n
+00008c80: 6f64 6520 3d20 6e6f 6465 0a0a 2020 2020  ode = node..    
+00008c90: 6465 6620 7363 6f70 6528 2a61 7267 733a  def scope(*args:
+00008ca0: 2073 7472 2c20 2a2a 6b77 6172 6773 3a20   str, **kwargs: 
+00008cb0: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
+00008cc0: 2020 2020 2020 7363 6f70 6520 3d20 7b22        scope = {"
+00008cd0: 6e61 6d65 223a 2065 7661 6c5f 7661 7228  name": eval_var(
+00008ce0: 5f75 6e71 756f 7465 2861 7267 735b 305d  _unquote(args[0]
+00008cf0: 2929 7d0a 2020 2020 2020 2020 646f 632e  ))}.        doc.
+00008d00: 6e6f 6465 732e 6170 7065 6e64 2873 636f  nodes.append(sco
+00008d10: 7065 290a 2020 2020 2020 2020 7061 7273  pe).        pars
+00008d20: 6572 5f73 7461 7465 2e63 7572 7265 6e74  er_state.current
+00008d30: 5f6e 6f64 6520 3d20 7363 6f70 650a 0a20  _node = scope.. 
+00008d40: 2020 2064 6566 2064 6573 6372 6970 7469     def descripti
+00008d50: 6f6e 282a 6172 6773 3a20 7374 722c 202a  on(*args: str, *
+00008d60: 2a6b 7761 7267 733a 2041 6e79 2920 2d3e  *kwargs: Any) ->
+00008d70: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
+00008d80: 6573 6372 6970 7469 6f6e 203d 2028 2220  escription = (" 
+00008d90: 222e 6a6f 696e 2861 7267 7329 292e 7374  ".join(args)).st
+00008da0: 7269 7028 290a 0a20 2020 2020 2020 2069  rip()..        i
+00008db0: 6620 7061 7273 6572 5f73 7461 7465 2e63  f parser_state.c
+00008dc0: 7572 7265 6e74 5f6e 6f64 653a 0a20 2020  urrent_node:.   
+00008dd0: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
+00008de0: 7374 6174 652e 6375 7272 656e 745f 6e6f  state.current_no
+00008df0: 6465 5b22 6465 7363 7269 7074 696f 6e22  de["description"
+00008e00: 5d20 3d20 6465 7363 7269 7074 696f 6e0a  ] = description.
+00008e10: 2020 2020 2020 2020 2020 2020 6966 2070              if p
+00008e20: 6172 7365 725f 7374 6174 652e 6375 7272  arser_state.curr
+00008e30: 656e 745f 6e6f 6465 2e67 6574 2822 6e61  ent_node.get("na
+00008e40: 6d65 222c 2022 2229 203d 3d20 2264 6566  me", "") == "def
+00008e50: 6175 6c74 223a 0a20 2020 2020 2020 2020  ault":.         
+00008e60: 2020 2020 2020 2064 6f63 2e64 6573 6372         doc.descr
+00008e70: 6970 7469 6f6e 203d 2064 6573 6372 6970  iption = descrip
+00008e80: 7469 6f6e 0a20 2020 2020 2020 2065 6c73  tion.        els
+00008e90: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+00008ea0: 6f63 2e64 6573 6372 6970 7469 6f6e 203d  oc.description =
+00008eb0: 2064 6573 6372 6970 7469 6f6e 0a0a 2020   description..  
+00008ec0: 2020 6465 6620 7371 6c28 7661 725f 6e61    def sql(var_na
+00008ed0: 6d65 3a20 7374 722c 202a 2a6b 7761 7267  me: str, **kwarg
+00008ee0: 733a 2041 6e79 2920 2d3e 2043 616c 6c61  s: Any) -> Calla
+00008ef0: 626c 655b 5b73 7472 2c20 4b77 4172 6728  ble[[str, KwArg(
+00008f00: 416e 7929 5d2c 204e 6f6e 655d 3a0a 2020  Any)], None]:.  
+00008f10: 2020 2020 2020 6465 6620 5f66 2873 716c        def _f(sql
+00008f20: 3a20 7374 722c 202a 2a6b 7761 7267 733a  : str, **kwargs:
+00008f30: 2041 6e79 2920 2d3e 204e 6f6e 653a 0a20   Any) -> None:. 
+00008f40: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00008f50: 7420 7061 7273 6572 5f73 7461 7465 2e63  t parser_state.c
+00008f60: 7572 7265 6e74 5f6e 6f64 653a 0a20 2020  urrent_node:.   
+00008f70: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00008f80: 7365 2050 6172 7365 4578 6365 7074 696f  se ParseExceptio
+00008f90: 6e28 2253 514c 206d 7573 7420 6265 2063  n("SQL must be c
+00008fa0: 616c 6c65 6420 6166 7465 7220 6120 4e4f  alled after a NO
+00008fb0: 4445 2063 6f6d 6d61 6e64 2229 0a20 2020  DE command").   
+00008fc0: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
+00008fd0: 7374 6174 652e 6375 7272 656e 745f 6e6f  state.current_no
+00008fe0: 6465 5b76 6172 5f6e 616d 655d 203d 2028  de[var_name] = (
+00008ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009000: 2074 6578 7477 7261 702e 6465 6465 6e74   textwrap.dedent
+00009010: 2873 716c 292e 7273 7472 6970 2829 2069  (sql).rstrip() i
+00009020: 6620 2225 2220 6e6f 7420 696e 2073 716c  f "%" not in sql
+00009030: 2e73 7472 6970 2829 5b30 5d20 656c 7365  .strip()[0] else
+00009040: 2073 716c 2e73 7472 6970 2829 0a20 2020   sql.strip().   
+00009050: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00009060: 2020 2020 2320 4841 434b 2074 6869 7320      # HACK this 
+00009070: 6361 7374 2069 7320 6e65 6564 6564 2062  cast is needed b
+00009080: 6563 6175 7365 204d 7970 790a 2020 2020  ecause Mypy.    
+00009090: 2020 2020 7265 7475 726e 2063 6173 7428      return cast(
+000090a0: 4361 6c6c 6162 6c65 5b5b 7374 722c 204b  Callable[[str, K
+000090b0: 7741 7267 2841 6e79 295d 2c20 4e6f 6e65  wArg(Any)], None
+000090c0: 5d2c 205f 6629 0a0a 2020 2020 6465 6620  ], _f)..    def 
+000090d0: 6173 7369 676e 5f6e 6f64 655f 7661 7228  assign_node_var(
+000090e0: 763a 2073 7472 2920 2d3e 2043 616c 6c61  v: str) -> Calla
+000090f0: 626c 655b 5b56 6172 4172 6728 7374 7229  ble[[VarArg(str)
+00009100: 2c20 4b77 4172 6728 416e 7929 5d2c 204e  , KwArg(Any)], N
+00009110: 6f6e 655d 3a0a 2020 2020 2020 2020 6465  one]:.        de
+00009120: 6620 5f66 282a 6172 6773 3a20 7374 722c  f _f(*args: str,
+00009130: 202a 2a6b 7761 7267 733a 2041 6e79 2920   **kwargs: Any) 
+00009140: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00009150: 2020 2020 2069 6620 6e6f 7420 7061 7273       if not pars
+00009160: 6572 5f73 7461 7465 2e63 7572 7265 6e74  er_state.current
+00009170: 5f6e 6f64 653a 0a20 2020 2020 2020 2020  _node:.         
+00009180: 2020 2020 2020 2072 6169 7365 2050 6172         raise Par
+00009190: 7365 4578 6365 7074 696f 6e28 2225 7320  seException("%s 
+000091a0: 6d75 7374 2062 6520 6361 6c6c 6564 2061  must be called a
+000091b0: 6674 6572 2061 204e 4f44 4520 636f 6d6d  fter a NODE comm
+000091c0: 616e 6422 2025 2076 290a 2020 2020 2020  and" % v).      
+000091d0: 2020 2020 2020 7265 7475 726e 2061 7373        return ass
+000091e0: 6967 6e5f 7661 7228 7629 282a 6172 6773  ign_var(v)(*args
+000091f0: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
+00009200: 2020 2020 2072 6574 7572 6e20 5f66 0a0a       return _f..
+00009210: 2020 2020 6465 6620 6164 645f 746f 6b65      def add_toke
+00009220: 6e28 2a61 7267 733a 2073 7472 2c20 2a2a  n(*args: str, **
+00009230: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
+00009240: 4e6f 6e65 3a20 2023 2074 6f6b 656e 5f6e  None:  # token_n
+00009250: 616d 652c 2070 6572 6d69 7373 696f 6e73  ame, permissions
+00009260: 293a 0a20 2020 2020 2020 2069 6620 6c65  ):.        if le
+00009270: 6e28 6172 6773 2920 3c20 323a 0a20 2020  n(args) < 2:.   
+00009280: 2020 2020 2020 2020 2072 6169 7365 2050           raise P
+00009290: 6172 7365 4578 6365 7074 696f 6e28 2754  arseException('T
+000092a0: 4f4b 454e 2067 6574 7320 7477 6f20 7061  OKEN gets two pa
+000092b0: 7261 6d73 2c20 746f 6b65 6e20 6e61 6d65  rams, token name
+000092c0: 2061 6e64 2070 6572 6d69 7373 696f 6e73   and permissions
+000092d0: 2065 2e67 2054 4f4b 454e 2022 7265 6164   e.g TOKEN "read
+000092e0: 2061 7069 2074 6f6b 656e 2220 5245 4144   api token" READ
+000092f0: 2729 0a20 2020 2020 2020 2064 6f63 2e74  ').        doc.t
+00009300: 6f6b 656e 732e 6170 7065 6e64 287b 2274  okens.append({"t
+00009310: 6f6b 656e 5f6e 616d 6522 3a20 5f75 6e71  oken_name": _unq
+00009320: 756f 7465 2861 7267 735b 305d 292c 2022  uote(args[0]), "
+00009330: 7065 726d 6973 7369 6f6e 7322 3a20 6172  permissions": ar
+00009340: 6773 5b31 5d7d 290a 0a20 2020 2064 6566  gs[1]})..    def
+00009350: 2061 6464 5f6b 6579 282a 6172 6773 3a20   add_key(*args: 
+00009360: 7374 722c 202a 2a6b 7761 7267 733a 2041  str, **kwargs: A
+00009370: 6e79 2920 2d3e 204e 6f6e 653a 2020 2320  ny) -> None:  # 
+00009380: 746f 6b65 6e5f 6e61 6d65 2c20 7065 726d  token_name, perm
+00009390: 6973 7369 6f6e 7329 3a0a 2020 2020 2020  issions):.      
+000093a0: 2020 6966 206c 656e 2861 7267 7329 203c    if len(args) <
+000093b0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+000093c0: 7261 6973 6520 5061 7273 6545 7863 6570  raise ParseExcep
+000093d0: 7469 6f6e 2822 4b45 5920 6765 7473 206f  tion("KEY gets o
+000093e0: 6e65 2070 6172 616d 7322 290a 2020 2020  ne params").    
+000093f0: 2020 2020 646f 632e 6b65 7973 2e61 7070      doc.keys.app
+00009400: 656e 6428 7b22 636f 6c75 6d6e 223a 205f  end({"column": _
+00009410: 756e 7175 6f74 6528 6172 6773 5b30 5d29  unquote(args[0])
+00009420: 7d29 0a0a 2020 2020 6465 6620 7465 7374  })..    def test
+00009430: 282a 6172 6773 3a20 7374 722c 202a 2a6b  (*args: str, **k
+00009440: 7761 7267 733a 2041 6e79 2920 2d3e 204e  wargs: Any) -> N
+00009450: 6f6e 653a 0a20 2020 2020 2020 2070 7269  one:.        pri
+00009460: 6e74 2822 7465 7374 222c 2061 7267 732c  nt("test", args,
+00009470: 206b 7761 7267 7329 0a0a 2020 2020 6465   kwargs)..    de
+00009480: 6620 696e 636c 7564 6528 2a61 7267 733a  f include(*args:
+00009490: 2073 7472 2c20 2a2a 6b77 6172 6773 3a20   str, **kwargs: 
+000094a0: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
+000094b0: 2020 2020 2020 6620 3d20 5f75 6e71 756f        f = _unquo
+000094c0: 7465 2861 7267 735b 305d 290a 2020 2020  te(args[0]).    
+000094d0: 2020 2020 6620 3d20 6576 616c 5f76 6172      f = eval_var
+000094e0: 2866 290a 2020 2020 2020 2020 6174 7472  (f).        attr
+000094f0: 7320 3d20 6469 6374 285f 756e 7175 6f74  s = dict(_unquot
+00009500: 6528 7829 2e73 706c 6974 2822 3d22 2c20  e(x).split("=", 
+00009510: 3129 2066 6f72 2078 2069 6e20 6172 6773  1) for x in args
+00009520: 5b31 3a5d 290a 2020 2020 2020 2020 6e6f  [1:]).        no
+00009530: 6e6c 6f63 616c 206c 696e 6573 0a20 2020  nlocal lines.   
+00009540: 2020 2020 206c 696e 656e 6f20 3d20 6b77       lineno = kw
+00009550: 6172 6773 5b22 6c69 6e65 6e6f 225d 0a20  args["lineno"]. 
+00009560: 2020 2020 2020 2072 6570 6c61 6365 5f69         replace_i
+00009570: 6e63 6c75 6465 7320 3d20 6b77 6172 6773  ncludes = kwargs
+00009580: 5b22 7265 706c 6163 655f 696e 636c 7564  ["replace_includ
+00009590: 6573 225d 0a20 2020 2020 2020 206e 203d  es"].        n =
+000095a0: 206c 696e 656e 6f0a 2020 2020 2020 2020   lineno.        
+000095b0: 6172 6773 5f77 6974 685f 6174 7472 7320  args_with_attrs 
+000095c0: 3d20 2220 222e 6a6f 696e 2861 7267 7329  = " ".join(args)
+000095d0: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+000095e0: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+000095f0: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
+00009600: 2020 2020 2020 206e 202b 3d20 310a 2020         n += 1.  
+00009610: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00009620: 206c 656e 286c 696e 6573 2920 3c3d 206e   len(lines) <= n
+00009630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009640: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
+00009650: 2020 2020 2020 2020 2020 2020 6966 2022              if "
+00009660: 4e4f 4445 2220 696e 206c 696e 6573 5b6e  NODE" in lines[n
+00009670: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+00009680: 2020 2020 2020 2064 6f63 2e69 6e63 6c75         doc.inclu
+00009690: 6465 735b 6172 6773 5f77 6974 685f 6174  des[args_with_at
+000096a0: 7472 735d 203d 206c 696e 6573 5b6e 5d0a  trs] = lines[n].
+000096b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000096c0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+000096d0: 2020 2020 2020 6966 2061 7267 735f 7769        if args_wi
+000096e0: 7468 5f61 7474 7273 206e 6f74 2069 6e20  th_attrs not in 
+000096f0: 646f 632e 696e 636c 7564 6573 3a0a 2020  doc.includes:.  
+00009700: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00009710: 632e 696e 636c 7564 6573 5b61 7267 735f  c.includes[args_
+00009720: 7769 7468 5f61 7474 7273 5d20 3d20 2222  with_attrs] = ""
+00009730: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00009740: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+00009750: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+00009760: 2020 2020 2023 2049 6620 7468 6973 2070       # If this p
+00009770: 6172 7365 2077 6173 2074 7269 6767 6572  arse was trigger
+00009780: 6564 2062 7920 666f 726d 6174 2c20 7765  ed by format, we
+00009790: 2064 6f6e 2774 2077 616e 7420 746f 2072   don't want to r
+000097a0: 6570 6c61 6365 2074 6865 2066 696c 650a  eplace the file.
+000097b0: 2020 2020 2020 2020 6966 206e 6f74 2072          if not r
+000097c0: 6570 6c61 6365 5f69 6e63 6c75 6465 733a  eplace_includes:
+000097d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000097e0: 7572 6e0a 0a20 2020 2020 2020 2023 2062  urn..        # b
+000097f0: 6520 7375 7265 2074 6f20 7265 706c 6163  e sure to replac
+00009800: 6520 7468 6520 696e 636c 7564 6520 6c69  e the include li
+00009810: 6e65 0a20 2020 2020 2020 2070 203d 2050  ne.        p = P
+00009820: 6174 6828 6261 7365 7061 7468 290a 0a20  ath(basepath).. 
+00009830: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00009840: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
+00009850: 6e28 7020 2f20 6629 2061 7320 6669 6c65  n(p / f) as file
+00009860: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009870: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00009880: 2020 2020 2020 2020 2020 206c 6c20 3d20             ll = 
+00009890: 6c69 7374 2853 7472 696e 6749 4f28 6669  list(StringIO(fi
+000098a0: 6c65 2e72 6561 6428 292c 206e 6577 6c69  le.read(), newli
+000098b0: 6e65 3d4e 6f6e 6529 290a 2020 2020 2020  ne=None)).      
+000098c0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+000098d0: 6465 5f6c 696e 6520 3d20 5b6c 696e 6520  de_line = [line 
+000098e0: 666f 7220 6c69 6e65 2069 6e20 6c6c 2069  for line in ll i
+000098f0: 6620 224e 4f44 4522 2069 6e20 6c69 6e65  f "NODE" in line
+00009900: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00009910: 2020 2020 2020 6966 206e 6f64 655f 6c69        if node_li
+00009920: 6e65 2061 6e64 2064 6f63 2e69 6e63 6c75  ne and doc.inclu
+00009930: 6465 735b 6172 6773 5f77 6974 685f 6174  des[args_with_at
+00009940: 7472 735d 3a0a 2020 2020 2020 2020 2020  trs]:.          
+00009950: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00009960: 632e 696e 636c 7564 6573 5b6e 6f64 655f  c.includes[node_
+00009970: 6c69 6e65 5b30 5d2e 7370 6c69 7428 224e  line[0].split("N
+00009980: 4f44 4522 295b 2d31 5d2e 7370 6c69 7428  ODE")[-1].split(
+00009990: 225c 6e22 295b 305d 2e73 7472 6970 2829  "\n")[0].strip()
+000099a0: 5d20 3d20 2222 0a20 2020 2020 2020 2020  ] = "".         
+000099b0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+000099c0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+000099d0: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+000099e0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000099f0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
+00009a00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009a10: 696c 652e 7365 656b 2830 290a 2020 2020  ile.seek(0).    
+00009a20: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+00009a30: 735b 6c69 6e65 6e6f 203a 206c 696e 656e  s[lineno : linen
+00009a40: 6f20 2b20 315d 203d 205b 2222 5d20 2b20  o + 1] = [""] + 
+00009a50: 6c69 7374 280a 2020 2020 2020 2020 2020  list(.          
+00009a60: 2020 2020 2020 2020 2020 5374 7269 6e67            String
+00009a70: 494f 2854 656d 706c 6174 6528 6669 6c65  IO(Template(file
+00009a80: 2e72 6561 6428 2929 2e73 6166 655f 7375  .read()).safe_su
+00009a90: 6273 7469 7475 7465 2861 7474 7273 292c  bstitute(attrs),
+00009aa0: 206e 6577 6c69 6e65 3d4e 6f6e 6529 0a20   newline=None). 
+00009ab0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00009ac0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00009ad0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+00009ae0: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
+00009af0: 6169 7365 2049 6e63 6c75 6465 4669 6c65  aise IncludeFile
+00009b00: 4e6f 7446 6f75 6e64 4578 6365 7074 696f  NotFoundExceptio
+00009b10: 6e28 6629 0a0a 2020 2020 6465 6620 7665  n(f)..    def ve
+00009b20: 7273 696f 6e28 2a61 7267 733a 2073 7472  rsion(*args: str
+00009b30: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
+00009b40: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00009b50: 2020 6966 206c 656e 2861 7267 7329 203c    if len(args) <
+00009b60: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00009b70: 7261 6973 6520 5061 7273 6545 7863 6570  raise ParseExcep
+00009b80: 7469 6f6e 2822 5645 5253 494f 4e20 6765  tion("VERSION ge
+00009b90: 7473 206f 6e65 2070 6f73 6974 6976 6520  ts one positive 
+00009ba0: 696e 7465 6765 7220 7061 7261 6d22 290a  integer param").
+00009bb0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00009bc0: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
+00009bd0: 203d 2069 6e74 2861 7267 735b 305d 290a   = int(args[0]).
+00009be0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+00009bf0: 6572 7369 6f6e 203c 2030 3a0a 2020 2020  ersion < 0:.    
+00009c00: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00009c10: 6520 5661 6c69 6461 7469 6f6e 4578 6365  e ValidationExce
+00009c20: 7074 696f 6e28 2276 6572 7369 6f6e 206d  ption("version m
+00009c30: 7573 7420 6265 2061 2070 6f73 6974 6976  ust be a positiv
+00009c40: 6520 696e 7465 6765 7220 652e 6720 5645  e integer e.g VE
+00009c50: 5253 494f 4e20 3222 290a 2020 2020 2020  RSION 2").      
+00009c60: 2020 2020 2020 646f 632e 7665 7273 696f        doc.versio
+00009c70: 6e20 3d20 7665 7273 696f 6e0a 2020 2020  n = version.    
+00009c80: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
+00009c90: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+00009ca0: 2020 2072 6169 7365 2056 616c 6964 6174     raise Validat
+00009cb0: 696f 6e45 7863 6570 7469 6f6e 2822 7665  ionException("ve
+00009cc0: 7273 696f 6e20 6d75 7374 2062 6520 6120  rsion must be a 
+00009cd0: 706f 7369 7469 7665 2069 6e74 6567 6572  positive integer
+00009ce0: 2065 2e67 2056 4552 5349 4f4e 2032 2229   e.g VERSION 2")
+00009cf0: 0a0a 2020 2020 6465 6620 7368 6172 6564  ..    def shared
+00009d00: 5f77 6974 6828 2a61 7267 733a 2073 7472  _with(*args: str
+00009d10: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
+00009d20: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00009d30: 2020 666f 7220 656e 7472 6965 7320 696e    for entries in
+00009d40: 2061 7267 733a 0a20 2020 2020 2020 2020   args:.         
+00009d50: 2020 2023 2049 6e20 6361 7365 2074 6865     # In case the
+00009d60: 7920 7370 6563 6966 7920 6d75 6c74 6970  y specify multip
+00009d70: 6c65 2077 6f72 6b73 7061 6365 730a 2020  le workspaces.  
+00009d80: 2020 2020 2020 2020 2020 646f 632e 7368            doc.sh
+00009d90: 6172 6564 5f77 6974 6820 2b3d 205b 776f  ared_with += [wo
+00009da0: 726b 7370 6163 652e 7374 7269 7028 2920  rkspace.strip() 
+00009db0: 666f 7220 776f 726b 7370 6163 6520 696e  for workspace in
+00009dc0: 2065 6e74 7269 6573 2e73 706c 6974 6c69   entries.splitli
+00009dd0: 6e65 7328 295d 0a0a 2020 2020 6465 6620  nes()]..    def 
+00009de0: 5f5f 696e 6974 5f65 6e67 696e 6528 763a  __init_engine(v:
+00009df0: 2073 7472 293a 0a20 2020 2020 2020 2069   str):.        i
+00009e00: 6620 6e6f 7420 7061 7273 6572 5f73 7461  f not parser_sta
+00009e10: 7465 2e63 7572 7265 6e74 5f6e 6f64 653a  te.current_node:
+00009e20: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00009e30: 7365 2045 7863 6570 7469 6f6e 2866 227b  se Exception(f"{
+00009e40: 767d 206d 7573 7420 6265 2063 616c 6c65  v} must be calle
+00009e50: 6420 6166 7465 7220 6120 4e4f 4445 2063  d after a NODE c
+00009e60: 6f6d 6d61 6e64 2229 0a20 2020 2020 2020  ommand").       
+00009e70: 2069 6620 2265 6e67 696e 6522 206e 6f74   if "engine" not
+00009e80: 2069 6e20 7061 7273 6572 5f73 7461 7465   in parser_state
+00009e90: 2e63 7572 7265 6e74 5f6e 6f64 653a 0a20  .current_node:. 
+00009ea0: 2020 2020 2020 2020 2020 2070 6172 7365             parse
+00009eb0: 725f 7374 6174 652e 6375 7272 656e 745f  r_state.current_
+00009ec0: 6e6f 6465 5b22 656e 6769 6e65 225d 203d  node["engine"] =
+00009ed0: 207b 2274 7970 6522 3a20 4e6f 6e65 2c20   {"type": None, 
+00009ee0: 2261 7267 7322 3a20 5b5d 7d0a 0a20 2020  "args": []}..   
+00009ef0: 2064 6566 2073 6574 5f65 6e67 696e 6528   def set_engine(
+00009f00: 2a61 7267 733a 2073 7472 2c20 2a2a 6b77  *args: str, **kw
+00009f10: 6172 6773 3a20 416e 7929 202d 3e20 4e6f  args: Any) -> No
+00009f20: 6e65 3a0a 2020 2020 2020 2020 5f5f 696e  ne:.        __in
+00009f30: 6974 5f65 6e67 696e 6528 2245 4e47 494e  it_engine("ENGIN
+00009f40: 4522 290a 2020 2020 2020 2020 656e 6769  E").        engi
+00009f50: 6e65 5f74 7970 6520 3d20 5f75 6e71 756f  ne_type = _unquo
+00009f60: 7465 2828 2220 222e 6a6f 696e 2861 7267  te((" ".join(arg
+00009f70: 7329 292e 7374 7269 7028 2929 0a20 2020  s)).strip()).   
+00009f80: 2020 2020 2070 6172 7365 725f 7374 6174       parser_stat
+00009f90: 652e 6375 7272 656e 745f 6e6f 6465 5b22  e.current_node["
+00009fa0: 656e 6769 6e65 225d 5b22 7479 7065 225d  engine"]["type"]
+00009fb0: 203d 2065 7661 6c5f 7661 7228 656e 6769   = eval_var(engi
+00009fc0: 6e65 5f74 7970 652c 2073 6b69 703d 736b  ne_type, skip=sk
+00009fd0: 6970 5f65 7661 6c29 0a0a 2020 2020 6465  ip_eval)..    de
+00009fe0: 6620 6164 645f 656e 6769 6e65 5f76 6172  f add_engine_var
+00009ff0: 2876 3a20 7374 7229 202d 3e20 4361 6c6c  (v: str) -> Call
+0000a000: 6162 6c65 5b5b 5661 7241 7267 2873 7472  able[[VarArg(str
+0000a010: 292c 204b 7741 7267 2841 6e79 295d 2c20  ), KwArg(Any)], 
+0000a020: 4e6f 6e65 5d3a 0a20 2020 2020 2020 2064  None]:.        d
+0000a030: 6566 205f 6628 2a61 7267 733a 2073 7472  ef _f(*args: str
+0000a040: 2c20 2a2a 6b77 6172 6773 3a20 416e 7929  , **kwargs: Any)
+0000a050: 3a0a 2020 2020 2020 2020 2020 2020 5f5f  :.            __
+0000a060: 696e 6974 5f65 6e67 696e 6528 6622 454e  init_engine(f"EN
+0000a070: 4749 4e45 5f7b 767d 222e 7570 7065 7228  GINE_{v}".upper(
+0000a080: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+0000a090: 6e67 696e 655f 6172 6720 3d20 6576 616c  ngine_arg = eval
+0000a0a0: 5f76 6172 285f 756e 7175 6f74 6528 2822  _var(_unquote(("
+0000a0b0: 2022 2e6a 6f69 6e28 6172 6773 2929 2e73   ".join(args)).s
+0000a0c0: 7472 6970 2829 292c 2073 6b69 703d 736b  trip()), skip=sk
+0000a0d0: 6970 5f65 7661 6c29 0a20 2020 2020 2020  ip_eval).       
+0000a0e0: 2020 2020 2070 6172 7365 725f 7374 6174       parser_stat
+0000a0f0: 652e 6375 7272 656e 745f 6e6f 6465 5b22  e.current_node["
+0000a100: 656e 6769 6e65 225d 5b22 6172 6773 225d  engine"]["args"]
+0000a110: 2e61 7070 656e 6428 2876 2c20 656e 6769  .append((v, engi
+0000a120: 6e65 5f61 7267 2929 0a0a 2020 2020 2020  ne_arg))..      
+0000a130: 2020 7265 7475 726e 205f 660a 0a20 2020    return _f..   
+0000a140: 2063 6d64 7320 3d20 7b0a 2020 2020 2020   cmds = {.      
+0000a150: 2020 2266 726f 6d22 3a20 6173 7369 676e    "from": assign
+0000a160: 2822 6672 6f6d 2229 2c0a 2020 2020 2020  ("from"),.      
+0000a170: 2020 2273 6f75 7263 6522 3a20 736f 7572    "source": sour
+0000a180: 6365 732c 0a20 2020 2020 2020 2022 6d61  ces,.        "ma
+0000a190: 696e 7461 696e 6572 223a 2061 7373 6967  intainer": assig
+0000a1a0: 6e28 226d 6169 6e74 6169 6e65 7222 292c  n("maintainer"),
+0000a1b0: 0a20 2020 2020 2020 2022 7363 6865 6d61  .        "schema
+0000a1c0: 223a 2073 6368 656d 612c 0a20 2020 2020  ": schema,.     
+0000a1d0: 2020 2022 696e 6465 7865 7322 3a20 696e     "indexes": in
+0000a1e0: 6465 7865 732c 0a20 2020 2020 2020 2023  dexes,.        #
+0000a1f0: 2054 4f44 4f3a 2041 6464 6564 2074 6f20   TODO: Added to 
+0000a200: 6265 2061 626c 6520 746f 206d 6572 6765  be able to merge
+0000a210: 204d 5220 3131 3334 372c 206c 6574 2773   MR 11347, let's
+0000a220: 2072 656d 6f76 6520 6974 2061 6674 6572   remove it after
+0000a230: 7761 7264 730a 2020 2020 2020 2020 2269  wards.        "i
+0000a240: 6e64 6963 6573 223a 2069 6e64 6578 6573  ndices": indexes
+0000a250: 2c0a 2020 2020 2020 2020 2265 6e67 696e  ,.        "engin
+0000a260: 6522 3a20 7365 745f 656e 6769 6e65 2c0a  e": set_engine,.
+0000a270: 2020 2020 2020 2020 2270 6172 7469 7469          "partiti
+0000a280: 6f6e 5f6b 6579 223a 2061 7373 6967 6e5f  on_key": assign_
+0000a290: 7661 7228 2270 6172 7469 7469 6f6e 5f6b  var("partition_k
+0000a2a0: 6579 2229 2c0a 2020 2020 2020 2020 2273  ey"),.        "s
+0000a2b0: 6f72 7469 6e67 5f6b 6579 223a 2061 7373  orting_key": ass
+0000a2c0: 6967 6e5f 7661 7228 2273 6f72 7469 6e67  ign_var("sorting
+0000a2d0: 5f6b 6579 2229 2c0a 2020 2020 2020 2020  _key"),.        
+0000a2e0: 2270 7269 6d61 7279 5f6b 6579 223a 2061  "primary_key": a
+0000a2f0: 7373 6967 6e5f 7661 7228 2270 7269 6d61  ssign_var("prima
+0000a300: 7279 5f6b 6579 2229 2c0a 2020 2020 2020  ry_key"),.      
+0000a310: 2020 2273 616d 706c 696e 675f 6b65 7922    "sampling_key"
+0000a320: 3a20 6173 7369 676e 5f76 6172 2822 7361  : assign_var("sa
+0000a330: 6d70 6c69 6e67 5f6b 6579 2229 2c0a 2020  mpling_key"),.  
+0000a340: 2020 2020 2020 2274 746c 223a 2061 7373        "ttl": ass
+0000a350: 6967 6e5f 7661 7228 2274 746c 2229 2c0a  ign_var("ttl"),.
+0000a360: 2020 2020 2020 2020 2273 6574 7469 6e67          "setting
+0000a370: 7322 3a20 6173 7369 676e 5f76 6172 2822  s": assign_var("
+0000a380: 7365 7474 696e 6773 2229 2c0a 2020 2020  settings"),.    
+0000a390: 2020 2020 226e 6f64 6522 3a20 6e6f 6465      "node": node
+0000a3a0: 2c0a 2020 2020 2020 2020 2273 636f 7065  ,.        "scope
+0000a3b0: 223a 2073 636f 7065 2c0a 2020 2020 2020  ": scope,.      
+0000a3c0: 2020 2264 6573 6372 6970 7469 6f6e 223a    "description":
+0000a3d0: 2064 6573 6372 6970 7469 6f6e 2c0a 2020   description,.  
+0000a3e0: 2020 2020 2020 2274 7970 6522 3a20 6173        "type": as
+0000a3f0: 7369 676e 5f6e 6f64 655f 7661 7228 2274  sign_node_var("t
+0000a400: 7970 6522 292c 0a20 2020 2020 2020 2022  ype"),.        "
+0000a410: 6461 7461 736f 7572 6365 223a 2061 7373  datasource": ass
+0000a420: 6967 6e5f 6e6f 6465 5f76 6172 2822 6461  ign_node_var("da
+0000a430: 7461 736f 7572 6365 2229 2c0a 2020 2020  tasource"),.    
+0000a440: 2020 2020 2274 6167 7322 3a20 6173 7369      "tags": assi
+0000a450: 676e 5f6e 6f64 655f 7661 7228 2274 6167  gn_node_var("tag
+0000a460: 7322 292c 0a20 2020 2020 2020 2022 7461  s"),.        "ta
+0000a470: 7267 6574 5f64 6174 6173 6f75 7263 6522  rget_datasource"
+0000a480: 3a20 6173 7369 676e 5f6e 6f64 655f 7661  : assign_node_va
+0000a490: 7228 2274 6172 6765 745f 6461 7461 736f  r("target_dataso
+0000a4a0: 7572 6365 2229 2c0a 2020 2020 2020 2020  urce"),.        
+0000a4b0: 2263 6f70 795f 7363 6865 6475 6c65 223a  "copy_schedule":
+0000a4c0: 2061 7373 6967 6e5f 6e6f 6465 5f76 6172   assign_node_var
+0000a4d0: 2843 6f70 7950 6172 616d 6574 6572 732e  (CopyParameters.
+0000a4e0: 434f 5059 5f53 4348 4544 554c 4529 2c0a  COPY_SCHEDULE),.
+0000a4f0: 2020 2020 2020 2020 2272 6573 6f75 7263          "resourc
+0000a500: 6522 3a20 6173 7369 676e 5f6e 6f64 655f  e": assign_node_
+0000a510: 7661 7228 2272 6573 6f75 7263 6522 292c  var("resource"),
+0000a520: 0a20 2020 2020 2020 2022 6669 6c74 6572  .        "filter
+0000a530: 223a 2061 7373 6967 6e5f 6e6f 6465 5f76  ": assign_node_v
+0000a540: 6172 2822 6669 6c74 6572 2229 2c0a 2020  ar("filter"),.  
+0000a550: 2020 2020 2020 2274 6f6b 656e 223a 2061        "token": a
+0000a560: 6464 5f74 6f6b 656e 2c0a 2020 2020 2020  dd_token,.      
+0000a570: 2020 226b 6579 223a 2061 6464 5f6b 6579    "key": add_key
+0000a580: 2c0a 2020 2020 2020 2020 2274 6573 7422  ,.        "test"
+0000a590: 3a20 7465 7374 2c0a 2020 2020 2020 2020  : test,.        
+0000a5a0: 2269 6e63 6c75 6465 223a 2069 6e63 6c75  "include": inclu
+0000a5b0: 6465 2c0a 2020 2020 2020 2020 2273 716c  de,.        "sql
+0000a5c0: 223a 2073 716c 2822 7371 6c22 292c 0a20  ": sql("sql"),. 
+0000a5d0: 2020 2020 2020 2022 7665 7273 696f 6e22         "version"
+0000a5e0: 3a20 7665 7273 696f 6e2c 0a20 2020 2020  : version,.     
+0000a5f0: 2020 2022 6b61 666b 615f 636f 6e6e 6563     "kafka_connec
+0000a600: 7469 6f6e 5f6e 616d 6522 3a20 6173 7369  tion_name": assi
+0000a610: 676e 5f76 6172 2822 6b61 666b 615f 636f  gn_var("kafka_co
+0000a620: 6e6e 6563 7469 6f6e 5f6e 616d 6522 292c  nnection_name"),
+0000a630: 0a20 2020 2020 2020 2022 6b61 666b 615f  .        "kafka_
+0000a640: 746f 7069 6322 3a20 6173 7369 676e 5f76  topic": assign_v
+0000a650: 6172 2822 6b61 666b 615f 746f 7069 6322  ar("kafka_topic"
+0000a660: 292c 0a20 2020 2020 2020 2022 6b61 666b  ),.        "kafk
+0000a670: 615f 6772 6f75 705f 6964 223a 2061 7373  a_group_id": ass
+0000a680: 6967 6e5f 7661 7228 226b 6166 6b61 5f67  ign_var("kafka_g
+0000a690: 726f 7570 5f69 6422 292c 0a20 2020 2020  roup_id"),.     
+0000a6a0: 2020 2022 6b61 666b 615f 626f 6f74 7374     "kafka_bootst
+0000a6b0: 7261 705f 7365 7276 6572 7322 3a20 6173  rap_servers": as
+0000a6c0: 7369 676e 5f76 6172 2822 6b61 666b 615f  sign_var("kafka_
+0000a6d0: 626f 6f74 7374 7261 705f 7365 7276 6572  bootstrap_server
+0000a6e0: 7322 292c 0a20 2020 2020 2020 2022 6b61  s"),.        "ka
+0000a6f0: 666b 615f 6b65 7922 3a20 6173 7369 676e  fka_key": assign
+0000a700: 5f76 6172 2822 6b61 666b 615f 6b65 7922  _var("kafka_key"
+0000a710: 292c 0a20 2020 2020 2020 2022 6b61 666b  ),.        "kafk
+0000a720: 615f 7365 6372 6574 223a 2061 7373 6967  a_secret": assig
+0000a730: 6e5f 7661 7228 226b 6166 6b61 5f73 6563  n_var("kafka_sec
+0000a740: 7265 7422 292c 0a20 2020 2020 2020 2022  ret"),.        "
+0000a750: 6b61 666b 615f 7363 6865 6d61 5f72 6567  kafka_schema_reg
+0000a760: 6973 7472 795f 7572 6c22 3a20 6173 7369  istry_url": assi
+0000a770: 676e 5f76 6172 2822 6b61 666b 615f 7363  gn_var("kafka_sc
+0000a780: 6865 6d61 5f72 6567 6973 7472 795f 7572  hema_registry_ur
+0000a790: 6c22 292c 0a20 2020 2020 2020 2022 6b61  l"),.        "ka
+0000a7a0: 666b 615f 7461 7267 6574 5f70 6172 7469  fka_target_parti
+0000a7b0: 7469 6f6e 7322 3a20 6173 7369 676e 5f76  tions": assign_v
+0000a7c0: 6172 2822 6b61 666b 615f 7461 7267 6574  ar("kafka_target
+0000a7d0: 5f70 6172 7469 7469 6f6e 7322 292c 0a20  _partitions"),. 
+0000a7e0: 2020 2020 2020 2022 6b61 666b 615f 6175         "kafka_au
+0000a7f0: 746f 5f6f 6666 7365 745f 7265 7365 7422  to_offset_reset"
+0000a800: 3a20 6173 7369 676e 5f76 6172 2822 6b61  : assign_var("ka
+0000a810: 666b 615f 6175 746f 5f6f 6666 7365 745f  fka_auto_offset_
+0000a820: 7265 7365 7422 292c 0a20 2020 2020 2020  reset"),.       
+0000a830: 2022 6b61 666b 615f 7374 6f72 655f 7261   "kafka_store_ra
+0000a840: 775f 7661 6c75 6522 3a20 6173 7369 676e  w_value": assign
+0000a850: 5f76 6172 2822 6b61 666b 615f 7374 6f72  _var("kafka_stor
+0000a860: 655f 7261 775f 7661 6c75 6522 292c 0a20  e_raw_value"),. 
+0000a870: 2020 2020 2020 2022 6b61 666b 615f 7374         "kafka_st
+0000a880: 6f72 655f 6865 6164 6572 7322 3a20 6173  ore_headers": as
+0000a890: 7369 676e 5f76 6172 2822 6b61 666b 615f  sign_var("kafka_
+0000a8a0: 7374 6f72 655f 6865 6164 6572 7322 292c  store_headers"),
+0000a8b0: 0a20 2020 2020 2020 2022 6b61 666b 615f  .        "kafka_
+0000a8c0: 6b65 795f 6176 726f 5f64 6573 6572 6961  key_avro_deseria
+0000a8d0: 6c69 7a61 7469 6f6e 223a 2061 7373 6967  lization": assig
+0000a8e0: 6e5f 7661 7228 226b 6166 6b61 5f6b 6579  n_var("kafka_key
+0000a8f0: 5f61 7672 6f5f 6465 7365 7269 616c 697a  _avro_deserializ
+0000a900: 6174 696f 6e22 292c 0a20 2020 2020 2020  ation"),.       
+0000a910: 2022 696d 706f 7274 5f73 6572 7669 6365   "import_service
+0000a920: 223a 2061 7373 6967 6e5f 7661 7228 2269  ": assign_var("i
+0000a930: 6d70 6f72 745f 7365 7276 6963 6522 292c  mport_service"),
+0000a940: 0a20 2020 2020 2020 2022 696d 706f 7274  .        "import
+0000a950: 5f63 6f6e 6e65 6374 696f 6e5f 6e61 6d65  _connection_name
+0000a960: 223a 2061 7373 6967 6e5f 7661 7228 2269  ": assign_var("i
+0000a970: 6d70 6f72 745f 636f 6e6e 6563 7469 6f6e  mport_connection
+0000a980: 5f6e 616d 6522 292c 0a20 2020 2020 2020  _name"),.       
+0000a990: 2022 696d 706f 7274 5f73 6368 6564 756c   "import_schedul
+0000a9a0: 6522 3a20 6173 7369 676e 5f76 6172 2822  e": assign_var("
+0000a9b0: 696d 706f 7274 5f73 6368 6564 756c 6522  import_schedule"
+0000a9c0: 292c 0a20 2020 2020 2020 2022 696d 706f  ),.        "impo
+0000a9d0: 7274 5f73 7472 6174 6567 7922 3a20 6173  rt_strategy": as
+0000a9e0: 7369 676e 5f76 6172 2822 696d 706f 7274  sign_var("import
+0000a9f0: 5f73 7472 6174 6567 7922 292c 0a20 2020  _strategy"),.   
+0000aa00: 2020 2020 2022 696d 706f 7274 5f65 7874       "import_ext
+0000aa10: 6572 6e61 6c5f 6461 7461 736f 7572 6365  ernal_datasource
+0000aa20: 223a 2061 7373 6967 6e5f 7661 7228 2269  ": assign_var("i
+0000aa30: 6d70 6f72 745f 6578 7465 726e 616c 5f64  mport_external_d
+0000aa40: 6174 6173 6f75 7263 6522 292c 0a20 2020  atasource"),.   
+0000aa50: 2020 2020 2022 696d 706f 7274 5f62 7563       "import_buc
+0000aa60: 6b65 745f 7572 6922 3a20 6173 7369 676e  ket_uri": assign
+0000aa70: 5f76 6172 2822 696d 706f 7274 5f62 7563  _var("import_buc
+0000aa80: 6b65 745f 7572 6922 292c 0a20 2020 2020  ket_uri"),.     
+0000aa90: 2020 2022 696d 706f 7274 5f71 7565 7279     "import_query
+0000aaa0: 223a 2061 7373 6967 6e5f 7661 7228 2269  ": assign_var("i
+0000aab0: 6d70 6f72 745f 7175 6572 7922 292c 0a20  mport_query"),. 
+0000aac0: 2020 2020 2020 2022 7368 6172 6564 5f77         "shared_w
+0000aad0: 6974 6822 3a20 7368 6172 6564 5f77 6974  ith": shared_wit
+0000aae0: 682c 0a20 2020 2020 2020 2022 6578 706f  h,.        "expo
+0000aaf0: 7274 5f73 6572 7669 6365 223a 2061 7373  rt_service": ass
+0000ab00: 6967 6e5f 7661 7228 2265 7870 6f72 745f  ign_var("export_
+0000ab10: 7365 7276 6963 6522 292c 0a20 2020 2020  service"),.     
+0000ab20: 2020 2022 6578 706f 7274 5f63 6f6e 6e65     "export_conne
+0000ab30: 6374 696f 6e5f 6e61 6d65 223a 2061 7373  ction_name": ass
+0000ab40: 6967 6e5f 7661 7228 2265 7870 6f72 745f  ign_var("export_
+0000ab50: 636f 6e6e 6563 7469 6f6e 5f6e 616d 6522  connection_name"
+0000ab60: 292c 0a20 2020 2020 2020 2022 6578 706f  ),.        "expo
+0000ab70: 7274 5f73 6368 6564 756c 6522 3a20 6173  rt_schedule": as
+0000ab80: 7369 676e 5f76 6172 2822 6578 706f 7274  sign_var("export
+0000ab90: 5f73 6368 6564 756c 6522 292c 0a20 2020  _schedule"),.   
+0000aba0: 2020 2020 2022 6578 706f 7274 5f62 7563       "export_buc
+0000abb0: 6b65 745f 7572 6922 3a20 6173 7369 676e  ket_uri": assign
+0000abc0: 5f76 6172 2822 6578 706f 7274 5f62 7563  _var("export_buc
+0000abd0: 6b65 745f 7572 6922 292c 0a20 2020 2020  ket_uri"),.     
+0000abe0: 2020 2022 6578 706f 7274 5f66 696c 655f     "export_file_
+0000abf0: 7465 6d70 6c61 7465 223a 2061 7373 6967  template": assig
+0000ac00: 6e5f 7661 7228 2265 7870 6f72 745f 6669  n_var("export_fi
+0000ac10: 6c65 5f74 656d 706c 6174 6522 292c 0a20  le_template"),. 
+0000ac20: 2020 2020 2020 2022 6578 706f 7274 5f66         "export_f
+0000ac30: 6f72 6d61 7422 3a20 6173 7369 676e 5f76  ormat": assign_v
+0000ac40: 6172 2822 6578 706f 7274 5f66 6f72 6d61  ar("export_forma
+0000ac50: 7422 292c 0a20 2020 2020 2020 2022 6578  t"),.        "ex
+0000ac60: 706f 7274 5f73 7472 6174 6567 7922 3a20  port_strategy": 
+0000ac70: 6173 7369 676e 5f76 6172 2822 6578 706f  assign_var("expo
+0000ac80: 7274 5f73 7472 6174 6567 7922 292c 0a20  rt_strategy"),. 
+0000ac90: 2020 2020 2020 2022 6578 706f 7274 5f63         "export_c
+0000aca0: 6f6d 7072 6573 7369 6f6e 223a 2061 7373  ompression": ass
+0000acb0: 6967 6e5f 7661 7228 2265 7870 6f72 745f  ign_var("export_
+0000acc0: 636f 6d70 7265 7373 696f 6e22 292c 0a20  compression"),. 
+0000acd0: 2020 207d 0a0a 2020 2020 656e 6769 6e65     }..    engine
+0000ace0: 5f76 6172 7320 3d20 7365 7428 290a 0a20  _vars = set().. 
+0000acf0: 2020 2066 6f72 205f 656e 6769 6e65 2c20     for _engine, 
+0000ad00: 2870 6172 616d 732c 206f 7074 696f 6e73  (params, options
+0000ad10: 2920 696e 2045 4e41 424c 4544 5f45 4e47  ) in ENABLED_ENG
+0000ad20: 494e 4553 3a0a 2020 2020 2020 2020 666f  INES:.        fo
+0000ad30: 7220 7020 696e 2070 6172 616d 733a 0a20  r p in params:. 
+0000ad40: 2020 2020 2020 2020 2020 2065 6e67 696e             engin
+0000ad50: 655f 7661 7273 2e61 6464 2870 2e6e 616d  e_vars.add(p.nam
+0000ad60: 6529 0a20 2020 2020 2020 2066 6f72 206f  e).        for o
+0000ad70: 2069 6e20 6f70 7469 6f6e 733a 0a20 2020   in options:.   
+0000ad80: 2020 2020 2020 2020 2065 6e67 696e 655f           engine_
+0000ad90: 7661 7273 2e61 6464 286f 2e6e 616d 6529  vars.add(o.name)
+0000ada0: 0a20 2020 2066 6f72 2076 2069 6e20 656e  .    for v in en
+0000adb0: 6769 6e65 5f76 6172 733a 0a20 2020 2020  gine_vars:.     
+0000adc0: 2020 2063 6d64 735b 6622 656e 6769 6e65     cmds[f"engine
+0000add0: 5f7b 767d 225d 203d 2061 6464 5f65 6e67  _{v}"] = add_eng
+0000ade0: 696e 655f 7661 7228 7629 0a0a 2020 2020  ine_var(v)..    
+0000adf0: 6966 2064 6566 6175 6c74 5f6e 6f64 653a  if default_node:
+0000ae00: 0a20 2020 2020 2020 206e 6f64 6528 6465  .        node(de
+0000ae10: 6661 756c 745f 6e6f 6465 290a 0a20 2020  fault_node)..   
+0000ae20: 206c 696e 656e 6f20 3d20 300a 2020 2020   lineno = 0.    
+0000ae30: 7472 793a 0a20 2020 2020 2020 2077 6869  try:.        whi
+0000ae40: 6c65 206c 696e 656e 6f20 3c20 6c65 6e28  le lineno < len(
+0000ae50: 6c69 6e65 7329 3a0a 2020 2020 2020 2020  lines):.        
+0000ae60: 2020 2020 6c69 6e65 203d 206c 696e 6573      line = lines
+0000ae70: 5b6c 696e 656e 6f5d 0a20 2020 2020 2020  [lineno].       
+0000ae80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000ae90: 2020 2020 2020 2020 2020 7361 203d 2073            sa = s
+0000aea0: 686c 6578 2e73 686c 6578 286c 696e 6529  hlex.shlex(line)
+0000aeb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000aec0: 2073 612e 7768 6974 6573 7061 6365 5f73   sa.whitespace_s
+0000aed0: 706c 6974 203d 2054 7275 650a 2020 2020  plit = True.    
+0000aee0: 2020 2020 2020 2020 2020 2020 6c65 7865              lexe
+0000aef0: 7220 3d20 6c69 7374 2873 6129 0a20 2020  r = list(sa).   
+0000af00: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0000af10: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
+0000af20: 2020 2020 2020 2020 2020 2020 7361 203d              sa =
+0000af30: 2073 686c 6578 2e73 686c 6578 2873 686c   shlex.shlex(shl
+0000af40: 6578 2e71 756f 7465 286c 696e 6529 290a  ex.quote(line)).
+0000af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af60: 7361 2e77 6869 7465 7370 6163 655f 7370  sa.whitespace_sp
+0000af70: 6c69 7420 3d20 5472 7565 0a20 2020 2020  lit = True.     
+0000af80: 2020 2020 2020 2020 2020 206c 6578 6572             lexer
+0000af90: 203d 206c 6973 7428 7361 290a 2020 2020   = list(sa).    
+0000afa0: 2020 2020 2020 2020 6966 206c 6578 6572          if lexer
+0000afb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000afc0: 2020 636d 642c 2061 7267 7320 3d20 6c65    cmd, args = le
+0000afd0: 7865 725b 305d 2c20 6c65 7865 725b 313a  xer[0], lexer[1:
+0000afe0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0000aff0: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
+0000b000: 2020 2020 2020 2020 2020 2070 6172 7365             parse
+0000b010: 725f 7374 6174 652e 6d75 6c74 696c 696e  r_state.multilin
+0000b020: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000b030: 2020 2020 2020 616e 6420 636d 642e 6c6f        and cmd.lo
+0000b040: 7765 7228 2920 696e 2063 6d64 730a 2020  wer() in cmds.  
+0000b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b060: 2020 616e 6420 6e6f 7420 286c 696e 652e    and not (line.
+0000b070: 7374 6172 7473 7769 7468 2822 2022 2920  startswith(" ") 
+0000b080: 6f72 206c 696e 652e 7374 6172 7473 7769  or line.startswi
+0000b090: 7468 2822 5c74 2229 206f 7220 6c69 6e65  th("\t") or line
+0000b0a0: 2e6c 6f77 6572 2829 2e73 7461 7274 7377  .lower().startsw
+0000b0b0: 6974 6828 2266 726f 6d22 2929 0a20 2020  ith("from")).   
+0000b0c0: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+0000b0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0e0: 2020 2020 7061 7273 6572 5f73 7461 7465      parser_state
+0000b0f0: 2e6d 756c 7469 6c69 6e65 203d 2046 616c  .multiline = Fal
+0000b100: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+0000b110: 2020 2020 2020 2063 6d64 735b 7061 7273         cmds[pars
+0000b120: 6572 5f73 7461 7465 2e63 6f6d 6d61 6e64  er_state.command
+0000b130: 5d28 0a20 2020 2020 2020 2020 2020 2020  ](.             
+0000b140: 2020 2020 2020 2020 2020 2070 6172 7365             parse
+0000b150: 725f 7374 6174 652e 6d75 6c74 696c 696e  r_state.multilin
+0000b160: 655f 7374 7269 6e67 2c20 6c69 6e65 6e6f  e_string, lineno
+0000b170: 3d6c 696e 656e 6f2c 2072 6570 6c61 6365  =lineno, replace
+0000b180: 5f69 6e63 6c75 6465 733d 7265 706c 6163  _includes=replac
+0000b190: 655f 696e 636c 7564 6573 0a20 2020 2020  e_includes.     
+0000b1a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000b1b0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000b1c0: 2020 6966 206e 6f74 2070 6172 7365 725f    if not parser_
+0000b1d0: 7374 6174 652e 6d75 6c74 696c 696e 653a  state.multiline:
+0000b1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b1f0: 2020 2020 2069 6620 6c65 6e28 6172 6773       if len(args
+0000b200: 2920 3e3d 2031 2061 6e64 2061 7267 735b  ) >= 1 and args[
+0000b210: 305d 203d 3d20 223e 223a 0a20 2020 2020  0] == ">":.     
+0000b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b230: 2020 2070 6172 7365 725f 7374 6174 652e     parser_state.
+0000b240: 6d75 6c74 696c 696e 6520 3d20 5472 7565  multiline = True
+0000b250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b260: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
+0000b270: 7374 6174 652e 636f 6d6d 616e 6420 3d20  state.command = 
+0000b280: 636d 642e 6c6f 7765 7228 290a 2020 2020  cmd.lower().    
+0000b290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b2a0: 2020 2020 7061 7273 6572 5f73 7461 7465      parser_state
+0000b2b0: 2e6d 756c 7469 6c69 6e65 5f73 7472 696e  .multiline_strin
+0000b2c0: 6720 3d20 2222 0a20 2020 2020 2020 2020  g = "".         
+0000b2d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000b2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b2f0: 2020 2020 2020 2020 2069 6620 636d 642e           if cmd.
+0000b300: 6c6f 7765 7228 2920 696e 2063 6d64 733a  lower() in cmds:
+0000b310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b320: 2020 2020 2020 2020 2020 2020 2063 6d64               cmd
+0000b330: 735b 636d 642e 6c6f 7765 7228 295d 282a  s[cmd.lower()](*
+0000b340: 6172 6773 2c20 6c69 6e65 6e6f 3d6c 696e  args, lineno=lin
+0000b350: 656e 6f2c 2072 6570 6c61 6365 5f69 6e63  eno, replace_inc
+0000b360: 6c75 6465 733d 7265 706c 6163 655f 696e  ludes=replace_in
+0000b370: 636c 7564 6573 290a 2020 2020 2020 2020  cludes).        
+0000b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b390: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3b0: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+0000b3c0: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
+0000b3d0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+0000b3e0: 6f72 5f6f 7074 696f 6e28 6f70 7469 6f6e  or_option(option
+0000b3f0: 3d63 6d64 2e75 7070 6572 2829 2929 0a20  =cmd.upper())). 
+0000b400: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000b410: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000b420: 2020 2020 2020 2020 2070 6172 7365 725f           parser_
+0000b430: 7374 6174 652e 6d75 6c74 696c 696e 655f  state.multiline_
+0000b440: 7374 7269 6e67 202b 3d20 6c69 6e65 0a20  string += line. 
+0000b450: 2020 2020 2020 2020 2020 206c 696e 656e             linen
+0000b460: 6f20 2b3d 2031 0a20 2020 2020 2020 2023  o += 1.        #
+0000b470: 2063 6c6f 7365 2066 696e 616c 2073 7461   close final sta
+0000b480: 7465 0a20 2020 2020 2020 2069 6620 7061  te.        if pa
+0000b490: 7273 6572 5f73 7461 7465 2e6d 756c 7469  rser_state.multi
+0000b4a0: 6c69 6e65 3a0a 2020 2020 2020 2020 2020  line:.          
+0000b4b0: 2020 636d 6473 5b70 6172 7365 725f 7374    cmds[parser_st
+0000b4c0: 6174 652e 636f 6d6d 616e 645d 2870 6172  ate.command](par
+0000b4d0: 7365 725f 7374 6174 652e 6d75 6c74 696c  ser_state.multil
+0000b4e0: 696e 655f 7374 7269 6e67 2c20 6c69 6e65  ine_string, line
+0000b4f0: 6e6f 3d6c 696e 656e 6f2c 2072 6570 6c61  no=lineno, repla
+0000b500: 6365 5f69 6e63 6c75 6465 733d 7265 706c  ce_includes=repl
+0000b510: 6163 655f 696e 636c 7564 6573 290a 2020  ace_includes).  
+0000b520: 2020 6578 6365 7074 2050 6172 7365 4578    except ParseEx
+0000b530: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+0000b540: 2020 2020 2020 7261 6973 6520 5061 7273        raise Pars
+0000b550: 6545 7863 6570 7469 6f6e 2873 7472 2865  eException(str(e
+0000b560: 292c 206c 696e 656e 6f3d 6c69 6e65 6e6f  ), lineno=lineno
+0000b570: 290a 2020 2020 6578 6365 7074 2056 616c  ).    except Val
+0000b580: 6964 6174 696f 6e45 7863 6570 7469 6f6e  idationException
+0000b590: 2061 7320 653a 0a20 2020 2020 2020 2072   as e:.        r
+0000b5a0: 6169 7365 2056 616c 6964 6174 696f 6e45  aise ValidationE
+0000b5b0: 7863 6570 7469 6f6e 2873 7472 2865 292c  xception(str(e),
+0000b5c0: 206c 696e 656e 6f3d 6c69 6e65 6e6f 290a   lineno=lineno).
+0000b5d0: 2020 2020 6578 6365 7074 2049 6e64 6578      except Index
+0000b5e0: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
+0000b5f0: 2020 2020 6966 2022 6e6f 6465 2220 696e      if "node" in
+0000b600: 206c 696e 652e 6c6f 7765 7228 293a 0a20   line.lower():. 
+0000b610: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000b620: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
+0000b630: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+0000b640: 6e61 6765 722e 6572 726f 725f 6d69 7373  nager.error_miss
+0000b650: 696e 675f 6e6f 6465 5f6e 616d 6528 2929  ing_node_name())
+0000b660: 0a20 2020 2020 2020 2065 6c69 6620 2273  .        elif "s
+0000b670: 716c 2220 696e 206c 696e 652e 6c6f 7765  ql" in line.lowe
+0000b680: 7228 293a 0a20 2020 2020 2020 2020 2020  r():.           
+0000b690: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+0000b6a0: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
+0000b6b0: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+0000b6c0: 725f 6d69 7373 696e 675f 7371 6c5f 636f  r_missing_sql_co
+0000b6d0: 6d6d 616e 6428 2929 0a20 2020 2020 2020  mmand()).       
+0000b6e0: 2065 6c69 6620 2264 6174 6173 6f75 7263   elif "datasourc
+0000b6f0: 6522 2069 6e20 6c69 6e65 2e6c 6f77 6572  e" in line.lower
+0000b700: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0000b710: 7261 6973 6520 636c 6963 6b2e 436c 6963  raise click.Clic
+0000b720: 6b45 7863 6570 7469 6f6e 2846 6565 6462  kException(Feedb
+0000b730: 6163 6b4d 616e 6167 6572 2e65 7272 6f72  ackManager.error
+0000b740: 5f6d 6973 7369 6e67 5f64 6174 6173 6f75  _missing_datasou
+0000b750: 7263 655f 6e61 6d65 2829 290a 2020 2020  rce_name()).    
+0000b760: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000b770: 2020 2020 2020 7261 6973 6520 5661 6c69        raise Vali
+0000b780: 6461 7469 6f6e 4578 6365 7074 696f 6e28  dationException(
+0000b790: 6622 5661 6c69 6461 7469 6f6e 2065 7272  f"Validation err
+0000b7a0: 6f72 2c20 666f 756e 6420 7b6c 696e 657d  or, found {line}
+0000b7b0: 2069 6e20 6c69 6e65 207b 7374 7228 6c69   in line {str(li
+0000b7c0: 6e65 6e6f 297d 3a20 7b73 7472 2865 297d  neno)}: {str(e)}
+0000b7d0: 222c 206c 696e 656e 6f3d 6c69 6e65 6e6f  ", lineno=lineno
+0000b7e0: 290a 2020 2020 6578 6365 7074 2049 6e63  ).    except Inc
+0000b7f0: 6c75 6465 4669 6c65 4e6f 7446 6f75 6e64  ludeFileNotFound
+0000b800: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0000b810: 2020 2020 2020 2020 7261 6973 6520 650a          raise e.
+0000b820: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0000b830: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+0000b840: 2020 2074 7261 6365 6261 636b 2e70 7269     traceback.pri
+0000b850: 6e74 5f74 6228 652e 5f5f 7472 6163 6562  nt_tb(e.__traceb
+0000b860: 6163 6b5f 5f29 0a20 2020 2020 2020 2072  ack__).        r
+0000b870: 6169 7365 2050 6172 7365 4578 6365 7074  aise ParseExcept
+0000b880: 696f 6e28 6622 556e 6578 7065 6374 6564  ion(f"Unexpected
+0000b890: 2065 7272 6f72 3a20 7b65 7d22 2c20 6c69   error: {e}", li
+0000b8a0: 6e65 6e6f 3d6c 696e 656e 6f29 0a0a 2020  neno=lineno)..  
+0000b8b0: 2020 7265 7475 726e 2064 6f63 0a0a 0a64    return doc...d
+0000b8c0: 6566 2067 656e 6572 6174 655f 7265 736f  ef generate_reso
+0000b8d0: 7572 6365 5f66 6f72 5f6b 6579 286b 6579  urce_for_key(key
+0000b8e0: 3a20 7374 722c 206e 616d 653a 2073 7472  : str, name: str
+0000b8f0: 2c20 7363 6865 6d61 3a20 7374 722c 2076  , schema: str, v
+0000b900: 6572 7369 6f6e 3a20 7374 722c 2072 6573  ersion: str, res
+0000b910: 5f6e 616d 653a 2073 7472 2920 2d3e 204c  _name: str) -> L
+0000b920: 6973 745b 4469 6374 5b73 7472 2c20 416e  ist[Dict[str, An
+0000b930: 795d 5d3a 0a20 2020 2072 6573 6f75 7263  y]]:.    resourc
+0000b940: 6573 3a20 4c69 7374 5b44 6963 745b 7374  es: List[Dict[st
+0000b950: 722c 2041 6e79 5d5d 203d 205b 5d0a 2020  r, Any]] = [].  
+0000b960: 2020 2320 6461 7461 736f 7572 6365 0a20    # datasource. 
+0000b970: 2020 2064 735f 6e61 6d65 203d 2066 227b     ds_name = f"{
+0000b980: 6e61 6d65 7d5f 6a6f 696e 5f62 795f 7b6b  name}_join_by_{k
+0000b990: 6579 7d7b 7665 7273 696f 6e7d 220a 2020  ey}{version}".  
+0000b9a0: 2020 7061 7261 6d73 203d 207b 0a20 2020    params = {.   
+0000b9b0: 2020 2020 2022 6e61 6d65 223a 2064 735f       "name": ds_
+0000b9c0: 6e61 6d65 2c0a 2020 2020 2020 2020 2273  name,.        "s
+0000b9d0: 6368 656d 6122 3a20 7363 6865 6d61 2c0a  chema": schema,.
+0000b9e0: 2020 2020 2020 2020 2265 6e67 696e 6522          "engine"
+0000b9f0: 3a20 224a 6f69 6e22 2c0a 2020 2020 2020  : "Join",.      
+0000ba00: 2020 2265 6e67 696e 655f 6a6f 696e 5f73    "engine_join_s
+0000ba10: 7472 6963 746e 6573 7322 3a20 2241 4e59  trictness": "ANY
+0000ba20: 222c 0a20 2020 2020 2020 2022 656e 6769  ",.        "engi
+0000ba30: 6e65 5f6a 6f69 6e5f 7479 7065 223a 2022  ne_join_type": "
+0000ba40: 4c45 4654 222c 0a20 2020 2020 2020 2022  LEFT",.        "
+0000ba50: 656e 6769 6e65 5f6b 6579 5f63 6f6c 756d  engine_key_colum
+0000ba60: 6e73 223a 206b 6579 2c0a 2020 2020 7d0a  ns": key,.    }.
+0000ba70: 2020 2020 7265 736f 7572 6365 732e 6170      resources.ap
+0000ba80: 7065 6e64 280a 2020 2020 2020 2020 7b0a  pend(.        {.
+0000ba90: 2020 2020 2020 2020 2020 2020 2272 6573              "res
+0000baa0: 6f75 7263 655f 6e61 6d65 223a 2066 227b  ource_name": f"{
+0000bab0: 6e61 6d65 7d5f 6a6f 696e 5f62 795f 7b6b  name}_join_by_{k
+0000bac0: 6579 7d22 2c0a 2020 2020 2020 2020 2020  ey}",.          
+0000bad0: 2020 2272 6573 6f75 7263 6522 3a20 2264    "resource": "d
+0000bae0: 6174 6173 6f75 7263 6573 222c 0a20 2020  atasources",.   
+0000baf0: 2020 2020 2020 2020 2022 7061 7261 6d73           "params
+0000bb00: 223a 2070 6172 616d 732c 0a20 2020 2020  ": params,.     
+0000bb10: 2020 2020 2020 2022 6669 6c65 6e61 6d65         "filename
+0000bb20: 223a 2066 227b 7061 7261 6d73 5b27 6e61  ": f"{params['na
+0000bb30: 6d65 275d 7d2e 6461 7461 736f 7572 6365  me']}.datasource
+0000bb40: 222c 0a20 2020 2020 2020 207d 0a20 2020  ",.        }.   
+0000bb50: 2029 0a20 2020 2072 6573 6f75 7263 6573   ).    resources
+0000bb60: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
+0000bb70: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+0000bb80: 7265 736f 7572 6365 5f6e 616d 6522 3a20  resource_name": 
+0000bb90: 6622 7b6e 616d 657d 5f6a 6f69 6e5f 6279  f"{name}_join_by
+0000bba0: 5f7b 6b65 797d 5f70 6970 6522 2c0a 2020  _{key}_pipe",.  
+0000bbb0: 2020 2020 2020 2020 2020 2272 6573 6f75            "resou
+0000bbc0: 7263 6522 3a20 2270 6970 6573 222c 0a20  rce": "pipes",. 
+0000bbd0: 2020 2020 2020 2020 2020 2022 6669 6c65             "file
+0000bbe0: 6e61 6d65 223a 2066 227b 7061 7261 6d73  name": f"{params
+0000bbf0: 5b27 6e61 6d65 275d 7d2e 7069 7065 222c  ['name']}.pipe",
+0000bc00: 0a20 2020 2020 2020 2020 2020 2022 6e61  .            "na
+0000bc10: 6d65 223a 2066 227b 6e61 6d65 7d5f 6a6f  me": f"{name}_jo
+0000bc20: 696e 5f62 795f 7b6b 6579 7d5f 7069 7065  in_by_{key}_pipe
+0000bc30: 7b76 6572 7369 6f6e 7d22 2c0a 2020 2020  {version}",.    
+0000bc40: 2020 2020 2020 2020 2273 6368 656d 6122          "schema"
+0000bc50: 3a20 7363 6865 6d61 2c0a 2020 2020 2020  : schema,.      
+0000bc60: 2020 2020 2020 226e 6f64 6573 223a 205b        "nodes": [
+0000bc70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bc80: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0000bc90: 2020 2020 2020 2022 7371 6c22 3a20 6622         "sql": f"
+0000bca0: 7365 6c65 6374 202a 2066 726f 6d20 7b6e  select * from {n
+0000bcb0: 616d 657d 7b76 6572 7369 6f6e 7d22 2c0a  ame}{version}",.
+0000bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcd0: 2020 2020 2270 6172 616d 7322 3a20 7b22      "params": {"
+0000bce0: 6e61 6d65 223a 2066 227b 6e61 6d65 7d5f  name": f"{name}_
+0000bcf0: 6a6f 696e 5f62 795f 7b6b 6579 7d5f 7669  join_by_{key}_vi
+0000bd00: 6577 222c 2022 7479 7065 223a 2022 6d61  ew", "type": "ma
+0000bd10: 7465 7269 616c 697a 6564 222c 2022 6461  terialized", "da
+0000bd20: 7461 736f 7572 6365 223a 2064 735f 6e61  tasource": ds_na
+0000bd30: 6d65 7d2c 0a20 2020 2020 2020 2020 2020  me},.           
+0000bd40: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0000bd50: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+0000bd60: 2020 2264 6570 7322 3a20 5b72 6573 5f6e    "deps": [res_n
+0000bd70: 616d 655d 2c20 2023 205b 6473 5f6e 616d  ame],  # [ds_nam
+0000bd80: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
+0000bd90: 2274 6f6b 656e 7322 3a20 5b5d 2c0a 2020  "tokens": [],.  
+0000bda0: 2020 2020 2020 7d0a 2020 2020 290a 2020        }.    ).  
+0000bdb0: 2020 7265 7475 726e 2072 6573 6f75 7263    return resourc
+0000bdc0: 6573 0a0a 0a61 7379 6e63 2064 6566 2070  es...async def p
+0000bdd0: 726f 6365 7373 5f66 696c 6528 0a20 2020  rocess_file(.   
+0000bde0: 2066 696c 656e 616d 653a 2073 7472 2c0a   filename: str,.
+0000bdf0: 2020 2020 7462 5f63 6c69 656e 743a 2054      tb_client: T
+0000be00: 696e 7942 2c0a 2020 2020 7265 736f 7572  inyB,.    resour
+0000be10: 6365 5f76 6572 7369 6f6e 733a 204f 7074  ce_versions: Opt
+0000be20: 696f 6e61 6c5b 4469 6374 5d20 3d20 4e6f  ional[Dict] = No
+0000be30: 6e65 2c0a 2020 2020 736b 6970 5f63 6f6e  ne,.    skip_con
+0000be40: 6e65 6374 6f72 733a 2062 6f6f 6c20 3d20  nectors: bool = 
+0000be50: 4661 6c73 652c 0a20 2020 2077 6f72 6b73  False,.    works
+0000be60: 7061 6365 5f6d 6170 3a20 4f70 7469 6f6e  pace_map: Option
+0000be70: 616c 5b44 6963 745d 203d 204e 6f6e 652c  al[Dict] = None,
+0000be80: 0a20 2020 2077 6f72 6b73 7061 6365 5f6c  .    workspace_l
+0000be90: 6962 5f70 6174 6873 3a20 4f70 7469 6f6e  ib_paths: Option
+0000bea0: 616c 5b4c 6973 745b 5475 706c 655b 7374  al[List[Tuple[st
+0000beb0: 722c 2073 7472 5d5d 5d20 3d20 4e6f 6e65  r, str]]] = None
+0000bec0: 2c0a 2020 2020 6375 7272 656e 745f 7773  ,.    current_ws
+0000bed0: 3a20 4f70 7469 6f6e 616c 5b44 6963 745b  : Optional[Dict[
+0000bee0: 7374 722c 2041 6e79 5d5d 203d 204e 6f6e  str, Any]] = Non
+0000bef0: 652c 0a29 3a20 2023 206e 6f71 613a 2043  e,.):  # noqa: C
+0000bf00: 3930 3120 4230 3036 0a20 2020 2069 6620  901 B006.    if 
+0000bf10: 776f 726b 7370 6163 655f 6d61 7020 6973  workspace_map is
+0000bf20: 204e 6f6e 653a 0a20 2020 2020 2020 2077   None:.        w
+0000bf30: 6f72 6b73 7061 6365 5f6d 6170 203d 207b  orkspace_map = {
+0000bf40: 7d0a 0a20 2020 2069 6620 7265 736f 7572  }..    if resour
+0000bf50: 6365 5f76 6572 7369 6f6e 7320 6973 204e  ce_versions is N
+0000bf60: 6f6e 653a 0a20 2020 2020 2020 2072 6573  one:.        res
+0000bf70: 6f75 7263 655f 7665 7273 696f 6e73 203d  ource_versions =
+0000bf80: 207b 7d0a 2020 2020 7265 736f 7572 6365   {}.    resource
+0000bf90: 5f76 6572 7369 6f6e 735f 7374 7269 6e67  _versions_string
+0000bfa0: 203d 207b 6b3a 2066 225f 5f76 7b76 7d22   = {k: f"__v{v}"
+0000bfb0: 2066 6f72 206b 2c20 7620 696e 2072 6573   for k, v in res
+0000bfc0: 6f75 7263 655f 7665 7273 696f 6e73 2e69  ource_versions.i
+0000bfd0: 7465 6d73 2829 2069 6620 7620 3e3d 2030  tems() if v >= 0
+0000bfe0: 7d0a 0a20 2020 2064 6566 2067 6574 5f65  }..    def get_e
+0000bff0: 6e67 696e 655f 7061 7261 6d73 286e 6f64  ngine_params(nod
+0000c000: 653a 2044 6963 745b 7374 722c 2041 6e79  e: Dict[str, Any
+0000c010: 5d29 202d 3e20 4469 6374 5b73 7472 2c20  ]) -> Dict[str, 
+0000c020: 416e 795d 3a0a 2020 2020 2020 2020 7061  Any]:.        pa
+0000c030: 7261 6d73 203d 207b 7d0a 0a20 2020 2020  rams = {}..     
+0000c040: 2020 2069 6620 2265 6e67 696e 6522 2069     if "engine" i
+0000c050: 6e20 6e6f 6465 3a0a 2020 2020 2020 2020  n node:.        
+0000c060: 2020 2020 656e 6769 6e65 203d 206e 6f64      engine = nod
+0000c070: 655b 2265 6e67 696e 6522 5d5b 2274 7970  e["engine"]["typ
+0000c080: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
+0000c090: 7061 7261 6d73 5b22 656e 6769 6e65 225d  params["engine"]
+0000c0a0: 203d 2065 6e67 696e 650a 2020 2020 2020   = engine.      
+0000c0b0: 2020 2020 2020 6172 6773 203d 206e 6f64        args = nod
+0000c0c0: 655b 2265 6e67 696e 6522 5d5b 2261 7267  e["engine"]["arg
+0000c0d0: 7322 5d0a 2020 2020 2020 2020 2020 2020  s"].            
+0000c0e0: 666f 7220 6b2c 2076 2069 6e20 6172 6773  for k, v in args
+0000c0f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c100: 2020 7061 7261 6d73 5b66 2265 6e67 696e    params[f"engin
+0000c110: 655f 7b6b 7d22 5d20 3d20 760a 2020 2020  e_{k}"] = v.    
+0000c120: 2020 2020 7265 7475 726e 2070 6172 616d      return param
+0000c130: 730a 0a20 2020 2061 7379 6e63 2064 6566  s..    async def
+0000c140: 2067 6574 5f6b 6166 6b61 5f70 6172 616d   get_kafka_param
+0000c150: 7328 6e6f 6465 3a20 4469 6374 5b73 7472  s(node: Dict[str
+0000c160: 2c20 416e 795d 293a 0a20 2020 2020 2020  , Any]):.       
+0000c170: 2070 6172 616d 7320 3d20 7b6b 6579 3a20   params = {key: 
+0000c180: 7661 6c75 6520 666f 7220 6b65 792c 2076  value for key, v
+0000c190: 616c 7565 2069 6e20 6e6f 6465 2e69 7465  alue in node.ite
+0000c1a0: 6d73 2829 2069 6620 6b65 792e 7374 6172  ms() if key.star
+0000c1b0: 7473 7769 7468 2822 6b61 666b 6122 297d  tswith("kafka")}
+0000c1c0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0000c1d0: 2073 6b69 705f 636f 6e6e 6563 746f 7273   skip_connectors
+0000c1e0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+0000c1f0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000c200: 2020 2063 6f6e 6e65 6374 6f72 5f70 6172     connector_par
+0000c210: 616d 7320 3d20 7b0a 2020 2020 2020 2020  ams = {.        
+0000c220: 2020 2020 2020 2020 2020 2020 226b 6166              "kaf
+0000c230: 6b61 5f62 6f6f 7473 7472 6170 5f73 6572  ka_bootstrap_ser
+0000c240: 7665 7273 223a 2070 6172 616d 732e 6765  vers": params.ge
+0000c250: 7428 226b 6166 6b61 5f62 6f6f 7473 7472  t("kafka_bootstr
+0000c260: 6170 5f73 6572 7665 7273 222c 204e 6f6e  ap_servers", Non
+0000c270: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0000c280: 2020 2020 2020 2020 226b 6166 6b61 5f6b          "kafka_k
+0000c290: 6579 223a 2070 6172 616d 732e 6765 7428  ey": params.get(
+0000c2a0: 226b 6166 6b61 5f6b 6579 222c 204e 6f6e  "kafka_key", Non
+0000c2b0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0000c2c0: 2020 2020 2020 2020 226b 6166 6b61 5f73          "kafka_s
+0000c2d0: 6563 7265 7422 3a20 7061 7261 6d73 2e67  ecret": params.g
+0000c2e0: 6574 2822 6b61 666b 615f 7365 6372 6574  et("kafka_secret
+0000c2f0: 222c 204e 6f6e 6529 2c0a 2020 2020 2020  ", None),.      
+0000c300: 2020 2020 2020 2020 2020 2020 2020 226b                "k
+0000c310: 6166 6b61 5f63 6f6e 6e65 6374 696f 6e5f  afka_connection_
+0000c320: 6e61 6d65 223a 2070 6172 616d 732e 6765  name": params.ge
+0000c330: 7428 226b 6166 6b61 5f63 6f6e 6e65 6374  t("kafka_connect
+0000c340: 696f 6e5f 6e61 6d65 222c 204e 6f6e 6529  ion_name", None)
+0000c350: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c360: 2020 2020 2020 226b 6166 6b61 5f61 7574        "kafka_aut
+0000c370: 6f5f 6f66 6673 6574 5f72 6573 6574 223a  o_offset_reset":
+0000c380: 2070 6172 616d 732e 6765 7428 226b 6166   params.get("kaf
+0000c390: 6b61 5f61 7574 6f5f 6f66 6673 6574 5f72  ka_auto_offset_r
+0000c3a0: 6573 6574 222c 204e 6f6e 6529 2c0a 2020  eset", None),.  
+0000c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3c0: 2020 226b 6166 6b61 5f73 6368 656d 615f    "kafka_schema_
+0000c3d0: 7265 6769 7374 7279 5f75 726c 223a 2070  registry_url": p
+0000c3e0: 6172 616d 732e 6765 7428 226b 6166 6b61  arams.get("kafka
+0000c3f0: 5f73 6368 656d 615f 7265 6769 7374 7279  _schema_registry
+0000c400: 5f75 726c 222c 204e 6f6e 6529 2c0a 2020  _url", None),.  
+0000c410: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0000c420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c430: 2063 6f6e 6e65 6374 6f72 203d 2061 7761   connector = awa
+0000c440: 6974 2074 625f 636c 6965 6e74 2e67 6574  it tb_client.get
+0000c450: 5f63 6f6e 6e65 6374 696f 6e28 2a2a 636f  _connection(**co
+0000c460: 6e6e 6563 746f 725f 7061 7261 6d73 290a  nnector_params).
+0000c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c480: 6966 206e 6f74 2063 6f6e 6e65 6374 6f72  if not connector
+0000c490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c4a0: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
+0000c4b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000c4c0: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+0000c4d0: 636b 4d61 6e61 6765 722e 696e 666f 5f63  ckManager.info_c
+0000c4e0: 7265 6174 696e 675f 6b61 666b 615f 636f  reating_kafka_co
+0000c4f0: 6e6e 6563 7469 6f6e 2863 6f6e 6e65 6374  nnection(connect
+0000c500: 696f 6e5f 6e61 6d65 3d70 6172 616d 735b  ion_name=params[
+0000c510: 226b 6166 6b61 5f63 6f6e 6e65 6374 696f  "kafka_connectio
+0000c520: 6e5f 6e61 6d65 225d 290a 2020 2020 2020  n_name"]).      
+0000c530: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c550: 2020 2020 7265 7175 6972 6564 5f70 6172      required_par
+0000c560: 616d 7320 3d20 5b0a 2020 2020 2020 2020  ams = [.        
+0000c570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c580: 636f 6e6e 6563 746f 725f 7061 7261 6d73  connector_params
+0000c590: 5b22 6b61 666b 615f 626f 6f74 7374 7261  ["kafka_bootstra
+0000c5a0: 705f 7365 7276 6572 7322 5d2c 0a20 2020  p_servers"],.   
+0000c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c5c0: 2020 2020 2063 6f6e 6e65 6374 6f72 5f70       connector_p
+0000c5d0: 6172 616d 735b 226b 6166 6b61 5f6b 6579  arams["kafka_key
+0000c5e0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+0000c5f0: 2020 2020 2020 2020 2020 2020 636f 6e6e              conn
+0000c600: 6563 746f 725f 7061 7261 6d73 5b22 6b61  ector_params["ka
+0000c610: 666b 615f 7365 6372 6574 225d 2c0a 2020  fka_secret"],.  
+0000c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c630: 2020 5d0a 0a20 2020 2020 2020 2020 2020    ]..           
+0000c640: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0000c650: 616c 6c28 7265 7175 6972 6564 5f70 6172  all(required_par
+0000c660: 616d 7329 3a0a 2020 2020 2020 2020 2020  ams):.          
+0000c670: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000c680: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
+0000c690: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
+0000c6a0: 6b4d 616e 6167 6572 2e65 7272 6f72 5f75  kManager.error_u
+0000c6b0: 6e6b 6e6f 776e 5f6b 6166 6b61 5f63 6f6e  nknown_kafka_con
+0000c6c0: 6e65 6374 696f 6e28 6461 7461 736f 7572  nection(datasour
+0000c6d0: 6365 3d6e 616d 6529 290a 0a20 2020 2020  ce=name))..     
+0000c6e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000c6f0: 6f6e 6e65 6374 6f72 203d 2061 7761 6974  onnector = await
+0000c700: 2074 625f 636c 6965 6e74 2e63 6f6e 6e65   tb_client.conne
+0000c710: 6374 696f 6e5f 6372 6561 7465 5f6b 6166  ction_create_kaf
+0000c720: 6b61 282a 2a63 6f6e 6e65 6374 6f72 5f70  ka(**connector_p
+0000c730: 6172 616d 7329 0a20 2020 2020 2020 2020  arams).         
+0000c740: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0000c750: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+0000c760: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000c770: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
+0000c780: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+0000c790: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+0000c7a0: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+0000c7b0: 636f 6e6e 6563 7469 6f6e 5f63 7265 6174  connection_creat
+0000c7c0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0000c7d0: 2020 2020 2020 2020 2020 2063 6f6e 6e65             conne
+0000c7e0: 6374 696f 6e5f 6e61 6d65 3d70 6172 616d  ction_name=param
+0000c7f0: 735b 226b 6166 6b61 5f63 6f6e 6e65 6374  s["kafka_connect
+0000c800: 696f 6e5f 6e61 6d65 225d 2c20 6572 726f  ion_name"], erro
+0000c810: 723d 7374 7228 6529 0a20 2020 2020 2020  r=str(e).       
+0000c820: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0000c830: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0000c840: 0a0a 2020 2020 2020 2020 2020 2020 636c  ..            cl
+0000c850: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
+0000c860: 6b4d 616e 6167 6572 2e73 7563 6365 7373  kManager.success
+0000c870: 5f63 6f6e 6e65 6374 696f 6e5f 7573 696e  _connection_usin
+0000c880: 6728 636f 6e6e 6563 7469 6f6e 5f6e 616d  g(connection_nam
+0000c890: 653d 636f 6e6e 6563 746f 725b 226e 616d  e=connector["nam
+0000c8a0: 6522 5d29 290a 0a20 2020 2020 2020 2020  e"]))..         
+0000c8b0: 2020 2070 6172 616d 732e 7570 6461 7465     params.update
+0000c8c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000c8d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0000c8e0: 2020 2020 2020 2020 2263 6f6e 6e65 6374          "connect
+0000c8f0: 6f72 223a 2063 6f6e 6e65 6374 6f72 5b22  or": connector["
+0000c900: 6964 225d 2c0a 2020 2020 2020 2020 2020  id"],.          
+0000c910: 2020 2020 2020 2020 2020 2273 6572 7669            "servi
+0000c920: 6365 223a 2022 6b61 666b 6122 2c0a 2020  ce": "kafka",.  
+0000c930: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0000c940: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0000c950: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
+0000c960: 7261 6d73 0a0a 2020 2020 6173 796e 6320  rams..    async 
+0000c970: 6465 6620 6765 745f 696d 706f 7274 5f70  def get_import_p
+0000c980: 6172 616d 7328 6461 7461 736f 7572 6365  arams(datasource
+0000c990: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
+0000c9a0: 2c20 6e6f 6465 3a20 4469 6374 5b73 7472  , node: Dict[str
+0000c9b0: 2c20 416e 795d 2920 2d3e 2044 6963 745b  , Any]) -> Dict[
+0000c9c0: 7374 722c 2041 6e79 5d3a 0a20 2020 2020  str, Any]:.     
+0000c9d0: 2020 2070 6172 616d 733a 2044 6963 745b     params: Dict[
+0000c9e0: 7374 722c 2041 6e79 5d20 3d20 7b6b 6579  str, Any] = {key
+0000c9f0: 3a20 7661 6c75 6520 666f 7220 6b65 792c  : value for key,
+0000ca00: 2076 616c 7565 2069 6e20 6e6f 6465 2e69   value in node.i
+0000ca10: 7465 6d73 2829 2069 6620 6b65 792e 7374  tems() if key.st
+0000ca20: 6172 7473 7769 7468 2822 696d 706f 7274  artswith("import
+0000ca30: 5f22 297d 0a0a 2020 2020 2020 2020 6966  _")}..        if
+0000ca40: 206c 656e 2870 6172 616d 7329 203d 3d20   len(params) == 
+0000ca50: 3020 6f72 2073 6b69 705f 636f 6e6e 6563  0 or skip_connec
+0000ca60: 746f 7273 3a0a 2020 2020 2020 2020 2020  tors:.          
+0000ca70: 2020 7265 7475 726e 2070 6172 616d 730a    return params.
+0000ca80: 0a20 2020 2020 2020 2073 6572 7669 6365  .        service
+0000ca90: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+0000caa0: 3d20 6e6f 6465 2e67 6574 2822 696d 706f  = node.get("impo
+0000cab0: 7274 5f73 6572 7669 6365 222c 204e 6f6e  rt_service", Non
+0000cac0: 6529 0a0a 2020 2020 2020 2020 6966 2073  e)..        if s
+0000cad0: 6572 7669 6365 2061 6e64 2073 6572 7669  ervice and servi
+0000cae0: 6365 2e6c 6f77 6572 2829 203d 3d20 2262  ce.lower() == "b
+0000caf0: 6967 7175 6572 7922 3a0a 2020 2020 2020  igquery":.      
+0000cb00: 2020 2020 2020 6966 206e 6f74 2061 7761        if not awa
+0000cb10: 6974 2074 625f 636c 6965 6e74 2e63 6865  it tb_client.che
+0000cb20: 636b 5f67 6370 5f72 6561 645f 7065 726d  ck_gcp_read_perm
+0000cb30: 6973 7369 6f6e 7328 293a 0a20 2020 2020  issions():.     
+0000cb40: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000cb50: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
+0000cb60: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+0000cb70: 6e61 6765 722e 6572 726f 725f 756e 6b6e  nager.error_unkn
+0000cb80: 6f77 6e5f 6271 5f63 6f6e 6e65 6374 696f  own_bq_connectio
+0000cb90: 6e28 6461 7461 736f 7572 6365 3d64 6174  n(datasource=dat
+0000cba0: 6173 6f75 7263 655b 226e 616d 6522 5d29  asource["name"])
+0000cbb0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0000cbc0: 2042 6967 7175 6572 7920 646f 6573 6e27   Bigquery doesn'
+0000cbd0: 7420 6861 7665 2061 2064 6174 616c 696e  t have a datalin
+0000cbe0: 6b2c 2073 6f20 7765 2063 616e 2073 746f  k, so we can sto
+0000cbf0: 7020 6865 7265 0a20 2020 2020 2020 2020  p here.         
+0000cc00: 2020 2072 6574 7572 6e20 7061 7261 6d73     return params
+0000cc10: 0a0a 2020 2020 2020 2020 2320 5265 7374  ..        # Rest
+0000cc20: 206f 6620 636f 6e6e 6563 746f 7273 0a0a   of connectors..
+0000cc30: 2020 2020 2020 2020 636f 6e6e 6563 746f          connecto
+0000cc40: 725f 6964 3a20 4f70 7469 6f6e 616c 5b73  r_id: Optional[s
+0000cc50: 7472 5d20 3d20 6e6f 6465 2e67 6574 2822  tr] = node.get("
+0000cc60: 696d 706f 7274 5f63 6f6e 6e65 6374 6f72  import_connector
+0000cc70: 222c 204e 6f6e 6529 0a20 2020 2020 2020  ", None).       
+0000cc80: 2063 6f6e 6e65 6374 6f72 5f6e 616d 653a   connector_name:
+0000cc90: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+0000cca0: 206e 6f64 652e 6765 7428 2269 6d70 6f72   node.get("impor
+0000ccb0: 745f 636f 6e6e 6563 7469 6f6e 5f6e 616d  t_connection_nam
+0000ccc0: 6522 2c20 4e6f 6e65 290a 2020 2020 2020  e", None).      
+0000ccd0: 2020 6966 206e 6f74 2063 6f6e 6e65 6374    if not connect
+0000cce0: 6f72 5f6e 616d 6520 616e 6420 6e6f 7420  or_name and not 
+0000ccf0: 636f 6e6e 6563 746f 725f 6964 3a0a 2020  connector_id:.  
+0000cd00: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000cd10: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
+0000cd20: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
+0000cd30: 6167 6572 2e65 7272 6f72 5f6d 6973 7369  ager.error_missi
+0000cd40: 6e67 5f63 6f6e 6e65 6374 696f 6e5f 6e61  ng_connection_na
+0000cd50: 6d65 2864 6174 6173 6f75 7263 653d 6461  me(datasource=da
+0000cd60: 7461 736f 7572 6365 5b22 6e61 6d65 225d  tasource["name"]
+0000cd70: 2929 0a0a 2020 2020 2020 2020 6966 206e  ))..        if n
+0000cd80: 6f74 2063 6f6e 6e65 6374 6f72 5f69 643a  ot connector_id:
+0000cd90: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000cda0: 6572 7420 6973 696e 7374 616e 6365 2863  ert isinstance(c
+0000cdb0: 6f6e 6e65 6374 6f72 5f6e 616d 652c 2073  onnector_name, s
+0000cdc0: 7472 290a 0a20 2020 2020 2020 2020 2020  tr)..           
+0000cdd0: 2063 6f6e 6e65 6374 6f72 3a20 4f70 7469   connector: Opti
+0000cde0: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
+0000cdf0: 6e79 5d5d 203d 2061 7761 6974 2074 625f  ny]] = await tb_
+0000ce00: 636c 6965 6e74 2e67 6574 5f63 6f6e 6e65  client.get_conne
+0000ce10: 6374 6f72 2863 6f6e 6e65 6374 6f72 5f6e  ctor(connector_n
+0000ce20: 616d 652c 2073 6572 7669 6365 290a 0a20  ame, service).. 
+0000ce30: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0000ce40: 7420 636f 6e6e 6563 746f 723a 0a20 2020  t connector:.   
+0000ce50: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000ce60: 7365 2045 7863 6570 7469 6f6e 280a 2020  se Exception(.  
+0000ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce80: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
+0000ce90: 722e 6572 726f 725f 756e 6b6e 6f77 6e5f  r.error_unknown_
+0000cea0: 636f 6e6e 6563 7469 6f6e 2864 6174 6173  connection(datas
+0000ceb0: 6f75 7263 653d 6461 7461 736f 7572 6365  ource=datasource
+0000cec0: 5b22 6e61 6d65 225d 2c20 636f 6e6e 6563  ["name"], connec
+0000ced0: 7469 6f6e 3d63 6f6e 6e65 6374 6f72 5f6e  tion=connector_n
+0000cee0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0000cef0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000cf00: 2020 2063 6f6e 6e65 6374 6f72 5f69 6420     connector_id 
+0000cf10: 3d20 636f 6e6e 6563 746f 725b 2269 6422  = connector["id"
+0000cf20: 5d0a 2020 2020 2020 2020 2020 2020 7365  ].            se
+0000cf30: 7276 6963 6520 3d20 636f 6e6e 6563 746f  rvice = connecto
+0000cf40: 725b 2273 6572 7669 6365 225d 0a0a 2020  r["service"]..  
+0000cf50: 2020 2020 2020 2320 5468 6520 4150 4920        # The API 
+0000cf60: 6e65 6564 7320 7468 6520 636f 6e6e 6563  needs the connec
+0000cf70: 746f 7220 4944 2074 6f20 6372 6561 7465  tor ID to create
+0000cf80: 2074 6865 2064 6174 6173 6f75 7263 652e   the datasource.
+0000cf90: 0a20 2020 2020 2020 2070 6172 616d 735b  .        params[
+0000cfa0: 2269 6d70 6f72 745f 636f 6e6e 6563 746f  "import_connecto
+0000cfb0: 7222 5d20 3d20 636f 6e6e 6563 746f 725f  r"] = connector_
+0000cfc0: 6964 0a20 2020 2020 2020 2069 6620 7365  id.        if se
+0000cfd0: 7276 6963 653a 0a20 2020 2020 2020 2020  rvice:.         
+0000cfe0: 2020 2070 6172 616d 735b 2269 6d70 6f72     params["impor
+0000cff0: 745f 7365 7276 6963 6522 5d20 3d20 7365  t_service"] = se
+0000d000: 7276 6963 650a 0a20 2020 2020 2020 2069  rvice..        i
+0000d010: 6620 7365 7276 6963 6520 696e 2050 5245  f service in PRE
+0000d020: 5649 4557 5f43 4f4e 4e45 4354 4f52 5f53  VIEW_CONNECTOR_S
+0000d030: 4552 5649 4345 533a 0a20 2020 2020 2020  ERVICES:.       
+0000d040: 2020 2020 2069 6620 6e6f 7420 7061 7261       if not para
+0000d050: 6d73 2e67 6574 2822 696d 706f 7274 5f62  ms.get("import_b
+0000d060: 7563 6b65 745f 7572 6922 2c20 4e6f 6e65  ucket_uri", None
+0000d070: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000d080: 2020 2072 6169 7365 2063 6c69 636b 2e43     raise click.C
+0000d090: 6c69 636b 4578 6365 7074 696f 6e28 4665  lickException(Fe
+0000d0a0: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
+0000d0b0: 726f 725f 6d69 7373 696e 675f 6275 636b  ror_missing_buck
+0000d0c0: 6574 5f75 7269 2864 6174 6173 6f75 7263  et_uri(datasourc
+0000d0d0: 653d 6461 7461 736f 7572 6365 5b22 6e61  e=datasource["na
+0000d0e0: 6d65 225d 2929 0a20 2020 2020 2020 2065  me"])).        e
+0000d0f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000d100: 2069 6620 6e6f 7420 7061 7261 6d73 2e67   if not params.g
+0000d110: 6574 2822 696d 706f 7274 5f65 7874 6572  et("import_exter
+0000d120: 6e61 6c5f 6461 7461 736f 7572 6365 222c  nal_datasource",
+0000d130: 204e 6f6e 6529 3a0a 2020 2020 2020 2020   None):.        
+0000d140: 2020 2020 2020 2020 7261 6973 6520 636c          raise cl
+0000d150: 6963 6b2e 436c 6963 6b45 7863 6570 7469  ick.ClickExcepti
+0000d160: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+0000d170: 2020 2020 2020 2020 4665 6564 6261 636b          Feedback
+0000d180: 4d61 6e61 6765 722e 6572 726f 725f 6d69  Manager.error_mi
+0000d190: 7373 696e 675f 6578 7465 726e 616c 5f64  ssing_external_d
+0000d1a0: 6174 6173 6f75 7263 6528 6461 7461 736f  atasource(dataso
+0000d1b0: 7572 6365 3d64 6174 6173 6f75 7263 655b  urce=datasource[
+0000d1c0: 226e 616d 6522 5d29 0a20 2020 2020 2020  "name"]).       
+0000d1d0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0000d1e0: 2020 2020 7265 7475 726e 2070 6172 616d      return param
+0000d1f0: 730a 0a20 2020 2069 6620 4461 7461 4669  s..    if DataFi
+0000d200: 6c65 4578 7465 6e73 696f 6e73 2e44 4154  leExtensions.DAT
+0000d210: 4153 4f55 5243 4520 696e 2066 696c 656e  ASOURCE in filen
+0000d220: 616d 653a 0a20 2020 2020 2020 2064 6f63  ame:.        doc
+0000d230: 203d 2070 6172 7365 5f64 6174 6173 6f75   = parse_datasou
+0000d240: 7263 6528 6669 6c65 6e61 6d65 290a 2020  rce(filename).  
+0000d250: 2020 2020 2020 6e6f 6465 203d 2064 6f63        node = doc
+0000d260: 2e6e 6f64 6573 5b30 5d0a 2020 2020 2020  .nodes[0].      
+0000d270: 2020 6465 7073 3a20 4c69 7374 5b73 7472    deps: List[str
+0000d280: 5d20 3d20 5b5d 0a20 2020 2020 2020 2023  ] = [].        #
+0000d290: 2072 6565 6d70 6c61 6365 2074 6162 6c65   reemplace table
+0000d2a0: 7320 6f6e 206d 6174 6572 6961 6c69 7a65  s on materialize
+0000d2b0: 6420 636f 6c75 6d6e 730a 2020 2020 2020  d columns.      
+0000d2c0: 2020 636f 6c75 6d6e 7320 3d20 7061 7273    columns = pars
+0000d2d0: 655f 7461 626c 655f 7374 7275 6374 7572  e_table_structur
+0000d2e0: 6528 6e6f 6465 5b22 7363 6865 6d61 225d  e(node["schema"]
+0000d2f0: 290a 0a20 2020 2020 2020 205f 666f 726d  )..        _form
+0000d300: 6174 203d 2022 6373 7622 0a20 2020 2020  at = "csv".     
+0000d310: 2020 2066 6f72 2078 2069 6e20 636f 6c75     for x in colu
+0000d320: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
+0000d330: 2069 6620 785b 2264 6566 6175 6c74 5f76   if x["default_v
+0000d340: 616c 7565 225d 2061 6e64 2078 5b22 6465  alue"] and x["de
+0000d350: 6661 756c 745f 7661 6c75 6522 5d2e 6c6f  fault_value"].lo
+0000d360: 7765 7228 292e 7374 6172 7473 7769 7468  wer().startswith
+0000d370: 2822 6d61 7465 7269 616c 697a 6564 2229  ("materialized")
+0000d380: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d390: 2020 2320 7475 726e 2065 7870 7265 7373    # turn express
+0000d3a0: 696f 6e20 746f 2061 2073 656c 6563 7420  ion to a select 
+0000d3b0: 7175 6572 7920 746f 2073 716c 5f67 6574  query to sql_get
+0000d3c0: 5f75 7365 645f 7461 626c 6573 2063 616e  _used_tables can
+0000d3d0: 2067 6574 2074 6865 2075 7365 6420 7461   get the used ta
+0000d3e0: 626c 6573 0a20 2020 2020 2020 2020 2020  bles.           
+0000d3f0: 2020 2020 2071 203d 2022 7365 6c65 6374       q = "select
+0000d400: 2022 202b 2078 5b22 6465 6661 756c 745f   " + x["default_
+0000d410: 7661 6c75 6522 5d5b 6c65 6e28 226d 6174  value"][len("mat
+0000d420: 6572 6961 6c69 7a65 6422 2920 3a5d 0a20  erialized") :]. 
+0000d430: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000d440: 6162 6c65 7320 3d20 6177 6169 7420 7462  ables = await tb
+0000d450: 5f63 6c69 656e 742e 7371 6c5f 6765 745f  _client.sql_get_
+0000d460: 7573 6564 5f74 6162 6c65 7328 7129 0a20  used_tables(q). 
+0000d470: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000d480: 206d 6174 6572 6961 6c69 7a65 6420 636f   materialized co
+0000d490: 6c75 6d6e 7320 6578 7072 6573 7369 6f6e  lumns expression
+0000d4a0: 7320 636f 756c 6420 6861 7665 206a 6f69  s could have joi
+0000d4b0: 6e73 2073 6f20 7765 206e 6565 6420 746f  ns so we need to
+0000d4c0: 2061 6464 2074 6865 6d20 6173 2061 2064   add them as a d
+0000d4d0: 6570 0a20 2020 2020 2020 2020 2020 2020  ep.             
+0000d4e0: 2020 2064 6570 7320 2b3d 2074 6162 6c65     deps += table
+0000d4f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0000d500: 2020 2320 6765 6e65 7261 7465 2072 6570    # generate rep
+0000d510: 6c61 6365 6d65 6e74 7320 616e 6420 7265  lacements and re
+0000d520: 706c 6163 6520 7468 6520 7175 6572 790a  place the query.
+0000d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d540: 7265 706c 6163 656d 656e 7473 203d 207b  replacements = {
+0000d550: 743a 2074 202b 2072 6573 6f75 7263 655f  t: t + resource_
+0000d560: 7665 7273 696f 6e73 5f73 7472 696e 672e  versions_string.
+0000d570: 6765 7428 742c 2022 2229 2066 6f72 2074  get(t, "") for t
+0000d580: 2069 6e20 7461 626c 6573 7d0a 0a20 2020   in tables}..   
+0000d590: 2020 2020 2020 2020 2020 2020 2072 6570               rep
+0000d5a0: 6c61 6365 645f 7265 7375 6c74 7320 3d20  laced_results = 
+0000d5b0: 6177 6169 7420 7462 5f63 6c69 656e 742e  await tb_client.
+0000d5c0: 7265 706c 6163 655f 7461 626c 6573 2871  replace_tables(q
+0000d5d0: 2c20 7265 706c 6163 656d 656e 7473 290a  , replacements).
+0000d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d5f0: 785b 2264 6566 6175 6c74 5f76 616c 7565  x["default_value
+0000d600: 225d 203d 2072 6570 6c61 6365 645f 7265  "] = replaced_re
+0000d610: 7375 6c74 732e 7265 706c 6163 6528 2253  sults.replace("S
+0000d620: 454c 4543 5422 2c20 226d 6174 6572 6961  ELECT", "materia
+0000d630: 6c69 7a65 6422 2c20 3129 0a20 2020 2020  lized", 1).     
+0000d640: 2020 2020 2020 2069 6620 782e 6765 7428         if x.get(
+0000d650: 226a 736f 6e70 6174 6822 2c20 4e6f 6e65  "jsonpath", None
+0000d660: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000d670: 2020 205f 666f 726d 6174 203d 2022 6e64     _format = "nd
+0000d680: 6a73 6f6e 220a 0a20 2020 2020 2020 2073  json"..        s
+0000d690: 6368 656d 6120 3d20 222c 222e 6a6f 696e  chema = ",".join
+0000d6a0: 2873 6368 656d 615f 746f 5f73 716c 5f63  (schema_to_sql_c
+0000d6b0: 6f6c 756d 6e73 2863 6f6c 756d 6e73 2929  olumns(columns))
+0000d6c0: 0a0a 2020 2020 2020 2020 6e61 6d65 203d  ..        name =
+0000d6d0: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+0000d6e0: 6528 6669 6c65 6e61 6d65 292e 7273 706c  e(filename).rspl
+0000d6f0: 6974 2822 2e22 2c20 3129 5b30 5d0a 0a20  it(".", 1)[0].. 
+0000d700: 2020 2020 2020 2069 6620 776f 726b 7370         if worksp
+0000d710: 6163 655f 6c69 625f 7061 7468 733a 0a20  ace_lib_paths:. 
+0000d720: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
+0000d730: 6b5f 6e61 6d65 2c20 776b 5f70 6174 6820  k_name, wk_path 
+0000d740: 696e 2077 6f72 6b73 7061 6365 5f6c 6962  in workspace_lib
+0000d750: 5f70 6174 6873 3a0a 2020 2020 2020 2020  _paths:.        
+0000d760: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d780: 2050 6174 6828 6669 6c65 6e61 6d65 292e   Path(filename).
+0000d790: 7265 6c61 7469 7665 5f74 6f28 776b 5f70  relative_to(wk_p
+0000d7a0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+0000d7b0: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
+0000d7c0: 6622 7b77 6f72 6b73 7061 6365 5f6d 6170  f"{workspace_map
+0000d7d0: 2e67 6574 2877 6b5f 6e61 6d65 2c20 776b  .get(wk_name, wk
+0000d7e0: 5f6e 616d 6529 7d2e 7b6e 616d 657d 220a  _name)}.{name}".
+0000d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d800: 6578 6365 7074 2056 616c 7565 4572 726f  except ValueErro
+0000d810: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000d820: 2020 2020 2020 2023 2074 6865 2070 6174         # the pat
+0000d830: 6820 7761 7320 6e6f 7420 7265 6c61 7469  h was not relati
+0000d840: 7665 2c20 6e6f 7420 696e 7369 6465 2077  ve, not inside w
+0000d850: 6f72 6b73 7061 6365 0a20 2020 2020 2020  orkspace.       
+0000d860: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+0000d870: 730a 0a20 2020 2020 2020 2072 6573 5f6e  s..        res_n
+0000d880: 616d 6520 3d20 6e61 6d65 0a20 2020 2020  ame = name.     
+0000d890: 2020 2076 6572 7369 6f6e 203d 2066 225f     version = f"_
+0000d8a0: 5f76 7b64 6f63 2e76 6572 7369 6f6e 7d22  _v{doc.version}"
+0000d8b0: 2069 6620 646f 632e 7665 7273 696f 6e20   if doc.version 
+0000d8c0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0000d8d0: 2022 220a 0a20 2020 2020 2020 2064 6566   ""..        def
+0000d8e0: 2061 7070 656e 645f 7665 7273 696f 6e5f   append_version_
+0000d8f0: 746f 5f6e 616d 6528 6e61 6d65 3a20 7374  to_name(name: st
+0000d900: 722c 2076 6572 7369 6f6e 3a20 7374 7229  r, version: str)
+0000d910: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+0000d920: 2020 2020 2069 6620 7665 7273 696f 6e20       if version 
+0000d930: 213d 2022 223a 0a20 2020 2020 2020 2020  != "":.         
+0000d940: 2020 2020 2020 206e 616d 6520 3d20 6e61         name = na
+0000d950: 6d65 2e72 6570 6c61 6365 2822 2e22 2c20  me.replace(".", 
+0000d960: 225f 2229 0a20 2020 2020 2020 2020 2020  "_").           
+0000d970: 2020 2020 2072 6574 7572 6e20 6e61 6d65       return name
+0000d980: 202b 2076 6572 7369 6f6e 0a20 2020 2020   + version.     
+0000d990: 2020 2020 2020 2072 6574 7572 6e20 6e61         return na
+0000d9a0: 6d65 0a0a 2020 2020 2020 2020 6465 7363  me..        desc
+0000d9b0: 7269 7074 696f 6e20 3d20 6e6f 6465 2e67  ription = node.g
+0000d9c0: 6574 2822 6465 7363 7269 7074 696f 6e22  et("description"
+0000d9d0: 2c20 2222 290a 2020 2020 2020 2020 696e  , "").        in
+0000d9e0: 6465 7865 735f 6c69 7374 203d 206e 6f64  dexes_list = nod
+0000d9f0: 652e 6765 7428 2269 6e64 6578 6573 222c  e.get("indexes",
+0000da00: 205b 5d29 0a20 2020 2020 2020 2069 6e64   []).        ind
+0000da10: 6578 6573 203d 204e 6f6e 650a 2020 2020  exes = None.    
+0000da20: 2020 2020 6966 2069 6e64 6578 6573 5f6c      if indexes_l
+0000da30: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
+0000da40: 2069 6e64 6578 6573 203d 2022 5c6e 222e   indexes = "\n".
+0000da50: 6a6f 696e 285b 696e 6465 782e 746f 5f73  join([index.to_s
+0000da60: 716c 2829 2066 6f72 2069 6e64 6578 2069  ql() for index i
+0000da70: 6e20 696e 6465 7865 735f 6c69 7374 5d29  n indexes_list])
+0000da80: 0a20 2020 2020 2020 2070 6172 616d 7320  .        params 
+0000da90: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0000daa0: 226e 616d 6522 3a20 6170 7065 6e64 5f76  "name": append_v
+0000dab0: 6572 7369 6f6e 5f74 6f5f 6e61 6d65 286e  ersion_to_name(n
+0000dac0: 616d 652c 2076 6572 7369 6f6e 292c 0a20  ame, version),. 
+0000dad0: 2020 2020 2020 2020 2020 2022 6465 7363             "desc
+0000dae0: 7269 7074 696f 6e22 3a20 6465 7363 7269  ription": descri
+0000daf0: 7074 696f 6e2c 0a20 2020 2020 2020 2020  ption,.         
+0000db00: 2020 2022 7363 6865 6d61 223a 2073 6368     "schema": sch
+0000db10: 656d 612c 0a20 2020 2020 2020 2020 2020  ema,.           
+0000db20: 2022 696e 6465 7865 7322 3a20 696e 6465   "indexes": inde
+0000db30: 7865 732c 0a20 2020 2020 2020 2020 2020  xes,.           
+0000db40: 2022 696e 6465 7865 735f 6c69 7374 223a   "indexes_list":
+0000db50: 2069 6e64 6578 6573 5f6c 6973 742c 0a20   indexes_list,. 
+0000db60: 2020 2020 2020 2020 2020 2022 666f 726d             "form
+0000db70: 6174 223a 205f 666f 726d 6174 2c0a 2020  at": _format,.  
+0000db80: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0000db90: 2070 6172 616d 732e 7570 6461 7465 2867   params.update(g
+0000dba0: 6574 5f65 6e67 696e 655f 7061 7261 6d73  et_engine_params
+0000dbb0: 286e 6f64 6529 290a 0a20 2020 2020 2020  (node))..       
+0000dbc0: 2069 6620 2269 6d70 6f72 745f 7365 7276   if "import_serv
+0000dbd0: 6963 6522 2069 6e20 6e6f 6465 206f 7220  ice" in node or 
+0000dbe0: 2269 6d70 6f72 745f 636f 6e6e 6563 7469  "import_connecti
+0000dbf0: 6f6e 5f6e 616d 6522 2069 6e20 6e6f 6465  on_name" in node
+0000dc00: 3a0a 2020 2020 2020 2020 2020 2020 5641  :.            VA
+0000dc10: 4c49 445f 5345 5256 4943 4553 3a20 5475  LID_SERVICES: Tu
+0000dc20: 706c 655b 7374 722c 202e 2e2e 5d20 3d20  ple[str, ...] = 
+0000dc30: 2822 6269 6771 7565 7279 222c 2022 736e  ("bigquery", "sn
+0000dc40: 6f77 666c 616b 6522 2c20 2273 3322 2c20  owflake", "s3", 
+0000dc50: 2273 335f 6961 6d72 6f6c 6522 2c20 2267  "s3_iamrole", "g
+0000dc60: 6373 2229 0a0a 2020 2020 2020 2020 2020  cs")..          
+0000dc70: 2020 696d 706f 7274 5f70 6172 616d 7320    import_params 
+0000dc80: 3d20 6177 6169 7420 6765 745f 696d 706f  = await get_impo
+0000dc90: 7274 5f70 6172 616d 7328 7061 7261 6d73  rt_params(params
+0000dca0: 2c20 6e6f 6465 290a 0a20 2020 2020 2020  , node)..       
+0000dcb0: 2020 2020 2073 6572 7669 6365 203d 2069       service = i
+0000dcc0: 6d70 6f72 745f 7061 7261 6d73 2e67 6574  mport_params.get
+0000dcd0: 2822 696d 706f 7274 5f73 6572 7669 6365  ("import_service
+0000dce0: 222c 204e 6f6e 6529 0a20 2020 2020 2020  ", None).       
+0000dcf0: 2020 2020 2069 6620 7365 7276 6963 6520       if service 
+0000dd00: 616e 6420 7365 7276 6963 6520 6e6f 7420  and service not 
+0000dd10: 696e 2056 414c 4944 5f53 4552 5649 4345  in VALID_SERVICE
+0000dd20: 533a 0a20 2020 2020 2020 2020 2020 2020  S:.             
+0000dd30: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+0000dd40: 6f6e 2866 2255 6e6b 6e6f 776e 2069 6d70  on(f"Unknown imp
+0000dd50: 6f72 7420 7365 7276 6963 653a 207b 7365  ort service: {se
+0000dd60: 7276 6963 657d 2229 0a0a 2020 2020 2020  rvice}")..      
+0000dd70: 2020 2020 2020 6966 2073 6572 7669 6365        if service
+0000dd80: 2069 6e20 5052 4556 4945 575f 434f 4e4e   in PREVIEW_CONN
+0000dd90: 4543 544f 525f 5345 5256 4943 4553 3a0a  ECTOR_SERVICES:.
+0000dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ddb0: 4f4e 5f44 454d 414e 445f 4352 4f4e 203d  ON_DEMAND_CRON =
+0000ddc0: 204f 4e5f 4445 4d41 4e44 0a20 2020 2020   ON_DEMAND.     
+0000ddd0: 2020 2020 2020 2020 2020 2041 5554 4f5f             AUTO_
+0000dde0: 4352 4f4e 203d 2022 4061 7574 6f22 0a20  CRON = "@auto". 
+0000ddf0: 2020 2020 2020 2020 2020 2020 2020 204f                 O
+0000de00: 4e5f 4445 4d41 4e44 5f43 524f 4e5f 4558  N_DEMAND_CRON_EX
+0000de10: 5045 4354 4544 5f42 595f 5448 455f 4150  PECTED_BY_THE_AP
+0000de20: 4920 3d20 2240 6f6e 6365 220a 2020 2020  I = "@once".    
+0000de30: 2020 2020 2020 2020 2020 2020 5641 4c49              VALI
+0000de40: 445f 4352 4f4e 533a 2054 7570 6c65 5b73  D_CRONS: Tuple[s
+0000de50: 7472 2c20 2e2e 2e5d 203d 2028 4f4e 5f44  tr, ...] = (ON_D
+0000de60: 454d 414e 445f 4352 4f4e 2c20 4155 544f  EMAND_CRON, AUTO
+0000de70: 5f43 524f 4e29 0a20 2020 2020 2020 2020  _CRON).         
+0000de80: 2020 2020 2020 2063 726f 6e20 3d20 6e6f         cron = no
+0000de90: 6465 2e67 6574 2822 696d 706f 7274 5f73  de.get("import_s
+0000dea0: 6368 6564 756c 6522 2c20 4f4e 5f44 454d  chedule", ON_DEM
+0000deb0: 414e 445f 4352 4f4e 290a 0a20 2020 2020  AND_CRON)..     
+0000dec0: 2020 2020 2020 2020 2020 2069 6620 6372             if cr
+0000ded0: 6f6e 206e 6f74 2069 6e20 5641 4c49 445f  on not in VALID_
+0000dee0: 4352 4f4e 533a 0a20 2020 2020 2020 2020  CRONS:.         
+0000def0: 2020 2020 2020 2020 2020 2076 616c 6964             valid
+0000df00: 5f76 616c 7565 7320 3d20 222c 2022 2e6a  _values = ", ".j
+0000df10: 6f69 6e28 5641 4c49 445f 4352 4f4e 5329  oin(VALID_CRONS)
+0000df20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000df30: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
+0000df40: 7469 6f6e 2866 2249 6e76 616c 6964 2069  tion(f"Invalid i
+0000df50: 6d70 6f72 7420 7363 6865 6475 6c65 3a20  mport schedule: 
+0000df60: 277b 6372 6f6e 7d27 2e20 5661 6c69 6420  '{cron}'. Valid 
+0000df70: 7661 6c75 6573 2061 7265 3a20 7b76 616c  values are: {val
+0000df80: 6964 5f76 616c 7565 737d 2229 0a0a 2020  id_values}")..  
+0000df90: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000dfa0: 2063 726f 6e20 3d3d 204f 4e5f 4445 4d41   cron == ON_DEMA
+0000dfb0: 4e44 5f43 524f 4e3a 0a20 2020 2020 2020  ND_CRON:.       
+0000dfc0: 2020 2020 2020 2020 2020 2020 2069 6d70               imp
+0000dfd0: 6f72 745f 7061 7261 6d73 5b22 696d 706f  ort_params["impo
+0000dfe0: 7274 5f73 6368 6564 756c 6522 5d20 3d20  rt_schedule"] = 
+0000dff0: 4f4e 5f44 454d 414e 445f 4352 4f4e 5f45  ON_DEMAND_CRON_E
+0000e000: 5850 4543 5445 445f 4259 5f54 4845 5f41  XPECTED_BY_THE_A
+0000e010: 5049 0a20 2020 2020 2020 2020 2020 2020  PI.             
+0000e020: 2020 2069 6620 6372 6f6e 203d 3d20 4155     if cron == AU
+0000e030: 544f 5f43 524f 4e20 616e 6420 6375 7272  TO_CRON and curr
+0000e040: 656e 745f 7773 3a0a 2020 2020 2020 2020  ent_ws:.        
+0000e050: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0000e060: 7370 6163 6573 203d 2028 6177 6169 7420  spaces = (await 
+0000e070: 7462 5f63 6c69 656e 742e 7573 6572 5f77  tb_client.user_w
+0000e080: 6f72 6b73 7061 6365 7328 2929 2e67 6574  orkspaces()).get
+0000e090: 2822 776f 726b 7370 6163 6573 222c 205b  ("workspaces", [
+0000e0a0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+0000e0b0: 2020 2020 2020 2072 6174 655f 6c69 6d69         rate_limi
+0000e0c0: 7473 3a20 4469 6374 5b73 7472 2c20 4469  ts: Dict[str, Di
+0000e0d0: 6374 5b73 7472 2c20 696e 745d 5d20 3d20  ct[str, int]] = 
+0000e0e0: 6e65 7874 280a 2020 2020 2020 2020 2020  next(.          
+0000e0f0: 2020 2020 2020 2020 2020 2020 2020 2877                (w
+0000e100: 2e67 6574 2822 7261 7465 5f6c 696d 6974  .get("rate_limit
+0000e110: 7322 2c20 7b7d 2920 666f 7220 7720 696e  s", {}) for w in
+0000e120: 2077 6f72 6b73 7061 6365 7320 6966 2077   workspaces if w
+0000e130: 5b22 6964 225d 203d 3d20 6375 7272 656e  ["id"] == curren
+0000e140: 745f 7773 5b22 6964 225d 292c 207b 7d0a  t_ws["id"]), {}.
+0000e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e160: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000e170: 2020 2020 2020 2020 2020 7065 7269 6f64            period
+0000e180: 3a20 696e 7420 3d20 7261 7465 5f6c 696d  : int = rate_lim
+0000e190: 6974 732e 6765 7428 2261 7069 5f64 6174  its.get("api_dat
+0000e1a0: 6173 6f75 7263 6573 5f63 7265 6174 655f  asources_create_
+0000e1b0: 6170 7065 6e64 5f72 6570 6c61 6365 222c  append_replace",
+0000e1c0: 207b 7d29 2e67 6574 2822 7065 7269 6f64   {}).get("period
+0000e1d0: 222c 2036 3029 0a0a 2020 2020 2020 2020  ", 60)..        
+0000e1e0: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+0000e1f0: 7365 636f 6e64 735f 746f 5f63 726f 6e5f  seconds_to_cron_
+0000e200: 6578 7072 6573 7369 6f6e 2873 6563 6f6e  expression(secon
+0000e210: 6473 3a20 696e 7429 202d 3e20 7374 723a  ds: int) -> str:
+0000e220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e230: 2020 2020 2020 2020 206d 696e 7574 6573           minutes
+0000e240: 203d 2073 6563 6f6e 6473 202f 2f20 3630   = seconds // 60
+0000e250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e260: 2020 2020 2020 2020 2068 6f75 7273 203d           hours =
+0000e270: 206d 696e 7574 6573 202f 2f20 3630 0a20   minutes // 60. 
+0000e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e290: 2020 2020 2020 2064 6179 7320 3d20 686f         days = ho
+0000e2a0: 7572 7320 2f2f 2032 340a 2020 2020 2020  urs // 24.      
+0000e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2c0: 2020 6966 2064 6179 7320 3e20 303a 0a20    if days > 0:. 
+0000e2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000e2f0: 6e20 6622 3020 3020 2a2f 7b64 6179 737d  n f"0 0 */{days}
+0000e300: 202a 202a 220a 2020 2020 2020 2020 2020   * *".          
+0000e310: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000e320: 2068 6f75 7273 203e 2030 3a0a 2020 2020   hours > 0:.    
+0000e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e340: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0000e350: 2230 202a 2f7b 686f 7572 737d 202a 202a  "0 */{hours} * *
+0000e360: 202a 220a 2020 2020 2020 2020 2020 2020   *".            
+0000e370: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+0000e380: 696e 7574 6573 203e 2030 3a0a 2020 2020  inutes > 0:.    
+0000e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e3a0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0000e3b0: 222a 2f7b 6d69 6e75 7465 737d 202a 202a  "*/{minutes} * *
+0000e3c0: 202a 202a 220a 2020 2020 2020 2020 2020   * *".          
+0000e3d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000e3e0: 7475 726e 2066 222a 2f7b 7365 636f 6e64  turn f"*/{second
+0000e3f0: 737d 202a 202a 202a 202a 220a 0a20 2020  s} * * * *"..   
+0000e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e410: 2069 6d70 6f72 745f 7061 7261 6d73 5b22   import_params["
+0000e420: 696d 706f 7274 5f73 6368 6564 756c 6522  import_schedule"
+0000e430: 5d20 3d20 7365 636f 6e64 735f 746f 5f63  ] = seconds_to_c
+0000e440: 726f 6e5f 6578 7072 6573 7369 6f6e 2870  ron_expression(p
+0000e450: 6572 696f 6429 0a0a 2020 2020 2020 2020  eriod)..        
+0000e460: 2020 2020 2320 496e 636c 7564 6520 616c      # Include al
+0000e470: 6c20 696d 706f 7274 5f20 7061 7261 6d65  l import_ parame
+0000e480: 7465 7273 2069 6e20 7468 6520 6461 7461  ters in the data
+0000e490: 736f 7572 6365 2070 6172 616d 730a 2020  source params.  
+0000e4a0: 2020 2020 2020 2020 2020 7061 7261 6d73            params
+0000e4b0: 2e75 7064 6174 6528 696d 706f 7274 5f70  .update(import_p
+0000e4c0: 6172 616d 7329 0a0a 2020 2020 2020 2020  arams)..        
+0000e4d0: 2020 2020 2320 5375 6273 7469 7475 7465      # Substitute
+0000e4e0: 2074 6865 2069 6d70 6f72 7420 7061 7261   the import para
+0000e4f0: 6d65 7465 7273 2077 6974 6820 7468 6520  meters with the 
+0000e500: 6f6e 6573 2075 7365 6420 6279 2074 6865  ones used by the
+0000e510: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+0000e520: 6d70 6f72 7420 4150 493a 0a20 2020 2020  mport API:.     
+0000e530: 2020 2020 2020 2023 202d 2049 6620 616e         # - If an
+0000e540: 2069 6d70 6f72 7420 7061 7261 6d65 7465   import paramete
+0000e550: 7220 6973 206e 6f74 2070 7265 7365 6e74  r is not present
+0000e560: 2061 6e64 2074 6865 7265 2773 2061 2064   and there's a d
+0000e570: 6566 6175 6c74 0a20 2020 2020 2020 2020  efault.         
+0000e580: 2020 2023 2020 2076 616c 7565 2c20 7573     #   value, us
+0000e590: 6520 7468 6520 6465 6661 756c 7420 7661  e the default va
+0000e5a0: 6c75 652e 0a20 2020 2020 2020 2020 2020  lue..           
+0000e5b0: 2023 202d 2049 6620 7468 6520 7265 7375   # - If the resu
+0000e5c0: 6c74 696e 6720 7661 6c75 6520 6973 204e  lting value is N
+0000e5d0: 6f6e 652c 2064 6f20 6e6f 7420 6164 6420  one, do not add 
+0000e5e0: 7468 6520 7061 7261 6d65 7465 722e 0a20  the parameter.. 
+0000e5f0: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+0000e600: 2020 2020 2020 2020 2023 204e 6f74 653a           # Note:
+0000e610: 2061 6e79 2075 6e6b 6e6f 776e 2069 6d70   any unknown imp
+0000e620: 6f72 745f 2070 6172 616d 6574 6572 2069  ort_ parameter i
+0000e630: 7320 6c65 6176 6564 2061 7320 6973 2e0a  s leaved as is..
+0000e640: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000e650: 6b65 7920 696e 2049 6d70 6f72 7452 6570  key in ImportRep
+0000e660: 6c61 6365 6d65 6e74 732e 6765 745f 6461  lacements.get_da
+0000e670: 7461 6669 6c65 5f70 6172 616d 6574 6572  tafile_parameter
+0000e680: 5f6b 6579 7328 293a 0a20 2020 2020 2020  _keys():.       
+0000e690: 2020 2020 2020 2020 2072 6570 6c61 6365           replace
+0000e6a0: 6d65 6e74 2c20 6465 6661 756c 745f 7661  ment, default_va
+0000e6b0: 6c75 6520 3d20 496d 706f 7274 5265 706c  lue = ImportRepl
+0000e6c0: 6163 656d 656e 7473 2e67 6574 5f61 7069  acements.get_api
+0000e6d0: 5f70 6172 616d 5f66 6f72 5f64 6174 6166  _param_for_dataf
+0000e6e0: 696c 655f 7061 7261 6d28 7365 7276 6963  ile_param(servic
+0000e6f0: 652c 206b 6579 290a 2020 2020 2020 2020  e, key).        
+0000e700: 2020 2020 2020 2020 6966 206e 6f74 2072          if not r
+0000e710: 6570 6c61 6365 6d65 6e74 3a0a 2020 2020  eplacement:.    
+0000e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e730: 636f 6e74 696e 7565 2020 2320 5765 2073  continue  # We s
+0000e740: 686f 756c 6420 6e6f 7420 7265 6163 6820  hould not reach 
+0000e750: 7468 6973 206e 6576 6572 2c20 6275 7420  this never, but 
+0000e760: 6a75 7374 2069 6e20 6361 7365 2e2e 2e0a  just in case....
+0000e770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e780: 2076 616c 7565 3a20 416e 790a 2020 2020   value: Any.    
+0000e790: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0000e7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e7b0: 2020 2020 2076 616c 7565 203d 2070 6172       value = par
+0000e7c0: 616d 735b 6b65 795d 0a20 2020 2020 2020  ams[key].       
+0000e7d0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+0000e7e0: 2070 6172 616d 735b 6b65 795d 0a20 2020   params[key].   
+0000e7f0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0000e800: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+0000e810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e820: 2020 7661 6c75 6520 3d20 6465 6661 756c    value = defaul
+0000e830: 745f 7661 6c75 650a 0a20 2020 2020 2020  t_value..       
+0000e840: 2020 2020 2020 2020 2069 6620 7661 6c75           if valu
+0000e850: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000e860: 2020 2020 2020 2070 6172 616d 735b 7265         params[re
+0000e870: 706c 6163 656d 656e 745d 203d 2076 616c  placement] = val
+0000e880: 7565 0a0a 2020 2020 2020 2020 6966 2022  ue..        if "
+0000e890: 6b61 666b 615f 636f 6e6e 6563 7469 6f6e  kafka_connection
+0000e8a0: 5f6e 616d 6522 2069 6e20 6e6f 6465 3a0a  _name" in node:.
+0000e8b0: 2020 2020 2020 2020 2020 2020 6b61 666b              kafk
+0000e8c0: 615f 7061 7261 6d73 203d 2061 7761 6974  a_params = await
+0000e8d0: 2067 6574 5f6b 6166 6b61 5f70 6172 616d   get_kafka_param
+0000e8e0: 7328 6e6f 6465 290a 2020 2020 2020 2020  s(node).        
+0000e8f0: 2020 2020 7061 7261 6d73 2e75 7064 6174      params.updat
+0000e900: 6528 6b61 666b 615f 7061 7261 6d73 290a  e(kafka_params).
+0000e910: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+0000e920: 7061 7261 6d73 5b22 666f 726d 6174 225d  params["format"]
+0000e930: 0a0a 2020 2020 2020 2020 6966 2022 7461  ..        if "ta
+0000e940: 6773 2220 696e 206e 6f64 653a 0a20 2020  gs" in node:.   
+0000e950: 2020 2020 2020 2020 2074 6167 7320 3d20           tags = 
+0000e960: 7b6b 3a20 765b 305d 2066 6f72 206b 2c20  {k: v[0] for k, 
+0000e970: 7620 696e 2075 726c 6c69 622e 7061 7273  v in urllib.pars
+0000e980: 652e 7061 7273 655f 7173 286e 6f64 655b  e.parse_qs(node[
+0000e990: 2274 6167 7322 5d29 2e69 7465 6d73 2829  "tags"]).items()
+0000e9a0: 7d0a 2020 2020 2020 2020 2020 2020 7061  }.            pa
+0000e9b0: 7261 6d73 2e75 7064 6174 6528 7461 6773  rams.update(tags
+0000e9c0: 290a 0a20 2020 2020 2020 2072 6573 6f75  )..        resou
+0000e9d0: 7263 6573 3a20 4c69 7374 5b44 6963 745b  rces: List[Dict[
+0000e9e0: 7374 722c 2041 6e79 5d5d 203d 205b 5d0a  str, Any]] = [].
+0000e9f0: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
+0000ea00: 6573 2e61 7070 656e 6428 0a20 2020 2020  es.append(.     
+0000ea10: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0000ea20: 2020 2020 2020 2020 2022 7265 736f 7572           "resour
+0000ea30: 6365 223a 2022 6461 7461 736f 7572 6365  ce": "datasource
+0000ea40: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+0000ea50: 2020 2020 2272 6573 6f75 7263 655f 6e61      "resource_na
+0000ea60: 6d65 223a 206e 616d 652c 0a20 2020 2020  me": name,.     
+0000ea70: 2020 2020 2020 2020 2020 2022 7665 7273             "vers
+0000ea80: 696f 6e22 3a20 646f 632e 7665 7273 696f  ion": doc.versio
+0000ea90: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+0000eaa0: 2020 2022 7061 7261 6d73 223a 2070 6172     "params": par
+0000eab0: 616d 732c 0a20 2020 2020 2020 2020 2020  ams,.           
+0000eac0: 2020 2020 2022 6669 6c65 6e61 6d65 223a       "filename":
+0000ead0: 2066 696c 656e 616d 652c 0a20 2020 2020   filename,.     
+0000eae0: 2020 2020 2020 2020 2020 2022 6b65 7973             "keys
+0000eaf0: 223a 2064 6f63 2e6b 6579 732c 0a20 2020  ": doc.keys,.   
+0000eb00: 2020 2020 2020 2020 2020 2020 2022 6465               "de
+0000eb10: 7073 223a 2064 6570 732c 0a20 2020 2020  ps": deps,.     
+0000eb20: 2020 2020 2020 2020 2020 2022 746f 6b65             "toke
+0000eb30: 6e73 223a 2064 6f63 2e74 6f6b 656e 732c  ns": doc.tokens,
+0000eb40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eb50: 2022 7368 6172 6564 5f77 6974 6822 3a20   "shared_with": 
+0000eb60: 646f 632e 7368 6172 6564 5f77 6974 682c  doc.shared_with,
+0000eb70: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0000eb80: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000eb90: 2020 2320 6765 6e65 7261 7465 2065 7874    # generate ext
+0000eba0: 7261 2072 6573 6f75 7263 6573 2069 6e20  ra resources in 
+0000ebb0: 6361 7365 206f 6620 7468 6520 6b65 790a  case of the key.
+0000ebc0: 2020 2020 2020 2020 6966 2064 6f63 2e6b          if doc.k
+0000ebd0: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
+0000ebe0: 2066 6f72 206b 2069 6e20 646f 632e 6b65   for k in doc.ke
+0000ebf0: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+0000ec00: 2020 2020 7265 736f 7572 6365 7320 2b3d      resources +=
+0000ec10: 2067 656e 6572 6174 655f 7265 736f 7572   generate_resour
+0000ec20: 6365 5f66 6f72 5f6b 6579 286b 5b22 636f  ce_for_key(k["co
+0000ec30: 6c75 6d6e 225d 2c20 6e61 6d65 2c20 7061  lumn"], name, pa
+0000ec40: 7261 6d73 5b22 7363 6865 6d61 225d 2c20  rams["schema"], 
+0000ec50: 7665 7273 696f 6e2c 2072 6573 5f6e 616d  version, res_nam
+0000ec60: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0000ec70: 2020 2023 2073 6574 2064 6572 6976 6564     # set derived
+0000ec80: 2072 6573 6f75 7263 6573 2076 6572 7369   resources versi
+0000ec90: 6f6e 2074 6865 2073 616d 6520 7468 6520  on the same the 
+0000eca0: 7061 7265 6e74 0a20 2020 2020 2020 2020  parent.         
+0000ecb0: 2020 2020 2020 2066 6f72 2078 2069 6e20         for x in 
+0000ecc0: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
+0000ecd0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+0000ece0: 5b22 7665 7273 696f 6e22 5d20 3d20 646f  ["version"] = do
+0000ecf0: 632e 7665 7273 696f 6e0a 0a20 2020 2020  c.version..     
+0000ed00: 2020 2072 6574 7572 6e20 7265 736f 7572     return resour
+0000ed10: 6365 730a 0a20 2020 2065 6c69 6620 4461  ces..    elif Da
+0000ed20: 7461 4669 6c65 4578 7465 6e73 696f 6e73  taFileExtensions
+0000ed30: 2e50 4950 4520 696e 2066 696c 656e 616d  .PIPE in filenam
+0000ed40: 653a 0a20 2020 2020 2020 2064 6f63 203d  e:.        doc =
+0000ed50: 2070 6172 7365 5f70 6970 6528 6669 6c65   parse_pipe(file
+0000ed60: 6e61 6d65 290a 2020 2020 2020 2020 7665  name).        ve
+0000ed70: 7273 696f 6e20 3d20 6622 5f5f 767b 646f  rsion = f"__v{do
+0000ed80: 632e 7665 7273 696f 6e7d 2220 6966 2064  c.version}" if d
+0000ed90: 6f63 2e76 6572 7369 6f6e 2069 7320 6e6f  oc.version is no
+0000eda0: 7420 4e6f 6e65 2065 6c73 6520 2222 0a20  t None else "". 
+0000edb0: 2020 2020 2020 206e 616d 6520 3d20 6f73         name = os
+0000edc0: 2e70 6174 682e 6261 7365 6e61 6d65 2866  .path.basename(f
+0000edd0: 696c 656e 616d 6529 2e73 706c 6974 2822  ilename).split("
+0000ede0: 2e22 295b 305d 0a20 2020 2020 2020 2064  .")[0].        d
+0000edf0: 6573 6372 6970 7469 6f6e 203d 2064 6f63  escription = doc
+0000ee00: 2e64 6573 6372 6970 7469 6f6e 2069 6620  .description if 
+0000ee10: 646f 632e 6465 7363 7269 7074 696f 6e20  doc.description 
+0000ee20: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0000ee30: 2022 220a 0a20 2020 2020 2020 2064 6570   ""..        dep
+0000ee40: 7320 3d20 5b5d 0a20 2020 2020 2020 206e  s = [].        n
+0000ee50: 6f64 6573 3a20 4c69 7374 5b44 6963 745b  odes: List[Dict[
+0000ee60: 7374 722c 2041 6e79 5d5d 203d 205b 5d0a  str, Any]] = [].
+0000ee70: 0a20 2020 2020 2020 2066 6f72 206e 6f64  .        for nod
+0000ee80: 6520 696e 2064 6f63 2e6e 6f64 6573 3a0a  e in doc.nodes:.
+0000ee90: 2020 2020 2020 2020 2020 2020 7371 6c20              sql 
+0000eea0: 3d20 6e6f 6465 5b22 7371 6c22 5d0a 2020  = node["sql"].  
+0000eeb0: 2020 2020 2020 2020 2020 6e6f 6465 5f74            node_t
+0000eec0: 7970 6520 3d20 6e6f 6465 2e67 6574 2822  ype = node.get("
+0000eed0: 7479 7065 222c 2022 7374 616e 6461 7264  type", "standard
+0000eee0: 2229 2e6c 6f77 6572 2829 0a20 2020 2020  ").lower().     
+0000eef0: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
+0000ef00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0000ef10: 2020 226e 616d 6522 3a20 6e6f 6465 5b22    "name": node["
+0000ef20: 6e61 6d65 225d 2c0a 2020 2020 2020 2020  name"],.        
+0000ef30: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
+0000ef40: 6e6f 6465 5f74 7970 652c 0a20 2020 2020  node_type,.     
+0000ef50: 2020 2020 2020 2020 2020 2022 6465 7363             "desc
+0000ef60: 7269 7074 696f 6e22 3a20 6e6f 6465 2e67  ription": node.g
+0000ef70: 6574 2822 6465 7363 7269 7074 696f 6e22  et("description"
+0000ef80: 2c20 2222 292c 0a20 2020 2020 2020 2020  , ""),.         
+0000ef90: 2020 2020 2020 2022 7461 7267 6574 5f64         "target_d
+0000efa0: 6174 6173 6f75 7263 6522 3a20 6e6f 6465  atasource": node
+0000efb0: 2e67 6574 2822 7461 7267 6574 5f64 6174  .get("target_dat
+0000efc0: 6173 6f75 7263 6522 2c20 4e6f 6e65 292c  asource", None),
+0000efd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000efe0: 2022 636f 7079 5f73 6368 6564 756c 6522   "copy_schedule"
+0000eff0: 3a20 6e6f 6465 2e67 6574 2843 6f70 7950  : node.get(CopyP
+0000f000: 6172 616d 6574 6572 732e 434f 5059 5f53  arameters.COPY_S
+0000f010: 4348 4544 554c 452c 204e 6f6e 6529 2c0a  CHEDULE, None),.
+0000f020: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0000f030: 2020 2020 2020 2020 2020 2069 735f 6578             is_ex
+0000f040: 706f 7274 5f6e 6f64 6520 3d20 4578 706f  port_node = Expo
+0000f050: 7274 5265 706c 6163 656d 656e 7473 2e69  rtReplacements.i
+0000f060: 735f 6578 706f 7274 5f6e 6f64 6528 6e6f  s_export_node(no
+0000f070: 6465 290a 2020 2020 2020 2020 2020 2020  de).            
+0000f080: 6578 706f 7274 5f70 6172 616d 7320 3d20  export_params = 
+0000f090: 4578 706f 7274 5265 706c 6163 656d 656e  ExportReplacemen
+0000f0a0: 7473 2e67 6574 5f70 6172 616d 735f 6672  ts.get_params_fr
+0000f0b0: 6f6d 5f64 6174 6166 696c 6528 6e6f 6465  om_datafile(node
+0000f0c0: 2920 6966 2069 735f 6578 706f 7274 5f6e  ) if is_export_n
+0000f0d0: 6f64 6520 656c 7365 204e 6f6e 650a 0a20  ode else None.. 
+0000f0e0: 2020 2020 2020 2020 2020 2073 716c 203d             sql =
+0000f0f0: 2073 716c 2e73 7472 6970 2829 0a20 2020   sql.strip().   
+0000f100: 2020 2020 2020 2020 2069 735f 7465 6d70           is_temp
+0000f110: 6c61 7465 203d 2046 616c 7365 0a20 2020  late = False.   
+0000f120: 2020 2020 2020 2020 2069 6620 7371 6c5b           if sql[
+0000f130: 305d 203d 3d20 2225 223a 0a20 2020 2020  0] == "%":.     
+0000f140: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0000f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f160: 2020 2020 7371 6c5f 7265 6e64 6572 6564      sql_rendered
+0000f170: 2c20 5f20 3d20 7265 6e64 6572 5f73 716c  , _ = render_sql
+0000f180: 5f74 656d 706c 6174 6528 7371 6c5b 313a  _template(sql[1:
+0000f190: 5d2c 2074 6573 745f 6d6f 6465 3d54 7275  ], test_mode=Tru
+0000f1a0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0000f1b0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0000f1c0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+0000f1d0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000f1e0: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
+0000f1f0: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
+0000f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f210: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
+0000f220: 722e 6572 726f 725f 7061 7273 696e 675f  r.error_parsing_
+0000f230: 6e6f 6465 286e 6f64 653d 6e6f 6465 5b22  node(node=node["
+0000f240: 6e61 6d65 225d 2c20 7069 7065 3d6e 616d  name"], pipe=nam
+0000f250: 652c 2065 7272 6f72 3d73 7472 2865 2929  e, error=str(e))
+0000f260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f270: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000f280: 2020 2020 2020 2069 735f 7465 6d70 6c61         is_templa
+0000f290: 7465 203d 2054 7275 650a 2020 2020 2020  te = True.      
+0000f2a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000f2b0: 2020 2020 2020 2020 2020 2020 7371 6c5f              sql_
+0000f2c0: 7265 6e64 6572 6564 203d 2073 716c 0a0a  rendered = sql..
+0000f2d0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0000f2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f2f0: 2064 6570 656e 6465 6e63 6965 7320 3d20   dependencies = 
+0000f300: 6177 6169 7420 7462 5f63 6c69 656e 742e  await tb_client.
+0000f310: 7371 6c5f 6765 745f 7573 6564 5f74 6162  sql_get_used_tab
+0000f320: 6c65 7328 7371 6c5f 7265 6e64 6572 6564  les(sql_rendered
+0000f330: 2c20 7261 6973 696e 673d 5472 7565 290a  , raising=True).
+0000f340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f350: 6465 7073 202b 3d20 5b74 2066 6f72 2074  deps += [t for t
+0000f360: 2069 6e20 6465 7065 6e64 656e 6369 6573   in dependencies
+0000f370: 2069 6620 7420 6e6f 7420 696e 205b 6e5b   if t not in [n[
+0000f380: 226e 616d 6522 5d20 666f 7220 6e20 696e  "name"] for n in
+0000f390: 2064 6f63 2e6e 6f64 6573 5d5d 0a0a 2020   doc.nodes]]..  
+0000f3a0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000f3b0: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
+0000f3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f3d0: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+0000f3e0: 636b 4578 6365 7074 696f 6e28 0a20 2020  ckException(.   
+0000f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f400: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
+0000f410: 2e65 7272 6f72 5f70 6172 7369 6e67 5f6e  .error_parsing_n
+0000f420: 6f64 6528 6e6f 6465 3d6e 6f64 655b 226e  ode(node=node["n
+0000f430: 616d 6522 5d2c 2070 6970 653d 6e61 6d65  ame"], pipe=name
+0000f440: 2c20 6572 726f 723d 7374 7228 6529 290a  , error=str(e)).
+0000f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f460: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0000f470: 6620 6973 5f74 656d 706c 6174 653a 0a20  f is_template:. 
+0000f480: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000f490: 6570 7320 2b3d 2067 6574 5f75 7365 645f  eps += get_used_
+0000f4a0: 7461 626c 6573 5f69 6e5f 7465 6d70 6c61  tables_in_templa
+0000f4b0: 7465 2873 716c 5b31 3a5d 290a 0a20 2020  te(sql[1:])..   
+0000f4c0: 2020 2020 2020 2020 2069 735f 6e65 6974           is_neit
+0000f4d0: 6865 725f 636f 7079 5f6e 6f72 5f6d 6174  her_copy_nor_mat
+0000f4e0: 6572 6961 6c69 7a65 6420 3d20 2264 6174  erialized = "dat
+0000f4f0: 6173 6f75 7263 6522 206e 6f74 2069 6e20  asource" not in 
+0000f500: 6e6f 6465 2061 6e64 2022 7461 7267 6574  node and "target
+0000f510: 5f64 6174 6173 6f75 7263 6522 206e 6f74  _datasource" not
+0000f520: 2069 6e20 6e6f 6465 0a20 2020 2020 2020   in node.       
+0000f530: 2020 2020 2069 6620 2265 6e67 696e 6522       if "engine"
+0000f540: 2069 6e20 6e6f 6465 2061 6e64 2069 735f   in node and is_
+0000f550: 6e65 6974 6865 725f 636f 7079 5f6e 6f72  neither_copy_nor
+0000f560: 5f6d 6174 6572 6961 6c69 7a65 643a 0a20  _materialized:. 
+0000f570: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000f580: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0000f590: 2244 6566 696e 696e 6720 454e 4749 4e45  "Defining ENGINE
+0000f5a0: 206f 7074 696f 6e73 2069 6e20 6120 6e6f   options in a no
+0000f5b0: 6465 2072 6571 7569 7265 7320 6120 4441  de requires a DA
+0000f5c0: 5441 534f 5552 4345 2229 0a0a 2020 2020  TASOURCE")..    
+0000f5d0: 2020 2020 2020 2020 6966 2022 6461 7461          if "data
+0000f5e0: 736f 7572 6365 2220 696e 206e 6f64 653a  source" in node:
+0000f5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f600: 2070 6172 616d 735b 2264 6174 6173 6f75   params["datasou
+0000f610: 7263 6522 5d20 3d20 6e6f 6465 5b22 6461  rce"] = node["da
+0000f620: 7461 736f 7572 6365 225d 202b 2072 6573  tasource"] + res
+0000f630: 6f75 7263 655f 7665 7273 696f 6e73 5f73  ource_versions_s
+0000f640: 7472 696e 672e 6765 7428 6e6f 6465 5b22  tring.get(node["
+0000f650: 6461 7461 736f 7572 6365 225d 2c20 2222  datasource"], ""
+0000f660: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f670: 2020 6465 7073 202b 3d20 5b6e 6f64 655b    deps += [node[
+0000f680: 2264 6174 6173 6f75 7263 6522 5d5d 0a0a  "datasource"]]..
+0000f690: 2020 2020 2020 2020 2020 2020 6966 2022              if "
+0000f6a0: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
+0000f6b0: 6522 2069 6e20 6e6f 6465 3a0a 2020 2020  e" in node:.    
+0000f6c0: 2020 2020 2020 2020 2020 2020 7061 7261              para
+0000f6d0: 6d73 5b22 7461 7267 6574 5f64 6174 6173  ms["target_datas
+0000f6e0: 6f75 7263 6522 5d20 3d20 6e6f 6465 5b22  ource"] = node["
+0000f6f0: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
+0000f700: 6522 5d20 2b20 7265 736f 7572 6365 5f76  e"] + resource_v
+0000f710: 6572 7369 6f6e 735f 7374 7269 6e67 2e67  ersions_string.g
+0000f720: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
+0000f730: 2020 2020 2020 2020 6e6f 6465 5b22 7461          node["ta
+0000f740: 7267 6574 5f64 6174 6173 6f75 7263 6522  rget_datasource"
+0000f750: 5d2c 2022 220a 2020 2020 2020 2020 2020  ], "".          
+0000f760: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000f770: 2020 2020 2020 2020 6465 7073 202b 3d20          deps += 
+0000f780: 5b6e 6f64 655b 2274 6172 6765 745f 6461  [node["target_da
+0000f790: 7461 736f 7572 6365 225d 5d0a 0a20 2020  tasource"]]..   
+0000f7a0: 2020 2020 2020 2020 2070 6172 616d 732e           params.
+0000f7b0: 7570 6461 7465 2867 6574 5f65 6e67 696e  update(get_engin
+0000f7c0: 655f 7061 7261 6d73 286e 6f64 6529 290a  e_params(node)).
+0000f7d0: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
+0000f7e0: 2063 7265 6174 655f 7265 706c 6163 656d   create_replacem
+0000f7f0: 656e 745f 666f 725f 7265 736f 7572 6365  ent_for_resource
+0000f800: 286e 616d 653a 2073 7472 2920 2d3e 2073  (name: str) -> s
+0000f810: 7472 3a0a 2020 2020 2020 2020 2020 2020  tr:.            
+0000f820: 2020 2020 666f 7220 6f6c 645f 7773 2c20      for old_ws, 
+0000f830: 6e65 775f 7773 2069 6e20 776f 726b 7370  new_ws in worksp
+0000f840: 6163 655f 6d61 702e 6974 656d 7328 293a  ace_map.items():
+0000f850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f860: 2020 2020 206e 616d 6520 3d20 6e61 6d65       name = name
+0000f870: 2e72 6570 6c61 6365 2866 227b 6f6c 645f  .replace(f"{old_
+0000f880: 7773 7d2e 222c 2066 227b 6e65 775f 7773  ws}.", f"{new_ws
+0000f890: 7d2e 2229 0a20 2020 2020 2020 2020 2020  }.").           
+0000f8a0: 2020 2020 2072 6574 7572 6e20 6e61 6d65       return name
+0000f8b0: 202b 2072 6573 6f75 7263 655f 7665 7273   + resource_vers
+0000f8c0: 696f 6e73 5f73 7472 696e 672e 6765 7428  ions_string.get(
+0000f8d0: 6e61 6d65 2c20 2222 290a 0a20 2020 2020  name, "")..     
+0000f8e0: 2020 2020 2020 2072 6570 6c61 6365 6d65         replaceme
+0000f8f0: 6e74 7320 3d20 7b0a 2020 2020 2020 2020  nts = {.        
+0000f900: 2020 2020 2020 2020 783a 2063 7265 6174          x: creat
+0000f910: 655f 7265 706c 6163 656d 656e 745f 666f  e_replacement_fo
+0000f920: 725f 7265 736f 7572 6365 2878 2920 666f  r_resource(x) fo
+0000f930: 7220 7820 696e 2064 6570 7320 6966 2078  r x in deps if x
+0000f940: 206e 6f74 2069 6e20 5b6e 5b22 6e61 6d65   not in [n["name
+0000f950: 225d 2066 6f72 206e 2069 6e20 646f 632e  "] for n in doc.
+0000f960: 6e6f 6465 735d 0a20 2020 2020 2020 2020  nodes].         
+0000f970: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+0000f980: 2020 2320 4649 584d 453a 2049 6465 616c    # FIXME: Ideal
+0000f990: 6c79 2077 6520 7368 6f75 6c64 2075 7365  ly we should use
+0000f9a0: 2061 7761 6974 2074 625f 636c 6965 6e74   await tb_client
+0000f9b0: 2e72 6570 6c61 6365 5f74 6162 6c65 7328  .replace_tables(
+0000f9c0: 7371 6c2c 2072 6570 6c61 6365 6d65 6e74  sql, replacement
+0000f9d0: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
+0000f9e0: 6f72 206f 6c64 2c20 6e65 7720 696e 2072  or old, new in r
+0000f9f0: 6570 6c61 6365 6d65 6e74 732e 6974 656d  eplacements.item
+0000fa00: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0000fa10: 2020 2020 2073 716c 203d 2072 652e 7375       sql = re.su
+0000fa20: 6228 2228 5b5c 7420 5c5c 6e27 5d2b 7c5e  b("([\t \\n']+|^
+0000fa30: 2922 202b 206f 6c64 202b 2022 285b 5c74  )" + old + "([\t
+0000fa40: 205c 5c6e 275c 5c29 5d2b 7c24 2922 2c20   \\n'\\)]+|$)", 
+0000fa50: 225c 5c31 2220 2b20 6e65 7720 2b20 225c  "\\1" + new + "\
+0000fa60: 5c32 222c 2073 716c 290a 0a20 2020 2020  \2", sql)..     
+0000fa70: 2020 2020 2020 2069 6620 2274 6167 7322         if "tags"
+0000fa80: 2069 6e20 6e6f 6465 3a0a 2020 2020 2020   in node:.      
+0000fa90: 2020 2020 2020 2020 2020 7461 6773 203d            tags =
+0000faa0: 207b 6b3a 2076 5b30 5d20 666f 7220 6b2c   {k: v[0] for k,
+0000fab0: 2076 2069 6e20 7572 6c6c 6962 2e70 6172   v in urllib.par
+0000fac0: 7365 2e70 6172 7365 5f71 7328 6e6f 6465  se.parse_qs(node
+0000fad0: 5b22 7461 6773 225d 292e 6974 656d 7328  ["tags"]).items(
+0000fae0: 297d 0a20 2020 2020 2020 2020 2020 2020  )}.             
+0000faf0: 2020 2070 6172 616d 732e 7570 6461 7465     params.update
+0000fb00: 2874 6167 7329 0a0a 2020 2020 2020 2020  (tags)..        
+0000fb10: 2020 2020 6e6f 6465 732e 6170 7065 6e64      nodes.append
+0000fb20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000fb30: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0000fb40: 2020 2020 2020 2020 2273 716c 223a 2073          "sql": s
+0000fb50: 716c 2c0a 2020 2020 2020 2020 2020 2020  ql,.            
+0000fb60: 2020 2020 2020 2020 2270 6172 616d 7322          "params"
+0000fb70: 3a20 7061 7261 6d73 2c0a 2020 2020 2020  : params,.      
+0000fb80: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+0000fb90: 7870 6f72 745f 7061 7261 6d73 223a 2065  xport_params": e
+0000fba0: 7870 6f72 745f 7061 7261 6d73 2c0a 2020  xport_params,.  
+0000fbb0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0000fbc0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0000fbd0: 2020 2020 2020 2072 6574 7572 6e20 5b0a         return [.
+0000fbe0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0000fbf0: 2020 2020 2020 2020 2020 2020 2020 2272                "r
+0000fc00: 6573 6f75 7263 6522 3a20 2270 6970 6573  esource": "pipes
+0000fc10: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000fc20: 2020 2022 7265 736f 7572 6365 5f6e 616d     "resource_nam
+0000fc30: 6522 3a20 6e61 6d65 2c0a 2020 2020 2020  e": name,.      
+0000fc40: 2020 2020 2020 2020 2020 2276 6572 7369            "versi
+0000fc50: 6f6e 223a 2064 6f63 2e76 6572 7369 6f6e  on": doc.version
+0000fc60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000fc70: 2020 2266 696c 656e 616d 6522 3a20 6669    "filename": fi
+0000fc80: 6c65 6e61 6d65 2c0a 2020 2020 2020 2020  lename,.        
+0000fc90: 2020 2020 2020 2020 226e 616d 6522 3a20          "name": 
+0000fca0: 6e61 6d65 202b 2076 6572 7369 6f6e 2c0a  name + version,.
+0000fcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fcc0: 226e 6f64 6573 223a 206e 6f64 6573 2c0a  "nodes": nodes,.
+0000fcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fce0: 2264 6570 7322 3a20 5b78 2066 6f72 2078  "deps": [x for x
+0000fcf0: 2069 6e20 7365 7428 6465 7073 295d 2c0a   in set(deps)],.
+0000fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd10: 2274 6f6b 656e 7322 3a20 646f 632e 746f  "tokens": doc.to
+0000fd20: 6b65 6e73 2c0a 2020 2020 2020 2020 2020  kens,.          
+0000fd30: 2020 2020 2020 2264 6573 6372 6970 7469        "descripti
+0000fd40: 6f6e 223a 2064 6573 6372 6970 7469 6f6e  on": description
+0000fd50: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+0000fd60: 2020 2020 2020 2020 5d0a 2020 2020 656c          ].    el
+0000fd70: 6966 2044 6174 6146 696c 6545 7874 656e  if DataFileExten
+0000fd80: 7369 6f6e 732e 544f 4b45 4e20 696e 2066  sions.TOKEN in f
+0000fd90: 696c 656e 616d 653a 0a20 2020 2020 2020  ilename:.       
+0000fda0: 2064 6f63 203d 2070 6172 7365 5f74 6f6b   doc = parse_tok
+0000fdb0: 656e 2866 696c 656e 616d 6529 0a20 2020  en(filename).   
+0000fdc0: 2020 2020 206e 616d 6520 3d20 6f73 2e70       name = os.p
+0000fdd0: 6174 682e 6261 7365 6e61 6d65 2866 696c  ath.basename(fil
+0000fde0: 656e 616d 6529 2e73 706c 6974 2844 6174  ename).split(Dat
+0000fdf0: 6146 696c 6545 7874 656e 7369 6f6e 732e  aFileExtensions.
+0000fe00: 544f 4b45 4e29 5b30 5d0a 2020 2020 2020  TOKEN)[0].      
+0000fe10: 2020 6465 7363 7269 7074 696f 6e20 3d20    description = 
+0000fe20: 646f 632e 6465 7363 7269 7074 696f 6e20  doc.description 
+0000fe30: 6f72 2022 220a 2020 2020 2020 2020 7665  or "".        ve
+0000fe40: 7273 696f 6e20 3d20 6622 5f5f 767b 646f  rsion = f"__v{do
+0000fe50: 632e 7665 7273 696f 6e7d 2220 6966 2064  c.version}" if d
+0000fe60: 6f63 2e76 6572 7369 6f6e 2069 7320 6e6f  oc.version is no
+0000fe70: 7420 4e6f 6e65 2065 6c73 6520 2222 0a20  t None else "". 
+0000fe80: 2020 2020 2020 2073 636f 7065 7320 3d20         scopes = 
+0000fe90: 646f 632e 6e6f 6465 7320 6f72 205b 5d0a  doc.nodes or [].
+0000fea0: 2020 2020 2020 2020 7265 7475 726e 205b          return [
+0000feb0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0000fec0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000fed0: 7265 736f 7572 6365 223a 2022 746f 6b65  resource": "toke
+0000fee0: 6e73 222c 0a20 2020 2020 2020 2020 2020  ns",.           
+0000fef0: 2020 2020 2022 7265 736f 7572 6365 5f6e       "resource_n
+0000ff00: 616d 6522 3a20 6e61 6d65 2c0a 2020 2020  ame": name,.    
+0000ff10: 2020 2020 2020 2020 2020 2020 2276 6572              "ver
+0000ff20: 7369 6f6e 223a 2064 6f63 2e76 6572 7369  sion": doc.versi
+0000ff30: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
+0000ff40: 2020 2020 2266 696c 656e 616d 6522 3a20      "filename": 
+0000ff50: 6669 6c65 6e61 6d65 2c0a 2020 2020 2020  filename,.      
+0000ff60: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
+0000ff70: 3a20 6e61 6d65 202b 2076 6572 7369 6f6e  : name + version
+0000ff80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ff90: 2020 2273 636f 7065 7322 3a20 7363 6f70    "scopes": scop
+0000ffa0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000ffb0: 2020 2020 2264 6573 6372 6970 7469 6f6e      "description
+0000ffc0: 223a 2064 6573 6372 6970 7469 6f6e 2c0a  ": description,.
+0000ffd0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0000ffe0: 2020 2020 2020 5d0a 2020 2020 656c 7365        ].    else
+0000fff0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00010000: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
+00010010: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
+00010020: 6167 6572 2e65 7272 6f72 5f66 696c 655f  ager.error_file_
+00010030: 6578 7465 6e73 696f 6e28 6669 6c65 6e61  extension(filena
+00010040: 6d65 3d66 696c 656e 616d 6529 290a 0a0a  me=filename))...
+00010050: 6465 6620 6675 6c6c 5f70 6174 685f 6279  def full_path_by
+00010060: 5f6e 616d 6528 0a20 2020 2066 6f6c 6465  _name(.    folde
+00010070: 723a 2073 7472 2c20 6e61 6d65 3a20 7374  r: str, name: st
+00010080: 722c 2077 6f72 6b73 7061 6365 5f6c 6962  r, workspace_lib
+00010090: 5f70 6174 6873 3a20 4f70 7469 6f6e 616c  _paths: Optional
+000100a0: 5b4c 6973 745b 5475 706c 655b 7374 722c  [List[Tuple[str,
+000100b0: 2073 7472 5d5d 5d20 3d20 4e6f 6e65 0a29   str]]] = None.)
+000100c0: 202d 3e20 4f70 7469 6f6e 616c 5b50 6174   -> Optional[Pat
+000100d0: 685d 3a0a 2020 2020 6620 3d20 5061 7468  h]:.    f = Path
+000100e0: 2866 6f6c 6465 7229 0a20 2020 2064 7320  (folder).    ds 
+000100f0: 3d20 6e61 6d65 202b 2022 2e64 6174 6173  = name + ".datas
+00010100: 6f75 7263 6522 0a20 2020 2069 6620 6f73  ource".    if os
+00010110: 2e70 6174 682e 6973 6669 6c65 286f 732e  .path.isfile(os.
+00010120: 7061 7468 2e6a 6f69 6e28 666f 6c64 6572  path.join(folder
+00010130: 2c20 6473 2929 3a0a 2020 2020 2020 2020  , ds)):.        
+00010140: 7265 7475 726e 2066 202f 2064 730a 2020  return f / ds.  
+00010150: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
+00010160: 696c 6528 6620 2f20 2264 6174 6173 6f75  ile(f / "datasou
+00010170: 7263 6573 2220 2f20 6473 293a 0a20 2020  rces" / ds):.   
+00010180: 2020 2020 2072 6574 7572 6e20 6620 2f20       return f / 
+00010190: 2264 6174 6173 6f75 7263 6573 2220 2f20  "datasources" / 
+000101a0: 6473 0a0a 2020 2020 7069 7065 203d 206e  ds..    pipe = n
+000101b0: 616d 6520 2b20 222e 7069 7065 220a 2020  ame + ".pipe".  
+000101c0: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
+000101d0: 696c 6528 6f73 2e70 6174 682e 6a6f 696e  ile(os.path.join
+000101e0: 2866 6f6c 6465 722c 2070 6970 6529 293a  (folder, pipe)):
+000101f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010200: 6620 2f20 7069 7065 0a0a 2020 2020 6966  f / pipe..    if
+00010210: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+00010220: 6620 2f20 2265 6e64 706f 696e 7473 2220  f / "endpoints" 
+00010230: 2f20 7069 7065 293a 0a20 2020 2020 2020  / pipe):.       
+00010240: 2072 6574 7572 6e20 6620 2f20 2265 6e64   return f / "end
+00010250: 706f 696e 7473 2220 2f20 7069 7065 0a0a  points" / pipe..
+00010260: 2020 2020 6966 206f 732e 7061 7468 2e69      if os.path.i
+00010270: 7366 696c 6528 6620 2f20 2270 6970 6573  sfile(f / "pipes
+00010280: 2220 2f20 7069 7065 293a 0a20 2020 2020  " / pipe):.     
+00010290: 2020 2072 6574 7572 6e20 6620 2f20 2270     return f / "p
+000102a0: 6970 6573 2220 2f20 7069 7065 0a0a 2020  ipes" / pipe..  
+000102b0: 2020 746f 6b65 6e20 3d20 6e61 6d65 202b    token = name +
+000102c0: 2022 2e74 6f6b 656e 220a 2020 2020 6966   ".token".    if
+000102d0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+000102e0: 6620 2f20 2274 6f6b 656e 7322 202f 2074  f / "tokens" / t
+000102f0: 6f6b 656e 293a 0a20 2020 2020 2020 2072  oken):.        r
+00010300: 6574 7572 6e20 6620 2f20 2274 6f6b 656e  eturn f / "token
+00010310: 7322 202f 2074 6f6b 656e 0a0a 2020 2020  s" / token..    
+00010320: 6966 2077 6f72 6b73 7061 6365 5f6c 6962  if workspace_lib
+00010330: 5f70 6174 6873 3a0a 2020 2020 2020 2020  _paths:.        
+00010340: 666f 7220 776b 5f6e 616d 652c 2077 6b5f  for wk_name, wk_
+00010350: 7061 7468 2069 6e20 776f 726b 7370 6163  path in workspac
+00010360: 655f 6c69 625f 7061 7468 733a 0a20 2020  e_lib_paths:.   
+00010370: 2020 2020 2020 2020 2069 6620 6e61 6d65           if name
+00010380: 2e73 7461 7274 7377 6974 6828 6622 7b77  .startswith(f"{w
+00010390: 6b5f 6e61 6d65 7d2e 2229 3a0a 2020 2020  k_name}."):.    
+000103a0: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
+000103b0: 6675 6c6c 5f70 6174 685f 6279 5f6e 616d  full_path_by_nam
+000103c0: 6528 776b 5f70 6174 682c 206e 616d 652e  e(wk_path, name.
+000103d0: 7265 706c 6163 6528 6622 7b77 6b5f 6e61  replace(f"{wk_na
+000103e0: 6d65 7d2e 222c 2022 2229 290a 2020 2020  me}.", "")).    
+000103f0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00010400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010410: 2020 2020 2020 7265 7475 726e 2072 0a20        return r. 
+00010420: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+00010430: 0a64 6566 2066 696e 645f 6669 6c65 5f62  .def find_file_b
+00010440: 795f 6e61 6d65 280a 2020 2020 666f 6c64  y_name(.    fold
+00010450: 6572 3a20 7374 722c 0a20 2020 206e 616d  er: str,.    nam
+00010460: 653a 2073 7472 2c0a 2020 2020 7665 7262  e: str,.    verb
+00010470: 6f73 653a 2062 6f6f 6c20 3d20 4661 6c73  ose: bool = Fals
+00010480: 652c 0a20 2020 2069 735f 7261 773a 2062  e,.    is_raw: b
+00010490: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+000104a0: 2077 6f72 6b73 7061 6365 5f6c 6962 5f70   workspace_lib_p
+000104b0: 6174 6873 3a20 4f70 7469 6f6e 616c 5b4c  aths: Optional[L
+000104c0: 6973 745b 5475 706c 655b 7374 722c 2073  ist[Tuple[str, s
+000104d0: 7472 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020  tr]]] = None,.  
+000104e0: 2020 7265 736f 7572 6365 3a20 4f70 7469    resource: Opti
+000104f0: 6f6e 616c 5b44 6963 745d 203d 204e 6f6e  onal[Dict] = Non
+00010500: 652c 0a29 3a0a 2020 2020 6620 3d20 5061  e,.):.    f = Pa
+00010510: 7468 2866 6f6c 6465 7229 0a20 2020 2064  th(folder).    d
+00010520: 7320 3d20 6e61 6d65 202b 2022 2e64 6174  s = name + ".dat
+00010530: 6173 6f75 7263 6522 0a20 2020 2069 6620  asource".    if 
+00010540: 6f73 2e70 6174 682e 6973 6669 6c65 286f  os.path.isfile(o
+00010550: 732e 7061 7468 2e6a 6f69 6e28 666f 6c64  s.path.join(fold
+00010560: 6572 2c20 6473 2929 3a0a 2020 2020 2020  er, ds)):.      
+00010570: 2020 7265 7475 726e 2064 732c 204e 6f6e    return ds, Non
+00010580: 650a 2020 2020 6966 206f 732e 7061 7468  e.    if os.path
+00010590: 2e69 7366 696c 6528 6620 2f20 2264 6174  .isfile(f / "dat
+000105a0: 6173 6f75 7263 6573 2220 2f20 6473 293a  asources" / ds):
+000105b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000105c0: 6473 2c20 4e6f 6e65 0a0a 2020 2020 7069  ds, None..    pi
+000105d0: 7065 203d 206e 616d 6520 2b20 222e 7069  pe = name + ".pi
+000105e0: 7065 220a 2020 2020 6966 206f 732e 7061  pe".    if os.pa
+000105f0: 7468 2e69 7366 696c 6528 6f73 2e70 6174  th.isfile(os.pat
+00010600: 682e 6a6f 696e 2866 6f6c 6465 722c 2070  h.join(folder, p
+00010610: 6970 6529 293a 0a20 2020 2020 2020 2072  ipe)):.        r
+00010620: 6574 7572 6e20 7069 7065 2c20 4e6f 6e65  eturn pipe, None
+00010630: 0a0a 2020 2020 6966 206f 732e 7061 7468  ..    if os.path
+00010640: 2e69 7366 696c 6528 6620 2f20 2265 6e64  .isfile(f / "end
+00010650: 706f 696e 7473 2220 2f20 7069 7065 293a  points" / pipe):
+00010660: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010670: 7069 7065 2c20 4e6f 6e65 0a0a 2020 2020  pipe, None..    
+00010680: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
+00010690: 6528 6620 2f20 2270 6970 6573 2220 2f20  e(f / "pipes" / 
+000106a0: 7069 7065 293a 0a20 2020 2020 2020 2072  pipe):.        r
+000106b0: 6574 7572 6e20 7069 7065 2c20 4e6f 6e65  eturn pipe, None
+000106c0: 0a0a 2020 2020 746f 6b65 6e20 3d20 6e61  ..    token = na
+000106d0: 6d65 202b 2022 2e74 6f6b 656e 220a 2020  me + ".token".  
+000106e0: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
+000106f0: 696c 6528 6620 2f20 2274 6f6b 656e 7322  ile(f / "tokens"
+00010700: 202f 2074 6f6b 656e 293a 0a20 2020 2020   / token):.     
+00010710: 2020 2072 6574 7572 6e20 746f 6b65 6e2c     return token,
+00010720: 204e 6f6e 650a 0a20 2020 2023 206c 6f6f   None..    # loo
+00010730: 6b20 666f 7220 7468 6520 6669 6c65 2069  k for the file i
+00010740: 6e20 7375 6264 6972 6563 746f 7269 6573  n subdirectories
+00010750: 2069 6620 6974 2773 206e 6f74 2066 6f75   if it's not fou
+00010760: 6e64 2069 6e20 6461 7461 736f 7572 6365  nd in datasource
+00010770: 7320 666f 6c64 6572 0a20 2020 2069 6620  s folder.    if 
+00010780: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
+00010790: 7468 733a 0a20 2020 2020 2020 205f 7265  ths:.        _re
+000107a0: 736f 7572 6365 203d 204e 6f6e 650a 2020  source = None.  
+000107b0: 2020 2020 2020 666f 7220 776b 5f6e 616d        for wk_nam
+000107c0: 652c 2077 6b5f 7061 7468 2069 6e20 776f  e, wk_path in wo
+000107d0: 726b 7370 6163 655f 6c69 625f 7061 7468  rkspace_lib_path
+000107e0: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
+000107f0: 696c 6520 3d20 4e6f 6e65 0a20 2020 2020  ile = None.     
+00010800: 2020 2020 2020 2069 6620 6e61 6d65 2e73         if name.s
+00010810: 7461 7274 7377 6974 6828 6622 7b77 6b5f  tartswith(f"{wk_
+00010820: 6e61 6d65 7d2e 2229 3a0a 2020 2020 2020  name}."):.      
+00010830: 2020 2020 2020 2020 2020 6669 6c65 2c20            file, 
+00010840: 5f72 6573 6f75 7263 6520 3d20 6669 6e64  _resource = find
+00010850: 5f66 696c 655f 6279 5f6e 616d 6528 0a20  _file_by_name(. 
+00010860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010870: 2020 2077 6b5f 7061 7468 2c20 6e61 6d65     wk_path, name
+00010880: 2e72 6570 6c61 6365 2866 227b 776b 5f6e  .replace(f"{wk_n
+00010890: 616d 657d 2e22 2c20 2222 292c 2076 6572  ame}.", ""), ver
+000108a0: 626f 7365 2c20 6973 5f72 6177 2c20 7265  bose, is_raw, re
+000108b0: 736f 7572 6365 3d72 6573 6f75 7263 650a  source=resource.
+000108c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108d0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+000108e0: 2066 696c 653a 0a20 2020 2020 2020 2020   file:.         
+000108f0: 2020 2020 2020 2072 6574 7572 6e20 6669         return fi
+00010900: 6c65 2c20 5f72 6573 6f75 7263 650a 0a20  le, _resource.. 
+00010910: 2020 2069 6620 6e6f 7420 6973 5f72 6177     if not is_raw
+00010920: 3a0a 2020 2020 2020 2020 662c 2072 6177  :.        f, raw
+00010930: 203d 2066 696e 645f 6669 6c65 5f62 795f   = find_file_by_
+00010940: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
+00010950: 2020 666f 6c64 6572 2c0a 2020 2020 2020    folder,.      
+00010960: 2020 2020 2020 6765 745f 6465 705f 6672        get_dep_fr
+00010970: 6f6d 5f72 6177 5f74 6162 6c65 7328 6e61  om_raw_tables(na
+00010980: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
+00010990: 2076 6572 626f 7365 3d76 6572 626f 7365   verbose=verbose
+000109a0: 2c0a 2020 2020 2020 2020 2020 2020 6973  ,.            is
+000109b0: 5f72 6177 3d54 7275 652c 0a20 2020 2020  _raw=True,.     
+000109c0: 2020 2020 2020 2077 6f72 6b73 7061 6365         workspace
+000109d0: 5f6c 6962 5f70 6174 6873 3d77 6f72 6b73  _lib_paths=works
+000109e0: 7061 6365 5f6c 6962 5f70 6174 6873 2c0a  pace_lib_paths,.
+000109f0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+00010a00: 7572 6365 3d72 6573 6f75 7263 652c 0a20  urce=resource,. 
+00010a10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00010a20: 2072 6574 7572 6e20 662c 2072 6177 0a0a   return f, raw..
+00010a30: 2020 2020 2320 6d61 7465 7269 616c 697a      # materializ
+00010a40: 6564 206e 6f64 6520 7769 7468 2044 4154  ed node with DAT
+00010a50: 4153 4f55 5243 4520 6465 6669 6e69 7469  ASOURCE definiti
+00010a60: 6f6e 0a20 2020 2069 6620 7265 736f 7572  on.    if resour
+00010a70: 6365 2061 6e64 2022 6e6f 6465 7322 2069  ce and "nodes" i
+00010a80: 6e20 7265 736f 7572 6365 3a0a 2020 2020  n resource:.    
+00010a90: 2020 2020 666f 7220 6e6f 6465 2069 6e20      for node in 
+00010aa0: 7265 736f 7572 6365 5b22 6e6f 6465 7322  resource["nodes"
+00010ab0: 5d3a 0a20 2020 2020 2020 2020 2020 2070  ]:.            p
+00010ac0: 6172 616d 7320 3d20 6e6f 6465 2e67 6574  arams = node.get
+00010ad0: 2822 7061 7261 6d73 222c 207b 7d29 0a20  ("params", {}). 
+00010ae0: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
+00010af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b00: 7061 7261 6d73 2e67 6574 2822 7479 7065  params.get("type
+00010b10: 222c 204e 6f6e 6529 203d 3d20 226d 6174  ", None) == "mat
+00010b20: 6572 6961 6c69 7a65 6422 0a20 2020 2020  erialized".     
+00010b30: 2020 2020 2020 2020 2020 2061 6e64 2070             and p
+00010b40: 6172 616d 732e 6765 7428 2265 6e67 696e  arams.get("engin
+00010b50: 6522 2c20 4e6f 6e65 290a 2020 2020 2020  e", None).      
+00010b60: 2020 2020 2020 2020 2020 616e 6420 7061            and pa
+00010b70: 7261 6d73 2e67 6574 2822 6461 7461 736f  rams.get("dataso
+00010b80: 7572 6365 222c 204e 6f6e 6529 0a20 2020  urce", None).   
+00010b90: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
+00010ba0: 2020 2020 2020 2020 2020 2020 7069 7065              pipe
+00010bb0: 203d 2072 6573 6f75 7263 655b 2272 6573   = resource["res
+00010bc0: 6f75 7263 655f 6e61 6d65 225d 202b 2022  ource_name"] + "
+00010bd0: 2e70 6970 6522 0a20 2020 2020 2020 2020  .pipe".         
+00010be0: 2020 2020 2020 2070 6970 655f 6669 6c65         pipe_file
+00010bf0: 5f65 7869 7374 7320 3d20 280a 2020 2020  _exists = (.    
+00010c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c10: 6f73 2e70 6174 682e 6973 6669 6c65 286f  os.path.isfile(o
+00010c20: 732e 7061 7468 2e6a 6f69 6e28 666f 6c64  s.path.join(fold
+00010c30: 6572 2c20 7069 7065 2929 0a20 2020 2020  er, pipe)).     
+00010c40: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00010c50: 7220 6f73 2e70 6174 682e 6973 6669 6c65  r os.path.isfile
+00010c60: 2866 202f 2022 656e 6470 6f69 6e74 7322  (f / "endpoints"
+00010c70: 202f 2070 6970 6529 0a20 2020 2020 2020   / pipe).       
+00010c80: 2020 2020 2020 2020 2020 2020 206f 7220               or 
+00010c90: 6f73 2e70 6174 682e 6973 6669 6c65 2866  os.path.isfile(f
+00010ca0: 202f 2022 7069 7065 7322 202f 2070 6970   / "pipes" / pip
+00010cb0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00010cc0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00010cd0: 2020 2020 2069 735f 7461 7267 6574 5f64       is_target_d
+00010ce0: 6174 6173 6f75 7263 6520 3d20 7061 7261  atasource = para
+00010cf0: 6d73 5b22 6461 7461 736f 7572 6365 225d  ms["datasource"]
+00010d00: 203d 3d20 6e61 6d65 0a20 2020 2020 2020   == name.       
+00010d10: 2020 2020 2020 2020 2069 6620 7069 7065           if pipe
+00010d20: 5f66 696c 655f 6578 6973 7473 2061 6e64  _file_exists and
+00010d30: 2069 735f 7461 7267 6574 5f64 6174 6173   is_target_datas
+00010d40: 6f75 7263 653a 0a20 2020 2020 2020 2020  ource:.         
+00010d50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00010d60: 6e20 7069 7065 2c20 7b22 7265 736f 7572  n pipe, {"resour
+00010d70: 6365 5f6e 616d 6522 3a20 7061 7261 6d73  ce_name": params
+00010d80: 2e67 6574 2822 6461 7461 736f 7572 6365  .get("datasource
+00010d90: 2229 7d0a 0a20 2020 2069 6620 7665 7262  ")}..    if verb
+00010da0: 6f73 653a 0a20 2020 2020 2020 2063 6c69  ose:.        cli
+00010db0: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
+00010dc0: 4d61 6e61 6765 722e 7761 726e 696e 675f  Manager.warning_
+00010dd0: 6669 6c65 5f6e 6f74 5f66 6f75 6e64 5f69  file_not_found_i
+00010de0: 6e73 6964 6528 6e61 6d65 3d6e 616d 652c  nside(name=name,
+00010df0: 2066 6f6c 6465 723d 666f 6c64 6572 2929   folder=folder))
+00010e00: 0a0a 2020 2020 7265 7475 726e 204e 6f6e  ..    return Non
+00010e10: 652c 204e 6f6e 650a 0a0a 6465 6620 6472  e, None...def dr
+00010e20: 6f70 5f74 6f6b 656e 2875 726c 3a20 7374  op_token(url: st
+00010e30: 7229 202d 3e20 7374 723a 0a20 2020 2022  r) -> str:.    "
+00010e40: 2222 0a20 2020 2064 726f 7073 2074 6f6b  "".    drops tok
+00010e50: 656e 2070 6172 616d 2066 726f 6d20 7468  en param from th
+00010e60: 6520 7572 6c20 7175 6572 7920 7374 7269  e url query stri
+00010e70: 6e67 0a20 2020 203e 3e3e 2064 726f 705f  ng.    >>> drop_
+00010e80: 746f 6b65 6e28 2768 7474 7073 3a2f 2f61  token('https://a
+00010e90: 7069 2e74 696e 7962 6972 642e 636f 2f76  pi.tinybird.co/v
+00010ea0: 302f 7069 7065 732f 6161 612e 6a73 6f6e  0/pipes/aaa.json
+00010eb0: 3f74 6f6b 656e 3d61 6263 6426 613d 3127  ?token=abcd&a=1'
+00010ec0: 290a 2020 2020 2768 7474 7073 3a2f 2f61  ).    'https://a
+00010ed0: 7069 2e74 696e 7962 6972 642e 636f 2f76  pi.tinybird.co/v
+00010ee0: 302f 7069 7065 732f 6161 612e 6a73 6f6e  0/pipes/aaa.json
+00010ef0: 3f61 3d31 270a 2020 2020 3e3e 3e20 6472  ?a=1'.    >>> dr
+00010f00: 6f70 5f74 6f6b 656e 2827 6874 7470 733a  op_token('https:
+00010f10: 2f2f 6170 692e 7469 6e79 6269 7264 2e63  //api.tinybird.c
+00010f20: 6f2f 7630 2f70 6970 6573 2f61 6161 2e6a  o/v0/pipes/aaa.j
+00010f30: 736f 6e3f 613d 3127 290a 2020 2020 2768  son?a=1').    'h
+00010f40: 7474 7073 3a2f 2f61 7069 2e74 696e 7962  ttps://api.tinyb
+00010f50: 6972 642e 636f 2f76 302f 7069 7065 732f  ird.co/v0/pipes/
+00010f60: 6161 612e 6a73 6f6e 3f61 3d31 270a 2020  aaa.json?a=1'.  
+00010f70: 2020 2222 220a 2020 2020 7061 7273 6564    """.    parsed
+00010f80: 203d 2075 726c 7061 7273 6528 7572 6c29   = urlparse(url)
+00010f90: 0a20 2020 2071 7320 3d20 7061 7273 655f  .    qs = parse_
+00010fa0: 7173 2870 6172 7365 642e 7175 6572 7929  qs(parsed.query)
+00010fb0: 0a20 2020 2071 735f 7369 6d70 6c69 6679  .    qs_simplify
+00010fc0: 203d 207b 6b3a 2076 5b30 5d20 666f 7220   = {k: v[0] for 
+00010fd0: 6b2c 2076 2069 6e20 7173 2e69 7465 6d73  k, v in qs.items
+00010fe0: 2829 7d20 2023 2063 6861 6e67 6520 7365  ()}  # change se
+00010ff0: 7665 7261 6c20 6172 6775 6d65 6e74 7320  veral arguments 
+00011000: 746f 2073 696e 676c 6520 6f6e 650a 2020  to single one.  
+00011010: 2020 6966 2022 746f 6b65 6e22 2069 6e20    if "token" in 
+00011020: 7173 5f73 696d 706c 6966 793a 0a20 2020  qs_simplify:.   
+00011030: 2020 2020 2064 656c 2071 735f 7369 6d70       del qs_simp
+00011040: 6c69 6679 5b22 746f 6b65 6e22 5d0a 2020  lify["token"].  
+00011050: 2020 7265 7475 726e 2066 227b 7061 7273    return f"{pars
+00011060: 6564 2e73 6368 656d 657d 3a2f 2f7b 7061  ed.scheme}://{pa
+00011070: 7273 6564 2e6e 6574 6c6f 637d 7b70 6172  rsed.netloc}{par
+00011080: 7365 642e 7061 7468 7d3f 7b75 726c 656e  sed.path}?{urlen
+00011090: 636f 6465 2871 735f 7369 6d70 6c69 6679  code(qs_simplify
+000110a0: 297d 220a 0a0a 6465 6620 6e6f 726d 616c  )}"...def normal
+000110b0: 697a 655f 6172 7261 7928 6974 656d 733a  ize_array(items:
+000110c0: 204c 6973 745b 4469 6374 5b73 7472 2c20   List[Dict[str, 
+000110d0: 4f70 7469 6f6e 616c 5b41 6e79 5d5d 5d29  Optional[Any]]])
+000110e0: 202d 3e20 4c69 7374 5b44 6963 745d 3a0a   -> List[Dict]:.
+000110f0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00011100: 536f 7274 6564 2829 2064 6f65 736e 2774  Sorted() doesn't
+00011110: 206e 6f74 2073 7570 706f 7274 2076 616c   not support val
+00011120: 7565 7320 7769 7468 2064 6966 6665 7265  ues with differe
+00011130: 6e74 2074 7970 6573 2066 6f72 2074 6865  nt types for the
+00011140: 2073 616d 6520 636f 6c75 6d6e 206c 696b   same column lik
+00011150: 6520 4e6f 6e65 2076 7320 7374 722e 0a20  e None vs str.. 
+00011160: 2020 2020 2020 2053 6f2c 2077 6520 6e65         So, we ne
+00011170: 6564 2074 6f20 6361 7374 2061 6c6c 204e  ed to cast all N
+00011180: 6f6e 6520 746f 2064 6566 6175 6c74 2076  one to default v
+00011190: 616c 7565 206f 6620 7468 6520 7479 7065  alue of the type
+000111a0: 206f 6620 7468 6520 636f 6c75 6d6e 2069   of the column i
+000111b0: 6620 6578 6973 7420 616e 6420 6966 2061  f exist and if a
+000111c0: 6c6c 2074 6865 2076 616c 7565 7320 6172  ll the values ar
+000111d0: 6520 4e6f 6e65 2c20 7765 2063 616e 206c  e None, we can l
+000111e0: 6561 7665 2074 6865 6d20 6173 204e 6f6e  eave them as Non
+000111f0: 650a 2020 2020 3e3e 3e20 6e6f 726d 616c  e.    >>> normal
+00011200: 697a 655f 6172 7261 7928 5b7b 2778 273a  ize_array([{'x':
+00011210: 2027 6865 6c6c 6f20 576f 726c 6427 7d2c   'hello World'},
+00011220: 207b 2778 273a 204e 6f6e 657d 5d29 0a20   {'x': None}]). 
+00011230: 2020 205b 7b27 7827 3a20 2768 656c 6c6f     [{'x': 'hello
+00011240: 2057 6f72 6c64 277d 2c20 7b27 7827 3a20   World'}, {'x': 
+00011250: 2727 7d5d 0a20 2020 203e 3e3e 206e 6f72  ''}].    >>> nor
+00011260: 6d61 6c69 7a65 5f61 7272 6179 285b 7b27  malize_array([{'
+00011270: 7827 3a20 337d 2c20 7b27 7827 3a20 4e6f  x': 3}, {'x': No
+00011280: 6e65 7d5d 290a 2020 2020 5b7b 2778 273a  ne}]).    [{'x':
+00011290: 2033 7d2c 207b 2778 273a 2030 7d5d 0a20   3}, {'x': 0}]. 
+000112a0: 2020 203e 3e3e 206e 6f72 6d61 6c69 7a65     >>> normalize
+000112b0: 5f61 7272 6179 285b 7b27 7827 3a20 7b27  _array([{'x': {'
+000112c0: 7927 3a20 5b31 2c32 2c33 2c34 5d7d 7d2c  y': [1,2,3,4]}},
+000112d0: 207b 2778 273a 207b 277a 273a 2022 4865   {'x': {'z': "He
+000112e0: 6c6c 6f22 207d 7d5d 290a 2020 2020 5b7b  llo" }}]).    [{
+000112f0: 2778 273a 207b 2779 273a 205b 312c 2032  'x': {'y': [1, 2
+00011300: 2c20 332c 2034 5d7d 7d2c 207b 2778 273a  , 3, 4]}}, {'x':
+00011310: 207b 277a 273a 2027 4865 6c6c 6f27 7d7d   {'z': 'Hello'}}
+00011320: 5d0a 2020 2020 2222 220a 2020 2020 7479  ].    """.    ty
+00011330: 7065 733a 2044 6963 745b 7374 722c 2074  pes: Dict[str, t
+00011340: 7970 655d 203d 207b 7d0a 2020 2020 6966  ype] = {}.    if
+00011350: 206c 656e 2869 7465 6d73 2920 3d3d 2030   len(items) == 0
+00011360: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00011370: 2069 7465 6d73 0a0a 2020 2020 636f 6c75   items..    colu
+00011380: 6d6e 7320 3d20 6974 656d 735b 305d 2e6b  mns = items[0].k
+00011390: 6579 7328 290a 2020 2020 666f 7220 636f  eys().    for co
+000113a0: 6c75 6d6e 2069 6e20 636f 6c75 6d6e 733a  lumn in columns:
+000113b0: 0a20 2020 2020 2020 2066 6f72 206f 626a  .        for obj
+000113c0: 6563 7420 696e 2069 7465 6d73 3a0a 2020  ect in items:.  
+000113d0: 2020 2020 2020 2020 2020 6966 206f 626a            if obj
+000113e0: 6563 745b 636f 6c75 6d6e 5d20 6973 206e  ect[column] is n
+000113f0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00011400: 2020 2020 2020 2020 2074 7970 6573 5b63           types[c
+00011410: 6f6c 756d 6e5d 203d 2074 7970 6528 6f62  olumn] = type(ob
+00011420: 6a65 6374 5b63 6f6c 756d 6e5d 290a 2020  ject[column]).  
+00011430: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00011440: 6561 6b0a 0a20 2020 2066 6f72 206f 626a  eak..    for obj
+00011450: 6563 7420 696e 2069 7465 6d73 3a0a 2020  ect in items:.  
+00011460: 2020 2020 2020 666f 7220 636f 6c75 6d6e        for column
+00011470: 2069 6e20 636f 6c75 6d6e 733a 0a20 2020   in columns:.   
+00011480: 2020 2020 2020 2020 2069 6620 6f62 6a65           if obje
+00011490: 6374 5b63 6f6c 756d 6e5d 2069 7320 6e6f  ct[column] is no
+000114a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+000114b0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+000114c0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+000114d0: 4966 204e 6f6e 652c 2077 6520 7265 706c  If None, we repl
+000114e0: 6163 6520 6974 2066 6f72 2074 6865 2064  ace it for the d
+000114f0: 6566 6175 6c74 2076 616c 7565 0a20 2020  efault value.   
+00011500: 2020 2020 2020 2020 2069 6620 7479 7065           if type
+00011510: 732e 6765 7428 636f 6c75 6d6e 2c20 4e6f  s.get(column, No
+00011520: 6e65 293a 0a20 2020 2020 2020 2020 2020  ne):.           
+00011530: 2020 2020 206f 626a 6563 745b 636f 6c75       object[colu
+00011540: 6d6e 5d20 3d20 7479 7065 735b 636f 6c75  mn] = types[colu
+00011550: 6d6e 5d28 290a 0a20 2020 2072 6574 7572  mn]()..    retur
+00011560: 6e20 6974 656d 730a 0a0a 636c 6173 7320  n items...class 
+00011570: 5069 7065 4368 6563 6b65 7228 756e 6974  PipeChecker(unit
+00011580: 7465 7374 2e54 6573 7443 6173 6529 3a0a  test.TestCase):.
+00011590: 2020 2020 5245 5452 4945 535f 4c49 4d49      RETRIES_LIMI
+000115a0: 5420 3d20 5049 5045 5f43 4845 434b 4552  T = PIPE_CHECKER
+000115b0: 5f52 4554 5249 4553 0a0a 2020 2020 6375  _RETRIES..    cu
+000115c0: 7272 656e 745f 7265 7370 6f6e 7365 5f74  rrent_response_t
+000115d0: 696d 653a 2066 6c6f 6174 203d 2030 0a20  ime: float = 0. 
+000115e0: 2020 2063 6865 636b 6572 5f72 6573 706f     checker_respo
+000115f0: 6e73 655f 7469 6d65 3a20 666c 6f61 7420  nse_time: float 
+00011600: 3d20 300a 0a20 2020 2063 7572 7265 6e74  = 0..    current
+00011610: 5f72 6561 645f 6279 7465 733a 2069 6e74  _read_bytes: int
+00011620: 203d 2030 0a20 2020 2063 6865 636b 6572   = 0.    checker
+00011630: 5f72 6561 645f 6279 7465 733a 2069 6e74  _read_bytes: int
+00011640: 203d 2030 0a0a 2020 2020 6465 6620 5f5f   = 0..    def __
+00011650: 696e 6974 5f5f 280a 2020 2020 2020 2020  init__(.        
+00011660: 7365 6c66 2c0a 2020 2020 2020 2020 7265  self,.        re
+00011670: 7175 6573 743a 2044 6963 745b 7374 722c  quest: Dict[str,
+00011680: 2041 6e79 5d2c 0a20 2020 2020 2020 2070   Any],.        p
+00011690: 6970 655f 6e61 6d65 3a20 7374 722c 0a20  ipe_name: str,. 
+000116a0: 2020 2020 2020 2063 6865 636b 6572 5f70         checker_p
+000116b0: 6970 655f 6e61 6d65 3a20 7374 722c 0a20  ipe_name: str,. 
+000116c0: 2020 2020 2020 2074 6f6b 656e 3a20 7374         token: st
+000116d0: 722c 0a20 2020 2020 2020 206f 6e6c 795f  r,.        only_
+000116e0: 7265 7370 6f6e 7365 5f74 696d 6573 3a20  response_times: 
+000116f0: 626f 6f6c 2c0a 2020 2020 2020 2020 6967  bool,.        ig
+00011700: 6e6f 7265 5f6f 7264 6572 3a20 626f 6f6c  nore_order: bool
+00011710: 2c0a 2020 2020 2020 2020 7661 6c69 6461  ,.        valida
+00011720: 7465 5f70 726f 6365 7373 6564 5f62 7974  te_processed_byt
+00011730: 6573 3a20 626f 6f6c 2c0a 2020 2020 2020  es: bool,.      
+00011740: 2020 2a61 7267 732c 0a20 2020 2020 2020    *args,.       
+00011750: 202a 2a6b 7761 7267 732c 0a20 2020 2029   **kwargs,.    )
+00011760: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00011770: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00011780: 5f5f 282a 6172 6773 2c20 2a2a 6b77 6172  __(*args, **kwar
+00011790: 6773 290a 2020 2020 2020 2020 6966 2072  gs).        if r
+000117a0: 6571 7565 7374 2e67 6574 2822 6874 7470  equest.get("http
+000117b0: 5f6d 6574 686f 6422 2920 3d3d 2022 504f  _method") == "PO
+000117c0: 5354 223a 0a20 2020 2020 2020 2020 2020  ST":.           
+000117d0: 2073 656c 662e 6874 7470 5f6d 6574 686f   self.http_metho
+000117e0: 6420 3d20 2250 4f53 5422 0a20 2020 2020  d = "POST".     
+000117f0: 2020 2020 2020 2073 656c 662e 6375 7272         self.curr
+00011800: 656e 745f 7069 7065 5f75 726c 2c20 7365  ent_pipe_url, se
+00011810: 6c66 2e70 6970 655f 7265 7175 6573 745f  lf.pipe_request_
+00011820: 7061 7261 6d73 203d 2073 656c 662e 5f70  params = self._p
+00011830: 7265 7061 7265 5f63 7572 7265 6e74 5f70  repare_current_p
+00011840: 6970 655f 666f 725f 706f 7374 5f72 6571  ipe_for_post_req
+00011850: 7565 7374 2872 6571 7565 7374 290a 2020  uest(request).  
+00011860: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00011870: 2020 2020 2020 2020 7365 6c66 2e68 7474          self.htt
+00011880: 705f 6d65 7468 6f64 203d 2022 4745 5422  p_method = "GET"
+00011890: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000118a0: 662e 6375 7272 656e 745f 7069 7065 5f75  f.current_pipe_u
+000118b0: 726c 2c20 7365 6c66 2e70 6970 655f 7265  rl, self.pipe_re
+000118c0: 7175 6573 745f 7061 7261 6d73 203d 2073  quest_params = s
+000118d0: 656c 662e 5f70 7265 7061 7265 5f63 7572  elf._prepare_cur
+000118e0: 7265 6e74 5f70 6970 655f 7572 6c5f 666f  rent_pipe_url_fo
+000118f0: 725f 6765 745f 7265 7175 6573 7428 7265  r_get_request(re
+00011900: 7175 6573 7429 0a0a 2020 2020 2020 2020  quest)..        
+00011910: 7365 6c66 2e5f 7072 6f63 6573 735f 7061  self._process_pa
+00011920: 7261 6d73 2829 0a20 2020 2020 2020 2073  rams().        s
+00011930: 656c 662e 6368 6563 6b65 725f 7069 7065  elf.checker_pipe
+00011940: 5f6e 616d 6520 3d20 6368 6563 6b65 725f  _name = checker_
+00011950: 7069 7065 5f6e 616d 650a 2020 2020 2020  pipe_name.      
+00011960: 2020 7365 6c66 2e70 6970 655f 6e61 6d65    self.pipe_name
+00011970: 203d 2070 6970 655f 6e61 6d65 0a20 2020   = pipe_name.   
+00011980: 2020 2020 2073 656c 662e 746f 6b65 6e20       self.token 
+00011990: 3d20 746f 6b65 6e0a 2020 2020 2020 2020  = token.        
+000119a0: 7365 6c66 2e6f 6e6c 795f 7265 7370 6f6e  self.only_respon
+000119b0: 7365 5f74 696d 6573 203d 206f 6e6c 795f  se_times = only_
+000119c0: 7265 7370 6f6e 7365 5f74 696d 6573 0a20  response_times. 
+000119d0: 2020 2020 2020 2073 656c 662e 6967 6e6f         self.igno
+000119e0: 7265 5f6f 7264 6572 203d 2069 676e 6f72  re_order = ignor
+000119f0: 655f 6f72 6465 720a 2020 2020 2020 2020  e_order.        
+00011a00: 7365 6c66 2e76 616c 6964 6174 655f 7072  self.validate_pr
+00011a10: 6f63 6573 7365 645f 6279 7465 7320 3d20  ocessed_bytes = 
+00011a20: 7661 6c69 6461 7465 5f70 726f 6365 7373  validate_process
+00011a30: 6564 5f62 7974 6573 0a0a 2020 2020 2020  ed_bytes..      
+00011a40: 2020 7061 7273 6564 203d 2075 726c 7061    parsed = urlpa
+00011a50: 7273 6528 7365 6c66 2e63 7572 7265 6e74  rse(self.current
+00011a60: 5f70 6970 655f 7572 6c29 0a20 2020 2020  _pipe_url).     
+00011a70: 2020 2073 656c 662e 6368 6563 6b65 725f     self.checker_
+00011a80: 7069 7065 5f75 726c 203d 2066 227b 7061  pipe_url = f"{pa
+00011a90: 7273 6564 2e73 6368 656d 657d 3a2f 2f7b  rsed.scheme}://{
+00011aa0: 7061 7273 6564 2e6e 6574 6c6f 637d 2f76  parsed.netloc}/v
+00011ab0: 302f 7069 7065 732f 7b73 656c 662e 6368  0/pipes/{self.ch
+00011ac0: 6563 6b65 725f 7069 7065 5f6e 616d 657d  ecker_pipe_name}
+00011ad0: 2e6a 736f 6e22 0a20 2020 2020 2020 2073  .json".        s
+00011ae0: 656c 662e 6368 6563 6b65 725f 7069 7065  elf.checker_pipe
+00011af0: 5f75 726c 202b 3d20 6622 3f7b 7061 7273  _url += f"?{pars
+00011b00: 6564 2e71 7565 7279 7d22 2069 6620 7061  ed.query}" if pa
+00011b10: 7273 6564 2e71 7565 7279 2069 7320 6e6f  rsed.query is no
+00011b20: 7420 4e6f 6e65 2061 6e64 2070 6172 7365  t None and parse
+00011b30: 642e 7175 6572 7920 213d 2022 2220 656c  d.query != "" el
+00011b40: 7365 2022 220a 0a20 2020 2064 6566 205f  se ""..    def _
+00011b50: 7072 6f63 6573 735f 7061 7261 6d73 2873  process_params(s
+00011b60: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
+00011b70: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+00011b80: 2073 656c 662e 7069 7065 5f72 6571 7565   self.pipe_reque
+00011b90: 7374 5f70 6172 616d 732e 6b65 7973 2829  st_params.keys()
+00011ba0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00011bb0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00011bc0: 2020 2073 656c 662e 7069 7065 5f72 6571     self.pipe_req
+00011bd0: 7565 7374 5f70 6172 616d 735b 6b65 795d  uest_params[key]
+00011be0: 203d 206a 736f 6e2e 6c6f 6164 7328 7365   = json.loads(se
+00011bf0: 6c66 2e70 6970 655f 7265 7175 6573 745f  lf.pipe_request_
+00011c00: 7061 7261 6d73 5b6b 6579 5d29 0a20 2020  params[key]).   
+00011c10: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00011c20: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+00011c30: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00011c40: 0a20 2020 2064 6566 205f 7072 6570 6172  .    def _prepar
+00011c50: 655f 6375 7272 656e 745f 7069 7065 5f75  e_current_pipe_u
+00011c60: 726c 5f66 6f72 5f67 6574 5f72 6571 7565  rl_for_get_reque
+00011c70: 7374 2873 656c 662c 2072 6571 7565 7374  st(self, request
+00011c80: 2920 2d3e 2054 7570 6c65 5b73 7472 2c20  ) -> Tuple[str, 
+00011c90: 4469 6374 5b73 7472 2c20 7374 725d 5d3a  Dict[str, str]]:
+00011ca0: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
+00011cb0: 5f70 6970 655f 7572 6c20 3d20 7265 7175  _pipe_url = requ
+00011cc0: 6573 742e 6765 7428 2265 6e64 706f 696e  est.get("endpoin
+00011cd0: 745f 7572 6c22 2c20 2222 290a 2020 2020  t_url", "").    
+00011ce0: 2020 2020 6375 7272 656e 745f 7069 7065      current_pipe
+00011cf0: 5f75 726c 203d 2028 0a20 2020 2020 2020  _url = (.       
+00011d00: 2020 2020 2063 7572 7265 6e74 5f70 6970       current_pip
+00011d10: 655f 7572 6c2e 7265 706c 6163 6528 222e  e_url.replace(".
+00011d20: 6e64 6a73 6f6e 222c 2022 2e6a 736f 6e22  ndjson", ".json"
+00011d30: 292e 7265 706c 6163 6528 222e 6373 7622  ).replace(".csv"
+00011d40: 2c20 222e 6a73 6f6e 2229 2e72 6570 6c61  , ".json").repla
+00011d50: 6365 2822 2e70 6172 7175 6574 222c 2022  ce(".parquet", "
+00011d60: 2e6a 736f 6e22 290a 2020 2020 2020 2020  .json").        
+00011d70: 290a 2020 2020 2020 2020 6375 7272 656e  ).        curren
+00011d80: 745f 7069 7065 5f75 726c 203d 2064 726f  t_pipe_url = dro
+00011d90: 705f 746f 6b65 6e28 6375 7272 656e 745f  p_token(current_
+00011da0: 7069 7065 5f75 726c 290a 2020 2020 2020  pipe_url).      
+00011db0: 2020 6375 7272 656e 745f 7069 7065 5f75    current_pipe_u
+00011dc0: 726c 202b 3d20 2822 2622 2069 6620 223f  rl += ("&" if "?
+00011dd0: 2220 696e 2063 7572 7265 6e74 5f70 6970  " in current_pip
+00011de0: 655f 7572 6c20 656c 7365 2022 3f22 2920  e_url else "?") 
+00011df0: 2b20 2270 6970 655f 6368 6563 6b65 723d  + "pipe_checker=
+00011e00: 7472 7565 220a 2020 2020 2020 2020 7265  true".        re
+00011e10: 7475 726e 2063 7572 7265 6e74 5f70 6970  turn current_pip
+00011e20: 655f 7572 6c2c 2072 6571 7565 7374 2e67  e_url, request.g
+00011e30: 6574 2822 7069 7065 5f72 6571 7565 7374  et("pipe_request
+00011e40: 5f70 6172 616d 7322 2c20 7b7d 290a 0a20  _params", {}).. 
+00011e50: 2020 2064 6566 205f 7072 6570 6172 655f     def _prepare_
+00011e60: 6375 7272 656e 745f 7069 7065 5f66 6f72  current_pipe_for
+00011e70: 5f70 6f73 745f 7265 7175 6573 7428 7365  _post_request(se
+00011e80: 6c66 2c20 7265 7175 6573 7429 202d 3e20  lf, request) -> 
+00011e90: 5475 706c 655b 7374 722c 2044 6963 745b  Tuple[str, Dict[
+00011ea0: 7374 722c 2073 7472 5d5d 3a0a 2020 2020  str, str]]:.    
+00011eb0: 2020 2020 6375 7272 656e 745f 7069 7065      current_pipe
+00011ec0: 5f75 726c 203d 2072 6571 7565 7374 2e67  _url = request.g
+00011ed0: 6574 2822 656e 6470 6f69 6e74 5f75 726c  et("endpoint_url
+00011ee0: 222c 2022 2229 0a20 2020 2020 2020 2063  ", "").        c
+00011ef0: 7572 7265 6e74 5f70 6970 655f 7572 6c20  urrent_pipe_url 
+00011f00: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00011f10: 6375 7272 656e 745f 7069 7065 5f75 726c  current_pipe_url
+00011f20: 2e72 6570 6c61 6365 2822 2e6e 646a 736f  .replace(".ndjso
+00011f30: 6e22 2c20 222e 6a73 6f6e 2229 2e72 6570  n", ".json").rep
+00011f40: 6c61 6365 2822 2e63 7376 222c 2022 2e6a  lace(".csv", ".j
+00011f50: 736f 6e22 292e 7265 706c 6163 6528 222e  son").replace(".
+00011f60: 7061 7271 7565 7422 2c20 222e 6a73 6f6e  parquet", ".json
+00011f70: 2229 0a20 2020 2020 2020 2029 0a20 2020  ").        ).   
+00011f80: 2020 2020 2061 6c6c 5f70 6172 616d 6574       all_paramet
+00011f90: 6572 7320 3d20 7265 7175 6573 742e 6765  ers = request.ge
+00011fa0: 7428 2270 6970 655f 7265 7175 6573 745f  t("pipe_request_
+00011fb0: 7061 7261 6d73 2229 0a20 2020 2020 2020  params").       
+00011fc0: 2061 6c6c 5f70 6172 616d 6574 6572 732e   all_parameters.
+00011fd0: 706f 7028 2274 6f6b 656e 222c 204e 6f6e  pop("token", Non
+00011fe0: 6529 0a20 2020 2020 2020 2061 6c6c 5f70  e).        all_p
+00011ff0: 6172 616d 6574 6572 735b 2270 6970 655f  arameters["pipe_
+00012000: 6368 6563 6b65 7222 5d20 3d20 2274 7275  checker"] = "tru
+00012010: 6522 0a0a 2020 2020 2020 2020 7265 7475  e"..        retu
+00012020: 726e 2063 7572 7265 6e74 5f70 6970 655f  rn current_pipe_
+00012030: 7572 6c2c 2061 6c6c 5f70 6172 616d 6574  url, all_paramet
+00012040: 6572 730a 0a20 2020 2064 6566 205f 5f73  ers..    def __s
+00012050: 7472 5f5f 2873 656c 6629 3a0a 2020 2020  tr__(self):.    
+00012060: 2020 2020 706f 7374 5f76 616c 7565 7320      post_values 
+00012070: 3d20 6622 202d 2050 4f53 5420 426f 6479  = f" - POST Body
+00012080: 3a20 7b73 656c 662e 7069 7065 5f72 6571  : {self.pipe_req
+00012090: 7565 7374 5f70 6172 616d 737d 2220 6966  uest_params}" if
+000120a0: 2073 656c 662e 6874 7470 5f6d 6574 686f   self.http_metho
+000120b0: 6420 3d3d 2022 504f 5354 2220 656c 7365  d == "POST" else
+000120c0: 2022 220a 0a20 2020 2020 2020 2072 6574   ""..        ret
+000120d0: 7572 6e20 6622 6375 7272 656e 7420 7b73  urn f"current {s
+000120e0: 656c 662e 6375 7272 656e 745f 7069 7065  elf.current_pipe
+000120f0: 5f75 726c 7d7b 706f 7374 5f76 616c 7565  _url}{post_value
+00012100: 737d 5c6e 2020 2020 6e65 7720 7b73 656c  s}\n    new {sel
+00012110: 662e 6368 6563 6b65 725f 7069 7065 5f75  f.checker_pipe_u
+00012120: 726c 7d7b 706f 7374 5f76 616c 7565 737d  rl}{post_values}
+00012130: 220a 0a20 2020 2064 6566 2064 6966 6628  "..    def diff(
+00012140: 7365 6c66 2c20 613a 2044 6963 745b 7374  self, a: Dict[st
+00012150: 722c 2041 6e79 5d2c 2062 3a20 4469 6374  r, Any], b: Dict
+00012160: 5b73 7472 2c20 416e 795d 2920 2d3e 2073  [str, Any]) -> s
+00012170: 7472 3a0a 2020 2020 2020 2020 615f 7072  tr:.        a_pr
+00012180: 6f70 6572 7469 6573 203d 206c 6973 7428  operties = list(
+00012190: 6d61 7028 6c61 6d62 6461 2078 3a20 6622  map(lambda x: f"
+000121a0: 7b78 7d3a 7b61 5b78 5d7d 5c6e 222c 2061  {x}:{a[x]}\n", a
+000121b0: 2e6b 6579 7328 2929 290a 2020 2020 2020  .keys())).      
+000121c0: 2020 625f 7072 6f70 6572 7469 6573 203d    b_properties =
+000121d0: 206c 6973 7428 6d61 7028 6c61 6d62 6461   list(map(lambda
+000121e0: 2078 3a20 6622 7b78 7d3a 7b62 5b78 5d7d   x: f"{x}:{b[x]}
+000121f0: 5c6e 222c 2062 2e6b 6579 7328 2929 290a  \n", b.keys())).
+00012200: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00012210: 2222 2e6a 6f69 6e28 6469 6666 6c69 622e  "".join(difflib.
+00012220: 636f 6e74 6578 745f 6469 6666 2861 5f70  context_diff(a_p
+00012230: 726f 7065 7274 6965 732c 2062 5f70 726f  roperties, b_pro
+00012240: 7065 7274 6965 732c 2073 656c 662e 7069  perties, self.pi
+00012250: 7065 5f6e 616d 652c 2073 656c 662e 6368  pe_name, self.ch
+00012260: 6563 6b65 725f 7069 7065 5f6e 616d 6529  ecker_pipe_name)
+00012270: 290a 0a20 2020 2064 6566 205f 646f 5f72  )..    def _do_r
+00012280: 6571 7565 7374 5f74 6f5f 7069 7065 2873  equest_to_pipe(s
+00012290: 656c 662c 2070 6970 655f 7572 6c3a 2073  elf, pipe_url: s
+000122a0: 7472 2920 2d3e 2052 6573 706f 6e73 653a  tr) -> Response:
+000122b0: 0a20 2020 2020 2020 2068 6561 6465 7273  .        headers
+000122c0: 203d 207b 2241 7574 686f 7269 7a61 7469   = {"Authorizati
+000122d0: 6f6e 223a 2066 2242 6561 7265 7220 7b73  on": f"Bearer {s
+000122e0: 656c 662e 746f 6b65 6e7d 227d 0a20 2020  elf.token}"}.   
+000122f0: 2020 2020 2069 6620 7365 6c66 2e68 7474       if self.htt
+00012300: 705f 6d65 7468 6f64 203d 3d20 2247 4554  p_method == "GET
+00012310: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
+00012320: 6574 7572 6e20 7265 7175 6573 7473 2e67  eturn requests.g
+00012330: 6574 2870 6970 655f 7572 6c2c 2068 6561  et(pipe_url, hea
+00012340: 6465 7273 3d68 6561 6465 7273 2c20 7665  ders=headers, ve
+00012350: 7269 6679 3d6e 6f74 2067 6574 656e 765f  rify=not getenv_
+00012360: 626f 6f6c 2822 5442 5f44 4953 4142 4c45  bool("TB_DISABLE
+00012370: 5f53 534c 5f43 4845 434b 5322 2c20 4661  _SSL_CHECKS", Fa
+00012380: 6c73 6529 290a 2020 2020 2020 2020 656c  lse)).        el
+00012390: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000123a0: 7265 7475 726e 2072 6571 7565 7374 732e  return requests.
+000123b0: 706f 7374 280a 2020 2020 2020 2020 2020  post(.          
+000123c0: 2020 2020 2020 7069 7065 5f75 726c 2c0a        pipe_url,.
+000123d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123e0: 6865 6164 6572 733d 6865 6164 6572 732c  headers=headers,
+000123f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012400: 2076 6572 6966 793d 6e6f 7420 6765 7465   verify=not gete
+00012410: 6e76 5f62 6f6f 6c28 2254 425f 4449 5341  nv_bool("TB_DISA
+00012420: 424c 455f 5353 4c5f 4348 4543 4b53 222c  BLE_SSL_CHECKS",
+00012430: 2046 616c 7365 292c 0a20 2020 2020 2020   False),.       
+00012440: 2020 2020 2020 2020 2064 6174 613d 7365           data=se
+00012450: 6c66 2e70 6970 655f 7265 7175 6573 745f  lf.pipe_request_
+00012460: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00012470: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
+00012480: 7772 6974 655f 7065 7266 6f72 6d61 6e63  write_performanc
+00012490: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+000124a0: 2072 6574 7572 6e20 2222 0a0a 2020 2020   return ""..    
+000124b0: 6465 6620 5f72 756e 5465 7374 2873 656c  def _runTest(sel
+000124c0: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
+000124d0: 2020 2020 6375 7272 656e 745f 7220 3d20      current_r = 
+000124e0: 7365 6c66 2e5f 646f 5f72 6571 7565 7374  self._do_request
+000124f0: 5f74 6f5f 7069 7065 2873 656c 662e 6375  _to_pipe(self.cu
+00012500: 7272 656e 745f 7069 7065 5f75 726c 290a  rrent_pipe_url).
+00012510: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
+00012520: 7220 3d20 7365 6c66 2e5f 646f 5f72 6571  r = self._do_req
+00012530: 7565 7374 5f74 6f5f 7069 7065 2873 656c  uest_to_pipe(sel
+00012540: 662e 6368 6563 6b65 725f 7069 7065 5f75  f.checker_pipe_u
+00012550: 726c 290a 0a20 2020 2020 2020 2074 7279  rl)..        try
+00012560: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00012570: 6c66 2e63 7572 7265 6e74 5f72 6573 706f  lf.current_respo
+00012580: 6e73 655f 7469 6d65 203d 2063 7572 7265  nse_time = curre
+00012590: 6e74 5f72 2e65 6c61 7073 6564 2e74 6f74  nt_r.elapsed.tot
+000125a0: 616c 5f73 6563 6f6e 6473 2829 0a20 2020  al_seconds().   
+000125b0: 2020 2020 2020 2020 2073 656c 662e 6368           self.ch
+000125c0: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
+000125d0: 696d 6520 3d20 6368 6563 6b65 725f 722e  ime = checker_r.
+000125e0: 656c 6170 7365 642e 746f 7461 6c5f 7365  elapsed.total_se
+000125f0: 636f 6e64 7328 290a 2020 2020 2020 2020  conds().        
+00012600: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00012610: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+00012620: 7373 0a0a 2020 2020 2020 2020 6375 7272  ss..        curr
+00012630: 656e 745f 7265 7370 6f6e 7365 3a20 4469  ent_response: Di
+00012640: 6374 5b73 7472 2c20 416e 795d 203d 2063  ct[str, Any] = c
+00012650: 7572 7265 6e74 5f72 2e6a 736f 6e28 290a  urrent_r.json().
+00012660: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
+00012670: 7265 7370 6f6e 7365 3a20 4469 6374 5b73  response: Dict[s
+00012680: 7472 2c20 416e 795d 203d 2063 6865 636b  tr, Any] = check
+00012690: 6572 5f72 2e6a 736f 6e28 290a 0a20 2020  er_r.json()..   
+000126a0: 2020 2020 2063 7572 7265 6e74 5f64 6174       current_dat
+000126b0: 613a 204c 6973 745b 4469 6374 5b73 7472  a: List[Dict[str
+000126c0: 2c20 416e 795d 5d20 3d20 6375 7272 656e  , Any]] = curren
+000126d0: 745f 7265 7370 6f6e 7365 2e67 6574 2822  t_response.get("
+000126e0: 6461 7461 222c 205b 5d29 0a20 2020 2020  data", []).     
+000126f0: 2020 2063 6865 636b 6572 5f64 6174 613a     checker_data:
+00012700: 204c 6973 745b 4469 6374 5b73 7472 2c20   List[Dict[str, 
+00012710: 416e 795d 5d20 3d20 6368 6563 6b65 725f  Any]] = checker_
+00012720: 7265 7370 6f6e 7365 2e67 6574 2822 6461  response.get("da
+00012730: 7461 222c 205b 5d29 0a0a 2020 2020 2020  ta", [])..      
+00012740: 2020 7365 6c66 2e63 7572 7265 6e74 5f72    self.current_r
+00012750: 6561 645f 6279 7465 7320 3d20 6375 7272  ead_bytes = curr
+00012760: 656e 745f 7265 7370 6f6e 7365 2e67 6574  ent_response.get
+00012770: 2822 7374 6174 6973 7469 6373 222c 207b  ("statistics", {
+00012780: 7d29 2e67 6574 2822 6279 7465 735f 7265  }).get("bytes_re
+00012790: 6164 222c 2030 290a 2020 2020 2020 2020  ad", 0).        
+000127a0: 7365 6c66 2e63 6865 636b 6572 5f72 6561  self.checker_rea
+000127b0: 645f 6279 7465 7320 3d20 6368 6563 6b65  d_bytes = checke
+000127c0: 725f 7265 7370 6f6e 7365 2e67 6574 2822  r_response.get("
+000127d0: 7374 6174 6973 7469 6373 222c 207b 7d29  statistics", {})
+000127e0: 2e67 6574 2822 6279 7465 735f 7265 6164  .get("bytes_read
+000127f0: 222c 2030 290a 0a20 2020 2020 2020 2065  ", 0)..        e
+00012800: 7272 6f72 5f63 6865 636b 5f66 6978 7475  rror_check_fixtu
+00012810: 7265 735f 6461 7461 3a20 4f70 7469 6f6e  res_data: Option
+00012820: 616c 5b73 7472 5d20 3d20 6368 6563 6b65  al[str] = checke
+00012830: 725f 7265 7370 6f6e 7365 2e67 6574 2822  r_response.get("
+00012840: 6572 726f 7222 2c20 4e6f 6e65 290a 2020  error", None).  
+00012850: 2020 2020 2020 7365 6c66 2e61 7373 6572        self.asser
+00012860: 7449 734e 6f6e 6528 0a20 2020 2020 2020  tIsNone(.       
+00012870: 2020 2020 2065 7272 6f72 5f63 6865 636b       error_check
+00012880: 5f66 6978 7475 7265 735f 6461 7461 2c0a  _fixtures_data,.
+00012890: 2020 2020 2020 2020 2020 2020 2259 6f75              "You
+000128a0: 2061 7265 2074 7279 696e 6720 746f 2070   are trying to p
+000128b0: 7573 6820 6120 7069 7065 2077 6974 6820  ush a pipe with 
+000128c0: 6572 726f 7273 2c20 706c 6561 7365 2063  errors, please c
+000128d0: 6865 636b 2074 6865 206f 7574 7075 7420  heck the output 
+000128e0: 6f72 2072 756e 2077 6974 6820 2d2d 6e6f  or run with --no
+000128f0: 2d63 6865 636b 222c 0a20 2020 2020 2020  -check",.       
+00012900: 2029 0a0a 2020 2020 2020 2020 696e 6372   )..        incr
+00012910: 6561 7365 5f72 6573 706f 6e73 655f 7469  ease_response_ti
+00012920: 6d65 203d 2028 0a20 2020 2020 2020 2020  me = (.         
+00012930: 2020 2063 6865 636b 6572 5f72 2e65 6c61     checker_r.ela
+00012940: 7073 6564 2e74 6f74 616c 5f73 6563 6f6e  psed.total_secon
+00012950: 6473 2829 202d 2063 7572 7265 6e74 5f72  ds() - current_r
+00012960: 2e65 6c61 7073 6564 2e74 6f74 616c 5f73  .elapsed.total_s
+00012970: 6563 6f6e 6473 2829 0a20 2020 2020 2020  econds().       
+00012980: 2029 202f 2063 7572 7265 6e74 5f72 2e65   ) / current_r.e
+00012990: 6c61 7073 6564 2e74 6f74 616c 5f73 6563  lapsed.total_sec
+000129a0: 6f6e 6473 2829 0a20 2020 2020 2020 2069  onds().        i
+000129b0: 6620 7365 6c66 2e6f 6e6c 795f 7265 7370  f self.only_resp
+000129c0: 6f6e 7365 5f74 696d 6573 3a0a 2020 2020  onse_times:.    
+000129d0: 2020 2020 2020 2020 7365 6c66 2e61 7373          self.ass
+000129e0: 6572 744c 6573 7328 0a20 2020 2020 2020  ertLess(.       
+000129f0: 2020 2020 2020 2020 2069 6e63 7265 6173           increas
+00012a00: 655f 7265 7370 6f6e 7365 5f74 696d 652c  e_response_time,
+00012a10: 2030 2e32 352c 206d 7367 3d66 2272 6573   0.25, msg=f"res
+00012a20: 706f 6e73 6520 7469 6d65 2068 6173 2069  ponse time has i
+00012a30: 6e63 7265 6173 6564 207b 726f 756e 6428  ncreased {round(
+00012a40: 696e 6372 6561 7365 5f72 6573 706f 6e73  increase_respons
+00012a50: 655f 7469 6d65 202a 2031 3030 297d 2522  e_time * 100)}%"
+00012a60: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00012a70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00012a80: 6e0a 0a20 2020 2020 2020 2073 656c 662e  n..        self.
+00012a90: 6173 7365 7274 4571 7561 6c28 6c65 6e28  assertEqual(len(
+00012aa0: 6375 7272 656e 745f 6461 7461 292c 206c  current_data), l
+00012ab0: 656e 2863 6865 636b 6572 5f64 6174 6129  en(checker_data)
+00012ac0: 2c20 224e 756d 6265 7220 6f66 2065 6c65  , "Number of ele
+00012ad0: 6d65 6e74 7320 646f 6573 206e 6f74 206d  ments does not m
+00012ae0: 6174 6368 2229 0a0a 2020 2020 2020 2020  atch")..        
+00012af0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+00012b00: 5f70 726f 6365 7373 6564 5f62 7974 6573  _processed_bytes
+00012b10: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
+00012b20: 6372 6561 7365 5f72 6561 645f 6279 7465  crease_read_byte
+00012b30: 7320 3d20 2873 656c 662e 6368 6563 6b65  s = (self.checke
+00012b40: 725f 7265 6164 5f62 7974 6573 202d 2073  r_read_bytes - s
+00012b50: 656c 662e 6375 7272 656e 745f 7265 6164  elf.current_read
+00012b60: 5f62 7974 6573 2920 2f20 7365 6c66 2e63  _bytes) / self.c
+00012b70: 7572 7265 6e74 5f72 6561 645f 6279 7465  urrent_read_byte
+00012b80: 730a 2020 2020 2020 2020 2020 2020 7365  s.            se
+00012b90: 6c66 2e61 7373 6572 744c 6573 7328 0a20  lf.assertLess(. 
+00012ba0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00012bb0: 6f75 6e64 2869 6e63 7265 6173 655f 7265  ound(increase_re
+00012bc0: 6164 5f62 7974 6573 2c20 3229 2c0a 2020  ad_bytes, 2),.  
+00012bd0: 2020 2020 2020 2020 2020 2020 2020 302e                0.
+00012be0: 3235 2c0a 2020 2020 2020 2020 2020 2020  25,.            
+00012bf0: 2020 2020 6d73 673d 6622 5468 6520 6e75      msg=f"The nu
+00012c00: 6d62 6572 206f 6620 7072 6f63 6573 7365  mber of processe
+00012c10: 6420 6279 7465 7320 6861 7320 696e 6372  d bytes has incr
+00012c20: 6561 7365 6420 7b72 6f75 6e64 2869 6e63  eased {round(inc
+00012c30: 7265 6173 655f 7265 6164 5f62 7974 6573  rease_read_bytes
+00012c40: 202a 2031 3030 297d 2522 2c0a 2020 2020   * 100)}%",.    
+00012c50: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00012c60: 2020 2069 6620 7365 6c66 2e69 676e 6f72     if self.ignor
+00012c70: 655f 6f72 6465 723a 0a20 2020 2020 2020  e_order:.       
+00012c80: 2020 2020 2063 7572 7265 6e74 5f64 6174       current_dat
+00012c90: 6120 3d20 280a 2020 2020 2020 2020 2020  a = (.          
+00012ca0: 2020 2020 2020 736f 7274 6564 286e 6f72        sorted(nor
+00012cb0: 6d61 6c69 7a65 5f61 7272 6179 2863 7572  malize_array(cur
+00012cc0: 7265 6e74 5f64 6174 6129 2c20 6b65 793d  rent_data), key=
+00012cd0: 6974 656d 6765 7474 6572 282a 5b6b 2066  itemgetter(*[k f
+00012ce0: 6f72 206b 2069 6e20 6375 7272 656e 745f  or k in current_
+00012cf0: 6461 7461 5b30 5d2e 6b65 7973 2829 5d29  data[0].keys()])
+00012d00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012d10: 2020 6966 206c 656e 2863 7572 7265 6e74    if len(current
+00012d20: 5f64 6174 6129 203e 2030 0a20 2020 2020  _data) > 0.     
+00012d30: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
+00012d40: 6375 7272 656e 745f 6461 7461 0a20 2020  current_data.   
+00012d50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00012d60: 2020 2020 2020 2063 6865 636b 6572 5f64         checker_d
+00012d70: 6174 6120 3d20 280a 2020 2020 2020 2020  ata = (.        
+00012d80: 2020 2020 2020 2020 736f 7274 6564 286e          sorted(n
+00012d90: 6f72 6d61 6c69 7a65 5f61 7272 6179 2863  ormalize_array(c
+00012da0: 6865 636b 6572 5f64 6174 6129 2c20 6b65  hecker_data), ke
+00012db0: 793d 6974 656d 6765 7474 6572 282a 5b6b  y=itemgetter(*[k
+00012dc0: 2066 6f72 206b 2069 6e20 6368 6563 6b65   for k in checke
+00012dd0: 725f 6461 7461 5b30 5d2e 6b65 7973 2829  r_data[0].keys()
+00012de0: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
+00012df0: 2020 2020 6966 206c 656e 2863 6865 636b      if len(check
+00012e00: 6572 5f64 6174 6129 203e 2030 0a20 2020  er_data) > 0.   
+00012e10: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00012e20: 6520 6368 6563 6b65 725f 6461 7461 0a20  e checker_data. 
+00012e30: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00012e40: 2020 2020 2020 666f 7220 5f2c 2028 6375        for _, (cu
+00012e50: 7272 656e 745f 6461 7461 5f65 2c20 6368  rrent_data_e, ch
+00012e60: 6563 6b5f 6669 7874 7572 6573 5f64 6174  eck_fixtures_dat
+00012e70: 615f 6529 2069 6e20 656e 756d 6572 6174  a_e) in enumerat
+00012e80: 6528 7a69 7028 6375 7272 656e 745f 6461  e(zip(current_da
+00012e90: 7461 2c20 6368 6563 6b65 725f 6461 7461  ta, checker_data
+00012ea0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00012eb0: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00012ec0: 286c 6973 7428 6375 7272 656e 745f 6461  (list(current_da
+00012ed0: 7461 5f65 2e6b 6579 7328 2929 2c20 6c69  ta_e.keys()), li
+00012ee0: 7374 2863 6865 636b 5f66 6978 7475 7265  st(check_fixture
+00012ef0: 735f 6461 7461 5f65 2e6b 6579 7328 2929  s_data_e.keys())
+00012f00: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00012f10: 7220 7820 696e 2063 7572 7265 6e74 5f64  r x in current_d
+00012f20: 6174 615f 652e 6b65 7973 2829 3a0a 2020  ata_e.keys():.  
+00012f30: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00012f40: 2069 7369 6e73 7461 6e63 6528 6375 7272   isinstance(curr
+00012f50: 656e 745f 6461 7461 5f65 5b78 5d2c 2066  ent_data_e[x], f
+00012f60: 6c6f 6174 293a 0a20 2020 2020 2020 2020  loat):.         
+00012f70: 2020 2020 2020 2020 2020 2064 203d 2061             d = a
+00012f80: 6273 2863 7572 7265 6e74 5f64 6174 615f  bs(current_data_
+00012f90: 655b 785d 202d 2063 6865 636b 5f66 6978  e[x] - check_fix
+00012fa0: 7475 7265 735f 6461 7461 5f65 5b78 5d29  tures_data_e[x])
+00012fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012fc0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
 00012fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fe0: 2020 6578 6365 7074 205a 6572 6f44 6976    except ZeroDiv
-00012ff0: 6973 696f 6e45 7272 6f72 3a0a 2020 2020  isionError:.    
+00012fe0: 2020 7365 6c66 2e61 7373 6572 744c 6573    self.assertLes
+00012ff0: 7345 7175 616c 280a 2020 2020 2020 2020  sEqual(.        
 00013000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013010: 2020 2020 7365 6c66 2e61 7373 6572 7445      self.assertE
-00013020: 7175 616c 280a 2020 2020 2020 2020 2020  qual(.          
+00013010: 2020 2020 6420 2f20 6375 7272 656e 745f      d / current_
+00013020: 6461 7461 5f65 5b78 5d2c 0a20 2020 2020  data_e[x],.     
 00013030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013040: 2020 642c 0a20 2020 2020 2020 2020 2020    d,.           
+00013040: 2020 2020 2020 2030 2e30 312c 0a20 2020         0.01,.   
 00013050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013060: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
-00013070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013080: 6622 6b65 7920 7b78 7d2e 206f 6c64 2076  f"key {x}. old v
-00013090: 616c 7565 3a20 7b63 7572 7265 6e74 5f64  alue: {current_d
-000130a0: 6174 615f 655b 785d 7d2c 206e 6577 2076  ata_e[x]}, new v
-000130b0: 616c 7565 3a20 7b63 6865 636b 5f66 6978  alue: {check_fix
-000130c0: 7475 7265 735f 6461 7461 5f65 5b78 5d7d  tures_data_e[x]}
-000130d0: 5c6e 7b73 656c 662e 6469 6666 2863 7572  \n{self.diff(cur
-000130e0: 7265 6e74 5f64 6174 615f 652c 2063 6865  rent_data_e, che
-000130f0: 636b 5f66 6978 7475 7265 735f 6461 7461  ck_fixtures_data
-00013100: 5f65 297d 222c 0a20 2020 2020 2020 2020  _e)}",.         
-00013110: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00013120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013130: 2065 6c69 6620 280a 2020 2020 2020 2020   elif (.        
-00013140: 2020 2020 2020 2020 2020 2020 6e6f 7420              not 
-00013150: 6973 696e 7374 616e 6365 2863 7572 7265  isinstance(curre
-00013160: 6e74 5f64 6174 615f 655b 785d 2c20 2873  nt_data_e[x], (s
-00013170: 7472 2c20 6279 7465 7329 290a 2020 2020  tr, bytes)).    
-00013180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013190: 616e 6420 6973 696e 7374 616e 6365 2863  and isinstance(c
-000131a0: 7572 7265 6e74 5f64 6174 615f 655b 785d  urrent_data_e[x]
-000131b0: 2c20 4974 6572 6162 6c65 290a 2020 2020  , Iterable).    
-000131c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131d0: 616e 6420 7365 6c66 2e69 676e 6f72 655f  and self.ignore_
-000131e0: 6f72 6465 720a 2020 2020 2020 2020 2020  order.          
-000131f0: 2020 2020 2020 293a 0a0a 2020 2020 2020        ):..      
-00013200: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00013210: 6620 666c 6174 7465 6e28 6974 656d 7329  f flatten(items)
-00013220: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013230: 2020 2020 2020 2020 2020 2222 2259 6965            """Yie
-00013240: 6c64 2069 7465 6d73 2066 726f 6d20 616e  ld items from an
-00013250: 7920 6e65 7374 6564 2069 7465 7261 626c  y nested iterabl
-00013260: 653b 2073 6565 2052 6566 6572 656e 6365  e; see Reference
-00013270: 2e22 2222 0a20 2020 2020 2020 2020 2020  .""".           
-00013280: 2020 2020 2020 2020 2020 2020 206f 7574               out
-00013290: 7075 7420 3d20 5b5d 0a20 2020 2020 2020  put = [].       
-000132a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000132b0: 2066 6f72 2078 2069 6e20 6974 656d 733a   for x in items:
-000132c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000132d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000132e0: 6973 696e 7374 616e 6365 2878 2c20 4974  isinstance(x, It
-000132f0: 6572 6162 6c65 2920 616e 6420 6e6f 7420  erable) and not 
-00013300: 6973 696e 7374 616e 6365 2878 2c20 2873  isinstance(x, (s
-00013310: 7472 2c20 6279 7465 7329 293a 0a20 2020  tr, bytes)):.   
-00013320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013330: 2020 2020 2020 2020 2020 2020 206f 7574               out
-00013340: 7075 742e 6578 7465 6e64 2866 6c61 7474  put.extend(flatt
-00013350: 656e 2878 2929 0a20 2020 2020 2020 2020  en(x)).         
+00013060: 2020 2020 2020 2020 2066 226b 6579 207b           f"key {
+00013070: 787d 2e20 6f6c 6420 7661 6c75 653a 207b  x}. old value: {
+00013080: 6375 7272 656e 745f 6461 7461 5f65 5b78  current_data_e[x
+00013090: 5d7d 2c20 6e65 7720 7661 6c75 653a 207b  ]}, new value: {
+000130a0: 6368 6563 6b5f 6669 7874 7572 6573 5f64  check_fixtures_d
+000130b0: 6174 615f 655b 785d 7d5c 6e7b 7365 6c66  ata_e[x]}\n{self
+000130c0: 2e64 6966 6628 6375 7272 656e 745f 6461  .diff(current_da
+000130d0: 7461 5f65 2c20 6368 6563 6b5f 6669 7874  ta_e, check_fixt
+000130e0: 7572 6573 5f64 6174 615f 6529 7d22 2c0a  ures_data_e)}",.
+000130f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013100: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00013110: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00013120: 6365 7074 205a 6572 6f44 6976 6973 696f  cept ZeroDivisio
+00013130: 6e45 7272 6f72 3a0a 2020 2020 2020 2020  nError:.        
+00013140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013150: 7365 6c66 2e61 7373 6572 7445 7175 616c  self.assertEqual
+00013160: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00013170: 2020 2020 2020 2020 2020 2020 2020 642c                d,
+00013180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013190: 2020 2020 2020 2020 2020 2020 2030 2c0a               0,.
+000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131b0: 2020 2020 2020 2020 2020 2020 6622 6b65              f"ke
+000131c0: 7920 7b78 7d2e 206f 6c64 2076 616c 7565  y {x}. old value
+000131d0: 3a20 7b63 7572 7265 6e74 5f64 6174 615f  : {current_data_
+000131e0: 655b 785d 7d2c 206e 6577 2076 616c 7565  e[x]}, new value
+000131f0: 3a20 7b63 6865 636b 5f66 6978 7475 7265  : {check_fixture
+00013200: 735f 6461 7461 5f65 5b78 5d7d 5c6e 7b73  s_data_e[x]}\n{s
+00013210: 656c 662e 6469 6666 2863 7572 7265 6e74  elf.diff(current
+00013220: 5f64 6174 615f 652c 2063 6865 636b 5f66  _data_e, check_f
+00013230: 6978 7475 7265 735f 6461 7461 5f65 297d  ixtures_data_e)}
+00013240: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00013250: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00013260: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00013270: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
+00013280: 2020 2020 2020 2020 6e6f 7420 6973 696e          not isin
+00013290: 7374 616e 6365 2863 7572 7265 6e74 5f64  stance(current_d
+000132a0: 6174 615f 655b 785d 2c20 2873 7472 2c20  ata_e[x], (str, 
+000132b0: 6279 7465 7329 290a 2020 2020 2020 2020  bytes)).        
+000132c0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+000132d0: 6973 696e 7374 616e 6365 2863 7572 7265  isinstance(curre
+000132e0: 6e74 5f64 6174 615f 655b 785d 2c20 4974  nt_data_e[x], It
+000132f0: 6572 6162 6c65 290a 2020 2020 2020 2020  erable).        
+00013300: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00013310: 7365 6c66 2e69 676e 6f72 655f 6f72 6465  self.ignore_orde
+00013320: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+00013330: 2020 293a 0a0a 2020 2020 2020 2020 2020    ):..          
+00013340: 2020 2020 2020 2020 2020 6465 6620 666c            def fl
+00013350: 6174 7465 6e28 6974 656d 7329 3a0a 2020  atten(items):.  
 00013360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013370: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00013380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013390: 2020 2020 2020 2020 206f 7574 7075 742e           output.
-000133a0: 6170 7065 6e64 2878 290a 2020 2020 2020  append(x).      
-000133b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133c0: 2020 7265 7475 726e 206f 7574 7075 740a    return output.
-000133d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000133e0: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-000133f0: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
-00013400: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013410: 6c61 7474 656e 2863 7572 7265 6e74 5f64  latten(current_d
-00013420: 6174 615f 655b 785d 292e 736f 7274 2829  ata_e[x]).sort()
-00013430: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013440: 2020 2020 2020 2020 2020 666c 6174 7465            flatte
-00013450: 6e28 6368 6563 6b5f 6669 7874 7572 6573  n(check_fixtures
-00013460: 5f64 6174 615f 655b 785d 292e 736f 7274  _data_e[x]).sort
-00013470: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-00013480: 2020 2020 2020 2020 2020 2020 225c 6e22              "\n"
-00013490: 202b 2073 656c 662e 6469 6666 2863 7572   + self.diff(cur
-000134a0: 7265 6e74 5f64 6174 615f 652c 2063 6865  rent_data_e, che
-000134b0: 636b 5f66 6978 7475 7265 735f 6461 7461  ck_fixtures_data
-000134c0: 5f65 292c 0a20 2020 2020 2020 2020 2020  _e),.           
-000134d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000134e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000134f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013500: 2020 2020 2073 656c 662e 6173 7365 7274       self.assert
-00013510: 4571 7561 6c28 0a20 2020 2020 2020 2020  Equal(.         
-00013520: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00013530: 7572 7265 6e74 5f64 6174 615f 655b 785d  urrent_data_e[x]
-00013540: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013550: 2020 2020 2020 2020 2020 6368 6563 6b5f            check_
-00013560: 6669 7874 7572 6573 5f64 6174 615f 655b  fixtures_data_e[
-00013570: 785d 2c0a 2020 2020 2020 2020 2020 2020  x],.            
-00013580: 2020 2020 2020 2020 2020 2020 225c 6e22              "\n"
-00013590: 202b 2073 656c 662e 6469 6666 2863 7572   + self.diff(cur
-000135a0: 7265 6e74 5f64 6174 615f 652c 2063 6865  rent_data_e, che
-000135b0: 636b 5f66 6978 7475 7265 735f 6461 7461  ck_fixtures_data
-000135c0: 5f65 292c 0a20 2020 2020 2020 2020 2020  _e),.           
-000135d0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000135e0: 6465 6620 7275 6e54 6573 7428 7365 6c66  def runTest(self
-000135f0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00013600: 2020 2069 6620 2264 6562 7567 2220 696e     if "debug" in
-00013610: 2073 656c 662e 7069 7065 5f72 6571 7565   self.pipe_reque
-00013620: 7374 5f70 6172 616d 7320 6f72 2028 0a20  st_params or (. 
-00013630: 2020 2020 2020 2020 2020 2022 6672 6f6d             "from
-00013640: 2220 696e 2073 656c 662e 7069 7065 5f72  " in self.pipe_r
-00013650: 6571 7565 7374 5f70 6172 616d 7320 616e  equest_params an
-00013660: 6420 7365 6c66 2e70 6970 655f 7265 7175  d self.pipe_requ
-00013670: 6573 745f 7061 7261 6d73 5b22 6672 6f6d  est_params["from
-00013680: 225d 203d 3d20 2275 6922 0a20 2020 2020  "] == "ui".     
-00013690: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-000136a0: 2020 7365 6c66 2e73 6b69 7054 6573 7428    self.skipTest(
-000136b0: 2266 6f75 6e64 2064 6562 7567 2070 6172  "found debug par
-000136c0: 616d 2229 0a0a 2020 2020 2020 2020 2320  am")..        # 
-000136d0: 4c65 7427 7320 7265 7472 7920 7468 6520  Let's retry the 
-000136e0: 7661 6c69 6461 7469 6f6e 2074 6f20 6176  validation to av
-000136f0: 6f69 6420 6661 6c73 6520 616c 6572 7473  oid false alerts
-00013700: 2077 6865 6e20 6465 616c 696e 6720 7769   when dealing wi
-00013710: 7468 2065 6e64 706f 696e 7473 2074 6861  th endpoints tha
-00013720: 7420 6861 7665 2063 6f6e 7469 6e75 6f73  t have continuos
-00013730: 2069 6e67 6573 7469 6f6e 0a20 2020 2020   ingestion.     
-00013740: 2020 2072 6574 7269 6573 203d 2030 0a20     retries = 0. 
-00013750: 2020 2020 2020 2077 6869 6c65 2072 6574         while ret
-00013760: 7269 6573 203c 2073 656c 662e 5245 5452  ries < self.RETR
-00013770: 4945 535f 4c49 4d49 543a 0a20 2020 2020  IES_LIMIT:.     
-00013780: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00013790: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000137a0: 2e5f 7275 6e54 6573 7428 290a 2020 2020  ._runTest().    
-000137b0: 2020 2020 2020 2020 6578 6365 7074 2041          except A
-000137c0: 7373 6572 7469 6f6e 4572 726f 7220 6173  ssertionError as
-000137d0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-000137e0: 2020 2020 7265 7472 6965 7320 2b3d 2031      retries += 1
-000137f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013800: 2069 6620 7265 7472 6965 7320 3e3d 2073   if retries >= s
-00013810: 656c 662e 5245 5452 4945 535f 4c49 4d49  elf.RETRIES_LIMI
-00013820: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
-00013830: 2020 2020 2020 2072 6169 7365 2065 0a20         raise e. 
-00013840: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00013850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013860: 2062 7265 616b 0a0a 0a40 6461 7461 636c   break...@datacl
-00013870: 6173 730a 636c 6173 7320 5069 7065 4368  ass.class PipeCh
-00013880: 6563 6b65 7252 756e 6e65 7252 6573 706f  eckerRunnerRespo
-00013890: 6e73 653a 0a20 2020 2070 6970 655f 6e61  nse:.    pipe_na
-000138a0: 6d65 3a20 7374 720a 2020 2020 7465 7374  me: str.    test
-000138b0: 5f74 7970 653a 2073 7472 0a20 2020 206f  _type: str.    o
-000138c0: 7574 7075 743a 2073 7472 0a20 2020 206d  utput: str.    m
-000138d0: 6574 7269 6373 5f73 756d 6d61 7279 3a20  etrics_summary: 
-000138e0: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
-000138f0: 722c 2041 6e79 5d5d 0a20 2020 206d 6574  r, Any]].    met
-00013900: 7269 6373 5f74 696d 696e 673a 2044 6963  rics_timing: Dic
-00013910: 745b 7374 722c 2054 7570 6c65 5b66 6c6f  t[str, Tuple[flo
-00013920: 6174 2c20 666c 6f61 742c 2066 6c6f 6174  at, float, float
-00013930: 5d5d 0a20 2020 2066 6169 6c65 643a 204c  ]].    failed: L
-00013940: 6973 745b 4469 6374 5b73 7472 2c20 7374  ist[Dict[str, st
-00013950: 725d 5d0a 2020 2020 7761 735f 7375 6363  r]].    was_succ
-00013960: 6573 7366 756c 6c3a 2062 6f6f 6c0a 0a0a  essfull: bool...
-00013970: 636c 6173 7320 5069 7065 4368 6563 6b65  class PipeChecke
-00013980: 7252 756e 6e65 723a 0a20 2020 2063 6865  rRunner:.    che
-00013990: 636b 6572 5f73 7472 6561 6d5f 7265 7375  cker_stream_resu
-000139a0: 6c74 5f63 6c61 7373 203d 2075 6e69 7474  lt_class = unitt
-000139b0: 6573 742e 7275 6e6e 6572 2e5f 5772 6974  est.runner._Writ
-000139c0: 656c 6e44 6563 6f72 6174 6f72 2020 2320  elnDecorator  # 
-000139d0: 7479 7065 3a20 6967 6e6f 7265 0a0a 2020  type: ignore..  
-000139e0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-000139f0: 656c 662c 2070 6970 655f 6e61 6d65 3a20  elf, pipe_name: 
-00013a00: 7374 722c 2068 6f73 743a 2073 7472 293a  str, host: str):
-00013a10: 0a20 2020 2020 2020 2073 656c 662e 7069  .        self.pi
-00013a20: 7065 5f6e 616d 6520 3d20 7069 7065 5f6e  pe_name = pipe_n
-00013a30: 616d 650a 2020 2020 2020 2020 7365 6c66  ame.        self
-00013a40: 2e68 6f73 7420 3d20 686f 7374 0a0a 2020  .host = host..  
-00013a50: 2020 6465 6620 6765 745f 7371 6c73 5f66    def get_sqls_f
-00013a60: 6f72 5f72 6571 7565 7374 735f 746f 5f63  or_requests_to_c
-00013a70: 6865 636b 280a 2020 2020 2020 2020 7365  heck(.        se
-00013a80: 6c66 2c0a 2020 2020 2020 2020 6d61 7463  lf,.        matc
-00013a90: 6865 733a 204c 6973 745b 7374 725d 2c0a  hes: List[str],.
-00013aa0: 2020 2020 2020 2020 7361 6d70 6c65 5f62          sample_b
-00013ab0: 795f 7061 7261 6d73 3a20 696e 742c 0a20  y_params: int,. 
-00013ac0: 2020 2020 2020 206c 696d 6974 3a20 696e         limit: in
-00013ad0: 742c 0a20 2020 2020 2020 2070 6970 655f  t,.        pipe_
-00013ae0: 7374 6174 735f 7274 5f74 6162 6c65 3a20  stats_rt_table: 
-00013af0: 7374 7220 3d20 2222 2c0a 2020 2020 2020  str = "",.      
-00013b00: 2020 6578 7472 615f 7768 6572 655f 636c    extra_where_cl
-00013b10: 6175 7365 3a20 7374 7220 3d20 2222 2c0a  ause: str = "",.
-00013b20: 2020 2020 293a 0a20 2020 2020 2020 2070      ):.        p
-00013b30: 6970 655f 7374 6174 735f 7274 203d 2070  ipe_stats_rt = p
-00013b40: 6970 655f 7374 6174 735f 7274 5f74 6162  ipe_stats_rt_tab
-00013b50: 6c65 206f 7220 2274 696e 7962 6972 642e  le or "tinybird.
-00013b60: 7069 7065 5f73 7461 7473 5f72 7422 0a20  pipe_stats_rt". 
-00013b70: 2020 2020 2020 2023 2054 4f44 4f20 6974         # TODO it
-00013b80: 206d 6179 206e 6f74 2062 6520 6e65 6564   may not be need
-00013b90: 6564 2074 6f20 6578 7472 6163 7420 746f  ed to extract to
-00013ba0: 6b65 6e2c 2070 6970 655f 6368 6563 6b65  ken, pipe_checke
-00013bb0: 722c 2066 6f72 6d20 6f72 2064 6562 7567  r, form or debug
-00013bc0: 2e20 5468 6579 206d 6179 2062 6520 7573  . They may be us
-00013bd0: 6564 2069 6e20 6e65 7874 2073 7465 7073  ed in next steps
-00013be0: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
-00013bf0: 6578 7472 6163 7455 524c 5061 7261 6d65  extractURLParame
-00013c00: 7465 7228 6173 7375 6d65 4e6f 744e 756c  ter(assumeNotNul
-00013c10: 6c28 7572 6c29 2c20 2766 726f 6d27 2920  l(url), 'from') 
-00013c20: 3c3e 2027 7569 2720 7368 6f75 6c64 2072  <> 'ui' should r
-00013c30: 6561 6420 6672 6f6d 2072 6571 7565 7374  ead from request
-00013c40: 5f70 6172 616d 5f6e 616d 6573 2e0a 2020  _param_names..  
-00013c50: 2020 2020 2020 7371 6c5f 666f 725f 636f        sql_for_co
-00013c60: 7665 7261 6765 203d 2066 2222 220a 2020  verage = f""".  
-00013c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c80: 2020 5345 4c45 4354 0a20 2020 2020 2020    SELECT.       
-00013c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ca0: 2067 726f 7570 4172 7261 7953 616d 706c   groupArraySampl
-00013cb0: 6528 7b73 616d 706c 655f 6279 5f70 6172  e({sample_by_par
-00013cc0: 616d 7320 6966 2073 616d 706c 655f 6279  ams if sample_by
-00013cd0: 5f70 6172 616d 7320 3e20 3020 656c 7365  _params > 0 else
-00013ce0: 2031 7d29 2875 726c 2920 6173 2065 6e64   1})(url) as end
-00013cf0: 706f 696e 745f 7572 6c2c 0a20 2020 2020  point_url,.     
-00013d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d10: 2020 2067 726f 7570 4172 7261 7953 616d     groupArraySam
-00013d20: 706c 6528 7b73 616d 706c 655f 6279 5f70  ple({sample_by_p
-00013d30: 6172 616d 7320 6966 2073 616d 706c 655f  arams if sample_
-00013d40: 6279 5f70 6172 616d 7320 3e20 3020 656c  by_params > 0 el
-00013d50: 7365 2031 7d29 2870 6970 655f 7265 7175  se 1})(pipe_requ
-00013d60: 6573 745f 7061 7261 6d73 2920 6173 2070  est_params) as p
-00013d70: 6970 655f 7265 7175 6573 745f 7061 7261  ipe_request_para
-00013d80: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-00013d90: 2020 2020 2020 2020 2020 2020 6874 7470              http
-00013da0: 5f6d 6574 686f 640a 2020 2020 2020 2020  _method.        
-00013db0: 2020 2020 2020 2020 2020 2020 4652 4f4d              FROM
-00013dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013dd0: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
-00013de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013df0: 2020 2053 656c 6563 740a 2020 2020 2020     Select.      
-00013e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e10: 2020 2020 2020 7572 6c2c 0a20 2020 2020        url,.     
-00013e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e30: 2020 2020 2020 206d 6170 4669 6c74 6572         mapFilter
-00013e40: 2828 6b2c 2076 2920 2d3e 2028 6b20 6e6f  ((k, v) -> (k no
-00013e50: 7420 494e 2028 2774 6f6b 656e 272c 2027  t IN ('token', '
-00013e60: 7069 7065 5f63 6865 636b 6572 272c 2027  pipe_checker', '
-00013e70: 6672 6f6d 272c 2027 6465 6275 6727 2929  from', 'debug'))
-00013e80: 2c20 7061 7261 6d65 7465 7273 2920 4153  , parameters) AS
-00013e90: 2070 6970 655f 7265 7175 6573 745f 7061   pipe_request_pa
-00013ea0: 7261 6d73 2c0a 2020 2020 2020 2020 2020  rams,.          
-00013eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ec0: 2020 6d61 704b 6579 7328 7069 7065 5f72    mapKeys(pipe_r
-00013ed0: 6571 7565 7374 5f70 6172 616d 7329 2072  equest_params) r
-00013ee0: 6571 7565 7374 5f70 6172 616d 5f6e 616d  equest_param_nam
-00013ef0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00013370: 2020 2020 2020 2222 2259 6965 6c64 2069        """Yield i
+00013380: 7465 6d73 2066 726f 6d20 616e 7920 6e65  tems from any ne
+00013390: 7374 6564 2069 7465 7261 626c 653b 2073  sted iterable; s
+000133a0: 6565 2052 6566 6572 656e 6365 2e22 2222  ee Reference."""
+000133b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000133c0: 2020 2020 2020 2020 206f 7574 7075 7420           output 
+000133d0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+000133e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000133f0: 2078 2069 6e20 6974 656d 733a 0a20 2020   x in items:.   
+00013400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013410: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00013420: 7374 616e 6365 2878 2c20 4974 6572 6162  stance(x, Iterab
+00013430: 6c65 2920 616e 6420 6e6f 7420 6973 696e  le) and not isin
+00013440: 7374 616e 6365 2878 2c20 2873 7472 2c20  stance(x, (str, 
+00013450: 6279 7465 7329 293a 0a20 2020 2020 2020  bytes)):.       
+00013460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013470: 2020 2020 2020 2020 206f 7574 7075 742e           output.
+00013480: 6578 7465 6e64 2866 6c61 7474 656e 2878  extend(flatten(x
+00013490: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+000134a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000134b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000134c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000134d0: 2020 2020 206f 7574 7075 742e 6170 7065       output.appe
+000134e0: 6e64 2878 290a 2020 2020 2020 2020 2020  nd(x).          
+000134f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00013500: 7475 726e 206f 7574 7075 740a 0a20 2020  turn output..   
+00013510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013520: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00013530: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
+00013540: 2020 2020 2020 2020 2020 2066 6c61 7474             flatt
+00013550: 656e 2863 7572 7265 6e74 5f64 6174 615f  en(current_data_
+00013560: 655b 785d 292e 736f 7274 2829 2c0a 2020  e[x]).sort(),.  
+00013570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013580: 2020 2020 2020 666c 6174 7465 6e28 6368        flatten(ch
+00013590: 6563 6b5f 6669 7874 7572 6573 5f64 6174  eck_fixtures_dat
+000135a0: 615f 655b 785d 292e 736f 7274 2829 2c0a  a_e[x]).sort(),.
+000135b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135c0: 2020 2020 2020 2020 225c 6e22 202b 2073          "\n" + s
+000135d0: 656c 662e 6469 6666 2863 7572 7265 6e74  elf.diff(current
+000135e0: 5f64 6174 615f 652c 2063 6865 636b 5f66  _data_e, check_f
+000135f0: 6978 7475 7265 735f 6461 7461 5f65 292c  ixtures_data_e),
+00013600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013610: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00013620: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00013630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013640: 2073 656c 662e 6173 7365 7274 4571 7561   self.assertEqua
+00013650: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
+00013660: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+00013670: 6e74 5f64 6174 615f 655b 785d 2c0a 2020  nt_data_e[x],.  
+00013680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013690: 2020 2020 2020 6368 6563 6b5f 6669 7874        check_fixt
+000136a0: 7572 6573 5f64 6174 615f 655b 785d 2c0a  ures_data_e[x],.
+000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136c0: 2020 2020 2020 2020 225c 6e22 202b 2073          "\n" + s
+000136d0: 656c 662e 6469 6666 2863 7572 7265 6e74  elf.diff(current
+000136e0: 5f64 6174 615f 652c 2063 6865 636b 5f66  _data_e, check_f
+000136f0: 6978 7475 7265 735f 6461 7461 5f65 292c  ixtures_data_e),
+00013700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013710: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00013720: 7275 6e54 6573 7428 7365 6c66 2920 2d3e  runTest(self) ->
+00013730: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+00013740: 6620 2264 6562 7567 2220 696e 2073 656c  f "debug" in sel
+00013750: 662e 7069 7065 5f72 6571 7565 7374 5f70  f.pipe_request_p
+00013760: 6172 616d 7320 6f72 2028 0a20 2020 2020  arams or (.     
+00013770: 2020 2020 2020 2022 6672 6f6d 2220 696e         "from" in
+00013780: 2073 656c 662e 7069 7065 5f72 6571 7565   self.pipe_reque
+00013790: 7374 5f70 6172 616d 7320 616e 6420 7365  st_params and se
+000137a0: 6c66 2e70 6970 655f 7265 7175 6573 745f  lf.pipe_request_
+000137b0: 7061 7261 6d73 5b22 6672 6f6d 225d 203d  params["from"] =
+000137c0: 3d20 2275 6922 0a20 2020 2020 2020 2029  = "ui".        )
+000137d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000137e0: 6c66 2e73 6b69 7054 6573 7428 2266 6f75  lf.skipTest("fou
+000137f0: 6e64 2064 6562 7567 2070 6172 616d 2229  nd debug param")
+00013800: 0a0a 2020 2020 2020 2020 2320 4c65 7427  ..        # Let'
+00013810: 7320 7265 7472 7920 7468 6520 7661 6c69  s retry the vali
+00013820: 6461 7469 6f6e 2074 6f20 6176 6f69 6420  dation to avoid 
+00013830: 6661 6c73 6520 616c 6572 7473 2077 6865  false alerts whe
+00013840: 6e20 6465 616c 696e 6720 7769 7468 2065  n dealing with e
+00013850: 6e64 706f 696e 7473 2074 6861 7420 6861  ndpoints that ha
+00013860: 7665 2063 6f6e 7469 6e75 6f73 2069 6e67  ve continuos ing
+00013870: 6573 7469 6f6e 0a20 2020 2020 2020 2072  estion.        r
+00013880: 6574 7269 6573 203d 2030 0a20 2020 2020  etries = 0.     
+00013890: 2020 2077 6869 6c65 2072 6574 7269 6573     while retries
+000138a0: 203c 2073 656c 662e 5245 5452 4945 535f   < self.RETRIES_
+000138b0: 4c49 4d49 543a 0a20 2020 2020 2020 2020  LIMIT:.         
+000138c0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000138d0: 2020 2020 2020 2020 7365 6c66 2e5f 7275          self._ru
+000138e0: 6e54 6573 7428 290a 2020 2020 2020 2020  nTest().        
+000138f0: 2020 2020 6578 6365 7074 2041 7373 6572      except Asser
+00013900: 7469 6f6e 4572 726f 7220 6173 2065 3a0a  tionError as e:.
+00013910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013920: 7265 7472 6965 7320 2b3d 2031 0a20 2020  retries += 1.   
+00013930: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00013940: 7265 7472 6965 7320 3e3d 2073 656c 662e  retries >= self.
+00013950: 5245 5452 4945 535f 4c49 4d49 543a 0a20  RETRIES_LIMIT:. 
+00013960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013970: 2020 2072 6169 7365 2065 0a20 2020 2020     raise e.     
+00013980: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00013990: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+000139a0: 616b 0a0a 0a40 6461 7461 636c 6173 730a  ak...@dataclass.
+000139b0: 636c 6173 7320 5069 7065 4368 6563 6b65  class PipeChecke
+000139c0: 7252 756e 6e65 7252 6573 706f 6e73 653a  rRunnerResponse:
+000139d0: 0a20 2020 2070 6970 655f 6e61 6d65 3a20  .    pipe_name: 
+000139e0: 7374 720a 2020 2020 7465 7374 5f74 7970  str.    test_typ
+000139f0: 653a 2073 7472 0a20 2020 206f 7574 7075  e: str.    outpu
+00013a00: 743a 2073 7472 0a20 2020 206d 6574 7269  t: str.    metri
+00013a10: 6373 5f73 756d 6d61 7279 3a20 4f70 7469  cs_summary: Opti
+00013a20: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
+00013a30: 6e79 5d5d 0a20 2020 206d 6574 7269 6373  ny]].    metrics
+00013a40: 5f74 696d 696e 673a 2044 6963 745b 7374  _timing: Dict[st
+00013a50: 722c 2054 7570 6c65 5b66 6c6f 6174 2c20  r, Tuple[float, 
+00013a60: 666c 6f61 742c 2066 6c6f 6174 5d5d 0a20  float, float]]. 
+00013a70: 2020 2066 6169 6c65 643a 204c 6973 745b     failed: List[
+00013a80: 4469 6374 5b73 7472 2c20 7374 725d 5d0a  Dict[str, str]].
+00013a90: 2020 2020 7761 735f 7375 6363 6573 7366      was_successf
+00013aa0: 756c 6c3a 2062 6f6f 6c0a 0a0a 636c 6173  ull: bool...clas
+00013ab0: 7320 5069 7065 4368 6563 6b65 7252 756e  s PipeCheckerRun
+00013ac0: 6e65 723a 0a20 2020 2063 6865 636b 6572  ner:.    checker
+00013ad0: 5f73 7472 6561 6d5f 7265 7375 6c74 5f63  _stream_result_c
+00013ae0: 6c61 7373 203d 2075 6e69 7474 6573 742e  lass = unittest.
+00013af0: 7275 6e6e 6572 2e5f 5772 6974 656c 6e44  runner._WritelnD
+00013b00: 6563 6f72 6174 6f72 2020 2320 7479 7065  ecorator  # type
+00013b10: 3a20 6967 6e6f 7265 0a0a 2020 2020 6465  : ignore..    de
+00013b20: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00013b30: 2070 6970 655f 6e61 6d65 3a20 7374 722c   pipe_name: str,
+00013b40: 2068 6f73 743a 2073 7472 293a 0a20 2020   host: str):.   
+00013b50: 2020 2020 2073 656c 662e 7069 7065 5f6e       self.pipe_n
+00013b60: 616d 6520 3d20 7069 7065 5f6e 616d 650a  ame = pipe_name.
+00013b70: 2020 2020 2020 2020 7365 6c66 2e68 6f73          self.hos
+00013b80: 7420 3d20 686f 7374 0a0a 2020 2020 6465  t = host..    de
+00013b90: 6620 6765 745f 7371 6c73 5f66 6f72 5f72  f get_sqls_for_r
+00013ba0: 6571 7565 7374 735f 746f 5f63 6865 636b  equests_to_check
+00013bb0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00013bc0: 2020 2020 2020 2020 6d61 7463 6865 733a          matches:
+00013bd0: 204c 6973 745b 7374 725d 2c0a 2020 2020   List[str],.    
+00013be0: 2020 2020 7361 6d70 6c65 5f62 795f 7061      sample_by_pa
+00013bf0: 7261 6d73 3a20 696e 742c 0a20 2020 2020  rams: int,.     
+00013c00: 2020 206c 696d 6974 3a20 696e 742c 0a20     limit: int,. 
+00013c10: 2020 2020 2020 2070 6970 655f 7374 6174         pipe_stat
+00013c20: 735f 7274 5f74 6162 6c65 3a20 7374 7220  s_rt_table: str 
+00013c30: 3d20 2222 2c0a 2020 2020 2020 2020 6578  = "",.        ex
+00013c40: 7472 615f 7768 6572 655f 636c 6175 7365  tra_where_clause
+00013c50: 3a20 7374 7220 3d20 2222 2c0a 2020 2020  : str = "",.    
+00013c60: 293a 0a20 2020 2020 2020 2070 6970 655f  ):.        pipe_
+00013c70: 7374 6174 735f 7274 203d 2070 6970 655f  stats_rt = pipe_
+00013c80: 7374 6174 735f 7274 5f74 6162 6c65 206f  stats_rt_table o
+00013c90: 7220 2274 696e 7962 6972 642e 7069 7065  r "tinybird.pipe
+00013ca0: 5f73 7461 7473 5f72 7422 0a20 2020 2020  _stats_rt".     
+00013cb0: 2020 2023 2054 4f44 4f20 6974 206d 6179     # TODO it may
+00013cc0: 206e 6f74 2062 6520 6e65 6564 6564 2074   not be needed t
+00013cd0: 6f20 6578 7472 6163 7420 746f 6b65 6e2c  o extract token,
+00013ce0: 2070 6970 655f 6368 6563 6b65 722c 2066   pipe_checker, f
+00013cf0: 6f72 6d20 6f72 2064 6562 7567 2e20 5468  orm or debug. Th
+00013d00: 6579 206d 6179 2062 6520 7573 6564 2069  ey may be used i
+00013d10: 6e20 6e65 7874 2073 7465 7073 0a20 2020  n next steps.   
+00013d20: 2020 2020 2023 2054 4f44 4f20 6578 7472       # TODO extr
+00013d30: 6163 7455 524c 5061 7261 6d65 7465 7228  actURLParameter(
+00013d40: 6173 7375 6d65 4e6f 744e 756c 6c28 7572  assumeNotNull(ur
+00013d50: 6c29 2c20 2766 726f 6d27 2920 3c3e 2027  l), 'from') <> '
+00013d60: 7569 2720 7368 6f75 6c64 2072 6561 6420  ui' should read 
+00013d70: 6672 6f6d 2072 6571 7565 7374 5f70 6172  from request_par
+00013d80: 616d 5f6e 616d 6573 2e0a 2020 2020 2020  am_names..      
+00013d90: 2020 7371 6c5f 666f 725f 636f 7665 7261    sql_for_covera
+00013da0: 6765 203d 2066 2222 220a 2020 2020 2020  ge = f""".      
+00013db0: 2020 2020 2020 2020 2020 2020 2020 5345                SE
+00013dc0: 4c45 4354 0a20 2020 2020 2020 2020 2020  LECT.           
+00013dd0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00013de0: 7570 4172 7261 7953 616d 706c 6528 7b73  upArraySample({s
+00013df0: 616d 706c 655f 6279 5f70 6172 616d 7320  ample_by_params 
+00013e00: 6966 2073 616d 706c 655f 6279 5f70 6172  if sample_by_par
+00013e10: 616d 7320 3e20 3020 656c 7365 2031 7d29  ams > 0 else 1})
+00013e20: 2875 726c 2920 6173 2065 6e64 706f 696e  (url) as endpoin
+00013e30: 745f 7572 6c2c 0a20 2020 2020 2020 2020  t_url,.         
+00013e40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00013e50: 726f 7570 4172 7261 7953 616d 706c 6528  roupArraySample(
+00013e60: 7b73 616d 706c 655f 6279 5f70 6172 616d  {sample_by_param
+00013e70: 7320 6966 2073 616d 706c 655f 6279 5f70  s if sample_by_p
+00013e80: 6172 616d 7320 3e20 3020 656c 7365 2031  arams > 0 else 1
+00013e90: 7d29 2870 6970 655f 7265 7175 6573 745f  })(pipe_request_
+00013ea0: 7061 7261 6d73 2920 6173 2070 6970 655f  params) as pipe_
+00013eb0: 7265 7175 6573 745f 7061 7261 6d73 2c0a  request_params,.
+00013ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ed0: 2020 2020 2020 2020 6874 7470 5f6d 6574          http_met
+00013ee0: 686f 640a 2020 2020 2020 2020 2020 2020  hod.            
+00013ef0: 2020 2020 2020 2020 4652 4f4d 0a20 2020          FROM.   
 00013f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f10: 6578 7472 6163 7455 524c 5061 7261 6d65  extractURLParame
-00013f20: 7465 724e 616d 6573 2861 7373 756d 654e  terNames(assumeN
-00013f30: 6f74 4e75 6c6c 2875 726c 2929 2061 7320  otNull(url)) as 
-00013f40: 7572 6c5f 7061 7261 6d5f 6e61 6d65 732c  url_param_names,
-00013f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013f60: 2020 2020 2020 2020 2020 2020 206d 6574               met
-00013f70: 686f 6420 6173 2068 7474 705f 6d65 7468  hod as http_meth
-00013f80: 6f64 0a20 2020 2020 2020 2020 2020 2020  od.             
-00013f90: 2020 2020 2020 2020 2020 2046 524f 4d20             FROM 
-00013fa0: 7b70 6970 655f 7374 6174 735f 7274 7d0a  {pipe_stats_rt}.
-00013fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013fc0: 2020 2020 2020 2020 5748 4552 450a 2020          WHERE.  
-00013fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013fe0: 2020 2020 2020 2020 2020 7069 7065 5f6e            pipe_n
-00013ff0: 616d 6520 3d20 277b 7365 6c66 2e70 6970  ame = '{self.pip
-00014000: 655f 6e61 6d65 7d27 0a20 2020 2020 2020  e_name}'.       
-00014010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014020: 2020 2020 2041 4e44 2075 726c 2049 5320       AND url IS 
-00014030: 4e4f 5420 4e55 4c4c 0a20 2020 2020 2020  NOT NULL.       
-00014040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014050: 2020 2020 2041 4e44 2065 7874 7261 6374       AND extract
-00014060: 5552 4c50 6172 616d 6574 6572 2861 7373  URLParameter(ass
-00014070: 756d 654e 6f74 4e75 6c6c 2875 726c 292c  umeNotNull(url),
-00014080: 2027 6672 6f6d 2729 203c 3e20 2775 6927   'from') <> 'ui'
-00014090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000140a0: 2020 2020 2020 2020 2020 2020 2041 4e44               AND
-000140b0: 2065 7874 7261 6374 5552 4c50 6172 616d   extractURLParam
-000140c0: 6574 6572 2861 7373 756d 654e 6f74 4e75  eter(assumeNotNu
-000140d0: 6c6c 2875 726c 292c 2027 7069 7065 5f63  ll(url), 'pipe_c
-000140e0: 6865 636b 6572 2729 203c 3e20 2774 7275  hecker') <> 'tru
-000140f0: 6527 0a20 2020 2020 2020 2020 2020 2020  e'.             
-00014100: 2020 2020 2020 2020 2020 2020 2020 2041                 A
-00014110: 4e44 2065 7874 7261 6374 5552 4c50 6172  ND extractURLPar
-00014120: 616d 6574 6572 2861 7373 756d 654e 6f74  ameter(assumeNot
-00014130: 4e75 6c6c 2875 726c 292c 2027 6465 6275  Null(url), 'debu
-00014140: 6727 2920 3c3e 2027 7175 6572 7927 0a20  g') <> 'query'. 
+00013f10: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
+00013f20: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+00013f30: 656c 6563 740a 2020 2020 2020 2020 2020  elect.          
+00013f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f50: 2020 7572 6c2c 0a20 2020 2020 2020 2020    url,.         
+00013f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f70: 2020 206d 6170 4669 6c74 6572 2828 6b2c     mapFilter((k,
+00013f80: 2076 2920 2d3e 2028 6b20 6e6f 7420 494e   v) -> (k not IN
+00013f90: 2028 2774 6f6b 656e 272c 2027 7069 7065   ('token', 'pipe
+00013fa0: 5f63 6865 636b 6572 272c 2027 6672 6f6d  _checker', 'from
+00013fb0: 272c 2027 6465 6275 6727 2929 2c20 7061  ', 'debug')), pa
+00013fc0: 7261 6d65 7465 7273 2920 4153 2070 6970  rameters) AS pip
+00013fd0: 655f 7265 7175 6573 745f 7061 7261 6d73  e_request_params
+00013fe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013ff0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00014000: 704b 6579 7328 7069 7065 5f72 6571 7565  pKeys(pipe_reque
+00014010: 7374 5f70 6172 616d 7329 2072 6571 7565  st_params) reque
+00014020: 7374 5f70 6172 616d 5f6e 616d 6573 2c0a  st_param_names,.
+00014030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014040: 2020 2020 2020 2020 2020 2020 6578 7472              extr
+00014050: 6163 7455 524c 5061 7261 6d65 7465 724e  actURLParameterN
+00014060: 616d 6573 2861 7373 756d 654e 6f74 4e75  ames(assumeNotNu
+00014070: 6c6c 2875 726c 2929 2061 7320 7572 6c5f  ll(url)) as url_
+00014080: 7061 7261 6d5f 6e61 6d65 732c 0a20 2020  param_names,.   
+00014090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000140a0: 2020 2020 2020 2020 206d 6574 686f 6420           method 
+000140b0: 6173 2068 7474 705f 6d65 7468 6f64 0a20  as http_method. 
+000140c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000140d0: 2020 2020 2020 2046 524f 4d20 7b70 6970         FROM {pip
+000140e0: 655f 7374 6174 735f 7274 7d0a 2020 2020  e_stats_rt}.    
+000140f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014100: 2020 2020 5748 4552 450a 2020 2020 2020      WHERE.      
+00014110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014120: 2020 2020 2020 7069 7065 5f6e 616d 6520        pipe_name 
+00014130: 3d20 277b 7365 6c66 2e70 6970 655f 6e61  = '{self.pipe_na
+00014140: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
 00014150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014160: 2020 2020 2020 2020 2020 2041 4e44 2065             AND e
-00014170: 7272 6f72 203d 2030 0a20 2020 2020 2020  rror = 0.       
+00014160: 2041 4e44 2075 726c 2049 5320 4e4f 5420   AND url IS NOT 
+00014170: 4e55 4c4c 0a20 2020 2020 2020 2020 2020  NULL.           
 00014180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014190: 2020 2020 2041 4e44 206e 6f74 206d 6170       AND not map
-000141a0: 436f 6e74 6169 6e73 2870 6172 616d 6574  Contains(paramet
-000141b0: 6572 732c 2027 5f5f 7462 5f5f 7365 6d76  ers, '__tb__semv
-000141c0: 6572 2729 0a20 2020 2020 2020 2020 2020  er').           
+00014190: 2041 4e44 2065 7874 7261 6374 5552 4c50   AND extractURLP
+000141a0: 6172 616d 6574 6572 2861 7373 756d 654e  arameter(assumeN
+000141b0: 6f74 4e75 6c6c 2875 726c 292c 2027 6672  otNull(url), 'fr
+000141c0: 6f6d 2729 203c 3e20 2775 6927 0a20 2020  om') <> 'ui'.   
 000141d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141e0: 207b 2220 414e 4420 2220 2b20 2220 414e   {" AND " + " AN
-000141f0: 4420 222e 6a6f 696e 285b 6622 6d61 7043  D ".join([f"mapC
-00014200: 6f6e 7461 696e 7328 7069 7065 5f72 6571  ontains(pipe_req
-00014210: 7565 7374 5f70 6172 616d 732c 2027 7b6d  uest_params, '{m
-00014220: 6174 6368 7d27 2922 2066 6f72 206d 6174  atch}')" for mat
-00014230: 6368 2069 6e20 6d61 7463 6865 735d 2920  ch in matches]) 
-00014240: 6966 206d 6174 6368 6573 2061 6e64 206c  if matches and l
-00014250: 656e 286d 6174 6368 6573 2920 3e20 3020  en(matches) > 0 
-00014260: 656c 7365 2027 277d 0a20 2020 2020 2020  else ''}.       
-00014270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014280: 2020 2020 207b 2065 7874 7261 5f77 6865       { extra_whe
-00014290: 7265 5f63 6c61 7573 6520 7d0a 2020 2020  re_clause }.    
-000142a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142b0: 2020 2020 4c69 6d69 7420 3530 3030 3030      Limit 500000
-000142c0: 3020 2d2d 2045 6e6f 7567 6820 746f 2062  0 -- Enough to b
-000142d0: 7269 6e67 2064 6174 6120 7768 696c 6520  ring data while 
-000142e0: 6e6f 7420 7072 6f63 6573 7369 6e67 2061  not processing a
-000142f0: 6c6c 2072 6571 7565 7374 7320 6672 6f6d  ll requests from
-00014300: 2068 6967 686c 7920 7573 6564 2070 6970   highly used pip
-00014310: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00014320: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00014330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014340: 2067 726f 7570 2062 7920 7265 7175 6573   group by reques
-00014350: 745f 7061 7261 6d5f 6e61 6d65 732c 2068  t_param_names, h
-00014360: 7474 705f 6d65 7468 6f64 0a20 2020 2020  ttp_method.     
-00014370: 2020 2020 2020 2020 2020 2020 2020 2046                 F
-00014380: 4f52 4d41 5420 4a53 4f4e 0a20 2020 2020  ORMAT JSON.     
-00014390: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000143a0: 2222 0a20 2020 2020 2020 2073 716c 5f6c  "".        sql_l
-000143b0: 6174 6573 745f 7265 7175 6573 7473 203d  atest_requests =
-000143c0: 2066 2222 220a 2020 2020 2020 2020 2020   f""".          
-000143d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143e0: 2020 2020 2020 5345 4c45 4354 0a20 2020        SELECT.   
-000143f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014410: 205b 6669 7273 745f 7661 6c75 6528 7572   [first_value(ur
-00014420: 6c29 5d20 6173 2065 6e64 706f 696e 745f  l)] as endpoint_
-00014430: 7572 6c2c 0a20 2020 2020 2020 2020 2020  url,.           
-00014440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014450: 2020 2020 2020 2020 205b 7069 7065 5f72           [pipe_r
-00014460: 6571 7565 7374 5f70 6172 616d 735d 2061  equest_params] a
-00014470: 7320 7069 7065 5f72 6571 7565 7374 5f70  s pipe_request_p
-00014480: 6172 616d 732c 0a20 2020 2020 2020 2020  arams,.         
-00014490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144a0: 2020 2020 2020 2020 2020 2068 7474 705f             http_
-000144b0: 6d65 7468 6f64 0a20 2020 2020 2020 2020  method.         
-000144c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144d0: 2020 2020 2020 2046 524f 4d20 280a 2020         FROM (.  
-000144e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014500: 2020 5345 4c45 4354 2061 7373 756d 654e    SELECT assumeN
-00014510: 6f74 4e75 6c6c 2875 726c 2920 6173 2075  otNull(url) as u
-00014520: 726c 2c0a 2020 2020 2020 2020 2020 2020  rl,.            
+000141e0: 2020 2020 2020 2020 2041 4e44 2065 7874           AND ext
+000141f0: 7261 6374 5552 4c50 6172 616d 6574 6572  ractURLParameter
+00014200: 2861 7373 756d 654e 6f74 4e75 6c6c 2875  (assumeNotNull(u
+00014210: 726c 292c 2027 7069 7065 5f63 6865 636b  rl), 'pipe_check
+00014220: 6572 2729 203c 3e20 2774 7275 6527 0a20  er') <> 'true'. 
+00014230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014240: 2020 2020 2020 2020 2020 2041 4e44 2065             AND e
+00014250: 7874 7261 6374 5552 4c50 6172 616d 6574  xtractURLParamet
+00014260: 6572 2861 7373 756d 654e 6f74 4e75 6c6c  er(assumeNotNull
+00014270: 2875 726c 292c 2027 6465 6275 6727 2920  (url), 'debug') 
+00014280: 3c3e 2027 7175 6572 7927 0a20 2020 2020  <> 'query'.     
+00014290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142a0: 2020 2020 2020 2041 4e44 2065 7272 6f72         AND error
+000142b0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+000142c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142d0: 2041 4e44 206e 6f74 206d 6170 436f 6e74   AND not mapCont
+000142e0: 6169 6e73 2870 6172 616d 6574 6572 732c  ains(parameters,
+000142f0: 2027 5f5f 7462 5f5f 7365 6d76 6572 2729   '__tb__semver')
+00014300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014310: 2020 2020 2020 2020 2020 2020 207b 2220               {" 
+00014320: 414e 4420 2220 2b20 2220 414e 4420 222e  AND " + " AND ".
+00014330: 6a6f 696e 285b 6622 6d61 7043 6f6e 7461  join([f"mapConta
+00014340: 696e 7328 7069 7065 5f72 6571 7565 7374  ins(pipe_request
+00014350: 5f70 6172 616d 732c 2027 7b6d 6174 6368  _params, '{match
+00014360: 7d27 2922 2066 6f72 206d 6174 6368 2069  }')" for match i
+00014370: 6e20 6d61 7463 6865 735d 2920 6966 206d  n matches]) if m
+00014380: 6174 6368 6573 2061 6e64 206c 656e 286d  atches and len(m
+00014390: 6174 6368 6573 2920 3e20 3020 656c 7365  atches) > 0 else
+000143a0: 2027 277d 0a20 2020 2020 2020 2020 2020   ''}.           
+000143b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143c0: 207b 2065 7874 7261 5f77 6865 7265 5f63   { extra_where_c
+000143d0: 6c61 7573 6520 7d0a 2020 2020 2020 2020  lause }.        
+000143e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143f0: 4c69 6d69 7420 3530 3030 3030 3020 2d2d  Limit 5000000 --
+00014400: 2045 6e6f 7567 6820 746f 2062 7269 6e67   Enough to bring
+00014410: 2064 6174 6120 7768 696c 6520 6e6f 7420   data while not 
+00014420: 7072 6f63 6573 7369 6e67 2061 6c6c 2072  processing all r
+00014430: 6571 7565 7374 7320 6672 6f6d 2068 6967  equests from hig
+00014440: 686c 7920 7573 6564 2070 6970 6573 0a20  hly used pipes. 
+00014450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014460: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00014470: 2020 2020 2020 2020 2020 2020 2067 726f               gro
+00014480: 7570 2062 7920 7265 7175 6573 745f 7061  up by request_pa
+00014490: 7261 6d5f 6e61 6d65 732c 2068 7474 705f  ram_names, http_
+000144a0: 6d65 7468 6f64 0a20 2020 2020 2020 2020  method.         
+000144b0: 2020 2020 2020 2020 2020 2046 4f52 4d41             FORMA
+000144c0: 5420 4a53 4f4e 0a20 2020 2020 2020 2020  T JSON.         
+000144d0: 2020 2020 2020 2020 2020 2022 2222 0a20             """. 
+000144e0: 2020 2020 2020 2073 716c 5f6c 6174 6573         sql_lates
+000144f0: 745f 7265 7175 6573 7473 203d 2066 2222  t_requests = f""
+00014500: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00014510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014520: 2020 5345 4c45 4354 0a20 2020 2020 2020    SELECT.       
 00014530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014540: 2020 2020 2020 2020 2020 2020 6d61 7046              mapF
-00014550: 696c 7465 7228 286b 2c20 7629 202d 3e20  ilter((k, v) -> 
-00014560: 286b 206e 6f74 2049 4e20 2827 746f 6b65  (k not IN ('toke
-00014570: 6e27 2c20 2770 6970 655f 6368 6563 6b65  n', 'pipe_checke
-00014580: 7227 2c20 2766 726f 6d27 2c20 2764 6562  r', 'from', 'deb
-00014590: 7567 2729 292c 2070 6172 616d 6574 6572  ug')), parameter
-000145a0: 7329 2041 5320 7069 7065 5f72 6571 7565  s) AS pipe_reque
-000145b0: 7374 5f70 6172 616d 732c 0a20 2020 2020  st_params,.     
-000145c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014540: 2020 2020 2020 2020 2020 2020 205b 6669               [fi
+00014550: 7273 745f 7661 6c75 6528 7572 6c29 5d20  rst_value(url)] 
+00014560: 6173 2065 6e64 706f 696e 745f 7572 6c2c  as endpoint_url,
+00014570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014590: 2020 2020 205b 7069 7065 5f72 6571 7565       [pipe_reque
+000145a0: 7374 5f70 6172 616d 735d 2061 7320 7069  st_params] as pi
+000145b0: 7065 5f72 6571 7565 7374 5f70 6172 616d  pe_request_param
+000145c0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
 000145d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145e0: 2020 206d 6170 4b65 7973 2870 6970 655f     mapKeys(pipe_
-000145f0: 7265 7175 6573 745f 7061 7261 6d73 2920  request_params) 
-00014600: 7265 7175 6573 745f 7061 7261 6d5f 6e61  request_param_na
-00014610: 6d65 732c 0a20 2020 2020 2020 2020 2020  mes,.           
+000145e0: 2020 2020 2020 2068 7474 705f 6d65 7468         http_meth
+000145f0: 6f64 0a20 2020 2020 2020 2020 2020 2020  od.             
+00014600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014610: 2020 2046 524f 4d20 280a 2020 2020 2020     FROM (.      
 00014620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014630: 2020 2020 2020 2020 2020 2020 2065 7874               ext
-00014640: 7261 6374 5552 4c50 6172 616d 6574 6572  ractURLParameter
-00014650: 4e61 6d65 7328 6173 7375 6d65 4e6f 744e  Names(assumeNotN
-00014660: 756c 6c28 7572 6c29 2920 6173 2075 726c  ull(url)) as url
-00014670: 5f70 6172 616d 5f6e 616d 6573 2c0a 2020  _param_names,.  
-00014680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146a0: 2020 2020 2020 6d65 7468 6f64 2061 7320        method as 
-000146b0: 6874 7470 5f6d 6574 686f 640a 2020 2020  http_method.    
-000146c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146e0: 4652 4f4d 207b 7069 7065 5f73 7461 7473  FROM {pipe_stats
-000146f0: 5f72 747d 0a20 2020 2020 2020 2020 2020  _rt}.           
+00014630: 2020 2020 2020 2020 2020 2020 2020 5345                SE
+00014640: 4c45 4354 2061 7373 756d 654e 6f74 4e75  LECT assumeNotNu
+00014650: 6c6c 2875 726c 2920 6173 2075 726c 2c0a  ll(url) as url,.
+00014660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014680: 2020 2020 2020 2020 6d61 7046 696c 7465          mapFilte
+00014690: 7228 286b 2c20 7629 202d 3e20 286b 206e  r((k, v) -> (k n
+000146a0: 6f74 2049 4e20 2827 746f 6b65 6e27 2c20  ot IN ('token', 
+000146b0: 2770 6970 655f 6368 6563 6b65 7227 2c20  'pipe_checker', 
+000146c0: 2766 726f 6d27 2c20 2764 6562 7567 2729  'from', 'debug')
+000146d0: 292c 2070 6172 616d 6574 6572 7329 2041  ), parameters) A
+000146e0: 5320 7069 7065 5f72 6571 7565 7374 5f70  S pipe_request_p
+000146f0: 6172 616d 732c 0a20 2020 2020 2020 2020  arams,.         
 00014700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014710: 2020 2020 2020 2020 2057 4845 5245 0a20           WHERE. 
-00014720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014740: 2020 2020 2020 2070 6970 655f 6e61 6d65         pipe_name
-00014750: 203d 2027 7b73 656c 662e 7069 7065 5f6e   = '{self.pipe_n
-00014760: 616d 657d 270a 2020 2020 2020 2020 2020  ame}'.          
-00014770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014780: 2020 2020 2020 2020 2020 2020 2020 414e                AN
-00014790: 4420 7572 6c20 4953 204e 4f54 204e 554c  D url IS NOT NUL
-000147a0: 4c0a 2020 2020 2020 2020 2020 2020 2020  L.              
-000147b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147c0: 2020 2020 2020 2020 2020 414e 4420 6578            AND ex
-000147d0: 7472 6163 7455 524c 5061 7261 6d65 7465  tractURLParamete
-000147e0: 7228 6173 7375 6d65 4e6f 744e 756c 6c28  r(assumeNotNull(
-000147f0: 7572 6c29 2c20 2766 726f 6d27 2920 3c3e  url), 'from') <>
-00014800: 2027 7569 270a 2020 2020 2020 2020 2020   'ui'.          
-00014810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014820: 2020 2020 2020 2020 2020 2020 2020 414e                AN
-00014830: 4420 6578 7472 6163 7455 524c 5061 7261  D extractURLPara
-00014840: 6d65 7465 7228 6173 7375 6d65 4e6f 744e  meter(assumeNotN
-00014850: 756c 6c28 7572 6c29 2c20 2770 6970 655f  ull(url), 'pipe_
-00014860: 6368 6563 6b65 7227 2920 3c3e 2027 7472  checker') <> 'tr
-00014870: 7565 270a 2020 2020 2020 2020 2020 2020  ue'.            
-00014880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014890: 2020 2020 2020 2020 2020 2020 414e 4420              AND 
-000148a0: 6578 7472 6163 7455 524c 5061 7261 6d65  extractURLParame
-000148b0: 7465 7228 6173 7375 6d65 4e6f 744e 756c  ter(assumeNotNul
-000148c0: 6c28 7572 6c29 2c20 2764 6562 7567 2729  l(url), 'debug')
-000148d0: 203c 3e20 2771 7565 7279 270a 2020 2020   <> 'query'.    
+00014710: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00014720: 6170 4b65 7973 2870 6970 655f 7265 7175  apKeys(pipe_requ
+00014730: 6573 745f 7061 7261 6d73 2920 7265 7175  est_params) requ
+00014740: 6573 745f 7061 7261 6d5f 6e61 6d65 732c  est_param_names,
+00014750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014770: 2020 2020 2020 2020 2065 7874 7261 6374           extract
+00014780: 5552 4c50 6172 616d 6574 6572 4e61 6d65  URLParameterName
+00014790: 7328 6173 7375 6d65 4e6f 744e 756c 6c28  s(assumeNotNull(
+000147a0: 7572 6c29 2920 6173 2075 726c 5f70 6172  url)) as url_par
+000147b0: 616d 5f6e 616d 6573 2c0a 2020 2020 2020  am_names,.      
+000147c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147e0: 2020 6d65 7468 6f64 2061 7320 6874 7470    method as http
+000147f0: 5f6d 6574 686f 640a 2020 2020 2020 2020  _method.        
+00014800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014810: 2020 2020 2020 2020 2020 2020 4652 4f4d              FROM
+00014820: 207b 7069 7065 5f73 7461 7473 5f72 747d   {pipe_stats_rt}
+00014830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014850: 2020 2020 2057 4845 5245 0a20 2020 2020       WHERE.     
+00014860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014880: 2020 2070 6970 655f 6e61 6d65 203d 2027     pipe_name = '
+00014890: 7b73 656c 662e 7069 7065 5f6e 616d 657d  {self.pipe_name}
+000148a0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000148b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148c0: 2020 2020 2020 2020 2020 414e 4420 7572            AND ur
+000148d0: 6c20 4953 204e 4f54 204e 554c 4c0a 2020  l IS NOT NULL.  
 000148e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000148f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014900: 2020 2020 414e 4420 6572 726f 7220 3d20      AND error = 
-00014910: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-00014920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014930: 2020 2020 2020 2020 2020 414e 4420 6e6f            AND no
-00014940: 7420 6d61 7043 6f6e 7461 696e 7328 7061  t mapContains(pa
-00014950: 7261 6d65 7465 7273 2c20 275f 5f74 625f  rameters, '__tb_
-00014960: 5f73 656d 7665 7227 290a 2020 2020 2020  _semver').      
-00014970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014990: 2020 7b22 2041 4e44 2022 202b 2022 2041    {" AND " + " A
-000149a0: 4e44 2022 2e6a 6f69 6e28 5b66 226d 6170  ND ".join([f"map
-000149b0: 436f 6e74 6169 6e73 2870 6970 655f 7265  Contains(pipe_re
-000149c0: 7175 6573 745f 7061 7261 6d73 2c20 277b  quest_params, '{
-000149d0: 6d61 7463 687d 2729 2220 666f 7220 6d61  match}')" for ma
-000149e0: 7463 6820 696e 206d 6174 6368 6573 5d29  tch in matches])
-000149f0: 2069 6620 6d61 7463 6865 7320 616e 6420   if matches and 
-00014a00: 6c65 6e28 6d61 7463 6865 7329 203e 2030  len(matches) > 0
-00014a10: 2065 6c73 6520 2727 7d0a 2020 2020 2020   else ''}.      
+00014900: 2020 2020 2020 414e 4420 6578 7472 6163        AND extrac
+00014910: 7455 524c 5061 7261 6d65 7465 7228 6173  tURLParameter(as
+00014920: 7375 6d65 4e6f 744e 756c 6c28 7572 6c29  sumeNotNull(url)
+00014930: 2c20 2766 726f 6d27 2920 3c3e 2027 7569  , 'from') <> 'ui
+00014940: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00014950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014960: 2020 2020 2020 2020 2020 414e 4420 6578            AND ex
+00014970: 7472 6163 7455 524c 5061 7261 6d65 7465  tractURLParamete
+00014980: 7228 6173 7375 6d65 4e6f 744e 756c 6c28  r(assumeNotNull(
+00014990: 7572 6c29 2c20 2770 6970 655f 6368 6563  url), 'pipe_chec
+000149a0: 6b65 7227 2920 3c3e 2027 7472 7565 270a  ker') <> 'true'.
+000149b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149d0: 2020 2020 2020 2020 414e 4420 6578 7472          AND extr
+000149e0: 6163 7455 524c 5061 7261 6d65 7465 7228  actURLParameter(
+000149f0: 6173 7375 6d65 4e6f 744e 756c 6c28 7572  assumeNotNull(ur
+00014a00: 6c29 2c20 2764 6562 7567 2729 203c 3e20  l), 'debug') <> 
+00014a10: 2771 7565 7279 270a 2020 2020 2020 2020  'query'.        
 00014a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00014a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a40: 2020 7b65 7874 7261 5f77 6865 7265 5f63    {extra_where_c
-00014a50: 6c61 7573 657d 0a20 2020 2020 2020 2020  lause}.         
+00014a40: 414e 4420 6572 726f 7220 3d20 300a 2020  AND error = 0.  
+00014a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00014a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a70: 2020 2020 2020 2020 2020 204c 494d 4954             LIMIT
-00014a80: 207b 6c69 6d69 747d 0a20 2020 2020 2020   {limit}.       
-00014a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014aa0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00014a70: 2020 2020 2020 414e 4420 6e6f 7420 6d61        AND not ma
+00014a80: 7043 6f6e 7461 696e 7328 7061 7261 6d65  pContains(parame
+00014a90: 7465 7273 2c20 275f 5f74 625f 5f73 656d  ters, '__tb__sem
+00014aa0: 7665 7227 290a 2020 2020 2020 2020 2020  ver').          
 00014ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ac0: 2020 2020 2020 2020 2020 2047 524f 5550             GROUP
-00014ad0: 2042 5920 7069 7065 5f72 6571 7565 7374   BY pipe_request
-00014ae0: 5f70 6172 616d 732c 2068 7474 705f 6d65  _params, http_me
-00014af0: 7468 6f64 0a20 2020 2020 2020 2020 2020  thod.           
-00014b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b10: 2020 2020 2046 4f52 4d41 5420 4a53 4f4e       FORMAT JSON
-00014b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014b30: 2020 2020 2020 2020 2020 2020 2022 2222               """
-00014b40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00014b50: 7371 6c5f 666f 725f 636f 7665 7261 6765  sql_for_coverage
-00014b60: 2c20 7371 6c5f 6c61 7465 7374 5f72 6571  , sql_latest_req
-00014b70: 7565 7374 730a 0a20 2020 2064 6566 205f  uests..    def _
-00014b80: 6765 745f 6368 6563 6b65 7228 0a20 2020  get_checker(.   
-00014b90: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00014ba0: 2020 2072 6571 7565 7374 3a20 4469 6374     request: Dict
-00014bb0: 5b73 7472 2c20 416e 795d 2c0a 2020 2020  [str, Any],.    
-00014bc0: 2020 2020 6368 6563 6b65 725f 7069 7065      checker_pipe
-00014bd0: 5f6e 616d 653a 2073 7472 2c0a 2020 2020  _name: str,.    
-00014be0: 2020 2020 746f 6b65 6e3a 2073 7472 2c0a      token: str,.
-00014bf0: 2020 2020 2020 2020 6f6e 6c79 5f72 6573          only_res
-00014c00: 706f 6e73 655f 7469 6d65 733a 2062 6f6f  ponse_times: boo
-00014c10: 6c2c 0a20 2020 2020 2020 2069 676e 6f72  l,.        ignor
-00014c20: 655f 6f72 6465 723a 2062 6f6f 6c2c 0a20  e_order: bool,. 
-00014c30: 2020 2020 2020 2076 616c 6964 6174 655f         validate_
-00014c40: 7072 6f63 6573 7365 645f 6279 7465 733a  processed_bytes:
-00014c50: 2062 6f6f 6c2c 0a20 2020 2029 202d 3e20   bool,.    ) -> 
-00014c60: 5069 7065 4368 6563 6b65 723a 0a20 2020  PipeChecker:.   
-00014c70: 2020 2020 2072 6574 7572 6e20 5069 7065       return Pipe
-00014c80: 4368 6563 6b65 7228 0a20 2020 2020 2020  Checker(.       
-00014c90: 2020 2020 2072 6571 7565 7374 2c0a 2020       request,.  
-00014ca0: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-00014cb0: 6970 655f 6e61 6d65 2c0a 2020 2020 2020  ipe_name,.      
-00014cc0: 2020 2020 2020 6368 6563 6b65 725f 7069        checker_pi
-00014cd0: 7065 5f6e 616d 652c 0a20 2020 2020 2020  pe_name,.       
-00014ce0: 2020 2020 2074 6f6b 656e 2c0a 2020 2020       token,.    
-00014cf0: 2020 2020 2020 2020 6f6e 6c79 5f72 6573          only_res
-00014d00: 706f 6e73 655f 7469 6d65 732c 0a20 2020  ponse_times,.   
-00014d10: 2020 2020 2020 2020 2069 676e 6f72 655f           ignore_
-00014d20: 6f72 6465 722c 0a20 2020 2020 2020 2020  order,.         
-00014d30: 2020 2076 616c 6964 6174 655f 7072 6f63     validate_proc
-00014d40: 6573 7365 645f 6279 7465 732c 0a20 2020  essed_bytes,.   
-00014d50: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00014d60: 5f64 656c 7461 5f70 6572 6365 6e74 6167  _delta_percentag
-00014d70: 6528 7365 6c66 2c20 6368 6563 6b65 723a  e(self, checker:
-00014d80: 2066 6c6f 6174 2c20 6375 7272 656e 743a   float, current:
-00014d90: 2066 6c6f 6174 2920 2d3e 2066 6c6f 6174   float) -> float
-00014da0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-00014db0: 2020 2020 2020 2020 2020 2069 6620 6375             if cu
-00014dc0: 7272 656e 7420 3d3d 2030 2e30 3a0a 2020  rrent == 0.0:.  
-00014dd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00014de0: 7475 726e 2030 2e30 0a20 2020 2020 2020  turn 0.0.       
-00014df0: 2020 2020 2072 6574 7572 6e20 726f 756e       return roun
-00014e00: 6428 2828 6368 6563 6b65 7220 2d20 6375  d(((checker - cu
-00014e10: 7272 656e 7429 202f 2063 7572 7265 6e74  rrent) / current
-00014e20: 2920 2a20 3130 302c 2032 290a 2020 2020  ) * 100, 2).    
-00014e30: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00014e40: 7469 6f6e 2061 7320 6578 633a 0a20 2020  tion as exc:.   
-00014e50: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-00014e60: 2e77 6172 6e69 6e67 2866 2245 7272 6f72  .warning(f"Error
-00014e70: 2063 616c 6375 6c61 7469 6e67 2064 656c   calculating del
-00014e80: 7461 3a20 7b65 7863 7d22 290a 2020 2020  ta: {exc}").    
-00014e90: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
-00014ea0: 2e30 0a0a 2020 2020 6465 6620 7275 6e5f  .0..    def run_
-00014eb0: 7069 7065 5f63 6865 636b 6572 280a 2020  pipe_checker(.  
-00014ec0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00014ed0: 2020 2020 7069 7065 5f72 6571 7565 7374      pipe_request
-00014ee0: 735f 746f 5f63 6865 636b 3a20 4c69 7374  s_to_check: List
-00014ef0: 5b44 6963 745b 7374 722c 2041 6e79 5d5d  [Dict[str, Any]]
-00014f00: 2c0a 2020 2020 2020 2020 6368 6563 6b65  ,.        checke
-00014f10: 725f 7069 7065 5f6e 616d 653a 2073 7472  r_pipe_name: str
-00014f20: 2c0a 2020 2020 2020 2020 746f 6b65 6e3a  ,.        token:
-00014f30: 2073 7472 2c0a 2020 2020 2020 2020 6f6e   str,.        on
-00014f40: 6c79 5f72 6573 706f 6e73 655f 7469 6d65  ly_response_time
-00014f50: 733a 2062 6f6f 6c2c 0a20 2020 2020 2020  s: bool,.       
-00014f60: 2069 676e 6f72 655f 6f72 6465 723a 2062   ignore_order: b
-00014f70: 6f6f 6c2c 0a20 2020 2020 2020 2076 616c  ool,.        val
-00014f80: 6964 6174 655f 7072 6f63 6573 7365 645f  idate_processed_
-00014f90: 6279 7465 733a 2062 6f6f 6c2c 0a20 2020  bytes: bool,.   
-00014fa0: 2020 2020 2066 6169 6c66 6173 743a 2062       failfast: b
-00014fb0: 6f6f 6c2c 0a20 2020 2020 2020 2063 7573  ool,.        cus
-00014fc0: 746f 6d5f 6f75 7470 7574 3a20 626f 6f6c  tom_output: bool
-00014fd0: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
-00014fe0: 2020 6465 6275 673a 2062 6f6f 6c20 3d20    debug: bool = 
-00014ff0: 4661 6c73 652c 0a20 2020 2029 202d 3e20  False,.    ) -> 
-00015000: 5069 7065 4368 6563 6b65 7252 756e 6e65  PipeCheckerRunne
-00015010: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-00015020: 2020 2063 6c61 7373 2050 6970 6543 6865     class PipeChe
-00015030: 636b 6572 5465 7874 5465 7374 5265 7375  ckerTextTestResu
-00015040: 6c74 2875 6e69 7474 6573 742e 5465 7874  lt(unittest.Text
-00015050: 5465 7374 5265 7375 6c74 293a 0a20 2020  TestResult):.   
-00015060: 2020 2020 2020 2020 2064 6566 205f 5f69           def __i
-00015070: 6e69 745f 5f28 7365 6c66 2c20 2a61 7267  nit__(self, *arg
-00015080: 733a 2041 6e79 2c20 2a2a 6b77 6172 6773  s: Any, **kwargs
-00015090: 3a20 416e 7929 202d 3e20 4e6f 6e65 3a0a  : Any) -> None:.
-000150a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150b0: 7365 6c66 2e63 7573 746f 6d5f 6f75 7470  self.custom_outp
-000150c0: 7574 203d 206b 7761 7267 732e 706f 7028  ut = kwargs.pop(
-000150d0: 2263 7573 746f 6d5f 6f75 7470 7574 222c  "custom_output",
-000150e0: 2046 616c 7365 290a 2020 2020 2020 2020   False).        
-000150f0: 2020 2020 2020 2020 7375 7065 7228 5069          super(Pi
-00015100: 7065 4368 6563 6b65 7254 6578 7454 6573  peCheckerTextTes
-00015110: 7452 6573 756c 742c 2073 656c 6629 2e5f  tResult, self)._
-00015120: 5f69 6e69 745f 5f28 2a61 7267 732c 202a  _init__(*args, *
-00015130: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-00015140: 2020 2020 2020 2020 2073 656c 662e 7375           self.su
-00015150: 6363 6573 733a 204c 6973 745b 5069 7065  ccess: List[Pipe
-00015160: 4368 6563 6b65 725d 203d 205b 5d0a 0a20  Checker] = [].. 
-00015170: 2020 2020 2020 2020 2020 2064 6566 2061             def a
-00015180: 6464 5375 6363 6573 7328 7365 6c66 2c20  ddSuccess(self, 
-00015190: 7465 7374 3a20 5069 7065 4368 6563 6b65  test: PipeChecke
-000151a0: 7229 3a20 2023 2074 7970 653a 2069 676e  r):  # type: ign
-000151b0: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
-000151c0: 2020 2020 7375 7065 7228 5069 7065 4368      super(PipeCh
-000151d0: 6563 6b65 7254 6578 7454 6573 7452 6573  eckerTextTestRes
-000151e0: 756c 742c 2073 656c 6629 2e61 6464 5375  ult, self).addSu
-000151f0: 6363 6573 7328 7465 7374 290a 2020 2020  ccess(test).    
-00015200: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015210: 2e73 7563 6365 7373 2e61 7070 656e 6428  .success.append(
-00015220: 7465 7374 290a 0a20 2020 2020 2020 2020  test)..         
-00015230: 2020 2064 6566 2073 7461 7274 5465 7374     def startTest
-00015240: 2873 656c 662c 2074 6573 7429 3a0a 2020  (self, test):.  
-00015250: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00015260: 206e 6f74 2073 656c 662e 6375 7374 6f6d   not self.custom
-00015270: 5f6f 7574 7075 743a 0a20 2020 2020 2020  _output:.       
-00015280: 2020 2020 2020 2020 2020 2020 2073 7570               sup
-00015290: 6572 2850 6970 6543 6865 636b 6572 5465  er(PipeCheckerTe
-000152a0: 7874 5465 7374 5265 7375 6c74 2c20 7365  xtTestResult, se
-000152b0: 6c66 292e 7374 6172 7454 6573 7428 7465  lf).startTest(te
-000152c0: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-000152d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000152e0: 2020 2020 2020 2020 2020 2020 2020 7375                su
-000152f0: 7065 7228 756e 6974 7465 7374 2e54 6578  per(unittest.Tex
-00015300: 7454 6573 7452 6573 756c 742c 2073 656c  tTestResult, sel
-00015310: 6629 2e73 7461 7274 5465 7374 2874 6573  f).startTest(tes
-00015320: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-00015330: 6465 6620 5f77 7269 7465 5f73 7461 7475  def _write_statu
-00015340: 7328 7365 6c66 2c20 7465 7374 2c20 7374  s(self, test, st
-00015350: 6174 7573 293a 0a20 2020 2020 2020 2020  atus):.         
-00015360: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
-00015370: 7573 746f 6d5f 6f75 7470 7574 3a0a 2020  ustom_output:.  
-00015380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015390: 2020 7365 6c66 2e73 7472 6561 6d2e 7772    self.stream.wr
-000153a0: 6974 6528 7374 6174 7573 2e75 7070 6572  ite(status.upper
-000153b0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-000153c0: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
-000153d0: 6561 6d2e 7772 6974 6528 2220 2d20 2229  eam.write(" - ")
-000153e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000153f0: 2020 2020 2073 656c 662e 7374 7265 616d       self.stream
-00015400: 2e77 7269 7465 2873 7472 2874 6573 7429  .write(str(test)
-00015410: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015420: 2020 2020 2020 7365 6c66 2e73 7472 6561        self.strea
-00015430: 6d2e 7772 6974 6528 2220 2d20 2229 0a20  m.write(" - "). 
-00015440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015450: 2020 2073 656c 662e 7374 7265 616d 2e77     self.stream.w
-00015460: 7269 7465 6c6e 2874 6573 742e 5f77 7269  riteln(test._wri
-00015470: 7465 5f70 6572 666f 726d 616e 6365 2829  te_performance()
-00015480: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00015490: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000154a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000154b0: 662e 7374 7265 616d 2e77 7269 7465 6c6e  f.stream.writeln
-000154c0: 2873 7461 7475 7329 0a20 2020 2020 2020  (status).       
-000154d0: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
-000154e0: 7265 616d 2e66 6c75 7368 2829 0a20 2020  ream.flush().   
-000154f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00015500: 662e 5f6e 6577 6c69 6e65 203d 2054 7275  f._newline = Tru
-00015510: 650a 0a20 2020 2020 2020 2073 7569 7465  e..        suite
-00015520: 203d 2075 6e69 7474 6573 742e 5465 7374   = unittest.Test
-00015530: 5375 6974 6528 290a 0a20 2020 2020 2020  Suite()..       
-00015540: 2066 6f72 205f 2c20 7265 7175 6573 7420   for _, request 
-00015550: 696e 2065 6e75 6d65 7261 7465 2870 6970  in enumerate(pip
-00015560: 655f 7265 7175 6573 7473 5f74 6f5f 6368  e_requests_to_ch
-00015570: 6563 6b29 3a0a 2020 2020 2020 2020 2020  eck):.          
-00015580: 2020 7375 6974 652e 6164 6454 6573 7428    suite.addTest(
-00015590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000155a0: 2073 656c 662e 5f67 6574 5f63 6865 636b   self._get_check
-000155b0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-000155c0: 2020 2020 2020 2020 7265 7175 6573 742c          request,
-000155d0: 2063 6865 636b 6572 5f70 6970 655f 6e61   checker_pipe_na
-000155e0: 6d65 2c20 746f 6b65 6e2c 206f 6e6c 795f  me, token, only_
-000155f0: 7265 7370 6f6e 7365 5f74 696d 6573 2c20  response_times, 
-00015600: 6967 6e6f 7265 5f6f 7264 6572 2c20 7661  ignore_order, va
-00015610: 6c69 6461 7465 5f70 726f 6365 7373 6564  lidate_processed
-00015620: 5f62 7974 6573 0a20 2020 2020 2020 2020  _bytes.         
-00015630: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00015640: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00015650: 7265 7375 6c74 203d 2050 6970 6543 6865  result = PipeChe
-00015660: 636b 6572 5465 7874 5465 7374 5265 7375  ckerTextTestResu
-00015670: 6c74 280a 2020 2020 2020 2020 2020 2020  lt(.            
-00015680: 7365 6c66 2e63 6865 636b 6572 5f73 7472  self.checker_str
-00015690: 6561 6d5f 7265 7375 6c74 5f63 6c61 7373  eam_result_class
-000156a0: 2873 7973 2e73 7464 6f75 7429 2c20 6465  (sys.stdout), de
-000156b0: 7363 7269 7074 696f 6e73 3d54 7275 652c  scriptions=True,
-000156c0: 2076 6572 626f 7369 7479 3d32 2c20 6375   verbosity=2, cu
-000156d0: 7374 6f6d 5f6f 7574 7075 743d 6375 7374  stom_output=cust
-000156e0: 6f6d 5f6f 7574 7075 740a 2020 2020 2020  om_output.      
-000156f0: 2020 290a 2020 2020 2020 2020 7265 7375    ).        resu
-00015700: 6c74 2e66 6169 6c66 6173 7420 3d20 6661  lt.failfast = fa
-00015710: 696c 6661 7374 0a20 2020 2020 2020 2073  ilfast.        s
-00015720: 7569 7465 2e72 756e 2872 6573 756c 7429  uite.run(result)
-00015730: 0a0a 2020 2020 2020 2020 6d65 7472 6963  ..        metric
-00015740: 735f 7375 6d6d 6172 793a 204f 7074 696f  s_summary: Optio
-00015750: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
-00015760: 795d 5d20 3d20 4e6f 6e65 0a20 2020 2020  y]] = None.     
-00015770: 2020 206d 6574 7269 6373 5f74 696d 696e     metrics_timin
-00015780: 673a 2044 6963 745b 7374 722c 2054 7570  g: Dict[str, Tup
-00015790: 6c65 5b66 6c6f 6174 2c20 666c 6f61 742c  le[float, float,
-000157a0: 2066 6c6f 6174 5d5d 203d 207b 7d0a 0a20   float]] = {}.. 
-000157b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000157c0: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-000157d0: 7265 7370 6f6e 7365 5f74 696d 6573 3a20  response_times: 
-000157e0: 4c69 7374 5b66 6c6f 6174 5d20 3d20 5b5d  List[float] = []
-000157f0: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
-00015800: 636b 6572 5f72 6573 706f 6e73 655f 7469  cker_response_ti
-00015810: 6d65 733a 204c 6973 745b 666c 6f61 745d  mes: List[float]
-00015820: 203d 205b 5d0a 0a20 2020 2020 2020 2020   = []..         
-00015830: 2020 2063 7572 7265 6e74 5f72 6561 645f     current_read_
-00015840: 6279 7465 733a 204c 6973 745b 696e 745d  bytes: List[int]
-00015850: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00015860: 2020 6368 6563 6b65 725f 7265 6164 5f62    checker_read_b
-00015870: 7974 6573 3a20 4c69 7374 5b69 6e74 5d20  ytes: List[int] 
-00015880: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00015890: 2069 6620 7265 7375 6c74 2e73 7563 6365   if result.succe
-000158a0: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
-000158b0: 2020 2020 666f 7220 7465 7374 2069 6e20      for test in 
-000158c0: 7265 7375 6c74 2e73 7563 6365 7373 3a0a  result.success:.
-000158d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158e0: 2020 2020 6375 7272 656e 745f 7265 7370      current_resp
-000158f0: 6f6e 7365 5f74 696d 6573 2e61 7070 656e  onse_times.appen
-00015900: 6428 7465 7374 2e63 7572 7265 6e74 5f72  d(test.current_r
-00015910: 6573 706f 6e73 655f 7469 6d65 290a 2020  esponse_time).  
-00015920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015930: 2020 6368 6563 6b65 725f 7265 7370 6f6e    checker_respon
-00015940: 7365 5f74 696d 6573 2e61 7070 656e 6428  se_times.append(
-00015950: 7465 7374 2e63 6865 636b 6572 5f72 6573  test.checker_res
-00015960: 706f 6e73 655f 7469 6d65 290a 0a20 2020  ponse_time)..   
-00015970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015980: 2063 7572 7265 6e74 5f72 6561 645f 6279   current_read_by
-00015990: 7465 732e 6170 7065 6e64 2874 6573 742e  tes.append(test.
-000159a0: 6375 7272 656e 745f 7265 6164 5f62 7974  current_read_byt
-000159b0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-000159c0: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
-000159d0: 7265 6164 5f62 7974 6573 2e61 7070 656e  read_bytes.appen
-000159e0: 6428 7465 7374 2e63 6865 636b 6572 5f72  d(test.checker_r
-000159f0: 6561 645f 6279 7465 7329 0a0a 2020 2020  ead_bytes)..    
-00015a00: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00015a10: 7465 7374 2c20 5f20 696e 2072 6573 756c  test, _ in resul
-00015a20: 742e 6661 696c 7572 6573 3a20 2023 2074  t.failures:  # t
-00015a30: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-00015a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a50: 6375 7272 656e 745f 7265 7370 6f6e 7365  current_response
-00015a60: 5f74 696d 6573 2e61 7070 656e 6428 7465  _times.append(te
-00015a70: 7374 2e63 7572 7265 6e74 5f72 6573 706f  st.current_respo
-00015a80: 6e73 655f 7469 6d65 290a 2020 2020 2020  nse_time).      
-00015a90: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00015aa0: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
-00015ab0: 696d 6573 2e61 7070 656e 6428 7465 7374  imes.append(test
-00015ac0: 2e63 6865 636b 6572 5f72 6573 706f 6e73  .checker_respons
-00015ad0: 655f 7469 6d65 290a 0a20 2020 2020 2020  e_time)..       
-00015ae0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00015af0: 7265 6e74 5f72 6561 645f 6279 7465 732e  rent_read_bytes.
-00015b00: 6170 7065 6e64 2874 6573 742e 6375 7272  append(test.curr
-00015b10: 656e 745f 7265 6164 5f62 7974 6573 290a  ent_read_bytes).
-00015b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b30: 2020 2020 6368 6563 6b65 725f 7265 6164      checker_read
-00015b40: 5f62 7974 6573 2e61 7070 656e 6428 7465  _bytes.append(te
-00015b50: 7374 2e63 6865 636b 6572 5f72 6561 645f  st.checker_read_
-00015b60: 6279 7465 7329 0a20 2020 2020 2020 2020  bytes).         
-00015b70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00015b80: 2020 2020 2020 2020 2023 2069 6620 7765           # if we
-00015b90: 2064 6f20 6e6f 7420 6861 7665 2061 6e79   do not have any
-00015ba0: 2073 7563 6365 7373 6675 6c20 6578 6563   successful exec
-00015bb0: 7574 696f 6e2c 206c 6574 2773 206a 7573  ution, let's jus
-00015bc0: 7420 7265 7475 726e 2061 2074 6162 6c65  t return a table
-00015bd0: 2077 6974 6820 6475 6d6d 7920 6d65 7472   with dummy metr
-00015be0: 6963 7320 6874 7470 733a 2f2f 6769 746c  ics https://gitl
-00015bf0: 6162 2e63 6f6d 2f74 696e 7962 6972 642f  ab.com/tinybird/
-00015c00: 616e 616c 7974 6963 732f 2d2f 6973 7375  analytics/-/issu
-00015c10: 6573 2f31 3038 3735 0a20 2020 2020 2020  es/10875.       
+00014ac0: 2020 2020 2020 2020 2020 2020 2020 7b22                {"
+00014ad0: 2041 4e44 2022 202b 2022 2041 4e44 2022   AND " + " AND "
+00014ae0: 2e6a 6f69 6e28 5b66 226d 6170 436f 6e74  .join([f"mapCont
+00014af0: 6169 6e73 2870 6970 655f 7265 7175 6573  ains(pipe_reques
+00014b00: 745f 7061 7261 6d73 2c20 277b 6d61 7463  t_params, '{matc
+00014b10: 687d 2729 2220 666f 7220 6d61 7463 6820  h}')" for match 
+00014b20: 696e 206d 6174 6368 6573 5d29 2069 6620  in matches]) if 
+00014b30: 6d61 7463 6865 7320 616e 6420 6c65 6e28  matches and len(
+00014b40: 6d61 7463 6865 7329 203e 2030 2065 6c73  matches) > 0 els
+00014b50: 6520 2727 7d0a 2020 2020 2020 2020 2020  e ''}.          
+00014b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b70: 2020 2020 2020 2020 2020 2020 2020 7b65                {e
+00014b80: 7874 7261 5f77 6865 7265 5f63 6c61 7573  xtra_where_claus
+00014b90: 657d 0a20 2020 2020 2020 2020 2020 2020  e}.             
+00014ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014bb0: 2020 2020 2020 204c 494d 4954 207b 6c69         LIMIT {li
+00014bc0: 6d69 747d 0a20 2020 2020 2020 2020 2020  mit}.           
+00014bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014be0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00014bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c00: 2020 2020 2020 2047 524f 5550 2042 5920         GROUP BY 
+00014c10: 7069 7065 5f72 6571 7565 7374 5f70 6172  pipe_request_par
+00014c20: 616d 732c 2068 7474 705f 6d65 7468 6f64  ams, http_method
+00014c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c50: 2046 4f52 4d41 5420 4a53 4f4e 0a20 2020   FORMAT JSON.   
+00014c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c70: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
+00014c80: 2020 2020 2072 6574 7572 6e20 7371 6c5f       return sql_
+00014c90: 666f 725f 636f 7665 7261 6765 2c20 7371  for_coverage, sq
+00014ca0: 6c5f 6c61 7465 7374 5f72 6571 7565 7374  l_latest_request
+00014cb0: 730a 0a20 2020 2064 6566 205f 6765 745f  s..    def _get_
+00014cc0: 6368 6563 6b65 7228 0a20 2020 2020 2020  checker(.       
+00014cd0: 2073 656c 662c 0a20 2020 2020 2020 2072   self,.        r
+00014ce0: 6571 7565 7374 3a20 4469 6374 5b73 7472  equest: Dict[str
+00014cf0: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
+00014d00: 6368 6563 6b65 725f 7069 7065 5f6e 616d  checker_pipe_nam
+00014d10: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
+00014d20: 746f 6b65 6e3a 2073 7472 2c0a 2020 2020  token: str,.    
+00014d30: 2020 2020 6f6e 6c79 5f72 6573 706f 6e73      only_respons
+00014d40: 655f 7469 6d65 733a 2062 6f6f 6c2c 0a20  e_times: bool,. 
+00014d50: 2020 2020 2020 2069 676e 6f72 655f 6f72         ignore_or
+00014d60: 6465 723a 2062 6f6f 6c2c 0a20 2020 2020  der: bool,.     
+00014d70: 2020 2076 616c 6964 6174 655f 7072 6f63     validate_proc
+00014d80: 6573 7365 645f 6279 7465 733a 2062 6f6f  essed_bytes: boo
+00014d90: 6c2c 0a20 2020 2029 202d 3e20 5069 7065  l,.    ) -> Pipe
+00014da0: 4368 6563 6b65 723a 0a20 2020 2020 2020  Checker:.       
+00014db0: 2072 6574 7572 6e20 5069 7065 4368 6563   return PipeChec
+00014dc0: 6b65 7228 0a20 2020 2020 2020 2020 2020  ker(.           
+00014dd0: 2072 6571 7565 7374 2c0a 2020 2020 2020   request,.      
+00014de0: 2020 2020 2020 7365 6c66 2e70 6970 655f        self.pipe_
+00014df0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00014e00: 2020 6368 6563 6b65 725f 7069 7065 5f6e    checker_pipe_n
+00014e10: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+00014e20: 2074 6f6b 656e 2c0a 2020 2020 2020 2020   token,.        
+00014e30: 2020 2020 6f6e 6c79 5f72 6573 706f 6e73      only_respons
+00014e40: 655f 7469 6d65 732c 0a20 2020 2020 2020  e_times,.       
+00014e50: 2020 2020 2069 676e 6f72 655f 6f72 6465       ignore_orde
+00014e60: 722c 0a20 2020 2020 2020 2020 2020 2076  r,.            v
+00014e70: 616c 6964 6174 655f 7072 6f63 6573 7365  alidate_processe
+00014e80: 645f 6279 7465 732c 0a20 2020 2020 2020  d_bytes,.       
+00014e90: 2029 0a0a 2020 2020 6465 6620 5f64 656c   )..    def _del
+00014ea0: 7461 5f70 6572 6365 6e74 6167 6528 7365  ta_percentage(se
+00014eb0: 6c66 2c20 6368 6563 6b65 723a 2066 6c6f  lf, checker: flo
+00014ec0: 6174 2c20 6375 7272 656e 743a 2066 6c6f  at, current: flo
+00014ed0: 6174 2920 2d3e 2066 6c6f 6174 3a0a 2020  at) -> float:.  
+00014ee0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00014ef0: 2020 2020 2020 2069 6620 6375 7272 656e         if curren
+00014f00: 7420 3d3d 2030 2e30 3a0a 2020 2020 2020  t == 0.0:.      
+00014f10: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00014f20: 2030 2e30 0a20 2020 2020 2020 2020 2020   0.0.           
+00014f30: 2072 6574 7572 6e20 726f 756e 6428 2828   return round(((
+00014f40: 6368 6563 6b65 7220 2d20 6375 7272 656e  checker - curren
+00014f50: 7429 202f 2063 7572 7265 6e74 2920 2a20  t) / current) * 
+00014f60: 3130 302c 2032 290a 2020 2020 2020 2020  100, 2).        
+00014f70: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00014f80: 2061 7320 6578 633a 0a20 2020 2020 2020   as exc:.       
+00014f90: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
+00014fa0: 6e69 6e67 2866 2245 7272 6f72 2063 616c  ning(f"Error cal
+00014fb0: 6375 6c61 7469 6e67 2064 656c 7461 3a20  culating delta: 
+00014fc0: 7b65 7863 7d22 290a 2020 2020 2020 2020  {exc}").        
+00014fd0: 2020 2020 7265 7475 726e 2030 2e30 0a0a      return 0.0..
+00014fe0: 2020 2020 6465 6620 7275 6e5f 7069 7065      def run_pipe
+00014ff0: 5f63 6865 636b 6572 280a 2020 2020 2020  _checker(.      
+00015000: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00015010: 7069 7065 5f72 6571 7565 7374 735f 746f  pipe_requests_to
+00015020: 5f63 6865 636b 3a20 4c69 7374 5b44 6963  _check: List[Dic
+00015030: 745b 7374 722c 2041 6e79 5d5d 2c0a 2020  t[str, Any]],.  
+00015040: 2020 2020 2020 6368 6563 6b65 725f 7069        checker_pi
+00015050: 7065 5f6e 616d 653a 2073 7472 2c0a 2020  pe_name: str,.  
+00015060: 2020 2020 2020 746f 6b65 6e3a 2073 7472        token: str
+00015070: 2c0a 2020 2020 2020 2020 6f6e 6c79 5f72  ,.        only_r
+00015080: 6573 706f 6e73 655f 7469 6d65 733a 2062  esponse_times: b
+00015090: 6f6f 6c2c 0a20 2020 2020 2020 2069 676e  ool,.        ign
+000150a0: 6f72 655f 6f72 6465 723a 2062 6f6f 6c2c  ore_order: bool,
+000150b0: 0a20 2020 2020 2020 2076 616c 6964 6174  .        validat
+000150c0: 655f 7072 6f63 6573 7365 645f 6279 7465  e_processed_byte
+000150d0: 733a 2062 6f6f 6c2c 0a20 2020 2020 2020  s: bool,.       
+000150e0: 2066 6169 6c66 6173 743a 2062 6f6f 6c2c   failfast: bool,
+000150f0: 0a20 2020 2020 2020 2063 7573 746f 6d5f  .        custom_
+00015100: 6f75 7470 7574 3a20 626f 6f6c 203d 2046  output: bool = F
+00015110: 616c 7365 2c0a 2020 2020 2020 2020 6465  alse,.        de
+00015120: 6275 673a 2062 6f6f 6c20 3d20 4661 6c73  bug: bool = Fals
+00015130: 652c 0a20 2020 2029 202d 3e20 5069 7065  e,.    ) -> Pipe
+00015140: 4368 6563 6b65 7252 756e 6e65 7252 6573  CheckerRunnerRes
+00015150: 706f 6e73 653a 0a20 2020 2020 2020 2063  ponse:.        c
+00015160: 6c61 7373 2050 6970 6543 6865 636b 6572  lass PipeChecker
+00015170: 5465 7874 5465 7374 5265 7375 6c74 2875  TextTestResult(u
+00015180: 6e69 7474 6573 742e 5465 7874 5465 7374  nittest.TextTest
+00015190: 5265 7375 6c74 293a 0a20 2020 2020 2020  Result):.       
+000151a0: 2020 2020 2064 6566 205f 5f69 6e69 745f       def __init_
+000151b0: 5f28 7365 6c66 2c20 2a61 7267 733a 2041  _(self, *args: A
+000151c0: 6e79 2c20 2a2a 6b77 6172 6773 3a20 416e  ny, **kwargs: An
+000151d0: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
+000151e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000151f0: 2e63 7573 746f 6d5f 6f75 7470 7574 203d  .custom_output =
+00015200: 206b 7761 7267 732e 706f 7028 2263 7573   kwargs.pop("cus
+00015210: 746f 6d5f 6f75 7470 7574 222c 2046 616c  tom_output", Fal
+00015220: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+00015230: 2020 2020 7375 7065 7228 5069 7065 4368      super(PipeCh
+00015240: 6563 6b65 7254 6578 7454 6573 7452 6573  eckerTextTestRes
+00015250: 756c 742c 2073 656c 6629 2e5f 5f69 6e69  ult, self).__ini
+00015260: 745f 5f28 2a61 7267 732c 202a 2a6b 7761  t__(*args, **kwa
+00015270: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
+00015280: 2020 2020 2073 656c 662e 7375 6363 6573       self.succes
+00015290: 733a 204c 6973 745b 5069 7065 4368 6563  s: List[PipeChec
+000152a0: 6b65 725d 203d 205b 5d0a 0a20 2020 2020  ker] = []..     
+000152b0: 2020 2020 2020 2064 6566 2061 6464 5375         def addSu
+000152c0: 6363 6573 7328 7365 6c66 2c20 7465 7374  ccess(self, test
+000152d0: 3a20 5069 7065 4368 6563 6b65 7229 3a20  : PipeChecker): 
+000152e0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+000152f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015300: 7375 7065 7228 5069 7065 4368 6563 6b65  super(PipeChecke
+00015310: 7254 6578 7454 6573 7452 6573 756c 742c  rTextTestResult,
+00015320: 2073 656c 6629 2e61 6464 5375 6363 6573   self).addSucces
+00015330: 7328 7465 7374 290a 2020 2020 2020 2020  s(test).        
+00015340: 2020 2020 2020 2020 7365 6c66 2e73 7563          self.suc
+00015350: 6365 7373 2e61 7070 656e 6428 7465 7374  cess.append(test
+00015360: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
+00015370: 6566 2073 7461 7274 5465 7374 2873 656c  ef startTest(sel
+00015380: 662c 2074 6573 7429 3a0a 2020 2020 2020  f, test):.      
+00015390: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000153a0: 2073 656c 662e 6375 7374 6f6d 5f6f 7574   self.custom_out
+000153b0: 7075 743a 0a20 2020 2020 2020 2020 2020  put:.           
+000153c0: 2020 2020 2020 2020 2073 7570 6572 2850           super(P
+000153d0: 6970 6543 6865 636b 6572 5465 7874 5465  ipeCheckerTextTe
+000153e0: 7374 5265 7375 6c74 2c20 7365 6c66 292e  stResult, self).
+000153f0: 7374 6172 7454 6573 7428 7465 7374 290a  startTest(test).
+00015400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015410: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00015420: 2020 2020 2020 2020 2020 7375 7065 7228            super(
+00015430: 756e 6974 7465 7374 2e54 6578 7454 6573  unittest.TextTes
+00015440: 7452 6573 756c 742c 2073 656c 6629 2e73  tResult, self).s
+00015450: 7461 7274 5465 7374 2874 6573 7429 0a0a  tartTest(test)..
+00015460: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+00015470: 5f77 7269 7465 5f73 7461 7475 7328 7365  _write_status(se
+00015480: 6c66 2c20 7465 7374 2c20 7374 6174 7573  lf, test, status
+00015490: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000154a0: 2020 2069 6620 7365 6c66 2e63 7573 746f     if self.custo
+000154b0: 6d5f 6f75 7470 7574 3a0a 2020 2020 2020  m_output:.      
+000154c0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000154d0: 6c66 2e73 7472 6561 6d2e 7772 6974 6528  lf.stream.write(
+000154e0: 7374 6174 7573 2e75 7070 6572 2829 290a  status.upper()).
+000154f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015500: 2020 2020 7365 6c66 2e73 7472 6561 6d2e      self.stream.
+00015510: 7772 6974 6528 2220 2d20 2229 0a20 2020  write(" - ").   
+00015520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015530: 2073 656c 662e 7374 7265 616d 2e77 7269   self.stream.wri
+00015540: 7465 2873 7472 2874 6573 7429 290a 2020  te(str(test)).  
+00015550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015560: 2020 7365 6c66 2e73 7472 6561 6d2e 7772    self.stream.wr
+00015570: 6974 6528 2220 2d20 2229 0a20 2020 2020  ite(" - ").     
+00015580: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00015590: 656c 662e 7374 7265 616d 2e77 7269 7465  elf.stream.write
+000155a0: 6c6e 2874 6573 742e 5f77 7269 7465 5f70  ln(test._write_p
+000155b0: 6572 666f 726d 616e 6365 2829 290a 0a20  erformance()).. 
+000155c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000155d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000155e0: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+000155f0: 7265 616d 2e77 7269 7465 6c6e 2873 7461  ream.writeln(sta
+00015600: 7475 7329 0a20 2020 2020 2020 2020 2020  tus).           
+00015610: 2020 2020 2073 656c 662e 7374 7265 616d       self.stream
+00015620: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
+00015630: 2020 2020 2020 2020 2073 656c 662e 5f6e           self._n
+00015640: 6577 6c69 6e65 203d 2054 7275 650a 0a20  ewline = True.. 
+00015650: 2020 2020 2020 2073 7569 7465 203d 2075         suite = u
+00015660: 6e69 7474 6573 742e 5465 7374 5375 6974  nittest.TestSuit
+00015670: 6528 290a 0a20 2020 2020 2020 2066 6f72  e()..        for
+00015680: 205f 2c20 7265 7175 6573 7420 696e 2065   _, request in e
+00015690: 6e75 6d65 7261 7465 2870 6970 655f 7265  numerate(pipe_re
+000156a0: 7175 6573 7473 5f74 6f5f 6368 6563 6b29  quests_to_check)
+000156b0: 3a0a 2020 2020 2020 2020 2020 2020 7375  :.            su
+000156c0: 6974 652e 6164 6454 6573 7428 0a20 2020  ite.addTest(.   
+000156d0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000156e0: 662e 5f67 6574 5f63 6865 636b 6572 280a  f._get_checker(.
+000156f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015700: 2020 2020 7265 7175 6573 742c 2063 6865      request, che
+00015710: 636b 6572 5f70 6970 655f 6e61 6d65 2c20  cker_pipe_name, 
+00015720: 746f 6b65 6e2c 206f 6e6c 795f 7265 7370  token, only_resp
+00015730: 6f6e 7365 5f74 696d 6573 2c20 6967 6e6f  onse_times, igno
+00015740: 7265 5f6f 7264 6572 2c20 7661 6c69 6461  re_order, valida
+00015750: 7465 5f70 726f 6365 7373 6564 5f62 7974  te_processed_byt
+00015760: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00015770: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00015780: 2029 0a0a 2020 2020 2020 2020 7265 7375   )..        resu
+00015790: 6c74 203d 2050 6970 6543 6865 636b 6572  lt = PipeChecker
+000157a0: 5465 7874 5465 7374 5265 7375 6c74 280a  TextTestResult(.
+000157b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000157c0: 2e63 6865 636b 6572 5f73 7472 6561 6d5f  .checker_stream_
+000157d0: 7265 7375 6c74 5f63 6c61 7373 2873 7973  result_class(sys
+000157e0: 2e73 7464 6f75 7429 2c20 6465 7363 7269  .stdout), descri
+000157f0: 7074 696f 6e73 3d54 7275 652c 2076 6572  ptions=True, ver
+00015800: 626f 7369 7479 3d32 2c20 6375 7374 6f6d  bosity=2, custom
+00015810: 5f6f 7574 7075 743d 6375 7374 6f6d 5f6f  _output=custom_o
+00015820: 7574 7075 740a 2020 2020 2020 2020 290a  utput.        ).
+00015830: 2020 2020 2020 2020 7265 7375 6c74 2e66          result.f
+00015840: 6169 6c66 6173 7420 3d20 6661 696c 6661  ailfast = failfa
+00015850: 7374 0a20 2020 2020 2020 2073 7569 7465  st.        suite
+00015860: 2e72 756e 2872 6573 756c 7429 0a0a 2020  .run(result)..  
+00015870: 2020 2020 2020 6d65 7472 6963 735f 7375        metrics_su
+00015880: 6d6d 6172 793a 204f 7074 696f 6e61 6c5b  mmary: Optional[
+00015890: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
+000158a0: 3d20 4e6f 6e65 0a20 2020 2020 2020 206d  = None.        m
+000158b0: 6574 7269 6373 5f74 696d 696e 673a 2044  etrics_timing: D
+000158c0: 6963 745b 7374 722c 2054 7570 6c65 5b66  ict[str, Tuple[f
+000158d0: 6c6f 6174 2c20 666c 6f61 742c 2066 6c6f  loat, float, flo
+000158e0: 6174 5d5d 203d 207b 7d0a 0a20 2020 2020  at]] = {}..     
+000158f0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00015900: 2020 2020 6375 7272 656e 745f 7265 7370      current_resp
+00015910: 6f6e 7365 5f74 696d 6573 3a20 4c69 7374  onse_times: List
+00015920: 5b66 6c6f 6174 5d20 3d20 5b5d 0a20 2020  [float] = [].   
+00015930: 2020 2020 2020 2020 2063 6865 636b 6572           checker
+00015940: 5f72 6573 706f 6e73 655f 7469 6d65 733a  _response_times:
+00015950: 204c 6973 745b 666c 6f61 745d 203d 205b   List[float] = [
+00015960: 5d0a 0a20 2020 2020 2020 2020 2020 2063  ]..            c
+00015970: 7572 7265 6e74 5f72 6561 645f 6279 7465  urrent_read_byte
+00015980: 733a 204c 6973 745b 696e 745d 203d 205b  s: List[int] = [
+00015990: 5d0a 2020 2020 2020 2020 2020 2020 6368  ].            ch
+000159a0: 6563 6b65 725f 7265 6164 5f62 7974 6573  ecker_read_bytes
+000159b0: 3a20 4c69 7374 5b69 6e74 5d20 3d20 5b5d  : List[int] = []
+000159c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000159d0: 7265 7375 6c74 2e73 7563 6365 7373 3a0a  result.success:.
+000159e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000159f0: 666f 7220 7465 7374 2069 6e20 7265 7375  for test in resu
+00015a00: 6c74 2e73 7563 6365 7373 3a0a 2020 2020  lt.success:.    
+00015a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a20: 6375 7272 656e 745f 7265 7370 6f6e 7365  current_response
+00015a30: 5f74 696d 6573 2e61 7070 656e 6428 7465  _times.append(te
+00015a40: 7374 2e63 7572 7265 6e74 5f72 6573 706f  st.current_respo
+00015a50: 6e73 655f 7469 6d65 290a 2020 2020 2020  nse_time).      
+00015a60: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00015a70: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
+00015a80: 696d 6573 2e61 7070 656e 6428 7465 7374  imes.append(test
+00015a90: 2e63 6865 636b 6572 5f72 6573 706f 6e73  .checker_respons
+00015aa0: 655f 7469 6d65 290a 0a20 2020 2020 2020  e_time)..       
+00015ab0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00015ac0: 7265 6e74 5f72 6561 645f 6279 7465 732e  rent_read_bytes.
+00015ad0: 6170 7065 6e64 2874 6573 742e 6375 7272  append(test.curr
+00015ae0: 656e 745f 7265 6164 5f62 7974 6573 290a  ent_read_bytes).
+00015af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b00: 2020 2020 6368 6563 6b65 725f 7265 6164      checker_read
+00015b10: 5f62 7974 6573 2e61 7070 656e 6428 7465  _bytes.append(te
+00015b20: 7374 2e63 6865 636b 6572 5f72 6561 645f  st.checker_read_
+00015b30: 6279 7465 7329 0a0a 2020 2020 2020 2020  bytes)..        
+00015b40: 2020 2020 2020 2020 666f 7220 7465 7374          for test
+00015b50: 2c20 5f20 696e 2072 6573 756c 742e 6661  , _ in result.fa
+00015b60: 696c 7572 6573 3a20 2023 2074 7970 653a  ilures:  # type:
+00015b70: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+00015b80: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00015b90: 656e 745f 7265 7370 6f6e 7365 5f74 696d  ent_response_tim
+00015ba0: 6573 2e61 7070 656e 6428 7465 7374 2e63  es.append(test.c
+00015bb0: 7572 7265 6e74 5f72 6573 706f 6e73 655f  urrent_response_
+00015bc0: 7469 6d65 290a 2020 2020 2020 2020 2020  time).          
+00015bd0: 2020 2020 2020 2020 2020 6368 6563 6b65            checke
+00015be0: 725f 7265 7370 6f6e 7365 5f74 696d 6573  r_response_times
+00015bf0: 2e61 7070 656e 6428 7465 7374 2e63 6865  .append(test.che
+00015c00: 636b 6572 5f72 6573 706f 6e73 655f 7469  cker_response_ti
+00015c10: 6d65 290a 0a20 2020 2020 2020 2020 2020  me)..           
 00015c20: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00015c30: 5f72 6573 706f 6e73 655f 7469 6d65 7320  _response_times 
-00015c40: 3d20 5b30 5d0a 2020 2020 2020 2020 2020  = [0].          
-00015c50: 2020 2020 2020 6368 6563 6b65 725f 7265        checker_re
-00015c60: 7370 6f6e 7365 5f74 696d 6573 203d 205b  sponse_times = [
-00015c70: 305d 0a0a 2020 2020 2020 2020 2020 2020  0]..            
-00015c80: 2020 2020 6375 7272 656e 745f 7265 6164      current_read
-00015c90: 5f62 7974 6573 203d 205b 305d 0a20 2020  _bytes = [0].   
-00015ca0: 2020 2020 2020 2020 2020 2020 2063 6865               che
-00015cb0: 636b 6572 5f72 6561 645f 6279 7465 7320  cker_read_bytes 
-00015cc0: 3d20 5b30 5d0a 0a20 2020 2020 2020 2020  = [0]..         
-00015cd0: 2020 206d 6574 7269 6373 5f73 756d 6d61     metrics_summa
-00015ce0: 7279 203d 207b 0a20 2020 2020 2020 2020  ry = {.         
-00015cf0: 2020 2020 2020 2022 7275 6e22 3a20 7265         "run": re
-00015d00: 7375 6c74 2e74 6573 7473 5275 6e2c 0a20  sult.testsRun,. 
-00015d10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00015d20: 7061 7373 6564 223a 206c 656e 2872 6573  passed": len(res
-00015d30: 756c 742e 7375 6363 6573 7329 2c0a 2020  ult.success),.  
-00015d40: 2020 2020 2020 2020 2020 2020 2020 2266                "f
-00015d50: 6169 6c65 6422 3a20 6c65 6e28 7265 7375  ailed": len(resu
-00015d60: 6c74 2e66 6169 6c75 7265 7329 2c0a 2020  lt.failures),.  
-00015d70: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-00015d80: 6572 6365 6e74 6167 655f 7061 7373 6564  ercentage_passed
-00015d90: 223a 206c 656e 2872 6573 756c 742e 7375  ": len(result.su
-00015da0: 6363 6573 7329 202a 2031 3030 202f 2072  ccess) * 100 / r
-00015db0: 6573 756c 742e 7465 7374 7352 756e 2c0a  esult.testsRun,.
-00015dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015dd0: 2270 6572 6365 6e74 6167 655f 6661 696c  "percentage_fail
-00015de0: 6564 223a 206c 656e 2872 6573 756c 742e  ed": len(result.
-00015df0: 6661 696c 7572 6573 2920 2a20 3130 3020  failures) * 100 
-00015e00: 2f20 7265 7375 6c74 2e74 6573 7473 5275  / result.testsRu
-00015e10: 6e2c 0a20 2020 2020 2020 2020 2020 207d  n,.            }
-00015e20: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
-00015e30: 7269 6373 5f74 696d 696e 6720 3d20 7b0a  rics_timing = {.
-00015e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e50: 226d 696e 2072 6573 706f 6e73 6520 7469  "min response ti
-00015e60: 6d65 223a 2028 0a20 2020 2020 2020 2020  me": (.         
-00015e70: 2020 2020 2020 2020 2020 206d 696e 2863             min(c
-00015e80: 7572 7265 6e74 5f72 6573 706f 6e73 655f  urrent_response_
-00015e90: 7469 6d65 7329 2c0a 2020 2020 2020 2020  times),.        
-00015ea0: 2020 2020 2020 2020 2020 2020 6d69 6e28              min(
-00015eb0: 6368 6563 6b65 725f 7265 7370 6f6e 7365  checker_response
-00015ec0: 5f74 696d 6573 292c 0a20 2020 2020 2020  _times),.       
-00015ed0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00015ee0: 662e 5f64 656c 7461 5f70 6572 6365 6e74  f._delta_percent
-00015ef0: 6167 6528 6d69 6e28 6368 6563 6b65 725f  age(min(checker_
-00015f00: 7265 7370 6f6e 7365 5f74 696d 6573 292c  response_times),
-00015f10: 206d 696e 2863 7572 7265 6e74 5f72 6573   min(current_res
-00015f20: 706f 6e73 655f 7469 6d65 7329 292c 0a20  ponse_times)),. 
-00015f30: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00015f40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015f50: 2020 226d 6178 2072 6573 706f 6e73 6520    "max response 
-00015f60: 7469 6d65 223a 2028 0a20 2020 2020 2020  time": (.       
-00015f70: 2020 2020 2020 2020 2020 2020 206d 6178               max
-00015f80: 2863 7572 7265 6e74 5f72 6573 706f 6e73  (current_respons
-00015f90: 655f 7469 6d65 7329 2c0a 2020 2020 2020  e_times),.      
-00015fa0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00015fb0: 7828 6368 6563 6b65 725f 7265 7370 6f6e  x(checker_respon
-00015fc0: 7365 5f74 696d 6573 292c 0a20 2020 2020  se_times),.     
-00015fd0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00015fe0: 656c 662e 5f64 656c 7461 5f70 6572 6365  elf._delta_perce
-00015ff0: 6e74 6167 6528 6d61 7828 6368 6563 6b65  ntage(max(checke
-00016000: 725f 7265 7370 6f6e 7365 5f74 696d 6573  r_response_times
-00016010: 292c 206d 6178 2863 7572 7265 6e74 5f72  ), max(current_r
-00016020: 6573 706f 6e73 655f 7469 6d65 7329 292c  esponse_times)),
-00016030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016040: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00016050: 2020 2020 226d 6561 6e20 7265 7370 6f6e      "mean respon
-00016060: 7365 2074 696d 6522 3a20 280a 2020 2020  se time": (.    
-00016070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016080: 666c 6f61 7428 666f 726d 6174 286d 6561  float(format(mea
-00016090: 6e28 6375 7272 656e 745f 7265 7370 6f6e  n(current_respon
-000160a0: 7365 5f74 696d 6573 292c 2022 2e36 6622  se_times), ".6f"
-000160b0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-000160c0: 2020 2020 2020 2020 666c 6f61 7428 666f          float(fo
-000160d0: 726d 6174 286d 6561 6e28 6368 6563 6b65  rmat(mean(checke
-000160e0: 725f 7265 7370 6f6e 7365 5f74 696d 6573  r_response_times
-000160f0: 292c 2022 2e36 6622 2929 2c0a 2020 2020  ), ".6f")),.    
-00016100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016110: 7365 6c66 2e5f 6465 6c74 615f 7065 7263  self._delta_perc
-00016120: 656e 7461 6765 280a 2020 2020 2020 2020  entage(.        
-00016130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016140: 666c 6f61 7428 666f 726d 6174 286d 6561  float(format(mea
-00016150: 6e28 6368 6563 6b65 725f 7265 7370 6f6e  n(checker_respon
-00016160: 7365 5f74 696d 6573 292c 2022 2e36 6622  se_times), ".6f"
-00016170: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00016180: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-00016190: 7428 666f 726d 6174 286d 6561 6e28 6375  t(format(mean(cu
-000161a0: 7272 656e 745f 7265 7370 6f6e 7365 5f74  rrent_response_t
-000161b0: 696d 6573 292c 2022 2e36 6622 2929 2c0a  imes), ".6f")),.
-000161c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161d0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-000161e0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-000161f0: 2020 2020 2020 2020 2020 226d 6564 6961            "media
-00016200: 6e20 7265 7370 6f6e 7365 2074 696d 6522  n response time"
-00016210: 3a20 280a 2020 2020 2020 2020 2020 2020  : (.            
-00016220: 2020 2020 2020 2020 6d65 6469 616e 2863          median(c
-00016230: 7572 7265 6e74 5f72 6573 706f 6e73 655f  urrent_response_
-00016240: 7469 6d65 7329 2c0a 2020 2020 2020 2020  times),.        
-00016250: 2020 2020 2020 2020 2020 2020 6d65 6469              medi
-00016260: 616e 2863 6865 636b 6572 5f72 6573 706f  an(checker_respo
-00016270: 6e73 655f 7469 6d65 7329 2c0a 2020 2020  nse_times),.    
-00016280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016290: 7365 6c66 2e5f 6465 6c74 615f 7065 7263  self._delta_perc
-000162a0: 656e 7461 6765 286d 6564 6961 6e28 6368  entage(median(ch
-000162b0: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
-000162c0: 696d 6573 292c 206d 6564 6961 6e28 6375  imes), median(cu
-000162d0: 7272 656e 745f 7265 7370 6f6e 7365 5f74  rrent_response_t
-000162e0: 696d 6573 2929 2c0a 2020 2020 2020 2020  imes)),.        
-000162f0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-00016300: 2020 2020 2020 2020 2020 2022 7039 3020             "p90 
-00016310: 7265 7370 6f6e 7365 2074 696d 6522 3a20  response time": 
-00016320: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00016330: 2020 2020 2020 736f 7274 6564 2863 7572        sorted(cur
-00016340: 7265 6e74 5f72 6573 706f 6e73 655f 7469  rent_response_ti
-00016350: 6d65 7329 5b6d 6174 682e 6365 696c 286c  mes)[math.ceil(l
-00016360: 656e 2863 7572 7265 6e74 5f72 6573 706f  en(current_respo
-00016370: 6e73 655f 7469 6d65 7329 202a 2030 2e39  nse_times) * 0.9
-00016380: 2920 2d20 315d 2c0a 2020 2020 2020 2020  ) - 1],.        
-00016390: 2020 2020 2020 2020 2020 2020 736f 7274              sort
-000163a0: 6564 2863 6865 636b 6572 5f72 6573 706f  ed(checker_respo
-000163b0: 6e73 655f 7469 6d65 7329 5b6d 6174 682e  nse_times)[math.
-000163c0: 6365 696c 286c 656e 2863 6865 636b 6572  ceil(len(checker
-000163d0: 5f72 6573 706f 6e73 655f 7469 6d65 7329  _response_times)
-000163e0: 202a 2030 2e39 2920 2d20 315d 2c0a 2020   * 0.9) - 1],.  
-000163f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016400: 2020 7365 6c66 2e5f 6465 6c74 615f 7065    self._delta_pe
-00016410: 7263 656e 7461 6765 280a 2020 2020 2020  rcentage(.      
-00016420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016430: 2020 736f 7274 6564 2863 6865 636b 6572    sorted(checker
-00016440: 5f72 6573 706f 6e73 655f 7469 6d65 7329  _response_times)
-00016450: 5b6d 6174 682e 6365 696c 286c 656e 2863  [math.ceil(len(c
-00016460: 6865 636b 6572 5f72 6573 706f 6e73 655f  hecker_response_
-00016470: 7469 6d65 7329 202a 2030 2e39 2920 2d20  times) * 0.9) - 
-00016480: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-00016490: 2020 2020 2020 2020 2020 2020 736f 7274              sort
-000164a0: 6564 2863 7572 7265 6e74 5f72 6573 706f  ed(current_respo
-000164b0: 6e73 655f 7469 6d65 7329 5b6d 6174 682e  nse_times)[math.
-000164c0: 6365 696c 286c 656e 2863 7572 7265 6e74  ceil(len(current
-000164d0: 5f72 6573 706f 6e73 655f 7469 6d65 7329  _response_times)
-000164e0: 202a 2030 2e39 2920 2d20 315d 2c0a 2020   * 0.9) - 1],.  
-000164f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016500: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-00016510: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00016520: 2020 2020 2020 2020 226d 696e 2072 6561          "min rea
-00016530: 6420 6279 7465 7322 3a20 280a 2020 2020  d bytes": (.    
-00016540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016550: 666f 726d 6174 5f73 697a 6528 6d69 6e28  format_size(min(
-00016560: 6375 7272 656e 745f 7265 6164 5f62 7974  current_read_byt
-00016570: 6573 2929 2c0a 2020 2020 2020 2020 2020  es)),.          
-00016580: 2020 2020 2020 2020 2020 666f 726d 6174            format
-00016590: 5f73 697a 6528 6d69 6e28 6368 6563 6b65  _size(min(checke
-000165a0: 725f 7265 6164 5f62 7974 6573 2929 2c0a  r_read_bytes)),.
-000165b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165c0: 2020 2020 7365 6c66 2e5f 6465 6c74 615f      self._delta_
-000165d0: 7065 7263 656e 7461 6765 286d 696e 2863  percentage(min(c
-000165e0: 6865 636b 6572 5f72 6561 645f 6279 7465  hecker_read_byte
-000165f0: 7329 2c20 6d69 6e28 6375 7272 656e 745f  s), min(current_
-00016600: 7265 6164 5f62 7974 6573 2929 2c0a 2020  read_bytes)),.  
-00016610: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-00016620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016630: 2022 6d61 7820 7265 6164 2062 7974 6573   "max read bytes
-00016640: 223a 2028 0a20 2020 2020 2020 2020 2020  ": (.           
-00016650: 2020 2020 2020 2020 2066 6f72 6d61 745f           format_
-00016660: 7369 7a65 286d 6178 2863 7572 7265 6e74  size(max(current
-00016670: 5f72 6561 645f 6279 7465 7329 292c 0a20  _read_bytes)),. 
-00016680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016690: 2020 2066 6f72 6d61 745f 7369 7a65 286d     format_size(m
-000166a0: 6178 2863 6865 636b 6572 5f72 6561 645f  ax(checker_read_
-000166b0: 6279 7465 7329 292c 0a20 2020 2020 2020  bytes)),.       
-000166c0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000166d0: 662e 5f64 656c 7461 5f70 6572 6365 6e74  f._delta_percent
-000166e0: 6167 6528 6d61 7828 6368 6563 6b65 725f  age(max(checker_
-000166f0: 7265 6164 5f62 7974 6573 292c 206d 6178  read_bytes), max
-00016700: 2863 7572 7265 6e74 5f72 6561 645f 6279  (current_read_by
-00016710: 7465 7329 292c 0a20 2020 2020 2020 2020  tes)),.         
-00016720: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00016730: 2020 2020 2020 2020 2020 226d 6561 6e20            "mean 
-00016740: 7265 6164 2062 7974 6573 223a 2028 0a20  read bytes": (. 
-00016750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016760: 2020 2066 6f72 6d61 745f 7369 7a65 286d     format_size(m
-00016770: 6561 6e28 6375 7272 656e 745f 7265 6164  ean(current_read
-00016780: 5f62 7974 6573 2929 2c0a 2020 2020 2020  _bytes)),.      
-00016790: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-000167a0: 726d 6174 5f73 697a 6528 6d65 616e 2863  rmat_size(mean(c
-000167b0: 6865 636b 6572 5f72 6561 645f 6279 7465  hecker_read_byte
-000167c0: 7329 292c 0a20 2020 2020 2020 2020 2020  s)),.           
-000167d0: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
-000167e0: 656c 7461 5f70 6572 6365 6e74 6167 6528  elta_percentage(
-000167f0: 6d65 616e 2863 6865 636b 6572 5f72 6561  mean(checker_rea
-00016800: 645f 6279 7465 7329 2c20 6d65 616e 2863  d_bytes), mean(c
-00016810: 7572 7265 6e74 5f72 6561 645f 6279 7465  urrent_read_byte
-00016820: 7329 292c 0a20 2020 2020 2020 2020 2020  s)),.           
-00016830: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00016840: 2020 2020 2020 2020 226d 6564 6961 6e20          "median 
-00016850: 7265 6164 2062 7974 6573 223a 2028 0a20  read bytes": (. 
-00016860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016870: 2020 2066 6f72 6d61 745f 7369 7a65 286d     format_size(m
-00016880: 6564 6961 6e28 6375 7272 656e 745f 7265  edian(current_re
-00016890: 6164 5f62 7974 6573 2929 2c0a 2020 2020  ad_bytes)),.    
-000168a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168b0: 666f 726d 6174 5f73 697a 6528 6d65 6469  format_size(medi
-000168c0: 616e 2863 6865 636b 6572 5f72 6561 645f  an(checker_read_
-000168d0: 6279 7465 7329 292c 0a20 2020 2020 2020  bytes)),.       
-000168e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000168f0: 662e 5f64 656c 7461 5f70 6572 6365 6e74  f._delta_percent
-00016900: 6167 6528 6d65 6469 616e 2863 6865 636b  age(median(check
-00016910: 6572 5f72 6561 645f 6279 7465 7329 2c20  er_read_bytes), 
-00016920: 6d65 6469 616e 2863 7572 7265 6e74 5f72  median(current_r
-00016930: 6561 645f 6279 7465 7329 292c 0a20 2020  ead_bytes)),.   
-00016940: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-00016950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016960: 2270 3930 2072 6561 6420 6279 7465 7322  "p90 read bytes"
-00016970: 3a20 280a 2020 2020 2020 2020 2020 2020  : (.            
-00016980: 2020 2020 2020 2020 666f 726d 6174 5f73          format_s
-00016990: 697a 6528 736f 7274 6564 2863 7572 7265  ize(sorted(curre
-000169a0: 6e74 5f72 6561 645f 6279 7465 7329 5b6d  nt_read_bytes)[m
-000169b0: 6174 682e 6365 696c 286c 656e 2863 7572  ath.ceil(len(cur
-000169c0: 7265 6e74 5f72 6561 645f 6279 7465 7329  rent_read_bytes)
-000169d0: 202a 2030 2e39 2920 2d20 315d 292c 0a20   * 0.9) - 1]),. 
-000169e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169f0: 2020 2066 6f72 6d61 745f 7369 7a65 2873     format_size(s
-00016a00: 6f72 7465 6428 6368 6563 6b65 725f 7265  orted(checker_re
-00016a10: 6164 5f62 7974 6573 295b 6d61 7468 2e63  ad_bytes)[math.c
-00016a20: 6569 6c28 6c65 6e28 6368 6563 6b65 725f  eil(len(checker_
-00016a30: 7265 6164 5f62 7974 6573 2920 2a20 302e  read_bytes) * 0.
-00016a40: 3929 202d 2031 5d29 2c0a 2020 2020 2020  9) - 1]),.      
-00016a50: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00016a60: 6c66 2e5f 6465 6c74 615f 7065 7263 656e  lf._delta_percen
-00016a70: 7461 6765 280a 2020 2020 2020 2020 2020  tage(.          
-00016a80: 2020 2020 2020 2020 2020 2020 2020 736f                so
-00016a90: 7274 6564 2863 6865 636b 6572 5f72 6561  rted(checker_rea
-00016aa0: 645f 6279 7465 7329 5b6d 6174 682e 6365  d_bytes)[math.ce
-00016ab0: 696c 286c 656e 2863 6865 636b 6572 5f72  il(len(checker_r
-00016ac0: 6561 645f 6279 7465 7329 202a 2030 2e39  ead_bytes) * 0.9
-00016ad0: 2920 2d20 315d 2c0a 2020 2020 2020 2020  ) - 1],.        
-00016ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016af0: 736f 7274 6564 2863 7572 7265 6e74 5f72  sorted(current_r
-00016b00: 6561 645f 6279 7465 7329 5b6d 6174 682e  ead_bytes)[math.
-00016b10: 6365 696c 286c 656e 2863 7572 7265 6e74  ceil(len(current
-00016b20: 5f72 6561 645f 6279 7465 7329 202a 2030  _read_bytes) * 0
-00016b30: 2e39 2920 2d20 315d 2c0a 2020 2020 2020  .9) - 1],.      
-00016b40: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-00016b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016b60: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00016b70: 7d0a 2020 2020 2020 2020 6578 6365 7074  }.        except
-00016b80: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-00016b90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00016ba0: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
-00016bb0: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
-00016bc0: 7863 6570 7469 6f6e 2865 290a 0a20 2020  xception(e)..   
-00016bd0: 2020 2020 2066 6169 6c75 7265 7320 3d20       failures = 
-00016be0: 5b5d 0a20 2020 2020 2020 2069 6620 6e6f  [].        if no
-00016bf0: 7420 7265 7375 6c74 2e77 6173 5375 6363  t result.wasSucc
-00016c00: 6573 7366 756c 2829 3a0a 2020 2020 2020  essful():.      
-00016c10: 2020 2020 2020 666f 7220 5f74 6573 742c        for _test,
-00016c20: 2065 7272 2069 6e20 7265 7375 6c74 2e66   err in result.f
-00016c30: 6169 6c75 7265 733a 0a20 2020 2020 2020  ailures:.       
-00016c40: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00016c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c60: 2020 6920 3d20 6572 722e 696e 6465 7828    i = err.index(
-00016c70: 2241 7373 6572 7469 6f6e 4572 726f 7222  "AssertionError"
-00016c80: 2920 2b20 6c65 6e28 2241 7373 6572 7469  ) + len("Asserti
-00016c90: 6f6e 4572 726f 7220 3a22 290a 2020 2020  onError :").    
-00016ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016cb0: 6661 696c 7572 6573 2e61 7070 656e 6428  failures.append(
-00016cc0: 7b22 6e61 6d65 223a 2073 7472 285f 7465  {"name": str(_te
-00016cd0: 7374 292c 2022 6572 726f 7222 3a20 6572  st), "error": er
-00016ce0: 725b 693a 5d7d 290a 2020 2020 2020 2020  r[i:]}).        
-00016cf0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00016d00: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-00016d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d20: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
-00016d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d40: 2020 2020 206c 6f67 6769 6e67 2e65 7863       logging.exc
-00016d50: 6570 7469 6f6e 2865 290a 0a20 2020 2020  eption(e)..     
-00016d60: 2020 2072 6574 7572 6e20 5069 7065 4368     return PipeCh
-00016d70: 6563 6b65 7252 756e 6e65 7252 6573 706f  eckerRunnerRespo
-00016d80: 6e73 6528 0a20 2020 2020 2020 2020 2020  nse(.           
-00016d90: 2070 6970 655f 6e61 6d65 3d63 6865 636b   pipe_name=check
-00016da0: 6572 5f70 6970 655f 6e61 6d65 2c0a 2020  er_pipe_name,.  
-00016db0: 2020 2020 2020 2020 2020 7465 7374 5f74            test_t
-00016dc0: 7970 653d 6765 7461 7474 7228 7365 6c66  ype=getattr(self
-00016dd0: 2c20 2274 6573 745f 7479 7065 222c 2022  , "test_type", "
-00016de0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00016df0: 6f75 7470 7574 3d67 6574 6174 7472 2872  output=getattr(r
-00016e00: 6573 756c 742e 7374 7265 616d 2c20 225f  esult.stream, "_
-00016e10: 6275 6666 6572 222c 2022 2229 2c0a 2020  buffer", ""),.  
-00016e20: 2020 2020 2020 2020 2020 6d65 7472 6963            metric
-00016e30: 735f 7375 6d6d 6172 793d 6d65 7472 6963  s_summary=metric
-00016e40: 735f 7375 6d6d 6172 792c 0a20 2020 2020  s_summary,.     
-00016e50: 2020 2020 2020 206d 6574 7269 6373 5f74         metrics_t
-00016e60: 696d 696e 673d 6d65 7472 6963 735f 7469  iming=metrics_ti
-00016e70: 6d69 6e67 2c0a 2020 2020 2020 2020 2020  ming,.          
-00016e80: 2020 6661 696c 6564 3d66 6169 6c75 7265    failed=failure
-00016e90: 732c 0a20 2020 2020 2020 2020 2020 2077  s,.            w
-00016ea0: 6173 5f73 7563 6365 7373 6675 6c6c 3d72  as_successfull=r
-00016eb0: 6573 756c 742e 7761 7353 7563 6365 7373  esult.wasSuccess
-00016ec0: 6675 6c28 292c 0a20 2020 2020 2020 2029  ful(),.        )
-00016ed0: 0a0a 0a61 7379 6e63 2064 6566 2063 6865  ...async def che
-00016ee0: 636b 5f70 6970 6528 0a20 2020 2070 6970  ck_pipe(.    pip
-00016ef0: 652c 0a20 2020 2068 6f73 743a 2073 7472  e,.    host: str
-00016f00: 2c0a 2020 2020 746f 6b65 6e3a 2073 7472  ,.    token: str
-00016f10: 2c0a 2020 2020 706f 7075 6c61 7465 3a20  ,.    populate: 
-00016f20: 626f 6f6c 2c0a 2020 2020 636c 3a20 5469  bool,.    cl: Ti
-00016f30: 6e79 422c 0a20 2020 206c 696d 6974 3a20  nyB,.    limit: 
-00016f40: 696e 7420 3d20 302c 0a20 2020 2073 616d  int = 0,.    sam
-00016f50: 706c 655f 6279 5f70 6172 616d 733a 2069  ple_by_params: i
-00016f60: 6e74 203d 2030 2c0a 2020 2020 6f6e 6c79  nt = 0,.    only
-00016f70: 5f72 6573 706f 6e73 655f 7469 6d65 733d  _response_times=
-00016f80: 4661 6c73 652c 0a20 2020 206d 6174 6368  False,.    match
-00016f90: 6573 3a20 4f70 7469 6f6e 616c 5b4c 6973  es: Optional[Lis
-00016fa0: 745b 7374 725d 5d20 3d20 4e6f 6e65 2c0a  t[str]] = None,.
-00016fb0: 2020 2020 6661 696c 6661 7374 3a20 626f      failfast: bo
-00016fc0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-00016fd0: 7661 6c69 6461 7465 5f70 726f 6365 7373  validate_process
-00016fe0: 6564 5f62 7974 6573 3a20 626f 6f6c 203d  ed_bytes: bool =
-00016ff0: 2046 616c 7365 2c0a 2020 2020 6967 6e6f   False,.    igno
-00017000: 7265 5f6f 7264 6572 3a20 626f 6f6c 203d  re_order: bool =
-00017010: 2046 616c 7365 2c0a 2020 2020 746f 6b65   False,.    toke
-00017020: 6e5f 666f 725f 7265 7175 6573 7473 5f74  n_for_requests_t
-00017030: 6f5f 6368 6563 6b3a 204f 7074 696f 6e61  o_check: Optiona
-00017040: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-00017050: 2020 2063 7572 7265 6e74 5f70 6970 653a     current_pipe:
-00017060: 204f 7074 696f 6e61 6c5b 4469 6374 5b73   Optional[Dict[s
-00017070: 7472 2c20 416e 795d 5d20 3d20 4e6f 6e65  tr, Any]] = None
-00017080: 2c0a 293a 0a20 2020 2063 6865 636b 6572  ,.):.    checker
-00017090: 5f70 6970 6520 3d20 6465 6570 636f 7079  _pipe = deepcopy
-000170a0: 2870 6970 6529 0a20 2020 2063 6865 636b  (pipe).    check
-000170b0: 6572 5f70 6970 655b 226e 616d 6522 5d20  er_pipe["name"] 
-000170c0: 3d20 6622 7b63 6865 636b 6572 5f70 6970  = f"{checker_pip
-000170d0: 655b 276e 616d 6527 5d7d 5f5f 6368 6563  e['name']}__chec
-000170e0: 6b65 7222 0a0a 2020 2020 6966 2063 7572  ker"..    if cur
-000170f0: 7265 6e74 5f70 6970 653a 0a20 2020 2020  rent_pipe:.     
-00017100: 2020 2070 6970 655f 7479 7065 203d 2063     pipe_type = c
-00017110: 7572 7265 6e74 5f70 6970 655b 2274 7970  urrent_pipe["typ
-00017120: 6522 5d0a 2020 2020 2020 2020 6966 2070  e"].        if p
-00017130: 6970 655f 7479 7065 203d 3d20 5069 7065  ipe_type == Pipe
-00017140: 5479 7065 732e 434f 5059 3a0a 2020 2020  Types.COPY:.    
-00017150: 2020 2020 2020 2020 6177 6169 7420 636c          await cl
-00017160: 2e70 6970 655f 7265 6d6f 7665 5f63 6f70  .pipe_remove_cop
-00017170: 7928 6375 7272 656e 745f 7069 7065 5b22  y(current_pipe["
-00017180: 6964 225d 2c20 6375 7272 656e 745f 7069  id"], current_pi
-00017190: 7065 5b22 636f 7079 5f6e 6f64 6522 5d29  pe["copy_node"])
-000171a0: 0a20 2020 2020 2020 2069 6620 7069 7065  .        if pipe
-000171b0: 5f74 7970 6520 3d3d 2050 6970 6554 7970  _type == PipeTyp
-000171c0: 6573 2e44 4154 415f 5349 4e4b 3a0a 2020  es.DATA_SINK:.  
-000171d0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-000171e0: 636c 2e70 6970 655f 7265 6d6f 7665 5f73  cl.pipe_remove_s
-000171f0: 696e 6b28 6375 7272 656e 745f 7069 7065  ink(current_pipe
-00017200: 5b22 6964 225d 2c20 6375 7272 656e 745f  ["id"], current_
-00017210: 7069 7065 5b22 7369 6e6b 5f6e 6f64 6522  pipe["sink_node"
-00017220: 5d29 0a0a 2020 2020 2320 496e 2063 6173  ])..    # In cas
-00017230: 6520 6f66 2064 6f69 6e67 202d 2d66 6f72  e of doing --for
-00017240: 6365 2066 6f72 2061 206d 6174 6572 6961  ce for a materia
-00017250: 6c69 7a65 6420 7669 6577 2c20 6368 6563  lized view, chec
-00017260: 6b65 7220 6973 2062 6569 6e67 2063 7265  ker is being cre
-00017270: 6174 6564 2061 7320 7374 616e 6461 7264  ated as standard
-00017280: 2070 6970 650a 2020 2020 666f 7220 6e6f   pipe.    for no
-00017290: 6465 2069 6e20 6368 6563 6b65 725f 7069  de in checker_pi
-000172a0: 7065 5b22 6e6f 6465 7322 5d3a 0a20 2020  pe["nodes"]:.   
-000172b0: 2020 2020 206e 6f64 655b 2270 6172 616d       node["param
-000172c0: 7322 5d5b 2274 7970 6522 5d20 3d20 5069  s"]["type"] = Pi
-000172d0: 7065 4e6f 6465 5479 7065 732e 5354 414e  peNodeTypes.STAN
-000172e0: 4441 5244 0a0a 2020 2020 6966 2070 6f70  DARD..    if pop
-000172f0: 756c 6174 653a 0a20 2020 2020 2020 2072  ulate:.        r
-00017300: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
-00017310: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
-00017320: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-00017330: 6368 6563 6b5f 7069 7065 735f 706f 7075  check_pipes_popu
-00017340: 6c61 7465 2829 290a 0a20 2020 2072 756e  late())..    run
-00017350: 6e65 7220 3d20 5069 7065 4368 6563 6b65  ner = PipeChecke
-00017360: 7252 756e 6e65 7228 7069 7065 5b22 6e61  rRunner(pipe["na
-00017370: 6d65 225d 2c20 686f 7374 290a 2020 2020  me"], host).    
-00017380: 6865 6164 6572 7320 3d20 280a 2020 2020  headers = (.    
-00017390: 2020 2020 7b22 4175 7468 6f72 697a 6174      {"Authorizat
-000173a0: 696f 6e22 3a20 6622 4265 6172 6572 207b  ion": f"Bearer {
-000173b0: 746f 6b65 6e5f 666f 725f 7265 7175 6573  token_for_reques
-000173c0: 7473 5f74 6f5f 6368 6563 6b7d 227d 0a20  ts_to_check}"}. 
-000173d0: 2020 2020 2020 2069 6620 746f 6b65 6e5f         if token_
-000173e0: 666f 725f 7265 7175 6573 7473 5f74 6f5f  for_requests_to_
-000173f0: 6368 6563 6b0a 2020 2020 2020 2020 656c  check.        el
-00017400: 7365 207b 2241 7574 686f 7269 7a61 7469  se {"Authorizati
-00017410: 6f6e 223a 2066 2242 6561 7265 7220 7b74  on": f"Bearer {t
-00017420: 6f6b 656e 7d22 7d0a 2020 2020 290a 0a20  oken}"}.    ).. 
-00017430: 2020 2073 716c 5f66 6f72 5f63 6f76 6572     sql_for_cover
-00017440: 6167 652c 2073 716c 5f6c 6174 6573 745f  age, sql_latest_
-00017450: 7265 7175 6573 7473 203d 2072 756e 6e65  requests = runne
-00017460: 722e 6765 745f 7371 6c73 5f66 6f72 5f72  r.get_sqls_for_r
-00017470: 6571 7565 7374 735f 746f 5f63 6865 636b  equests_to_check
-00017480: 280a 2020 2020 2020 2020 6d61 7463 6865  (.        matche
-00017490: 7320 6f72 205b 5d2c 2073 616d 706c 655f  s or [], sample_
-000174a0: 6279 5f70 6172 616d 732c 206c 696d 6974  by_params, limit
-000174b0: 0a20 2020 2029 0a0a 2020 2020 7061 7261  .    )..    para
-000174c0: 6d73 203d 207b 2271 223a 2073 716c 5f66  ms = {"q": sql_f
-000174d0: 6f72 5f63 6f76 6572 6167 6520 6966 206c  or_coverage if l
-000174e0: 696d 6974 203d 3d20 3020 616e 6420 7361  imit == 0 and sa
-000174f0: 6d70 6c65 5f62 795f 7061 7261 6d73 203e  mple_by_params >
-00017500: 2030 2065 6c73 6520 7371 6c5f 6c61 7465   0 else sql_late
-00017510: 7374 5f72 6571 7565 7374 737d 0a20 2020  st_requests}.   
-00017520: 2072 3a20 7265 7175 6573 7473 2e52 6573   r: requests.Res
-00017530: 706f 6e73 6520 3d20 6177 6169 7420 7265  ponse = await re
-00017540: 7175 6573 7473 5f67 6574 280a 2020 2020  quests_get(.    
-00017550: 2020 2020 6622 7b68 6f73 747d 2f76 302f      f"{host}/v0/
-00017560: 7371 6c3f 7b75 726c 656e 636f 6465 2870  sql?{urlencode(p
-00017570: 6172 616d 7329 7d22 2c20 6865 6164 6572  arams)}", header
-00017580: 733d 6865 6164 6572 732c 2076 6572 6966  s=headers, verif
-00017590: 793d 6e6f 7420 6765 7465 6e76 5f62 6f6f  y=not getenv_boo
-000175a0: 6c28 2254 425f 4449 5341 424c 455f 5353  l("TB_DISABLE_SS
-000175b0: 4c5f 4348 4543 4b53 222c 2046 616c 7365  L_CHECKS", False
-000175c0: 290a 2020 2020 290a 0a20 2020 2023 2049  ).    )..    # I
-000175d0: 6620 7765 2067 6574 2061 2074 696d 656f  f we get a timeo
-000175e0: 7574 2c20 6661 6c6c 6261 636b 2074 6f20  ut, fallback to 
-000175f0: 6a75 7374 2074 6865 206c 6173 7420 7265  just the last re
-00017600: 7175 6573 7473 0a0a 2020 2020 6966 206e  quests..    if n
-00017610: 6f74 2072 206f 7220 722e 7374 6174 7573  ot r or r.status
-00017620: 5f63 6f64 6520 3d3d 2034 3038 3a0a 2020  _code == 408:.  
-00017630: 2020 2020 2020 7061 7261 6d73 203d 207b        params = {
-00017640: 2271 223a 2073 716c 5f6c 6174 6573 745f  "q": sql_latest_
-00017650: 7265 7175 6573 7473 7d0a 2020 2020 2020  requests}.      
-00017660: 2020 7220 3d20 6177 6169 7420 7265 7175    r = await requ
-00017670: 6573 7473 5f67 6574 280a 2020 2020 2020  ests_get(.      
-00017680: 2020 2020 2020 6622 7b68 6f73 747d 2f76        f"{host}/v
-00017690: 302f 7371 6c3f 7b75 726c 656e 636f 6465  0/sql?{urlencode
-000176a0: 2870 6172 616d 7329 7d22 2c0a 2020 2020  (params)}",.    
-000176b0: 2020 2020 2020 2020 6865 6164 6572 733d          headers=
-000176c0: 6865 6164 6572 732c 0a20 2020 2020 2020  headers,.       
-000176d0: 2020 2020 2076 6572 6966 793d 6e6f 7420       verify=not 
-000176e0: 6765 7465 6e76 5f62 6f6f 6c28 2254 425f  getenv_bool("TB_
-000176f0: 4449 5341 424c 455f 5353 4c5f 4348 4543  DISABLE_SSL_CHEC
-00017700: 4b53 222c 2046 616c 7365 292c 0a20 2020  KS", False),.   
-00017710: 2020 2020 2029 0a0a 2020 2020 6966 206e       )..    if n
-00017720: 6f74 2072 206f 7220 722e 7374 6174 7573  ot r or r.status
-00017730: 5f63 6f64 6520 213d 2032 3030 3a0a 2020  _code != 200:.  
-00017740: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
-00017750: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
-00017760: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-00017770: 2e65 7272 6f72 5f63 6865 636b 5f70 6970  .error_check_pip
-00017780: 6573 5f61 7069 2870 6970 653d 7069 7065  es_api(pipe=pipe
-00017790: 5b22 6e61 6d65 225d 2929 0a0a 2020 2020  ["name"]))..    
-000177a0: 7069 7065 5f72 6571 7565 7374 735f 746f  pipe_requests_to
-000177b0: 5f63 6865 636b 3a20 4c69 7374 5b44 6963  _check: List[Dic
-000177c0: 745b 7374 722c 2041 6e79 5d5d 203d 205b  t[str, Any]] = [
-000177d0: 5d0a 2020 2020 666f 7220 726f 7720 696e  ].    for row in
-000177e0: 2072 2e6a 736f 6e28 292e 6765 7428 2264   r.json().get("d
-000177f0: 6174 6122 2c20 5b5d 293a 0a20 2020 2020  ata", []):.     
-00017800: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-00017810: 6528 6c65 6e28 726f 775b 2265 6e64 706f  e(len(row["endpo
-00017820: 696e 745f 7572 6c22 5d29 293a 0a20 2020  int_url"])):.   
-00017830: 2020 2020 2020 2020 2070 6970 655f 7265           pipe_re
-00017840: 7175 6573 7473 5f74 6f5f 6368 6563 6b20  quests_to_check 
-00017850: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
-00017860: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00017870: 2020 2020 2020 2020 2020 2022 656e 6470             "endp
-00017880: 6f69 6e74 5f75 726c 223a 2066 227b 686f  oint_url": f"{ho
-00017890: 7374 7d7b 726f 775b 2765 6e64 706f 696e  st}{row['endpoin
-000178a0: 745f 7572 6c27 5d5b 695d 7d22 2c0a 2020  t_url'][i]}",.  
-000178b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178c0: 2020 2270 6970 655f 7265 7175 6573 745f    "pipe_request_
-000178d0: 7061 7261 6d73 223a 2072 6f77 5b22 7069  params": row["pi
-000178e0: 7065 5f72 6571 7565 7374 5f70 6172 616d  pe_request_param
-000178f0: 7322 5d5b 695d 2c0a 2020 2020 2020 2020  s"][i],.        
-00017900: 2020 2020 2020 2020 2020 2020 2268 7474              "htt
-00017910: 705f 6d65 7468 6f64 223a 2072 6f77 5b22  p_method": row["
-00017920: 6874 7470 5f6d 6574 686f 6422 5d2c 0a20  http_method"],. 
-00017930: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00017940: 0a20 2020 2020 2020 2020 2020 205d 0a0a  .            ]..
-00017950: 2020 2020 6966 206e 6f74 2070 6970 655f      if not pipe_
-00017960: 7265 7175 6573 7473 5f74 6f5f 6368 6563  requests_to_chec
-00017970: 6b3a 0a20 2020 2020 2020 2072 6574 7572  k:.        retur
-00017980: 6e0a 0a20 2020 2061 7761 6974 206e 6577  n..    await new
-00017990: 5f70 6970 6528 6368 6563 6b65 725f 7069  _pipe(checker_pi
-000179a0: 7065 2c20 636c 2c20 666f 7263 653d 5472  pe, cl, force=Tr
-000179b0: 7565 2c20 6368 6563 6b3d 4661 6c73 652c  ue, check=False,
-000179c0: 2070 6f70 756c 6174 653d 706f 7075 6c61   populate=popula
-000179d0: 7465 290a 0a20 2020 2072 756e 6e65 725f  te)..    runner_
-000179e0: 7265 7370 6f6e 7365 203d 2072 756e 6e65  response = runne
-000179f0: 722e 7275 6e5f 7069 7065 5f63 6865 636b  r.run_pipe_check
-00017a00: 6572 280a 2020 2020 2020 2020 7069 7065  er(.        pipe
-00017a10: 5f72 6571 7565 7374 735f 746f 5f63 6865  _requests_to_che
-00017a20: 636b 2c0a 2020 2020 2020 2020 6368 6563  ck,.        chec
-00017a30: 6b65 725f 7069 7065 5b22 6e61 6d65 225d  ker_pipe["name"]
-00017a40: 2c0a 2020 2020 2020 2020 746f 6b65 6e2c  ,.        token,
-00017a50: 0a20 2020 2020 2020 206f 6e6c 795f 7265  .        only_re
-00017a60: 7370 6f6e 7365 5f74 696d 6573 2c0a 2020  sponse_times,.  
-00017a70: 2020 2020 2020 6967 6e6f 7265 5f6f 7264        ignore_ord
-00017a80: 6572 2c0a 2020 2020 2020 2020 7661 6c69  er,.        vali
-00017a90: 6461 7465 5f70 726f 6365 7373 6564 5f62  date_processed_b
-00017aa0: 7974 6573 2c0a 2020 2020 2020 2020 6661  ytes,.        fa
-00017ab0: 696c 6661 7374 2c0a 2020 2020 290a 0a20  ilfast,.    ).. 
-00017ac0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00017ad0: 6966 2072 756e 6e65 725f 7265 7370 6f6e  if runner_respon
-00017ae0: 7365 2e6d 6574 7269 6373 5f73 756d 6d61  se.metrics_summa
-00017af0: 7279 2061 6e64 2072 756e 6e65 725f 7265  ry and runner_re
-00017b00: 7370 6f6e 7365 2e6d 6574 7269 6373 5f74  sponse.metrics_t
-00017b10: 696d 696e 673a 0a20 2020 2020 2020 2020  iming:.         
-00017b20: 2020 2063 6f6c 756d 6e5f 6e61 6d65 735f     column_names_
-00017b30: 7465 7374 7320 3d20 5b22 5465 7374 2052  tests = ["Test R
-00017b40: 756e 222c 2022 5465 7374 2050 6173 7365  un", "Test Passe
-00017b50: 6422 2c20 2254 6573 7420 4661 696c 6564  d", "Test Failed
-00017b60: 222c 2022 2520 5465 7374 2050 6173 7365  ", "% Test Passe
-00017b70: 6422 2c20 2225 2054 6573 7420 4661 696c  d", "% Test Fail
-00017b80: 6564 225d 0a20 2020 2020 2020 2020 2020  ed"].           
-00017b90: 2063 6c69 636b 2e65 6368 6f28 225c 6e3d   click.echo("\n=
-00017ba0: 3d3d 3d20 5465 7374 204d 6574 7269 6373  === Test Metrics
-00017bb0: 203d 3d3d 3d5c 6e22 290a 2020 2020 2020   ====\n").      
-00017bc0: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-00017bd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00017be0: 2020 666f 726d 6174 5f70 7265 7474 795f    format_pretty_
-00017bf0: 7461 626c 6528 0a20 2020 2020 2020 2020  table(.         
-00017c00: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
-00017c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c20: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00017c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c40: 2020 2072 756e 6e65 725f 7265 7370 6f6e     runner_respon
-00017c50: 7365 2e6d 6574 7269 6373 5f73 756d 6d61  se.metrics_summa
-00017c60: 7279 5b22 7275 6e22 5d2c 0a20 2020 2020  ry["run"],.     
-00017c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c80: 2020 2020 2020 2072 756e 6e65 725f 7265         runner_re
-00017c90: 7370 6f6e 7365 2e6d 6574 7269 6373 5f73  sponse.metrics_s
-00017ca0: 756d 6d61 7279 5b22 7061 7373 6564 225d  ummary["passed"]
-00017cb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017cc0: 2020 2020 2020 2020 2020 2020 2020 7275                ru
-00017cd0: 6e6e 6572 5f72 6573 706f 6e73 652e 6d65  nner_response.me
-00017ce0: 7472 6963 735f 7375 6d6d 6172 795b 2266  trics_summary["f
-00017cf0: 6169 6c65 6422 5d2c 0a20 2020 2020 2020  ailed"],.       
-00017d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d10: 2020 2020 2072 756e 6e65 725f 7265 7370       runner_resp
-00017d20: 6f6e 7365 2e6d 6574 7269 6373 5f73 756d  onse.metrics_sum
-00017d30: 6d61 7279 5b22 7065 7263 656e 7461 6765  mary["percentage
-00017d40: 5f70 6173 7365 6422 5d2c 0a20 2020 2020  _passed"],.     
+00015c30: 5f72 6561 645f 6279 7465 732e 6170 7065  _read_bytes.appe
+00015c40: 6e64 2874 6573 742e 6375 7272 656e 745f  nd(test.current_
+00015c50: 7265 6164 5f62 7974 6573 290a 2020 2020  read_bytes).    
+00015c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c70: 6368 6563 6b65 725f 7265 6164 5f62 7974  checker_read_byt
+00015c80: 6573 2e61 7070 656e 6428 7465 7374 2e63  es.append(test.c
+00015c90: 6865 636b 6572 5f72 6561 645f 6279 7465  hecker_read_byte
+00015ca0: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
+00015cb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00015cc0: 2020 2020 2023 2069 6620 7765 2064 6f20       # if we do 
+00015cd0: 6e6f 7420 6861 7665 2061 6e79 2073 7563  not have any suc
+00015ce0: 6365 7373 6675 6c20 6578 6563 7574 696f  cessful executio
+00015cf0: 6e2c 206c 6574 2773 206a 7573 7420 7265  n, let's just re
+00015d00: 7475 726e 2061 2074 6162 6c65 2077 6974  turn a table wit
+00015d10: 6820 6475 6d6d 7920 6d65 7472 6963 7320  h dummy metrics 
+00015d20: 6874 7470 733a 2f2f 6769 746c 6162 2e63  https://gitlab.c
+00015d30: 6f6d 2f74 696e 7962 6972 642f 616e 616c  om/tinybird/anal
+00015d40: 7974 6963 732f 2d2f 6973 7375 6573 2f31  ytics/-/issues/1
+00015d50: 3038 3735 0a20 2020 2020 2020 2020 2020  0875.           
+00015d60: 2020 2020 2063 7572 7265 6e74 5f72 6573       current_res
+00015d70: 706f 6e73 655f 7469 6d65 7320 3d20 5b30  ponse_times = [0
+00015d80: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00015d90: 2020 6368 6563 6b65 725f 7265 7370 6f6e    checker_respon
+00015da0: 7365 5f74 696d 6573 203d 205b 305d 0a0a  se_times = [0]..
+00015db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015dc0: 6375 7272 656e 745f 7265 6164 5f62 7974  current_read_byt
+00015dd0: 6573 203d 205b 305d 0a20 2020 2020 2020  es = [0].       
+00015de0: 2020 2020 2020 2020 2063 6865 636b 6572           checker
+00015df0: 5f72 6561 645f 6279 7465 7320 3d20 5b30  _read_bytes = [0
+00015e00: 5d0a 0a20 2020 2020 2020 2020 2020 206d  ]..            m
+00015e10: 6574 7269 6373 5f73 756d 6d61 7279 203d  etrics_summary =
+00015e20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00015e30: 2020 2022 7275 6e22 3a20 7265 7375 6c74     "run": result
+00015e40: 2e74 6573 7473 5275 6e2c 0a20 2020 2020  .testsRun,.     
+00015e50: 2020 2020 2020 2020 2020 2022 7061 7373             "pass
+00015e60: 6564 223a 206c 656e 2872 6573 756c 742e  ed": len(result.
+00015e70: 7375 6363 6573 7329 2c0a 2020 2020 2020  success),.      
+00015e80: 2020 2020 2020 2020 2020 2266 6169 6c65            "faile
+00015e90: 6422 3a20 6c65 6e28 7265 7375 6c74 2e66  d": len(result.f
+00015ea0: 6169 6c75 7265 7329 2c0a 2020 2020 2020  ailures),.      
+00015eb0: 2020 2020 2020 2020 2020 2270 6572 6365            "perce
+00015ec0: 6e74 6167 655f 7061 7373 6564 223a 206c  ntage_passed": l
+00015ed0: 656e 2872 6573 756c 742e 7375 6363 6573  en(result.succes
+00015ee0: 7329 202a 2031 3030 202f 2072 6573 756c  s) * 100 / resul
+00015ef0: 742e 7465 7374 7352 756e 2c0a 2020 2020  t.testsRun,.    
+00015f00: 2020 2020 2020 2020 2020 2020 2270 6572              "per
+00015f10: 6365 6e74 6167 655f 6661 696c 6564 223a  centage_failed":
+00015f20: 206c 656e 2872 6573 756c 742e 6661 696c   len(result.fail
+00015f30: 7572 6573 2920 2a20 3130 3020 2f20 7265  ures) * 100 / re
+00015f40: 7375 6c74 2e74 6573 7473 5275 6e2c 0a20  sult.testsRun,. 
+00015f50: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00015f60: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
+00015f70: 5f74 696d 696e 6720 3d20 7b0a 2020 2020  _timing = {.    
+00015f80: 2020 2020 2020 2020 2020 2020 226d 696e              "min
+00015f90: 2072 6573 706f 6e73 6520 7469 6d65 223a   response time":
+00015fa0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00015fb0: 2020 2020 2020 206d 696e 2863 7572 7265         min(curre
+00015fc0: 6e74 5f72 6573 706f 6e73 655f 7469 6d65  nt_response_time
+00015fd0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00015fe0: 2020 2020 2020 2020 6d69 6e28 6368 6563          min(chec
+00015ff0: 6b65 725f 7265 7370 6f6e 7365 5f74 696d  ker_response_tim
+00016000: 6573 292c 0a20 2020 2020 2020 2020 2020  es),.           
+00016010: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
+00016020: 656c 7461 5f70 6572 6365 6e74 6167 6528  elta_percentage(
+00016030: 6d69 6e28 6368 6563 6b65 725f 7265 7370  min(checker_resp
+00016040: 6f6e 7365 5f74 696d 6573 292c 206d 696e  onse_times), min
+00016050: 2863 7572 7265 6e74 5f72 6573 706f 6e73  (current_respons
+00016060: 655f 7469 6d65 7329 292c 0a20 2020 2020  e_times)),.     
+00016070: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+00016080: 2020 2020 2020 2020 2020 2020 2020 226d                "m
+00016090: 6178 2072 6573 706f 6e73 6520 7469 6d65  ax response time
+000160a0: 223a 2028 0a20 2020 2020 2020 2020 2020  ": (.           
+000160b0: 2020 2020 2020 2020 206d 6178 2863 7572           max(cur
+000160c0: 7265 6e74 5f72 6573 706f 6e73 655f 7469  rent_response_ti
+000160d0: 6d65 7329 2c0a 2020 2020 2020 2020 2020  mes),.          
+000160e0: 2020 2020 2020 2020 2020 6d61 7828 6368            max(ch
+000160f0: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
+00016100: 696d 6573 292c 0a20 2020 2020 2020 2020  imes),.         
+00016110: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00016120: 5f64 656c 7461 5f70 6572 6365 6e74 6167  _delta_percentag
+00016130: 6528 6d61 7828 6368 6563 6b65 725f 7265  e(max(checker_re
+00016140: 7370 6f6e 7365 5f74 696d 6573 292c 206d  sponse_times), m
+00016150: 6178 2863 7572 7265 6e74 5f72 6573 706f  ax(current_respo
+00016160: 6e73 655f 7469 6d65 7329 292c 0a20 2020  nse_times)),.   
+00016170: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+00016180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016190: 226d 6561 6e20 7265 7370 6f6e 7365 2074  "mean response t
+000161a0: 696d 6522 3a20 280a 2020 2020 2020 2020  ime": (.        
+000161b0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+000161c0: 7428 666f 726d 6174 286d 6561 6e28 6375  t(format(mean(cu
+000161d0: 7272 656e 745f 7265 7370 6f6e 7365 5f74  rrent_response_t
+000161e0: 696d 6573 292c 2022 2e36 6622 2929 2c0a  imes), ".6f")),.
+000161f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016200: 2020 2020 666c 6f61 7428 666f 726d 6174      float(format
+00016210: 286d 6561 6e28 6368 6563 6b65 725f 7265  (mean(checker_re
+00016220: 7370 6f6e 7365 5f74 696d 6573 292c 2022  sponse_times), "
+00016230: 2e36 6622 2929 2c0a 2020 2020 2020 2020  .6f")),.        
+00016240: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00016250: 2e5f 6465 6c74 615f 7065 7263 656e 7461  ._delta_percenta
+00016260: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
+00016270: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+00016280: 7428 666f 726d 6174 286d 6561 6e28 6368  t(format(mean(ch
+00016290: 6563 6b65 725f 7265 7370 6f6e 7365 5f74  ecker_response_t
+000162a0: 696d 6573 292c 2022 2e36 6622 2929 2c0a  imes), ".6f")),.
+000162b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000162c0: 2020 2020 2020 2020 666c 6f61 7428 666f          float(fo
+000162d0: 726d 6174 286d 6561 6e28 6375 7272 656e  rmat(mean(curren
+000162e0: 745f 7265 7370 6f6e 7365 5f74 696d 6573  t_response_times
+000162f0: 292c 2022 2e36 6622 2929 2c0a 2020 2020  ), ".6f")),.    
+00016300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016310: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00016320: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00016330: 2020 2020 2020 226d 6564 6961 6e20 7265        "median re
+00016340: 7370 6f6e 7365 2074 696d 6522 3a20 280a  sponse time": (.
+00016350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016360: 2020 2020 6d65 6469 616e 2863 7572 7265      median(curre
+00016370: 6e74 5f72 6573 706f 6e73 655f 7469 6d65  nt_response_time
+00016380: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00016390: 2020 2020 2020 2020 6d65 6469 616e 2863          median(c
+000163a0: 6865 636b 6572 5f72 6573 706f 6e73 655f  hecker_response_
+000163b0: 7469 6d65 7329 2c0a 2020 2020 2020 2020  times),.        
+000163c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000163d0: 2e5f 6465 6c74 615f 7065 7263 656e 7461  ._delta_percenta
+000163e0: 6765 286d 6564 6961 6e28 6368 6563 6b65  ge(median(checke
+000163f0: 725f 7265 7370 6f6e 7365 5f74 696d 6573  r_response_times
+00016400: 292c 206d 6564 6961 6e28 6375 7272 656e  ), median(curren
+00016410: 745f 7265 7370 6f6e 7365 5f74 696d 6573  t_response_times
+00016420: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00016430: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00016440: 2020 2020 2020 2022 7039 3020 7265 7370         "p90 resp
+00016450: 6f6e 7365 2074 696d 6522 3a20 280a 2020  onse time": (.  
+00016460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016470: 2020 736f 7274 6564 2863 7572 7265 6e74    sorted(current
+00016480: 5f72 6573 706f 6e73 655f 7469 6d65 7329  _response_times)
+00016490: 5b6d 6174 682e 6365 696c 286c 656e 2863  [math.ceil(len(c
+000164a0: 7572 7265 6e74 5f72 6573 706f 6e73 655f  urrent_response_
+000164b0: 7469 6d65 7329 202a 2030 2e39 2920 2d20  times) * 0.9) - 
+000164c0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+000164d0: 2020 2020 2020 2020 736f 7274 6564 2863          sorted(c
+000164e0: 6865 636b 6572 5f72 6573 706f 6e73 655f  hecker_response_
+000164f0: 7469 6d65 7329 5b6d 6174 682e 6365 696c  times)[math.ceil
+00016500: 286c 656e 2863 6865 636b 6572 5f72 6573  (len(checker_res
+00016510: 706f 6e73 655f 7469 6d65 7329 202a 2030  ponse_times) * 0
+00016520: 2e39 2920 2d20 315d 2c0a 2020 2020 2020  .9) - 1],.      
+00016530: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00016540: 6c66 2e5f 6465 6c74 615f 7065 7263 656e  lf._delta_percen
+00016550: 7461 6765 280a 2020 2020 2020 2020 2020  tage(.          
+00016560: 2020 2020 2020 2020 2020 2020 2020 736f                so
+00016570: 7274 6564 2863 6865 636b 6572 5f72 6573  rted(checker_res
+00016580: 706f 6e73 655f 7469 6d65 7329 5b6d 6174  ponse_times)[mat
+00016590: 682e 6365 696c 286c 656e 2863 6865 636b  h.ceil(len(check
+000165a0: 6572 5f72 6573 706f 6e73 655f 7469 6d65  er_response_time
+000165b0: 7329 202a 2030 2e39 2920 2d20 315d 2c0a  s) * 0.9) - 1],.
+000165c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165d0: 2020 2020 2020 2020 736f 7274 6564 2863          sorted(c
+000165e0: 7572 7265 6e74 5f72 6573 706f 6e73 655f  urrent_response_
+000165f0: 7469 6d65 7329 5b6d 6174 682e 6365 696c  times)[math.ceil
+00016600: 286c 656e 2863 7572 7265 6e74 5f72 6573  (len(current_res
+00016610: 706f 6e73 655f 7469 6d65 7329 202a 2030  ponse_times) * 0
+00016620: 2e39 2920 2d20 315d 2c0a 2020 2020 2020  .9) - 1],.      
+00016630: 2020 2020 2020 2020 2020 2020 2020 292c                ),
+00016640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016650: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00016660: 2020 2020 226d 696e 2072 6561 6420 6279      "min read by
+00016670: 7465 7322 3a20 280a 2020 2020 2020 2020  tes": (.        
+00016680: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00016690: 6174 5f73 697a 6528 6d69 6e28 6375 7272  at_size(min(curr
+000166a0: 656e 745f 7265 6164 5f62 7974 6573 2929  ent_read_bytes))
+000166b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000166c0: 2020 2020 2020 666f 726d 6174 5f73 697a        format_siz
+000166d0: 6528 6d69 6e28 6368 6563 6b65 725f 7265  e(min(checker_re
+000166e0: 6164 5f62 7974 6573 2929 2c0a 2020 2020  ad_bytes)),.    
+000166f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016700: 7365 6c66 2e5f 6465 6c74 615f 7065 7263  self._delta_perc
+00016710: 656e 7461 6765 286d 696e 2863 6865 636b  entage(min(check
+00016720: 6572 5f72 6561 645f 6279 7465 7329 2c20  er_read_bytes), 
+00016730: 6d69 6e28 6375 7272 656e 745f 7265 6164  min(current_read
+00016740: 5f62 7974 6573 2929 2c0a 2020 2020 2020  _bytes)),.      
+00016750: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00016760: 2020 2020 2020 2020 2020 2020 2022 6d61               "ma
+00016770: 7820 7265 6164 2062 7974 6573 223a 2028  x read bytes": (
+00016780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016790: 2020 2020 2066 6f72 6d61 745f 7369 7a65       format_size
+000167a0: 286d 6178 2863 7572 7265 6e74 5f72 6561  (max(current_rea
+000167b0: 645f 6279 7465 7329 292c 0a20 2020 2020  d_bytes)),.     
+000167c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000167d0: 6f72 6d61 745f 7369 7a65 286d 6178 2863  ormat_size(max(c
+000167e0: 6865 636b 6572 5f72 6561 645f 6279 7465  hecker_read_byte
+000167f0: 7329 292c 0a20 2020 2020 2020 2020 2020  s)),.           
+00016800: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
+00016810: 656c 7461 5f70 6572 6365 6e74 6167 6528  elta_percentage(
+00016820: 6d61 7828 6368 6563 6b65 725f 7265 6164  max(checker_read
+00016830: 5f62 7974 6573 292c 206d 6178 2863 7572  _bytes), max(cur
+00016840: 7265 6e74 5f72 6561 645f 6279 7465 7329  rent_read_bytes)
+00016850: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00016860: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00016870: 2020 2020 2020 226d 6561 6e20 7265 6164        "mean read
+00016880: 2062 7974 6573 223a 2028 0a20 2020 2020   bytes": (.     
+00016890: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000168a0: 6f72 6d61 745f 7369 7a65 286d 6561 6e28  ormat_size(mean(
+000168b0: 6375 7272 656e 745f 7265 6164 5f62 7974  current_read_byt
+000168c0: 6573 2929 2c0a 2020 2020 2020 2020 2020  es)),.          
+000168d0: 2020 2020 2020 2020 2020 666f 726d 6174            format
+000168e0: 5f73 697a 6528 6d65 616e 2863 6865 636b  _size(mean(check
+000168f0: 6572 5f72 6561 645f 6279 7465 7329 292c  er_read_bytes)),
+00016900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016910: 2020 2020 2073 656c 662e 5f64 656c 7461       self._delta
+00016920: 5f70 6572 6365 6e74 6167 6528 6d65 616e  _percentage(mean
+00016930: 2863 6865 636b 6572 5f72 6561 645f 6279  (checker_read_by
+00016940: 7465 7329 2c20 6d65 616e 2863 7572 7265  tes), mean(curre
+00016950: 6e74 5f72 6561 645f 6279 7465 7329 292c  nt_read_bytes)),
+00016960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016970: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00016980: 2020 2020 226d 6564 6961 6e20 7265 6164      "median read
+00016990: 2062 7974 6573 223a 2028 0a20 2020 2020   bytes": (.     
+000169a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000169b0: 6f72 6d61 745f 7369 7a65 286d 6564 6961  ormat_size(media
+000169c0: 6e28 6375 7272 656e 745f 7265 6164 5f62  n(current_read_b
+000169d0: 7974 6573 2929 2c0a 2020 2020 2020 2020  ytes)),.        
+000169e0: 2020 2020 2020 2020 2020 2020 666f 726d              form
+000169f0: 6174 5f73 697a 6528 6d65 6469 616e 2863  at_size(median(c
+00016a00: 6865 636b 6572 5f72 6561 645f 6279 7465  hecker_read_byte
+00016a10: 7329 292c 0a20 2020 2020 2020 2020 2020  s)),.           
+00016a20: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
+00016a30: 656c 7461 5f70 6572 6365 6e74 6167 6528  elta_percentage(
+00016a40: 6d65 6469 616e 2863 6865 636b 6572 5f72  median(checker_r
+00016a50: 6561 645f 6279 7465 7329 2c20 6d65 6469  ead_bytes), medi
+00016a60: 616e 2863 7572 7265 6e74 5f72 6561 645f  an(current_read_
+00016a70: 6279 7465 7329 292c 0a20 2020 2020 2020  bytes)),.       
+00016a80: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00016a90: 2020 2020 2020 2020 2020 2020 2270 3930              "p90
+00016aa0: 2072 6561 6420 6279 7465 7322 3a20 280a   read bytes": (.
+00016ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ac0: 2020 2020 666f 726d 6174 5f73 697a 6528      format_size(
+00016ad0: 736f 7274 6564 2863 7572 7265 6e74 5f72  sorted(current_r
+00016ae0: 6561 645f 6279 7465 7329 5b6d 6174 682e  ead_bytes)[math.
+00016af0: 6365 696c 286c 656e 2863 7572 7265 6e74  ceil(len(current
+00016b00: 5f72 6561 645f 6279 7465 7329 202a 2030  _read_bytes) * 0
+00016b10: 2e39 2920 2d20 315d 292c 0a20 2020 2020  .9) - 1]),.     
+00016b20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00016b30: 6f72 6d61 745f 7369 7a65 2873 6f72 7465  ormat_size(sorte
+00016b40: 6428 6368 6563 6b65 725f 7265 6164 5f62  d(checker_read_b
+00016b50: 7974 6573 295b 6d61 7468 2e63 6569 6c28  ytes)[math.ceil(
+00016b60: 6c65 6e28 6368 6563 6b65 725f 7265 6164  len(checker_read
+00016b70: 5f62 7974 6573 2920 2a20 302e 3929 202d  _bytes) * 0.9) -
+00016b80: 2031 5d29 2c0a 2020 2020 2020 2020 2020   1]),.          
+00016b90: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00016ba0: 6465 6c74 615f 7065 7263 656e 7461 6765  delta_percentage
+00016bb0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00016bc0: 2020 2020 2020 2020 2020 736f 7274 6564            sorted
+00016bd0: 2863 6865 636b 6572 5f72 6561 645f 6279  (checker_read_by
+00016be0: 7465 7329 5b6d 6174 682e 6365 696c 286c  tes)[math.ceil(l
+00016bf0: 656e 2863 6865 636b 6572 5f72 6561 645f  en(checker_read_
+00016c00: 6279 7465 7329 202a 2030 2e39 2920 2d20  bytes) * 0.9) - 
+00016c10: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+00016c20: 2020 2020 2020 2020 2020 2020 736f 7274              sort
+00016c30: 6564 2863 7572 7265 6e74 5f72 6561 645f  ed(current_read_
+00016c40: 6279 7465 7329 5b6d 6174 682e 6365 696c  bytes)[math.ceil
+00016c50: 286c 656e 2863 7572 7265 6e74 5f72 6561  (len(current_rea
+00016c60: 645f 6279 7465 7329 202a 2030 2e39 2920  d_bytes) * 0.9) 
+00016c70: 2d20 315d 2c0a 2020 2020 2020 2020 2020  - 1],.          
+00016c80: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00016c90: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+00016ca0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00016cb0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00016cc0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00016cd0: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
+00016ce0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+00016cf0: 2020 206c 6f67 6769 6e67 2e65 7863 6570     logging.excep
+00016d00: 7469 6f6e 2865 290a 0a20 2020 2020 2020  tion(e)..       
+00016d10: 2066 6169 6c75 7265 7320 3d20 5b5d 0a20   failures = []. 
+00016d20: 2020 2020 2020 2069 6620 6e6f 7420 7265         if not re
+00016d30: 7375 6c74 2e77 6173 5375 6363 6573 7366  sult.wasSuccessf
+00016d40: 756c 2829 3a0a 2020 2020 2020 2020 2020  ul():.          
+00016d50: 2020 666f 7220 5f74 6573 742c 2065 7272    for _test, err
+00016d60: 2069 6e20 7265 7375 6c74 2e66 6169 6c75   in result.failu
+00016d70: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+00016d80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00016d90: 2020 2020 2020 2020 2020 2020 2020 6920                i 
+00016da0: 3d20 6572 722e 696e 6465 7828 2241 7373  = err.index("Ass
+00016db0: 6572 7469 6f6e 4572 726f 7222 2920 2b20  ertionError") + 
+00016dc0: 6c65 6e28 2241 7373 6572 7469 6f6e 4572  len("AssertionEr
+00016dd0: 726f 7220 3a22 290a 2020 2020 2020 2020  ror :").        
+00016de0: 2020 2020 2020 2020 2020 2020 6661 696c              fail
+00016df0: 7572 6573 2e61 7070 656e 6428 7b22 6e61  ures.append({"na
+00016e00: 6d65 223a 2073 7472 285f 7465 7374 292c  me": str(_test),
+00016e10: 2022 6572 726f 7222 3a20 6572 725b 693a   "error": err[i:
+00016e20: 5d7d 290a 2020 2020 2020 2020 2020 2020  ]}).            
+00016e30: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00016e40: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00016e50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00016e60: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
+00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e80: 206c 6f67 6769 6e67 2e65 7863 6570 7469   logging.excepti
+00016e90: 6f6e 2865 290a 0a20 2020 2020 2020 2072  on(e)..        r
+00016ea0: 6574 7572 6e20 5069 7065 4368 6563 6b65  eturn PipeChecke
+00016eb0: 7252 756e 6e65 7252 6573 706f 6e73 6528  rRunnerResponse(
+00016ec0: 0a20 2020 2020 2020 2020 2020 2070 6970  .            pip
+00016ed0: 655f 6e61 6d65 3d63 6865 636b 6572 5f70  e_name=checker_p
+00016ee0: 6970 655f 6e61 6d65 2c0a 2020 2020 2020  ipe_name,.      
+00016ef0: 2020 2020 2020 7465 7374 5f74 7970 653d        test_type=
+00016f00: 6765 7461 7474 7228 7365 6c66 2c20 2274  getattr(self, "t
+00016f10: 6573 745f 7479 7065 222c 2022 2229 2c0a  est_type", ""),.
+00016f20: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00016f30: 7574 3d67 6574 6174 7472 2872 6573 756c  ut=getattr(resul
+00016f40: 742e 7374 7265 616d 2c20 225f 6275 6666  t.stream, "_buff
+00016f50: 6572 222c 2022 2229 2c0a 2020 2020 2020  er", ""),.      
+00016f60: 2020 2020 2020 6d65 7472 6963 735f 7375        metrics_su
+00016f70: 6d6d 6172 793d 6d65 7472 6963 735f 7375  mmary=metrics_su
+00016f80: 6d6d 6172 792c 0a20 2020 2020 2020 2020  mmary,.         
+00016f90: 2020 206d 6574 7269 6373 5f74 696d 696e     metrics_timin
+00016fa0: 673d 6d65 7472 6963 735f 7469 6d69 6e67  g=metrics_timing
+00016fb0: 2c0a 2020 2020 2020 2020 2020 2020 6661  ,.            fa
+00016fc0: 696c 6564 3d66 6169 6c75 7265 732c 0a20  iled=failures,. 
+00016fd0: 2020 2020 2020 2020 2020 2077 6173 5f73             was_s
+00016fe0: 7563 6365 7373 6675 6c6c 3d72 6573 756c  uccessfull=resul
+00016ff0: 742e 7761 7353 7563 6365 7373 6675 6c28  t.wasSuccessful(
+00017000: 292c 0a20 2020 2020 2020 2029 0a0a 0a61  ),.        )...a
+00017010: 7379 6e63 2064 6566 2063 6865 636b 5f70  sync def check_p
+00017020: 6970 6528 0a20 2020 2070 6970 652c 0a20  ipe(.    pipe,. 
+00017030: 2020 2068 6f73 743a 2073 7472 2c0a 2020     host: str,.  
+00017040: 2020 746f 6b65 6e3a 2073 7472 2c0a 2020    token: str,.  
+00017050: 2020 706f 7075 6c61 7465 3a20 626f 6f6c    populate: bool
+00017060: 2c0a 2020 2020 636c 3a20 5469 6e79 422c  ,.    cl: TinyB,
+00017070: 0a20 2020 206c 696d 6974 3a20 696e 7420  .    limit: int 
+00017080: 3d20 302c 0a20 2020 2073 616d 706c 655f  = 0,.    sample_
+00017090: 6279 5f70 6172 616d 733a 2069 6e74 203d  by_params: int =
+000170a0: 2030 2c0a 2020 2020 6f6e 6c79 5f72 6573   0,.    only_res
+000170b0: 706f 6e73 655f 7469 6d65 733d 4661 6c73  ponse_times=Fals
+000170c0: 652c 0a20 2020 206d 6174 6368 6573 3a20  e,.    matches: 
+000170d0: 4f70 7469 6f6e 616c 5b4c 6973 745b 7374  Optional[List[st
+000170e0: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
+000170f0: 6661 696c 6661 7374 3a20 626f 6f6c 203d  failfast: bool =
+00017100: 2046 616c 7365 2c0a 2020 2020 7661 6c69   False,.    vali
+00017110: 6461 7465 5f70 726f 6365 7373 6564 5f62  date_processed_b
+00017120: 7974 6573 3a20 626f 6f6c 203d 2046 616c  ytes: bool = Fal
+00017130: 7365 2c0a 2020 2020 6967 6e6f 7265 5f6f  se,.    ignore_o
+00017140: 7264 6572 3a20 626f 6f6c 203d 2046 616c  rder: bool = Fal
+00017150: 7365 2c0a 2020 2020 746f 6b65 6e5f 666f  se,.    token_fo
+00017160: 725f 7265 7175 6573 7473 5f74 6f5f 6368  r_requests_to_ch
+00017170: 6563 6b3a 204f 7074 696f 6e61 6c5b 7374  eck: Optional[st
+00017180: 725d 203d 204e 6f6e 652c 0a20 2020 2063  r] = None,.    c
+00017190: 7572 7265 6e74 5f70 6970 653a 204f 7074  urrent_pipe: Opt
+000171a0: 696f 6e61 6c5b 4469 6374 5b73 7472 2c20  ional[Dict[str, 
+000171b0: 416e 795d 5d20 3d20 4e6f 6e65 2c0a 293a  Any]] = None,.):
+000171c0: 0a20 2020 2063 6865 636b 6572 5f70 6970  .    checker_pip
+000171d0: 6520 3d20 6465 6570 636f 7079 2870 6970  e = deepcopy(pip
+000171e0: 6529 0a20 2020 2063 6865 636b 6572 5f70  e).    checker_p
+000171f0: 6970 655b 226e 616d 6522 5d20 3d20 6622  ipe["name"] = f"
+00017200: 7b63 6865 636b 6572 5f70 6970 655b 276e  {checker_pipe['n
+00017210: 616d 6527 5d7d 5f5f 6368 6563 6b65 7222  ame']}__checker"
+00017220: 0a0a 2020 2020 6966 2063 7572 7265 6e74  ..    if current
+00017230: 5f70 6970 653a 0a20 2020 2020 2020 2070  _pipe:.        p
+00017240: 6970 655f 7479 7065 203d 2063 7572 7265  ipe_type = curre
+00017250: 6e74 5f70 6970 655b 2274 7970 6522 5d0a  nt_pipe["type"].
+00017260: 2020 2020 2020 2020 6966 2070 6970 655f          if pipe_
+00017270: 7479 7065 203d 3d20 5069 7065 5479 7065  type == PipeType
+00017280: 732e 434f 5059 3a0a 2020 2020 2020 2020  s.COPY:.        
+00017290: 2020 2020 6177 6169 7420 636c 2e70 6970      await cl.pip
+000172a0: 655f 7265 6d6f 7665 5f63 6f70 7928 6375  e_remove_copy(cu
+000172b0: 7272 656e 745f 7069 7065 5b22 6964 225d  rrent_pipe["id"]
+000172c0: 2c20 6375 7272 656e 745f 7069 7065 5b22  , current_pipe["
+000172d0: 636f 7079 5f6e 6f64 6522 5d29 0a20 2020  copy_node"]).   
+000172e0: 2020 2020 2069 6620 7069 7065 5f74 7970       if pipe_typ
+000172f0: 6520 3d3d 2050 6970 6554 7970 6573 2e44  e == PipeTypes.D
+00017300: 4154 415f 5349 4e4b 3a0a 2020 2020 2020  ATA_SINK:.      
+00017310: 2020 2020 2020 6177 6169 7420 636c 2e70        await cl.p
+00017320: 6970 655f 7265 6d6f 7665 5f73 696e 6b28  ipe_remove_sink(
+00017330: 6375 7272 656e 745f 7069 7065 5b22 6964  current_pipe["id
+00017340: 225d 2c20 6375 7272 656e 745f 7069 7065  "], current_pipe
+00017350: 5b22 7369 6e6b 5f6e 6f64 6522 5d29 0a0a  ["sink_node"])..
+00017360: 2020 2020 2320 496e 2063 6173 6520 6f66      # In case of
+00017370: 2064 6f69 6e67 202d 2d66 6f72 6365 2066   doing --force f
+00017380: 6f72 2061 206d 6174 6572 6961 6c69 7a65  or a materialize
+00017390: 6420 7669 6577 2c20 6368 6563 6b65 7220  d view, checker 
+000173a0: 6973 2062 6569 6e67 2063 7265 6174 6564  is being created
+000173b0: 2061 7320 7374 616e 6461 7264 2070 6970   as standard pip
+000173c0: 650a 2020 2020 666f 7220 6e6f 6465 2069  e.    for node i
+000173d0: 6e20 6368 6563 6b65 725f 7069 7065 5b22  n checker_pipe["
+000173e0: 6e6f 6465 7322 5d3a 0a20 2020 2020 2020  nodes"]:.       
+000173f0: 206e 6f64 655b 2270 6172 616d 7322 5d5b   node["params"][
+00017400: 2274 7970 6522 5d20 3d20 5069 7065 4e6f  "type"] = PipeNo
+00017410: 6465 5479 7065 732e 5354 414e 4441 5244  deTypes.STANDARD
+00017420: 0a0a 2020 2020 6966 2070 6f70 756c 6174  ..    if populat
+00017430: 653a 0a20 2020 2020 2020 2072 6169 7365  e:.        raise
+00017440: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
+00017450: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+00017460: 6e61 6765 722e 6572 726f 725f 6368 6563  nager.error_chec
+00017470: 6b5f 7069 7065 735f 706f 7075 6c61 7465  k_pipes_populate
+00017480: 2829 290a 0a20 2020 2072 756e 6e65 7220  ())..    runner 
+00017490: 3d20 5069 7065 4368 6563 6b65 7252 756e  = PipeCheckerRun
+000174a0: 6e65 7228 7069 7065 5b22 6e61 6d65 225d  ner(pipe["name"]
+000174b0: 2c20 686f 7374 290a 2020 2020 6865 6164  , host).    head
+000174c0: 6572 7320 3d20 280a 2020 2020 2020 2020  ers = (.        
+000174d0: 7b22 4175 7468 6f72 697a 6174 696f 6e22  {"Authorization"
+000174e0: 3a20 6622 4265 6172 6572 207b 746f 6b65  : f"Bearer {toke
+000174f0: 6e5f 666f 725f 7265 7175 6573 7473 5f74  n_for_requests_t
+00017500: 6f5f 6368 6563 6b7d 227d 0a20 2020 2020  o_check}"}.     
+00017510: 2020 2069 6620 746f 6b65 6e5f 666f 725f     if token_for_
+00017520: 7265 7175 6573 7473 5f74 6f5f 6368 6563  requests_to_chec
+00017530: 6b0a 2020 2020 2020 2020 656c 7365 207b  k.        else {
+00017540: 2241 7574 686f 7269 7a61 7469 6f6e 223a  "Authorization":
+00017550: 2066 2242 6561 7265 7220 7b74 6f6b 656e   f"Bearer {token
+00017560: 7d22 7d0a 2020 2020 290a 0a20 2020 2073  }"}.    )..    s
+00017570: 716c 5f66 6f72 5f63 6f76 6572 6167 652c  ql_for_coverage,
+00017580: 2073 716c 5f6c 6174 6573 745f 7265 7175   sql_latest_requ
+00017590: 6573 7473 203d 2072 756e 6e65 722e 6765  ests = runner.ge
+000175a0: 745f 7371 6c73 5f66 6f72 5f72 6571 7565  t_sqls_for_reque
+000175b0: 7374 735f 746f 5f63 6865 636b 280a 2020  sts_to_check(.  
+000175c0: 2020 2020 2020 6d61 7463 6865 7320 6f72        matches or
+000175d0: 205b 5d2c 2073 616d 706c 655f 6279 5f70   [], sample_by_p
+000175e0: 6172 616d 732c 206c 696d 6974 0a20 2020  arams, limit.   
+000175f0: 2029 0a0a 2020 2020 7061 7261 6d73 203d   )..    params =
+00017600: 207b 2271 223a 2073 716c 5f66 6f72 5f63   {"q": sql_for_c
+00017610: 6f76 6572 6167 6520 6966 206c 696d 6974  overage if limit
+00017620: 203d 3d20 3020 616e 6420 7361 6d70 6c65   == 0 and sample
+00017630: 5f62 795f 7061 7261 6d73 203e 2030 2065  _by_params > 0 e
+00017640: 6c73 6520 7371 6c5f 6c61 7465 7374 5f72  lse sql_latest_r
+00017650: 6571 7565 7374 737d 0a20 2020 2072 3a20  equests}.    r: 
+00017660: 7265 7175 6573 7473 2e52 6573 706f 6e73  requests.Respons
+00017670: 6520 3d20 6177 6169 7420 7265 7175 6573  e = await reques
+00017680: 7473 5f67 6574 280a 2020 2020 2020 2020  ts_get(.        
+00017690: 6622 7b68 6f73 747d 2f76 302f 7371 6c3f  f"{host}/v0/sql?
+000176a0: 7b75 726c 656e 636f 6465 2870 6172 616d  {urlencode(param
+000176b0: 7329 7d22 2c20 6865 6164 6572 733d 6865  s)}", headers=he
+000176c0: 6164 6572 732c 2076 6572 6966 793d 6e6f  aders, verify=no
+000176d0: 7420 6765 7465 6e76 5f62 6f6f 6c28 2254  t getenv_bool("T
+000176e0: 425f 4449 5341 424c 455f 5353 4c5f 4348  B_DISABLE_SSL_CH
+000176f0: 4543 4b53 222c 2046 616c 7365 290a 2020  ECKS", False).  
+00017700: 2020 290a 0a20 2020 2023 2049 6620 7765    )..    # If we
+00017710: 2067 6574 2061 2074 696d 656f 7574 2c20   get a timeout, 
+00017720: 6661 6c6c 6261 636b 2074 6f20 6a75 7374  fallback to just
+00017730: 2074 6865 206c 6173 7420 7265 7175 6573   the last reques
+00017740: 7473 0a0a 2020 2020 6966 206e 6f74 2072  ts..    if not r
+00017750: 206f 7220 722e 7374 6174 7573 5f63 6f64   or r.status_cod
+00017760: 6520 3d3d 2034 3038 3a0a 2020 2020 2020  e == 408:.      
+00017770: 2020 7061 7261 6d73 203d 207b 2271 223a    params = {"q":
+00017780: 2073 716c 5f6c 6174 6573 745f 7265 7175   sql_latest_requ
+00017790: 6573 7473 7d0a 2020 2020 2020 2020 7220  ests}.        r 
+000177a0: 3d20 6177 6169 7420 7265 7175 6573 7473  = await requests
+000177b0: 5f67 6574 280a 2020 2020 2020 2020 2020  _get(.          
+000177c0: 2020 6622 7b68 6f73 747d 2f76 302f 7371    f"{host}/v0/sq
+000177d0: 6c3f 7b75 726c 656e 636f 6465 2870 6172  l?{urlencode(par
+000177e0: 616d 7329 7d22 2c0a 2020 2020 2020 2020  ams)}",.        
+000177f0: 2020 2020 6865 6164 6572 733d 6865 6164      headers=head
+00017800: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+00017810: 2076 6572 6966 793d 6e6f 7420 6765 7465   verify=not gete
+00017820: 6e76 5f62 6f6f 6c28 2254 425f 4449 5341  nv_bool("TB_DISA
+00017830: 424c 455f 5353 4c5f 4348 4543 4b53 222c  BLE_SSL_CHECKS",
+00017840: 2046 616c 7365 292c 0a20 2020 2020 2020   False),.       
+00017850: 2029 0a0a 2020 2020 6966 206e 6f74 2072   )..    if not r
+00017860: 206f 7220 722e 7374 6174 7573 5f63 6f64   or r.status_cod
+00017870: 6520 213d 2032 3030 3a0a 2020 2020 2020  e != 200:.      
+00017880: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+00017890: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
+000178a0: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+000178b0: 6f72 5f63 6865 636b 5f70 6970 6573 5f61  or_check_pipes_a
+000178c0: 7069 2870 6970 653d 7069 7065 5b22 6e61  pi(pipe=pipe["na
+000178d0: 6d65 225d 2929 0a0a 2020 2020 7069 7065  me"]))..    pipe
+000178e0: 5f72 6571 7565 7374 735f 746f 5f63 6865  _requests_to_che
+000178f0: 636b 3a20 4c69 7374 5b44 6963 745b 7374  ck: List[Dict[st
+00017900: 722c 2041 6e79 5d5d 203d 205b 5d0a 2020  r, Any]] = [].  
+00017910: 2020 666f 7220 726f 7720 696e 2072 2e6a    for row in r.j
+00017920: 736f 6e28 292e 6765 7428 2264 6174 6122  son().get("data"
+00017930: 2c20 5b5d 293a 0a20 2020 2020 2020 2066  , []):.        f
+00017940: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+00017950: 6e28 726f 775b 2265 6e64 706f 696e 745f  n(row["endpoint_
+00017960: 7572 6c22 5d29 293a 0a20 2020 2020 2020  url"])):.       
+00017970: 2020 2020 2070 6970 655f 7265 7175 6573       pipe_reques
+00017980: 7473 5f74 6f5f 6368 6563 6b20 2b3d 205b  ts_to_check += [
+00017990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000179a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000179b0: 2020 2020 2020 2022 656e 6470 6f69 6e74         "endpoint
+000179c0: 5f75 726c 223a 2066 227b 686f 7374 7d7b  _url": f"{host}{
+000179d0: 726f 775b 2765 6e64 706f 696e 745f 7572  row['endpoint_ur
+000179e0: 6c27 5d5b 695d 7d22 2c0a 2020 2020 2020  l'][i]}",.      
+000179f0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+00017a00: 6970 655f 7265 7175 6573 745f 7061 7261  ipe_request_para
+00017a10: 6d73 223a 2072 6f77 5b22 7069 7065 5f72  ms": row["pipe_r
+00017a20: 6571 7565 7374 5f70 6172 616d 7322 5d5b  equest_params"][
+00017a30: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
+00017a40: 2020 2020 2020 2020 2268 7474 705f 6d65          "http_me
+00017a50: 7468 6f64 223a 2072 6f77 5b22 6874 7470  thod": row["http
+00017a60: 5f6d 6574 686f 6422 5d2c 0a20 2020 2020  _method"],.     
+00017a70: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00017a80: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
+00017a90: 6966 206e 6f74 2070 6970 655f 7265 7175  if not pipe_requ
+00017aa0: 6573 7473 5f74 6f5f 6368 6563 6b3a 0a20  ests_to_check:. 
+00017ab0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00017ac0: 2020 2061 7761 6974 206e 6577 5f70 6970     await new_pip
+00017ad0: 6528 6368 6563 6b65 725f 7069 7065 2c20  e(checker_pipe, 
+00017ae0: 636c 2c20 666f 7263 653d 5472 7565 2c20  cl, force=True, 
+00017af0: 6368 6563 6b3d 4661 6c73 652c 2070 6f70  check=False, pop
+00017b00: 756c 6174 653d 706f 7075 6c61 7465 290a  ulate=populate).
+00017b10: 0a20 2020 2072 756e 6e65 725f 7265 7370  .    runner_resp
+00017b20: 6f6e 7365 203d 2072 756e 6e65 722e 7275  onse = runner.ru
+00017b30: 6e5f 7069 7065 5f63 6865 636b 6572 280a  n_pipe_checker(.
+00017b40: 2020 2020 2020 2020 7069 7065 5f72 6571          pipe_req
+00017b50: 7565 7374 735f 746f 5f63 6865 636b 2c0a  uests_to_check,.
+00017b60: 2020 2020 2020 2020 6368 6563 6b65 725f          checker_
+00017b70: 7069 7065 5b22 6e61 6d65 225d 2c0a 2020  pipe["name"],.  
+00017b80: 2020 2020 2020 746f 6b65 6e2c 0a20 2020        token,.   
+00017b90: 2020 2020 206f 6e6c 795f 7265 7370 6f6e       only_respon
+00017ba0: 7365 5f74 696d 6573 2c0a 2020 2020 2020  se_times,.      
+00017bb0: 2020 6967 6e6f 7265 5f6f 7264 6572 2c0a    ignore_order,.
+00017bc0: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+00017bd0: 5f70 726f 6365 7373 6564 5f62 7974 6573  _processed_bytes
+00017be0: 2c0a 2020 2020 2020 2020 6661 696c 6661  ,.        failfa
+00017bf0: 7374 2c0a 2020 2020 290a 0a20 2020 2074  st,.    )..    t
+00017c00: 7279 3a0a 2020 2020 2020 2020 6966 2072  ry:.        if r
+00017c10: 756e 6e65 725f 7265 7370 6f6e 7365 2e6d  unner_response.m
+00017c20: 6574 7269 6373 5f73 756d 6d61 7279 2061  etrics_summary a
+00017c30: 6e64 2072 756e 6e65 725f 7265 7370 6f6e  nd runner_respon
+00017c40: 7365 2e6d 6574 7269 6373 5f74 696d 696e  se.metrics_timin
+00017c50: 673a 0a20 2020 2020 2020 2020 2020 2063  g:.            c
+00017c60: 6f6c 756d 6e5f 6e61 6d65 735f 7465 7374  olumn_names_test
+00017c70: 7320 3d20 5b22 5465 7374 2052 756e 222c  s = ["Test Run",
+00017c80: 2022 5465 7374 2050 6173 7365 6422 2c20   "Test Passed", 
+00017c90: 2254 6573 7420 4661 696c 6564 222c 2022  "Test Failed", "
+00017ca0: 2520 5465 7374 2050 6173 7365 6422 2c20  % Test Passed", 
+00017cb0: 2225 2054 6573 7420 4661 696c 6564 225d  "% Test Failed"]
+00017cc0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00017cd0: 636b 2e65 6368 6f28 225c 6e3d 3d3d 3d20  ck.echo("\n==== 
+00017ce0: 5465 7374 204d 6574 7269 6373 203d 3d3d  Test Metrics ===
+00017cf0: 3d5c 6e22 290a 2020 2020 2020 2020 2020  =\n").          
+00017d00: 2020 636c 6963 6b2e 6563 686f 280a 2020    click.echo(.  
+00017d10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00017d20: 726d 6174 5f70 7265 7474 795f 7461 626c  rmat_pretty_tabl
+00017d30: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00017d40: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
 00017d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d60: 2020 2020 2020 2072 756e 6e65 725f 7265         runner_re
-00017d70: 7370 6f6e 7365 2e6d 6574 7269 6373 5f73  sponse.metrics_s
-00017d80: 756d 6d61 7279 5b22 7065 7263 656e 7461  ummary["percenta
-00017d90: 6765 5f66 6169 6c65 6422 5d2c 0a20 2020  ge_failed"],.   
-00017da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017db0: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-00017dc0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-00017dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017de0: 2020 636f 6c75 6d6e 5f6e 616d 6573 3d63    column_names=c
-00017df0: 6f6c 756d 6e5f 6e61 6d65 735f 7465 7374  olumn_names_test
-00017e00: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00017e10: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00017e20: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00017e30: 636f 6c75 6d6e 5f6e 616d 6573 5f74 696d  column_names_tim
-00017e40: 696e 6720 3d20 5b22 5469 6d69 6e67 204d  ing = ["Timing M
-00017e50: 6574 7269 6320 2873 2922 2c20 2243 7572  etric (s)", "Cur
-00017e60: 7265 6e74 222c 2022 4e65 7722 5d0a 2020  rent", "New"].  
-00017e70: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-00017e80: 6563 686f 2822 5c6e 3d3d 3d3d 2052 6573  echo("\n==== Res
-00017e90: 706f 6e73 6520 5469 6d65 204d 6574 7269  ponse Time Metri
-00017ea0: 6373 203d 3d3d 3d5c 6e22 290a 2020 2020  cs ====\n").    
-00017eb0: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-00017ec0: 686f 280a 2020 2020 2020 2020 2020 2020  ho(.            
-00017ed0: 2020 2020 666f 726d 6174 5f70 7265 7474      format_prett
-00017ee0: 795f 7461 626c 6528 0a20 2020 2020 2020  y_table(.       
-00017ef0: 2020 2020 2020 2020 2020 2020 205b 0a20               [. 
-00017f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f10: 2020 2020 2020 205b 6d65 7472 6963 2c20         [metric, 
-00017f20: 7275 6e6e 6572 5f72 6573 706f 6e73 652e  runner_response.
-00017f30: 6d65 7472 6963 735f 7469 6d69 6e67 5b6d  metrics_timing[m
-00017f40: 6574 7269 635d 5b30 5d2c 2072 756e 6e65  etric][0], runne
-00017f50: 725f 7265 7370 6f6e 7365 2e6d 6574 7269  r_response.metri
-00017f60: 6373 5f74 696d 696e 675b 6d65 7472 6963  cs_timing[metric
-00017f70: 5d5b 315d 5d0a 2020 2020 2020 2020 2020  ][1]].          
-00017f80: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00017f90: 7220 6d65 7472 6963 2069 6e20 5b0a 2020  r metric in [.  
-00017fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fb0: 2020 2020 2020 2020 2020 226d 696e 2072            "min r
-00017fc0: 6573 706f 6e73 6520 7469 6d65 222c 0a20  esponse time",. 
-00017fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fe0: 2020 2020 2020 2020 2020 2022 6d61 7820             "max 
-00017ff0: 7265 7370 6f6e 7365 2074 696d 6522 2c0a  response time",.
+00017d60: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00017d70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00017d80: 756e 6e65 725f 7265 7370 6f6e 7365 2e6d  unner_response.m
+00017d90: 6574 7269 6373 5f73 756d 6d61 7279 5b22  etrics_summary["
+00017da0: 7275 6e22 5d2c 0a20 2020 2020 2020 2020  run"],.         
+00017db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017dc0: 2020 2072 756e 6e65 725f 7265 7370 6f6e     runner_respon
+00017dd0: 7365 2e6d 6574 7269 6373 5f73 756d 6d61  se.metrics_summa
+00017de0: 7279 5b22 7061 7373 6564 225d 2c0a 2020  ry["passed"],.  
+00017df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e00: 2020 2020 2020 2020 2020 7275 6e6e 6572            runner
+00017e10: 5f72 6573 706f 6e73 652e 6d65 7472 6963  _response.metric
+00017e20: 735f 7375 6d6d 6172 795b 2266 6169 6c65  s_summary["faile
+00017e30: 6422 5d2c 0a20 2020 2020 2020 2020 2020  d"],.           
+00017e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e50: 2072 756e 6e65 725f 7265 7370 6f6e 7365   runner_response
+00017e60: 2e6d 6574 7269 6373 5f73 756d 6d61 7279  .metrics_summary
+00017e70: 5b22 7065 7263 656e 7461 6765 5f70 6173  ["percentage_pas
+00017e80: 7365 6422 5d2c 0a20 2020 2020 2020 2020  sed"],.         
+00017e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ea0: 2020 2072 756e 6e65 725f 7265 7370 6f6e     runner_respon
+00017eb0: 7365 2e6d 6574 7269 6373 5f73 756d 6d61  se.metrics_summa
+00017ec0: 7279 5b22 7065 7263 656e 7461 6765 5f66  ry["percentage_f
+00017ed0: 6169 6c65 6422 5d2c 0a20 2020 2020 2020  ailed"],.       
+00017ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ef0: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
+00017f00: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00017f10: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00017f20: 6c75 6d6e 5f6e 616d 6573 3d63 6f6c 756d  lumn_names=colum
+00017f30: 6e5f 6e61 6d65 735f 7465 7374 732c 0a20  n_names_tests,. 
+00017f40: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00017f50: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00017f60: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+00017f70: 6d6e 5f6e 616d 6573 5f74 696d 696e 6720  mn_names_timing 
+00017f80: 3d20 5b22 5469 6d69 6e67 204d 6574 7269  = ["Timing Metri
+00017f90: 6320 2873 2922 2c20 2243 7572 7265 6e74  c (s)", "Current
+00017fa0: 222c 2022 4e65 7722 5d0a 2020 2020 2020  ", "New"].      
+00017fb0: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
+00017fc0: 2822 5c6e 3d3d 3d3d 2052 6573 706f 6e73  ("\n==== Respons
+00017fd0: 6520 5469 6d65 204d 6574 7269 6373 203d  e Time Metrics =
+00017fe0: 3d3d 3d5c 6e22 290a 2020 2020 2020 2020  ===\n").        
+00017ff0: 2020 2020 636c 6963 6b2e 6563 686f 280a      click.echo(.
 00018000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018010: 2020 2020 2020 2020 2020 2020 226d 6561              "mea
-00018020: 6e20 7265 7370 6f6e 7365 2074 696d 6522  n response time"
-00018030: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018040: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00018050: 6564 6961 6e20 7265 7370 6f6e 7365 2074  edian response t
-00018060: 696d 6522 2c0a 2020 2020 2020 2020 2020  ime",.          
-00018070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018080: 2020 2270 3930 2072 6573 706f 6e73 6520    "p90 response 
-00018090: 7469 6d65 222c 0a20 2020 2020 2020 2020  time",.         
-000180a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000180b0: 2020 2022 6d69 6e20 7265 6164 2062 7974     "min read byt
-000180c0: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
-000180d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000180e0: 2022 6d61 7820 7265 6164 2062 7974 6573   "max read bytes
-000180f0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00018100: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00018110: 6d65 616e 2072 6561 6420 6279 7465 7322  mean read bytes"
-00018120: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018130: 2020 2020 2020 2020 2020 2020 2020 226d                "m
-00018140: 6564 6961 6e20 7265 6164 2062 7974 6573  edian read bytes
-00018150: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00018160: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00018170: 7039 3020 7265 6164 2062 7974 6573 222c  p90 read bytes",
-00018180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018190: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
-000181a0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-000181b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000181c0: 2020 2020 2020 636f 6c75 6d6e 5f6e 616d        column_nam
-000181d0: 6573 3d63 6f6c 756d 6e5f 6e61 6d65 735f  es=column_names_
-000181e0: 7469 6d69 6e67 2c0a 2020 2020 2020 2020  timing,.        
-000181f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00018200: 2020 2020 2020 290a 2020 2020 6578 6365        ).    exce
-00018210: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
-00018220: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00018230: 6966 206e 6f74 2072 756e 6e65 725f 7265  if not runner_re
-00018240: 7370 6f6e 7365 2e77 6173 5f73 7563 6365  sponse.was_succe
-00018250: 7373 6675 6c6c 3a0a 2020 2020 2020 2020  ssfull:.        
-00018260: 666f 7220 6661 696c 7572 6520 696e 2072  for failure in r
-00018270: 756e 6e65 725f 7265 7370 6f6e 7365 2e66  unner_response.f
-00018280: 6169 6c65 643a 0a20 2020 2020 2020 2020  ailed:.         
-00018290: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000182a0: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-000182b0: 686f 2822 3d3d 3d3d 2054 6573 7420 4641  ho("==== Test FA
-000182c0: 494c 4544 203d 3d3d 3d5c 6e22 290a 2020  ILED ====\n").  
-000182d0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-000182e0: 6963 6b2e 6563 686f 2866 6169 6c75 7265  ick.echo(failure
-000182f0: 5b22 6e61 6d65 225d 290a 2020 2020 2020  ["name"]).      
-00018300: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-00018310: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
-00018320: 6167 6572 2e65 7272 6f72 5f63 6865 636b  ager.error_check
-00018330: 5f70 6970 6528 6572 726f 723d 6661 696c  _pipe(error=fail
-00018340: 7572 655b 2265 7272 6f72 225d 2929 0a20  ure["error"])). 
-00018350: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00018360: 6c69 636b 2e65 6368 6f28 223d 3d3d 3d3d  lick.echo("=====
-00018370: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018380: 5c6e 5c6e 5c6e 2229 0a20 2020 2020 2020  \n\n\n").       
-00018390: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-000183a0: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-000183b0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-000183c0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-000183d0: 6545 7272 6f72 2822 496e 7661 6c69 6420  eError("Invalid 
-000183e0: 7265 7375 6c74 732c 2079 6f75 2063 616e  results, you can
-000183f0: 2062 7970 6173 7320 6368 6563 6b73 2062   bypass checks b
-00018400: 7920 7275 6e6e 696e 6720 7075 7368 2077  y running push w
-00018410: 6974 6820 7468 6520 2d2d 6e6f 2d63 6865  ith the --no-che
-00018420: 636b 2066 6c61 6722 290a 0a20 2020 2023  ck flag")..    #
-00018430: 204f 6e6c 7920 6465 6c65 7465 2069 6620   Only delete if 
-00018440: 6e6f 2065 7272 6f72 732c 2073 6f20 7765  no errors, so we
-00018450: 2063 616e 2063 6865 636b 2072 6573 756c   can check resul
-00018460: 7473 2061 6674 6572 2066 6169 6c75 7265  ts after failure
-00018470: 0a20 2020 2068 6561 6465 7273 203d 207b  .    headers = {
-00018480: 2241 7574 686f 7269 7a61 7469 6f6e 223a  "Authorization":
-00018490: 2066 2242 6561 7265 7220 7b74 6f6b 656e   f"Bearer {token
-000184a0: 7d22 7d0a 2020 2020 7220 3d20 6177 6169  }"}.    r = awai
-000184b0: 7420 7265 7175 6573 7473 5f64 656c 6574  t requests_delet
-000184c0: 6528 6622 7b68 6f73 747d 2f76 302f 7069  e(f"{host}/v0/pi
-000184d0: 7065 732f 7b63 6865 636b 6572 5f70 6970  pes/{checker_pip
-000184e0: 655b 276e 616d 6527 5d7d 222c 2068 6561  e['name']}", hea
-000184f0: 6465 7273 3d68 6561 6465 7273 290a 2020  ders=headers).  
-00018500: 2020 6966 2072 2e73 7461 7475 735f 636f    if r.status_co
-00018510: 6465 2021 3d20 3230 343a 0a20 2020 2020  de != 204:.     
-00018520: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
-00018530: 6564 6261 636b 4d61 6e61 6765 722e 7761  edbackManager.wa
-00018540: 726e 696e 675f 6368 6563 6b5f 7069 7065  rning_check_pipe
-00018550: 2863 6f6e 7465 6e74 3d72 2e63 6f6e 7465  (content=r.conte
-00018560: 6e74 2929 0a0a 0a61 7379 6e63 2064 6566  nt))...async def
-00018570: 2063 6865 636b 5f6d 6174 6572 6961 6c69   check_materiali
-00018580: 7a65 6428 7069 7065 2c20 686f 7374 2c20  zed(pipe, host, 
-00018590: 746f 6b65 6e2c 2063 6c2c 206f 7665 7272  token, cl, overr
-000185a0: 6964 655f 6461 7461 736f 7572 6365 3d46  ide_datasource=F
-000185b0: 616c 7365 2c20 6375 7272 656e 745f 7069  alse, current_pi
-000185c0: 7065 3d4e 6f6e 6529 3a0a 2020 2020 6368  pe=None):.    ch
-000185d0: 6563 6b65 725f 7069 7065 203d 2064 6565  ecker_pipe = dee
-000185e0: 7063 6f70 7928 7069 7065 290a 2020 2020  pcopy(pipe).    
-000185f0: 6368 6563 6b65 725f 7069 7065 5b22 6e61  checker_pipe["na
-00018600: 6d65 225d 203d 2066 227b 6368 6563 6b65  me"] = f"{checke
-00018610: 725f 7069 7065 5b27 6e61 6d65 275d 7d5f  r_pipe['name']}_
-00018620: 5f63 6865 636b 6572 220a 2020 2020 6865  _checker".    he
-00018630: 6164 6572 7320 3d20 7b22 4175 7468 6f72  aders = {"Author
-00018640: 697a 6174 696f 6e22 3a20 6622 4265 6172  ization": f"Bear
-00018650: 6572 207b 746f 6b65 6e7d 227d 0a0a 2020  er {token}"}..  
-00018660: 2020 6966 2063 7572 7265 6e74 5f70 6970    if current_pip
-00018670: 653a 0a20 2020 2020 2020 2066 726f 6d5f  e:.        from_
-00018680: 636f 7079 5f74 6f5f 6d61 7465 7269 616c  copy_to_material
-00018690: 697a 6564 203d 2063 7572 7265 6e74 5f70  ized = current_p
-000186a0: 6970 655b 2274 7970 6522 5d20 3d3d 2022  ipe["type"] == "
-000186b0: 636f 7079 220a 2020 2020 2020 2020 6966  copy".        if
-000186c0: 2066 726f 6d5f 636f 7079 5f74 6f5f 6d61   from_copy_to_ma
-000186d0: 7465 7269 616c 697a 6564 3a0a 2020 2020  terialized:.    
-000186e0: 2020 2020 2020 2020 6177 6169 7420 636c          await cl
-000186f0: 2e70 6970 655f 7265 6d6f 7665 5f63 6f70  .pipe_remove_cop
-00018700: 7928 6375 7272 656e 745f 7069 7065 5b22  y(current_pipe["
-00018710: 6964 225d 2c20 6375 7272 656e 745f 7069  id"], current_pi
-00018720: 7065 5b22 636f 7079 5f6e 6f64 6522 5d29  pe["copy_node"])
-00018730: 0a0a 2020 2020 6d61 7465 7269 616c 697a  ..    materializ
-00018740: 6564 5f6e 6f64 6520 3d20 4e6f 6e65 0a20  ed_node = None. 
-00018750: 2020 2066 6f72 206e 6f64 6520 696e 2063     for node in c
-00018760: 6865 636b 6572 5f70 6970 655b 226e 6f64  hecker_pipe["nod
-00018770: 6573 225d 3a0a 2020 2020 2020 2020 6966  es"]:.        if
-00018780: 206e 6f64 655b 2270 6172 616d 7322 5d5b   node["params"][
-00018790: 2274 7970 6522 5d20 3d3d 2022 6d61 7465  "type"] == "mate
-000187a0: 7269 616c 697a 6564 223a 0a20 2020 2020  rialized":.     
-000187b0: 2020 2020 2020 206d 6174 6572 6961 6c69         materiali
-000187c0: 7a65 645f 6e6f 6465 203d 2064 6565 7063  zed_node = deepc
-000187d0: 6f70 7928 6e6f 6465 290a 2020 2020 2020  opy(node).      
-000187e0: 2020 2020 2020 6d61 7465 7269 616c 697a        materializ
-000187f0: 6564 5f6e 6f64 655b 2270 6172 616d 7322  ed_node["params"
-00018800: 5d5b 226f 7665 7272 6964 655f 6461 7461  ]["override_data
-00018810: 736f 7572 6365 225d 203d 2022 7472 7565  source"] = "true
-00018820: 2220 6966 206f 7665 7272 6964 655f 6461  " if override_da
-00018830: 7461 736f 7572 6365 2065 6c73 6520 2266  tasource else "f
-00018840: 616c 7365 220a 2020 2020 2020 2020 6e6f  alse".        no
-00018850: 6465 5b22 7061 7261 6d73 225d 5b22 7479  de["params"]["ty
-00018860: 7065 225d 203d 2022 7374 616e 6461 7264  pe"] = "standard
-00018870: 220a 0a20 2020 2074 7279 3a0a 2020 2020  "..    try:.    
-00018880: 2020 2020 7069 7065 5f63 7265 6174 6564      pipe_created
-00018890: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-000188a0: 2061 7761 6974 206e 6577 5f70 6970 6528   await new_pipe(
-000188b0: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
-000188c0: 636b 6572 5f70 6970 652c 2063 6c2c 2066  cker_pipe, cl, f
-000188d0: 6f72 6365 3d54 7275 652c 2063 6865 636b  orce=True, check
-000188e0: 3d46 616c 7365 2c20 706f 7075 6c61 7465  =False, populate
-000188f0: 3d46 616c 7365 2c20 736b 6970 5f74 6f6b  =False, skip_tok
-00018900: 656e 733d 5472 7565 2c20 6967 6e6f 7265  ens=True, ignore
-00018910: 5f73 716c 5f65 7272 6f72 733d 4661 6c73  _sql_errors=Fals
-00018920: 650a 2020 2020 2020 2020 290a 2020 2020  e.        ).    
-00018930: 2020 2020 7069 7065 5f63 7265 6174 6564      pipe_created
-00018940: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00018950: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-00018960: 2063 6c2e 616e 616c 797a 655f 7069 7065   cl.analyze_pipe
-00018970: 5f6e 6f64 6528 6368 6563 6b65 725f 7069  _node(checker_pi
-00018980: 7065 5b22 6e61 6d65 225d 2c20 6d61 7465  pe["name"], mate
-00018990: 7269 616c 697a 6564 5f6e 6f64 652c 2064  rialized_node, d
-000189a0: 7279 5f72 756e 3d22 7472 7565 2229 0a20  ry_run="true"). 
-000189b0: 2020 2020 2020 2069 6620 7265 7370 6f6e         if respon
-000189c0: 7365 2e67 6574 2822 7761 726e 696e 6773  se.get("warnings
-000189d0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-000189e0: 7368 6f77 5f6d 6174 6572 6961 6c69 7a65  show_materialize
-000189f0: 645f 7669 6577 5f77 6172 6e69 6e67 7328  d_view_warnings(
-00018a00: 7265 7370 6f6e 7365 5b22 7761 726e 696e  response["warnin
-00018a10: 6773 225d 290a 0a20 2020 2065 7863 6570  gs"])..    excep
-00018a20: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
-00018a30: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00018a40: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
-00018a50: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
-00018a60: 6167 6572 2e65 7272 6f72 5f77 6869 6c65  ager.error_while
-00018a70: 5f63 6865 636b 5f6d 6174 6572 6961 6c69  _check_materiali
-00018a80: 7a65 6428 6572 726f 723d 7374 7228 6529  zed(error=str(e)
-00018a90: 2929 0a20 2020 2066 696e 616c 6c79 3a0a  )).    finally:.
-00018aa0: 2020 2020 2020 2020 6966 2070 6970 655f          if pipe_
-00018ab0: 6372 6561 7465 643a 0a20 2020 2020 2020  created:.       
-00018ac0: 2020 2020 2072 203d 2061 7761 6974 2072       r = await r
-00018ad0: 6571 7565 7374 735f 6465 6c65 7465 2866  equests_delete(f
-00018ae0: 227b 686f 7374 7d2f 7630 2f70 6970 6573  "{host}/v0/pipes
-00018af0: 2f7b 6368 6563 6b65 725f 7069 7065 5b27  /{checker_pipe['
-00018b00: 6e61 6d65 275d 7d22 2c20 6865 6164 6572  name']}", header
-00018b10: 733d 6865 6164 6572 7329 0a20 2020 2020  s=headers).     
-00018b20: 2020 2020 2020 2069 6620 722e 7374 6174         if r.stat
-00018b30: 7573 5f63 6f64 6520 213d 2032 3034 3a0a  us_code != 204:.
-00018b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b50: 636c 6963 6b2e 6563 686f 2846 6565 6462  click.echo(Feedb
-00018b60: 6163 6b4d 616e 6167 6572 2e77 6172 6e69  ackManager.warni
-00018b70: 6e67 5f63 6865 636b 5f70 6970 6528 636f  ng_check_pipe(co
-00018b80: 6e74 656e 743d 722e 636f 6e74 656e 7429  ntent=r.content)
-00018b90: 290a 0a0a 6173 796e 6320 6465 6620 6368  )...async def ch
-00018ba0: 6563 6b5f 636f 7079 5f70 6970 6528 7069  eck_copy_pipe(pi
-00018bb0: 7065 2c20 636f 7079 5f6e 6f64 652c 2074  pe, copy_node, t
-00018bc0: 625f 636c 6965 6e74 3a20 5469 6e79 4229  b_client: TinyB)
-00018bd0: 3a0a 2020 2020 7461 7267 6574 5f64 6174  :.    target_dat
-00018be0: 6173 6f75 7263 6520 3d20 636f 7079 5f6e  asource = copy_n
-00018bf0: 6f64 655b 2270 6172 616d 7322 5d2e 6765  ode["params"].ge
-00018c00: 7428 2274 6172 6765 745f 6461 7461 736f  t("target_dataso
-00018c10: 7572 6365 222c 204e 6f6e 6529 0a20 2020  urce", None).   
-00018c20: 2069 6620 6e6f 7420 7461 7267 6574 5f64   if not target_d
-00018c30: 6174 6173 6f75 7263 653a 0a20 2020 2020  atasource:.     
-00018c40: 2020 2072 6169 7365 2043 4c49 5069 7065     raise CLIPipe
-00018c50: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
-00018c60: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-00018c70: 6372 6561 7469 6e67 5f63 6f70 795f 7069  creating_copy_pi
-00018c80: 7065 5f74 6172 6765 745f 6461 7461 736f  pe_target_dataso
-00018c90: 7572 6365 5f72 6571 7569 7265 6428 2929  urce_required())
-00018ca0: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
-00018cb0: 2020 2061 7761 6974 2074 625f 636c 6965     await tb_clie
-00018cc0: 6e74 2e67 6574 5f64 6174 6173 6f75 7263  nt.get_datasourc
-00018cd0: 6528 7461 7267 6574 5f64 6174 6173 6f75  e(target_datasou
-00018ce0: 7263 6529 0a20 2020 2065 7863 6570 7420  rce).    except 
-00018cf0: 446f 6573 4e6f 7445 7869 7374 4578 6365  DoesNotExistExce
-00018d00: 7074 696f 6e3a 0a20 2020 2020 2020 2072  ption:.        r
-00018d10: 6169 7365 2043 4c49 5069 7065 4578 6365  aise CLIPipeExce
-00018d20: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
-00018d30: 2020 2046 6565 6462 6163 6b4d 616e 6167     FeedbackManag
-00018d40: 6572 2e65 7272 6f72 5f63 7265 6174 696e  er.error_creatin
-00018d50: 675f 636f 7079 5f70 6970 655f 7461 7267  g_copy_pipe_targ
-00018d60: 6574 5f64 6174 6173 6f75 7263 655f 6e6f  et_datasource_no
-00018d70: 745f 666f 756e 6428 7461 7267 6574 5f64  t_found(target_d
-00018d80: 6174 6173 6f75 7263 653d 7461 7267 6574  atasource=target
-00018d90: 5f64 6174 6173 6f75 7263 6529 0a20 2020  _datasource).   
-00018da0: 2020 2020 2029 0a20 2020 2065 7863 6570       ).    excep
-00018db0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
-00018dc0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00018dd0: 434c 4950 6970 6545 7863 6570 7469 6f6e  CLIPipeException
-00018de0: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-00018df0: 2e65 7272 6f72 5f65 7863 6570 7469 6f6e  .error_exception
-00018e00: 2865 7272 6f72 3d65 2929 0a0a 2020 2020  (error=e))..    
-00018e10: 7363 6865 6475 6c65 5f63 726f 6e20 3d20  schedule_cron = 
-00018e20: 636f 7079 5f6e 6f64 655b 2270 6172 616d  copy_node["param
-00018e30: 7322 5d2e 6765 7428 436f 7079 5061 7261  s"].get(CopyPara
-00018e40: 6d65 7465 7273 2e43 4f50 595f 5343 4845  meters.COPY_SCHE
-00018e50: 4455 4c45 2c20 4e6f 6e65 290a 2020 2020  DULE, None).    
-00018e60: 6973 5f76 616c 6964 5f63 726f 6e20 3d20  is_valid_cron = 
-00018e70: 6e6f 7420 7363 6865 6475 6c65 5f63 726f  not schedule_cro
-00018e80: 6e20 6f72 2028 0a20 2020 2020 2020 2073  n or (.        s
-00018e90: 6368 6564 756c 655f 6372 6f6e 2061 6e64  chedule_cron and
-00018ea0: 2028 7363 6865 6475 6c65 5f63 726f 6e20   (schedule_cron 
-00018eb0: 3d3d 204f 4e5f 4445 4d41 4e44 206f 7220  == ON_DEMAND or 
-00018ec0: 6372 6f6e 6974 6572 2e69 735f 7661 6c69  croniter.is_vali
-00018ed0: 6428 7363 6865 6475 6c65 5f63 726f 6e29  d(schedule_cron)
-00018ee0: 290a 2020 2020 290a 0a20 2020 2069 6620  ).    )..    if 
-00018ef0: 6e6f 7420 6973 5f76 616c 6964 5f63 726f  not is_valid_cro
-00018f00: 6e3a 0a20 2020 2020 2020 2072 6169 7365  n:.        raise
-00018f10: 2043 4c49 5069 7065 4578 6365 7074 696f   CLIPipeExceptio
-00018f20: 6e28 4665 6564 6261 636b 4d61 6e61 6765  n(FeedbackManage
-00018f30: 722e 6572 726f 725f 6372 6561 7469 6e67  r.error_creating
-00018f40: 5f63 6f70 795f 7069 7065 5f69 6e76 616c  _copy_pipe_inval
-00018f50: 6964 5f63 726f 6e28 7363 6865 6475 6c65  id_cron(schedule
-00018f60: 5f63 726f 6e3d 7363 6865 6475 6c65 5f63  _cron=schedule_c
-00018f70: 726f 6e29 290a 0a20 2020 2069 6620 6e6f  ron))..    if no
-00018f80: 7420 7069 7065 3a0a 2020 2020 2020 2020  t pipe:.        
-00018f90: 7265 7475 726e 0a0a 2020 2020 7069 7065  return..    pipe
-00018fa0: 5f6e 616d 6520 3d20 7069 7065 5b22 6e61  _name = pipe["na
-00018fb0: 6d65 225d 0a20 2020 2070 6970 655f 7479  me"].    pipe_ty
-00018fc0: 7065 203d 2070 6970 655b 2274 7970 6522  pe = pipe["type"
-00018fd0: 5d0a 0a20 2020 2069 6620 7069 7065 5f74  ]..    if pipe_t
-00018fe0: 7970 6520 3d3d 2050 6970 6554 7970 6573  ype == PipeTypes
-00018ff0: 2e45 4e44 504f 494e 543a 0a20 2020 2020  .ENDPOINT:.     
-00019000: 2020 2061 7761 6974 2074 625f 636c 6965     await tb_clie
-00019010: 6e74 2e70 6970 655f 7265 6d6f 7665 5f65  nt.pipe_remove_e
-00019020: 6e64 706f 696e 7428 7069 7065 5f6e 616d  ndpoint(pipe_nam
-00019030: 652c 2070 6970 655b 2265 6e64 706f 696e  e, pipe["endpoin
-00019040: 7422 5d29 0a0a 2020 2020 6966 2070 6970  t"])..    if pip
-00019050: 655f 7479 7065 203d 3d20 5069 7065 5479  e_type == PipeTy
-00019060: 7065 732e 4441 5441 5f53 494e 4b3a 0a20  pes.DATA_SINK:. 
-00019070: 2020 2020 2020 2061 7761 6974 2074 625f         await tb_
-00019080: 636c 6965 6e74 2e70 6970 655f 7265 6d6f  client.pipe_remo
-00019090: 7665 5f73 696e 6b28 7069 7065 5f6e 616d  ve_sink(pipe_nam
-000190a0: 652c 2070 6970 655b 2273 696e 6b5f 6e6f  e, pipe["sink_no
-000190b0: 6465 225d 290a 0a0a 6173 796e 6320 6465  de"])...async de
-000190c0: 6620 6368 6563 6b5f 7369 6e6b 5f70 6970  f check_sink_pip
-000190d0: 6528 7069 7065 2c20 7369 6e6b 5f6e 6f64  e(pipe, sink_nod
-000190e0: 652c 2074 625f 636c 6965 6e74 3a20 5469  e, tb_client: Ti
-000190f0: 6e79 4229 3a0a 2020 2020 6966 206e 6f74  nyB):.    if not
-00019100: 2073 696e 6b5f 6e6f 6465 5b22 6578 706f   sink_node["expo
-00019110: 7274 5f70 6172 616d 7322 5d3a 0a20 2020  rt_params"]:.   
-00019120: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00019130: 2069 6620 6e6f 7420 7069 7065 3a0a 2020   if not pipe:.  
-00019140: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-00019150: 2020 7069 7065 5f6e 616d 6520 3d20 7069    pipe_name = pi
-00019160: 7065 5b22 6e61 6d65 225d 0a20 2020 2070  pe["name"].    p
-00019170: 6970 655f 7479 7065 203d 2070 6970 655b  ipe_type = pipe[
-00019180: 2274 7970 6522 5d0a 0a20 2020 2073 6368  "type"]..    sch
-00019190: 6564 756c 655f 6372 6f6e 203d 2073 696e  edule_cron = sin
-000191a0: 6b5f 6e6f 6465 5b22 6578 706f 7274 5f70  k_node["export_p
-000191b0: 6172 616d 7322 5d2e 6765 7428 2273 6368  arams"].get("sch
-000191c0: 6564 756c 655f 6372 6f6e 222c 2022 2229  edule_cron", "")
-000191d0: 0a20 2020 2069 735f 7661 6c69 645f 6372  .    is_valid_cr
-000191e0: 6f6e 203d 206e 6f74 2073 6368 6564 756c  on = not schedul
-000191f0: 655f 6372 6f6e 206f 7220 2873 6368 6564  e_cron or (sched
-00019200: 756c 655f 6372 6f6e 2061 6e64 2063 726f  ule_cron and cro
-00019210: 6e69 7465 722e 6973 5f76 616c 6964 2873  niter.is_valid(s
-00019220: 6368 6564 756c 655f 6372 6f6e 2929 0a0a  chedule_cron))..
-00019230: 2020 2020 6966 206e 6f74 2069 735f 7661      if not is_va
-00019240: 6c69 645f 6372 6f6e 3a0a 2020 2020 2020  lid_cron:.      
-00019250: 2020 7261 6973 6520 434c 4950 6970 6545    raise CLIPipeE
-00019260: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
-00019270: 6b4d 616e 6167 6572 2e65 7272 6f72 5f63  kManager.error_c
-00019280: 7265 6174 696e 675f 7369 6e6b 5f70 6970  reating_sink_pip
-00019290: 655f 696e 7661 6c69 645f 6372 6f6e 2873  e_invalid_cron(s
-000192a0: 6368 6564 756c 655f 6372 6f6e 3d73 6368  chedule_cron=sch
-000192b0: 6564 756c 655f 6372 6f6e 2929 0a0a 2020  edule_cron))..  
-000192c0: 2020 6966 2070 6970 655f 7479 7065 203d    if pipe_type =
-000192d0: 3d20 5069 7065 5479 7065 732e 454e 4450  = PipeTypes.ENDP
-000192e0: 4f49 4e54 3a0a 2020 2020 2020 2020 6177  OINT:.        aw
-000192f0: 6169 7420 7462 5f63 6c69 656e 742e 7069  ait tb_client.pi
-00019300: 7065 5f72 656d 6f76 655f 656e 6470 6f69  pe_remove_endpoi
-00019310: 6e74 2870 6970 655f 6e61 6d65 2c20 7069  nt(pipe_name, pi
-00019320: 7065 5b22 656e 6470 6f69 6e74 225d 290a  pe["endpoint"]).
-00019330: 0a20 2020 2069 6620 7069 7065 5f74 7970  .    if pipe_typ
-00019340: 6520 3d3d 2050 6970 6554 7970 6573 2e43  e == PipeTypes.C
-00019350: 4f50 593a 0a20 2020 2020 2020 2061 7761  OPY:.        awa
-00019360: 6974 2074 625f 636c 6965 6e74 2e70 6970  it tb_client.pip
-00019370: 655f 7265 6d6f 7665 5f63 6f70 7928 7069  e_remove_copy(pi
-00019380: 7065 5f6e 616d 652c 2070 6970 655b 2263  pe_name, pipe["c
-00019390: 6f70 795f 6e6f 6465 225d 290a 0a0a 6465  opy_node"])...de
-000193a0: 6620 7368 6f77 5f6d 6174 6572 6961 6c69  f show_materiali
-000193b0: 7a65 645f 7669 6577 5f77 6172 6e69 6e67  zed_view_warning
-000193c0: 7328 7761 726e 696e 6773 293a 0a20 2020  s(warnings):.   
-000193d0: 2022 2222 0a20 2020 203e 3e3e 2073 686f   """.    >>> sho
-000193e0: 775f 6d61 7465 7269 616c 697a 6564 5f76  w_materialized_v
-000193f0: 6965 775f 7761 726e 696e 6773 285b 7b27  iew_warnings([{'
-00019400: 636f 6465 273a 2027 5349 4d27 2c20 2777  code': 'SIM', 'w
-00019410: 6569 6768 7427 3a20 317d 5d29 0a0a 2020  eight': 1}])..  
-00019420: 2020 3e3e 3e20 7368 6f77 5f6d 6174 6572    >>> show_mater
-00019430: 6961 6c69 7a65 645f 7669 6577 5f77 6172  ialized_view_war
-00019440: 6e69 6e67 7328 5b7b 2763 6f64 6527 3a20  nings([{'code': 
-00019450: 2753 494d 272c 2027 7765 6967 6874 273a  'SIM', 'weight':
-00019460: 2031 7d2c 207b 2763 6f64 6527 3a20 2748   1}, {'code': 'H
-00019470: 5547 455f 4a4f 494e 272c 2027 7765 6967  UGE_JOIN', 'weig
-00019480: 6874 273a 2032 7d2c 207b 2774 6578 7427  ht': 2}, {'text'
-00019490: 3a20 2243 6f6c 756d 6e20 276e 756d 6265  : "Column 'numbe
-000194a0: 7227 2069 7320 7072 6573 656e 7420 696e  r' is present in
-000194b0: 2074 6865 2047 524f 5550 2042 5920 6275   the GROUP BY bu
-000194c0: 7420 6e6f 7420 696e 2074 6865 2053 454c  t not in the SEL
-000194d0: 4543 5420 636c 6175 7365 2e20 5468 6973  ECT clause. This
-000194e0: 206d 6967 6874 2069 6e64 6963 6174 6520   might indicate 
-000194f0: 6120 6e6f 7420 7661 6c69 6420 4d61 7465  a not valid Mate
-00019500: 7269 616c 697a 6564 2056 6965 772c 2070  rialized View, p
-00019510: 6c65 6173 6520 6d61 6b65 2073 7572 6520  lease make sure 
-00019520: 796f 7520 6167 6772 6567 6174 6520 616e  you aggregate an
-00019530: 6420 4752 4f55 5020 4259 2069 6e20 7468  d GROUP BY in th
-00019540: 6520 746f 706d 6f73 7420 7175 6572 792e  e topmost query.
-00019550: 222c 2027 636f 6465 273a 2027 4752 4f55  ", 'code': 'GROU
-00019560: 505f 4259 272c 2027 7765 6967 6874 273a  P_BY', 'weight':
-00019570: 2031 3030 2c20 2764 6f63 756d 656e 7461   100, 'documenta
-00019580: 7469 6f6e 273a 2027 6874 7470 733a 2f2f  tion': 'https://
-00019590: 7469 6e79 6269 7264 2e63 6f2f 646f 6373  tinybird.co/docs
-000195a0: 2f67 7569 6465 732f 6d61 7465 7269 616c  /guides/material
-000195b0: 697a 6564 2d76 6965 7773 2e68 746d 6c23  ized-views.html#
-000195c0: 7573 652d 7468 652d 7361 6d65 2d61 6c69  use-the-same-ali
-000195d0: 6173 2d69 6e2d 7365 6c65 6374 2d61 6e64  as-in-select-and
-000195e0: 2d67 726f 7570 2d62 7927 7d5d 290a 2020  -group-by'}]).  
-000195f0: 2020 e29a a0ef b88f 2020 436f 6c75 6d6e    ......  Column
-00019600: 2027 6e75 6d62 6572 2720 6973 2070 7265   'number' is pre
-00019610: 7365 6e74 2069 6e20 7468 6520 4752 4f55  sent in the GROU
-00019620: 5020 4259 2062 7574 206e 6f74 2069 6e20  P BY but not in 
-00019630: 7468 6520 5345 4c45 4354 2063 6c61 7573  the SELECT claus
-00019640: 652e 2054 6869 7320 6d69 6768 7420 696e  e. This might in
-00019650: 6469 6361 7465 2061 206e 6f74 2076 616c  dicate a not val
-00019660: 6964 204d 6174 6572 6961 6c69 7a65 6420  id Materialized 
-00019670: 5669 6577 2c20 706c 6561 7365 206d 616b  View, please mak
-00019680: 6520 7375 7265 2079 6f75 2061 6767 7265  e sure you aggre
-00019690: 6761 7465 2061 6e64 2047 524f 5550 2042  gate and GROUP B
-000196a0: 5920 696e 2074 6865 2074 6f70 6d6f 7374  Y in the topmost
-000196b0: 2071 7565 7279 2e20 466f 7220 6d6f 7265   query. For more
-000196c0: 2069 6e66 6f72 6d61 7469 6f6e 2072 6561   information rea
-000196d0: 6420 6874 7470 733a 2f2f 7469 6e79 6269  d https://tinybi
-000196e0: 7264 2e63 6f2f 646f 6373 2f67 7569 6465  rd.co/docs/guide
-000196f0: 732f 6d61 7465 7269 616c 697a 6564 2d76  s/materialized-v
-00019700: 6965 7773 2e68 746d 6c23 7573 652d 7468  iews.html#use-th
-00019710: 652d 7361 6d65 2d61 6c69 6173 2d69 6e2d  e-same-alias-in-
-00019720: 7365 6c65 6374 2d61 6e64 2d67 726f 7570  select-and-group
-00019730: 2d62 7920 6f72 2063 6f6e 7461 6374 2075  -by or contact u
-00019740: 7320 6174 2073 7570 706f 7274 4074 696e  s at support@tin
-00019750: 7962 6972 642e 636f 0a20 2020 203e 3e3e  ybird.co.    >>>
-00019760: 2073 686f 775f 6d61 7465 7269 616c 697a   show_materializ
-00019770: 6564 5f76 6965 775f 7761 726e 696e 6773  ed_view_warnings
-00019780: 285b 7b27 636f 6465 273a 2027 5349 4e47  ([{'code': 'SING
-00019790: 4c45 5f4a 4f49 4e27 2c20 2777 6569 6768  LE_JOIN', 'weigh
-000197a0: 7427 3a20 3330 307d 2c20 7b27 7465 7874  t': 300}, {'text
-000197b0: 273a 2022 436f 6c75 6d6e 2027 6e75 6d62  ': "Column 'numb
-000197c0: 6572 2720 6973 2070 7265 7365 6e74 2069  er' is present i
-000197d0: 6e20 7468 6520 4752 4f55 5020 4259 2062  n the GROUP BY b
-000197e0: 7574 206e 6f74 2069 6e20 7468 6520 5345  ut not in the SE
-000197f0: 4c45 4354 2063 6c61 7573 652e 2054 6869  LECT clause. Thi
-00019800: 7320 6d69 6768 7420 696e 6469 6361 7465  s might indicate
-00019810: 2061 206e 6f74 2076 616c 6964 204d 6174   a not valid Mat
-00019820: 6572 6961 6c69 7a65 6420 5669 6577 2c20  erialized View, 
-00019830: 706c 6561 7365 206d 616b 6520 7375 7265  please make sure
-00019840: 2079 6f75 2061 6767 7265 6761 7465 2061   you aggregate a
-00019850: 6e64 2047 524f 5550 2042 5920 696e 2074  nd GROUP BY in t
-00019860: 6865 2074 6f70 6d6f 7374 2071 7565 7279  he topmost query
-00019870: 2e22 2c20 2763 6f64 6527 3a20 2747 524f  .", 'code': 'GRO
-00019880: 5550 5f42 5927 2c20 2777 6569 6768 7427  UP_BY', 'weight'
-00019890: 3a20 3130 302c 2027 646f 6375 6d65 6e74  : 100, 'document
-000198a0: 6174 696f 6e27 3a20 2768 7474 7073 3a2f  ation': 'https:/
-000198b0: 2f74 696e 7962 6972 642e 636f 2f64 6f63  /tinybird.co/doc
-000198c0: 732f 6775 6964 6573 2f6d 6174 6572 6961  s/guides/materia
-000198d0: 6c69 7a65 642d 7669 6577 732e 6874 6d6c  lized-views.html
-000198e0: 2375 7365 2d74 6865 2d73 616d 652d 616c  #use-the-same-al
-000198f0: 6961 732d 696e 2d73 656c 6563 742d 616e  ias-in-select-an
-00019900: 642d 6772 6f75 702d 6279 277d 5d29 0a20  d-group-by'}]). 
-00019910: 2020 20e2 9aa0 efb8 8f20 2043 6f6c 756d     ......  Colum
-00019920: 6e20 276e 756d 6265 7227 2069 7320 7072  n 'number' is pr
-00019930: 6573 656e 7420 696e 2074 6865 2047 524f  esent in the GRO
-00019940: 5550 2042 5920 6275 7420 6e6f 7420 696e  UP BY but not in
-00019950: 2074 6865 2053 454c 4543 5420 636c 6175   the SELECT clau
-00019960: 7365 2e20 5468 6973 206d 6967 6874 2069  se. This might i
-00019970: 6e64 6963 6174 6520 6120 6e6f 7420 7661  ndicate a not va
-00019980: 6c69 6420 4d61 7465 7269 616c 697a 6564  lid Materialized
-00019990: 2056 6965 772c 2070 6c65 6173 6520 6d61   View, please ma
-000199a0: 6b65 2073 7572 6520 796f 7520 6167 6772  ke sure you aggr
-000199b0: 6567 6174 6520 616e 6420 4752 4f55 5020  egate and GROUP 
-000199c0: 4259 2069 6e20 7468 6520 746f 706d 6f73  BY in the topmos
-000199d0: 7420 7175 6572 792e 2046 6f72 206d 6f72  t query. For mor
-000199e0: 6520 696e 666f 726d 6174 696f 6e20 7265  e information re
-000199f0: 6164 2068 7474 7073 3a2f 2f74 696e 7962  ad https://tinyb
-00019a00: 6972 642e 636f 2f64 6f63 732f 6775 6964  ird.co/docs/guid
-00019a10: 6573 2f6d 6174 6572 6961 6c69 7a65 642d  es/materialized-
-00019a20: 7669 6577 732e 6874 6d6c 2375 7365 2d74  views.html#use-t
-00019a30: 6865 2d73 616d 652d 616c 6961 732d 696e  he-same-alias-in
-00019a40: 2d73 656c 6563 742d 616e 642d 6772 6f75  -select-and-grou
-00019a50: 702d 6279 206f 7220 636f 6e74 6163 7420  p-by or contact 
-00019a60: 7573 2061 7420 7375 7070 6f72 7440 7469  us at support@ti
-00019a70: 6e79 6269 7264 2e63 6f0a 2020 2020 2222  nybird.co.    ""
-00019a80: 220a 2020 2020 6578 636c 7564 6564 5f77  ".    excluded_w
-00019a90: 6172 6e69 6e67 7320 3d20 5b22 5349 4d22  arnings = ["SIM"
-00019aa0: 2c20 2253 494d 5f55 4e4b 4e4f 574e 222c  , "SIM_UNKNOWN",
-00019ab0: 2022 4855 4745 5f4a 4f49 4e22 5d0a 2020   "HUGE_JOIN"].  
-00019ac0: 2020 736f 7274 6564 5f77 6172 6e69 6e67    sorted_warning
-00019ad0: 7320 3d20 736f 7274 6564 2877 6172 6e69  s = sorted(warni
-00019ae0: 6e67 732c 206b 6579 3d6c 616d 6264 6120  ngs, key=lambda 
-00019af0: 7761 726e 696e 673a 2077 6172 6e69 6e67  warning: warning
-00019b00: 5b22 7765 6967 6874 225d 290a 2020 2020  ["weight"]).    
-00019b10: 6d6f 7374 5f69 6d70 6f72 7461 6e74 5f77  most_important_w
-00019b20: 6172 6e69 6e67 203d 207b 7d0a 2020 2020  arning = {}.    
-00019b30: 666f 7220 7761 726e 696e 6720 696e 2073  for warning in s
-00019b40: 6f72 7465 645f 7761 726e 696e 6773 3a0a  orted_warnings:.
-00019b50: 2020 2020 2020 2020 6966 2077 6172 6e69          if warni
-00019b60: 6e67 2e67 6574 2822 636f 6465 2229 2061  ng.get("code") a
-00019b70: 6e64 2077 6172 6e69 6e67 5b22 636f 6465  nd warning["code
-00019b80: 225d 206e 6f74 2069 6e20 6578 636c 7564  "] not in exclud
-00019b90: 6564 5f77 6172 6e69 6e67 733a 0a20 2020  ed_warnings:.   
-00019ba0: 2020 2020 2020 2020 206d 6f73 745f 696d           most_im
-00019bb0: 706f 7274 616e 745f 7761 726e 696e 6720  portant_warning 
-00019bc0: 3d20 7761 726e 696e 670a 2020 2020 2020  = warning.      
-00019bd0: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00019be0: 6966 206d 6f73 745f 696d 706f 7274 616e  if most_importan
-00019bf0: 745f 7761 726e 696e 673a 0a20 2020 2020  t_warning:.     
-00019c00: 2020 2063 6c69 636b 2e65 6368 6f28 0a20     click.echo(. 
-00019c10: 2020 2020 2020 2020 2020 2046 6565 6462             Feedb
-00019c20: 6163 6b4d 616e 6167 6572 2e73 696e 676c  ackManager.singl
-00019c30: 655f 7761 726e 696e 675f 6d61 7465 7269  e_warning_materi
-00019c40: 616c 697a 6564 5f70 6970 6528 0a20 2020  alized_pipe(.   
-00019c50: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00019c60: 7465 6e74 3d6d 6f73 745f 696d 706f 7274  tent=most_import
-00019c70: 616e 745f 7761 726e 696e 675b 2274 6578  ant_warning["tex
-00019c80: 7422 5d2c 2064 6f63 735f 7572 6c3d 6d6f  t"], docs_url=mo
-00019c90: 7374 5f69 6d70 6f72 7461 6e74 5f77 6172  st_important_war
-00019ca0: 6e69 6e67 5b22 646f 6375 6d65 6e74 6174  ning["documentat
-00019cb0: 696f 6e22 5d0a 2020 2020 2020 2020 2020  ion"].          
-00019cc0: 2020 290a 2020 2020 2020 2020 290a 0a0a    ).        )...
-00019cd0: 6173 796e 6320 6465 6620 6765 745f 746f  async def get_to
-00019ce0: 6b65 6e5f 6672 6f6d 5f6d 6169 6e5f 6272  ken_from_main_br
-00019cf0: 616e 6368 2862 7261 6e63 685f 7462 5f63  anch(branch_tb_c
-00019d00: 6c69 656e 743a 2054 696e 7942 2920 2d3e  lient: TinyB) ->
-00019d10: 204f 7074 696f 6e61 6c5b 7374 725d 3a0a   Optional[str]:.
-00019d20: 2020 2020 746f 6b65 6e5f 6672 6f6d 5f6d      token_from_m
-00019d30: 6169 6e5f 6272 616e 6368 203d 204e 6f6e  ain_branch = Non
-00019d40: 650a 2020 2020 6375 7272 656e 745f 776f  e.    current_wo
-00019d50: 726b 7370 6163 6520 3d20 6177 6169 7420  rkspace = await 
-00019d60: 6272 616e 6368 5f74 625f 636c 6965 6e74  branch_tb_client
-00019d70: 2e77 6f72 6b73 7061 6365 5f69 6e66 6f28  .workspace_info(
-00019d80: 290a 2020 2020 2320 6375 7272 656e 7420  ).    # current 
-00019d90: 776f 726b 7370 6163 6520 6973 2061 2062  workspace is a b
-00019da0: 7261 6e63 680a 2020 2020 6966 2063 7572  ranch.    if cur
-00019db0: 7265 6e74 5f77 6f72 6b73 7061 6365 2e67  rent_workspace.g
-00019dc0: 6574 2822 6d61 696e 2229 3a0a 2020 2020  et("main"):.    
-00019dd0: 2020 2020 7265 7370 6f6e 7365 203d 2061      response = a
-00019de0: 7761 6974 2062 7261 6e63 685f 7462 5f63  wait branch_tb_c
-00019df0: 6c69 656e 742e 7573 6572 5f77 6f72 6b73  lient.user_works
-00019e00: 7061 6365 7328 290a 2020 2020 2020 2020  paces().        
-00019e10: 776f 726b 7370 6163 6573 203d 2072 6573  workspaces = res
-00019e20: 706f 6e73 655b 2277 6f72 6b73 7061 6365  ponse["workspace
-00019e30: 7322 5d0a 2020 2020 2020 2020 7072 6f64  s"].        prod
-00019e40: 5f77 6f72 6b73 7061 6365 203d 206e 6578  _workspace = nex
-00019e50: 7428 0a20 2020 2020 2020 2020 2020 2028  t(.            (
-00019e60: 776f 726b 7370 6163 6520 666f 7220 776f  workspace for wo
-00019e70: 726b 7370 6163 6520 696e 2077 6f72 6b73  rkspace in works
-00019e80: 7061 6365 7320 6966 2077 6f72 6b73 7061  paces if workspa
-00019e90: 6365 5b22 6964 225d 203d 3d20 6375 7272  ce["id"] == curr
-00019ea0: 656e 745f 776f 726b 7370 6163 655b 226d  ent_workspace["m
-00019eb0: 6169 6e22 5d29 2c20 4e6f 6e65 0a20 2020  ain"]), None.   
-00019ec0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00019ed0: 6620 7072 6f64 5f77 6f72 6b73 7061 6365  f prod_workspace
-00019ee0: 3a0a 2020 2020 2020 2020 2020 2020 746f  :.            to
-00019ef0: 6b65 6e5f 6672 6f6d 5f6d 6169 6e5f 6272  ken_from_main_br
-00019f00: 616e 6368 203d 2070 726f 645f 776f 726b  anch = prod_work
-00019f10: 7370 6163 652e 6765 7428 2274 6f6b 656e  space.get("token
-00019f20: 2229 0a20 2020 2072 6574 7572 6e20 746f  ").    return to
-00019f30: 6b65 6e5f 6672 6f6d 5f6d 6169 6e5f 6272  ken_from_main_br
-00019f40: 616e 6368 0a0a 0a61 7379 6e63 2064 6566  anch...async def
-00019f50: 206e 6577 5f70 6970 6528 0a20 2020 2070   new_pipe(.    p
-00019f60: 2c0a 2020 2020 7462 5f63 6c69 656e 743a  ,.    tb_client:
-00019f70: 2054 696e 7942 2c0a 2020 2020 666f 7263   TinyB,.    forc
-00019f80: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
-00019f90: 0a20 2020 2063 6865 636b 3a20 626f 6f6c  .    check: bool
-00019fa0: 203d 2054 7275 652c 0a20 2020 2070 6f70   = True,.    pop
-00019fb0: 756c 6174 653a 2062 6f6f 6c20 3d20 4661  ulate: bool = Fa
-00019fc0: 6c73 652c 0a20 2020 2070 6f70 756c 6174  lse,.    populat
-00019fd0: 655f 7375 6273 6574 3d4e 6f6e 652c 0a20  e_subset=None,. 
-00019fe0: 2020 2070 6f70 756c 6174 655f 636f 6e64     populate_cond
-00019ff0: 6974 696f 6e3d 4e6f 6e65 2c0a 2020 2020  ition=None,.    
-0001a000: 756e 6c69 6e6b 5f6f 6e5f 706f 7075 6c61  unlink_on_popula
-0001a010: 7465 5f65 7272 6f72 3a20 626f 6f6c 203d  te_error: bool =
-0001a020: 2046 616c 7365 2c0a 2020 2020 7761 6974   False,.    wait
-0001a030: 5f70 6f70 756c 6174 653a 2062 6f6f 6c20  _populate: bool 
-0001a040: 3d20 4661 6c73 652c 0a20 2020 2073 6b69  = False,.    ski
-0001a050: 705f 746f 6b65 6e73 3a20 626f 6f6c 203d  p_tokens: bool =
-0001a060: 2046 616c 7365 2c0a 2020 2020 6967 6e6f   False,.    igno
-0001a070: 7265 5f73 716c 5f65 7272 6f72 733a 2062  re_sql_errors: b
-0001a080: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-0001a090: 206f 6e6c 795f 7265 7370 6f6e 7365 5f74   only_response_t
-0001a0a0: 696d 6573 3a20 626f 6f6c 203d 2046 616c  imes: bool = Fal
-0001a0b0: 7365 2c0a 2020 2020 7469 6d65 6f75 743d  se,.    timeout=
-0001a0c0: 4e6f 6e65 2c0a 2020 2020 7275 6e5f 7465  None,.    run_te
-0001a0d0: 7374 733a 2062 6f6f 6c20 3d20 4661 6c73  sts: bool = Fals
-0001a0e0: 652c 0a20 2020 2061 735f 7374 616e 6461  e,.    as_standa
-0001a0f0: 7264 3a20 626f 6f6c 203d 2046 616c 7365  rd: bool = False
-0001a100: 2c0a 2020 2020 7465 7374 735f 746f 5f72  ,.    tests_to_r
-0001a110: 756e 3a20 696e 7420 3d20 302c 0a20 2020  un: int = 0,.   
-0001a120: 2074 6573 7473 5f74 6f5f 7361 6d70 6c65   tests_to_sample
-0001a130: 5f62 795f 7061 7261 6d73 3a20 696e 7420  _by_params: int 
-0001a140: 3d20 302c 0a20 2020 2074 6573 7473 5f66  = 0,.    tests_f
-0001a150: 696c 7465 725f 6279 3a20 4f70 7469 6f6e  ilter_by: Option
-0001a160: 616c 5b4c 6973 745b 7374 725d 5d20 3d20  al[List[str]] = 
-0001a170: 4e6f 6e65 2c0a 2020 2020 7465 7374 735f  None,.    tests_
-0001a180: 6661 696c 6661 7374 3a20 626f 6f6c 203d  failfast: bool =
-0001a190: 2046 616c 7365 2c0a 2020 2020 7465 7374   False,.    test
-0001a1a0: 735f 6967 6e6f 7265 5f6f 7264 6572 3a20  s_ignore_order: 
-0001a1b0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-0001a1c0: 2020 7465 7374 735f 7661 6c69 6461 7465    tests_validate
-0001a1d0: 5f70 726f 6365 7373 6564 5f62 7974 6573  _processed_bytes
+00018010: 666f 726d 6174 5f70 7265 7474 795f 7461  format_pretty_ta
+00018020: 626c 6528 0a20 2020 2020 2020 2020 2020  ble(.           
+00018030: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+00018040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018050: 2020 205b 6d65 7472 6963 2c20 7275 6e6e     [metric, runn
+00018060: 6572 5f72 6573 706f 6e73 652e 6d65 7472  er_response.metr
+00018070: 6963 735f 7469 6d69 6e67 5b6d 6574 7269  ics_timing[metri
+00018080: 635d 5b30 5d2c 2072 756e 6e65 725f 7265  c][0], runner_re
+00018090: 7370 6f6e 7365 2e6d 6574 7269 6373 5f74  sponse.metrics_t
+000180a0: 696d 696e 675b 6d65 7472 6963 5d5b 315d  iming[metric][1]
+000180b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000180c0: 2020 2020 2020 2020 2020 666f 7220 6d65            for me
+000180d0: 7472 6963 2069 6e20 5b0a 2020 2020 2020  tric in [.      
+000180e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000180f0: 2020 2020 2020 226d 696e 2072 6573 706f        "min respo
+00018100: 6e73 6520 7469 6d65 222c 0a20 2020 2020  nse time",.     
+00018110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018120: 2020 2020 2020 2022 6d61 7820 7265 7370         "max resp
+00018130: 6f6e 7365 2074 696d 6522 2c0a 2020 2020  onse time",.    
+00018140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018150: 2020 2020 2020 2020 226d 6561 6e20 7265          "mean re
+00018160: 7370 6f6e 7365 2074 696d 6522 2c0a 2020  sponse time",.  
+00018170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018180: 2020 2020 2020 2020 2020 226d 6564 6961            "media
+00018190: 6e20 7265 7370 6f6e 7365 2074 696d 6522  n response time"
+000181a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000181b0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+000181c0: 3930 2072 6573 706f 6e73 6520 7469 6d65  90 response time
+000181d0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+000181e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000181f0: 6d69 6e20 7265 6164 2062 7974 6573 222c  min read bytes",
+00018200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018210: 2020 2020 2020 2020 2020 2020 2022 6d61               "ma
+00018220: 7820 7265 6164 2062 7974 6573 222c 0a20  x read bytes",. 
+00018230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018240: 2020 2020 2020 2020 2020 2022 6d65 616e             "mean
+00018250: 2072 6561 6420 6279 7465 7322 2c0a 2020   read bytes",.  
+00018260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018270: 2020 2020 2020 2020 2020 226d 6564 6961            "media
+00018280: 6e20 7265 6164 2062 7974 6573 222c 0a20  n read bytes",. 
+00018290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182a0: 2020 2020 2020 2020 2020 2022 7039 3020             "p90 
+000182b0: 7265 6164 2062 7974 6573 222c 0a20 2020  read bytes",.   
+000182c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182d0: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+000182e0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+000182f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018300: 2020 636f 6c75 6d6e 5f6e 616d 6573 3d63    column_names=c
+00018310: 6f6c 756d 6e5f 6e61 6d65 735f 7469 6d69  olumn_names_timi
+00018320: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
+00018330: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00018340: 2020 290a 2020 2020 6578 6365 7074 2045    ).    except E
+00018350: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00018360: 2020 7061 7373 0a0a 2020 2020 6966 206e    pass..    if n
+00018370: 6f74 2072 756e 6e65 725f 7265 7370 6f6e  ot runner_respon
+00018380: 7365 2e77 6173 5f73 7563 6365 7373 6675  se.was_successfu
+00018390: 6c6c 3a0a 2020 2020 2020 2020 666f 7220  ll:.        for 
+000183a0: 6661 696c 7572 6520 696e 2072 756e 6e65  failure in runne
+000183b0: 725f 7265 7370 6f6e 7365 2e66 6169 6c65  r_response.faile
+000183c0: 643a 0a20 2020 2020 2020 2020 2020 2074  d:.            t
+000183d0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000183e0: 2020 2020 636c 6963 6b2e 6563 686f 2822      click.echo("
+000183f0: 3d3d 3d3d 2054 6573 7420 4641 494c 4544  ==== Test FAILED
+00018400: 203d 3d3d 3d5c 6e22 290a 2020 2020 2020   ====\n").      
+00018410: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
+00018420: 6563 686f 2866 6169 6c75 7265 5b22 6e61  echo(failure["na
+00018430: 6d65 225d 290a 2020 2020 2020 2020 2020  me"]).          
+00018440: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
+00018450: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
+00018460: 2e65 7272 6f72 5f63 6865 636b 5f70 6970  .error_check_pip
+00018470: 6528 6572 726f 723d 6661 696c 7572 655b  e(error=failure[
+00018480: 2265 7272 6f72 225d 2929 0a20 2020 2020  "error"])).     
+00018490: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+000184a0: 2e65 6368 6f28 223d 3d3d 3d3d 3d3d 3d3d  .echo("=========
+000184b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 5c6e 5c6e  ============\n\n
+000184c0: 5c6e 2229 0a20 2020 2020 2020 2020 2020  \n").           
+000184d0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000184e0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+000184f0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+00018500: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
+00018510: 6f72 2822 496e 7661 6c69 6420 7265 7375  or("Invalid resu
+00018520: 6c74 732c 2079 6f75 2063 616e 2062 7970  lts, you can byp
+00018530: 6173 7320 6368 6563 6b73 2062 7920 7275  ass checks by ru
+00018540: 6e6e 696e 6720 7075 7368 2077 6974 6820  nning push with 
+00018550: 7468 6520 2d2d 6e6f 2d63 6865 636b 2066  the --no-check f
+00018560: 6c61 6722 290a 0a20 2020 2023 204f 6e6c  lag")..    # Onl
+00018570: 7920 6465 6c65 7465 2069 6620 6e6f 2065  y delete if no e
+00018580: 7272 6f72 732c 2073 6f20 7765 2063 616e  rrors, so we can
+00018590: 2063 6865 636b 2072 6573 756c 7473 2061   check results a
+000185a0: 6674 6572 2066 6169 6c75 7265 0a20 2020  fter failure.   
+000185b0: 2068 6561 6465 7273 203d 207b 2241 7574   headers = {"Aut
+000185c0: 686f 7269 7a61 7469 6f6e 223a 2066 2242  horization": f"B
+000185d0: 6561 7265 7220 7b74 6f6b 656e 7d22 7d0a  earer {token}"}.
+000185e0: 2020 2020 7220 3d20 6177 6169 7420 7265      r = await re
+000185f0: 7175 6573 7473 5f64 656c 6574 6528 6622  quests_delete(f"
+00018600: 7b68 6f73 747d 2f76 302f 7069 7065 732f  {host}/v0/pipes/
+00018610: 7b63 6865 636b 6572 5f70 6970 655b 276e  {checker_pipe['n
+00018620: 616d 6527 5d7d 222c 2068 6561 6465 7273  ame']}", headers
+00018630: 3d68 6561 6465 7273 290a 2020 2020 6966  =headers).    if
+00018640: 2072 2e73 7461 7475 735f 636f 6465 2021   r.status_code !
+00018650: 3d20 3230 343a 0a20 2020 2020 2020 2063  = 204:.        c
+00018660: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
+00018670: 636b 4d61 6e61 6765 722e 7761 726e 696e  ckManager.warnin
+00018680: 675f 6368 6563 6b5f 7069 7065 2863 6f6e  g_check_pipe(con
+00018690: 7465 6e74 3d72 2e63 6f6e 7465 6e74 2929  tent=r.content))
+000186a0: 0a0a 0a61 7379 6e63 2064 6566 2063 6865  ...async def che
+000186b0: 636b 5f6d 6174 6572 6961 6c69 7a65 6428  ck_materialized(
+000186c0: 7069 7065 2c20 686f 7374 2c20 746f 6b65  pipe, host, toke
+000186d0: 6e2c 2063 6c2c 206f 7665 7272 6964 655f  n, cl, override_
+000186e0: 6461 7461 736f 7572 6365 3d46 616c 7365  datasource=False
+000186f0: 2c20 6375 7272 656e 745f 7069 7065 3d4e  , current_pipe=N
+00018700: 6f6e 6529 3a0a 2020 2020 6368 6563 6b65  one):.    checke
+00018710: 725f 7069 7065 203d 2064 6565 7063 6f70  r_pipe = deepcop
+00018720: 7928 7069 7065 290a 2020 2020 6368 6563  y(pipe).    chec
+00018730: 6b65 725f 7069 7065 5b22 6e61 6d65 225d  ker_pipe["name"]
+00018740: 203d 2066 227b 6368 6563 6b65 725f 7069   = f"{checker_pi
+00018750: 7065 5b27 6e61 6d65 275d 7d5f 5f63 6865  pe['name']}__che
+00018760: 636b 6572 220a 2020 2020 6865 6164 6572  cker".    header
+00018770: 7320 3d20 7b22 4175 7468 6f72 697a 6174  s = {"Authorizat
+00018780: 696f 6e22 3a20 6622 4265 6172 6572 207b  ion": f"Bearer {
+00018790: 746f 6b65 6e7d 227d 0a0a 2020 2020 6966  token}"}..    if
+000187a0: 2063 7572 7265 6e74 5f70 6970 653a 0a20   current_pipe:. 
+000187b0: 2020 2020 2020 2066 726f 6d5f 636f 7079         from_copy
+000187c0: 5f74 6f5f 6d61 7465 7269 616c 697a 6564  _to_materialized
+000187d0: 203d 2063 7572 7265 6e74 5f70 6970 655b   = current_pipe[
+000187e0: 2274 7970 6522 5d20 3d3d 2022 636f 7079  "type"] == "copy
+000187f0: 220a 2020 2020 2020 2020 6966 2066 726f  ".        if fro
+00018800: 6d5f 636f 7079 5f74 6f5f 6d61 7465 7269  m_copy_to_materi
+00018810: 616c 697a 6564 3a0a 2020 2020 2020 2020  alized:.        
+00018820: 2020 2020 6177 6169 7420 636c 2e70 6970      await cl.pip
+00018830: 655f 7265 6d6f 7665 5f63 6f70 7928 6375  e_remove_copy(cu
+00018840: 7272 656e 745f 7069 7065 5b22 6964 225d  rrent_pipe["id"]
+00018850: 2c20 6375 7272 656e 745f 7069 7065 5b22  , current_pipe["
+00018860: 636f 7079 5f6e 6f64 6522 5d29 0a0a 2020  copy_node"])..  
+00018870: 2020 6d61 7465 7269 616c 697a 6564 5f6e    materialized_n
+00018880: 6f64 6520 3d20 4e6f 6e65 0a20 2020 2066  ode = None.    f
+00018890: 6f72 206e 6f64 6520 696e 2063 6865 636b  or node in check
+000188a0: 6572 5f70 6970 655b 226e 6f64 6573 225d  er_pipe["nodes"]
+000188b0: 3a0a 2020 2020 2020 2020 6966 206e 6f64  :.        if nod
+000188c0: 655b 2270 6172 616d 7322 5d5b 2274 7970  e["params"]["typ
+000188d0: 6522 5d20 3d3d 2022 6d61 7465 7269 616c  e"] == "material
+000188e0: 697a 6564 223a 0a20 2020 2020 2020 2020  ized":.         
+000188f0: 2020 206d 6174 6572 6961 6c69 7a65 645f     materialized_
+00018900: 6e6f 6465 203d 2064 6565 7063 6f70 7928  node = deepcopy(
+00018910: 6e6f 6465 290a 2020 2020 2020 2020 2020  node).          
+00018920: 2020 6d61 7465 7269 616c 697a 6564 5f6e    materialized_n
+00018930: 6f64 655b 2270 6172 616d 7322 5d5b 226f  ode["params"]["o
+00018940: 7665 7272 6964 655f 6461 7461 736f 7572  verride_datasour
+00018950: 6365 225d 203d 2022 7472 7565 2220 6966  ce"] = "true" if
+00018960: 206f 7665 7272 6964 655f 6461 7461 736f   override_dataso
+00018970: 7572 6365 2065 6c73 6520 2266 616c 7365  urce else "false
+00018980: 220a 2020 2020 2020 2020 6e6f 6465 5b22  ".        node["
+00018990: 7061 7261 6d73 225d 5b22 7479 7065 225d  params"]["type"]
+000189a0: 203d 2022 7374 616e 6461 7264 220a 0a20   = "standard".. 
+000189b0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000189c0: 7069 7065 5f63 7265 6174 6564 203d 2046  pipe_created = F
+000189d0: 616c 7365 0a20 2020 2020 2020 2061 7761  alse.        awa
+000189e0: 6974 206e 6577 5f70 6970 6528 0a20 2020  it new_pipe(.   
+000189f0: 2020 2020 2020 2020 2063 6865 636b 6572           checker
+00018a00: 5f70 6970 652c 2063 6c2c 2066 6f72 6365  _pipe, cl, force
+00018a10: 3d54 7275 652c 2063 6865 636b 3d46 616c  =True, check=Fal
+00018a20: 7365 2c20 706f 7075 6c61 7465 3d46 616c  se, populate=Fal
+00018a30: 7365 2c20 736b 6970 5f74 6f6b 656e 733d  se, skip_tokens=
+00018a40: 5472 7565 2c20 6967 6e6f 7265 5f73 716c  True, ignore_sql
+00018a50: 5f65 7272 6f72 733d 4661 6c73 650a 2020  _errors=False.  
+00018a60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00018a70: 7069 7065 5f63 7265 6174 6564 203d 2054  pipe_created = T
+00018a80: 7275 650a 2020 2020 2020 2020 7265 7370  rue.        resp
+00018a90: 6f6e 7365 203d 2061 7761 6974 2063 6c2e  onse = await cl.
+00018aa0: 616e 616c 797a 655f 7069 7065 5f6e 6f64  analyze_pipe_nod
+00018ab0: 6528 6368 6563 6b65 725f 7069 7065 5b22  e(checker_pipe["
+00018ac0: 6e61 6d65 225d 2c20 6d61 7465 7269 616c  name"], material
+00018ad0: 697a 6564 5f6e 6f64 652c 2064 7279 5f72  ized_node, dry_r
+00018ae0: 756e 3d22 7472 7565 2229 0a20 2020 2020  un="true").     
+00018af0: 2020 2069 6620 7265 7370 6f6e 7365 2e67     if response.g
+00018b00: 6574 2822 7761 726e 696e 6773 2229 3a0a  et("warnings"):.
+00018b10: 2020 2020 2020 2020 2020 2020 7368 6f77              show
+00018b20: 5f6d 6174 6572 6961 6c69 7a65 645f 7669  _materialized_vi
+00018b30: 6577 5f77 6172 6e69 6e67 7328 7265 7370  ew_warnings(resp
+00018b40: 6f6e 7365 5b22 7761 726e 696e 6773 225d  onse["warnings"]
+00018b50: 290a 0a20 2020 2065 7863 6570 7420 4578  )..    except Ex
+00018b60: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+00018b70: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
+00018b80: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
+00018b90: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
+00018ba0: 2e65 7272 6f72 5f77 6869 6c65 5f63 6865  .error_while_che
+00018bb0: 636b 5f6d 6174 6572 6961 6c69 7a65 6428  ck_materialized(
+00018bc0: 6572 726f 723d 7374 7228 6529 2929 0a20  error=str(e))). 
+00018bd0: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
+00018be0: 2020 2020 6966 2070 6970 655f 6372 6561      if pipe_crea
+00018bf0: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
+00018c00: 2072 203d 2061 7761 6974 2072 6571 7565   r = await reque
+00018c10: 7374 735f 6465 6c65 7465 2866 227b 686f  sts_delete(f"{ho
+00018c20: 7374 7d2f 7630 2f70 6970 6573 2f7b 6368  st}/v0/pipes/{ch
+00018c30: 6563 6b65 725f 7069 7065 5b27 6e61 6d65  ecker_pipe['name
+00018c40: 275d 7d22 2c20 6865 6164 6572 733d 6865  ']}", headers=he
+00018c50: 6164 6572 7329 0a20 2020 2020 2020 2020  aders).         
+00018c60: 2020 2069 6620 722e 7374 6174 7573 5f63     if r.status_c
+00018c70: 6f64 6520 213d 2032 3034 3a0a 2020 2020  ode != 204:.    
+00018c80: 2020 2020 2020 2020 2020 2020 636c 6963              clic
+00018c90: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
+00018ca0: 616e 6167 6572 2e77 6172 6e69 6e67 5f63  anager.warning_c
+00018cb0: 6865 636b 5f70 6970 6528 636f 6e74 656e  heck_pipe(conten
+00018cc0: 743d 722e 636f 6e74 656e 7429 290a 0a0a  t=r.content))...
+00018cd0: 6173 796e 6320 6465 6620 6368 6563 6b5f  async def check_
+00018ce0: 636f 7079 5f70 6970 6528 7069 7065 2c20  copy_pipe(pipe, 
+00018cf0: 636f 7079 5f6e 6f64 652c 2074 625f 636c  copy_node, tb_cl
+00018d00: 6965 6e74 3a20 5469 6e79 4229 3a0a 2020  ient: TinyB):.  
+00018d10: 2020 7461 7267 6574 5f64 6174 6173 6f75    target_datasou
+00018d20: 7263 6520 3d20 636f 7079 5f6e 6f64 655b  rce = copy_node[
+00018d30: 2270 6172 616d 7322 5d2e 6765 7428 2274  "params"].get("t
+00018d40: 6172 6765 745f 6461 7461 736f 7572 6365  arget_datasource
+00018d50: 222c 204e 6f6e 6529 0a20 2020 2069 6620  ", None).    if 
+00018d60: 6e6f 7420 7461 7267 6574 5f64 6174 6173  not target_datas
+00018d70: 6f75 7263 653a 0a20 2020 2020 2020 2072  ource:.        r
+00018d80: 6169 7365 2043 4c49 5069 7065 4578 6365  aise CLIPipeExce
+00018d90: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+00018da0: 6e61 6765 722e 6572 726f 725f 6372 6561  nager.error_crea
+00018db0: 7469 6e67 5f63 6f70 795f 7069 7065 5f74  ting_copy_pipe_t
+00018dc0: 6172 6765 745f 6461 7461 736f 7572 6365  arget_datasource
+00018dd0: 5f72 6571 7569 7265 6428 2929 0a0a 2020  _required())..  
+00018de0: 2020 7472 793a 0a20 2020 2020 2020 2061    try:.        a
+00018df0: 7761 6974 2074 625f 636c 6965 6e74 2e67  wait tb_client.g
+00018e00: 6574 5f64 6174 6173 6f75 7263 6528 7461  et_datasource(ta
+00018e10: 7267 6574 5f64 6174 6173 6f75 7263 6529  rget_datasource)
+00018e20: 0a20 2020 2065 7863 6570 7420 446f 6573  .    except Does
+00018e30: 4e6f 7445 7869 7374 4578 6365 7074 696f  NotExistExceptio
+00018e40: 6e3a 0a20 2020 2020 2020 2072 6169 7365  n:.        raise
+00018e50: 2043 4c49 5069 7065 4578 6365 7074 696f   CLIPipeExceptio
+00018e60: 6e28 0a20 2020 2020 2020 2020 2020 2046  n(.            F
+00018e70: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
+00018e80: 7272 6f72 5f63 7265 6174 696e 675f 636f  rror_creating_co
+00018e90: 7079 5f70 6970 655f 7461 7267 6574 5f64  py_pipe_target_d
+00018ea0: 6174 6173 6f75 7263 655f 6e6f 745f 666f  atasource_not_fo
+00018eb0: 756e 6428 7461 7267 6574 5f64 6174 6173  und(target_datas
+00018ec0: 6f75 7263 653d 7461 7267 6574 5f64 6174  ource=target_dat
+00018ed0: 6173 6f75 7263 6529 0a20 2020 2020 2020  asource).       
+00018ee0: 2029 0a20 2020 2065 7863 6570 7420 4578   ).    except Ex
+00018ef0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+00018f00: 2020 2020 2020 7261 6973 6520 434c 4950        raise CLIP
+00018f10: 6970 6545 7863 6570 7469 6f6e 2846 6565  ipeException(Fee
+00018f20: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+00018f30: 6f72 5f65 7863 6570 7469 6f6e 2865 7272  or_exception(err
+00018f40: 6f72 3d65 2929 0a0a 2020 2020 7363 6865  or=e))..    sche
+00018f50: 6475 6c65 5f63 726f 6e20 3d20 636f 7079  dule_cron = copy
+00018f60: 5f6e 6f64 655b 2270 6172 616d 7322 5d2e  _node["params"].
+00018f70: 6765 7428 436f 7079 5061 7261 6d65 7465  get(CopyParamete
+00018f80: 7273 2e43 4f50 595f 5343 4845 4455 4c45  rs.COPY_SCHEDULE
+00018f90: 2c20 4e6f 6e65 290a 2020 2020 6973 5f76  , None).    is_v
+00018fa0: 616c 6964 5f63 726f 6e20 3d20 6e6f 7420  alid_cron = not 
+00018fb0: 7363 6865 6475 6c65 5f63 726f 6e20 6f72  schedule_cron or
+00018fc0: 2028 0a20 2020 2020 2020 2073 6368 6564   (.        sched
+00018fd0: 756c 655f 6372 6f6e 2061 6e64 2028 7363  ule_cron and (sc
+00018fe0: 6865 6475 6c65 5f63 726f 6e20 3d3d 204f  hedule_cron == O
+00018ff0: 4e5f 4445 4d41 4e44 206f 7220 6372 6f6e  N_DEMAND or cron
+00019000: 6974 6572 2e69 735f 7661 6c69 6428 7363  iter.is_valid(sc
+00019010: 6865 6475 6c65 5f63 726f 6e29 290a 2020  hedule_cron)).  
+00019020: 2020 290a 0a20 2020 2069 6620 6e6f 7420    )..    if not 
+00019030: 6973 5f76 616c 6964 5f63 726f 6e3a 0a20  is_valid_cron:. 
+00019040: 2020 2020 2020 2072 6169 7365 2043 4c49         raise CLI
+00019050: 5069 7065 4578 6365 7074 696f 6e28 4665  PipeException(Fe
+00019060: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
+00019070: 726f 725f 6372 6561 7469 6e67 5f63 6f70  ror_creating_cop
+00019080: 795f 7069 7065 5f69 6e76 616c 6964 5f63  y_pipe_invalid_c
+00019090: 726f 6e28 7363 6865 6475 6c65 5f63 726f  ron(schedule_cro
+000190a0: 6e3d 7363 6865 6475 6c65 5f63 726f 6e29  n=schedule_cron)
+000190b0: 290a 0a20 2020 2069 6620 6e6f 7420 7069  )..    if not pi
+000190c0: 7065 3a0a 2020 2020 2020 2020 7265 7475  pe:.        retu
+000190d0: 726e 0a0a 2020 2020 7069 7065 5f6e 616d  rn..    pipe_nam
+000190e0: 6520 3d20 7069 7065 5b22 6e61 6d65 225d  e = pipe["name"]
+000190f0: 0a20 2020 2070 6970 655f 7479 7065 203d  .    pipe_type =
+00019100: 2070 6970 655b 2274 7970 6522 5d0a 0a20   pipe["type"].. 
+00019110: 2020 2069 6620 7069 7065 5f74 7970 6520     if pipe_type 
+00019120: 3d3d 2050 6970 6554 7970 6573 2e45 4e44  == PipeTypes.END
+00019130: 504f 494e 543a 0a20 2020 2020 2020 2061  POINT:.        a
+00019140: 7761 6974 2074 625f 636c 6965 6e74 2e70  wait tb_client.p
+00019150: 6970 655f 7265 6d6f 7665 5f65 6e64 706f  ipe_remove_endpo
+00019160: 696e 7428 7069 7065 5f6e 616d 652c 2070  int(pipe_name, p
+00019170: 6970 655b 2265 6e64 706f 696e 7422 5d29  ipe["endpoint"])
+00019180: 0a0a 2020 2020 6966 2070 6970 655f 7479  ..    if pipe_ty
+00019190: 7065 203d 3d20 5069 7065 5479 7065 732e  pe == PipeTypes.
+000191a0: 4441 5441 5f53 494e 4b3a 0a20 2020 2020  DATA_SINK:.     
+000191b0: 2020 2061 7761 6974 2074 625f 636c 6965     await tb_clie
+000191c0: 6e74 2e70 6970 655f 7265 6d6f 7665 5f73  nt.pipe_remove_s
+000191d0: 696e 6b28 7069 7065 5f6e 616d 652c 2070  ink(pipe_name, p
+000191e0: 6970 655b 2273 696e 6b5f 6e6f 6465 225d  ipe["sink_node"]
+000191f0: 290a 0a0a 6173 796e 6320 6465 6620 6368  )...async def ch
+00019200: 6563 6b5f 7369 6e6b 5f70 6970 6528 7069  eck_sink_pipe(pi
+00019210: 7065 2c20 7369 6e6b 5f6e 6f64 652c 2074  pe, sink_node, t
+00019220: 625f 636c 6965 6e74 3a20 5469 6e79 4229  b_client: TinyB)
+00019230: 3a0a 2020 2020 6966 206e 6f74 2073 696e  :.    if not sin
+00019240: 6b5f 6e6f 6465 5b22 6578 706f 7274 5f70  k_node["export_p
+00019250: 6172 616d 7322 5d3a 0a20 2020 2020 2020  arams"]:.       
+00019260: 2072 6574 7572 6e0a 0a20 2020 2069 6620   return..    if 
+00019270: 6e6f 7420 7069 7065 3a0a 2020 2020 2020  not pipe:.      
+00019280: 2020 7265 7475 726e 0a0a 2020 2020 7069    return..    pi
+00019290: 7065 5f6e 616d 6520 3d20 7069 7065 5b22  pe_name = pipe["
+000192a0: 6e61 6d65 225d 0a20 2020 2070 6970 655f  name"].    pipe_
+000192b0: 7479 7065 203d 2070 6970 655b 2274 7970  type = pipe["typ
+000192c0: 6522 5d0a 0a20 2020 2073 6368 6564 756c  e"]..    schedul
+000192d0: 655f 6372 6f6e 203d 2073 696e 6b5f 6e6f  e_cron = sink_no
+000192e0: 6465 5b22 6578 706f 7274 5f70 6172 616d  de["export_param
+000192f0: 7322 5d2e 6765 7428 2273 6368 6564 756c  s"].get("schedul
+00019300: 655f 6372 6f6e 222c 2022 2229 0a20 2020  e_cron", "").   
+00019310: 2069 735f 7661 6c69 645f 6372 6f6e 203d   is_valid_cron =
+00019320: 206e 6f74 2073 6368 6564 756c 655f 6372   not schedule_cr
+00019330: 6f6e 206f 7220 2873 6368 6564 756c 655f  on or (schedule_
+00019340: 6372 6f6e 2061 6e64 2063 726f 6e69 7465  cron and cronite
+00019350: 722e 6973 5f76 616c 6964 2873 6368 6564  r.is_valid(sched
+00019360: 756c 655f 6372 6f6e 2929 0a0a 2020 2020  ule_cron))..    
+00019370: 6966 206e 6f74 2069 735f 7661 6c69 645f  if not is_valid_
+00019380: 6372 6f6e 3a0a 2020 2020 2020 2020 7261  cron:.        ra
+00019390: 6973 6520 434c 4950 6970 6545 7863 6570  ise CLIPipeExcep
+000193a0: 7469 6f6e 2846 6565 6462 6163 6b4d 616e  tion(FeedbackMan
+000193b0: 6167 6572 2e65 7272 6f72 5f63 7265 6174  ager.error_creat
+000193c0: 696e 675f 7369 6e6b 5f70 6970 655f 696e  ing_sink_pipe_in
+000193d0: 7661 6c69 645f 6372 6f6e 2873 6368 6564  valid_cron(sched
+000193e0: 756c 655f 6372 6f6e 3d73 6368 6564 756c  ule_cron=schedul
+000193f0: 655f 6372 6f6e 2929 0a0a 2020 2020 6966  e_cron))..    if
+00019400: 2070 6970 655f 7479 7065 203d 3d20 5069   pipe_type == Pi
+00019410: 7065 5479 7065 732e 454e 4450 4f49 4e54  peTypes.ENDPOINT
+00019420: 3a0a 2020 2020 2020 2020 6177 6169 7420  :.        await 
+00019430: 7462 5f63 6c69 656e 742e 7069 7065 5f72  tb_client.pipe_r
+00019440: 656d 6f76 655f 656e 6470 6f69 6e74 2870  emove_endpoint(p
+00019450: 6970 655f 6e61 6d65 2c20 7069 7065 5b22  ipe_name, pipe["
+00019460: 656e 6470 6f69 6e74 225d 290a 0a20 2020  endpoint"])..   
+00019470: 2069 6620 7069 7065 5f74 7970 6520 3d3d   if pipe_type ==
+00019480: 2050 6970 6554 7970 6573 2e43 4f50 593a   PipeTypes.COPY:
+00019490: 0a20 2020 2020 2020 2061 7761 6974 2074  .        await t
+000194a0: 625f 636c 6965 6e74 2e70 6970 655f 7265  b_client.pipe_re
+000194b0: 6d6f 7665 5f63 6f70 7928 7069 7065 5f6e  move_copy(pipe_n
+000194c0: 616d 652c 2070 6970 655b 2263 6f70 795f  ame, pipe["copy_
+000194d0: 6e6f 6465 225d 290a 0a0a 6465 6620 7368  node"])...def sh
+000194e0: 6f77 5f6d 6174 6572 6961 6c69 7a65 645f  ow_materialized_
+000194f0: 7669 6577 5f77 6172 6e69 6e67 7328 7761  view_warnings(wa
+00019500: 726e 696e 6773 293a 0a20 2020 2022 2222  rnings):.    """
+00019510: 0a20 2020 203e 3e3e 2073 686f 775f 6d61  .    >>> show_ma
+00019520: 7465 7269 616c 697a 6564 5f76 6965 775f  terialized_view_
+00019530: 7761 726e 696e 6773 285b 7b27 636f 6465  warnings([{'code
+00019540: 273a 2027 5349 4d27 2c20 2777 6569 6768  ': 'SIM', 'weigh
+00019550: 7427 3a20 317d 5d29 0a0a 2020 2020 3e3e  t': 1}])..    >>
+00019560: 3e20 7368 6f77 5f6d 6174 6572 6961 6c69  > show_materiali
+00019570: 7a65 645f 7669 6577 5f77 6172 6e69 6e67  zed_view_warning
+00019580: 7328 5b7b 2763 6f64 6527 3a20 2753 494d  s([{'code': 'SIM
+00019590: 272c 2027 7765 6967 6874 273a 2031 7d2c  ', 'weight': 1},
+000195a0: 207b 2763 6f64 6527 3a20 2748 5547 455f   {'code': 'HUGE_
+000195b0: 4a4f 494e 272c 2027 7765 6967 6874 273a  JOIN', 'weight':
+000195c0: 2032 7d2c 207b 2774 6578 7427 3a20 2243   2}, {'text': "C
+000195d0: 6f6c 756d 6e20 276e 756d 6265 7227 2069  olumn 'number' i
+000195e0: 7320 7072 6573 656e 7420 696e 2074 6865  s present in the
+000195f0: 2047 524f 5550 2042 5920 6275 7420 6e6f   GROUP BY but no
+00019600: 7420 696e 2074 6865 2053 454c 4543 5420  t in the SELECT 
+00019610: 636c 6175 7365 2e20 5468 6973 206d 6967  clause. This mig
+00019620: 6874 2069 6e64 6963 6174 6520 6120 6e6f  ht indicate a no
+00019630: 7420 7661 6c69 6420 4d61 7465 7269 616c  t valid Material
+00019640: 697a 6564 2056 6965 772c 2070 6c65 6173  ized View, pleas
+00019650: 6520 6d61 6b65 2073 7572 6520 796f 7520  e make sure you 
+00019660: 6167 6772 6567 6174 6520 616e 6420 4752  aggregate and GR
+00019670: 4f55 5020 4259 2069 6e20 7468 6520 746f  OUP BY in the to
+00019680: 706d 6f73 7420 7175 6572 792e 222c 2027  pmost query.", '
+00019690: 636f 6465 273a 2027 4752 4f55 505f 4259  code': 'GROUP_BY
+000196a0: 272c 2027 7765 6967 6874 273a 2031 3030  ', 'weight': 100
+000196b0: 2c20 2764 6f63 756d 656e 7461 7469 6f6e  , 'documentation
+000196c0: 273a 2027 6874 7470 733a 2f2f 7469 6e79  ': 'https://tiny
+000196d0: 6269 7264 2e63 6f2f 646f 6373 2f67 7569  bird.co/docs/gui
+000196e0: 6465 732f 6d61 7465 7269 616c 697a 6564  des/materialized
+000196f0: 2d76 6965 7773 2e68 746d 6c23 7573 652d  -views.html#use-
+00019700: 7468 652d 7361 6d65 2d61 6c69 6173 2d69  the-same-alias-i
+00019710: 6e2d 7365 6c65 6374 2d61 6e64 2d67 726f  n-select-and-gro
+00019720: 7570 2d62 7927 7d5d 290a 2020 2020 e29a  up-by'}]).    ..
+00019730: a0ef b88f 2020 436f 6c75 6d6e 2027 6e75  ....  Column 'nu
+00019740: 6d62 6572 2720 6973 2070 7265 7365 6e74  mber' is present
+00019750: 2069 6e20 7468 6520 4752 4f55 5020 4259   in the GROUP BY
+00019760: 2062 7574 206e 6f74 2069 6e20 7468 6520   but not in the 
+00019770: 5345 4c45 4354 2063 6c61 7573 652e 2054  SELECT clause. T
+00019780: 6869 7320 6d69 6768 7420 696e 6469 6361  his might indica
+00019790: 7465 2061 206e 6f74 2076 616c 6964 204d  te a not valid M
+000197a0: 6174 6572 6961 6c69 7a65 6420 5669 6577  aterialized View
+000197b0: 2c20 706c 6561 7365 206d 616b 6520 7375  , please make su
+000197c0: 7265 2079 6f75 2061 6767 7265 6761 7465  re you aggregate
+000197d0: 2061 6e64 2047 524f 5550 2042 5920 696e   and GROUP BY in
+000197e0: 2074 6865 2074 6f70 6d6f 7374 2071 7565   the topmost que
+000197f0: 7279 2e20 466f 7220 6d6f 7265 2069 6e66  ry. For more inf
+00019800: 6f72 6d61 7469 6f6e 2072 6561 6420 6874  ormation read ht
+00019810: 7470 733a 2f2f 7469 6e79 6269 7264 2e63  tps://tinybird.c
+00019820: 6f2f 646f 6373 2f67 7569 6465 732f 6d61  o/docs/guides/ma
+00019830: 7465 7269 616c 697a 6564 2d76 6965 7773  terialized-views
+00019840: 2e68 746d 6c23 7573 652d 7468 652d 7361  .html#use-the-sa
+00019850: 6d65 2d61 6c69 6173 2d69 6e2d 7365 6c65  me-alias-in-sele
+00019860: 6374 2d61 6e64 2d67 726f 7570 2d62 7920  ct-and-group-by 
+00019870: 6f72 2063 6f6e 7461 6374 2075 7320 6174  or contact us at
+00019880: 2073 7570 706f 7274 4074 696e 7962 6972   support@tinybir
+00019890: 642e 636f 0a20 2020 203e 3e3e 2073 686f  d.co.    >>> sho
+000198a0: 775f 6d61 7465 7269 616c 697a 6564 5f76  w_materialized_v
+000198b0: 6965 775f 7761 726e 696e 6773 285b 7b27  iew_warnings([{'
+000198c0: 636f 6465 273a 2027 5349 4e47 4c45 5f4a  code': 'SINGLE_J
+000198d0: 4f49 4e27 2c20 2777 6569 6768 7427 3a20  OIN', 'weight': 
+000198e0: 3330 307d 2c20 7b27 7465 7874 273a 2022  300}, {'text': "
+000198f0: 436f 6c75 6d6e 2027 6e75 6d62 6572 2720  Column 'number' 
+00019900: 6973 2070 7265 7365 6e74 2069 6e20 7468  is present in th
+00019910: 6520 4752 4f55 5020 4259 2062 7574 206e  e GROUP BY but n
+00019920: 6f74 2069 6e20 7468 6520 5345 4c45 4354  ot in the SELECT
+00019930: 2063 6c61 7573 652e 2054 6869 7320 6d69   clause. This mi
+00019940: 6768 7420 696e 6469 6361 7465 2061 206e  ght indicate a n
+00019950: 6f74 2076 616c 6964 204d 6174 6572 6961  ot valid Materia
+00019960: 6c69 7a65 6420 5669 6577 2c20 706c 6561  lized View, plea
+00019970: 7365 206d 616b 6520 7375 7265 2079 6f75  se make sure you
+00019980: 2061 6767 7265 6761 7465 2061 6e64 2047   aggregate and G
+00019990: 524f 5550 2042 5920 696e 2074 6865 2074  ROUP BY in the t
+000199a0: 6f70 6d6f 7374 2071 7565 7279 2e22 2c20  opmost query.", 
+000199b0: 2763 6f64 6527 3a20 2747 524f 5550 5f42  'code': 'GROUP_B
+000199c0: 5927 2c20 2777 6569 6768 7427 3a20 3130  Y', 'weight': 10
+000199d0: 302c 2027 646f 6375 6d65 6e74 6174 696f  0, 'documentatio
+000199e0: 6e27 3a20 2768 7474 7073 3a2f 2f74 696e  n': 'https://tin
+000199f0: 7962 6972 642e 636f 2f64 6f63 732f 6775  ybird.co/docs/gu
+00019a00: 6964 6573 2f6d 6174 6572 6961 6c69 7a65  ides/materialize
+00019a10: 642d 7669 6577 732e 6874 6d6c 2375 7365  d-views.html#use
+00019a20: 2d74 6865 2d73 616d 652d 616c 6961 732d  -the-same-alias-
+00019a30: 696e 2d73 656c 6563 742d 616e 642d 6772  in-select-and-gr
+00019a40: 6f75 702d 6279 277d 5d29 0a20 2020 20e2  oup-by'}]).    .
+00019a50: 9aa0 efb8 8f20 2043 6f6c 756d 6e20 276e  .....  Column 'n
+00019a60: 756d 6265 7227 2069 7320 7072 6573 656e  umber' is presen
+00019a70: 7420 696e 2074 6865 2047 524f 5550 2042  t in the GROUP B
+00019a80: 5920 6275 7420 6e6f 7420 696e 2074 6865  Y but not in the
+00019a90: 2053 454c 4543 5420 636c 6175 7365 2e20   SELECT clause. 
+00019aa0: 5468 6973 206d 6967 6874 2069 6e64 6963  This might indic
+00019ab0: 6174 6520 6120 6e6f 7420 7661 6c69 6420  ate a not valid 
+00019ac0: 4d61 7465 7269 616c 697a 6564 2056 6965  Materialized Vie
+00019ad0: 772c 2070 6c65 6173 6520 6d61 6b65 2073  w, please make s
+00019ae0: 7572 6520 796f 7520 6167 6772 6567 6174  ure you aggregat
+00019af0: 6520 616e 6420 4752 4f55 5020 4259 2069  e and GROUP BY i
+00019b00: 6e20 7468 6520 746f 706d 6f73 7420 7175  n the topmost qu
+00019b10: 6572 792e 2046 6f72 206d 6f72 6520 696e  ery. For more in
+00019b20: 666f 726d 6174 696f 6e20 7265 6164 2068  formation read h
+00019b30: 7474 7073 3a2f 2f74 696e 7962 6972 642e  ttps://tinybird.
+00019b40: 636f 2f64 6f63 732f 6775 6964 6573 2f6d  co/docs/guides/m
+00019b50: 6174 6572 6961 6c69 7a65 642d 7669 6577  aterialized-view
+00019b60: 732e 6874 6d6c 2375 7365 2d74 6865 2d73  s.html#use-the-s
+00019b70: 616d 652d 616c 6961 732d 696e 2d73 656c  ame-alias-in-sel
+00019b80: 6563 742d 616e 642d 6772 6f75 702d 6279  ect-and-group-by
+00019b90: 206f 7220 636f 6e74 6163 7420 7573 2061   or contact us a
+00019ba0: 7420 7375 7070 6f72 7440 7469 6e79 6269  t support@tinybi
+00019bb0: 7264 2e63 6f0a 2020 2020 2222 220a 2020  rd.co.    """.  
+00019bc0: 2020 6578 636c 7564 6564 5f77 6172 6e69    excluded_warni
+00019bd0: 6e67 7320 3d20 5b22 5349 4d22 2c20 2253  ngs = ["SIM", "S
+00019be0: 494d 5f55 4e4b 4e4f 574e 222c 2022 4855  IM_UNKNOWN", "HU
+00019bf0: 4745 5f4a 4f49 4e22 5d0a 2020 2020 736f  GE_JOIN"].    so
+00019c00: 7274 6564 5f77 6172 6e69 6e67 7320 3d20  rted_warnings = 
+00019c10: 736f 7274 6564 2877 6172 6e69 6e67 732c  sorted(warnings,
+00019c20: 206b 6579 3d6c 616d 6264 6120 7761 726e   key=lambda warn
+00019c30: 696e 673a 2077 6172 6e69 6e67 5b22 7765  ing: warning["we
+00019c40: 6967 6874 225d 290a 2020 2020 6d6f 7374  ight"]).    most
+00019c50: 5f69 6d70 6f72 7461 6e74 5f77 6172 6e69  _important_warni
+00019c60: 6e67 203d 207b 7d0a 2020 2020 666f 7220  ng = {}.    for 
+00019c70: 7761 726e 696e 6720 696e 2073 6f72 7465  warning in sorte
+00019c80: 645f 7761 726e 696e 6773 3a0a 2020 2020  d_warnings:.    
+00019c90: 2020 2020 6966 2077 6172 6e69 6e67 2e67      if warning.g
+00019ca0: 6574 2822 636f 6465 2229 2061 6e64 2077  et("code") and w
+00019cb0: 6172 6e69 6e67 5b22 636f 6465 225d 206e  arning["code"] n
+00019cc0: 6f74 2069 6e20 6578 636c 7564 6564 5f77  ot in excluded_w
+00019cd0: 6172 6e69 6e67 733a 0a20 2020 2020 2020  arnings:.       
+00019ce0: 2020 2020 206d 6f73 745f 696d 706f 7274       most_import
+00019cf0: 616e 745f 7761 726e 696e 6720 3d20 7761  ant_warning = wa
+00019d00: 726e 696e 670a 2020 2020 2020 2020 2020  rning.          
+00019d10: 2020 6272 6561 6b0a 2020 2020 6966 206d    break.    if m
+00019d20: 6f73 745f 696d 706f 7274 616e 745f 7761  ost_important_wa
+00019d30: 726e 696e 673a 0a20 2020 2020 2020 2063  rning:.        c
+00019d40: 6c69 636b 2e65 6368 6f28 0a20 2020 2020  lick.echo(.     
+00019d50: 2020 2020 2020 2046 6565 6462 6163 6b4d         FeedbackM
+00019d60: 616e 6167 6572 2e73 696e 676c 655f 7761  anager.single_wa
+00019d70: 726e 696e 675f 6d61 7465 7269 616c 697a  rning_materializ
+00019d80: 6564 5f70 6970 6528 0a20 2020 2020 2020  ed_pipe(.       
+00019d90: 2020 2020 2020 2020 2063 6f6e 7465 6e74           content
+00019da0: 3d6d 6f73 745f 696d 706f 7274 616e 745f  =most_important_
+00019db0: 7761 726e 696e 675b 2274 6578 7422 5d2c  warning["text"],
+00019dc0: 2064 6f63 735f 7572 6c3d 6d6f 7374 5f69   docs_url=most_i
+00019dd0: 6d70 6f72 7461 6e74 5f77 6172 6e69 6e67  mportant_warning
+00019de0: 5b22 646f 6375 6d65 6e74 6174 696f 6e22  ["documentation"
+00019df0: 5d0a 2020 2020 2020 2020 2020 2020 290a  ].            ).
+00019e00: 2020 2020 2020 2020 290a 0a0a 6173 796e          )...asyn
+00019e10: 6320 6465 6620 6765 745f 746f 6b65 6e5f  c def get_token_
+00019e20: 6672 6f6d 5f6d 6169 6e5f 6272 616e 6368  from_main_branch
+00019e30: 2862 7261 6e63 685f 7462 5f63 6c69 656e  (branch_tb_clien
+00019e40: 743a 2054 696e 7942 2920 2d3e 204f 7074  t: TinyB) -> Opt
+00019e50: 696f 6e61 6c5b 7374 725d 3a0a 2020 2020  ional[str]:.    
+00019e60: 746f 6b65 6e5f 6672 6f6d 5f6d 6169 6e5f  token_from_main_
+00019e70: 6272 616e 6368 203d 204e 6f6e 650a 2020  branch = None.  
+00019e80: 2020 6375 7272 656e 745f 776f 726b 7370    current_worksp
+00019e90: 6163 6520 3d20 6177 6169 7420 6272 616e  ace = await bran
+00019ea0: 6368 5f74 625f 636c 6965 6e74 2e77 6f72  ch_tb_client.wor
+00019eb0: 6b73 7061 6365 5f69 6e66 6f28 290a 2020  kspace_info().  
+00019ec0: 2020 2320 6375 7272 656e 7420 776f 726b    # current work
+00019ed0: 7370 6163 6520 6973 2061 2062 7261 6e63  space is a branc
+00019ee0: 680a 2020 2020 6966 2063 7572 7265 6e74  h.    if current
+00019ef0: 5f77 6f72 6b73 7061 6365 2e67 6574 2822  _workspace.get("
+00019f00: 6d61 696e 2229 3a0a 2020 2020 2020 2020  main"):.        
+00019f10: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
+00019f20: 2062 7261 6e63 685f 7462 5f63 6c69 656e   branch_tb_clien
+00019f30: 742e 7573 6572 5f77 6f72 6b73 7061 6365  t.user_workspace
+00019f40: 7328 290a 2020 2020 2020 2020 776f 726b  s().        work
+00019f50: 7370 6163 6573 203d 2072 6573 706f 6e73  spaces = respons
+00019f60: 655b 2277 6f72 6b73 7061 6365 7322 5d0a  e["workspaces"].
+00019f70: 2020 2020 2020 2020 7072 6f64 5f77 6f72          prod_wor
+00019f80: 6b73 7061 6365 203d 206e 6578 7428 0a20  kspace = next(. 
+00019f90: 2020 2020 2020 2020 2020 2028 776f 726b             (work
+00019fa0: 7370 6163 6520 666f 7220 776f 726b 7370  space for worksp
+00019fb0: 6163 6520 696e 2077 6f72 6b73 7061 6365  ace in workspace
+00019fc0: 7320 6966 2077 6f72 6b73 7061 6365 5b22  s if workspace["
+00019fd0: 6964 225d 203d 3d20 6375 7272 656e 745f  id"] == current_
+00019fe0: 776f 726b 7370 6163 655b 226d 6169 6e22  workspace["main"
+00019ff0: 5d29 2c20 4e6f 6e65 0a20 2020 2020 2020  ]), None.       
+0001a000: 2029 0a20 2020 2020 2020 2069 6620 7072   ).        if pr
+0001a010: 6f64 5f77 6f72 6b73 7061 6365 3a0a 2020  od_workspace:.  
+0001a020: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+0001a030: 6672 6f6d 5f6d 6169 6e5f 6272 616e 6368  from_main_branch
+0001a040: 203d 2070 726f 645f 776f 726b 7370 6163   = prod_workspac
+0001a050: 652e 6765 7428 2274 6f6b 656e 2229 0a20  e.get("token"). 
+0001a060: 2020 2072 6574 7572 6e20 746f 6b65 6e5f     return token_
+0001a070: 6672 6f6d 5f6d 6169 6e5f 6272 616e 6368  from_main_branch
+0001a080: 0a0a 0a61 7379 6e63 2064 6566 206e 6577  ...async def new
+0001a090: 5f70 6970 6528 0a20 2020 2070 2c0a 2020  _pipe(.    p,.  
+0001a0a0: 2020 7462 5f63 6c69 656e 743a 2054 696e    tb_client: Tin
+0001a0b0: 7942 2c0a 2020 2020 666f 7263 653a 2062  yB,.    force: b
+0001a0c0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+0001a0d0: 2063 6865 636b 3a20 626f 6f6c 203d 2054   check: bool = T
+0001a0e0: 7275 652c 0a20 2020 2070 6f70 756c 6174  rue,.    populat
+0001a0f0: 653a 2062 6f6f 6c20 3d20 4661 6c73 652c  e: bool = False,
+0001a100: 0a20 2020 2070 6f70 756c 6174 655f 7375  .    populate_su
+0001a110: 6273 6574 3d4e 6f6e 652c 0a20 2020 2070  bset=None,.    p
+0001a120: 6f70 756c 6174 655f 636f 6e64 6974 696f  opulate_conditio
+0001a130: 6e3d 4e6f 6e65 2c0a 2020 2020 756e 6c69  n=None,.    unli
+0001a140: 6e6b 5f6f 6e5f 706f 7075 6c61 7465 5f65  nk_on_populate_e
+0001a150: 7272 6f72 3a20 626f 6f6c 203d 2046 616c  rror: bool = Fal
+0001a160: 7365 2c0a 2020 2020 7761 6974 5f70 6f70  se,.    wait_pop
+0001a170: 756c 6174 653a 2062 6f6f 6c20 3d20 4661  ulate: bool = Fa
+0001a180: 6c73 652c 0a20 2020 2073 6b69 705f 746f  lse,.    skip_to
+0001a190: 6b65 6e73 3a20 626f 6f6c 203d 2046 616c  kens: bool = Fal
+0001a1a0: 7365 2c0a 2020 2020 6967 6e6f 7265 5f73  se,.    ignore_s
+0001a1b0: 716c 5f65 7272 6f72 733a 2062 6f6f 6c20  ql_errors: bool 
+0001a1c0: 3d20 4661 6c73 652c 0a20 2020 206f 6e6c  = False,.    onl
+0001a1d0: 795f 7265 7370 6f6e 7365 5f74 696d 6573  y_response_times
 0001a1e0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-0001a1f0: 2020 2020 6f76 6572 7269 6465 5f64 6174      override_dat
-0001a200: 6173 6f75 7263 653a 2062 6f6f 6c20 3d20  asource: bool = 
-0001a210: 4661 6c73 652c 0a20 2020 2074 6573 7473  False,.    tests
-0001a220: 5f63 6865 636b 5f72 6571 7565 7374 735f  _check_requests_
-0001a230: 6672 6f6d 5f62 7261 6e63 683a 2062 6f6f  from_branch: boo
-0001a240: 6c20 3d20 4661 6c73 652c 0a20 2020 2063  l = False,.    c
-0001a250: 6f6e 6669 673a 2041 6e79 203d 204e 6f6e  onfig: Any = Non
-0001a260: 652c 0a20 2020 2066 6f72 6b5f 646f 776e  e,.    fork_down
-0001a270: 7374 7265 616d 3a20 4f70 7469 6f6e 616c  stream: Optional
-0001a280: 5b62 6f6f 6c5d 203d 2046 616c 7365 2c0a  [bool] = False,.
-0001a290: 2020 2020 666f 726b 3a20 4f70 7469 6f6e      fork: Option
-0001a2a0: 616c 5b62 6f6f 6c5d 203d 2046 616c 7365  al[bool] = False
-0001a2b0: 2c0a 293a 2020 2320 6e6f 7161 3a20 4339  ,.):  # noqa: C9
-0001a2c0: 3031 0a20 2020 2023 2054 4f44 4f20 7573  01.    # TODO us
-0001a2d0: 6520 7462 5f63 6c69 656e 7420 696e 7374  e tb_client inst
-0001a2e0: 6561 6420 6f66 2063 616c 6c69 6e67 2074  ead of calling t
-0001a2f0: 6865 2075 726c 7320 6469 7265 6374 6c79  he urls directly
-0001a300: 2e0a 2020 2020 686f 7374 203d 2074 625f  ..    host = tb_
-0001a310: 636c 6965 6e74 2e68 6f73 740a 2020 2020  client.host.    
-0001a320: 746f 6b65 6e20 3d20 7462 5f63 6c69 656e  token = tb_clien
-0001a330: 742e 746f 6b65 6e0a 0a20 2020 2068 6561  t.token..    hea
-0001a340: 6465 7273 203d 207b 2241 7574 686f 7269  ders = {"Authori
-0001a350: 7a61 7469 6f6e 223a 2066 2242 6561 7265  zation": f"Beare
-0001a360: 7220 7b74 6f6b 656e 7d22 7d0a 0a20 2020  r {token}"}..   
-0001a370: 2063 6c69 5f70 6172 616d 7320 3d20 7b7d   cli_params = {}
-0001a380: 0a20 2020 2063 6c69 5f70 6172 616d 735b  .    cli_params[
-0001a390: 2263 6c69 5f76 6572 7369 6f6e 225d 203d  "cli_version"] =
-0001a3a0: 2074 625f 636c 6965 6e74 2e76 6572 7369   tb_client.versi
-0001a3b0: 6f6e 0a20 2020 2063 6c69 5f70 6172 616d  on.    cli_param
-0001a3c0: 735b 2264 6573 6372 6970 7469 6f6e 225d  s["description"]
-0001a3d0: 203d 2070 2e67 6574 2822 6465 7363 7269   = p.get("descri
-0001a3e0: 7074 696f 6e22 2c20 2222 290a 2020 2020  ption", "").    
-0001a3f0: 636c 695f 7061 7261 6d73 5b22 6967 6e6f  cli_params["igno
-0001a400: 7265 5f73 716c 5f65 7272 6f72 7322 5d20  re_sql_errors"] 
-0001a410: 3d20 2274 7275 6522 2069 6620 6967 6e6f  = "true" if igno
-0001a420: 7265 5f73 716c 5f65 7272 6f72 7320 656c  re_sql_errors el
-0001a430: 7365 2022 6661 6c73 6522 0a0a 2020 2020  se "false"..    
-0001a440: 723a 2072 6571 7565 7374 732e 5265 7370  r: requests.Resp
-0001a450: 6f6e 7365 203d 2061 7761 6974 2072 6571  onse = await req
-0001a460: 7565 7374 735f 6765 7428 6622 7b68 6f73  uests_get(f"{hos
-0001a470: 747d 2f76 302f 7069 7065 732f 7b70 5b27  t}/v0/pipes/{p['
-0001a480: 6e61 6d65 275d 7d3f 7b75 726c 656e 636f  name']}?{urlenco
-0001a490: 6465 2863 6c69 5f70 6172 616d 7329 7d22  de(cli_params)}"
-0001a4a0: 2c20 6865 6164 6572 733d 6865 6164 6572  , headers=header
-0001a4b0: 7329 0a0a 2020 2020 6375 7272 656e 745f  s)..    current_
-0001a4c0: 7069 7065 203d 2072 2e6a 736f 6e28 2920  pipe = r.json() 
-0001a4d0: 6966 2072 2e73 7461 7475 735f 636f 6465  if r.status_code
-0001a4e0: 203d 3d20 3230 3020 656c 7365 204e 6f6e   == 200 else Non
-0001a4f0: 650a 2020 2020 7069 7065 5f65 7869 7374  e.    pipe_exist
-0001a500: 7320 3d20 6375 7272 656e 745f 7069 7065  s = current_pipe
-0001a510: 2069 7320 6e6f 7420 4e6f 6e65 0a0a 2020   is not None..  
-0001a520: 2020 6973 5f6d 6174 6572 6961 6c69 7a65    is_materialize
-0001a530: 6420 3d20 616e 7928 5b6e 6f64 652e 6765  d = any([node.ge
-0001a540: 7428 2270 6172 616d 7322 2c20 7b7d 292e  t("params", {}).
-0001a550: 6765 7428 2274 7970 6522 2c20 4e6f 6e65  get("type", None
-0001a560: 2920 3d3d 2022 6d61 7465 7269 616c 697a  ) == "materializ
-0001a570: 6564 2220 666f 7220 6e6f 6465 2069 6e20  ed" for node in 
-0001a580: 705b 226e 6f64 6573 225d 5d29 0a20 2020  p["nodes"]]).   
-0001a590: 2063 6f70 795f 6e6f 6465 203d 206e 6578   copy_node = nex
-0001a5a0: 7428 286e 6f64 6520 666f 7220 6e6f 6465  t((node for node
-0001a5b0: 2069 6e20 705b 226e 6f64 6573 225d 2069   in p["nodes"] i
-0001a5c0: 6620 6e6f 6465 2e67 6574 2822 7061 7261  f node.get("para
-0001a5d0: 6d73 222c 207b 7d29 2e67 6574 2822 7479  ms", {}).get("ty
-0001a5e0: 7065 222c 204e 6f6e 6529 203d 3d20 2263  pe", None) == "c
-0001a5f0: 6f70 7922 292c 204e 6f6e 6529 0a20 2020  opy"), None).   
-0001a600: 2073 696e 6b5f 6e6f 6465 203d 206e 6578   sink_node = nex
-0001a610: 7428 286e 6f64 6520 666f 7220 6e6f 6465  t((node for node
-0001a620: 2069 6e20 705b 226e 6f64 6573 225d 2069   in p["nodes"] i
-0001a630: 6620 6e6f 6465 2e67 6574 2822 7061 7261  f node.get("para
-0001a640: 6d73 222c 207b 7d29 2e67 6574 2822 7479  ms", {}).get("ty
-0001a650: 7065 222c 204e 6f6e 6529 203d 3d20 2273  pe", None) == "s
-0001a660: 696e 6b22 292c 204e 6f6e 6529 0a0a 2020  ink"), None)..  
-0001a670: 2020 6966 2070 6970 655f 6578 6973 7473    if pipe_exists
-0001a680: 3a0a 2020 2020 2020 2020 6966 2066 6f72  :.        if for
-0001a690: 6365 206f 7220 7275 6e5f 7465 7374 733a  ce or run_tests:
-0001a6a0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-0001a6b0: 4f44 4f3a 2074 6869 7320 7368 6f75 6c64  ODO: this should
-0001a6c0: 2063 7265 6174 6520 6120 6469 6666 6572   create a differ
-0001a6d0: 656e 7420 6e6f 6465 2061 6e64 2072 656e  ent node and ren
-0001a6e0: 616d 6520 6974 2074 6f20 7468 6520 6669  ame it to the fi
-0001a6f0: 6e61 6c20 6f6e 6520 6f6e 2073 7563 6365  nal one on succe
-0001a700: 7373 0a20 2020 2020 2020 2020 2020 2069  ss.            i
-0001a710: 6620 6368 6563 6b20 616e 6420 6e6f 7420  f check and not 
-0001a720: 706f 7075 6c61 7465 3a0a 2020 2020 2020  populate:.      
-0001a730: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0001a740: 2069 735f 6d61 7465 7269 616c 697a 6564   is_materialized
-0001a750: 2061 6e64 206e 6f74 2063 6f70 795f 6e6f   and not copy_no
-0001a760: 6465 2061 6e64 206e 6f74 2073 696e 6b5f  de and not sink_
-0001a770: 6e6f 6465 3a0a 2020 2020 2020 2020 2020  node:.          
-0001a780: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0001a790: 6368 6563 6b5f 7069 7065 280a 2020 2020  check_pipe(.    
-0001a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a7b0: 2020 2020 702c 0a20 2020 2020 2020 2020      p,.         
-0001a7c0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0001a7d0: 6f73 742c 0a20 2020 2020 2020 2020 2020  ost,.           
-0001a7e0: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
-0001a7f0: 656e 2c0a 2020 2020 2020 2020 2020 2020  en,.            
-0001a800: 2020 2020 2020 2020 2020 2020 706f 7075              popu
-0001a810: 6c61 7465 2c0a 2020 2020 2020 2020 2020  late,.          
-0001a820: 2020 2020 2020 2020 2020 2020 2020 7462                tb
-0001a830: 5f63 6c69 656e 742c 0a20 2020 2020 2020  _client,.       
-0001a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a850: 206f 6e6c 795f 7265 7370 6f6e 7365 5f74   only_response_t
-0001a860: 696d 6573 3d6f 6e6c 795f 7265 7370 6f6e  imes=only_respon
-0001a870: 7365 5f74 696d 6573 2c0a 2020 2020 2020  se_times,.      
-0001a880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a890: 2020 6c69 6d69 743d 7465 7374 735f 746f    limit=tests_to
-0001a8a0: 5f72 756e 2c0a 2020 2020 2020 2020 2020  _run,.          
-0001a8b0: 2020 2020 2020 2020 2020 2020 2020 7361                sa
-0001a8c0: 6d70 6c65 5f62 795f 7061 7261 6d73 3d74  mple_by_params=t
-0001a8d0: 6573 7473 5f74 6f5f 7361 6d70 6c65 5f62  ests_to_sample_b
-0001a8e0: 795f 7061 7261 6d73 2c0a 2020 2020 2020  y_params,.      
-0001a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a900: 2020 6d61 7463 6865 733d 7465 7374 735f    matches=tests_
-0001a910: 6669 6c74 6572 5f62 792c 0a20 2020 2020  filter_by,.     
-0001a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a930: 2020 2066 6169 6c66 6173 743d 7465 7374     failfast=test
-0001a940: 735f 6661 696c 6661 7374 2c0a 2020 2020  s_failfast,.    
-0001a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a960: 2020 2020 7661 6c69 6461 7465 5f70 726f      validate_pro
-0001a970: 6365 7373 6564 5f62 7974 6573 3d74 6573  cessed_bytes=tes
-0001a980: 7473 5f76 616c 6964 6174 655f 7072 6f63  ts_validate_proc
-0001a990: 6573 7365 645f 6279 7465 732c 0a20 2020  essed_bytes,.   
-0001a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9b0: 2020 2020 2069 676e 6f72 655f 6f72 6465       ignore_orde
-0001a9c0: 723d 7465 7374 735f 6967 6e6f 7265 5f6f  r=tests_ignore_o
-0001a9d0: 7264 6572 2c0a 2020 2020 2020 2020 2020  rder,.          
-0001a9e0: 2020 2020 2020 2020 2020 2020 2020 746f                to
-0001a9f0: 6b65 6e5f 666f 725f 7265 7175 6573 7473  ken_for_requests
-0001aa00: 5f74 6f5f 6368 6563 6b3d 280a 2020 2020  _to_check=(.    
-0001aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa20: 2020 2020 2020 2020 6177 6169 7420 6765          await ge
-0001aa30: 745f 746f 6b65 6e5f 6672 6f6d 5f6d 6169  t_token_from_mai
-0001aa40: 6e5f 6272 616e 6368 2874 625f 636c 6965  n_branch(tb_clie
-0001aa50: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-0001aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa70: 6966 206e 6f74 2074 6573 7473 5f63 6865  if not tests_che
-0001aa80: 636b 5f72 6571 7565 7374 735f 6672 6f6d  ck_requests_from
-0001aa90: 5f62 7261 6e63 680a 2020 2020 2020 2020  _branch.        
-0001aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aab0: 2020 2020 656c 7365 204e 6f6e 650a 2020      else None.  
-0001aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aad0: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
+0001a1f0: 2020 2020 7469 6d65 6f75 743d 4e6f 6e65      timeout=None
+0001a200: 2c0a 2020 2020 7275 6e5f 7465 7374 733a  ,.    run_tests:
+0001a210: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+0001a220: 2020 2061 735f 7374 616e 6461 7264 3a20     as_standard: 
+0001a230: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+0001a240: 2020 7465 7374 735f 746f 5f72 756e 3a20    tests_to_run: 
+0001a250: 696e 7420 3d20 302c 0a20 2020 2074 6573  int = 0,.    tes
+0001a260: 7473 5f74 6f5f 7361 6d70 6c65 5f62 795f  ts_to_sample_by_
+0001a270: 7061 7261 6d73 3a20 696e 7420 3d20 302c  params: int = 0,
+0001a280: 0a20 2020 2074 6573 7473 5f66 696c 7465  .    tests_filte
+0001a290: 725f 6279 3a20 4f70 7469 6f6e 616c 5b4c  r_by: Optional[L
+0001a2a0: 6973 745b 7374 725d 5d20 3d20 4e6f 6e65  ist[str]] = None
+0001a2b0: 2c0a 2020 2020 7465 7374 735f 6661 696c  ,.    tests_fail
+0001a2c0: 6661 7374 3a20 626f 6f6c 203d 2046 616c  fast: bool = Fal
+0001a2d0: 7365 2c0a 2020 2020 7465 7374 735f 6967  se,.    tests_ig
+0001a2e0: 6e6f 7265 5f6f 7264 6572 3a20 626f 6f6c  nore_order: bool
+0001a2f0: 203d 2046 616c 7365 2c0a 2020 2020 7465   = False,.    te
+0001a300: 7374 735f 7661 6c69 6461 7465 5f70 726f  sts_validate_pro
+0001a310: 6365 7373 6564 5f62 7974 6573 3a20 626f  cessed_bytes: bo
+0001a320: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+0001a330: 6f76 6572 7269 6465 5f64 6174 6173 6f75  override_datasou
+0001a340: 7263 653a 2062 6f6f 6c20 3d20 4661 6c73  rce: bool = Fals
+0001a350: 652c 0a20 2020 2074 6573 7473 5f63 6865  e,.    tests_che
+0001a360: 636b 5f72 6571 7565 7374 735f 6672 6f6d  ck_requests_from
+0001a370: 5f62 7261 6e63 683a 2062 6f6f 6c20 3d20  _branch: bool = 
+0001a380: 4661 6c73 652c 0a20 2020 2063 6f6e 6669  False,.    confi
+0001a390: 673a 2041 6e79 203d 204e 6f6e 652c 0a20  g: Any = None,. 
+0001a3a0: 2020 2066 6f72 6b5f 646f 776e 7374 7265     fork_downstre
+0001a3b0: 616d 3a20 4f70 7469 6f6e 616c 5b62 6f6f  am: Optional[boo
+0001a3c0: 6c5d 203d 2046 616c 7365 2c0a 2020 2020  l] = False,.    
+0001a3d0: 666f 726b 3a20 4f70 7469 6f6e 616c 5b62  fork: Optional[b
+0001a3e0: 6f6f 6c5d 203d 2046 616c 7365 2c0a 293a  ool] = False,.):
+0001a3f0: 2020 2320 6e6f 7161 3a20 4339 3031 0a20    # noqa: C901. 
+0001a400: 2020 2023 2054 4f44 4f20 7573 6520 7462     # TODO use tb
+0001a410: 5f63 6c69 656e 7420 696e 7374 6561 6420  _client instead 
+0001a420: 6f66 2063 616c 6c69 6e67 2074 6865 2075  of calling the u
+0001a430: 726c 7320 6469 7265 6374 6c79 2e0a 2020  rls directly..  
+0001a440: 2020 686f 7374 203d 2074 625f 636c 6965    host = tb_clie
+0001a450: 6e74 2e68 6f73 740a 2020 2020 746f 6b65  nt.host.    toke
+0001a460: 6e20 3d20 7462 5f63 6c69 656e 742e 746f  n = tb_client.to
+0001a470: 6b65 6e0a 0a20 2020 2068 6561 6465 7273  ken..    headers
+0001a480: 203d 207b 2241 7574 686f 7269 7a61 7469   = {"Authorizati
+0001a490: 6f6e 223a 2066 2242 6561 7265 7220 7b74  on": f"Bearer {t
+0001a4a0: 6f6b 656e 7d22 7d0a 0a20 2020 2063 6c69  oken}"}..    cli
+0001a4b0: 5f70 6172 616d 7320 3d20 7b7d 0a20 2020  _params = {}.   
+0001a4c0: 2063 6c69 5f70 6172 616d 735b 2263 6c69   cli_params["cli
+0001a4d0: 5f76 6572 7369 6f6e 225d 203d 2074 625f  _version"] = tb_
+0001a4e0: 636c 6965 6e74 2e76 6572 7369 6f6e 0a20  client.version. 
+0001a4f0: 2020 2063 6c69 5f70 6172 616d 735b 2264     cli_params["d
+0001a500: 6573 6372 6970 7469 6f6e 225d 203d 2070  escription"] = p
+0001a510: 2e67 6574 2822 6465 7363 7269 7074 696f  .get("descriptio
+0001a520: 6e22 2c20 2222 290a 2020 2020 636c 695f  n", "").    cli_
+0001a530: 7061 7261 6d73 5b22 6967 6e6f 7265 5f73  params["ignore_s
+0001a540: 716c 5f65 7272 6f72 7322 5d20 3d20 2274  ql_errors"] = "t
+0001a550: 7275 6522 2069 6620 6967 6e6f 7265 5f73  rue" if ignore_s
+0001a560: 716c 5f65 7272 6f72 7320 656c 7365 2022  ql_errors else "
+0001a570: 6661 6c73 6522 0a0a 2020 2020 723a 2072  false"..    r: r
+0001a580: 6571 7565 7374 732e 5265 7370 6f6e 7365  equests.Response
+0001a590: 203d 2061 7761 6974 2072 6571 7565 7374   = await request
+0001a5a0: 735f 6765 7428 6622 7b68 6f73 747d 2f76  s_get(f"{host}/v
+0001a5b0: 302f 7069 7065 732f 7b70 5b27 6e61 6d65  0/pipes/{p['name
+0001a5c0: 275d 7d3f 7b75 726c 656e 636f 6465 2863  ']}?{urlencode(c
+0001a5d0: 6c69 5f70 6172 616d 7329 7d22 2c20 6865  li_params)}", he
+0001a5e0: 6164 6572 733d 6865 6164 6572 7329 0a0a  aders=headers)..
+0001a5f0: 2020 2020 6375 7272 656e 745f 7069 7065      current_pipe
+0001a600: 203d 2072 2e6a 736f 6e28 2920 6966 2072   = r.json() if r
+0001a610: 2e73 7461 7475 735f 636f 6465 203d 3d20  .status_code == 
+0001a620: 3230 3020 656c 7365 204e 6f6e 650a 2020  200 else None.  
+0001a630: 2020 7069 7065 5f65 7869 7374 7320 3d20    pipe_exists = 
+0001a640: 6375 7272 656e 745f 7069 7065 2069 7320  current_pipe is 
+0001a650: 6e6f 7420 4e6f 6e65 0a0a 2020 2020 6973  not None..    is
+0001a660: 5f6d 6174 6572 6961 6c69 7a65 6420 3d20  _materialized = 
+0001a670: 616e 7928 5b6e 6f64 652e 6765 7428 2270  any([node.get("p
+0001a680: 6172 616d 7322 2c20 7b7d 292e 6765 7428  arams", {}).get(
+0001a690: 2274 7970 6522 2c20 4e6f 6e65 2920 3d3d  "type", None) ==
+0001a6a0: 2022 6d61 7465 7269 616c 697a 6564 2220   "materialized" 
+0001a6b0: 666f 7220 6e6f 6465 2069 6e20 705b 226e  for node in p["n
+0001a6c0: 6f64 6573 225d 5d29 0a20 2020 2063 6f70  odes"]]).    cop
+0001a6d0: 795f 6e6f 6465 203d 206e 6578 7428 286e  y_node = next((n
+0001a6e0: 6f64 6520 666f 7220 6e6f 6465 2069 6e20  ode for node in 
+0001a6f0: 705b 226e 6f64 6573 225d 2069 6620 6e6f  p["nodes"] if no
+0001a700: 6465 2e67 6574 2822 7061 7261 6d73 222c  de.get("params",
+0001a710: 207b 7d29 2e67 6574 2822 7479 7065 222c   {}).get("type",
+0001a720: 204e 6f6e 6529 203d 3d20 2263 6f70 7922   None) == "copy"
+0001a730: 292c 204e 6f6e 6529 0a20 2020 2073 696e  ), None).    sin
+0001a740: 6b5f 6e6f 6465 203d 206e 6578 7428 286e  k_node = next((n
+0001a750: 6f64 6520 666f 7220 6e6f 6465 2069 6e20  ode for node in 
+0001a760: 705b 226e 6f64 6573 225d 2069 6620 6e6f  p["nodes"] if no
+0001a770: 6465 2e67 6574 2822 7061 7261 6d73 222c  de.get("params",
+0001a780: 207b 7d29 2e67 6574 2822 7479 7065 222c   {}).get("type",
+0001a790: 204e 6f6e 6529 203d 3d20 2273 696e 6b22   None) == "sink"
+0001a7a0: 292c 204e 6f6e 6529 0a0a 2020 2020 6966  ), None)..    if
+0001a7b0: 2070 6970 655f 6578 6973 7473 3a0a 2020   pipe_exists:.  
+0001a7c0: 2020 2020 2020 6966 2066 6f72 6365 206f        if force o
+0001a7d0: 7220 7275 6e5f 7465 7374 733a 0a20 2020  r run_tests:.   
+0001a7e0: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
+0001a7f0: 2074 6869 7320 7368 6f75 6c64 2063 7265   this should cre
+0001a800: 6174 6520 6120 6469 6666 6572 656e 7420  ate a different 
+0001a810: 6e6f 6465 2061 6e64 2072 656e 616d 6520  node and rename 
+0001a820: 6974 2074 6f20 7468 6520 6669 6e61 6c20  it to the final 
+0001a830: 6f6e 6520 6f6e 2073 7563 6365 7373 0a20  one on success. 
+0001a840: 2020 2020 2020 2020 2020 2069 6620 6368             if ch
+0001a850: 6563 6b20 616e 6420 6e6f 7420 706f 7075  eck and not popu
+0001a860: 6c61 7465 3a0a 2020 2020 2020 2020 2020  late:.          
+0001a870: 2020 2020 2020 6966 206e 6f74 2069 735f        if not is_
+0001a880: 6d61 7465 7269 616c 697a 6564 2061 6e64  materialized and
+0001a890: 206e 6f74 2063 6f70 795f 6e6f 6465 2061   not copy_node a
+0001a8a0: 6e64 206e 6f74 2073 696e 6b5f 6e6f 6465  nd not sink_node
+0001a8b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001a8c0: 2020 2020 2020 6177 6169 7420 6368 6563        await chec
+0001a8d0: 6b5f 7069 7065 280a 2020 2020 2020 2020  k_pipe(.        
+0001a8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8f0: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+0001a900: 2020 2020 2020 2020 2020 2068 6f73 742c             host,
+0001a910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a920: 2020 2020 2020 2020 2074 6f6b 656e 2c0a           token,.
+0001a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a940: 2020 2020 2020 2020 706f 7075 6c61 7465          populate
+0001a950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a960: 2020 2020 2020 2020 2020 7462 5f63 6c69            tb_cli
+0001a970: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
+0001a980: 2020 2020 2020 2020 2020 2020 206f 6e6c               onl
+0001a990: 795f 7265 7370 6f6e 7365 5f74 696d 6573  y_response_times
+0001a9a0: 3d6f 6e6c 795f 7265 7370 6f6e 7365 5f74  =only_response_t
+0001a9b0: 696d 6573 2c0a 2020 2020 2020 2020 2020  imes,.          
+0001a9c0: 2020 2020 2020 2020 2020 2020 2020 6c69                li
+0001a9d0: 6d69 743d 7465 7374 735f 746f 5f72 756e  mit=tests_to_run
+0001a9e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a9f0: 2020 2020 2020 2020 2020 7361 6d70 6c65            sample
+0001aa00: 5f62 795f 7061 7261 6d73 3d74 6573 7473  _by_params=tests
+0001aa10: 5f74 6f5f 7361 6d70 6c65 5f62 795f 7061  _to_sample_by_pa
+0001aa20: 7261 6d73 2c0a 2020 2020 2020 2020 2020  rams,.          
+0001aa30: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+0001aa40: 7463 6865 733d 7465 7374 735f 6669 6c74  tches=tests_filt
+0001aa50: 6572 5f62 792c 0a20 2020 2020 2020 2020  er_by,.         
+0001aa60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001aa70: 6169 6c66 6173 743d 7465 7374 735f 6661  ailfast=tests_fa
+0001aa80: 696c 6661 7374 2c0a 2020 2020 2020 2020  ilfast,.        
+0001aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aaa0: 7661 6c69 6461 7465 5f70 726f 6365 7373  validate_process
+0001aab0: 6564 5f62 7974 6573 3d74 6573 7473 5f76  ed_bytes=tests_v
+0001aac0: 616c 6964 6174 655f 7072 6f63 6573 7365  alidate_processe
+0001aad0: 645f 6279 7465 732c 0a20 2020 2020 2020  d_bytes,.       
 0001aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aaf0: 2063 7572 7265 6e74 5f70 6970 653d 6375   current_pipe=cu
-0001ab00: 7272 656e 745f 7069 7065 2c0a 2020 2020  rrent_pipe,.    
-0001ab10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001ab30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001ab40: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0001ab50: 735f 6d61 7465 7269 616c 697a 6564 3a0a  s_materialized:.
-0001ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab70: 2020 2020 2020 2020 6177 6169 7420 6368          await ch
-0001ab80: 6563 6b5f 6d61 7465 7269 616c 697a 6564  eck_materialized
-0001ab90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001aba0: 2020 2020 2020 2020 2020 2020 2020 702c                p,
-0001abb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001abc0: 2020 2020 2020 2020 2020 2020 2068 6f73               hos
-0001abd0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0001abe0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001abf0: 6f6b 656e 2c0a 2020 2020 2020 2020 2020  oken,.          
+0001aaf0: 2069 676e 6f72 655f 6f72 6465 723d 7465   ignore_order=te
+0001ab00: 7374 735f 6967 6e6f 7265 5f6f 7264 6572  sts_ignore_order
+0001ab10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ab20: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+0001ab30: 666f 725f 7265 7175 6573 7473 5f74 6f5f  for_requests_to_
+0001ab40: 6368 6563 6b3d 280a 2020 2020 2020 2020  check=(.        
+0001ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab60: 2020 2020 6177 6169 7420 6765 745f 746f      await get_to
+0001ab70: 6b65 6e5f 6672 6f6d 5f6d 6169 6e5f 6272  ken_from_main_br
+0001ab80: 616e 6368 2874 625f 636c 6965 6e74 290a  anch(tb_client).
+0001ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aba0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0001abb0: 6f74 2074 6573 7473 5f63 6865 636b 5f72  ot tests_check_r
+0001abc0: 6571 7565 7374 735f 6672 6f6d 5f62 7261  equests_from_bra
+0001abd0: 6e63 680a 2020 2020 2020 2020 2020 2020  nch.            
+0001abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abf0: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
 0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac10: 2020 7462 5f63 6c69 656e 742c 0a20 2020    tb_client,.   
-0001ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac30: 2020 2020 2020 2020 206f 7665 7272 6964           overrid
-0001ac40: 655f 6461 7461 736f 7572 6365 3d6f 7665  e_datasource=ove
-0001ac50: 7272 6964 655f 6461 7461 736f 7572 6365  rride_datasource
-0001ac60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ac70: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-0001ac80: 7272 656e 745f 7069 7065 3d63 7572 7265  rrent_pipe=curre
-0001ac90: 6e74 5f70 6970 652c 0a20 2020 2020 2020  nt_pipe,.       
+0001ac10: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+0001ac20: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+0001ac30: 7265 6e74 5f70 6970 653d 6375 7272 656e  rent_pipe=curren
+0001ac40: 745f 7069 7065 2c0a 2020 2020 2020 2020  t_pipe,.        
+0001ac50: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001ac60: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001ac70: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001ac80: 2020 2020 2020 2020 6966 2069 735f 6d61          if is_ma
+0001ac90: 7465 7269 616c 697a 6564 3a0a 2020 2020  terialized:.    
 0001aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001acb0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0001acc0: 2020 2020 2020 2069 6620 636f 7079 5f6e         if copy_n
-0001acd0: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
-0001ace0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-0001acf0: 6974 2063 6865 636b 5f63 6f70 795f 7069  it check_copy_pi
-0001ad00: 7065 2870 6970 653d 6375 7272 656e 745f  pe(pipe=current_
-0001ad10: 7069 7065 2c20 636f 7079 5f6e 6f64 653d  pipe, copy_node=
-0001ad20: 636f 7079 5f6e 6f64 652c 2074 625f 636c  copy_node, tb_cl
-0001ad30: 6965 6e74 3d74 625f 636c 6965 6e74 290a  ient=tb_client).
-0001ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad50: 2020 2020 6966 2073 696e 6b5f 6e6f 6465      if sink_node
-0001ad60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ad70: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0001ad80: 6368 6563 6b5f 7369 6e6b 5f70 6970 6528  check_sink_pipe(
-0001ad90: 7069 7065 3d63 7572 7265 6e74 5f70 6970  pipe=current_pip
-0001ada0: 652c 2073 696e 6b5f 6e6f 6465 3d73 696e  e, sink_node=sin
-0001adb0: 6b5f 6e6f 6465 2c20 7462 5f63 6c69 656e  k_node, tb_clien
-0001adc0: 743d 7462 5f63 6c69 656e 7429 0a20 2020  t=tb_client).   
-0001add0: 2020 2020 2020 2020 2069 6620 7275 6e5f           if run_
-0001ade0: 7465 7374 733a 0a20 2020 2020 2020 2020  tests:.         
-0001adf0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0001ae00: 6e66 6f28 6622 736b 6970 7069 6e67 2066  nfo(f"skipping f
-0001ae10: 6f72 6365 206f 7665 7272 6964 6520 6f66  orce override of
-0001ae20: 207b 705b 276e 616d 6527 5d7d 2229 0a20   {p['name']}"). 
-0001ae30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001ae40: 6574 7572 6e0a 2020 2020 2020 2020 656c  eturn.        el
-0001ae50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001ae60: 7261 6973 6520 636c 6963 6b2e 436c 6963  raise click.Clic
-0001ae70: 6b45 7863 6570 7469 6f6e 2846 6565 6462  kException(Feedb
-0001ae80: 6163 6b4d 616e 6167 6572 2e65 7272 6f72  ackManager.error
-0001ae90: 5f70 6970 655f 616c 7265 6164 795f 6578  _pipe_already_ex
-0001aea0: 6973 7473 2870 6970 653d 705b 226e 616d  ists(pipe=p["nam
-0001aeb0: 6522 5d29 290a 2020 2020 656c 6966 206e  e"])).    elif n
-0001aec0: 6f74 2070 6970 655f 6578 6973 7473 2061  ot pipe_exists a
-0001aed0: 6e64 2063 6865 636b 3a0a 2020 2020 2020  nd check:.      
-0001aee0: 2020 6966 2069 735f 6d61 7465 7269 616c    if is_material
-0001aef0: 697a 6564 3a0a 2020 2020 2020 2020 2020  ized:.          
-0001af00: 2020 6177 6169 7420 6368 6563 6b5f 6d61    await check_ma
-0001af10: 7465 7269 616c 697a 6564 280a 2020 2020  terialized(.    
-0001af20: 2020 2020 2020 2020 2020 2020 702c 2068              p, h
-0001af30: 6f73 742c 2074 6f6b 656e 2c20 7462 5f63  ost, token, tb_c
-0001af40: 6c69 656e 742c 206f 7665 7272 6964 655f  lient, override_
-0001af50: 6461 7461 736f 7572 6365 3d6f 7665 7272  datasource=overr
-0001af60: 6964 655f 6461 7461 736f 7572 6365 2c20  ide_datasource, 
-0001af70: 6375 7272 656e 745f 7069 7065 3d63 7572  current_pipe=cur
-0001af80: 7265 6e74 5f70 6970 650a 2020 2020 2020  rent_pipe.      
-0001af90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001afa0: 6966 2063 6f70 795f 6e6f 6465 3a0a 2020  if copy_node:.  
-0001afb0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0001afc0: 6368 6563 6b5f 636f 7079 5f70 6970 6528  check_copy_pipe(
-0001afd0: 7069 7065 3d63 7572 7265 6e74 5f70 6970  pipe=current_pip
-0001afe0: 652c 2063 6f70 795f 6e6f 6465 3d63 6f70  e, copy_node=cop
-0001aff0: 795f 6e6f 6465 2c20 7462 5f63 6c69 656e  y_node, tb_clien
-0001b000: 743d 7462 5f63 6c69 656e 7429 0a0a 2020  t=tb_client)..  
-0001b010: 2020 7061 7261 6d73 203d 207b 7d0a 2020    params = {}.  
-0001b020: 2020 7061 7261 6d73 2e75 7064 6174 6528    params.update(
-0001b030: 636c 695f 7061 7261 6d73 290a 2020 2020  cli_params).    
-0001b040: 6966 2066 6f72 6365 3a0a 2020 2020 2020  if force:.      
-0001b050: 2020 7061 7261 6d73 5b22 666f 7263 6522    params["force"
-0001b060: 5d20 3d20 2274 7275 6522 0a20 2020 2069  ] = "true".    i
-0001b070: 6620 706f 7075 6c61 7465 3a0a 2020 2020  f populate:.    
-0001b080: 2020 2020 7061 7261 6d73 5b22 706f 7075      params["popu
-0001b090: 6c61 7465 225d 203d 2022 7472 7565 220a  late"] = "true".
-0001b0a0: 2020 2020 6966 2070 6f70 756c 6174 655f      if populate_
-0001b0b0: 636f 6e64 6974 696f 6e3a 0a20 2020 2020  condition:.     
-0001b0c0: 2020 2070 6172 616d 735b 2270 6f70 756c     params["popul
-0001b0d0: 6174 655f 636f 6e64 6974 696f 6e22 5d20  ate_condition"] 
-0001b0e0: 3d20 706f 7075 6c61 7465 5f63 6f6e 6469  = populate_condi
-0001b0f0: 7469 6f6e 0a20 2020 2069 6620 706f 7075  tion.    if popu
-0001b100: 6c61 7465 5f73 7562 7365 743a 0a20 2020  late_subset:.   
-0001b110: 2020 2020 2070 6172 616d 735b 2270 6f70       params["pop
-0001b120: 756c 6174 655f 7375 6273 6574 225d 203d  ulate_subset"] =
-0001b130: 2070 6f70 756c 6174 655f 7375 6273 6574   populate_subset
-0001b140: 0a20 2020 2070 6172 616d 735b 2275 6e6c  .    params["unl
-0001b150: 696e 6b5f 6f6e 5f70 6f70 756c 6174 655f  ink_on_populate_
-0001b160: 6572 726f 7222 5d20 3d20 2274 7275 6522  error"] = "true"
-0001b170: 2069 6620 756e 6c69 6e6b 5f6f 6e5f 706f   if unlink_on_po
-0001b180: 7075 6c61 7465 5f65 7272 6f72 2065 6c73  pulate_error els
-0001b190: 6520 2266 616c 7365 220a 2020 2020 7061  e "false".    pa
-0001b1a0: 7261 6d73 5b22 6272 616e 6368 5f6d 6f64  rams["branch_mod
-0001b1b0: 6522 5d20 3d20 2266 6f72 6b22 2069 6620  e"] = "fork" if 
-0001b1c0: 666f 726b 5f64 6f77 6e73 7472 6561 6d20  fork_downstream 
-0001b1d0: 6f72 2066 6f72 6b20 656c 7365 2022 4e6f  or fork else "No
-0001b1e0: 6e65 220a 0a20 2020 2062 6f64 7920 3d20  ne"..    body = 
-0001b1f0: 7b22 6e61 6d65 223a 2070 5b22 6e61 6d65  {"name": p["name
-0001b200: 225d 2c20 2264 6573 6372 6970 7469 6f6e  "], "description
-0001b210: 223a 2070 2e67 6574 2822 6465 7363 7269  ": p.get("descri
-0001b220: 7074 696f 6e22 2c20 2222 297d 0a0a 2020  ption", "")}..  
-0001b230: 2020 6465 6620 7061 7273 655f 6e6f 6465    def parse_node
-0001b240: 286e 6f64 6529 3a0a 2020 2020 2020 2020  (node):.        
-0001b250: 6966 2022 7061 7261 6d73 2220 696e 206e  if "params" in n
-0001b260: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
-0001b270: 206e 6f64 652e 7570 6461 7465 286e 6f64   node.update(nod
-0001b280: 655b 2270 6172 616d 7322 5d29 0a20 2020  e["params"]).   
-0001b290: 2020 2020 2020 2020 2069 6620 6e6f 6465           if node
-0001b2a0: 2e67 6574 2822 7479 7065 222c 2022 2229  .get("type", "")
-0001b2b0: 203d 3d20 226d 6174 6572 6961 6c69 7a65   == "materialize
-0001b2c0: 6422 2061 6e64 206f 7665 7272 6964 655f  d" and override_
-0001b2d0: 6461 7461 736f 7572 6365 3a0a 2020 2020  datasource:.    
-0001b2e0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-0001b2f0: 5b22 6f76 6572 7269 6465 5f64 6174 6173  ["override_datas
-0001b300: 6f75 7263 6522 5d20 3d20 2274 7275 6522  ource"] = "true"
-0001b310: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-0001b320: 206e 6f64 655b 2270 6172 616d 7322 5d0a   node["params"].
-0001b330: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-0001b340: 6f64 650a 0a20 2020 2069 6620 705b 226e  ode..    if p["n
-0001b350: 6f64 6573 225d 3a0a 2020 2020 2020 2020  odes"]:.        
-0001b360: 626f 6479 5b22 6e6f 6465 7322 5d20 3d20  body["nodes"] = 
-0001b370: 5b70 6172 7365 5f6e 6f64 6528 6e29 2066  [parse_node(n) f
-0001b380: 6f72 206e 2069 6e20 705b 226e 6f64 6573  or n in p["nodes
-0001b390: 225d 5d0a 0a20 2020 2069 6620 636f 7079  "]]..    if copy
-0001b3a0: 5f6e 6f64 653a 0a20 2020 2020 2020 2062  _node:.        b
-0001b3b0: 6f64 795b 2274 6172 6765 745f 6461 7461  ody["target_data
-0001b3c0: 736f 7572 6365 225d 203d 2063 6f70 795f  source"] = copy_
-0001b3d0: 6e6f 6465 2e67 6574 2822 7461 7267 6574  node.get("target
-0001b3e0: 5f64 6174 6173 6f75 7263 6522 2c20 4e6f  _datasource", No
-0001b3f0: 6e65 290a 2020 2020 2020 2020 2320 5765  ne).        # We
-0001b400: 2077 696c 6c20 7570 6461 7465 2074 6865   will update the
-0001b410: 2073 6368 6564 756c 6520 6372 6f6e 206c   schedule cron l
-0001b420: 6174 6572 0a20 2020 2020 2020 2062 6f64  ater.        bod
-0001b430: 795b 2273 6368 6564 756c 655f 6372 6f6e  y["schedule_cron
-0001b440: 225d 203d 204e 6f6e 650a 0a20 2020 2069  "] = None..    i
-0001b450: 6620 7369 6e6b 5f6e 6f64 653a 0a20 2020  f sink_node:.   
-0001b460: 2020 2020 2062 6f64 792e 7570 6461 7465       body.update
-0001b470: 2873 696e 6b5f 6e6f 6465 2e67 6574 2822  (sink_node.get("
-0001b480: 6578 706f 7274 5f70 6172 616d 7322 2c20  export_params", 
-0001b490: 7b7d 2929 0a0a 2020 2020 706f 7374 5f68  {}))..    post_h
-0001b4a0: 6561 6465 7273 203d 207b 2243 6f6e 7465  eaders = {"Conte
-0001b4b0: 6e74 2d54 7970 6522 3a20 2261 7070 6c69  nt-Type": "appli
-0001b4c0: 6361 7469 6f6e 2f6a 736f 6e22 7d0a 0a20  cation/json"}.. 
-0001b4d0: 2020 2070 6f73 745f 6865 6164 6572 732e     post_headers.
-0001b4e0: 7570 6461 7465 2868 6561 6465 7273 290a  update(headers).
-0001b4f0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-0001b500: 2020 6461 7461 203d 2061 7761 6974 2074    data = await t
-0001b510: 625f 636c 6965 6e74 2e5f 7265 7128 0a20  b_client._req(. 
-0001b520: 2020 2020 2020 2020 2020 2066 222f 7630             f"/v0
-0001b530: 2f70 6970 6573 3f7b 7572 6c65 6e63 6f64  /pipes?{urlencod
-0001b540: 6528 7061 7261 6d73 297d 222c 206d 6574  e(params)}", met
-0001b550: 686f 643d 2250 4f53 5422 2c20 6865 6164  hod="POST", head
-0001b560: 6572 733d 706f 7374 5f68 6561 6465 7273  ers=post_headers
-0001b570: 2c20 6461 7461 3d6a 736f 6e2e 6475 6d70  , data=json.dump
-0001b580: 7328 626f 6479 290a 2020 2020 2020 2020  s(body).        
-0001b590: 290a 2020 2020 6578 6365 7074 2045 7863  ).    except Exc
-0001b5a0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-0001b5b0: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
-0001b5c0: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
-0001b5d0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-0001b5e0: 6572 726f 725f 7075 7368 696e 675f 7069  error_pushing_pi
-0001b5f0: 7065 2870 6970 653d 705b 226e 616d 6522  pe(pipe=p["name"
-0001b600: 5d2c 2065 7272 6f72 3d73 7472 2865 2929  ], error=str(e))
-0001b610: 290a 0a20 2020 2064 6174 6173 6f75 7263  )..    datasourc
-0001b620: 6520 3d20 6461 7461 2e67 6574 2822 6461  e = data.get("da
-0001b630: 7461 736f 7572 6365 222c 204e 6f6e 6529  tasource", None)
-0001b640: 0a20 2020 2063 7265 6174 6564 5f64 6174  .    created_dat
-0001b650: 6173 6f75 7263 6520 3d20 6461 7461 2e67  asource = data.g
-0001b660: 6574 2822 6372 6561 7465 645f 6461 7461  et("created_data
-0001b670: 736f 7572 6365 222c 204e 6f6e 6529 0a0a  source", None)..
-0001b680: 2020 2020 6966 2064 6174 6173 6f75 7263      if datasourc
-0001b690: 6520 616e 6420 6372 6561 7465 645f 6461  e and created_da
-0001b6a0: 7461 736f 7572 6365 3a0a 2020 2020 2020  tasource:.      
-0001b6b0: 2020 6966 2063 6f70 795f 6e6f 6465 3a0a    if copy_node:.
-0001b6c0: 2020 2020 2020 2020 2020 2020 636c 6963              clic
-0001b6d0: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
-0001b6e0: 616e 6167 6572 2e69 6e66 6f5f 636f 7079  anager.info_copy
-0001b6f0: 5f64 6174 6173 6f75 7263 655f 6372 6561  _datasource_crea
-0001b700: 7465 6428 7069 7065 3d70 5b22 6e61 6d65  ted(pipe=p["name
-0001b710: 225d 2c20 6461 7461 736f 7572 6365 3d64  "], datasource=d
-0001b720: 6174 6173 6f75 7263 655b 226e 616d 6522  atasource["name"
-0001b730: 5d29 290a 2020 2020 2020 2020 656c 7365  ])).        else
-0001b740: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-0001b750: 6963 6b2e 6563 686f 280a 2020 2020 2020  ick.echo(.      
-0001b760: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
-0001b770: 636b 4d61 6e61 6765 722e 696e 666f 5f6d  ckManager.info_m
-0001b780: 6174 6572 6961 6c69 7a65 645f 6461 7461  aterialized_data
-0001b790: 736f 7572 6365 5f63 7265 6174 6564 2870  source_created(p
-0001b7a0: 6970 653d 705b 226e 616d 6522 5d2c 2064  ipe=p["name"], d
-0001b7b0: 6174 6173 6f75 7263 653d 6461 7461 736f  atasource=dataso
-0001b7c0: 7572 6365 5b22 6e61 6d65 225d 290a 2020  urce["name"]).  
-0001b7d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001b7e0: 656c 6966 2064 6174 6173 6f75 7263 6520  elif datasource 
-0001b7f0: 616e 6420 6e6f 7420 6372 6561 7465 645f  and not created_
-0001b800: 6461 7461 736f 7572 6365 3a0a 2020 2020  datasource:.    
-0001b810: 2020 2020 6966 2063 6f70 795f 6e6f 6465      if copy_node
-0001b820: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-0001b830: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
-0001b840: 6b4d 616e 6167 6572 2e69 6e66 6f5f 636f  kManager.info_co
-0001b850: 7079 5f64 6174 6173 6f75 7263 655f 7573  py_datasource_us
-0001b860: 6564 2870 6970 653d 705b 226e 616d 6522  ed(pipe=p["name"
-0001b870: 5d2c 2064 6174 6173 6f75 7263 653d 6461  ], datasource=da
-0001b880: 7461 736f 7572 6365 5b22 6e61 6d65 225d  tasource["name"]
-0001b890: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
-0001b8a0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-0001b8b0: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
-0001b8c0: 4d61 6e61 6765 722e 696e 666f 5f6d 6174  Manager.info_mat
-0001b8d0: 6572 6961 6c69 7a65 645f 6461 7461 736f  erialized_dataso
-0001b8e0: 7572 6365 5f75 7365 6428 7069 7065 3d70  urce_used(pipe=p
-0001b8f0: 5b22 6e61 6d65 225d 2c20 6461 7461 736f  ["name"], dataso
-0001b900: 7572 6365 3d64 6174 6173 6f75 7263 655b  urce=datasource[
-0001b910: 226e 616d 6522 5d29 290a 0a20 2020 2069  "name"]))..    i
-0001b920: 6620 6461 7461 736f 7572 6365 2061 6e64  f datasource and
-0001b930: 2070 6f70 756c 6174 6520 616e 6420 6e6f   populate and no
-0001b940: 7420 636f 7079 5f6e 6f64 653a 0a20 2020  t copy_node:.   
-0001b950: 2020 2020 206a 6f62 5f75 726c 203d 2064       job_url = d
-0001b960: 6174 612e 6765 7428 226a 6f62 222c 207b  ata.get("job", {
-0001b970: 7d29 2e67 6574 2822 6a6f 625f 7572 6c22  }).get("job_url"
-0001b980: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-0001b990: 6a6f 625f 6964 203d 2064 6174 612e 6765  job_id = data.ge
-0001b9a0: 7428 226a 6f62 222c 207b 7d29 2e67 6574  t("job", {}).get
-0001b9b0: 2822 6a6f 625f 6964 222c 204e 6f6e 6529  ("job_id", None)
-0001b9c0: 0a20 2020 2020 2020 2069 6620 706f 7075  .        if popu
-0001b9d0: 6c61 7465 5f73 7562 7365 743a 0a20 2020  late_subset:.   
+0001acb0: 2020 2020 6177 6169 7420 6368 6563 6b5f      await check_
+0001acc0: 6d61 7465 7269 616c 697a 6564 280a 2020  materialized(.  
+0001acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ace0: 2020 2020 2020 2020 2020 702c 0a20 2020            p,.   
+0001acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad00: 2020 2020 2020 2020 2068 6f73 742c 0a20           host,. 
+0001ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad20: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
+0001ad30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ad40: 2020 2020 2020 2020 2020 2020 2020 7462                tb
+0001ad50: 5f63 6c69 656e 742c 0a20 2020 2020 2020  _client,.       
+0001ad60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad70: 2020 2020 206f 7665 7272 6964 655f 6461       override_da
+0001ad80: 7461 736f 7572 6365 3d6f 7665 7272 6964  tasource=overrid
+0001ad90: 655f 6461 7461 736f 7572 6365 2c0a 2020  e_datasource,.  
+0001ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adb0: 2020 2020 2020 2020 2020 6375 7272 656e            curren
+0001adc0: 745f 7069 7065 3d63 7572 7265 6e74 5f70  t_pipe=current_p
+0001add0: 6970 652c 0a20 2020 2020 2020 2020 2020  ipe,.           
+0001ade0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0001adf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae00: 2020 2069 6620 636f 7079 5f6e 6f64 653a     if copy_node:
+0001ae10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ae20: 2020 2020 2020 2020 2061 7761 6974 2063           await c
+0001ae30: 6865 636b 5f63 6f70 795f 7069 7065 2870  heck_copy_pipe(p
+0001ae40: 6970 653d 6375 7272 656e 745f 7069 7065  ipe=current_pipe
+0001ae50: 2c20 636f 7079 5f6e 6f64 653d 636f 7079  , copy_node=copy
+0001ae60: 5f6e 6f64 652c 2074 625f 636c 6965 6e74  _node, tb_client
+0001ae70: 3d74 625f 636c 6965 6e74 290a 2020 2020  =tb_client).    
+0001ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae90: 6966 2073 696e 6b5f 6e6f 6465 3a0a 2020  if sink_node:.  
+0001aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aeb0: 2020 2020 2020 6177 6169 7420 6368 6563        await chec
+0001aec0: 6b5f 7369 6e6b 5f70 6970 6528 7069 7065  k_sink_pipe(pipe
+0001aed0: 3d63 7572 7265 6e74 5f70 6970 652c 2073  =current_pipe, s
+0001aee0: 696e 6b5f 6e6f 6465 3d73 696e 6b5f 6e6f  ink_node=sink_no
+0001aef0: 6465 2c20 7462 5f63 6c69 656e 743d 7462  de, tb_client=tb
+0001af00: 5f63 6c69 656e 7429 0a20 2020 2020 2020  _client).       
+0001af10: 2020 2020 2069 6620 7275 6e5f 7465 7374       if run_test
+0001af20: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001af30: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0001af40: 6622 736b 6970 7069 6e67 2066 6f72 6365  f"skipping force
+0001af50: 206f 7665 7272 6964 6520 6f66 207b 705b   override of {p[
+0001af60: 276e 616d 6527 5d7d 2229 0a20 2020 2020  'name']}").     
+0001af70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001af80: 6e0a 2020 2020 2020 2020 656c 7365 3a0a  n.        else:.
+0001af90: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001afa0: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
+0001afb0: 6570 7469 6f6e 2846 6565 6462 6163 6b4d  eption(FeedbackM
+0001afc0: 616e 6167 6572 2e65 7272 6f72 5f70 6970  anager.error_pip
+0001afd0: 655f 616c 7265 6164 795f 6578 6973 7473  e_already_exists
+0001afe0: 2870 6970 653d 705b 226e 616d 6522 5d29  (pipe=p["name"])
+0001aff0: 290a 2020 2020 656c 6966 206e 6f74 2070  ).    elif not p
+0001b000: 6970 655f 6578 6973 7473 2061 6e64 2063  ipe_exists and c
+0001b010: 6865 636b 3a0a 2020 2020 2020 2020 6966  heck:.        if
+0001b020: 2069 735f 6d61 7465 7269 616c 697a 6564   is_materialized
+0001b030: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+0001b040: 6169 7420 6368 6563 6b5f 6d61 7465 7269  ait check_materi
+0001b050: 616c 697a 6564 280a 2020 2020 2020 2020  alized(.        
+0001b060: 2020 2020 2020 2020 702c 2068 6f73 742c          p, host,
+0001b070: 2074 6f6b 656e 2c20 7462 5f63 6c69 656e   token, tb_clien
+0001b080: 742c 206f 7665 7272 6964 655f 6461 7461  t, override_data
+0001b090: 736f 7572 6365 3d6f 7665 7272 6964 655f  source=override_
+0001b0a0: 6461 7461 736f 7572 6365 2c20 6375 7272  datasource, curr
+0001b0b0: 656e 745f 7069 7065 3d63 7572 7265 6e74  ent_pipe=current
+0001b0c0: 5f70 6970 650a 2020 2020 2020 2020 2020  _pipe.          
+0001b0d0: 2020 290a 2020 2020 2020 2020 6966 2063    ).        if c
+0001b0e0: 6f70 795f 6e6f 6465 3a0a 2020 2020 2020  opy_node:.      
+0001b0f0: 2020 2020 2020 6177 6169 7420 6368 6563        await chec
+0001b100: 6b5f 636f 7079 5f70 6970 6528 7069 7065  k_copy_pipe(pipe
+0001b110: 3d63 7572 7265 6e74 5f70 6970 652c 2063  =current_pipe, c
+0001b120: 6f70 795f 6e6f 6465 3d63 6f70 795f 6e6f  opy_node=copy_no
+0001b130: 6465 2c20 7462 5f63 6c69 656e 743d 7462  de, tb_client=tb
+0001b140: 5f63 6c69 656e 7429 0a0a 2020 2020 7061  _client)..    pa
+0001b150: 7261 6d73 203d 207b 7d0a 2020 2020 7061  rams = {}.    pa
+0001b160: 7261 6d73 2e75 7064 6174 6528 636c 695f  rams.update(cli_
+0001b170: 7061 7261 6d73 290a 2020 2020 6966 2066  params).    if f
+0001b180: 6f72 6365 3a0a 2020 2020 2020 2020 7061  orce:.        pa
+0001b190: 7261 6d73 5b22 666f 7263 6522 5d20 3d20  rams["force"] = 
+0001b1a0: 2274 7275 6522 0a20 2020 2069 6620 706f  "true".    if po
+0001b1b0: 7075 6c61 7465 3a0a 2020 2020 2020 2020  pulate:.        
+0001b1c0: 7061 7261 6d73 5b22 706f 7075 6c61 7465  params["populate
+0001b1d0: 225d 203d 2022 7472 7565 220a 2020 2020  "] = "true".    
+0001b1e0: 6966 2070 6f70 756c 6174 655f 636f 6e64  if populate_cond
+0001b1f0: 6974 696f 6e3a 0a20 2020 2020 2020 2070  ition:.        p
+0001b200: 6172 616d 735b 2270 6f70 756c 6174 655f  arams["populate_
+0001b210: 636f 6e64 6974 696f 6e22 5d20 3d20 706f  condition"] = po
+0001b220: 7075 6c61 7465 5f63 6f6e 6469 7469 6f6e  pulate_condition
+0001b230: 0a20 2020 2069 6620 706f 7075 6c61 7465  .    if populate
+0001b240: 5f73 7562 7365 743a 0a20 2020 2020 2020  _subset:.       
+0001b250: 2070 6172 616d 735b 2270 6f70 756c 6174   params["populat
+0001b260: 655f 7375 6273 6574 225d 203d 2070 6f70  e_subset"] = pop
+0001b270: 756c 6174 655f 7375 6273 6574 0a20 2020  ulate_subset.   
+0001b280: 2070 6172 616d 735b 2275 6e6c 696e 6b5f   params["unlink_
+0001b290: 6f6e 5f70 6f70 756c 6174 655f 6572 726f  on_populate_erro
+0001b2a0: 7222 5d20 3d20 2274 7275 6522 2069 6620  r"] = "true" if 
+0001b2b0: 756e 6c69 6e6b 5f6f 6e5f 706f 7075 6c61  unlink_on_popula
+0001b2c0: 7465 5f65 7272 6f72 2065 6c73 6520 2266  te_error else "f
+0001b2d0: 616c 7365 220a 2020 2020 7061 7261 6d73  alse".    params
+0001b2e0: 5b22 6272 616e 6368 5f6d 6f64 6522 5d20  ["branch_mode"] 
+0001b2f0: 3d20 2266 6f72 6b22 2069 6620 666f 726b  = "fork" if fork
+0001b300: 5f64 6f77 6e73 7472 6561 6d20 6f72 2066  _downstream or f
+0001b310: 6f72 6b20 656c 7365 2022 4e6f 6e65 220a  ork else "None".
+0001b320: 0a20 2020 2062 6f64 7920 3d20 7b22 6e61  .    body = {"na
+0001b330: 6d65 223a 2070 5b22 6e61 6d65 225d 2c20  me": p["name"], 
+0001b340: 2264 6573 6372 6970 7469 6f6e 223a 2070  "description": p
+0001b350: 2e67 6574 2822 6465 7363 7269 7074 696f  .get("descriptio
+0001b360: 6e22 2c20 2222 297d 0a0a 2020 2020 6465  n", "")}..    de
+0001b370: 6620 7061 7273 655f 6e6f 6465 286e 6f64  f parse_node(nod
+0001b380: 6529 3a0a 2020 2020 2020 2020 6966 2022  e):.        if "
+0001b390: 7061 7261 6d73 2220 696e 206e 6f64 653a  params" in node:
+0001b3a0: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+0001b3b0: 652e 7570 6461 7465 286e 6f64 655b 2270  e.update(node["p
+0001b3c0: 6172 616d 7322 5d29 0a20 2020 2020 2020  arams"]).       
+0001b3d0: 2020 2020 2069 6620 6e6f 6465 2e67 6574       if node.get
+0001b3e0: 2822 7479 7065 222c 2022 2229 203d 3d20  ("type", "") == 
+0001b3f0: 226d 6174 6572 6961 6c69 7a65 6422 2061  "materialized" a
+0001b400: 6e64 206f 7665 7272 6964 655f 6461 7461  nd override_data
+0001b410: 736f 7572 6365 3a0a 2020 2020 2020 2020  source:.        
+0001b420: 2020 2020 2020 2020 6e6f 6465 5b22 6f76          node["ov
+0001b430: 6572 7269 6465 5f64 6174 6173 6f75 7263  erride_datasourc
+0001b440: 6522 5d20 3d20 2274 7275 6522 0a20 2020  e"] = "true".   
+0001b450: 2020 2020 2020 2020 2064 656c 206e 6f64           del nod
+0001b460: 655b 2270 6172 616d 7322 5d0a 2020 2020  e["params"].    
+0001b470: 2020 2020 7265 7475 726e 206e 6f64 650a      return node.
+0001b480: 0a20 2020 2069 6620 705b 226e 6f64 6573  .    if p["nodes
+0001b490: 225d 3a0a 2020 2020 2020 2020 626f 6479  "]:.        body
+0001b4a0: 5b22 6e6f 6465 7322 5d20 3d20 5b70 6172  ["nodes"] = [par
+0001b4b0: 7365 5f6e 6f64 6528 6e29 2066 6f72 206e  se_node(n) for n
+0001b4c0: 2069 6e20 705b 226e 6f64 6573 225d 5d0a   in p["nodes"]].
+0001b4d0: 0a20 2020 2069 6620 636f 7079 5f6e 6f64  .    if copy_nod
+0001b4e0: 653a 0a20 2020 2020 2020 2062 6f64 795b  e:.        body[
+0001b4f0: 2274 6172 6765 745f 6461 7461 736f 7572  "target_datasour
+0001b500: 6365 225d 203d 2063 6f70 795f 6e6f 6465  ce"] = copy_node
+0001b510: 2e67 6574 2822 7461 7267 6574 5f64 6174  .get("target_dat
+0001b520: 6173 6f75 7263 6522 2c20 4e6f 6e65 290a  asource", None).
+0001b530: 2020 2020 2020 2020 2320 5765 2077 696c          # We wil
+0001b540: 6c20 7570 6461 7465 2074 6865 2073 6368  l update the sch
+0001b550: 6564 756c 6520 6372 6f6e 206c 6174 6572  edule cron later
+0001b560: 0a20 2020 2020 2020 2062 6f64 795b 2273  .        body["s
+0001b570: 6368 6564 756c 655f 6372 6f6e 225d 203d  chedule_cron"] =
+0001b580: 204e 6f6e 650a 0a20 2020 2069 6620 7369   None..    if si
+0001b590: 6e6b 5f6e 6f64 653a 0a20 2020 2020 2020  nk_node:.       
+0001b5a0: 2062 6f64 792e 7570 6461 7465 2873 696e   body.update(sin
+0001b5b0: 6b5f 6e6f 6465 2e67 6574 2822 6578 706f  k_node.get("expo
+0001b5c0: 7274 5f70 6172 616d 7322 2c20 7b7d 2929  rt_params", {}))
+0001b5d0: 0a0a 2020 2020 706f 7374 5f68 6561 6465  ..    post_heade
+0001b5e0: 7273 203d 207b 2243 6f6e 7465 6e74 2d54  rs = {"Content-T
+0001b5f0: 7970 6522 3a20 2261 7070 6c69 6361 7469  ype": "applicati
+0001b600: 6f6e 2f6a 736f 6e22 7d0a 0a20 2020 2070  on/json"}..    p
+0001b610: 6f73 745f 6865 6164 6572 732e 7570 6461  ost_headers.upda
+0001b620: 7465 2868 6561 6465 7273 290a 0a20 2020  te(headers)..   
+0001b630: 2074 7279 3a0a 2020 2020 2020 2020 6461   try:.        da
+0001b640: 7461 203d 2061 7761 6974 2074 625f 636c  ta = await tb_cl
+0001b650: 6965 6e74 2e5f 7265 7128 0a20 2020 2020  ient._req(.     
+0001b660: 2020 2020 2020 2066 222f 7630 2f70 6970         f"/v0/pip
+0001b670: 6573 3f7b 7572 6c65 6e63 6f64 6528 7061  es?{urlencode(pa
+0001b680: 7261 6d73 297d 222c 206d 6574 686f 643d  rams)}", method=
+0001b690: 2250 4f53 5422 2c20 6865 6164 6572 733d  "POST", headers=
+0001b6a0: 706f 7374 5f68 6561 6465 7273 2c20 6461  post_headers, da
+0001b6b0: 7461 3d6a 736f 6e2e 6475 6d70 7328 626f  ta=json.dumps(bo
+0001b6c0: 6479 290a 2020 2020 2020 2020 290a 2020  dy).        ).  
+0001b6d0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+0001b6e0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+0001b6f0: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+0001b700: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
+0001b710: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+0001b720: 725f 7075 7368 696e 675f 7069 7065 2870  r_pushing_pipe(p
+0001b730: 6970 653d 705b 226e 616d 6522 5d2c 2065  ipe=p["name"], e
+0001b740: 7272 6f72 3d73 7472 2865 2929 290a 0a20  rror=str(e))).. 
+0001b750: 2020 2064 6174 6173 6f75 7263 6520 3d20     datasource = 
+0001b760: 6461 7461 2e67 6574 2822 6461 7461 736f  data.get("dataso
+0001b770: 7572 6365 222c 204e 6f6e 6529 0a20 2020  urce", None).   
+0001b780: 2063 7265 6174 6564 5f64 6174 6173 6f75   created_datasou
+0001b790: 7263 6520 3d20 6461 7461 2e67 6574 2822  rce = data.get("
+0001b7a0: 6372 6561 7465 645f 6461 7461 736f 7572  created_datasour
+0001b7b0: 6365 222c 204e 6f6e 6529 0a0a 2020 2020  ce", None)..    
+0001b7c0: 6966 2064 6174 6173 6f75 7263 6520 616e  if datasource an
+0001b7d0: 6420 6372 6561 7465 645f 6461 7461 736f  d created_dataso
+0001b7e0: 7572 6365 3a0a 2020 2020 2020 2020 6966  urce:.        if
+0001b7f0: 2063 6f70 795f 6e6f 6465 3a0a 2020 2020   copy_node:.    
+0001b800: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
+0001b810: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
+0001b820: 6572 2e69 6e66 6f5f 636f 7079 5f64 6174  er.info_copy_dat
+0001b830: 6173 6f75 7263 655f 6372 6561 7465 6428  asource_created(
+0001b840: 7069 7065 3d70 5b22 6e61 6d65 225d 2c20  pipe=p["name"], 
+0001b850: 6461 7461 736f 7572 6365 3d64 6174 6173  datasource=datas
+0001b860: 6f75 7263 655b 226e 616d 6522 5d29 290a  ource["name"])).
+0001b870: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001b880: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
+0001b890: 6563 686f 280a 2020 2020 2020 2020 2020  echo(.          
+0001b8a0: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
+0001b8b0: 6e61 6765 722e 696e 666f 5f6d 6174 6572  nager.info_mater
+0001b8c0: 6961 6c69 7a65 645f 6461 7461 736f 7572  ialized_datasour
+0001b8d0: 6365 5f63 7265 6174 6564 2870 6970 653d  ce_created(pipe=
+0001b8e0: 705b 226e 616d 6522 5d2c 2064 6174 6173  p["name"], datas
+0001b8f0: 6f75 7263 653d 6461 7461 736f 7572 6365  ource=datasource
+0001b900: 5b22 6e61 6d65 225d 290a 2020 2020 2020  ["name"]).      
+0001b910: 2020 2020 2020 290a 2020 2020 656c 6966        ).    elif
+0001b920: 2064 6174 6173 6f75 7263 6520 616e 6420   datasource and 
+0001b930: 6e6f 7420 6372 6561 7465 645f 6461 7461  not created_data
+0001b940: 736f 7572 6365 3a0a 2020 2020 2020 2020  source:.        
+0001b950: 6966 2063 6f70 795f 6e6f 6465 3a0a 2020  if copy_node:.  
+0001b960: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
+0001b970: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
+0001b980: 6167 6572 2e69 6e66 6f5f 636f 7079 5f64  ager.info_copy_d
+0001b990: 6174 6173 6f75 7263 655f 7573 6564 2870  atasource_used(p
+0001b9a0: 6970 653d 705b 226e 616d 6522 5d2c 2064  ipe=p["name"], d
+0001b9b0: 6174 6173 6f75 7263 653d 6461 7461 736f  atasource=dataso
+0001b9c0: 7572 6365 5b22 6e61 6d65 225d 2929 0a20  urce["name"])). 
+0001b9d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
 0001b9e0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
 0001b9f0: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-0001ba00: 6765 722e 696e 666f 5f70 6f70 756c 6174  ger.info_populat
-0001ba10: 655f 7375 6273 6574 5f6a 6f62 5f75 726c  e_subset_job_url
-0001ba20: 2875 726c 3d6a 6f62 5f75 726c 2c20 7375  (url=job_url, su
-0001ba30: 6273 6574 3d70 6f70 756c 6174 655f 7375  bset=populate_su
-0001ba40: 6273 6574 2929 0a20 2020 2020 2020 2065  bset)).        e
-0001ba50: 6c69 6620 706f 7075 6c61 7465 5f63 6f6e  lif populate_con
-0001ba60: 6469 7469 6f6e 3a0a 2020 2020 2020 2020  dition:.        
-0001ba70: 2020 2020 636c 6963 6b2e 6563 686f 280a      click.echo(.
-0001ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba90: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-0001baa0: 696e 666f 5f70 6f70 756c 6174 655f 636f  info_populate_co
-0001bab0: 6e64 6974 696f 6e5f 6a6f 625f 7572 6c28  ndition_job_url(
-0001bac0: 7572 6c3d 6a6f 625f 7572 6c2c 2070 6f70  url=job_url, pop
-0001bad0: 756c 6174 655f 636f 6e64 6974 696f 6e3d  ulate_condition=
-0001bae0: 706f 7075 6c61 7465 5f63 6f6e 6469 7469  populate_conditi
-0001baf0: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-0001bb00: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001bb10: 2020 2020 2020 2020 2020 2020 636c 6963              clic
-0001bb20: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
-0001bb30: 616e 6167 6572 2e69 6e66 6f5f 706f 7075  anager.info_popu
-0001bb40: 6c61 7465 5f6a 6f62 5f75 726c 2875 726c  late_job_url(url
-0001bb50: 3d6a 6f62 5f75 726c 2929 0a0a 2020 2020  =job_url))..    
-0001bb60: 2020 2020 6966 2077 6169 745f 706f 7075      if wait_popu
-0001bb70: 6c61 7465 3a0a 2020 2020 2020 2020 2020  late:.          
-0001bb80: 2020 7265 7375 6c74 203d 2061 7761 6974    result = await
-0001bb90: 2077 6169 745f 6a6f 6228 7462 5f63 6c69   wait_job(tb_cli
-0001bba0: 656e 742c 206a 6f62 5f69 642c 206a 6f62  ent, job_id, job
-0001bbb0: 5f75 726c 2c20 2250 6f70 756c 6174 696e  _url, "Populatin
-0001bbc0: 6722 2c20 7469 6d65 6f75 7429 0a20 2020  g", timeout).   
-0001bbd0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
-0001bbe0: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-0001bbf0: 6765 722e 696e 666f 5f70 6f70 756c 6174  ger.info_populat
-0001bc00: 655f 6a6f 625f 7265 7375 6c74 2872 6573  e_job_result(res
-0001bc10: 756c 743d 7265 7375 6c74 2929 0a20 2020  ult=result)).   
-0001bc20: 2065 6c73 653a 0a20 2020 2020 2020 2069   else:.        i
-0001bc30: 6620 6461 7461 2e67 6574 2822 7479 7065  f data.get("type
-0001bc40: 2229 203d 3d20 2264 6566 6175 6c74 2220  ") == "default" 
-0001bc50: 616e 6420 6e6f 7420 736b 6970 5f74 6f6b  and not skip_tok
-0001bc60: 656e 7320 616e 6420 6e6f 7420 6173 5f73  ens and not as_s
-0001bc70: 7461 6e64 6172 6420 616e 6420 6e6f 7420  tandard and not 
-0001bc80: 636f 7079 5f6e 6f64 6520 616e 6420 6e6f  copy_node and no
-0001bc90: 7420 7369 6e6b 5f6e 6f64 653a 0a20 2020  t sink_node:.   
-0001bca0: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
-0001bcb0: 3a20 7365 7420 6f70 7469 6f6e 2074 6f20  : set option to 
-0001bcc0: 6164 6420 6c61 7374 206e 6f64 6520 6173  add last node as
-0001bcd0: 2065 6e64 706f 696e 7420 696e 2074 6865   endpoint in the
-0001bce0: 2041 5049 0a20 2020 2020 2020 2020 2020   API.           
-0001bcf0: 2065 6e64 706f 696e 745f 6e6f 6465 203d   endpoint_node =
-0001bd00: 206e 6578 7428 0a20 2020 2020 2020 2020   next(.         
-0001bd10: 2020 2020 2020 2028 6e6f 6465 2066 6f72         (node for
-0001bd20: 206e 6f64 6520 696e 2064 6174 612e 6765   node in data.ge
-0001bd30: 7428 226e 6f64 6573 222c 205b 5d29 2069  t("nodes", []) i
-0001bd40: 6620 6e6f 6465 2e67 6574 2822 7479 7065  f node.get("type
-0001bd50: 2229 203d 3d20 2265 6e64 706f 696e 7422  ") == "endpoint"
-0001bd60: 292c 2064 6174 612e 6765 7428 226e 6f64  ), data.get("nod
-0001bd70: 6573 222c 205b 5d29 5b2d 315d 0a20 2020  es", [])[-1].   
-0001bd80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001bd90: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0001bda0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0001bdb0: 203d 2061 7761 6974 2074 625f 636c 6965   = await tb_clie
-0001bdc0: 6e74 2e5f 7265 7128 0a20 2020 2020 2020  nt._req(.       
-0001bdd0: 2020 2020 2020 2020 2020 2020 2066 222f               f"/
-0001bde0: 7630 2f70 6970 6573 2f7b 705b 276e 616d  v0/pipes/{p['nam
-0001bdf0: 6527 5d7d 2f6e 6f64 6573 2f7b 656e 6470  e']}/nodes/{endp
-0001be00: 6f69 6e74 5f6e 6f64 652e 6765 7428 2769  oint_node.get('i
-0001be10: 6427 297d 2f65 6e64 706f 696e 743f 7b75  d')}/endpoint?{u
-0001be20: 726c 656e 636f 6465 2863 6c69 5f70 6172  rlencode(cli_par
-0001be30: 616d 7329 7d22 2c0a 2020 2020 2020 2020  ams)}",.        
-0001be40: 2020 2020 2020 2020 2020 2020 6d65 7468              meth
-0001be50: 6f64 3d22 504f 5354 222c 0a20 2020 2020  od="POST",.     
-0001be60: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0001be70: 6561 6465 7273 3d68 6561 6465 7273 2c0a  eaders=headers,.
-0001be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be90: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-0001bea0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-0001beb0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-0001bec0: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-0001bed0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-0001bee0: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
-0001bef0: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-0001bf00: 6372 6561 7469 6e67 5f65 6e64 706f 696e  creating_endpoin
-0001bf10: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0001bf20: 2020 2020 2020 2020 2020 206e 6f64 653d             node=
-0001bf30: 656e 6470 6f69 6e74 5f6e 6f64 652e 6765  endpoint_node.ge
-0001bf40: 7428 226e 616d 6522 292c 2070 6970 653d  t("name"), pipe=
-0001bf50: 705b 226e 616d 6522 5d2c 2065 7272 6f72  p["name"], error
-0001bf60: 3d73 7472 2865 290a 2020 2020 2020 2020  =str(e).        
-0001bf70: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001bf80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0001bf90: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-0001bfa0: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
-0001bfb0: 4d61 6e61 6765 722e 7375 6363 6573 735f  Manager.success_
-0001bfc0: 7465 7374 5f65 6e64 706f 696e 745f 6e6f  test_endpoint_no
-0001bfd0: 5f74 6f6b 656e 2868 6f73 743d 686f 7374  _token(host=host
-0001bfe0: 2c20 7069 7065 3d70 5b22 6e61 6d65 225d  , pipe=p["name"]
-0001bff0: 2929 0a0a 2020 2020 6966 2063 6f70 795f  ))..    if copy_
-0001c000: 6e6f 6465 3a0a 2020 2020 2020 2020 7069  node:.        pi
-0001c010: 7065 5f69 6420 3d20 6461 7461 5b22 6964  pe_id = data["id
-0001c020: 225d 0a20 2020 2020 2020 206e 6f64 6520  "].        node 
-0001c030: 3d20 6e65 7874 2828 6e6f 6465 2066 6f72  = next((node for
-0001c040: 206e 6f64 6520 696e 2064 6174 615b 226e   node in data["n
-0001c050: 6f64 6573 225d 2069 6620 6e6f 6465 5b22  odes"] if node["
-0001c060: 6e6f 6465 5f74 7970 6522 5d20 3d3d 2022  node_type"] == "
-0001c070: 636f 7079 2229 2c20 4e6f 6e65 290a 2020  copy"), None).  
-0001c080: 2020 2020 2020 6966 206e 6f64 653a 0a20        if node:. 
-0001c090: 2020 2020 2020 2020 2020 2063 6f70 795f             copy_
-0001c0a0: 7061 7261 6d73 203d 207b 2270 6970 655f  params = {"pipe_
-0001c0b0: 6e61 6d65 5f6f 725f 6964 223a 2070 6970  name_or_id": pip
-0001c0c0: 655f 6964 2c20 226e 6f64 655f 6964 223a  e_id, "node_id":
-0001c0d0: 206e 6f64 655b 2269 6422 5d7d 0a20 2020   node["id"]}.   
-0001c0e0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0001c0f0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-0001c100: 7267 6574 5f64 6174 6173 6f75 7263 6520  rget_datasource 
-0001c110: 3d20 636f 7079 5f6e 6f64 652e 6765 7428  = copy_node.get(
-0001c120: 436f 7079 5061 7261 6d65 7465 7273 2e54  CopyParameters.T
-0001c130: 4152 4745 545f 4441 5441 534f 5552 4345  ARGET_DATASOURCE
-0001c140: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-0001c150: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-0001c160: 5f63 726f 6e20 3d20 636f 7079 5f6e 6f64  _cron = copy_nod
-0001c170: 652e 6765 7428 436f 7079 5061 7261 6d65  e.get(CopyParame
-0001c180: 7465 7273 2e43 4f50 595f 5343 4845 4455  ters.COPY_SCHEDU
-0001c190: 4c45 2c20 4e6f 6e65 290a 2020 2020 2020  LE, None).      
-0001c1a0: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
-0001c1b0: 6c65 5f63 726f 6e20 3d20 4e6f 6e65 2069  le_cron = None i
-0001c1c0: 6620 7363 6865 6475 6c65 5f63 726f 6e20  f schedule_cron 
-0001c1d0: 3d3d 204f 4e5f 4445 4d41 4e44 2065 6c73  == ON_DEMAND els
-0001c1e0: 6520 7363 6865 6475 6c65 5f63 726f 6e0a  e schedule_cron.
-0001c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c200: 6375 7272 656e 745f 7461 7267 6574 5f64  current_target_d
-0001c210: 6174 6173 6f75 7263 655f 6964 203d 2064  atasource_id = d
-0001c220: 6174 615b 2263 6f70 795f 7461 7267 6574  ata["copy_target
-0001c230: 5f64 6174 6173 6f75 7263 6522 5d0a 2020  _datasource"].  
-0001c240: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-0001c250: 7267 6574 5f64 6174 6173 6f75 7263 655f  rget_datasource_
-0001c260: 7265 7370 6f6e 7365 203d 2061 7761 6974  response = await
-0001c270: 2074 625f 636c 6965 6e74 2e67 6574 5f64   tb_client.get_d
-0001c280: 6174 6173 6f75 7263 6528 7461 7267 6574  atasource(target
-0001c290: 5f64 6174 6173 6f75 7263 6529 0a20 2020  _datasource).   
-0001c2a0: 2020 2020 2020 2020 2020 2020 2074 6172               tar
-0001c2b0: 6765 745f 6461 7461 736f 7572 6365 5f74  get_datasource_t
-0001c2c0: 6f5f 7365 6e64 203d 2028 0a20 2020 2020  o_send = (.     
-0001c2d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001c2e0: 6172 6765 745f 6461 7461 736f 7572 6365  arget_datasource
-0001c2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c300: 2020 2020 2069 6620 7461 7267 6574 5f64       if target_d
-0001c310: 6174 6173 6f75 7263 655f 7265 7370 6f6e  atasource_respon
-0001c320: 7365 2e67 6574 2822 6964 222c 2074 6172  se.get("id", tar
-0001c330: 6765 745f 6461 7461 736f 7572 6365 2920  get_datasource) 
-0001c340: 213d 2063 7572 7265 6e74 5f74 6172 6765  != current_targe
-0001c350: 745f 6461 7461 736f 7572 6365 5f69 640a  t_datasource_id.
-0001c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c370: 2020 2020 656c 7365 204e 6f6e 650a 2020      else None.  
-0001c380: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0001c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3a0: 636f 7079 5f70 6172 616d 735b 436f 7079  copy_params[Copy
-0001c3b0: 5061 7261 6d65 7465 7273 2e54 4152 4745  Parameters.TARGE
-0001c3c0: 545f 4441 5441 534f 5552 4345 5d20 3d20  T_DATASOURCE] = 
-0001c3d0: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
-0001c3e0: 655f 746f 5f73 656e 640a 2020 2020 2020  e_to_send.      
-0001c3f0: 2020 2020 2020 2020 2020 6375 7272 656e            curren
-0001c400: 745f 7363 6865 6475 6c65 203d 2064 6174  t_schedule = dat
-0001c410: 612e 6765 7428 2273 6368 6564 756c 6522  a.get("schedule"
-0001c420: 2c20 7b7d 290a 2020 2020 2020 2020 2020  , {}).          
-0001c430: 2020 2020 2020 6375 7272 656e 745f 7363        current_sc
-0001c440: 6865 6475 6c65 5f63 726f 6e20 3d20 6375  hedule_cron = cu
-0001c450: 7272 656e 745f 7363 6865 6475 6c65 2e67  rrent_schedule.g
-0001c460: 6574 2822 6372 6f6e 222c 204e 6f6e 6529  et("cron", None)
-0001c470: 2069 6620 6375 7272 656e 745f 7363 6865   if current_sche
-0001c480: 6475 6c65 2065 6c73 6520 4e6f 6e65 0a20  dule else None. 
-0001c490: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c4a0: 6368 6564 756c 655f 6372 6f6e 5f73 686f  chedule_cron_sho
-0001c4b0: 756c 645f 6265 5f72 656d 6f76 6564 203d  uld_be_removed =
-0001c4c0: 2063 7572 7265 6e74 5f73 6368 6564 756c   current_schedul
-0001c4d0: 655f 6372 6f6e 2061 6e64 206e 6f74 2073  e_cron and not s
-0001c4e0: 6368 6564 756c 655f 6372 6f6e 0a20 2020  chedule_cron.   
-0001c4f0: 2020 2020 2020 2020 2020 2020 2063 6f70               cop
-0001c500: 795f 7061 7261 6d73 5b22 7363 6865 6475  y_params["schedu
-0001c510: 6c65 5f63 726f 6e22 5d20 3d20 224e 6f6e  le_cron"] = "Non
-0001c520: 6522 2069 6620 7363 6865 6475 6c65 5f63  e" if schedule_c
-0001c530: 726f 6e5f 7368 6f75 6c64 5f62 655f 7265  ron_should_be_re
-0001c540: 6d6f 7665 6420 656c 7365 2073 6368 6564  moved else sched
-0001c550: 756c 655f 6372 6f6e 0a20 2020 2020 2020  ule_cron.       
-0001c560: 2020 2020 2020 2020 2061 7761 6974 2074           await t
-0001c570: 625f 636c 6965 6e74 2e70 6970 655f 7570  b_client.pipe_up
-0001c580: 6461 7465 5f63 6f70 7928 2a2a 636f 7079  date_copy(**copy
-0001c590: 5f70 6172 616d 7329 0a20 2020 2020 2020  _params).       
-0001c5a0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0001c5b0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
-0001c5c0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001c5d0: 6520 4578 6365 7074 696f 6e28 0a20 2020  e Exception(.   
-0001c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5f0: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
-0001c600: 2e65 7272 6f72 5f73 6574 7469 6e67 5f63  .error_setting_c
-0001c610: 6f70 795f 6e6f 6465 286e 6f64 653d 636f  opy_node(node=co
-0001c620: 7079 5f6e 6f64 652e 6765 7428 226e 616d  py_node.get("nam
-0001c630: 6522 292c 2070 6970 653d 705b 226e 616d  e"), pipe=p["nam
-0001c640: 6522 5d2c 2065 7272 6f72 3d73 7472 2865  e"], error=str(e
-0001c650: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0001c660: 2020 2029 0a0a 2020 2020 6966 2070 5b22     )..    if p["
-0001c670: 746f 6b65 6e73 225d 2061 6e64 206e 6f74  tokens"] and not
-0001c680: 2073 6b69 705f 746f 6b65 6e73 2061 6e64   skip_tokens and
-0001c690: 206e 6f74 2061 735f 7374 616e 6461 7264   not as_standard
-0001c6a0: 2061 6e64 2064 6174 612e 6765 7428 2274   and data.get("t
-0001c6b0: 7970 6522 2920 696e 205b 2265 6e64 706f  ype") in ["endpo
-0001c6c0: 696e 7422 2c20 2263 6f70 7922 5d3a 0a20  int", "copy"]:. 
-0001c6d0: 2020 2020 2020 2023 2073 6561 7263 6820         # search 
-0001c6e0: 666f 7220 746f 6b65 6e20 7769 7468 2073  for token with s
-0001c6f0: 7065 6369 6669 6564 206e 616d 6520 616e  pecified name an
-0001c700: 6420 6164 6473 2069 7420 6966 206e 6f74  d adds it if not
-0001c710: 2066 6f75 6e64 206f 7220 6164 6473 2070   found or adds p
-0001c720: 6572 6d69 7373 696f 6e73 2074 6f20 6974  ermissions to it
-0001c730: 0a20 2020 2020 2020 2074 203d 204e 6f6e  .        t = Non
-0001c740: 650a 2020 2020 2020 2020 666f 7220 746b  e.        for tk
-0001c750: 2069 6e20 705b 2274 6f6b 656e 7322 5d3a   in p["tokens"]:
-0001c760: 0a20 2020 2020 2020 2020 2020 2074 6f6b  .            tok
-0001c770: 656e 5f6e 616d 6520 3d20 746b 5b22 746f  en_name = tk["to
-0001c780: 6b65 6e5f 6e61 6d65 225d 0a20 2020 2020  ken_name"].     
-0001c790: 2020 2020 2020 2074 203d 2061 7761 6974         t = await
-0001c7a0: 2074 625f 636c 6965 6e74 2e67 6574 5f74   tb_client.get_t
-0001c7b0: 6f6b 656e 5f62 795f 6e61 6d65 2874 6f6b  oken_by_name(tok
-0001c7c0: 656e 5f6e 616d 6529 0a20 2020 2020 2020  en_name).       
-0001c7d0: 2020 2020 2069 6620 743a 0a20 2020 2020       if t:.     
-0001c7e0: 2020 2020 2020 2020 2020 2063 6c69 636b             click
-0001c7f0: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
-0001c800: 6e61 6765 722e 696e 666f 5f63 7265 6174  nager.info_creat
-0001c810: 655f 666f 756e 645f 746f 6b65 6e28 746f  e_found_token(to
-0001c820: 6b65 6e3d 746f 6b65 6e5f 6e61 6d65 2929  ken=token_name))
-0001c830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c840: 2073 636f 7065 7320 3d20 5b66 2250 4950   scopes = [f"PIP
-0001c850: 4553 3a7b 746b 5b27 7065 726d 6973 7369  ES:{tk['permissi
-0001c860: 6f6e 7327 5d7d 3a7b 705b 276e 616d 6527  ons']}:{p['name'
-0001c870: 5d7d 225d 0a20 2020 2020 2020 2020 2020  ]}"].           
-0001c880: 2020 2020 2066 6f72 2078 2069 6e20 745b       for x in t[
-0001c890: 2273 636f 7065 7322 5d3a 0a20 2020 2020  "scopes"]:.     
-0001c8a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c8b0: 6320 3d20 785b 2274 7970 6522 5d20 6966  c = x["type"] if
-0001c8c0: 2022 7265 736f 7572 6365 2220 6e6f 7420   "resource" not 
-0001c8d0: 696e 2078 2065 6c73 6520 6622 7b78 5b27  in x else f"{x['
-0001c8e0: 7479 7065 275d 7d3a 7b78 5b27 7265 736f  type']}:{x['reso
-0001c8f0: 7572 6365 275d 7d22 0a20 2020 2020 2020  urce']}".       
-0001c900: 2020 2020 2020 2020 2020 2020 2073 636f               sco
-0001c910: 7065 732e 6170 7065 6e64 2873 6329 0a20  pes.append(sc). 
-0001c920: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001c930: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0001c940: 2020 2020 2020 2020 7220 3d20 6177 6169          r = awai
-0001c950: 7420 7462 5f63 6c69 656e 742e 616c 7465  t tb_client.alte
-0001c960: 725f 746f 6b65 6e73 2874 6f6b 656e 5f6e  r_tokens(token_n
-0001c970: 616d 652c 2073 636f 7065 7329 0a20 2020  ame, scopes).   
-0001c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c990: 2074 6f6b 656e 203d 2072 5b22 746f 6b65   token = r["toke
-0001c9a0: 6e22 5d20 2023 2074 7970 653a 2069 676e  n"]  # type: ign
-0001c9b0: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
-0001c9c0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0001c9d0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0001c9e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001c9f0: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
-0001ca00: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
-0001ca10: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
-0001ca20: 6372 6561 7469 6e67 5f70 6970 6528 6572  creating_pipe(er
-0001ca30: 726f 723d 6529 290a 2020 2020 2020 2020  ror=e)).        
-0001ca40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001ca50: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
-0001ca60: 6e61 6d65 203d 2074 6b5b 2274 6f6b 656e  name = tk["token
-0001ca70: 5f6e 616d 6522 5d0a 2020 2020 2020 2020  _name"].        
-0001ca80: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-0001ca90: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
-0001caa0: 6572 2e69 6e66 6f5f 6372 6561 7465 5f6e  er.info_create_n
-0001cab0: 6f74 5f66 6f75 6e64 5f74 6f6b 656e 2874  ot_found_token(t
-0001cac0: 6f6b 656e 3d74 6f6b 656e 5f6e 616d 6529  oken=token_name)
-0001cad0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001cae0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0001caf0: 2020 2020 2020 2020 2020 2072 203d 2061             r = a
-0001cb00: 7761 6974 2074 625f 636c 6965 6e74 2e63  wait tb_client.c
-0001cb10: 7265 6174 655f 746f 6b65 6e28 0a20 2020  reate_token(.   
-0001cb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cb30: 2020 2020 2074 6f6b 656e 5f6e 616d 652c       token_name,
-0001cb40: 2066 2250 4950 4553 3a7b 746b 5b27 7065   f"PIPES:{tk['pe
-0001cb50: 726d 6973 7369 6f6e 7327 5d7d 3a7b 705b  rmissions']}:{p[
-0001cb60: 276e 616d 6527 5d7d 222c 2022 5022 2c20  'name']}", "P", 
-0001cb70: 705b 226e 616d 6522 5d0a 2020 2020 2020  p["name"].      
-0001cb80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0001cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cba0: 2020 2020 746f 6b65 6e20 3d20 725b 2274      token = r["t
-0001cbb0: 6f6b 656e 225d 2020 2320 7479 7065 3a20  oken"]  # type: 
-0001cbc0: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
-0001cbd0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0001cbe0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-0001cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc00: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
-0001cc10: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
-0001cc20: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-0001cc30: 6f72 5f63 7265 6174 696e 675f 7069 7065  or_creating_pipe
-0001cc40: 2865 7272 6f72 3d65 2929 0a0a 2020 2020  (error=e))..    
-0001cc50: 2020 2020 6966 2064 6174 612e 6765 7428      if data.get(
-0001cc60: 2274 7970 6522 2920 3d3d 2022 656e 6470  "type") == "endp
-0001cc70: 6f69 6e74 223a 0a20 2020 2020 2020 2020  oint":.         
-0001cc80: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
-0001cc90: 6564 6261 636b 4d61 6e61 6765 722e 7375  edbackManager.su
-0001cca0: 6363 6573 735f 7465 7374 5f65 6e64 706f  ccess_test_endpo
-0001ccb0: 696e 7428 686f 7374 3d68 6f73 742c 2070  int(host=host, p
-0001ccc0: 6970 653d 705b 226e 616d 6522 5d2c 2074  ipe=p["name"], t
-0001ccd0: 6f6b 656e 3d74 6f6b 656e 2929 0a0a 0a61  oken=token))...a
-0001cce0: 7379 6e63 2064 6566 2073 6861 7265 5f61  sync def share_a
-0001ccf0: 6e64 5f75 6e73 6861 7265 5f64 6174 6173  nd_unshare_datas
-0001cd00: 6f75 7263 6528 0a20 2020 2063 6c69 656e  ource(.    clien
-0001cd10: 743a 2054 696e 7942 2c0a 2020 2020 6461  t: TinyB,.    da
-0001cd20: 7461 736f 7572 6365 3a20 4469 6374 5b73  tasource: Dict[s
-0001cd30: 7472 2c20 416e 795d 2c0a 2020 2020 7573  tr, Any],.    us
-0001cd40: 6572 5f74 6f6b 656e 3a20 7374 722c 0a20  er_token: str,. 
-0001cd50: 2020 2077 6f72 6b73 7061 6365 735f 6375     workspaces_cu
-0001cd60: 7272 656e 745f 7368 6172 6564 5f77 6974  rrent_shared_wit
-0001cd70: 683a 204c 6973 745b 7374 725d 2c0a 2020  h: List[str],.  
-0001cd80: 2020 776f 726b 7370 6163 6573 5f74 6f5f    workspaces_to_
-0001cd90: 7368 6172 653a 204c 6973 745b 7374 725d  share: List[str]
-0001cda0: 2c0a 2020 2020 6375 7272 656e 745f 7773  ,.    current_ws
-0001cdb0: 3a20 4f70 7469 6f6e 616c 5b44 6963 745b  : Optional[Dict[
-0001cdc0: 7374 722c 2041 6e79 5d5d 2c0a 2920 2d3e  str, Any]],.) ->
-0001cdd0: 204e 6f6e 653a 0a20 2020 2064 6174 6173   None:.    datas
-0001cde0: 6f75 7263 655f 6e61 6d65 203d 2064 6174  ource_name = dat
-0001cdf0: 6173 6f75 7263 652e 6765 7428 226e 616d  asource.get("nam
-0001ce00: 6522 2c20 2222 290a 2020 2020 6461 7461  e", "").    data
-0001ce10: 736f 7572 6365 5f69 6420 3d20 6461 7461  source_id = data
-0001ce20: 736f 7572 6365 2e67 6574 2822 6964 222c  source.get("id",
-0001ce30: 2022 2229 0a20 2020 2077 6f72 6b73 7061   "").    workspa
-0001ce40: 6365 733a 204c 6973 745b 4469 6374 5b73  ces: List[Dict[s
-0001ce50: 7472 2c20 416e 795d 5d0a 0a20 2020 2023  tr, Any]]..    #
-0001ce60: 2049 6e20 6361 7365 2077 6520 6172 6520   In case we are 
-0001ce70: 7075 7368 696e 6720 746f 2061 2062 7261  pushing to a bra
-0001ce80: 6e63 682c 2077 6520 646f 6e27 7420 7368  nch, we don't sh
-0001ce90: 6172 6520 7468 6520 6461 7461 736f 7572  are the datasour
-0001cea0: 6365 0a20 2020 2023 2046 4958 4d45 3a20  ce.    # FIXME: 
-0001ceb0: 4861 7665 206f 6e6c 7920 6f6e 6365 2077  Have only once w
-0001cec0: 6179 2074 6f20 6765 7420 7468 6520 6375  ay to get the cu
-0001ced0: 7272 656e 7420 776f 726b 7370 6163 650a  rrent workspace.
-0001cee0: 2020 2020 6966 2063 7572 7265 6e74 5f77      if current_w
-0001cef0: 733a 0a20 2020 2020 2020 2023 2046 6f72  s:.        # For
-0001cf00: 6365 2074 6f20 6765 7420 616c 6c20 7468  ce to get all th
-0001cf10: 6520 776f 726b 7370 6163 6573 2074 6865  e workspaces the
-0001cf20: 2075 7365 7220 6361 6e20 6163 6365 7373   user can access
-0001cf30: 0a20 2020 2020 2020 2077 6f72 6b73 7061  .        workspa
-0001cf40: 6365 203d 2063 7572 7265 6e74 5f77 730a  ce = current_ws.
-0001cf50: 2020 2020 2020 2020 776f 726b 7370 6163          workspac
-0001cf60: 6573 203d 2028 6177 6169 7420 636c 6965  es = (await clie
-0001cf70: 6e74 2e75 7365 725f 776f 726b 7370 6163  nt.user_workspac
-0001cf80: 6573 2829 292e 6765 7428 2277 6f72 6b73  es()).get("works
-0001cf90: 7061 6365 7322 2c20 5b5d 290a 2020 2020  paces", []).    
-0001cfa0: 656c 7365 3a0a 2020 2020 2020 2020 776f  else:.        wo
-0001cfb0: 726b 7370 6163 6520 3d20 6177 6169 7420  rkspace = await 
-0001cfc0: 636c 6965 6e74 2e75 7365 725f 776f 726b  client.user_work
-0001cfd0: 7370 6163 655f 6272 616e 6368 6573 2829  space_branches()
-0001cfe0: 0a20 2020 2020 2020 2077 6f72 6b73 7061  .        workspa
-0001cff0: 6365 7320 3d20 776f 726b 7370 6163 652e  ces = workspace.
-0001d000: 6765 7428 2277 6f72 6b73 7061 6365 7322  get("workspaces"
-0001d010: 2c20 5b5d 290a 0a20 2020 2069 6620 776f  , [])..    if wo
-0001d020: 726b 7370 6163 652e 6765 7428 2269 735f  rkspace.get("is_
-0001d030: 6272 616e 6368 222c 2046 616c 7365 293a  branch", False):
-0001d040: 0a20 2020 2020 2020 2063 6c69 636b 2e65  .        click.e
-0001d050: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-0001d060: 6765 722e 696e 666f 5f73 6b69 7070 696e  ger.info_skippin
-0001d070: 675f 7368 6172 696e 675f 6461 7461 736f  g_sharing_dataso
-0001d080: 7572 6365 735f 6272 616e 6368 2864 6174  urces_branch(dat
-0001d090: 6173 6f75 7263 653d 6461 7461 736f 7572  asource=datasour
-0001d0a0: 6365 5b22 6e61 6d65 225d 2929 0a20 2020  ce["name"])).   
-0001d0b0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0001d0c0: 2023 2057 6520 6475 706c 6963 6174 6520   # We duplicate 
-0001d0d0: 7468 6520 636c 6965 6e74 2074 6f20 7573  the client to us
-0001d0e0: 6520 7468 6520 7573 6572 5f74 6f6b 656e  e the user_token
-0001d0f0: 0a20 2020 2075 7365 725f 636c 6965 6e74  .    user_client
-0001d100: 3a20 5469 6e79 4220 3d20 6465 6570 636f  : TinyB = deepco
-0001d110: 7079 2863 6c69 656e 7429 0a20 2020 2075  py(client).    u
-0001d120: 7365 725f 636c 6965 6e74 2e74 6f6b 656e  ser_client.token
-0001d130: 203d 2075 7365 725f 746f 6b65 6e0a 2020   = user_token.  
-0001d140: 2020 6966 206e 6f74 2077 6f72 6b73 7061    if not workspa
-0001d150: 6365 735f 6375 7272 656e 745f 7368 6172  ces_current_shar
-0001d160: 6564 5f77 6974 683a 0a20 2020 2020 2020  ed_with:.       
-0001d170: 2066 6f72 2077 6f72 6b73 7061 6365 5f74   for workspace_t
-0001d180: 6f5f 7368 6172 6520 696e 2077 6f72 6b73  o_share in works
-0001d190: 7061 6365 735f 746f 5f73 6861 7265 3a0a  paces_to_share:.
-0001d1a0: 2020 2020 2020 2020 2020 2020 773a 204f              w: O
-0001d1b0: 7074 696f 6e61 6c5b 4469 6374 5b73 7472  ptional[Dict[str
-0001d1c0: 2c20 416e 795d 5d20 3d20 6e65 7874 2828  , Any]] = next((
-0001d1d0: 7720 666f 7220 7720 696e 2077 6f72 6b73  w for w in works
-0001d1e0: 7061 6365 7320 6966 2077 5b22 6e61 6d65  paces if w["name
-0001d1f0: 225d 203d 3d20 776f 726b 7370 6163 655f  "] == workspace_
-0001d200: 746f 5f73 6861 7265 292c 204e 6f6e 6529  to_share), None)
-0001d210: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001d220: 6e6f 7420 773a 0a20 2020 2020 2020 2020  not w:.         
-0001d230: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-0001d240: 6570 7469 6f6e 280a 2020 2020 2020 2020  eption(.        
-0001d250: 2020 2020 2020 2020 2020 2020 6622 556e              f"Un
-0001d260: 6162 6c65 2074 6f20 7368 6172 6520 6461  able to share da
-0001d270: 7461 736f 7572 6365 2077 6974 6820 7468  tasource with th
-0001d280: 6520 776f 726b 7370 6163 6520 7b77 6f72  e workspace {wor
-0001d290: 6b73 7061 6365 5f74 6f5f 7368 6172 657d  kspace_to_share}
-0001d2a0: 2e20 5265 7669 6577 2074 6861 7420 796f  . Review that yo
-0001d2b0: 7520 6861 7665 2074 6865 2061 646d 696e  u have the admin
-0001d2c0: 2070 6572 6d69 7373 696f 6e73 206f 6e20   permissions on 
-0001d2d0: 7468 6973 2077 6f72 6b73 7061 6365 220a  this workspace".
-0001d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2f0: 290a 0a20 2020 2020 2020 2020 2020 2061  )..            a
-0001d300: 7761 6974 2075 7365 725f 636c 6965 6e74  wait user_client
-0001d310: 2e64 6174 6173 6f75 7263 655f 7368 6172  .datasource_shar
-0001d320: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0001d330: 2020 2064 6174 6173 6f75 7263 655f 6964     datasource_id
-0001d340: 3d64 6174 6173 6f75 7263 655f 6964 2c0a  =datasource_id,.
-0001d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d360: 6375 7272 656e 745f 776f 726b 7370 6163  current_workspac
-0001d370: 655f 6964 3d77 6f72 6b73 7061 6365 2e67  e_id=workspace.g
-0001d380: 6574 2822 6964 222c 2022 2229 2c0a 2020  et("id", ""),.  
-0001d390: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0001d3a0: 7374 696e 6174 696f 6e5f 776f 726b 7370  stination_worksp
-0001d3b0: 6163 655f 6964 3d77 2e67 6574 2822 6964  ace_id=w.get("id
-0001d3c0: 222c 2022 2229 2c0a 2020 2020 2020 2020  ", ""),.        
-0001d3d0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001d3e0: 2020 636c 6963 6b2e 6563 686f 280a 2020    click.echo(.  
-0001d3f0: 2020 2020 2020 2020 2020 2020 2020 4665                Fe
-0001d400: 6564 6261 636b 4d61 6e61 6765 722e 7375  edbackManager.su
-0001d410: 6363 6573 735f 6461 7461 736f 7572 6365  ccess_datasource
-0001d420: 5f73 6861 7265 6428 6461 7461 736f 7572  _shared(datasour
-0001d430: 6365 3d64 6174 6173 6f75 7263 655f 6e61  ce=datasource_na
-0001d440: 6d65 2c20 776f 726b 7370 6163 653d 772e  me, workspace=w.
-0001d450: 6765 7428 226e 616d 6522 2c20 2222 2929  get("name", ""))
-0001d460: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001d470: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001d480: 2073 6861 7265 645f 7769 7468 203d 205b   shared_with = [
-0001d490: 0a20 2020 2020 2020 2020 2020 2077 0a20  .            w. 
-0001d4a0: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-0001d4b0: 2069 6e20 776f 726b 7370 6163 6573 0a20   in workspaces. 
-0001d4c0: 2020 2020 2020 2020 2020 2069 6620 6e65             if ne
-0001d4d0: 7874 2828 7773 2066 6f72 2077 7320 696e  xt((ws for ws in
-0001d4e0: 2077 6f72 6b73 7061 6365 735f 6375 7272   workspaces_curr
-0001d4f0: 656e 745f 7368 6172 6564 5f77 6974 6820  ent_shared_with 
-0001d500: 6966 2077 7320 3d3d 2077 5b22 6964 225d  if ws == w["id"]
-0001d510: 206f 7220 7773 203d 3d20 775b 226e 616d   or ws == w["nam
-0001d520: 6522 5d29 2c20 4e6f 6e65 290a 2020 2020  e"]), None).    
-0001d530: 2020 2020 5d0a 2020 2020 2020 2020 6465      ].        de
-0001d540: 6669 6e65 645f 746f 5f73 6861 7265 5f77  fined_to_share_w
-0001d550: 6974 6820 3d20 5b0a 2020 2020 2020 2020  ith = [.        
-0001d560: 2020 2020 7720 666f 7220 7720 696e 2077      w for w in w
-0001d570: 6f72 6b73 7061 6365 7320 6966 206e 6578  orkspaces if nex
-0001d580: 7428 2877 7320 666f 7220 7773 2069 6e20  t((ws for ws in 
-0001d590: 776f 726b 7370 6163 6573 5f74 6f5f 7368  workspaces_to_sh
-0001d5a0: 6172 6520 6966 2077 7320 3d3d 2077 5b22  are if ws == w["
-0001d5b0: 6964 225d 206f 7220 7773 203d 3d20 775b  id"] or ws == w[
-0001d5c0: 226e 616d 6522 5d29 2c20 4e6f 6e65 290a  "name"]), None).
-0001d5d0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-0001d5e0: 2020 776f 726b 7370 6163 6573 5f6e 6565    workspaces_nee
-0001d5f0: 645f 746f 5f73 6861 7265 203d 205b 7720  d_to_share = [w 
-0001d600: 666f 7220 7720 696e 2064 6566 696e 6564  for w in defined
-0001d610: 5f74 6f5f 7368 6172 655f 7769 7468 2069  _to_share_with i
-0001d620: 6620 7720 6e6f 7420 696e 2073 6861 7265  f w not in share
-0001d630: 645f 7769 7468 5d0a 2020 2020 2020 2020  d_with].        
-0001d640: 776f 726b 7370 6163 6573 5f6e 6565 645f  workspaces_need_
-0001d650: 746f 5f75 6e73 6861 7265 203d 205b 7720  to_unshare = [w 
-0001d660: 666f 7220 7720 696e 2073 6861 7265 645f  for w in shared_
-0001d670: 7769 7468 2069 6620 7720 6e6f 7420 696e  with if w not in
-0001d680: 2064 6566 696e 6564 5f74 6f5f 7368 6172   defined_to_shar
-0001d690: 655f 7769 7468 5d0a 0a20 2020 2020 2020  e_with]..       
-0001d6a0: 2066 6f72 2077 2069 6e20 776f 726b 7370   for w in worksp
-0001d6b0: 6163 6573 5f6e 6565 645f 746f 5f73 6861  aces_need_to_sha
-0001d6c0: 7265 3a0a 2020 2020 2020 2020 2020 2020  re:.            
-0001d6d0: 6177 6169 7420 7573 6572 5f63 6c69 656e  await user_clien
-0001d6e0: 742e 6461 7461 736f 7572 6365 5f73 6861  t.datasource_sha
-0001d6f0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-0001d700: 2020 2020 6461 7461 736f 7572 6365 5f69      datasource_i
-0001d710: 643d 6461 7461 736f 7572 6365 5f69 642c  d=datasource_id,
-0001d720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d730: 2063 7572 7265 6e74 5f77 6f72 6b73 7061   current_workspa
-0001d740: 6365 5f69 643d 776f 726b 7370 6163 652e  ce_id=workspace.
-0001d750: 6765 7428 2269 6422 2c20 2222 292c 0a20  get("id", ""),. 
-0001d760: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001d770: 6573 7469 6e61 7469 6f6e 5f77 6f72 6b73  estination_works
-0001d780: 7061 6365 5f69 643d 772e 6765 7428 2269  pace_id=w.get("i
-0001d790: 6422 2c20 2222 292c 0a20 2020 2020 2020  d", ""),.       
-0001d7a0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0001d7b0: 2020 2063 6c69 636b 2e65 6368 6f28 0a20     click.echo(. 
-0001d7c0: 2020 2020 2020 2020 2020 2020 2020 2046                 F
-0001d7d0: 6565 6462 6163 6b4d 616e 6167 6572 2e73  eedbackManager.s
-0001d7e0: 7563 6365 7373 5f64 6174 6173 6f75 7263  uccess_datasourc
-0001d7f0: 655f 7368 6172 6564 2864 6174 6173 6f75  e_shared(datasou
-0001d800: 7263 653d 6461 7461 736f 7572 6365 5b22  rce=datasource["
-0001d810: 6e61 6d65 225d 2c20 776f 726b 7370 6163  name"], workspac
-0001d820: 653d 772e 6765 7428 226e 616d 6522 2c20  e=w.get("name", 
-0001d830: 2222 2929 0a20 2020 2020 2020 2020 2020  "")).           
-0001d840: 2029 0a0a 2020 2020 2020 2020 666f 7220   )..        for 
-0001d850: 7720 696e 2077 6f72 6b73 7061 6365 735f  w in workspaces_
-0001d860: 6e65 6564 5f74 6f5f 756e 7368 6172 653a  need_to_unshare:
-0001d870: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-0001d880: 6974 2075 7365 725f 636c 6965 6e74 2e64  it user_client.d
-0001d890: 6174 6173 6f75 7263 655f 756e 7368 6172  atasource_unshar
-0001d8a0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0001d8b0: 2020 2064 6174 6173 6f75 7263 655f 6964     datasource_id
-0001d8c0: 3d64 6174 6173 6f75 7263 655f 6964 2c0a  =datasource_id,.
-0001d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8e0: 6375 7272 656e 745f 776f 726b 7370 6163  current_workspac
-0001d8f0: 655f 6964 3d77 6f72 6b73 7061 6365 2e67  e_id=workspace.g
-0001d900: 6574 2822 6964 222c 2022 2229 2c0a 2020  et("id", ""),.  
-0001d910: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0001d920: 7374 696e 6174 696f 6e5f 776f 726b 7370  stination_worksp
-0001d930: 6163 655f 6964 3d77 2e67 6574 2822 6964  ace_id=w.get("id
-0001d940: 222c 2022 2229 2c0a 2020 2020 2020 2020  ", ""),.        
-0001d950: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001d960: 2020 636c 6963 6b2e 6563 686f 280a 2020    click.echo(.  
-0001d970: 2020 2020 2020 2020 2020 2020 2020 4665                Fe
-0001d980: 6564 6261 636b 4d61 6e61 6765 722e 7375  edbackManager.su
-0001d990: 6363 6573 735f 6461 7461 736f 7572 6365  ccess_datasource
-0001d9a0: 5f75 6e73 6861 7265 6428 6461 7461 736f  _unshared(dataso
-0001d9b0: 7572 6365 3d64 6174 6173 6f75 7263 655f  urce=datasource_
-0001d9c0: 6e61 6d65 2c20 776f 726b 7370 6163 653d  name, workspace=
-0001d9d0: 772e 6765 7428 226e 616d 6522 2c20 2222  w.get("name", ""
-0001d9e0: 2929 0a20 2020 2020 2020 2020 2020 2029  )).            )
-0001d9f0: 0a0a 0a61 7379 6e63 2064 6566 206e 6577  ...async def new
-0001da00: 5f64 7328 0a20 2020 2064 733a 2044 6963  _ds(.    ds: Dic
-0001da10: 745b 7374 722c 2041 6e79 5d2c 0a20 2020  t[str, Any],.   
-0001da20: 2063 6c69 656e 743a 2054 696e 7942 2c0a   client: TinyB,.
-0001da30: 2020 2020 7573 6572 5f74 6f6b 656e 3a20      user_token: 
-0001da40: 4f70 7469 6f6e 616c 5b73 7472 5d2c 0a20  Optional[str],. 
-0001da50: 2020 2066 6f72 6365 3a20 626f 6f6c 203d     force: bool =
-0001da60: 2046 616c 7365 2c0a 2020 2020 736b 6970   False,.    skip
-0001da70: 5f63 6f6e 6669 726d 6174 696f 6e3a 2062  _confirmation: b
-0001da80: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-0001da90: 2063 7572 7265 6e74 5f77 733d 4e6f 6e65   current_ws=None
-0001daa0: 2c0a 2020 2020 666f 726b 5f64 6f77 6e73  ,.    fork_downs
-0001dab0: 7472 6561 6d3a 204f 7074 696f 6e61 6c5b  tream: Optional[
-0001dac0: 626f 6f6c 5d20 3d20 4661 6c73 652c 0a20  bool] = False,. 
-0001dad0: 2020 2066 6f72 6b3a 204f 7074 696f 6e61     fork: Optiona
-0001dae0: 6c5b 626f 6f6c 5d20 3d20 4661 6c73 652c  l[bool] = False,
-0001daf0: 0a20 2020 2067 6974 5f72 656c 6561 7365  .    git_release
-0001db00: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
-0001db10: 203d 2046 616c 7365 2c0a 293a 0a20 2020   = False,.):.   
-0001db20: 2064 735f 6e61 6d65 203d 2064 735b 2270   ds_name = ds["p
-0001db30: 6172 616d 7322 5d5b 226e 616d 6522 5d0a  arams"]["name"].
-0001db40: 0a20 2020 2061 7379 6e63 2064 6566 206d  .    async def m
-0001db50: 616e 6167 655f 746f 6b65 6e73 2829 3a0a  anage_tokens():.
-0001db60: 2020 2020 2020 2020 2320 7365 6172 6368          # search
-0001db70: 2066 6f72 2074 6f6b 656e 2077 6974 6820   for token with 
-0001db80: 7370 6563 6966 6965 6420 6e61 6d65 2061  specified name a
-0001db90: 6e64 2061 6464 7320 6974 2069 6620 6e6f  nd adds it if no
-0001dba0: 7420 666f 756e 6420 6f72 2061 6464 7320  t found or adds 
-0001dbb0: 7065 726d 6973 7369 6f6e 7320 746f 2069  permissions to i
-0001dbc0: 740a 2020 2020 2020 2020 7420 3d20 4e6f  t.        t = No
-0001dbd0: 6e65 0a20 2020 2020 2020 2066 6f72 2074  ne.        for t
-0001dbe0: 6b20 696e 2064 735b 2274 6f6b 656e 7322  k in ds["tokens"
-0001dbf0: 5d3a 0a20 2020 2020 2020 2020 2020 2074  ]:.            t
-0001dc00: 6f6b 656e 5f6e 616d 6520 3d20 746b 5b22  oken_name = tk["
-0001dc10: 746f 6b65 6e5f 6e61 6d65 225d 0a20 2020  token_name"].   
-0001dc20: 2020 2020 2020 2020 2074 203d 2061 7761           t = awa
-0001dc30: 6974 2063 6c69 656e 742e 6765 745f 746f  it client.get_to
-0001dc40: 6b65 6e5f 6279 5f6e 616d 6528 746f 6b65  ken_by_name(toke
-0001dc50: 6e5f 6e61 6d65 290a 2020 2020 2020 2020  n_name).        
-0001dc60: 2020 2020 6966 2074 3a0a 2020 2020 2020      if t:.      
-0001dc70: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0001dc80: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
-0001dc90: 3a0a 2020 2020 2020 2020 2020 2020 746f  :.            to
-0001dca0: 6b65 6e5f 6e61 6d65 203d 2074 6b5b 2274  ken_name = tk["t
-0001dcb0: 6f6b 656e 5f6e 616d 6522 5d0a 2020 2020  oken_name"].    
-0001dcc0: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-0001dcd0: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
-0001dce0: 6572 2e69 6e66 6f5f 6372 6561 7465 5f6e  er.info_create_n
-0001dcf0: 6f74 5f66 6f75 6e64 5f74 6f6b 656e 2874  ot_found_token(t
-0001dd00: 6f6b 656e 3d74 6f6b 656e 5f6e 616d 6529  oken=token_name)
-0001dd10: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-0001dd20: 4453 203d 3d20 746f 6b65 6e5f 6f72 6967  DS == token_orig
-0001dd30: 696e 2e4f 7269 6769 6e73 2e44 4154 4153  in.Origins.DATAS
-0001dd40: 4f55 5243 450a 2020 2020 2020 2020 2020  OURCE.          
-0001dd50: 2020 6177 6169 7420 636c 6965 6e74 2e63    await client.c
-0001dd60: 7265 6174 655f 746f 6b65 6e28 746f 6b65  reate_token(toke
-0001dd70: 6e5f 6e61 6d65 2c20 6622 4441 5441 534f  n_name, f"DATASO
-0001dd80: 5552 4345 533a 7b74 6b5b 2770 6572 6d69  URCES:{tk['permi
-0001dd90: 7373 696f 6e73 275d 7d3a 7b64 735f 6e61  ssions']}:{ds_na
-0001dda0: 6d65 7d22 2c20 2244 5322 2c20 6473 5f6e  me}", "DS", ds_n
-0001ddb0: 616d 6529 0a20 2020 2020 2020 2065 6c73  ame).        els
-0001ddc0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-0001ddd0: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
-0001dde0: 636b 4d61 6e61 6765 722e 696e 666f 5f63  ckManager.info_c
-0001ddf0: 7265 6174 655f 666f 756e 645f 746f 6b65  reate_found_toke
-0001de00: 6e28 746f 6b65 6e3d 746f 6b65 6e5f 6e61  n(token=token_na
-0001de10: 6d65 2929 0a20 2020 2020 2020 2020 2020  me)).           
-0001de20: 2073 636f 7065 7320 3d20 5b66 2244 4154   scopes = [f"DAT
-0001de30: 4153 4f55 5243 4553 3a7b 746b 5b27 7065  ASOURCES:{tk['pe
-0001de40: 726d 6973 7369 6f6e 7327 5d7d 3a7b 6473  rmissions']}:{ds
-0001de50: 5f6e 616d 657d 225d 0a20 2020 2020 2020  _name}"].       
-0001de60: 2020 2020 2066 6f72 2078 2069 6e20 745b       for x in t[
-0001de70: 2273 636f 7065 7322 5d3a 0a20 2020 2020  "scopes"]:.     
-0001de80: 2020 2020 2020 2020 2020 2073 6320 3d20             sc = 
-0001de90: 785b 2274 7970 6522 5d20 6966 2022 7265  x["type"] if "re
-0001dea0: 736f 7572 6365 2220 6e6f 7420 696e 2078  source" not in x
-0001deb0: 2065 6c73 6520 6622 7b78 5b27 7479 7065   else f"{x['type
-0001dec0: 275d 7d3a 7b78 5b27 7265 736f 7572 6365  ']}:{x['resource
-0001ded0: 275d 7d22 0a20 2020 2020 2020 2020 2020  ']}".           
-0001dee0: 2020 2020 2073 636f 7065 732e 6170 7065       scopes.appe
-0001def0: 6e64 2873 6329 0a20 2020 2020 2020 2020  nd(sc).         
-0001df00: 2020 2061 7761 6974 2063 6c69 656e 742e     await client.
-0001df10: 616c 7465 725f 746f 6b65 6e73 2874 6f6b  alter_tokens(tok
-0001df20: 656e 5f6e 616d 652c 2073 636f 7065 7329  en_name, scopes)
-0001df30: 0a0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
-0001df40: 2020 2065 7869 7374 696e 675f 6473 203d     existing_ds =
-0001df50: 2061 7761 6974 2063 6c69 656e 742e 6765   await client.ge
-0001df60: 745f 6461 7461 736f 7572 6365 2864 735f  t_datasource(ds_
-0001df70: 6e61 6d65 290a 2020 2020 2020 2020 6461  name).        da
-0001df80: 7461 736f 7572 6365 5f65 7869 7374 7320  tasource_exists 
-0001df90: 3d20 5472 7565 0a20 2020 2065 7863 6570  = True.    excep
-0001dfa0: 7420 446f 6573 4e6f 7445 7869 7374 4578  t DoesNotExistEx
-0001dfb0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-0001dfc0: 2064 6174 6173 6f75 7263 655f 6578 6973   datasource_exis
-0001dfd0: 7473 203d 2046 616c 7365 0a0a 2020 2020  ts = False..    
-0001dfe0: 6966 206e 6f74 2064 6174 6173 6f75 7263  if not datasourc
-0001dff0: 655f 6578 6973 7473 206f 7220 666f 726b  e_exists or fork
-0001e000: 5f64 6f77 6e73 7472 6561 6d20 6f72 2066  _downstream or f
-0001e010: 6f72 6b3a 0a20 2020 2020 2020 2070 6172  ork:.        par
-0001e020: 616d 7320 3d20 6473 5b22 7061 7261 6d73  ams = ds["params
-0001e030: 225d 0a20 2020 2020 2020 2070 6172 616d  "].        param
-0001e040: 735b 2262 7261 6e63 685f 6d6f 6465 225d  s["branch_mode"]
-0001e050: 203d 2022 666f 726b 2220 6966 2066 6f72   = "fork" if for
-0001e060: 6b5f 646f 776e 7374 7265 616d 206f 7220  k_downstream or 
-0001e070: 666f 726b 2065 6c73 6520 224e 6f6e 6522  fork else "None"
-0001e080: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-0001e090: 2020 2020 2020 2020 2020 2069 6620 280a             if (.
-0001e0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e0b0: 7061 7261 6d73 2e67 6574 2822 7365 7276  params.get("serv
-0001e0c0: 6963 6522 2920 696e 2050 5245 5649 4557  ice") in PREVIEW
-0001e0d0: 5f43 4f4e 4e45 4354 4f52 5f53 4552 5649  _CONNECTOR_SERVI
-0001e0e0: 4345 530a 2020 2020 2020 2020 2020 2020  CES.            
-0001e0f0: 2020 2020 616e 6420 7061 7261 6d73 2e67      and params.g
-0001e100: 6574 2822 636f 6e6e 6563 746f 7222 290a  et("connector").
-0001e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e120: 616e 6420 7061 7261 6d73 2e67 6574 2822  and params.get("
-0001e130: 6275 636b 6574 5f75 7269 2229 0a20 2020  bucket_uri").   
-0001e140: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
-0001e150: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0001e160: 203d 2061 7761 6974 2063 6c69 656e 742e   = await client.
-0001e170: 7072 6576 6965 775f 6275 636b 6574 2870  preview_bucket(p
-0001e180: 6172 616d 735b 2263 6f6e 6e65 6374 6f72  arams["connector
-0001e190: 225d 2c20 7061 7261 6d73 5b22 6275 636b  "], params["buck
-0001e1a0: 6574 5f75 7269 225d 290a 2020 2020 2020  et_uri"]).      
-0001e1b0: 2020 2020 2020 2020 2020 6966 2064 6174            if dat
-0001e1c0: 613a 0a20 2020 2020 2020 2020 2020 2020  a:.             
-0001e1d0: 2020 2020 2020 2066 696c 6573 203d 2064         files = d
-0001e1e0: 6174 612e 6765 7428 2266 696c 6573 222c  ata.get("files",
-0001e1f0: 205b 5d29 0a20 2020 2020 2020 2020 2020   []).           
-0001e200: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-0001e210: 6669 6c65 7329 203e 2030 3a0a 2020 2020  files) > 0:.    
+0001ba00: 6765 722e 696e 666f 5f6d 6174 6572 6961  ger.info_materia
+0001ba10: 6c69 7a65 645f 6461 7461 736f 7572 6365  lized_datasource
+0001ba20: 5f75 7365 6428 7069 7065 3d70 5b22 6e61  _used(pipe=p["na
+0001ba30: 6d65 225d 2c20 6461 7461 736f 7572 6365  me"], datasource
+0001ba40: 3d64 6174 6173 6f75 7263 655b 226e 616d  =datasource["nam
+0001ba50: 6522 5d29 290a 0a20 2020 2069 6620 6461  e"]))..    if da
+0001ba60: 7461 736f 7572 6365 2061 6e64 2070 6f70  tasource and pop
+0001ba70: 756c 6174 6520 616e 6420 6e6f 7420 636f  ulate and not co
+0001ba80: 7079 5f6e 6f64 653a 0a20 2020 2020 2020  py_node:.       
+0001ba90: 206a 6f62 5f75 726c 203d 2064 6174 612e   job_url = data.
+0001baa0: 6765 7428 226a 6f62 222c 207b 7d29 2e67  get("job", {}).g
+0001bab0: 6574 2822 6a6f 625f 7572 6c22 2c20 4e6f  et("job_url", No
+0001bac0: 6e65 290a 2020 2020 2020 2020 6a6f 625f  ne).        job_
+0001bad0: 6964 203d 2064 6174 612e 6765 7428 226a  id = data.get("j
+0001bae0: 6f62 222c 207b 7d29 2e67 6574 2822 6a6f  ob", {}).get("jo
+0001baf0: 625f 6964 222c 204e 6f6e 6529 0a20 2020  b_id", None).   
+0001bb00: 2020 2020 2069 6620 706f 7075 6c61 7465       if populate
+0001bb10: 5f73 7562 7365 743a 0a20 2020 2020 2020  _subset:.       
+0001bb20: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001bb30: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0001bb40: 696e 666f 5f70 6f70 756c 6174 655f 7375  info_populate_su
+0001bb50: 6273 6574 5f6a 6f62 5f75 726c 2875 726c  bset_job_url(url
+0001bb60: 3d6a 6f62 5f75 726c 2c20 7375 6273 6574  =job_url, subset
+0001bb70: 3d70 6f70 756c 6174 655f 7375 6273 6574  =populate_subset
+0001bb80: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
+0001bb90: 706f 7075 6c61 7465 5f63 6f6e 6469 7469  populate_conditi
+0001bba0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+0001bbb0: 636c 6963 6b2e 6563 686f 280a 2020 2020  click.echo(.    
+0001bbc0: 2020 2020 2020 2020 2020 2020 4665 6564              Feed
+0001bbd0: 6261 636b 4d61 6e61 6765 722e 696e 666f  backManager.info
+0001bbe0: 5f70 6f70 756c 6174 655f 636f 6e64 6974  _populate_condit
+0001bbf0: 696f 6e5f 6a6f 625f 7572 6c28 7572 6c3d  ion_job_url(url=
+0001bc00: 6a6f 625f 7572 6c2c 2070 6f70 756c 6174  job_url, populat
+0001bc10: 655f 636f 6e64 6974 696f 6e3d 706f 7075  e_condition=popu
+0001bc20: 6c61 7465 5f63 6f6e 6469 7469 6f6e 290a  late_condition).
+0001bc30: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001bc40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001bc50: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
+0001bc60: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
+0001bc70: 6572 2e69 6e66 6f5f 706f 7075 6c61 7465  er.info_populate
+0001bc80: 5f6a 6f62 5f75 726c 2875 726c 3d6a 6f62  _job_url(url=job
+0001bc90: 5f75 726c 2929 0a0a 2020 2020 2020 2020  _url))..        
+0001bca0: 6966 2077 6169 745f 706f 7075 6c61 7465  if wait_populate
+0001bcb0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001bcc0: 7375 6c74 203d 2061 7761 6974 2077 6169  sult = await wai
+0001bcd0: 745f 6a6f 6228 7462 5f63 6c69 656e 742c  t_job(tb_client,
+0001bce0: 206a 6f62 5f69 642c 206a 6f62 5f75 726c   job_id, job_url
+0001bcf0: 2c20 2250 6f70 756c 6174 696e 6722 2c20  , "Populating", 
+0001bd00: 7469 6d65 6f75 7429 0a20 2020 2020 2020  timeout).       
+0001bd10: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001bd20: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0001bd30: 696e 666f 5f70 6f70 756c 6174 655f 6a6f  info_populate_jo
+0001bd40: 625f 7265 7375 6c74 2872 6573 756c 743d  b_result(result=
+0001bd50: 7265 7375 6c74 2929 0a20 2020 2065 6c73  result)).    els
+0001bd60: 653a 0a20 2020 2020 2020 2069 6620 6461  e:.        if da
+0001bd70: 7461 2e67 6574 2822 7479 7065 2229 203d  ta.get("type") =
+0001bd80: 3d20 2264 6566 6175 6c74 2220 616e 6420  = "default" and 
+0001bd90: 6e6f 7420 736b 6970 5f74 6f6b 656e 7320  not skip_tokens 
+0001bda0: 616e 6420 6e6f 7420 6173 5f73 7461 6e64  and not as_stand
+0001bdb0: 6172 6420 616e 6420 6e6f 7420 636f 7079  ard and not copy
+0001bdc0: 5f6e 6f64 6520 616e 6420 6e6f 7420 7369  _node and not si
+0001bdd0: 6e6b 5f6e 6f64 653a 0a20 2020 2020 2020  nk_node:.       
+0001bde0: 2020 2020 2023 2046 4958 4d45 3a20 7365       # FIXME: se
+0001bdf0: 7420 6f70 7469 6f6e 2074 6f20 6164 6420  t option to add 
+0001be00: 6c61 7374 206e 6f64 6520 6173 2065 6e64  last node as end
+0001be10: 706f 696e 7420 696e 2074 6865 2041 5049  point in the API
+0001be20: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
+0001be30: 706f 696e 745f 6e6f 6465 203d 206e 6578  point_node = nex
+0001be40: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0001be50: 2020 2028 6e6f 6465 2066 6f72 206e 6f64     (node for nod
+0001be60: 6520 696e 2064 6174 612e 6765 7428 226e  e in data.get("n
+0001be70: 6f64 6573 222c 205b 5d29 2069 6620 6e6f  odes", []) if no
+0001be80: 6465 2e67 6574 2822 7479 7065 2229 203d  de.get("type") =
+0001be90: 3d20 2265 6e64 706f 696e 7422 292c 2064  = "endpoint"), d
+0001bea0: 6174 612e 6765 7428 226e 6f64 6573 222c  ata.get("nodes",
+0001beb0: 205b 5d29 5b2d 315d 0a20 2020 2020 2020   [])[-1].       
+0001bec0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001bed0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001bee0: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
+0001bef0: 7761 6974 2074 625f 636c 6965 6e74 2e5f  wait tb_client._
+0001bf00: 7265 7128 0a20 2020 2020 2020 2020 2020  req(.           
+0001bf10: 2020 2020 2020 2020 2066 222f 7630 2f70           f"/v0/p
+0001bf20: 6970 6573 2f7b 705b 276e 616d 6527 5d7d  ipes/{p['name']}
+0001bf30: 2f6e 6f64 6573 2f7b 656e 6470 6f69 6e74  /nodes/{endpoint
+0001bf40: 5f6e 6f64 652e 6765 7428 2769 6427 297d  _node.get('id')}
+0001bf50: 2f65 6e64 706f 696e 743f 7b75 726c 656e  /endpoint?{urlen
+0001bf60: 636f 6465 2863 6c69 5f70 6172 616d 7329  code(cli_params)
+0001bf70: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
+0001bf80: 2020 2020 2020 2020 6d65 7468 6f64 3d22          method="
+0001bf90: 504f 5354 222c 0a20 2020 2020 2020 2020  POST",.         
+0001bfa0: 2020 2020 2020 2020 2020 2068 6561 6465             heade
+0001bfb0: 7273 3d68 6561 6465 7273 2c0a 2020 2020  rs=headers,.    
+0001bfc0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001bfd0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0001bfe0: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
+0001bff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c000: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+0001c010: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001c020: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
+0001c030: 6e61 6765 722e 6572 726f 725f 6372 6561  nager.error_crea
+0001c040: 7469 6e67 5f65 6e64 706f 696e 7428 0a20  ting_endpoint(. 
+0001c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c060: 2020 2020 2020 206e 6f64 653d 656e 6470         node=endp
+0001c070: 6f69 6e74 5f6e 6f64 652e 6765 7428 226e  oint_node.get("n
+0001c080: 616d 6522 292c 2070 6970 653d 705b 226e  ame"), pipe=p["n
+0001c090: 616d 6522 5d2c 2065 7272 6f72 3d73 7472  ame"], error=str
+0001c0a0: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
+0001c0b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001c0c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0001c0d0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+0001c0e0: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
+0001c0f0: 6765 722e 7375 6363 6573 735f 7465 7374  ger.success_test
+0001c100: 5f65 6e64 706f 696e 745f 6e6f 5f74 6f6b  _endpoint_no_tok
+0001c110: 656e 2868 6f73 743d 686f 7374 2c20 7069  en(host=host, pi
+0001c120: 7065 3d70 5b22 6e61 6d65 225d 2929 0a0a  pe=p["name"]))..
+0001c130: 2020 2020 6966 2063 6f70 795f 6e6f 6465      if copy_node
+0001c140: 3a0a 2020 2020 2020 2020 7069 7065 5f69  :.        pipe_i
+0001c150: 6420 3d20 6461 7461 5b22 6964 225d 0a20  d = data["id"]. 
+0001c160: 2020 2020 2020 206e 6f64 6520 3d20 6e65         node = ne
+0001c170: 7874 2828 6e6f 6465 2066 6f72 206e 6f64  xt((node for nod
+0001c180: 6520 696e 2064 6174 615b 226e 6f64 6573  e in data["nodes
+0001c190: 225d 2069 6620 6e6f 6465 5b22 6e6f 6465  "] if node["node
+0001c1a0: 5f74 7970 6522 5d20 3d3d 2022 636f 7079  _type"] == "copy
+0001c1b0: 2229 2c20 4e6f 6e65 290a 2020 2020 2020  "), None).      
+0001c1c0: 2020 6966 206e 6f64 653a 0a20 2020 2020    if node:.     
+0001c1d0: 2020 2020 2020 2063 6f70 795f 7061 7261         copy_para
+0001c1e0: 6d73 203d 207b 2270 6970 655f 6e61 6d65  ms = {"pipe_name
+0001c1f0: 5f6f 725f 6964 223a 2070 6970 655f 6964  _or_id": pipe_id
+0001c200: 2c20 226e 6f64 655f 6964 223a 206e 6f64  , "node_id": nod
+0001c210: 655b 2269 6422 5d7d 0a20 2020 2020 2020  e["id"]}.       
+0001c220: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001c230: 2020 2020 2020 2020 2020 7461 7267 6574            target
+0001c240: 5f64 6174 6173 6f75 7263 6520 3d20 636f  _datasource = co
+0001c250: 7079 5f6e 6f64 652e 6765 7428 436f 7079  py_node.get(Copy
+0001c260: 5061 7261 6d65 7465 7273 2e54 4152 4745  Parameters.TARGE
+0001c270: 545f 4441 5441 534f 5552 4345 2c20 4e6f  T_DATASOURCE, No
+0001c280: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+0001c290: 2020 2020 7363 6865 6475 6c65 5f63 726f      schedule_cro
+0001c2a0: 6e20 3d20 636f 7079 5f6e 6f64 652e 6765  n = copy_node.ge
+0001c2b0: 7428 436f 7079 5061 7261 6d65 7465 7273  t(CopyParameters
+0001c2c0: 2e43 4f50 595f 5343 4845 4455 4c45 2c20  .COPY_SCHEDULE, 
+0001c2d0: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+0001c2e0: 2020 2020 2020 7363 6865 6475 6c65 5f63        schedule_c
+0001c2f0: 726f 6e20 3d20 4e6f 6e65 2069 6620 7363  ron = None if sc
+0001c300: 6865 6475 6c65 5f63 726f 6e20 3d3d 204f  hedule_cron == O
+0001c310: 4e5f 4445 4d41 4e44 2065 6c73 6520 7363  N_DEMAND else sc
+0001c320: 6865 6475 6c65 5f63 726f 6e0a 2020 2020  hedule_cron.    
+0001c330: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+0001c340: 656e 745f 7461 7267 6574 5f64 6174 6173  ent_target_datas
+0001c350: 6f75 7263 655f 6964 203d 2064 6174 615b  ource_id = data[
+0001c360: 2263 6f70 795f 7461 7267 6574 5f64 6174  "copy_target_dat
+0001c370: 6173 6f75 7263 6522 5d0a 2020 2020 2020  asource"].      
+0001c380: 2020 2020 2020 2020 2020 7461 7267 6574            target
+0001c390: 5f64 6174 6173 6f75 7263 655f 7265 7370  _datasource_resp
+0001c3a0: 6f6e 7365 203d 2061 7761 6974 2074 625f  onse = await tb_
+0001c3b0: 636c 6965 6e74 2e67 6574 5f64 6174 6173  client.get_datas
+0001c3c0: 6f75 7263 6528 7461 7267 6574 5f64 6174  ource(target_dat
+0001c3d0: 6173 6f75 7263 6529 0a20 2020 2020 2020  asource).       
+0001c3e0: 2020 2020 2020 2020 2074 6172 6765 745f           target_
+0001c3f0: 6461 7461 736f 7572 6365 5f74 6f5f 7365  datasource_to_se
+0001c400: 6e64 203d 2028 0a20 2020 2020 2020 2020  nd = (.         
+0001c410: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+0001c420: 745f 6461 7461 736f 7572 6365 0a20 2020  t_datasource.   
+0001c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c440: 2069 6620 7461 7267 6574 5f64 6174 6173   if target_datas
+0001c450: 6f75 7263 655f 7265 7370 6f6e 7365 2e67  ource_response.g
+0001c460: 6574 2822 6964 222c 2074 6172 6765 745f  et("id", target_
+0001c470: 6461 7461 736f 7572 6365 2920 213d 2063  datasource) != c
+0001c480: 7572 7265 6e74 5f74 6172 6765 745f 6461  urrent_target_da
+0001c490: 7461 736f 7572 6365 5f69 640a 2020 2020  tasource_id.    
+0001c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4b0: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
+0001c4c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001c4d0: 2020 2020 2020 2020 2020 2020 636f 7079              copy
+0001c4e0: 5f70 6172 616d 735b 436f 7079 5061 7261  _params[CopyPara
+0001c4f0: 6d65 7465 7273 2e54 4152 4745 545f 4441  meters.TARGET_DA
+0001c500: 5441 534f 5552 4345 5d20 3d20 7461 7267  TASOURCE] = targ
+0001c510: 6574 5f64 6174 6173 6f75 7263 655f 746f  et_datasource_to
+0001c520: 5f73 656e 640a 2020 2020 2020 2020 2020  _send.          
+0001c530: 2020 2020 2020 6375 7272 656e 745f 7363        current_sc
+0001c540: 6865 6475 6c65 203d 2064 6174 612e 6765  hedule = data.ge
+0001c550: 7428 2273 6368 6564 756c 6522 2c20 7b7d  t("schedule", {}
+0001c560: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001c570: 2020 6375 7272 656e 745f 7363 6865 6475    current_schedu
+0001c580: 6c65 5f63 726f 6e20 3d20 6375 7272 656e  le_cron = curren
+0001c590: 745f 7363 6865 6475 6c65 2e67 6574 2822  t_schedule.get("
+0001c5a0: 6372 6f6e 222c 204e 6f6e 6529 2069 6620  cron", None) if 
+0001c5b0: 6375 7272 656e 745f 7363 6865 6475 6c65  current_schedule
+0001c5c0: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+0001c5d0: 2020 2020 2020 2020 2020 2073 6368 6564             sched
+0001c5e0: 756c 655f 6372 6f6e 5f73 686f 756c 645f  ule_cron_should_
+0001c5f0: 6265 5f72 656d 6f76 6564 203d 2063 7572  be_removed = cur
+0001c600: 7265 6e74 5f73 6368 6564 756c 655f 6372  rent_schedule_cr
+0001c610: 6f6e 2061 6e64 206e 6f74 2073 6368 6564  on and not sched
+0001c620: 756c 655f 6372 6f6e 0a20 2020 2020 2020  ule_cron.       
+0001c630: 2020 2020 2020 2020 2063 6f70 795f 7061           copy_pa
+0001c640: 7261 6d73 5b22 7363 6865 6475 6c65 5f63  rams["schedule_c
+0001c650: 726f 6e22 5d20 3d20 224e 6f6e 6522 2069  ron"] = "None" i
+0001c660: 6620 7363 6865 6475 6c65 5f63 726f 6e5f  f schedule_cron_
+0001c670: 7368 6f75 6c64 5f62 655f 7265 6d6f 7665  should_be_remove
+0001c680: 6420 656c 7365 2073 6368 6564 756c 655f  d else schedule_
+0001c690: 6372 6f6e 0a20 2020 2020 2020 2020 2020  cron.           
+0001c6a0: 2020 2020 2061 7761 6974 2074 625f 636c       await tb_cl
+0001c6b0: 6965 6e74 2e70 6970 655f 7570 6461 7465  ient.pipe_update
+0001c6c0: 5f63 6f70 7928 2a2a 636f 7079 5f70 6172  _copy(**copy_par
+0001c6d0: 616d 7329 0a20 2020 2020 2020 2020 2020  ams).           
+0001c6e0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0001c6f0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+0001c700: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+0001c710: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
+0001c720: 2020 2020 2020 2020 2020 2020 2046 6565               Fee
+0001c730: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+0001c740: 6f72 5f73 6574 7469 6e67 5f63 6f70 795f  or_setting_copy_
+0001c750: 6e6f 6465 286e 6f64 653d 636f 7079 5f6e  node(node=copy_n
+0001c760: 6f64 652e 6765 7428 226e 616d 6522 292c  ode.get("name"),
+0001c770: 2070 6970 653d 705b 226e 616d 6522 5d2c   pipe=p["name"],
+0001c780: 2065 7272 6f72 3d73 7472 2865 2929 0a20   error=str(e)). 
+0001c790: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0001c7a0: 0a0a 2020 2020 6966 2070 5b22 746f 6b65  ..    if p["toke
+0001c7b0: 6e73 225d 2061 6e64 206e 6f74 2073 6b69  ns"] and not ski
+0001c7c0: 705f 746f 6b65 6e73 2061 6e64 206e 6f74  p_tokens and not
+0001c7d0: 2061 735f 7374 616e 6461 7264 2061 6e64   as_standard and
+0001c7e0: 2064 6174 612e 6765 7428 2274 7970 6522   data.get("type"
+0001c7f0: 2920 696e 205b 2265 6e64 706f 696e 7422  ) in ["endpoint"
+0001c800: 2c20 2263 6f70 7922 5d3a 0a20 2020 2020  , "copy"]:.     
+0001c810: 2020 2023 2073 6561 7263 6820 666f 7220     # search for 
+0001c820: 746f 6b65 6e20 7769 7468 2073 7065 6369  token with speci
+0001c830: 6669 6564 206e 616d 6520 616e 6420 6164  fied name and ad
+0001c840: 6473 2069 7420 6966 206e 6f74 2066 6f75  ds it if not fou
+0001c850: 6e64 206f 7220 6164 6473 2070 6572 6d69  nd or adds permi
+0001c860: 7373 696f 6e73 2074 6f20 6974 0a20 2020  ssions to it.   
+0001c870: 2020 2020 2074 203d 204e 6f6e 650a 2020       t = None.  
+0001c880: 2020 2020 2020 666f 7220 746b 2069 6e20        for tk in 
+0001c890: 705b 2274 6f6b 656e 7322 5d3a 0a20 2020  p["tokens"]:.   
+0001c8a0: 2020 2020 2020 2020 2074 6f6b 656e 5f6e           token_n
+0001c8b0: 616d 6520 3d20 746b 5b22 746f 6b65 6e5f  ame = tk["token_
+0001c8c0: 6e61 6d65 225d 0a20 2020 2020 2020 2020  name"].         
+0001c8d0: 2020 2074 203d 2061 7761 6974 2074 625f     t = await tb_
+0001c8e0: 636c 6965 6e74 2e67 6574 5f74 6f6b 656e  client.get_token
+0001c8f0: 5f62 795f 6e61 6d65 2874 6f6b 656e 5f6e  _by_name(token_n
+0001c900: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0001c910: 2069 6620 743a 0a20 2020 2020 2020 2020   if t:.         
+0001c920: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
+0001c930: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
+0001c940: 722e 696e 666f 5f63 7265 6174 655f 666f  r.info_create_fo
+0001c950: 756e 645f 746f 6b65 6e28 746f 6b65 6e3d  und_token(token=
+0001c960: 746f 6b65 6e5f 6e61 6d65 2929 0a20 2020  token_name)).   
+0001c970: 2020 2020 2020 2020 2020 2020 2073 636f               sco
+0001c980: 7065 7320 3d20 5b66 2250 4950 4553 3a7b  pes = [f"PIPES:{
+0001c990: 746b 5b27 7065 726d 6973 7369 6f6e 7327  tk['permissions'
+0001c9a0: 5d7d 3a7b 705b 276e 616d 6527 5d7d 225d  ]}:{p['name']}"]
+0001c9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c9c0: 2066 6f72 2078 2069 6e20 745b 2273 636f   for x in t["sco
+0001c9d0: 7065 7322 5d3a 0a20 2020 2020 2020 2020  pes"]:.         
+0001c9e0: 2020 2020 2020 2020 2020 2073 6320 3d20             sc = 
+0001c9f0: 785b 2274 7970 6522 5d20 6966 2022 7265  x["type"] if "re
+0001ca00: 736f 7572 6365 2220 6e6f 7420 696e 2078  source" not in x
+0001ca10: 2065 6c73 6520 6622 7b78 5b27 7479 7065   else f"{x['type
+0001ca20: 275d 7d3a 7b78 5b27 7265 736f 7572 6365  ']}:{x['resource
+0001ca30: 275d 7d22 0a20 2020 2020 2020 2020 2020  ']}".           
+0001ca40: 2020 2020 2020 2020 2073 636f 7065 732e           scopes.
+0001ca50: 6170 7065 6e64 2873 6329 0a20 2020 2020  append(sc).     
+0001ca60: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0001ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca80: 2020 2020 7220 3d20 6177 6169 7420 7462      r = await tb
+0001ca90: 5f63 6c69 656e 742e 616c 7465 725f 746f  _client.alter_to
+0001caa0: 6b65 6e73 2874 6f6b 656e 5f6e 616d 652c  kens(token_name,
+0001cab0: 2073 636f 7065 7329 0a20 2020 2020 2020   scopes).       
+0001cac0: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
+0001cad0: 656e 203d 2072 5b22 746f 6b65 6e22 5d20  en = r["token"] 
+0001cae0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+0001caf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb00: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+0001cb10: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+0001cb20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0001cb30: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
+0001cb40: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+0001cb50: 6e61 6765 722e 6572 726f 725f 6372 6561  nager.error_crea
+0001cb60: 7469 6e67 5f70 6970 6528 6572 726f 723d  ting_pipe(error=
+0001cb70: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
+0001cb80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001cb90: 2020 2020 2020 746f 6b65 6e5f 6e61 6d65        token_name
+0001cba0: 203d 2074 6b5b 2274 6f6b 656e 5f6e 616d   = tk["token_nam
+0001cbb0: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
+0001cbc0: 2020 2020 636c 6963 6b2e 6563 686f 2846      click.echo(F
+0001cbd0: 6565 6462 6163 6b4d 616e 6167 6572 2e69  eedbackManager.i
+0001cbe0: 6e66 6f5f 6372 6561 7465 5f6e 6f74 5f66  nfo_create_not_f
+0001cbf0: 6f75 6e64 5f74 6f6b 656e 2874 6f6b 656e  ound_token(token
+0001cc00: 3d74 6f6b 656e 5f6e 616d 6529 290a 2020  =token_name)).  
+0001cc10: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0001cc20: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0001cc30: 2020 2020 2020 2072 203d 2061 7761 6974         r = await
+0001cc40: 2074 625f 636c 6965 6e74 2e63 7265 6174   tb_client.creat
+0001cc50: 655f 746f 6b65 6e28 0a20 2020 2020 2020  e_token(.       
+0001cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc70: 2074 6f6b 656e 5f6e 616d 652c 2066 2250   token_name, f"P
+0001cc80: 4950 4553 3a7b 746b 5b27 7065 726d 6973  IPES:{tk['permis
+0001cc90: 7369 6f6e 7327 5d7d 3a7b 705b 276e 616d  sions']}:{p['nam
+0001cca0: 6527 5d7d 222c 2022 5022 2c20 705b 226e  e']}", "P", p["n
+0001ccb0: 616d 6522 5d0a 2020 2020 2020 2020 2020  ame"].          
+0001ccc0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cce0: 746f 6b65 6e20 3d20 725b 2274 6f6b 656e  token = r["token
+0001ccf0: 225d 2020 2320 7479 7065 3a20 6967 6e6f  "]  # type: igno
+0001cd00: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+0001cd10: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0001cd20: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+0001cd30: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0001cd40: 6973 6520 636c 6963 6b2e 436c 6963 6b45  ise click.ClickE
+0001cd50: 7863 6570 7469 6f6e 2846 6565 6462 6163  xception(Feedbac
+0001cd60: 6b4d 616e 6167 6572 2e65 7272 6f72 5f63  kManager.error_c
+0001cd70: 7265 6174 696e 675f 7069 7065 2865 7272  reating_pipe(err
+0001cd80: 6f72 3d65 2929 0a0a 2020 2020 2020 2020  or=e))..        
+0001cd90: 6966 2064 6174 612e 6765 7428 2274 7970  if data.get("typ
+0001cda0: 6522 2920 3d3d 2022 656e 6470 6f69 6e74  e") == "endpoint
+0001cdb0: 223a 0a20 2020 2020 2020 2020 2020 2063  ":.            c
+0001cdc0: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
+0001cdd0: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
+0001cde0: 735f 7465 7374 5f65 6e64 706f 696e 7428  s_test_endpoint(
+0001cdf0: 686f 7374 3d68 6f73 742c 2070 6970 653d  host=host, pipe=
+0001ce00: 705b 226e 616d 6522 5d2c 2074 6f6b 656e  p["name"], token
+0001ce10: 3d74 6f6b 656e 2929 0a0a 0a61 7379 6e63  =token))...async
+0001ce20: 2064 6566 2073 6861 7265 5f61 6e64 5f75   def share_and_u
+0001ce30: 6e73 6861 7265 5f64 6174 6173 6f75 7263  nshare_datasourc
+0001ce40: 6528 0a20 2020 2063 6c69 656e 743a 2054  e(.    client: T
+0001ce50: 696e 7942 2c0a 2020 2020 6461 7461 736f  inyB,.    dataso
+0001ce60: 7572 6365 3a20 4469 6374 5b73 7472 2c20  urce: Dict[str, 
+0001ce70: 416e 795d 2c0a 2020 2020 7573 6572 5f74  Any],.    user_t
+0001ce80: 6f6b 656e 3a20 7374 722c 0a20 2020 2077  oken: str,.    w
+0001ce90: 6f72 6b73 7061 6365 735f 6375 7272 656e  orkspaces_curren
+0001cea0: 745f 7368 6172 6564 5f77 6974 683a 204c  t_shared_with: L
+0001ceb0: 6973 745b 7374 725d 2c0a 2020 2020 776f  ist[str],.    wo
+0001cec0: 726b 7370 6163 6573 5f74 6f5f 7368 6172  rkspaces_to_shar
+0001ced0: 653a 204c 6973 745b 7374 725d 2c0a 2020  e: List[str],.  
+0001cee0: 2020 6375 7272 656e 745f 7773 3a20 4f70    current_ws: Op
+0001cef0: 7469 6f6e 616c 5b44 6963 745b 7374 722c  tional[Dict[str,
+0001cf00: 2041 6e79 5d5d 2c0a 2920 2d3e 204e 6f6e   Any]],.) -> Non
+0001cf10: 653a 0a20 2020 2064 6174 6173 6f75 7263  e:.    datasourc
+0001cf20: 655f 6e61 6d65 203d 2064 6174 6173 6f75  e_name = datasou
+0001cf30: 7263 652e 6765 7428 226e 616d 6522 2c20  rce.get("name", 
+0001cf40: 2222 290a 2020 2020 6461 7461 736f 7572  "").    datasour
+0001cf50: 6365 5f69 6420 3d20 6461 7461 736f 7572  ce_id = datasour
+0001cf60: 6365 2e67 6574 2822 6964 222c 2022 2229  ce.get("id", "")
+0001cf70: 0a20 2020 2077 6f72 6b73 7061 6365 733a  .    workspaces:
+0001cf80: 204c 6973 745b 4469 6374 5b73 7472 2c20   List[Dict[str, 
+0001cf90: 416e 795d 5d0a 0a20 2020 2023 2049 6e20  Any]]..    # In 
+0001cfa0: 6361 7365 2077 6520 6172 6520 7075 7368  case we are push
+0001cfb0: 696e 6720 746f 2061 2062 7261 6e63 682c  ing to a branch,
+0001cfc0: 2077 6520 646f 6e27 7420 7368 6172 6520   we don't share 
+0001cfd0: 7468 6520 6461 7461 736f 7572 6365 0a20  the datasource. 
+0001cfe0: 2020 2023 2046 4958 4d45 3a20 4861 7665     # FIXME: Have
+0001cff0: 206f 6e6c 7920 6f6e 6365 2077 6179 2074   only once way t
+0001d000: 6f20 6765 7420 7468 6520 6375 7272 656e  o get the curren
+0001d010: 7420 776f 726b 7370 6163 650a 2020 2020  t workspace.    
+0001d020: 6966 2063 7572 7265 6e74 5f77 733a 0a20  if current_ws:. 
+0001d030: 2020 2020 2020 2023 2046 6f72 6365 2074         # Force t
+0001d040: 6f20 6765 7420 616c 6c20 7468 6520 776f  o get all the wo
+0001d050: 726b 7370 6163 6573 2074 6865 2075 7365  rkspaces the use
+0001d060: 7220 6361 6e20 6163 6365 7373 0a20 2020  r can access.   
+0001d070: 2020 2020 2077 6f72 6b73 7061 6365 203d       workspace =
+0001d080: 2063 7572 7265 6e74 5f77 730a 2020 2020   current_ws.    
+0001d090: 2020 2020 776f 726b 7370 6163 6573 203d      workspaces =
+0001d0a0: 2028 6177 6169 7420 636c 6965 6e74 2e75   (await client.u
+0001d0b0: 7365 725f 776f 726b 7370 6163 6573 2829  ser_workspaces()
+0001d0c0: 292e 6765 7428 2277 6f72 6b73 7061 6365  ).get("workspace
+0001d0d0: 7322 2c20 5b5d 290a 2020 2020 656c 7365  s", []).    else
+0001d0e0: 3a0a 2020 2020 2020 2020 776f 726b 7370  :.        worksp
+0001d0f0: 6163 6520 3d20 6177 6169 7420 636c 6965  ace = await clie
+0001d100: 6e74 2e75 7365 725f 776f 726b 7370 6163  nt.user_workspac
+0001d110: 655f 6272 616e 6368 6573 2829 0a20 2020  e_branches().   
+0001d120: 2020 2020 2077 6f72 6b73 7061 6365 7320       workspaces 
+0001d130: 3d20 776f 726b 7370 6163 652e 6765 7428  = workspace.get(
+0001d140: 2277 6f72 6b73 7061 6365 7322 2c20 5b5d  "workspaces", []
+0001d150: 290a 0a20 2020 2069 6620 776f 726b 7370  )..    if worksp
+0001d160: 6163 652e 6765 7428 2269 735f 6272 616e  ace.get("is_bran
+0001d170: 6368 222c 2046 616c 7365 293a 0a20 2020  ch", False):.   
+0001d180: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001d190: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0001d1a0: 696e 666f 5f73 6b69 7070 696e 675f 7368  info_skipping_sh
+0001d1b0: 6172 696e 675f 6461 7461 736f 7572 6365  aring_datasource
+0001d1c0: 735f 6272 616e 6368 2864 6174 6173 6f75  s_branch(datasou
+0001d1d0: 7263 653d 6461 7461 736f 7572 6365 5b22  rce=datasource["
+0001d1e0: 6e61 6d65 225d 2929 0a20 2020 2020 2020  name"])).       
+0001d1f0: 2072 6574 7572 6e0a 0a20 2020 2023 2057   return..    # W
+0001d200: 6520 6475 706c 6963 6174 6520 7468 6520  e duplicate the 
+0001d210: 636c 6965 6e74 2074 6f20 7573 6520 7468  client to use th
+0001d220: 6520 7573 6572 5f74 6f6b 656e 0a20 2020  e user_token.   
+0001d230: 2075 7365 725f 636c 6965 6e74 3a20 5469   user_client: Ti
+0001d240: 6e79 4220 3d20 6465 6570 636f 7079 2863  nyB = deepcopy(c
+0001d250: 6c69 656e 7429 0a20 2020 2075 7365 725f  lient).    user_
+0001d260: 636c 6965 6e74 2e74 6f6b 656e 203d 2075  client.token = u
+0001d270: 7365 725f 746f 6b65 6e0a 2020 2020 6966  ser_token.    if
+0001d280: 206e 6f74 2077 6f72 6b73 7061 6365 735f   not workspaces_
+0001d290: 6375 7272 656e 745f 7368 6172 6564 5f77  current_shared_w
+0001d2a0: 6974 683a 0a20 2020 2020 2020 2066 6f72  ith:.        for
+0001d2b0: 2077 6f72 6b73 7061 6365 5f74 6f5f 7368   workspace_to_sh
+0001d2c0: 6172 6520 696e 2077 6f72 6b73 7061 6365  are in workspace
+0001d2d0: 735f 746f 5f73 6861 7265 3a0a 2020 2020  s_to_share:.    
+0001d2e0: 2020 2020 2020 2020 773a 204f 7074 696f          w: Optio
+0001d2f0: 6e61 6c5b 4469 6374 5b73 7472 2c20 416e  nal[Dict[str, An
+0001d300: 795d 5d20 3d20 6e65 7874 2828 7720 666f  y]] = next((w fo
+0001d310: 7220 7720 696e 2077 6f72 6b73 7061 6365  r w in workspace
+0001d320: 7320 6966 2077 5b22 6e61 6d65 225d 203d  s if w["name"] =
+0001d330: 3d20 776f 726b 7370 6163 655f 746f 5f73  = workspace_to_s
+0001d340: 6861 7265 292c 204e 6f6e 6529 0a20 2020  hare), None).   
+0001d350: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001d360: 773a 0a20 2020 2020 2020 2020 2020 2020  w:.             
+0001d370: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+0001d380: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+0001d390: 2020 2020 2020 2020 6622 556e 6162 6c65          f"Unable
+0001d3a0: 2074 6f20 7368 6172 6520 6461 7461 736f   to share dataso
+0001d3b0: 7572 6365 2077 6974 6820 7468 6520 776f  urce with the wo
+0001d3c0: 726b 7370 6163 6520 7b77 6f72 6b73 7061  rkspace {workspa
+0001d3d0: 6365 5f74 6f5f 7368 6172 657d 2e20 5265  ce_to_share}. Re
+0001d3e0: 7669 6577 2074 6861 7420 796f 7520 6861  view that you ha
+0001d3f0: 7665 2074 6865 2061 646d 696e 2070 6572  ve the admin per
+0001d400: 6d69 7373 696f 6e73 206f 6e20 7468 6973  missions on this
+0001d410: 2077 6f72 6b73 7061 6365 220a 2020 2020   workspace".    
+0001d420: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0001d430: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0001d440: 2075 7365 725f 636c 6965 6e74 2e64 6174   user_client.dat
+0001d450: 6173 6f75 7263 655f 7368 6172 6528 0a20  asource_share(. 
+0001d460: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001d470: 6174 6173 6f75 7263 655f 6964 3d64 6174  atasource_id=dat
+0001d480: 6173 6f75 7263 655f 6964 2c0a 2020 2020  asource_id,.    
+0001d490: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+0001d4a0: 656e 745f 776f 726b 7370 6163 655f 6964  ent_workspace_id
+0001d4b0: 3d77 6f72 6b73 7061 6365 2e67 6574 2822  =workspace.get("
+0001d4c0: 6964 222c 2022 2229 2c0a 2020 2020 2020  id", ""),.      
+0001d4d0: 2020 2020 2020 2020 2020 6465 7374 696e            destin
+0001d4e0: 6174 696f 6e5f 776f 726b 7370 6163 655f  ation_workspace_
+0001d4f0: 6964 3d77 2e67 6574 2822 6964 222c 2022  id=w.get("id", "
+0001d500: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0001d510: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
+0001d520: 6963 6b2e 6563 686f 280a 2020 2020 2020  ick.echo(.      
+0001d530: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+0001d540: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
+0001d550: 735f 6461 7461 736f 7572 6365 5f73 6861  s_datasource_sha
+0001d560: 7265 6428 6461 7461 736f 7572 6365 3d64  red(datasource=d
+0001d570: 6174 6173 6f75 7263 655f 6e61 6d65 2c20  atasource_name, 
+0001d580: 776f 726b 7370 6163 653d 772e 6765 7428  workspace=w.get(
+0001d590: 226e 616d 6522 2c20 2222 2929 0a20 2020  "name", "")).   
+0001d5a0: 2020 2020 2020 2020 2029 0a20 2020 2065           ).    e
+0001d5b0: 6c73 653a 0a20 2020 2020 2020 2073 6861  lse:.        sha
+0001d5c0: 7265 645f 7769 7468 203d 205b 0a20 2020  red_with = [.   
+0001d5d0: 2020 2020 2020 2020 2077 0a20 2020 2020           w.     
+0001d5e0: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
+0001d5f0: 776f 726b 7370 6163 6573 0a20 2020 2020  workspaces.     
+0001d600: 2020 2020 2020 2069 6620 6e65 7874 2828         if next((
+0001d610: 7773 2066 6f72 2077 7320 696e 2077 6f72  ws for ws in wor
+0001d620: 6b73 7061 6365 735f 6375 7272 656e 745f  kspaces_current_
+0001d630: 7368 6172 6564 5f77 6974 6820 6966 2077  shared_with if w
+0001d640: 7320 3d3d 2077 5b22 6964 225d 206f 7220  s == w["id"] or 
+0001d650: 7773 203d 3d20 775b 226e 616d 6522 5d29  ws == w["name"])
+0001d660: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+0001d670: 5d0a 2020 2020 2020 2020 6465 6669 6e65  ].        define
+0001d680: 645f 746f 5f73 6861 7265 5f77 6974 6820  d_to_share_with 
+0001d690: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0001d6a0: 7720 666f 7220 7720 696e 2077 6f72 6b73  w for w in works
+0001d6b0: 7061 6365 7320 6966 206e 6578 7428 2877  paces if next((w
+0001d6c0: 7320 666f 7220 7773 2069 6e20 776f 726b  s for ws in work
+0001d6d0: 7370 6163 6573 5f74 6f5f 7368 6172 6520  spaces_to_share 
+0001d6e0: 6966 2077 7320 3d3d 2077 5b22 6964 225d  if ws == w["id"]
+0001d6f0: 206f 7220 7773 203d 3d20 775b 226e 616d   or ws == w["nam
+0001d700: 6522 5d29 2c20 4e6f 6e65 290a 2020 2020  e"]), None).    
+0001d710: 2020 2020 5d0a 2020 2020 2020 2020 776f      ].        wo
+0001d720: 726b 7370 6163 6573 5f6e 6565 645f 746f  rkspaces_need_to
+0001d730: 5f73 6861 7265 203d 205b 7720 666f 7220  _share = [w for 
+0001d740: 7720 696e 2064 6566 696e 6564 5f74 6f5f  w in defined_to_
+0001d750: 7368 6172 655f 7769 7468 2069 6620 7720  share_with if w 
+0001d760: 6e6f 7420 696e 2073 6861 7265 645f 7769  not in shared_wi
+0001d770: 7468 5d0a 2020 2020 2020 2020 776f 726b  th].        work
+0001d780: 7370 6163 6573 5f6e 6565 645f 746f 5f75  spaces_need_to_u
+0001d790: 6e73 6861 7265 203d 205b 7720 666f 7220  nshare = [w for 
+0001d7a0: 7720 696e 2073 6861 7265 645f 7769 7468  w in shared_with
+0001d7b0: 2069 6620 7720 6e6f 7420 696e 2064 6566   if w not in def
+0001d7c0: 696e 6564 5f74 6f5f 7368 6172 655f 7769  ined_to_share_wi
+0001d7d0: 7468 5d0a 0a20 2020 2020 2020 2066 6f72  th]..        for
+0001d7e0: 2077 2069 6e20 776f 726b 7370 6163 6573   w in workspaces
+0001d7f0: 5f6e 6565 645f 746f 5f73 6861 7265 3a0a  _need_to_share:.
+0001d800: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0001d810: 7420 7573 6572 5f63 6c69 656e 742e 6461  t user_client.da
+0001d820: 7461 736f 7572 6365 5f73 6861 7265 280a  tasource_share(.
+0001d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d840: 6461 7461 736f 7572 6365 5f69 643d 6461  datasource_id=da
+0001d850: 7461 736f 7572 6365 5f69 642c 0a20 2020  tasource_id,.   
+0001d860: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+0001d870: 7265 6e74 5f77 6f72 6b73 7061 6365 5f69  rent_workspace_i
+0001d880: 643d 776f 726b 7370 6163 652e 6765 7428  d=workspace.get(
+0001d890: 2269 6422 2c20 2222 292c 0a20 2020 2020  "id", ""),.     
+0001d8a0: 2020 2020 2020 2020 2020 2064 6573 7469             desti
+0001d8b0: 6e61 7469 6f6e 5f77 6f72 6b73 7061 6365  nation_workspace
+0001d8c0: 5f69 643d 772e 6765 7428 2269 6422 2c20  _id=w.get("id", 
+0001d8d0: 2222 292c 0a20 2020 2020 2020 2020 2020  ""),.           
+0001d8e0: 2029 0a20 2020 2020 2020 2020 2020 2063   ).            c
+0001d8f0: 6c69 636b 2e65 6368 6f28 0a20 2020 2020  lick.echo(.     
+0001d900: 2020 2020 2020 2020 2020 2046 6565 6462             Feedb
+0001d910: 6163 6b4d 616e 6167 6572 2e73 7563 6365  ackManager.succe
+0001d920: 7373 5f64 6174 6173 6f75 7263 655f 7368  ss_datasource_sh
+0001d930: 6172 6564 2864 6174 6173 6f75 7263 653d  ared(datasource=
+0001d940: 6461 7461 736f 7572 6365 5b22 6e61 6d65  datasource["name
+0001d950: 225d 2c20 776f 726b 7370 6163 653d 772e  "], workspace=w.
+0001d960: 6765 7428 226e 616d 6522 2c20 2222 2929  get("name", ""))
+0001d970: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0001d980: 2020 2020 2020 2020 666f 7220 7720 696e          for w in
+0001d990: 2077 6f72 6b73 7061 6365 735f 6e65 6564   workspaces_need
+0001d9a0: 5f74 6f5f 756e 7368 6172 653a 0a20 2020  _to_unshare:.   
+0001d9b0: 2020 2020 2020 2020 2061 7761 6974 2075           await u
+0001d9c0: 7365 725f 636c 6965 6e74 2e64 6174 6173  ser_client.datas
+0001d9d0: 6f75 7263 655f 756e 7368 6172 6528 0a20  ource_unshare(. 
+0001d9e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001d9f0: 6174 6173 6f75 7263 655f 6964 3d64 6174  atasource_id=dat
+0001da00: 6173 6f75 7263 655f 6964 2c0a 2020 2020  asource_id,.    
+0001da10: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+0001da20: 656e 745f 776f 726b 7370 6163 655f 6964  ent_workspace_id
+0001da30: 3d77 6f72 6b73 7061 6365 2e67 6574 2822  =workspace.get("
+0001da40: 6964 222c 2022 2229 2c0a 2020 2020 2020  id", ""),.      
+0001da50: 2020 2020 2020 2020 2020 6465 7374 696e            destin
+0001da60: 6174 696f 6e5f 776f 726b 7370 6163 655f  ation_workspace_
+0001da70: 6964 3d77 2e67 6574 2822 6964 222c 2022  id=w.get("id", "
+0001da80: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0001da90: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
+0001daa0: 6963 6b2e 6563 686f 280a 2020 2020 2020  ick.echo(.      
+0001dab0: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+0001dac0: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
+0001dad0: 735f 6461 7461 736f 7572 6365 5f75 6e73  s_datasource_uns
+0001dae0: 6861 7265 6428 6461 7461 736f 7572 6365  hared(datasource
+0001daf0: 3d64 6174 6173 6f75 7263 655f 6e61 6d65  =datasource_name
+0001db00: 2c20 776f 726b 7370 6163 653d 772e 6765  , workspace=w.ge
+0001db10: 7428 226e 616d 6522 2c20 2222 2929 0a20  t("name", "")). 
+0001db20: 2020 2020 2020 2020 2020 2029 0a0a 0a61             )...a
+0001db30: 7379 6e63 2064 6566 206e 6577 5f64 7328  sync def new_ds(
+0001db40: 0a20 2020 2064 733a 2044 6963 745b 7374  .    ds: Dict[st
+0001db50: 722c 2041 6e79 5d2c 0a20 2020 2063 6c69  r, Any],.    cli
+0001db60: 656e 743a 2054 696e 7942 2c0a 2020 2020  ent: TinyB,.    
+0001db70: 7573 6572 5f74 6f6b 656e 3a20 4f70 7469  user_token: Opti
+0001db80: 6f6e 616c 5b73 7472 5d2c 0a20 2020 2066  onal[str],.    f
+0001db90: 6f72 6365 3a20 626f 6f6c 203d 2046 616c  orce: bool = Fal
+0001dba0: 7365 2c0a 2020 2020 736b 6970 5f63 6f6e  se,.    skip_con
+0001dbb0: 6669 726d 6174 696f 6e3a 2062 6f6f 6c20  firmation: bool 
+0001dbc0: 3d20 4661 6c73 652c 0a20 2020 2063 7572  = False,.    cur
+0001dbd0: 7265 6e74 5f77 733d 4e6f 6e65 2c0a 2020  rent_ws=None,.  
+0001dbe0: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
+0001dbf0: 6d3a 204f 7074 696f 6e61 6c5b 626f 6f6c  m: Optional[bool
+0001dc00: 5d20 3d20 4661 6c73 652c 0a20 2020 2066  ] = False,.    f
+0001dc10: 6f72 6b3a 204f 7074 696f 6e61 6c5b 626f  ork: Optional[bo
+0001dc20: 6f6c 5d20 3d20 4661 6c73 652c 0a20 2020  ol] = False,.   
+0001dc30: 2067 6974 5f72 656c 6561 7365 3a20 4f70   git_release: Op
+0001dc40: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2046  tional[bool] = F
+0001dc50: 616c 7365 2c0a 293a 0a20 2020 2064 735f  alse,.):.    ds_
+0001dc60: 6e61 6d65 203d 2064 735b 2270 6172 616d  name = ds["param
+0001dc70: 7322 5d5b 226e 616d 6522 5d0a 0a20 2020  s"]["name"]..   
+0001dc80: 2061 7379 6e63 2064 6566 206d 616e 6167   async def manag
+0001dc90: 655f 746f 6b65 6e73 2829 3a0a 2020 2020  e_tokens():.    
+0001dca0: 2020 2020 2320 7365 6172 6368 2066 6f72      # search for
+0001dcb0: 2074 6f6b 656e 2077 6974 6820 7370 6563   token with spec
+0001dcc0: 6966 6965 6420 6e61 6d65 2061 6e64 2061  ified name and a
+0001dcd0: 6464 7320 6974 2069 6620 6e6f 7420 666f  dds it if not fo
+0001dce0: 756e 6420 6f72 2061 6464 7320 7065 726d  und or adds perm
+0001dcf0: 6973 7369 6f6e 7320 746f 2069 740a 2020  issions to it.  
+0001dd00: 2020 2020 2020 7420 3d20 4e6f 6e65 0a20        t = None. 
+0001dd10: 2020 2020 2020 2066 6f72 2074 6b20 696e         for tk in
+0001dd20: 2064 735b 2274 6f6b 656e 7322 5d3a 0a20   ds["tokens"]:. 
+0001dd30: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
+0001dd40: 5f6e 616d 6520 3d20 746b 5b22 746f 6b65  _name = tk["toke
+0001dd50: 6e5f 6e61 6d65 225d 0a20 2020 2020 2020  n_name"].       
+0001dd60: 2020 2020 2074 203d 2061 7761 6974 2063       t = await c
+0001dd70: 6c69 656e 742e 6765 745f 746f 6b65 6e5f  lient.get_token_
+0001dd80: 6279 5f6e 616d 6528 746f 6b65 6e5f 6e61  by_name(token_na
+0001dd90: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0001dda0: 6966 2074 3a0a 2020 2020 2020 2020 2020  if t:.          
+0001ddb0: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
+0001ddc0: 2020 2020 6966 206e 6f74 2074 3a0a 2020      if not t:.  
+0001ddd0: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+0001dde0: 6e61 6d65 203d 2074 6b5b 2274 6f6b 656e  name = tk["token
+0001ddf0: 5f6e 616d 6522 5d0a 2020 2020 2020 2020  _name"].        
+0001de00: 2020 2020 636c 6963 6b2e 6563 686f 2846      click.echo(F
+0001de10: 6565 6462 6163 6b4d 616e 6167 6572 2e69  eedbackManager.i
+0001de20: 6e66 6f5f 6372 6561 7465 5f6e 6f74 5f66  nfo_create_not_f
+0001de30: 6f75 6e64 5f74 6f6b 656e 2874 6f6b 656e  ound_token(token
+0001de40: 3d74 6f6b 656e 5f6e 616d 6529 290a 2020  =token_name)).  
+0001de50: 2020 2020 2020 2020 2020 2320 4453 203d            # DS =
+0001de60: 3d20 746f 6b65 6e5f 6f72 6967 696e 2e4f  = token_origin.O
+0001de70: 7269 6769 6e73 2e44 4154 4153 4f55 5243  rigins.DATASOURC
+0001de80: 450a 2020 2020 2020 2020 2020 2020 6177  E.            aw
+0001de90: 6169 7420 636c 6965 6e74 2e63 7265 6174  ait client.creat
+0001dea0: 655f 746f 6b65 6e28 746f 6b65 6e5f 6e61  e_token(token_na
+0001deb0: 6d65 2c20 6622 4441 5441 534f 5552 4345  me, f"DATASOURCE
+0001dec0: 533a 7b74 6b5b 2770 6572 6d69 7373 696f  S:{tk['permissio
+0001ded0: 6e73 275d 7d3a 7b64 735f 6e61 6d65 7d22  ns']}:{ds_name}"
+0001dee0: 2c20 2244 5322 2c20 6473 5f6e 616d 6529  , "DS", ds_name)
+0001def0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001df00: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+0001df10: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
+0001df20: 6e61 6765 722e 696e 666f 5f63 7265 6174  nager.info_creat
+0001df30: 655f 666f 756e 645f 746f 6b65 6e28 746f  e_found_token(to
+0001df40: 6b65 6e3d 746f 6b65 6e5f 6e61 6d65 2929  ken=token_name))
+0001df50: 0a20 2020 2020 2020 2020 2020 2073 636f  .            sco
+0001df60: 7065 7320 3d20 5b66 2244 4154 4153 4f55  pes = [f"DATASOU
+0001df70: 5243 4553 3a7b 746b 5b27 7065 726d 6973  RCES:{tk['permis
+0001df80: 7369 6f6e 7327 5d7d 3a7b 6473 5f6e 616d  sions']}:{ds_nam
+0001df90: 657d 225d 0a20 2020 2020 2020 2020 2020  e}"].           
+0001dfa0: 2066 6f72 2078 2069 6e20 745b 2273 636f   for x in t["sco
+0001dfb0: 7065 7322 5d3a 0a20 2020 2020 2020 2020  pes"]:.         
+0001dfc0: 2020 2020 2020 2073 6320 3d20 785b 2274         sc = x["t
+0001dfd0: 7970 6522 5d20 6966 2022 7265 736f 7572  ype"] if "resour
+0001dfe0: 6365 2220 6e6f 7420 696e 2078 2065 6c73  ce" not in x els
+0001dff0: 6520 6622 7b78 5b27 7479 7065 275d 7d3a  e f"{x['type']}:
+0001e000: 7b78 5b27 7265 736f 7572 6365 275d 7d22  {x['resource']}"
+0001e010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e020: 2073 636f 7065 732e 6170 7065 6e64 2873   scopes.append(s
+0001e030: 6329 0a20 2020 2020 2020 2020 2020 2061  c).            a
+0001e040: 7761 6974 2063 6c69 656e 742e 616c 7465  wait client.alte
+0001e050: 725f 746f 6b65 6e73 2874 6f6b 656e 5f6e  r_tokens(token_n
+0001e060: 616d 652c 2073 636f 7065 7329 0a0a 2020  ame, scopes)..  
+0001e070: 2020 7472 793a 0a20 2020 2020 2020 2065    try:.        e
+0001e080: 7869 7374 696e 675f 6473 203d 2061 7761  xisting_ds = awa
+0001e090: 6974 2063 6c69 656e 742e 6765 745f 6461  it client.get_da
+0001e0a0: 7461 736f 7572 6365 2864 735f 6e61 6d65  tasource(ds_name
+0001e0b0: 290a 2020 2020 2020 2020 6461 7461 736f  ).        dataso
+0001e0c0: 7572 6365 5f65 7869 7374 7320 3d20 5472  urce_exists = Tr
+0001e0d0: 7565 0a20 2020 2065 7863 6570 7420 446f  ue.    except Do
+0001e0e0: 6573 4e6f 7445 7869 7374 4578 6365 7074  esNotExistExcept
+0001e0f0: 696f 6e3a 0a20 2020 2020 2020 2064 6174  ion:.        dat
+0001e100: 6173 6f75 7263 655f 6578 6973 7473 203d  asource_exists =
+0001e110: 2046 616c 7365 0a0a 2020 2020 6966 206e   False..    if n
+0001e120: 6f74 2064 6174 6173 6f75 7263 655f 6578  ot datasource_ex
+0001e130: 6973 7473 206f 7220 666f 726b 5f64 6f77  ists or fork_dow
+0001e140: 6e73 7472 6561 6d20 6f72 2066 6f72 6b3a  nstream or fork:
+0001e150: 0a20 2020 2020 2020 2070 6172 616d 7320  .        params 
+0001e160: 3d20 6473 5b22 7061 7261 6d73 225d 0a20  = ds["params"]. 
+0001e170: 2020 2020 2020 2070 6172 616d 735b 2262         params["b
+0001e180: 7261 6e63 685f 6d6f 6465 225d 203d 2022  ranch_mode"] = "
+0001e190: 666f 726b 2220 6966 2066 6f72 6b5f 646f  fork" if fork_do
+0001e1a0: 776e 7374 7265 616d 206f 7220 666f 726b  wnstream or fork
+0001e1b0: 2065 6c73 6520 224e 6f6e 6522 0a0a 2020   else "None"..  
+0001e1c0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001e1d0: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
+0001e1e0: 2020 2020 2020 2020 2020 2020 7061 7261              para
+0001e1f0: 6d73 2e67 6574 2822 7365 7276 6963 6522  ms.get("service"
+0001e200: 2920 696e 2050 5245 5649 4557 5f43 4f4e  ) in PREVIEW_CON
+0001e210: 4e45 4354 4f52 5f53 4552 5649 4345 530a  NECTOR_SERVICES.
 0001e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e230: 2020 2020 6669 6c65 5f6e 616d 6520 3d20      file_name = 
-0001e240: 6669 6c65 735b 305d 2e67 6574 2822 6e61  files[0].get("na
-0001e250: 6d65 222c 2022 2229 0a20 2020 2020 2020  me", "").       
-0001e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e270: 2065 7874 656e 7369 6f6e 203d 2066 696c   extension = fil
-0001e280: 655f 6e61 6d65 2e73 706c 6974 2822 2e22  e_name.split("."
-0001e290: 295b 2d31 5d0a 2020 2020 2020 2020 2020  )[-1].          
-0001e2a0: 2020 2020 2020 2020 2020 2020 2020 7661                va
-0001e2b0: 6c69 645f 666f 726d 6174 7320 3d20 5b22  lid_formats = ["
-0001e2c0: 6373 7622 2c20 226e 646a 736f 6e22 2c20  csv", "ndjson", 
-0001e2d0: 2270 6172 7175 6574 225d 0a20 2020 2020  "parquet"].     
-0001e2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e2f0: 2020 2069 6620 6578 7465 6e73 696f 6e20     if extension 
-0001e300: 6e6f 7420 696e 2076 616c 6964 5f66 6f72  not in valid_for
-0001e310: 6d61 7473 3a0a 2020 2020 2020 2020 2020  mats:.          
-0001e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e330: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-0001e340: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-0001e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e360: 2020 2046 6565 6462 6163 6b4d 616e 6167     FeedbackManag
-0001e370: 6572 2e65 7272 6f72 5f66 6f72 6d61 7428  er.error_format(
-0001e380: 6578 7465 6e73 696f 6e3d 6578 7465 6e73  extension=extens
-0001e390: 696f 6e2c 2076 616c 6964 5f66 6f72 6d61  ion, valid_forma
-0001e3a0: 7473 3d76 616c 6964 5f66 6f72 6d61 7473  ts=valid_formats
-0001e3b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e3c0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0001e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3e0: 2020 2020 2020 2020 7061 7261 6d73 5b22          params["
-0001e3f0: 666f 726d 6174 225d 203d 2065 7874 656e  format"] = exten
-0001e400: 7369 6f6e 0a0a 2020 2020 2020 2020 2020  sion..          
-0001e410: 2020 6461 7461 736f 7572 6365 203d 2028    datasource = (
-0001e420: 6177 6169 7420 636c 6965 6e74 2e64 6174  await client.dat
-0001e430: 6173 6f75 7263 655f 6372 6561 7465 5f66  asource_create_f
-0001e440: 726f 6d5f 6465 6669 6e69 7469 6f6e 2870  rom_definition(p
-0001e450: 6172 616d 7329 292e 6765 7428 2264 6174  arams)).get("dat
-0001e460: 6173 6f75 7263 6522 2c20 7b7d 290a 2020  asource", {}).  
-0001e470: 2020 2020 2020 2020 2020 6966 2022 746f            if "to
-0001e480: 6b65 6e73 2220 696e 2064 7320 616e 6420  kens" in ds and 
-0001e490: 6473 5b22 746f 6b65 6e73 225d 3a0a 2020  ds["tokens"]:.  
-0001e4a0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-0001e4b0: 6169 7420 6d61 6e61 6765 5f74 6f6b 656e  ait manage_token
-0001e4c0: 7328 290a 0a20 2020 2020 2020 2020 2020  s()..           
-0001e4d0: 2069 6620 2273 6861 7265 645f 7769 7468   if "shared_with
-0001e4e0: 2220 696e 2064 7320 616e 6420 6473 5b22  " in ds and ds["
-0001e4f0: 7368 6172 6564 5f77 6974 6822 5d3a 0a20  shared_with"]:. 
-0001e500: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001e510: 6620 6e6f 7420 7573 6572 5f74 6f6b 656e  f not user_token
-0001e520: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e530: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-0001e540: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-0001e550: 2e69 6e66 6f5f 736b 6970 7069 6e67 5f73  .info_skipping_s
-0001e560: 6861 7265 645f 7769 7468 5f65 6e74 7279  hared_with_entry
-0001e570: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-0001e580: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001e590: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-0001e5a0: 6169 7420 7368 6172 655f 616e 645f 756e  ait share_and_un
-0001e5b0: 7368 6172 655f 6461 7461 736f 7572 6365  share_datasource
-0001e5c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001e5d0: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-0001e5e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001e5f0: 2020 2020 2020 2020 2020 6461 7461 736f            dataso
-0001e600: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
-0001e610: 2020 2020 2020 2020 2020 2020 2020 7573                us
-0001e620: 6572 5f74 6f6b 656e 2c0a 2020 2020 2020  er_token,.      
-0001e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e640: 2020 776f 726b 7370 6163 6573 5f63 7572    workspaces_cur
-0001e650: 7265 6e74 5f73 6861 7265 645f 7769 7468  rent_shared_with
-0001e660: 3d5b 5d2c 0a20 2020 2020 2020 2020 2020  =[],.           
-0001e670: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
-0001e680: 6b73 7061 6365 735f 746f 5f73 6861 7265  kspaces_to_share
-0001e690: 3d64 735b 2273 6861 7265 645f 7769 7468  =ds["shared_with
-0001e6a0: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-0001e6b0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-0001e6c0: 656e 745f 7773 3d63 7572 7265 6e74 5f77  ent_ws=current_w
-0001e6d0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0001e6e0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0001e6f0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0001e700: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-0001e710: 2020 2020 2072 6169 7365 2063 6c69 636b       raise click
-0001e720: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
-0001e730: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-0001e740: 6572 726f 725f 6372 6561 7469 6e67 5f64  error_creating_d
-0001e750: 6174 6173 6f75 7263 6528 6572 726f 723d  atasource(error=
-0001e760: 7374 7228 6529 2929 0a20 2020 2020 2020  str(e))).       
-0001e770: 2072 6574 7572 6e0a 0a20 2020 2069 6620   return..    if 
-0001e780: 6e6f 7420 666f 7263 653a 0a20 2020 2020  not force:.     
-0001e790: 2020 2072 6169 7365 2063 6c69 636b 2e43     raise click.C
-0001e7a0: 6c69 636b 4578 6365 7074 696f 6e28 4665  lickException(Fe
-0001e7b0: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
-0001e7c0: 726f 725f 6461 7461 736f 7572 6365 5f61  ror_datasource_a
-0001e7d0: 6c72 6561 6479 5f65 7869 7374 7328 6461  lready_exists(da
-0001e7e0: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
-0001e7f0: 2929 0a0a 2020 2020 6966 2064 732e 6765  ))..    if ds.ge
-0001e800: 7428 2273 6861 7265 645f 7769 7468 222c  t("shared_with",
-0001e810: 205b 5d29 206f 7220 6578 6973 7469 6e67   []) or existing
-0001e820: 5f64 732e 6765 7428 2273 6861 7265 645f  _ds.get("shared_
-0001e830: 7769 7468 222c 205b 5d29 3a0a 2020 2020  with", []):.    
-0001e840: 2020 2020 6966 206e 6f74 2075 7365 725f      if not user_
-0001e850: 746f 6b65 6e3a 0a20 2020 2020 2020 2020  token:.         
-0001e860: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
-0001e870: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
-0001e880: 666f 5f73 6b69 7070 696e 675f 7368 6172  fo_skipping_shar
-0001e890: 6564 5f77 6974 685f 656e 7472 7928 2929  ed_with_entry())
-0001e8a0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001e8b0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0001e8c0: 2073 6861 7265 5f61 6e64 5f75 6e73 6861   share_and_unsha
-0001e8d0: 7265 5f64 6174 6173 6f75 7263 6528 0a20  re_datasource(. 
-0001e8e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001e8f0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
-0001e900: 2020 2020 2020 2065 7869 7374 696e 675f         existing_
-0001e910: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
-0001e920: 2020 2020 7573 6572 5f74 6f6b 656e 2c0a      user_token,.
-0001e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e940: 6578 6973 7469 6e67 5f64 732e 6765 7428  existing_ds.get(
-0001e950: 2273 6861 7265 645f 7769 7468 222c 205b  "shared_with", [
-0001e960: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0001e970: 2020 2020 6473 2e67 6574 2822 7368 6172      ds.get("shar
-0001e980: 6564 5f77 6974 6822 2c20 5b5d 292c 0a20  ed_with", []),. 
-0001e990: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001e9a0: 7572 7265 6e74 5f77 732c 0a20 2020 2020  urrent_ws,.     
-0001e9b0: 2020 2020 2020 2029 0a0a 2020 2020 616c         )..    al
-0001e9c0: 7465 725f 7265 7370 6f6e 7365 203d 204e  ter_response = N
-0001e9d0: 6f6e 650a 2020 2020 616c 7465 725f 6572  one.    alter_er
-0001e9e0: 726f 725f 6d65 7373 6167 6520 3d20 4e6f  ror_message = No
-0001e9f0: 6e65 0a20 2020 206e 6577 5f64 6573 6372  ne.    new_descr
-0001ea00: 6970 7469 6f6e 203d 204e 6f6e 650a 2020  iption = None.  
-0001ea10: 2020 6e65 775f 7363 6865 6d61 203d 204e    new_schema = N
-0001ea20: 6f6e 650a 2020 2020 6e65 775f 696e 6469  one.    new_indi
-0001ea30: 6365 7320 3d20 4e6f 6e65 0a20 2020 206e  ces = None.    n
-0001ea40: 6577 5f74 746c 203d 204e 6f6e 650a 0a20  ew_ttl = None.. 
-0001ea50: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001ea60: 6966 2064 6174 6173 6f75 7263 655f 6578  if datasource_ex
-0001ea70: 6973 7473 2061 6e64 2064 735b 2270 6172  ists and ds["par
-0001ea80: 616d 7322 5d5b 2264 6573 6372 6970 7469  ams"]["descripti
-0001ea90: 6f6e 225d 2021 3d20 6578 6973 7469 6e67  on"] != existing
-0001eaa0: 5f64 735b 2264 6573 6372 6970 7469 6f6e  _ds["description
-0001eab0: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
-0001eac0: 6e65 775f 6465 7363 7269 7074 696f 6e20  new_description 
-0001ead0: 3d20 6473 5b22 7061 7261 6d73 225d 5b22  = ds["params"]["
-0001eae0: 6465 7363 7269 7074 696f 6e22 5d0a 0a20  description"].. 
-0001eaf0: 2020 2020 2020 2069 6620 6461 7461 736f         if dataso
-0001eb00: 7572 6365 5f65 7869 7374 7320 616e 6420  urce_exists and 
-0001eb10: 6473 5b22 7061 7261 6d73 225d 2e67 6574  ds["params"].get
-0001eb20: 2822 656e 6769 6e65 5f74 746c 2229 2021  ("engine_ttl") !
-0001eb30: 3d20 6578 6973 7469 6e67 5f64 735b 2265  = existing_ds["e
-0001eb40: 6e67 696e 6522 5d2e 6765 7428 2274 746c  ngine"].get("ttl
-0001eb50: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-0001eb60: 6e65 775f 7474 6c20 3d20 6473 5b22 7061  new_ttl = ds["pa
-0001eb70: 7261 6d73 225d 2e67 6574 2822 656e 6769  rams"].get("engi
-0001eb80: 6e65 5f74 746c 222c 2022 6661 6c73 6522  ne_ttl", "false"
-0001eb90: 290a 0a20 2020 2020 2020 2023 2053 6368  )..        # Sch
-0001eba0: 656d 6120 6669 7865 6420 6279 2074 6865  ema fixed by the
-0001ebb0: 206b 6166 6b61 2063 6f6e 6e65 6374 6f72   kafka connector
-0001ebc0: 0a20 2020 2020 2020 2069 6620 6461 7461  .        if data
-0001ebd0: 736f 7572 6365 5f65 7869 7374 7320 616e  source_exists an
-0001ebe0: 6420 280a 2020 2020 2020 2020 2020 2020  d (.            
-0001ebf0: 6473 5b22 7061 7261 6d73 225d 5b22 7363  ds["params"]["sc
-0001ec00: 6865 6d61 225d 2e72 6570 6c61 6365 2822  hema"].replace("
-0001ec10: 2022 2c20 2222 2920 213d 2065 7869 7374   ", "") != exist
-0001ec20: 696e 675f 6473 5b22 7363 6865 6d61 225d  ing_ds["schema"]
-0001ec30: 5b22 7371 6c5f 7363 6865 6d61 225d 2e72  ["sql_schema"].r
-0001ec40: 6570 6c61 6365 2822 2022 2c20 2222 290a  eplace(" ", "").
-0001ec50: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-0001ec60: 2020 2020 2020 206e 6577 5f73 6368 656d         new_schem
-0001ec70: 6120 3d20 6473 5b22 7061 7261 6d73 225d  a = ds["params"]
-0001ec80: 5b22 7363 6865 6d61 225d 0a0a 2020 2020  ["schema"]..    
-0001ec90: 2020 2020 6966 2064 6174 6173 6f75 7263      if datasourc
-0001eca0: 655f 6578 6973 7473 3a0a 2020 2020 2020  e_exists:.      
-0001ecb0: 2020 2020 2020 6e65 7720 3d20 5b61 7364        new = [asd
-0001ecc0: 6963 7428 696e 6465 7829 2066 6f72 2069  ict(index) for i
-0001ecd0: 6e64 6578 2069 6e20 6473 2e67 6574 2822  ndex in ds.get("
-0001ece0: 7061 7261 6d73 222c 207b 7d29 2e67 6574  params", {}).get
-0001ecf0: 2822 696e 6465 7865 735f 6c69 7374 222c  ("indexes_list",
-0001ed00: 205b 5d29 5d0a 2020 2020 2020 2020 2020   [])].          
-0001ed10: 2020 6578 6973 7469 6e67 203d 2065 7869    existing = exi
-0001ed20: 7374 696e 675f 6473 2e67 6574 2822 696e  sting_ds.get("in
-0001ed30: 6465 7865 7322 2c20 5b5d 290a 2020 2020  dexes", []).    
-0001ed40: 2020 2020 2020 2020 6e65 772e 736f 7274          new.sort
-0001ed50: 286b 6579 3d6c 616d 6264 6120 783a 2078  (key=lambda x: x
-0001ed60: 5b22 6e61 6d65 225d 290a 2020 2020 2020  ["name"]).      
-0001ed70: 2020 2020 2020 6578 6973 7469 6e67 2e73        existing.s
-0001ed80: 6f72 7428 6b65 793d 6c61 6d62 6461 2078  ort(key=lambda x
-0001ed90: 3a20 785b 226e 616d 6522 5d29 0a20 2020  : x["name"]).   
-0001eda0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-0001edb0: 6578 6973 7469 6e67 2920 213d 206c 656e  existing) != len
-0001edc0: 286e 6577 2920 6f72 2061 6e79 285b 2864  (new) or any([(d
-0001edd0: 2c20 6432 2920 666f 7220 642c 2064 3220  , d2) for d, d2 
-0001ede0: 696e 207a 6970 286e 6577 2c20 6578 6973  in zip(new, exis
-0001edf0: 7469 6e67 2920 6966 2064 2021 3d20 6432  ting) if d != d2
-0001ee00: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-0001ee10: 2020 2020 6e65 775f 696e 6469 6365 7320      new_indices 
-0001ee20: 3d20 6473 2e67 6574 2822 7061 7261 6d73  = ds.get("params
-0001ee30: 222c 207b 7d29 2e67 6574 2822 696e 6465  ", {}).get("inde
-0001ee40: 7865 7322 2920 6f72 2022 3022 0a20 2020  xes") or "0".   
-0001ee50: 2020 2020 2069 6620 6e65 775f 6465 7363       if new_desc
-0001ee60: 7269 7074 696f 6e20 6f72 206e 6577 5f73  ription or new_s
-0001ee70: 6368 656d 6120 6f72 206e 6577 5f74 746c  chema or new_ttl
-0001ee80: 206f 7220 286e 6577 5f69 6e64 6963 6573   or (new_indices
-0001ee90: 2069 7320 6e6f 7420 4e6f 6e65 2920 616e   is not None) an
-0001eea0: 6420 286e 6f74 2066 6f72 6b5f 646f 776e  d (not fork_down
-0001eeb0: 7374 7265 616d 206f 7220 6e6f 7420 666f  stream or not fo
-0001eec0: 726b 293a 0a20 2020 2020 2020 2020 2020  rk):.           
-0001eed0: 2061 6c74 6572 5f72 6573 706f 6e73 6520   alter_response 
-0001eee0: 3d20 6177 6169 7420 636c 6965 6e74 2e61  = await client.a
-0001eef0: 6c74 6572 5f64 6174 6173 6f75 7263 6528  lter_datasource(
-0001ef00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ef10: 2064 735f 6e61 6d65 2c0a 2020 2020 2020   ds_name,.      
-0001ef20: 2020 2020 2020 2020 2020 6e65 775f 7363            new_sc
-0001ef30: 6865 6d61 3d6e 6577 5f73 6368 656d 612c  hema=new_schema,
-0001ef40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ef50: 2064 6573 6372 6970 7469 6f6e 3d6e 6577   description=new
-0001ef60: 5f64 6573 6372 6970 7469 6f6e 2c0a 2020  _description,.  
-0001ef70: 2020 2020 2020 2020 2020 2020 2020 7474                tt
-0001ef80: 6c3d 6e65 775f 7474 6c2c 0a20 2020 2020  l=new_ttl,.     
-0001ef90: 2020 2020 2020 2020 2020 2064 7279 5f72             dry_r
-0001efa0: 756e 3d54 7275 652c 0a20 2020 2020 2020  un=True,.       
-0001efb0: 2020 2020 2020 2020 2069 6e64 6578 6573           indexes
-0001efc0: 3d6e 6577 5f69 6e64 6963 6573 2c0a 2020  =new_indices,.  
-0001efd0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001efe0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0001eff0: 2061 7320 653a 0a20 2020 2020 2020 2069   as e:.        i
-0001f000: 6620 2254 6865 7265 2077 6572 6520 6e6f  f "There were no
-0001f010: 206f 7065 7261 7469 6f6e 7320 746f 2070   operations to p
-0001f020: 6572 666f 726d 2220 696e 2073 7472 2865  erform" in str(e
-0001f030: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-0001f040: 6173 730a 2020 2020 2020 2020 656c 7365  ass.        else
-0001f050: 3a0a 2020 2020 2020 2020 2020 2020 616c  :.            al
-0001f060: 7465 725f 6572 726f 725f 6d65 7373 6167  ter_error_messag
-0001f070: 6520 3d20 7374 7228 6529 0a0a 2020 2020  e = str(e)..    
-0001f080: 6966 2061 6c74 6572 5f72 6573 706f 6e73  if alter_respons
-0001f090: 653a 0a20 2020 2020 2020 2069 6620 6769  e:.        if gi
-0001f0a0: 745f 7265 6c65 6173 6520 616e 6420 6e6f  t_release and no
-0001f0b0: 7420 736b 6970 5f63 6f6e 6669 726d 6174  t skip_confirmat
-0001f0c0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-0001f0d0: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
-0001f0e0: 6261 636b 4d61 6e61 6765 722e 696e 666f  backManager.info
-0001f0f0: 5f63 7573 746f 6d5f 6465 706c 6f79 6d65  _custom_deployme
-0001f100: 6e74 2829 290a 2020 2020 2020 2020 2020  nt()).          
-0001f110: 2020 636c 6963 6b2e 6563 686f 2822 2a2a    click.echo("**
-0001f120: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
-0001f130: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
-0001f140: 2a2a 2a2a 2a22 290a 2020 2020 2020 2020  *****").        
-0001f150: 2020 2020 636c 6963 6b2e 6563 686f 2822      click.echo("
-0001f160: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
-0001f170: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
-0001f180: 2a2a 2a2a 2a2a 2a22 290a 2020 2020 2020  *******").      
-0001f190: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
-0001f1a0: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
-0001f1b0: 6f5f 6461 7461 736f 7572 6365 5f64 6f65  o_datasource_doe
-0001f1c0: 736e 745f 6d61 7463 6828 6461 7461 736f  snt_match(dataso
-0001f1d0: 7572 6365 3d64 735f 6e61 6d65 2929 0a20  urce=ds_name)). 
-0001f1e0: 2020 2020 2020 2066 6f72 206f 7065 7261         for opera
-0001f1f0: 7469 6f6e 2069 6e20 616c 7465 725f 7265  tion in alter_re
-0001f200: 7370 6f6e 7365 5b22 6f70 6572 6174 696f  sponse["operatio
-0001f210: 6e73 225d 3a0a 2020 2020 2020 2020 2020  ns"]:.          
-0001f220: 2020 636c 6963 6b2e 6563 686f 2866 222a    click.echo(f"*
-0001f230: 2a20 2020 2d20 207b 6f70 6572 6174 696f  *   -  {operatio
-0001f240: 6e7d 2229 0a0a 2020 2020 2020 2020 6966  n}")..        if
-0001f250: 2073 6b69 705f 636f 6e66 6972 6d61 7469   skip_confirmati
-0001f260: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-0001f270: 6d61 6b65 5f63 6861 6e67 6573 203d 2054  make_changes = T
-0001f280: 7275 650a 2020 2020 2020 2020 656c 7365  rue.        else
-0001f290: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
-0001f2a0: 6b65 5f63 6861 6e67 6573 203d 2063 6c69  ke_changes = cli
-0001f2b0: 636b 2e70 726f 6d70 7428 4665 6564 6261  ck.prompt(Feedba
-0001f2c0: 636b 4d61 6e61 6765 722e 696e 666f 5f61  ckManager.info_a
-0001f2d0: 736b 5f66 6f72 5f61 6c74 6572 5f63 6f6e  sk_for_alter_con
-0001f2e0: 6669 726d 6174 696f 6e28 2929 2e6c 6f77  firmation()).low
-0001f2f0: 6572 2829 203d 3d20 2279 220a 0a20 2020  er() == "y"..   
-0001f300: 2020 2020 2069 6620 6d61 6b65 5f63 6861       if make_cha
-0001f310: 6e67 6573 3a0a 2020 2020 2020 2020 2020  nges:.          
-0001f320: 2020 6177 6169 7420 636c 6965 6e74 2e61    await client.a
-0001f330: 6c74 6572 5f64 6174 6173 6f75 7263 6528  lter_datasource(
-0001f340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f350: 2064 735f 6e61 6d65 2c0a 2020 2020 2020   ds_name,.      
-0001f360: 2020 2020 2020 2020 2020 6e65 775f 7363            new_sc
-0001f370: 6865 6d61 3d6e 6577 5f73 6368 656d 612c  hema=new_schema,
-0001f380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f390: 2064 6573 6372 6970 7469 6f6e 3d6e 6577   description=new
-0001f3a0: 5f64 6573 6372 6970 7469 6f6e 2c0a 2020  _description,.  
-0001f3b0: 2020 2020 2020 2020 2020 2020 2020 7474                tt
-0001f3c0: 6c3d 6e65 775f 7474 6c2c 0a20 2020 2020  l=new_ttl,.     
-0001f3d0: 2020 2020 2020 2020 2020 2064 7279 5f72             dry_r
-0001f3e0: 756e 3d46 616c 7365 2c0a 2020 2020 2020  un=False,.      
-0001f3f0: 2020 2020 2020 2020 2020 696e 6465 7865            indexe
-0001f400: 733d 6e65 775f 696e 6469 6365 732c 0a20  s=new_indices,. 
-0001f410: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001f420: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
-0001f430: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-0001f440: 6765 722e 7375 6363 6573 735f 6461 7461  ger.success_data
-0001f450: 736f 7572 6365 5f61 6c74 6572 2829 290a  source_alter()).
-0001f460: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001f470: 2020 2020 2020 2020 2020 616c 7465 725f            alter_
-0001f480: 6572 726f 725f 6d65 7373 6167 6520 3d20  error_message = 
-0001f490: 2241 6c74 6572 2064 6174 6173 6f75 7263  "Alter datasourc
-0001f4a0: 6520 6361 6e63 656c 6c65 6422 0a0a 2020  e cancelled"..  
-0001f4b0: 2020 6966 2064 6174 6173 6f75 7263 655f    if datasource_
-0001f4c0: 6578 6973 7473 2061 6e64 2064 735b 2270  exists and ds["p
-0001f4d0: 6172 616d 7322 5d2e 6765 7428 2262 6163  arams"].get("bac
-0001f4e0: 6b66 696c 6c5f 636f 6c75 6d6e 2229 2021  kfill_column") !
-0001f4f0: 3d20 6578 6973 7469 6e67 5f64 735b 2274  = existing_ds["t
-0001f500: 6167 7322 5d2e 6765 7428 2262 6163 6b66  ags"].get("backf
-0001f510: 696c 6c5f 636f 6c75 6d6e 2229 3a0a 2020  ill_column"):.  
-0001f520: 2020 2020 2020 7061 7261 6d73 203d 207b        params = {
-0001f530: 0a20 2020 2020 2020 2020 2020 2022 6261  .            "ba
-0001f540: 636b 6669 6c6c 5f63 6f6c 756d 6e22 3a20  ckfill_column": 
-0001f550: 6473 5b22 7061 7261 6d73 225d 2e67 6574  ds["params"].get
-0001f560: 2822 6261 636b 6669 6c6c 5f63 6f6c 756d  ("backfill_colum
-0001f570: 6e22 292c 0a20 2020 2020 2020 207d 0a0a  n"),.        }..
-0001f580: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0001f590: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
-0001f5a0: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-0001f5b0: 6765 722e 696e 666f 5f75 7064 6174 655f  ger.info_update_
-0001f5c0: 6461 7461 736f 7572 6365 2864 6174 6173  datasource(datas
-0001f5d0: 6f75 7263 653d 6473 5f6e 616d 652c 2070  ource=ds_name, p
-0001f5e0: 6172 616d 733d 7061 7261 6d73 2929 0a20  arams=params)). 
-0001f5f0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0001f600: 2063 6c69 656e 742e 7570 6461 7465 5f64   client.update_d
-0001f610: 6174 6173 6f75 7263 6528 6473 5f6e 616d  atasource(ds_nam
-0001f620: 652c 2070 6172 616d 7329 0a20 2020 2020  e, params).     
-0001f630: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
-0001f640: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
-0001f650: 722e 7375 6363 6573 735f 7570 6461 7465  r.success_update
-0001f660: 5f64 6174 6173 6f75 7263 6528 6461 7461  _datasource(data
-0001f670: 736f 7572 6365 3d64 735f 6e61 6d65 2c20  source=ds_name, 
-0001f680: 7061 7261 6d73 3d70 6172 616d 7329 290a  params=params)).
-0001f690: 2020 2020 2020 2020 2020 2020 6d61 6b65              make
-0001f6a0: 5f63 6861 6e67 6573 203d 2054 7275 650a  _changes = True.
-0001f6b0: 2020 2020 2020 2020 2020 2020 616c 7465              alte
-0001f6c0: 725f 7265 7370 6f6e 7365 203d 2054 7275  r_response = Tru
-0001f6d0: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
-0001f6e0: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-0001f6f0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0001f700: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
-0001f710: 6365 7074 696f 6e28 4665 6564 6261 636b  ception(Feedback
-0001f720: 4d61 6e61 6765 722e 6572 726f 725f 7570  Manager.error_up
-0001f730: 6461 7469 6e67 5f64 6174 6173 6f75 7263  dating_datasourc
-0001f740: 6528 6461 7461 736f 7572 6365 3d64 735f  e(datasource=ds_
-0001f750: 6e61 6d65 2c20 6572 726f 723d 7374 7228  name, error=str(
-0001f760: 6529 2929 0a0a 2020 2020 636f 6e6e 6563  e)))..    connec
-0001f770: 746f 725f 6461 7461 203d 204e 6f6e 650a  tor_data = None.
-0001f780: 2020 2020 7072 6f6d 6f74 655f 6572 726f      promote_erro
-0001f790: 725f 6d65 7373 6167 6520 3d20 4e6f 6e65  r_message = None
-0001f7a0: 0a0a 2020 2020 6473 5f70 6172 616d 7320  ..    ds_params 
-0001f7b0: 3d20 6473 5b22 7061 7261 6d73 225d 0a20  = ds["params"]. 
-0001f7c0: 2020 2073 6572 7669 6365 203d 2064 735f     service = ds_
-0001f7d0: 7061 7261 6d73 2e67 6574 2822 7365 7276  params.get("serv
-0001f7e0: 6963 6522 290a 2020 2020 4441 5441 534f  ice").    DATASO
-0001f7f0: 5552 4345 5f56 414c 4944 5f53 4552 5649  URCE_VALID_SERVI
-0001f800: 4345 535f 544f 5f55 5044 4154 4520 3d20  CES_TO_UPDATE = 
-0001f810: 5b22 6269 6771 7565 7279 222c 2022 736e  ["bigquery", "sn
-0001f820: 6f77 666c 616b 6522 5d0a 2020 2020 6966  owflake"].    if
-0001f830: 2064 6174 6173 6f75 7263 655f 6578 6973   datasource_exis
-0001f840: 7473 2061 6e64 2073 6572 7669 6365 2061  ts and service a
-0001f850: 6e64 2073 6572 7669 6365 2069 6e20 5b2a  nd service in [*
-0001f860: 4441 5441 534f 5552 4345 5f56 414c 4944  DATASOURCE_VALID
-0001f870: 5f53 4552 5649 4345 535f 544f 5f55 5044  _SERVICES_TO_UPD
-0001f880: 4154 452c 202a 5052 4556 4945 575f 434f  ATE, *PREVIEW_CO
-0001f890: 4e4e 4543 544f 525f 5345 5256 4943 4553  NNECTOR_SERVICES
-0001f8a0: 5d3a 0a20 2020 2020 2020 2063 6f6e 6e65  ]:.        conne
-0001f8b0: 6374 6f72 5f72 6571 7569 7265 645f 7061  ctor_required_pa
-0001f8c0: 7261 6d73 203d 207b 0a20 2020 2020 2020  rams = {.       
-0001f8d0: 2020 2020 2022 6269 6771 7565 7279 223a       "bigquery":
-0001f8e0: 205b 2273 6572 7669 6365 222c 2022 6372   ["service", "cr
-0001f8f0: 6f6e 222c 2022 6578 7465 726e 616c 5f64  on", "external_d
-0001f900: 6174 615f 736f 7572 6365 225d 2c0a 2020  ata_source"],.  
-0001f910: 2020 2020 2020 2020 2020 2273 6e6f 7766            "snowf
-0001f920: 6c61 6b65 223a 205b 2263 6f6e 6e65 6374  lake": ["connect
-0001f930: 6f72 222c 2022 7365 7276 6963 6522 2c20  or", "service", 
-0001f940: 2263 726f 6e22 2c20 2265 7874 6572 6e61  "cron", "externa
-0001f950: 6c5f 6461 7461 5f73 6f75 7263 6522 5d2c  l_data_source"],
-0001f960: 0a20 2020 2020 2020 2020 2020 2022 7333  .            "s3
-0001f970: 223a 205b 2263 6f6e 6e65 6374 6f72 222c  ": ["connector",
-0001f980: 2022 7365 7276 6963 6522 2c20 2263 726f   "service", "cro
-0001f990: 6e22 2c20 2262 7563 6b65 745f 7572 6922  n", "bucket_uri"
-0001f9a0: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-0001f9b0: 7333 5f69 616d 726f 6c65 223a 205b 2263  s3_iamrole": ["c
-0001f9c0: 6f6e 6e65 6374 6f72 222c 2022 7365 7276  onnector", "serv
-0001f9d0: 6963 6522 2c20 2263 726f 6e22 2c20 2262  ice", "cron", "b
-0001f9e0: 7563 6b65 745f 7572 6922 5d2c 0a20 2020  ucket_uri"],.   
-0001f9f0: 2020 2020 2020 2020 2022 6763 7322 3a20           "gcs": 
-0001fa00: 5b22 636f 6e6e 6563 746f 7222 2c20 2273  ["connector", "s
-0001fa10: 6572 7669 6365 222c 2022 6372 6f6e 222c  ervice", "cron",
-0001fa20: 2022 6275 636b 6574 5f75 7269 225d 2c0a   "bucket_uri"],.
-0001fa30: 2020 2020 2020 2020 7d2e 6765 7428 7365          }.get(se
-0001fa40: 7276 6963 652c 205b 5d29 0a0a 2020 2020  rvice, [])..    
-0001fa50: 2020 2020 6966 206e 6f74 2061 6c6c 286b      if not all(k
-0001fa60: 6579 2069 6e20 6473 5f70 6172 616d 7320  ey in ds_params 
-0001fa70: 666f 7220 6b65 7920 696e 2063 6f6e 6e65  for key in conne
-0001fa80: 6374 6f72 5f72 6571 7569 7265 645f 7061  ctor_required_pa
-0001fa90: 7261 6d73 293a 0a20 2020 2020 2020 2020  rams):.         
-0001faa0: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-0001fab0: 2020 2063 6f6e 6e65 6374 6f72 203d 2064     connector = d
-0001fac0: 735f 7061 7261 6d73 2e67 6574 2822 636f  s_params.get("co
-0001fad0: 6e6e 6563 746f 7222 2c20 4e6f 6e65 290a  nnector", None).
-0001fae0: 0a20 2020 2020 2020 2069 6620 7365 7276  .        if serv
-0001faf0: 6963 6520 696e 2050 5245 5649 4557 5f43  ice in PREVIEW_C
-0001fb00: 4f4e 4e45 4354 4f52 5f53 4552 5649 4345  ONNECTOR_SERVICE
-0001fb10: 533a 0a20 2020 2020 2020 2020 2020 2063  S:.            c
-0001fb20: 6f6e 6e65 6374 6f72 5f69 6420 3d20 6578  onnector_id = ex
-0001fb30: 6973 7469 6e67 5f64 732e 6765 7428 2263  isting_ds.get("c
-0001fb40: 6f6e 6e65 6374 6f72 222c 2022 2229 0a20  onnector", ""). 
-0001fb50: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0001fb60: 7420 636f 6e6e 6563 746f 725f 6964 3a0a  t connector_id:.
-0001fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb80: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-0001fb90: 2020 2020 6375 7272 656e 745f 636f 6e6e      current_conn
-0001fba0: 6563 746f 7220 3d20 6177 6169 7420 636c  ector = await cl
-0001fbb0: 6965 6e74 2e67 6574 5f63 6f6e 6e65 6374  ient.get_connect
-0001fbc0: 6f72 5f62 795f 6964 2865 7869 7374 696e  or_by_id(existin
-0001fbd0: 675f 6473 2e67 6574 2822 636f 6e6e 6563  g_ds.get("connec
-0001fbe0: 746f 7222 2c20 2222 2929 0a20 2020 2020  tor", "")).     
-0001fbf0: 2020 2020 2020 2069 6620 6e6f 7420 6375         if not cu
-0001fc00: 7272 656e 745f 636f 6e6e 6563 746f 723a  rrent_connector:
-0001fc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fc20: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-0001fc30: 2020 2020 2069 6620 6375 7272 656e 745f       if current_
-0001fc40: 636f 6e6e 6563 746f 725b 226e 616d 6522  connector["name"
-0001fc50: 5d20 213d 2064 735f 7061 7261 6d73 5b22  ] != ds_params["
-0001fc60: 636f 6e6e 6563 7469 6f6e 225d 3a0a 2020  connection"]:.  
-0001fc70: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0001fc80: 7261 6d20 3d20 2263 6f6e 6e65 6374 696f  ram = "connectio
-0001fc90: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
-0001fca0: 2020 2064 6174 6166 696c 655f 7061 7261     datafile_para
-0001fcb0: 6d20 3d20 496d 706f 7274 5265 706c 6163  m = ImportReplac
-0001fcc0: 656d 656e 7473 2e67 6574 5f64 6174 6166  ements.get_dataf
-0001fcd0: 696c 655f 7061 7261 6d5f 666f 725f 6c69  ile_param_for_li
-0001fce0: 6e6b 6572 5f70 6172 616d 2873 6572 7669  nker_param(servi
-0001fcf0: 6365 2c20 7061 7261 6d29 206f 7220 7061  ce, param) or pa
-0001fd00: 7261 6d0a 2020 2020 2020 2020 2020 2020  ram.            
-0001fd10: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
-0001fd20: 436c 6963 6b45 7863 6570 7469 6f6e 2846  ClickException(F
-0001fd30: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
-0001fd40: 7272 6f72 5f75 7064 6174 696e 675f 636f  rror_updating_co
-0001fd50: 6e6e 6563 746f 725f 6e6f 745f 7375 7070  nnector_not_supp
-0001fd60: 6f72 7465 6428 7061 7261 6d3d 6461 7461  orted(param=data
-0001fd70: 6669 6c65 5f70 6172 616d 2929 0a0a 2020  file_param))..  
-0001fd80: 2020 2020 2020 2020 2020 6c69 6e6b 6572            linker
-0001fd90: 7320 3d20 6375 7272 656e 745f 636f 6e6e  s = current_conn
-0001fda0: 6563 746f 722e 6765 7428 226c 696e 6b65  ector.get("linke
-0001fdb0: 7273 222c 205b 5d29 0a20 2020 2020 2020  rs", []).       
-0001fdc0: 2020 2020 206c 696e 6b65 7220 3d20 6e65       linker = ne
-0001fdd0: 7874 2828 6c69 6e6b 6572 2066 6f72 206c  xt((linker for l
-0001fde0: 696e 6b65 7220 696e 206c 696e 6b65 7273  inker in linkers
-0001fdf0: 2069 6620 6c69 6e6b 6572 5b22 6461 7461   if linker["data
-0001fe00: 736f 7572 6365 5f69 6422 5d20 3d3d 2065  source_id"] == e
-0001fe10: 7869 7374 696e 675f 6473 5b22 6964 225d  xisting_ds["id"]
-0001fe20: 292c 204e 6f6e 6529 0a20 2020 2020 2020  ), None).       
-0001fe30: 2020 2020 2069 6620 6e6f 7420 6c69 6e6b       if not link
-0001fe40: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
-0001fe50: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-0001fe60: 2020 2020 2020 2020 6c69 6e6b 6572 5f73          linker_s
-0001fe70: 6574 7469 6e67 7320 3d20 6c69 6e6b 6572  ettings = linker
-0001fe80: 2e67 6574 2822 7365 7474 696e 6773 222c  .get("settings",
-0001fe90: 207b 7d29 0a20 2020 2020 2020 2020 2020   {}).           
-0001fea0: 2066 6f72 2070 6172 616d 2c20 7661 6c75   for param, valu
-0001feb0: 6520 696e 206c 696e 6b65 725f 7365 7474  e in linker_sett
-0001fec0: 696e 6773 2e69 7465 6d73 2829 3a0a 2020  ings.items():.  
-0001fed0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-0001fee0: 5f70 6172 616d 735f 7661 6c75 6520 3d20  _params_value = 
-0001fef0: 6473 5f70 6172 616d 732e 6765 7428 7061  ds_params.get(pa
-0001ff00: 7261 6d2c 204e 6f6e 6529 0a20 2020 2020  ram, None).     
-0001ff10: 2020 2020 2020 2020 2020 2069 6620 6473             if ds
-0001ff20: 5f70 6172 616d 735f 7661 6c75 6520 616e  _params_value an
-0001ff30: 6420 6473 5f70 6172 616d 735f 7661 6c75  d ds_params_valu
-0001ff40: 6520 213d 2076 616c 7565 3a0a 2020 2020  e != value:.    
-0001ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff60: 6461 7461 6669 6c65 5f70 6172 616d 203d  datafile_param =
-0001ff70: 2049 6d70 6f72 7452 6570 6c61 6365 6d65   ImportReplaceme
-0001ff80: 6e74 732e 6765 745f 6461 7461 6669 6c65  nts.get_datafile
-0001ff90: 5f70 6172 616d 5f66 6f72 5f6c 696e 6b65  _param_for_linke
-0001ffa0: 725f 7061 7261 6d28 7365 7276 6963 652c  r_param(service,
-0001ffb0: 2070 6172 616d 2920 6f72 2070 6172 616d   param) or param
-0001ffc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ffd0: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-0001ffe0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-0001fff0: 2020 2020 2020 2020 2020 2020 2020 4665                Fe
-00020000: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
-00020010: 726f 725f 7570 6461 7469 6e67 5f63 6f6e  ror_updating_con
-00020020: 6e65 6374 6f72 5f6e 6f74 5f73 7570 706f  nector_not_suppo
-00020030: 7274 6564 2870 6172 616d 3d64 6174 6166  rted(param=dataf
-00020040: 696c 655f 7061 7261 6d2e 7570 7065 7228  ile_param.upper(
-00020050: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00020060: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00020070: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00020080: 2020 2020 2063 6f6e 6e65 6374 6f72 5f64       connector_d
-00020090: 6174 6120 3d20 7b0a 2020 2020 2020 2020  ata = {.        
-000200a0: 2020 2020 2263 6f6e 6e65 6374 6f72 223a      "connector":
-000200b0: 2063 6f6e 6e65 6374 6f72 2c0a 2020 2020   connector,.    
-000200c0: 2020 2020 2020 2020 2273 6572 7669 6365          "service
-000200d0: 223a 2073 6572 7669 6365 2c0a 2020 2020  ": service,.    
-000200e0: 2020 2020 2020 2020 2263 726f 6e22 3a20          "cron": 
-000200f0: 6473 5f70 6172 616d 732e 6765 7428 2263  ds_params.get("c
-00020100: 726f 6e22 2c20 4e6f 6e65 292c 0a20 2020  ron", None),.   
-00020110: 2020 2020 2020 2020 2022 6578 7465 726e           "extern
-00020120: 616c 5f64 6174 615f 736f 7572 6365 223a  al_data_source":
-00020130: 2064 735f 7061 7261 6d73 2e67 6574 2822   ds_params.get("
-00020140: 6578 7465 726e 616c 5f64 6174 615f 736f  external_data_so
-00020150: 7572 6365 222c 204e 6f6e 6529 2c0a 2020  urce", None),.  
-00020160: 2020 2020 2020 2020 2020 2262 7563 6b65            "bucke
-00020170: 745f 7572 6922 3a20 6473 5f70 6172 616d  t_uri": ds_param
-00020180: 732e 6765 7428 2262 7563 6b65 745f 7572  s.get("bucket_ur
-00020190: 6922 2c20 4e6f 6e65 292c 0a20 2020 2020  i", None),.     
-000201a0: 2020 2020 2020 2022 6d6f 6465 223a 2064         "mode": d
-000201b0: 735f 7061 7261 6d73 2e67 6574 2822 6d6f  s_params.get("mo
-000201c0: 6465 222c 2022 7265 706c 6163 6522 292c  de", "replace"),
-000201d0: 0a20 2020 2020 2020 2020 2020 2022 7175  .            "qu
-000201e0: 6572 7922 3a20 6473 5f70 6172 616d 732e  ery": ds_params.
-000201f0: 6765 7428 2271 7565 7279 222c 204e 6f6e  get("query", Non
-00020200: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
-00020210: 2269 6e67 6573 745f 6e6f 7722 3a20 6473  "ingest_now": ds
-00020220: 5f70 6172 616d 732e 6765 7428 2269 6e67  _params.get("ing
-00020230: 6573 745f 6e6f 7722 2c20 4661 6c73 6529  est_now", False)
-00020240: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-00020250: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00020260: 2020 2020 2020 6177 6169 7420 636c 6965        await clie
-00020270: 6e74 2e75 7064 6174 655f 6461 7461 736f  nt.update_dataso
-00020280: 7572 6365 2864 735f 6e61 6d65 2c20 636f  urce(ds_name, co
-00020290: 6e6e 6563 746f 725f 6461 7461 290a 2020  nnector_data).  
-000202a0: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
-000202b0: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
-000202c0: 6167 6572 2e73 7563 6365 7373 5f70 726f  ager.success_pro
-000202d0: 6d6f 7469 6e67 5f64 6174 6173 6f75 7263  moting_datasourc
-000202e0: 6528 6461 7461 736f 7572 6365 3d64 735f  e(datasource=ds_
-000202f0: 6e61 6d65 2929 0a20 2020 2020 2020 2020  name)).         
-00020300: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00020310: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00020320: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00020330: 2020 2020 2070 726f 6d6f 7465 5f65 7272       promote_err
-00020340: 6f72 5f6d 6573 7361 6765 203d 2073 7472  or_message = str
-00020350: 2865 290a 0a20 2020 2069 6620 616c 7465  (e)..    if alte
-00020360: 725f 7265 7370 6f6e 7365 2061 6e64 206d  r_response and m
-00020370: 616b 655f 6368 616e 6765 733a 0a20 2020  ake_changes:.   
-00020380: 2020 2020 2023 2061 6c74 6572 206f 7065       # alter ope
-00020390: 7261 7469 6f6e 2066 696e 6973 6865 640a  ration finished.
-000203a0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-000203b0: 2020 2023 2072 656d 6f76 6564 2072 6570     # removed rep
-000203c0: 6c61 6369 6e67 2062 7920 6465 6661 756c  lacing by defaul
-000203d0: 742e 2057 6865 6e20 6120 6461 7461 736f  t. When a dataso
-000203e0: 7572 6365 2069 7320 7265 6d6f 7665 6420  urce is removed 
-000203f0: 6461 7461 2069 730a 2020 2020 2320 7265  data is.    # re
-00020400: 6d6f 7665 6420 616e 6420 616c 6c20 7468  moved and all th
-00020410: 6520 7265 6665 7265 6e63 6573 206e 6565  e references nee
-00020420: 6473 2074 6f20 6265 2075 7064 6174 6564  ds to be updated
-00020430: 0a20 2020 2069 6620 280a 2020 2020 2020  .    if (.      
-00020440: 2020 6f73 2e67 6574 656e 7628 2254 425f    os.getenv("TB_
-00020450: 495f 4b4e 4f57 5f57 4841 545f 495f 414d  I_KNOW_WHAT_I_AM
-00020460: 5f44 4f49 4e47 2229 0a20 2020 2020 2020  _DOING").       
-00020470: 2061 6e64 2063 6c69 636b 2e70 726f 6d70   and click.promp
-00020480: 7428 4665 6564 6261 636b 4d61 6e61 6765  t(FeedbackManage
-00020490: 722e 696e 666f 5f61 736b 5f66 6f72 5f64  r.info_ask_for_d
-000204a0: 6174 6173 6f75 7263 655f 636f 6e66 6972  atasource_confir
-000204b0: 6d61 7469 6f6e 2829 2920 3d3d 2064 735f  mation()) == ds_
-000204c0: 6e61 6d65 0a20 2020 2029 3a20 2023 2054  name.    ):  # T
-000204d0: 4f44 4f20 6d6f 7665 2074 6f20 434c 490a  ODO move to CLI.
-000204e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000204f0: 2020 2020 2020 2020 2061 7761 6974 2063           await c
-00020500: 6c69 656e 742e 6461 7461 736f 7572 6365  lient.datasource
-00020510: 5f64 656c 6574 6528 6473 5f6e 616d 6529  _delete(ds_name)
-00020520: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00020530: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
-00020540: 4d61 6e61 6765 722e 7375 6363 6573 735f  Manager.success_
-00020550: 6465 6c65 7465 5f64 6174 6173 6f75 7263  delete_datasourc
-00020560: 6528 6461 7461 736f 7572 6365 3d64 735f  e(datasource=ds_
-00020570: 6e61 6d65 2929 0a20 2020 2020 2020 2065  name)).        e
-00020580: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-00020590: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000205a0: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
-000205b0: 6365 7074 696f 6e28 4665 6564 6261 636b  ception(Feedback
-000205c0: 4d61 6e61 6765 722e 6572 726f 725f 7265  Manager.error_re
-000205d0: 6d6f 7669 6e67 5f64 6174 6173 6f75 7263  moving_datasourc
-000205e0: 6528 6461 7461 736f 7572 6365 3d64 735f  e(datasource=ds_
-000205f0: 6e61 6d65 2929 0a20 2020 2020 2020 2072  name)).        r
-00020600: 6574 7572 6e0a 2020 2020 656c 7365 3a0a  eturn.    else:.
-00020610: 2020 2020 2020 2020 6966 2061 6c74 6572          if alter
-00020620: 5f65 7272 6f72 5f6d 6573 7361 6765 3a0a  _error_message:.
-00020630: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00020640: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
-00020650: 6570 7469 6f6e 280a 2020 2020 2020 2020  eption(.        
-00020660: 2020 2020 2020 2020 4665 6564 6261 636b          Feedback
-00020670: 4d61 6e61 6765 722e 6572 726f 725f 6461  Manager.error_da
-00020680: 7461 736f 7572 6365 5f61 6c72 6561 6479  tasource_already
-00020690: 5f65 7869 7374 735f 616e 645f 616c 7465  _exists_and_alte
-000206a0: 725f 6661 696c 6564 280a 2020 2020 2020  r_failed(.      
-000206b0: 2020 2020 2020 2020 2020 2020 2020 6461                da
-000206c0: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
-000206d0: 2c20 616c 7465 725f 6572 726f 725f 6d65  , alter_error_me
-000206e0: 7373 6167 653d 616c 7465 725f 6572 726f  ssage=alter_erro
-000206f0: 725f 6d65 7373 6167 650a 2020 2020 2020  r_message.      
-00020700: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00020710: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00020720: 2020 6966 2070 726f 6d6f 7465 5f65 7272    if promote_err
-00020730: 6f72 5f6d 6573 7361 6765 3a0a 2020 2020  or_message:.    
-00020740: 2020 2020 2020 2020 7261 6973 6520 636c          raise cl
-00020750: 6963 6b2e 436c 6963 6b45 7863 6570 7469  ick.ClickExcepti
-00020760: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-00020770: 2020 2020 4665 6564 6261 636b 4d61 6e61      FeedbackMana
-00020780: 6765 722e 6572 726f 725f 7072 6f6d 6f74  ger.error_promot
-00020790: 696e 675f 6461 7461 736f 7572 6365 2864  ing_datasource(d
-000207a0: 6174 6173 6f75 7263 653d 6473 5f6e 616d  atasource=ds_nam
-000207b0: 652c 2065 7272 6f72 3d70 726f 6d6f 7465  e, error=promote
-000207c0: 5f65 7272 6f72 5f6d 6573 7361 6765 290a  _error_message).
-000207d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000207e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000207f0: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
-00020800: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
-00020810: 6572 2e77 6172 6e69 6e67 5f64 6174 6173  er.warning_datas
-00020820: 6f75 7263 655f 616c 7265 6164 795f 6578  ource_already_ex
-00020830: 6973 7473 2864 6174 6173 6f75 7263 653d  ists(datasource=
-00020840: 6473 5f6e 616d 6529 290a 0a0a 6173 796e  ds_name))...asyn
-00020850: 6320 6465 6620 6e65 775f 746f 6b65 6e28  c def new_token(
-00020860: 746f 6b65 6e3a 2044 6963 745b 7374 722c  token: Dict[str,
-00020870: 2041 6e79 5d2c 2063 6c69 656e 743a 2054   Any], client: T
-00020880: 696e 7942 2c20 666f 7263 653a 2062 6f6f  inyB, force: boo
-00020890: 6c20 3d20 4661 6c73 6529 3a0a 2020 2020  l = False):.    
-000208a0: 6578 6973 7469 6e67 5f74 6f6b 656e 203d  existing_token =
-000208b0: 204e 6f6e 650a 2020 2020 7472 793a 0a20   None.    try:. 
-000208c0: 2020 2020 2020 2065 7869 7374 696e 675f         existing_
-000208d0: 746f 6b65 6e20 3d20 6177 6169 7420 636c  token = await cl
-000208e0: 6965 6e74 2e74 6f6b 656e 5f67 6574 2874  ient.token_get(t
-000208f0: 6f6b 656e 5b22 6e61 6d65 225d 290a 2020  oken["name"]).  
-00020900: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00020910: 6f6e 3a0a 2020 2020 2020 2020 7061 7373  on:.        pass
-00020920: 0a0a 2020 2020 6966 206e 6f74 2065 7869  ..    if not exi
-00020930: 7374 696e 675f 746f 6b65 6e3a 0a20 2020  sting_token:.   
-00020940: 2020 2020 2061 7761 6974 2063 6c69 656e       await clien
-00020950: 742e 746f 6b65 6e5f 6372 6561 7465 2874  t.token_create(t
-00020960: 6f6b 656e 290a 2020 2020 2020 2020 7265  oken).        re
-00020970: 7475 726e 0a0a 2020 2020 6966 2066 6f72  turn..    if for
-00020980: 6365 3a0a 2020 2020 2020 2020 4144 4d49  ce:.        ADMI
-00020990: 4e5f 5343 4f50 4553 203d 205b 2241 444d  N_SCOPES = ["ADM
-000209a0: 494e 222c 2022 4144 4d49 4e5f 5553 4552  IN", "ADMIN_USER
-000209b0: 225d 0a20 2020 2020 2020 2069 6620 616e  "].        if an
-000209c0: 7928 5b73 636f 7065 5b22 7479 7065 225d  y([scope["type"]
-000209d0: 2069 6e20 4144 4d49 4e5f 5343 4f50 4553   in ADMIN_SCOPES
-000209e0: 2066 6f72 2073 636f 7065 2069 6e20 6578   for scope in ex
-000209f0: 6973 7469 6e67 5f74 6f6b 656e 5b22 7363  isting_token["sc
-00020a00: 6f70 6573 225d 5d29 3a0a 2020 2020 2020  opes"]]):.      
-00020a10: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
-00020a20: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
-00020a30: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-00020a40: 2e65 7272 6f72 5f74 6f6b 656e 5f63 616e  .error_token_can
-00020a50: 6e6f 745f 6265 5f6f 7665 7272 6964 656e  not_be_overriden
-00020a60: 2874 6f6b 656e 3d74 6f6b 656e 5b22 6e61  (token=token["na
-00020a70: 6d65 225d 2929 0a0a 2020 2020 2020 2020  me"]))..        
-00020a80: 6177 6169 7420 636c 6965 6e74 2e74 6f6b  await client.tok
-00020a90: 656e 5f75 7064 6174 6528 746f 6b65 6e29  en_update(token)
-00020aa0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-00020ab0: 0a20 2020 2072 6169 7365 2063 6c69 636b  .    raise click
-00020ac0: 2e43 6c69 636b 4578 6365 7074 696f 6e28  .ClickException(
-00020ad0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-00020ae0: 6572 726f 725f 746f 6b65 6e5f 616c 7265  error_token_alre
-00020af0: 6164 795f 6578 6973 7473 2874 6f6b 656e  ady_exists(token
-00020b00: 3d74 6f6b 656e 5b22 6e61 6d65 225d 2929  =token["name"]))
-00020b10: 0a0a 0a61 7379 6e63 2064 6566 2065 7865  ...async def exe
-00020b20: 635f 6669 6c65 280a 2020 2020 636f 6e66  c_file(.    conf
-00020b30: 6967 3a20 4f70 7469 6f6e 616c 5b44 6963  ig: Optional[Dic
-00020b40: 745b 7374 722c 2041 6e79 5d5d 2c0a 2020  t[str, Any]],.  
-00020b50: 2020 723a 2044 6963 745b 7374 722c 2041    r: Dict[str, A
-00020b60: 6e79 5d2c 0a20 2020 2074 625f 636c 6965  ny],.    tb_clie
-00020b70: 6e74 3a20 5469 6e79 422c 0a20 2020 2066  nt: TinyB,.    f
-00020b80: 6f72 6365 3a20 626f 6f6c 2c0a 2020 2020  orce: bool,.    
-00020b90: 6368 6563 6b3a 2062 6f6f 6c2c 0a20 2020  check: bool,.   
-00020ba0: 2064 6562 7567 3a20 626f 6f6c 2c0a 2020   debug: bool,.  
-00020bb0: 2020 706f 7075 6c61 7465 3a20 626f 6f6c    populate: bool
-00020bc0: 2c0a 2020 2020 706f 7075 6c61 7465 5f73  ,.    populate_s
-00020bd0: 7562 7365 742c 0a20 2020 2070 6f70 756c  ubset,.    popul
-00020be0: 6174 655f 636f 6e64 6974 696f 6e2c 0a20  ate_condition,. 
-00020bf0: 2020 2075 6e6c 696e 6b5f 6f6e 5f70 6f70     unlink_on_pop
-00020c00: 756c 6174 655f 6572 726f 722c 0a20 2020  ulate_error,.   
-00020c10: 2077 6169 745f 706f 7075 6c61 7465 2c0a   wait_populate,.
-00020c20: 2020 2020 7573 6572 5f74 6f6b 656e 3a20      user_token: 
-00020c30: 4f70 7469 6f6e 616c 5b73 7472 5d2c 0a20  Optional[str],. 
-00020c40: 2020 206f 7665 7272 6964 655f 6461 7461     override_data
-00020c50: 736f 7572 6365 3a20 626f 6f6c 203d 2046  source: bool = F
-00020c60: 616c 7365 2c0a 2020 2020 6967 6e6f 7265  alse,.    ignore
-00020c70: 5f73 716c 5f65 7272 6f72 733a 2062 6f6f  _sql_errors: boo
-00020c80: 6c20 3d20 4661 6c73 652c 0a20 2020 2073  l = False,.    s
-00020c90: 6b69 705f 636f 6e66 6972 6d61 7469 6f6e  kip_confirmation
-00020ca0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00020cb0: 2020 2020 6f6e 6c79 5f72 6573 706f 6e73      only_respons
-00020cc0: 655f 7469 6d65 733a 2062 6f6f 6c20 3d20  e_times: bool = 
-00020cd0: 4661 6c73 652c 0a20 2020 2074 696d 656f  False,.    timeo
-00020ce0: 7574 3d4e 6f6e 652c 0a20 2020 2072 756e  ut=None,.    run
-00020cf0: 5f74 6573 7473 3d46 616c 7365 2c0a 2020  _tests=False,.  
-00020d00: 2020 6173 5f73 7461 6e64 6172 643d 4661    as_standard=Fa
-00020d10: 6c73 652c 0a20 2020 2074 6573 7473 5f74  lse,.    tests_t
-00020d20: 6f5f 7275 6e3a 2069 6e74 203d 2030 2c0a  o_run: int = 0,.
-00020d30: 2020 2020 7465 7374 735f 746f 5f73 616d      tests_to_sam
-00020d40: 706c 655f 6279 5f70 6172 616d 733a 2069  ple_by_params: i
-00020d50: 6e74 203d 2030 2c0a 2020 2020 7465 7374  nt = 0,.    test
-00020d60: 735f 6669 6c74 6572 5f62 793a 204f 7074  s_filter_by: Opt
-00020d70: 696f 6e61 6c5b 4c69 7374 5b73 7472 5d5d  ional[List[str]]
-00020d80: 203d 204e 6f6e 652c 0a20 2020 2074 6573   = None,.    tes
-00020d90: 7473 5f66 6169 6c66 6173 743a 2062 6f6f  ts_failfast: boo
-00020da0: 6c20 3d20 4661 6c73 652c 0a20 2020 2074  l = False,.    t
-00020db0: 6573 7473 5f69 676e 6f72 655f 6f72 6465  ests_ignore_orde
-00020dc0: 723a 2062 6f6f 6c20 3d20 4661 6c73 652c  r: bool = False,
-00020dd0: 0a20 2020 2074 6573 7473 5f76 616c 6964  .    tests_valid
-00020de0: 6174 655f 7072 6f63 6573 7365 645f 6279  ate_processed_by
-00020df0: 7465 733a 2062 6f6f 6c20 3d20 4661 6c73  tes: bool = Fals
-00020e00: 652c 0a20 2020 2074 6573 7473 5f63 6865  e,.    tests_che
-00020e10: 636b 5f72 6571 7565 7374 735f 6672 6f6d  ck_requests_from
-00020e20: 5f62 7261 6e63 683a 2062 6f6f 6c20 3d20  _branch: bool = 
-00020e30: 4661 6c73 652c 0a20 2020 2063 7572 7265  False,.    curre
-00020e40: 6e74 5f77 733a 204f 7074 696f 6e61 6c5b  nt_ws: Optional[
-00020e50: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
-00020e60: 3d20 4e6f 6e65 2c0a 2020 2020 666f 726b  = None,.    fork
-00020e70: 5f64 6f77 6e73 7472 6561 6d3a 204f 7074  _downstream: Opt
-00020e80: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4661  ional[bool] = Fa
-00020e90: 6c73 652c 0a20 2020 2066 6f72 6b3a 204f  lse,.    fork: O
-00020ea0: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
-00020eb0: 4661 6c73 652c 0a20 2020 2067 6974 5f72  False,.    git_r
-00020ec0: 656c 6561 7365 3a20 4f70 7469 6f6e 616c  elease: Optional
-00020ed0: 5b62 6f6f 6c5d 203d 2046 616c 7365 2c0a  [bool] = False,.
-00020ee0: 293a 0a20 2020 2069 6620 6465 6275 673a  ):.    if debug:
-00020ef0: 0a20 2020 2020 2020 2063 6c69 636b 2e65  .        click.e
-00020f00: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-00020f10: 6765 722e 6465 6275 675f 7275 6e6e 696e  ger.debug_runnin
-00020f20: 675f 6669 6c65 2866 696c 653d 7070 2e70  g_file(file=pp.p
-00020f30: 666f 726d 6174 2872 2929 290a 2020 2020  format(r))).    
-00020f40: 6966 2072 5b22 7265 736f 7572 6365 225d  if r["resource"]
-00020f50: 203d 3d20 2270 6970 6573 223a 0a20 2020   == "pipes":.   
-00020f60: 2020 2020 2061 7761 6974 206e 6577 5f70       await new_p
-00020f70: 6970 6528 0a20 2020 2020 2020 2020 2020  ipe(.           
-00020f80: 2072 2c0a 2020 2020 2020 2020 2020 2020   r,.            
-00020f90: 7462 5f63 6c69 656e 742c 0a20 2020 2020  tb_client,.     
-00020fa0: 2020 2020 2020 2066 6f72 6365 2c0a 2020         force,.  
-00020fb0: 2020 2020 2020 2020 2020 6368 6563 6b2c            check,
-00020fc0: 0a20 2020 2020 2020 2020 2020 2070 6f70  .            pop
-00020fd0: 756c 6174 652c 0a20 2020 2020 2020 2020  ulate,.         
-00020fe0: 2020 2070 6f70 756c 6174 655f 7375 6273     populate_subs
-00020ff0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
-00021000: 706f 7075 6c61 7465 5f63 6f6e 6469 7469  populate_conditi
-00021010: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00021020: 756e 6c69 6e6b 5f6f 6e5f 706f 7075 6c61  unlink_on_popula
-00021030: 7465 5f65 7272 6f72 2c0a 2020 2020 2020  te_error,.      
-00021040: 2020 2020 2020 7761 6974 5f70 6f70 756c        wait_popul
-00021050: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
-00021060: 2069 676e 6f72 655f 7371 6c5f 6572 726f   ignore_sql_erro
-00021070: 7273 3d69 676e 6f72 655f 7371 6c5f 6572  rs=ignore_sql_er
-00021080: 726f 7273 2c0a 2020 2020 2020 2020 2020  rors,.          
-00021090: 2020 6f6e 6c79 5f72 6573 706f 6e73 655f    only_response_
-000210a0: 7469 6d65 733d 6f6e 6c79 5f72 6573 706f  times=only_respo
-000210b0: 6e73 655f 7469 6d65 732c 0a20 2020 2020  nse_times,.     
-000210c0: 2020 2020 2020 2074 696d 656f 7574 3d74         timeout=t
-000210d0: 696d 656f 7574 2c0a 2020 2020 2020 2020  imeout,.        
-000210e0: 2020 2020 7275 6e5f 7465 7374 733d 7275      run_tests=ru
-000210f0: 6e5f 7465 7374 732c 0a20 2020 2020 2020  n_tests,.       
-00021100: 2020 2020 2061 735f 7374 616e 6461 7264       as_standard
-00021110: 3d61 735f 7374 616e 6461 7264 2c0a 2020  =as_standard,.  
-00021120: 2020 2020 2020 2020 2020 7465 7374 735f            tests_
-00021130: 746f 5f72 756e 3d74 6573 7473 5f74 6f5f  to_run=tests_to_
-00021140: 7275 6e2c 0a20 2020 2020 2020 2020 2020  run,.           
-00021150: 2074 6573 7473 5f74 6f5f 7361 6d70 6c65   tests_to_sample
-00021160: 5f62 795f 7061 7261 6d73 3d74 6573 7473  _by_params=tests
-00021170: 5f74 6f5f 7361 6d70 6c65 5f62 795f 7061  _to_sample_by_pa
-00021180: 7261 6d73 2c0a 2020 2020 2020 2020 2020  rams,.          
-00021190: 2020 7465 7374 735f 6669 6c74 6572 5f62    tests_filter_b
-000211a0: 793d 7465 7374 735f 6669 6c74 6572 5f62  y=tests_filter_b
-000211b0: 792c 0a20 2020 2020 2020 2020 2020 2074  y,.            t
-000211c0: 6573 7473 5f66 6169 6c66 6173 743d 7465  ests_failfast=te
-000211d0: 7374 735f 6661 696c 6661 7374 2c0a 2020  sts_failfast,.  
-000211e0: 2020 2020 2020 2020 2020 7465 7374 735f            tests_
-000211f0: 6967 6e6f 7265 5f6f 7264 6572 3d74 6573  ignore_order=tes
-00021200: 7473 5f69 676e 6f72 655f 6f72 6465 722c  ts_ignore_order,
-00021210: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
-00021220: 7473 5f76 616c 6964 6174 655f 7072 6f63  ts_validate_proc
-00021230: 6573 7365 645f 6279 7465 733d 7465 7374  essed_bytes=test
-00021240: 735f 7661 6c69 6461 7465 5f70 726f 6365  s_validate_proce
-00021250: 7373 6564 5f62 7974 6573 2c0a 2020 2020  ssed_bytes,.    
-00021260: 2020 2020 2020 2020 6f76 6572 7269 6465          override
-00021270: 5f64 6174 6173 6f75 7263 653d 6f76 6572  _datasource=over
-00021280: 7269 6465 5f64 6174 6173 6f75 7263 652c  ride_datasource,
-00021290: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
-000212a0: 7473 5f63 6865 636b 5f72 6571 7565 7374  ts_check_request
-000212b0: 735f 6672 6f6d 5f62 7261 6e63 683d 7465  s_from_branch=te
-000212c0: 7374 735f 6368 6563 6b5f 7265 7175 6573  sts_check_reques
-000212d0: 7473 5f66 726f 6d5f 6272 616e 6368 2c0a  ts_from_branch,.
-000212e0: 2020 2020 2020 2020 2020 2020 666f 726b              fork
-000212f0: 5f64 6f77 6e73 7472 6561 6d3d 666f 726b  _downstream=fork
-00021300: 5f64 6f77 6e73 7472 6561 6d2c 0a20 2020  _downstream,.   
-00021310: 2020 2020 2020 2020 2066 6f72 6b3d 666f           fork=fo
-00021320: 726b 2c0a 2020 2020 2020 2020 290a 2020  rk,.        ).  
-00021330: 2020 656c 6966 2072 5b22 7265 736f 7572    elif r["resour
-00021340: 6365 225d 203d 3d20 2264 6174 6173 6f75  ce"] == "datasou
-00021350: 7263 6573 223a 0a20 2020 2020 2020 2061  rces":.        a
-00021360: 7761 6974 206e 6577 5f64 7328 0a20 2020  wait new_ds(.   
-00021370: 2020 2020 2020 2020 2072 2c0a 2020 2020           r,.    
-00021380: 2020 2020 2020 2020 7462 5f63 6c69 656e          tb_clien
-00021390: 742c 0a20 2020 2020 2020 2020 2020 2075  t,.            u
-000213a0: 7365 725f 746f 6b65 6e2c 0a20 2020 2020  ser_token,.     
-000213b0: 2020 2020 2020 2066 6f72 6365 2c0a 2020         force,.  
-000213c0: 2020 2020 2020 2020 2020 736b 6970 5f63            skip_c
-000213d0: 6f6e 6669 726d 6174 696f 6e3d 736b 6970  onfirmation=skip
-000213e0: 5f63 6f6e 6669 726d 6174 696f 6e2c 0a20  _confirmation,. 
-000213f0: 2020 2020 2020 2020 2020 2063 7572 7265             curre
-00021400: 6e74 5f77 733d 6375 7272 656e 745f 7773  nt_ws=current_ws
-00021410: 2c0a 2020 2020 2020 2020 2020 2020 666f  ,.            fo
-00021420: 726b 5f64 6f77 6e73 7472 6561 6d3d 666f  rk_downstream=fo
-00021430: 726b 5f64 6f77 6e73 7472 6561 6d2c 0a20  rk_downstream,. 
-00021440: 2020 2020 2020 2020 2020 2066 6f72 6b3d             fork=
-00021450: 666f 726b 2c0a 2020 2020 2020 2020 2020  fork,.          
-00021460: 2020 6769 745f 7265 6c65 6173 653d 6769    git_release=gi
-00021470: 745f 7265 6c65 6173 652c 0a20 2020 2020  t_release,.     
-00021480: 2020 2029 0a20 2020 2065 6c69 6620 725b     ).    elif r[
-00021490: 2272 6573 6f75 7263 6522 5d20 3d3d 2022  "resource"] == "
-000214a0: 746f 6b65 6e73 223a 0a20 2020 2020 2020  tokens":.       
-000214b0: 2061 7761 6974 206e 6577 5f74 6f6b 656e   await new_token
-000214c0: 2872 2c20 7462 5f63 6c69 656e 742c 2066  (r, tb_client, f
-000214d0: 6f72 6365 290a 2020 2020 656c 7365 3a0a  orce).    else:.
-000214e0: 2020 2020 2020 2020 7261 6973 6520 636c          raise cl
-000214f0: 6963 6b2e 436c 6963 6b45 7863 6570 7469  ick.ClickExcepti
-00021500: 6f6e 2846 6565 6462 6163 6b4d 616e 6167  on(FeedbackManag
-00021510: 6572 2e65 7272 6f72 5f75 6e6b 6e6f 776e  er.error_unknown
-00021520: 5f72 6573 6f75 7263 6528 7265 736f 7572  _resource(resour
-00021530: 6365 3d72 5b22 7265 736f 7572 6365 225d  ce=r["resource"]
-00021540: 2929 0a0a 0a64 6566 2067 6574 5f6e 616d  ))...def get_nam
-00021550: 655f 7665 7273 696f 6e28 6473 3a20 7374  e_version(ds: st
-00021560: 7229 202d 3e20 4469 6374 5b73 7472 2c20  r) -> Dict[str, 
-00021570: 416e 795d 3a0a 2020 2020 2222 220a 2020  Any]:.    """.  
-00021580: 2020 4769 7665 6e20 6120 6e61 6d65 206c    Given a name l
-00021590: 696b 6520 226e 616d 655f 5f64 6576 5f5f  ike "name__dev__
-000215a0: 7630 2220 7265 7475 726e 7320 5b27 6e61  v0" returns ['na
-000215b0: 6d65 272c 2027 6465 7627 2c20 2776 3027  me', 'dev', 'v0'
-000215c0: 5d0a 2020 2020 3e3e 3e20 6765 745f 6e61  ].    >>> get_na
-000215d0: 6d65 5f76 6572 7369 6f6e 2827 6465 765f  me_version('dev_
-000215e0: 5f6e 616d 655f 5f76 3027 290a 2020 2020  _name__v0').    
-000215f0: 7b27 6e61 6d65 273a 2027 6465 765f 5f6e  {'name': 'dev__n
-00021600: 616d 6527 2c20 2776 6572 7369 6f6e 273a  ame', 'version':
-00021610: 2030 7d0a 2020 2020 3e3e 3e20 6765 745f   0}.    >>> get_
-00021620: 6e61 6d65 5f76 6572 7369 6f6e 2827 6e61  name_version('na
-00021630: 6d65 5f5f 7630 2729 0a20 2020 207b 276e  me__v0').    {'n
-00021640: 616d 6527 3a20 276e 616d 6527 2c20 2776  ame': 'name', 'v
-00021650: 6572 7369 6f6e 273a 2030 7d0a 2020 2020  ersion': 0}.    
-00021660: 3e3e 3e20 6765 745f 6e61 6d65 5f76 6572  >>> get_name_ver
-00021670: 7369 6f6e 2827 6465 765f 5f6e 616d 6527  sion('dev__name'
-00021680: 290a 2020 2020 7b27 6e61 6d65 273a 2027  ).    {'name': '
-00021690: 6465 765f 5f6e 616d 6527 2c20 2776 6572  dev__name', 'ver
-000216a0: 7369 6f6e 273a 204e 6f6e 657d 0a20 2020  sion': None}.   
-000216b0: 203e 3e3e 2067 6574 5f6e 616d 655f 7665   >>> get_name_ve
-000216c0: 7273 696f 6e28 276e 616d 6527 290a 2020  rsion('name').  
-000216d0: 2020 7b27 6e61 6d65 273a 2027 6e61 6d65    {'name': 'name
-000216e0: 272c 2027 7665 7273 696f 6e27 3a20 4e6f  ', 'version': No
-000216f0: 6e65 7d0a 2020 2020 3e3e 3e20 6765 745f  ne}.    >>> get_
-00021700: 6e61 6d65 5f76 6572 7369 6f6e 2827 686f  name_version('ho
-00021710: 7261 7269 6f5f 5f33 5f5f 7069 7065 2729  rario__3__pipe')
-00021720: 0a20 2020 207b 276e 616d 6527 3a20 2768  .    {'name': 'h
-00021730: 6f72 6172 696f 5f5f 335f 5f70 6970 6527  orario__3__pipe'
-00021740: 2c20 2776 6572 7369 6f6e 273a 204e 6f6e  , 'version': Non
-00021750: 657d 0a20 2020 203e 3e3e 2067 6574 5f6e  e}.    >>> get_n
-00021760: 616d 655f 7665 7273 696f 6e28 2768 6f72  ame_version('hor
-00021770: 6172 696f 5f5f 6368 6563 6b65 7227 290a  ario__checker').
-00021780: 2020 2020 7b27 6e61 6d65 273a 2027 686f      {'name': 'ho
-00021790: 7261 7269 6f5f 5f63 6865 636b 6572 272c  rario__checker',
-000217a0: 2027 7665 7273 696f 6e27 3a20 4e6f 6e65   'version': None
-000217b0: 7d0a 2020 2020 3e3e 3e20 6765 745f 6e61  }.    >>> get_na
-000217c0: 6d65 5f76 6572 7369 6f6e 2827 6465 765f  me_version('dev_
-000217d0: 5f68 6f72 6172 696f 5f5f 6368 6563 6b65  _horario__checke
-000217e0: 7227 290a 2020 2020 7b27 6e61 6d65 273a  r').    {'name':
-000217f0: 2027 6465 765f 5f68 6f72 6172 696f 5f5f   'dev__horario__
-00021800: 6368 6563 6b65 7227 2c20 2776 6572 7369  checker', 'versi
-00021810: 6f6e 273a 204e 6f6e 657d 0a20 2020 203e  on': None}.    >
-00021820: 3e3e 2067 6574 5f6e 616d 655f 7665 7273  >> get_name_vers
-00021830: 696f 6e28 2774 675f 5f64 4163 7469 7669  ion('tg__dActivi
-00021840: 6461 6465 735f 5f76 305f 7069 7065 5f33  dades__v0_pipe_3
-00021850: 3930 3727 290a 2020 2020 7b27 6e61 6d65  907').    {'name
-00021860: 273a 2027 7467 5f5f 6441 6374 6976 6964  ': 'tg__dActivid
-00021870: 6164 6573 272c 2027 7665 7273 696f 6e27  ades', 'version'
-00021880: 3a20 307d 0a20 2020 203e 3e3e 2067 6574  : 0}.    >>> get
-00021890: 5f6e 616d 655f 7665 7273 696f 6e28 2774  _name_version('t
-000218a0: 675f 5f64 4163 7469 7669 6461 6465 735f  g__dActividades_
-000218b0: 5f76 615f 7069 7065 5f33 3930 3727 290a  _va_pipe_3907').
-000218c0: 2020 2020 7b27 6e61 6d65 273a 2027 7467      {'name': 'tg
-000218d0: 5f5f 6441 6374 6976 6964 6164 6573 5f5f  __dActividades__
-000218e0: 7661 5f70 6970 655f 3339 3037 272c 2027  va_pipe_3907', '
-000218f0: 7665 7273 696f 6e27 3a20 4e6f 6e65 7d0a  version': None}.
-00021900: 2020 2020 3e3e 3e20 6765 745f 6e61 6d65      >>> get_name
-00021910: 5f76 6572 7369 6f6e 2827 7467 5f5f 6f72  _version('tg__or
-00021920: 6967 696e 5f77 6f72 6b73 7061 6365 2e73  igin_workspace.s
-00021930: 6861 7265 645f 6473 5f5f 7633 3930 3727  hared_ds__v3907'
-00021940: 290a 2020 2020 7b27 6e61 6d65 273a 2027  ).    {'name': '
-00021950: 7467 5f5f 6f72 6967 696e 5f77 6f72 6b73  tg__origin_works
-00021960: 7061 6365 2e73 6861 7265 645f 6473 272c  pace.shared_ds',
-00021970: 2027 7665 7273 696f 6e27 3a20 3339 3037   'version': 3907
-00021980: 7d0a 2020 2020 3e3e 3e20 6765 745f 6e61  }.    >>> get_na
-00021990: 6d65 5f76 6572 7369 6f6e 2827 746d 7068  me_version('tmph
-000219a0: 3865 6774 6c5f 5f27 290a 2020 2020 7b27  8egtl__').    {'
-000219b0: 6e61 6d65 273a 2027 746d 7068 3865 6774  name': 'tmph8egt
-000219c0: 6c5f 5f27 2c20 2776 6572 7369 6f6e 273a  l__', 'version':
-000219d0: 204e 6f6e 657d 0a20 2020 203e 3e3e 2067   None}.    >>> g
-000219e0: 6574 5f6e 616d 655f 7665 7273 696f 6e28  et_name_version(
-000219f0: 2774 6d70 6838 6567 746c 5f5f 3132 335f  'tmph8egtl__123_
-00021a00: 5f27 290a 2020 2020 7b27 6e61 6d65 273a  _').    {'name':
-00021a10: 2027 746d 7068 3865 6774 6c5f 5f31 3233   'tmph8egtl__123
-00021a20: 5f5f 272c 2027 7665 7273 696f 6e27 3a20  __', 'version': 
-00021a30: 4e6f 6e65 7d0a 2020 2020 3e3e 3e20 6765  None}.    >>> ge
-00021a40: 745f 6e61 6d65 5f76 6572 7369 6f6e 2827  t_name_version('
-00021a50: 6465 765f 5f6e 616d 655f 5f76 3027 290a  dev__name__v0').
-00021a60: 2020 2020 7b27 6e61 6d65 273a 2027 6465      {'name': 'de
-00021a70: 765f 5f6e 616d 6527 2c20 2776 6572 7369  v__name', 'versi
-00021a80: 6f6e 273a 2030 7d0a 2020 2020 3e3e 3e20  on': 0}.    >>> 
-00021a90: 6765 745f 6e61 6d65 5f76 6572 7369 6f6e  get_name_version
-00021aa0: 2827 6e61 6d65 5f5f 7630 2729 0a20 2020  ('name__v0').   
-00021ab0: 207b 276e 616d 6527 3a20 276e 616d 6527   {'name': 'name'
-00021ac0: 2c20 2776 6572 7369 6f6e 273a 2030 7d0a  , 'version': 0}.
-00021ad0: 2020 2020 3e3e 3e20 6765 745f 6e61 6d65      >>> get_name
-00021ae0: 5f76 6572 7369 6f6e 2827 6465 765f 5f6e  _version('dev__n
-00021af0: 616d 6527 290a 2020 2020 7b27 6e61 6d65  ame').    {'name
-00021b00: 273a 2027 6465 765f 5f6e 616d 6527 2c20  ': 'dev__name', 
-00021b10: 2776 6572 7369 6f6e 273a 204e 6f6e 657d  'version': None}
-00021b20: 0a20 2020 203e 3e3e 2067 6574 5f6e 616d  .    >>> get_nam
-00021b30: 655f 7665 7273 696f 6e28 276e 616d 6527  e_version('name'
-00021b40: 290a 2020 2020 7b27 6e61 6d65 273a 2027  ).    {'name': '
-00021b50: 6e61 6d65 272c 2027 7665 7273 696f 6e27  name', 'version'
-00021b60: 3a20 4e6f 6e65 7d0a 2020 2020 3e3e 3e20  : None}.    >>> 
-00021b70: 6765 745f 6e61 6d65 5f76 6572 7369 6f6e  get_name_version
-00021b80: 2827 686f 7261 7269 6f5f 5f33 5f5f 7069  ('horario__3__pi
-00021b90: 7065 2729 0a20 2020 207b 276e 616d 6527  pe').    {'name'
-00021ba0: 3a20 2768 6f72 6172 696f 5f5f 335f 5f70  : 'horario__3__p
-00021bb0: 6970 6527 2c20 2776 6572 7369 6f6e 273a  ipe', 'version':
-00021bc0: 204e 6f6e 657d 0a20 2020 203e 3e3e 2067   None}.    >>> g
-00021bd0: 6574 5f6e 616d 655f 7665 7273 696f 6e28  et_name_version(
-00021be0: 2768 6f72 6172 696f 5f5f 6368 6563 6b65  'horario__checke
-00021bf0: 7227 290a 2020 2020 7b27 6e61 6d65 273a  r').    {'name':
-00021c00: 2027 686f 7261 7269 6f5f 5f63 6865 636b   'horario__check
-00021c10: 6572 272c 2027 7665 7273 696f 6e27 3a20  er', 'version': 
-00021c20: 4e6f 6e65 7d0a 2020 2020 3e3e 3e20 6765  None}.    >>> ge
-00021c30: 745f 6e61 6d65 5f76 6572 7369 6f6e 2827  t_name_version('
-00021c40: 6465 765f 5f68 6f72 6172 696f 5f5f 6368  dev__horario__ch
-00021c50: 6563 6b65 7227 290a 2020 2020 7b27 6e61  ecker').    {'na
-00021c60: 6d65 273a 2027 6465 765f 5f68 6f72 6172  me': 'dev__horar
-00021c70: 696f 5f5f 6368 6563 6b65 7227 2c20 2776  io__checker', 'v
-00021c80: 6572 7369 6f6e 273a 204e 6f6e 657d 0a20  ersion': None}. 
-00021c90: 2020 203e 3e3e 2067 6574 5f6e 616d 655f     >>> get_name_
-00021ca0: 7665 7273 696f 6e28 2774 675f 5f64 4163  version('tg__dAc
-00021cb0: 7469 7669 6461 6465 735f 5f76 305f 7069  tividades__v0_pi
-00021cc0: 7065 5f33 3930 3727 290a 2020 2020 7b27  pe_3907').    {'
-00021cd0: 6e61 6d65 273a 2027 7467 5f5f 6441 6374  name': 'tg__dAct
-00021ce0: 6976 6964 6164 6573 272c 2027 7665 7273  ividades', 'vers
-00021cf0: 696f 6e27 3a20 307d 0a20 2020 203e 3e3e  ion': 0}.    >>>
-00021d00: 2067 6574 5f6e 616d 655f 7665 7273 696f   get_name_versio
-00021d10: 6e28 2774 675f 5f6f 7269 6769 6e5f 776f  n('tg__origin_wo
-00021d20: 726b 7370 6163 652e 7368 6172 6564 5f64  rkspace.shared_d
-00021d30: 735f 5f76 3339 3037 2729 0a20 2020 207b  s__v3907').    {
-00021d40: 276e 616d 6527 3a20 2774 675f 5f6f 7269  'name': 'tg__ori
-00021d50: 6769 6e5f 776f 726b 7370 6163 652e 7368  gin_workspace.sh
-00021d60: 6172 6564 5f64 7327 2c20 2776 6572 7369  ared_ds', 'versi
-00021d70: 6f6e 273a 2033 3930 377d 0a20 2020 203e  on': 3907}.    >
-00021d80: 3e3e 2067 6574 5f6e 616d 655f 7665 7273  >> get_name_vers
-00021d90: 696f 6e28 2774 6d70 6838 6567 746c 5f5f  ion('tmph8egtl__
-00021da0: 2729 0a20 2020 207b 276e 616d 6527 3a20  ').    {'name': 
-00021db0: 2774 6d70 6838 6567 746c 5f5f 272c 2027  'tmph8egtl__', '
-00021dc0: 7665 7273 696f 6e27 3a20 4e6f 6e65 7d0a  version': None}.
-00021dd0: 2020 2020 3e3e 3e20 6765 745f 6e61 6d65      >>> get_name
-00021de0: 5f76 6572 7369 6f6e 2827 746d 7068 3865  _version('tmph8e
-00021df0: 6774 6c5f 5f31 3233 5f5f 2729 0a20 2020  gtl__123__').   
-00021e00: 207b 276e 616d 6527 3a20 2774 6d70 6838   {'name': 'tmph8
-00021e10: 6567 746c 5f5f 3132 335f 5f27 2c20 2776  egtl__123__', 'v
-00021e20: 6572 7369 6f6e 273a 204e 6f6e 657d 0a20  ersion': None}. 
-00021e30: 2020 2022 2222 0a20 2020 2074 6b20 3d20     """.    tk = 
-00021e40: 6473 2e72 7370 6c69 7428 225f 5f22 2c20  ds.rsplit("__", 
-00021e50: 3229 0a20 2020 2069 6620 6c65 6e28 746b  2).    if len(tk
-00021e60: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-00021e70: 7265 7475 726e 207b 226e 616d 6522 3a20  return {"name": 
-00021e80: 746b 5b30 5d2c 2022 7665 7273 696f 6e22  tk[0], "version"
-00021e90: 3a20 4e6f 6e65 7d0a 2020 2020 656c 6966  : None}.    elif
-00021ea0: 206c 656e 2874 6b29 203d 3d20 323a 0a20   len(tk) == 2:. 
-00021eb0: 2020 2020 2020 2069 6620 6c65 6e28 746b         if len(tk
-00021ec0: 5b31 5d29 3a0a 2020 2020 2020 2020 2020  [1]):.          
-00021ed0: 2020 6966 2074 6b5b 315d 5b30 5d20 3d3d    if tk[1][0] ==
-00021ee0: 2022 7622 2061 6e64 2072 652e 6d61 7463   "v" and re.matc
-00021ef0: 6828 225b 302d 395d 2b24 222c 2074 6b5b  h("[0-9]+$", tk[
-00021f00: 315d 5b31 3a5d 293a 0a20 2020 2020 2020  1][1:]):.       
-00021f10: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00021f20: 7b22 6e61 6d65 223a 2074 6b5b 305d 2c20  {"name": tk[0], 
-00021f30: 2276 6572 7369 6f6e 223a 2069 6e74 2874  "version": int(t
-00021f40: 6b5b 315d 5b31 3a5d 297d 0a20 2020 2020  k[1][1:])}.     
-00021f50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00021f60: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00021f70: 7572 6e20 7b22 6e61 6d65 223a 2074 6b5b  urn {"name": tk[
-00021f80: 305d 202b 2022 5f5f 2220 2b20 746b 5b31  0] + "__" + tk[1
-00021f90: 5d2c 2022 7665 7273 696f 6e22 3a20 4e6f  ], "version": No
-00021fa0: 6e65 7d0a 2020 2020 656c 6966 206c 656e  ne}.    elif len
-00021fb0: 2874 6b29 203d 3d20 3320 616e 6420 6c65  (tk) == 3 and le
-00021fc0: 6e28 746b 5b32 5d29 3a0a 2020 2020 2020  n(tk[2]):.      
-00021fd0: 2020 6966 2074 6b5b 325d 203d 3d20 2263    if tk[2] == "c
-00021fe0: 6865 636b 6572 223a 0a20 2020 2020 2020  hecker":.       
-00021ff0: 2020 2020 2072 6574 7572 6e20 7b22 6e61       return {"na
-00022000: 6d65 223a 2074 6b5b 305d 202b 2022 5f5f  me": tk[0] + "__
-00022010: 2220 2b20 746b 5b31 5d20 2b20 225f 5f22  " + tk[1] + "__"
-00022020: 202b 2074 6b5b 325d 2c20 2276 6572 7369   + tk[2], "versi
-00022030: 6f6e 223a 204e 6f6e 657d 0a20 2020 2020  on": None}.     
-00022040: 2020 2069 6620 746b 5b32 5d5b 305d 203d     if tk[2][0] =
-00022050: 3d20 2276 223a 0a20 2020 2020 2020 2020  = "v":.         
-00022060: 2020 2070 6172 7473 203d 2074 6b5b 325d     parts = tk[2]
-00022070: 2e73 706c 6974 2822 5f22 290a 2020 2020  .split("_").    
-00022080: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00022090: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-000220a0: 7572 6e20 7b22 6e61 6d65 223a 2074 6b5b  urn {"name": tk[
-000220b0: 305d 202b 2022 5f5f 2220 2b20 746b 5b31  0] + "__" + tk[1
-000220c0: 5d2c 2022 7665 7273 696f 6e22 3a20 696e  ], "version": in
-000220d0: 7428 7061 7274 735b 305d 5b31 3a5d 297d  t(parts[0][1:])}
-000220e0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-000220f0: 6570 7420 5661 6c75 6545 7272 6f72 3a0a  ept ValueError:.
-00022100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022110: 7265 7475 726e 207b 226e 616d 6522 3a20  return {"name": 
-00022120: 746b 5b30 5d20 2b20 225f 5f22 202b 2074  tk[0] + "__" + t
-00022130: 6b5b 315d 202b 2022 5f5f 2220 2b20 746b  k[1] + "__" + tk
-00022140: 5b32 5d2c 2022 7665 7273 696f 6e22 3a20  [2], "version": 
-00022150: 4e6f 6e65 7d0a 2020 2020 2020 2020 656c  None}.        el
-00022160: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00022170: 7265 7475 726e 207b 226e 616d 6522 3a20  return {"name": 
-00022180: 225f 5f22 2e6a 6f69 6e28 746b 5b30 3a5d  "__".join(tk[0:]
-00022190: 292c 2022 7665 7273 696f 6e22 3a20 4e6f  ), "version": No
-000221a0: 6e65 7d0a 0a20 2020 2072 6574 7572 6e20  ne}..    return 
-000221b0: 7b22 6e61 6d65 223a 2064 732c 2022 7665  {"name": ds, "ve
-000221c0: 7273 696f 6e22 3a20 4e6f 6e65 7d0a 0a0a  rsion": None}...
-000221d0: 6465 6620 6765 745f 7265 736f 7572 6365  def get_resource
-000221e0: 5f76 6572 7369 6f6e 7328 6461 7461 736f  _versions(dataso
-000221f0: 7572 6365 733a 204c 6973 745b 7374 725d  urces: List[str]
-00022200: 293a 0a20 2020 2022 2222 0a20 2020 2072  ):.    """.    r
-00022210: 6574 7572 6e20 7468 6520 6c61 7465 7374  eturn the latest
-00022220: 2076 6572 7369 6f6e 2066 6f72 2061 6c6c   version for all
-00022230: 2074 6865 2064 6174 6173 6f75 7263 6573   the datasources
-00022240: 0a20 2020 2022 2222 0a20 2020 2076 6572  .    """.    ver
-00022250: 7369 6f6e 7320 3d20 7b7d 0a20 2020 2066  sions = {}.    f
-00022260: 6f72 2078 2069 6e20 6461 7461 736f 7572  or x in datasour
-00022270: 6365 733a 0a20 2020 2020 2020 2074 203d  ces:.        t =
-00022280: 2067 6574 5f6e 616d 655f 7665 7273 696f   get_name_versio
-00022290: 6e28 7829 0a20 2020 2020 2020 206e 616d  n(x).        nam
-000222a0: 6520 3d20 745b 226e 616d 6522 5d0a 2020  e = t["name"].  
-000222b0: 2020 2020 2020 6966 2074 2e67 6574 2822        if t.get("
-000222c0: 7665 7273 696f 6e22 2c20 4e6f 6e65 2920  version", None) 
-000222d0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000222e0: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
-000222f0: 735b 6e61 6d65 5d20 3d20 745b 2276 6572  s[name] = t["ver
-00022300: 7369 6f6e 225d 0a20 2020 2072 6574 7572  sion"].    retur
-00022310: 6e20 7665 7273 696f 6e73 0a0a 0a64 6566  n versions...def
-00022320: 2067 6574 5f72 656d 6f74 655f 7265 736f   get_remote_reso
-00022330: 7572 6365 5f6e 616d 655f 7769 7468 6f75  urce_name_withou
-00022340: 745f 7665 7273 696f 6e28 7265 6d6f 7465  t_version(remote
-00022350: 5f72 6573 6f75 7263 655f 6e61 6d65 3a20  _resource_name: 
-00022360: 7374 7229 202d 3e20 7374 723a 0a20 2020  str) -> str:.   
-00022370: 2022 2222 0a20 2020 203e 3e3e 2067 6574   """.    >>> get
-00022380: 5f72 656d 6f74 655f 7265 736f 7572 6365  _remote_resource
-00022390: 5f6e 616d 655f 7769 7468 6f75 745f 7665  _name_without_ve
-000223a0: 7273 696f 6e28 2272 5f5f 6461 7461 736f  rsion("r__dataso
-000223b0: 7572 6365 2229 0a20 2020 2027 725f 5f64  urce").    'r__d
-000223c0: 6174 6173 6f75 7263 6527 0a20 2020 203e  atasource'.    >
-000223d0: 3e3e 2067 6574 5f72 656d 6f74 655f 7265  >> get_remote_re
-000223e0: 736f 7572 6365 5f6e 616d 655f 7769 7468  source_name_with
-000223f0: 6f75 745f 7665 7273 696f 6e28 2272 5f5f  out_version("r__
-00022400: 6461 7461 736f 7572 6365 5f5f 7630 2229  datasource__v0")
-00022410: 0a20 2020 2027 725f 5f64 6174 6173 6f75  .    'r__datasou
-00022420: 7263 6527 0a20 2020 203e 3e3e 2067 6574  rce'.    >>> get
-00022430: 5f72 656d 6f74 655f 7265 736f 7572 6365  _remote_resource
-00022440: 5f6e 616d 655f 7769 7468 6f75 745f 7665  _name_without_ve
-00022450: 7273 696f 6e28 2264 6174 6173 6f75 7263  rsion("datasourc
-00022460: 6522 290a 2020 2020 2764 6174 6173 6f75  e").    'datasou
-00022470: 7263 6527 0a20 2020 2022 2222 0a20 2020  rce'.    """.   
-00022480: 2070 6172 7473 203d 2067 6574 5f6e 616d   parts = get_nam
-00022490: 655f 7665 7273 696f 6e28 7265 6d6f 7465  e_version(remote
-000224a0: 5f72 6573 6f75 7263 655f 6e61 6d65 290a  _resource_name).
-000224b0: 2020 2020 7265 7475 726e 2070 6172 7473      return parts
-000224c0: 5b22 6e61 6d65 225d 0a0a 0a64 6566 2067  ["name"]...def g
-000224d0: 6574 5f64 6570 5f66 726f 6d5f 7261 775f  et_dep_from_raw_
-000224e0: 7461 626c 6573 2878 3a20 7374 7229 202d  tables(x: str) -
-000224f0: 3e20 7374 723a 0a20 2020 2022 2222 0a20  > str:.    """. 
-00022500: 2020 2064 6174 6173 6f75 7263 6573 204b     datasources K
-00022510: 4559 2063 6f6d 6d61 6e64 2067 656e 6572  EY command gener
-00022520: 6174 6573 2074 6162 6c65 732c 2074 6869  ates tables, thi
-00022530: 7320 7472 616e 7366 6f72 6d20 7468 6520  s transform the 
-00022540: 7573 6564 2074 6162 6c65 2077 6974 6820  used table with 
-00022550: 7468 6520 736f 7572 6365 2066 696c 650a  the source file.
-00022560: 2020 2020 3e3e 3e20 6765 745f 6465 705f      >>> get_dep_
-00022570: 6672 6f6d 5f72 6177 5f74 6162 6c65 7328  from_raw_tables(
-00022580: 2774 6573 7427 290a 2020 2020 2774 6573  'test').    'tes
-00022590: 7427 0a20 2020 203e 3e3e 2067 6574 5f64  t'.    >>> get_d
-000225a0: 6570 5f66 726f 6d5f 7261 775f 7461 626c  ep_from_raw_tabl
-000225b0: 6573 2827 7465 7374 5f6a 6f69 6e5f 6279  es('test_join_by
-000225c0: 5f63 6f6c 756d 6e27 290a 2020 2020 2774  _column').    't
-000225d0: 6573 7427 0a20 2020 2022 2222 0a0a 2020  est'.    """..  
-000225e0: 2020 7472 793a 0a20 2020 2020 2020 2072    try:.        r
-000225f0: 6574 7572 6e20 785b 3a20 782e 696e 6465  eturn x[: x.inde
-00022600: 7828 225f 6a6f 696e 5f62 795f 2229 5d0a  x("_join_by_")].
-00022610: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
-00022620: 4572 726f 723a 0a20 2020 2020 2020 2072  Error:.        r
-00022630: 6574 7572 6e20 780a 0a0a 6465 6620 6372  eturn x...def cr
-00022640: 6561 7465 5f64 6f77 6e73 7472 6561 6d5f  eate_downstream_
-00022650: 6465 7065 6e64 656e 6379 5f67 7261 7068  dependency_graph
-00022660: 2864 6570 656e 6465 6e63 795f 6772 6170  (dependency_grap
-00022670: 683a 2044 6963 745b 7374 722c 2053 6574  h: Dict[str, Set
-00022680: 5b73 7472 5d5d 2c20 616c 6c5f 7265 736f  [str]], all_reso
-00022690: 7572 6365 733a 2044 6963 745b 7374 722c  urces: Dict[str,
-000226a0: 2044 6963 745b 7374 722c 2041 6e79 5d5d   Dict[str, Any]]
-000226b0: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
-000226c0: 6869 7320 6675 6e63 7469 6f6e 2072 6576  his function rev
-000226d0: 6572 7365 7320 7468 6520 6465 7065 6e64  erses the depend
-000226e0: 656e 6379 2067 7261 7068 206f 6274 6169  ency graph obtai
-000226f0: 6e65 6420 6672 6f6d 2062 7569 6c64 5f67  ned from build_g
-00022700: 7261 7068 2073 6f20 796f 7520 6861 7665  raph so you have
-00022710: 2064 6f77 6e73 7472 6561 6d20 6465 7065   downstream depe
-00022720: 6e64 656e 6369 6573 2066 6f72 2065 6163  ndencies for eac
-00022730: 6820 6e6f 6465 2069 6e20 7468 6520 6772  h node in the gr
-00022740: 6170 682e 0a0a 2020 2020 4164 6469 7469  aph...    Additi
-00022750: 6f6e 616c 6c79 2074 616b 6573 2069 6e74  onally takes int
-00022760: 6f20 6163 636f 756e 7420 7461 7267 6574  o account target
-00022770: 5f64 6174 6173 6f75 7263 6520 6f66 206d  _datasource of m
-00022780: 6174 6572 6961 6c69 7a65 6420 7669 6577  aterialized view
-00022790: 730a 2020 2020 2222 220a 2020 2020 646f  s.    """.    do
-000227a0: 776e 7374 7265 616d 5f64 6570 656e 6465  wnstream_depende
-000227b0: 6e63 795f 6772 6170 683a 2044 6963 745b  ncy_graph: Dict[
-000227c0: 7374 722c 2053 6574 5b73 7472 5d5d 203d  str, Set[str]] =
-000227d0: 207b 6e6f 6465 3a20 7365 7428 2920 666f   {node: set() fo
-000227e0: 7220 6e6f 6465 2069 6e20 6465 7065 6e64  r node in depend
-000227f0: 656e 6379 5f67 7261 7068 7d0a 0a20 2020  ency_graph}..   
-00022800: 2066 6f72 206e 6f64 652c 2064 6570 656e   for node, depen
-00022810: 6465 6e63 6965 7320 696e 2064 6570 656e  dencies in depen
-00022820: 6465 6e63 795f 6772 6170 682e 6974 656d  dency_graph.item
-00022830: 7328 293a 0a20 2020 2020 2020 2066 6f72  s():.        for
-00022840: 2064 6570 656e 6465 6e63 7920 696e 2064   dependency in d
-00022850: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
-00022860: 2020 2020 2020 2020 2069 6620 6465 7065           if depe
-00022870: 6e64 656e 6379 206e 6f74 2069 6e20 646f  ndency not in do
-00022880: 776e 7374 7265 616d 5f64 6570 656e 6465  wnstream_depende
-00022890: 6e63 795f 6772 6170 683a 0a20 2020 2020  ncy_graph:.     
-000228a0: 2020 2020 2020 2020 2020 2023 2061 2073             # a s
-000228b0: 6861 7265 6420 6461 7461 2073 6f75 7263  hared data sourc
-000228c0: 652c 2077 6520 6361 6e20 736b 6970 2069  e, we can skip i
-000228d0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-000228e0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-000228f0: 2020 2020 2020 2064 6f77 6e73 7472 6561         downstrea
-00022900: 6d5f 6465 7065 6e64 656e 6379 5f67 7261  m_dependency_gra
-00022910: 7068 5b64 6570 656e 6465 6e63 795d 2e61  ph[dependency].a
-00022920: 6464 286e 6f64 6529 0a0a 2020 2020 666f  dd(node)..    fo
-00022930: 7220 6b65 7920 696e 2064 6963 7428 646f  r key in dict(do
-00022940: 776e 7374 7265 616d 5f64 6570 656e 6465  wnstream_depende
-00022950: 6e63 795f 6772 6170 6829 3a0a 2020 2020  ncy_graph):.    
-00022960: 2020 2020 7461 7267 6574 5f64 6174 6173      target_datas
-00022970: 6f75 7263 6520 3d20 6765 745f 7461 7267  ource = get_targ
-00022980: 6574 5f6d 6174 6572 6961 6c69 7a65 645f  et_materialized_
-00022990: 6461 7461 5f73 6f75 7263 655f 6e61 6d65  data_source_name
-000229a0: 2861 6c6c 5f72 6573 6f75 7263 6573 5b6b  (all_resources[k
-000229b0: 6579 5d29 0a20 2020 2020 2020 2069 6620  ey]).        if 
-000229c0: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
-000229d0: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
-000229e0: 6f77 6e73 7472 6561 6d5f 6465 7065 6e64  ownstream_depend
-000229f0: 656e 6379 5f67 7261 7068 5b6b 6579 5d2e  ency_graph[key].
-00022a00: 7570 6461 7465 287b 7461 7267 6574 5f64  update({target_d
-00022a10: 6174 6173 6f75 7263 657d 290a 2020 2020  atasource}).    
-00022a20: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00022a30: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
-00022a40: 6e73 7472 6561 6d5f 6465 7065 6e64 656e  nstream_dependen
-00022a50: 6379 5f67 7261 7068 5b74 6172 6765 745f  cy_graph[target_
-00022a60: 6461 7461 736f 7572 6365 5d2e 7265 6d6f  datasource].remo
-00022a70: 7665 286b 6579 290a 2020 2020 2020 2020  ve(key).        
-00022a80: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
-00022a90: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00022aa0: 2020 2020 2070 6173 730a 0a20 2020 2072       pass..    r
-00022ab0: 6574 7572 6e20 646f 776e 7374 7265 616d  eturn downstream
-00022ac0: 5f64 6570 656e 6465 6e63 795f 6772 6170  _dependency_grap
-00022ad0: 680a 0a0a 6465 6620 7570 6461 7465 5f64  h...def update_d
-00022ae0: 6570 5f6d 6170 5f72 6563 7572 7369 7665  ep_map_recursive
-00022af0: 6c79 280a 2020 2020 6465 705f 6d61 703a  ly(.    dep_map:
-00022b00: 2044 6963 745b 7374 722c 2053 6574 5b73   Dict[str, Set[s
-00022b10: 7472 5d5d 2c0a 2020 2020 646f 776e 7374  tr]],.    downst
-00022b20: 7265 616d 5f64 6570 5f6d 6170 3a20 4469  ream_dep_map: Di
-00022b30: 6374 5b73 7472 2c20 5365 745b 7374 725d  ct[str, Set[str]
-00022b40: 5d2c 0a20 2020 2061 6c6c 5f72 6573 6f75  ],.    all_resou
-00022b50: 7263 6573 3a20 4469 6374 5b73 7472 2c20  rces: Dict[str, 
-00022b60: 4469 6374 5b73 7472 2c20 416e 795d 5d2c  Dict[str, Any]],
-00022b70: 0a20 2020 2074 6f5f 7275 6e3a 2044 6963  .    to_run: Dic
-00022b80: 745b 7374 722c 2044 6963 745b 7374 722c  t[str, Dict[str,
-00022b90: 2041 6e79 5d5d 2c0a 2020 2020 6465 705f   Any]],.    dep_
-00022ba0: 6d61 705f 6b65 7973 3a20 4c69 7374 5b73  map_keys: List[s
-00022bb0: 7472 5d2c 0a20 2020 206b 6579 3a20 4f70  tr],.    key: Op
-00022bc0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00022bd0: 6e65 2c0a 2020 2020 7669 7369 7465 643a  ne,.    visited:
-00022be0: 204f 7074 696f 6e61 6c5b 4c69 7374 5b73   Optional[List[s
-00022bf0: 7472 5d5d 203d 204e 6f6e 652c 0a29 3a0a  tr]] = None,.):.
-00022c00: 2020 2020 2222 220a 2020 2020 4769 7665      """.    Give
-00022c10: 6e20 6120 646f 776e 7374 7265 616d 5f64  n a downstream_d
-00022c20: 6570 5f6d 6170 206f 6274 6169 6e65 6420  ep_map obtained 
-00022c30: 6672 6f6d 2063 7265 6174 655f 646f 776e  from create_down
-00022c40: 7374 7265 616d 5f64 6570 656e 6465 6e63  stream_dependenc
-00022c50: 795f 6772 6170 6820 7468 6973 2066 756e  y_graph this fun
-00022c60: 6374 696f 6e20 7570 6461 7465 7320 6561  ction updates ea
-00022c70: 6368 206e 6f64 6520 7265 6375 7273 6976  ch node recursiv
-00022c80: 656c 7920 746f 2063 6f6d 706c 6574 6520  ely to complete 
-00022c90: 7468 6520 646f 776e 7374 7265 616d 2064  the downstream d
-00022ca0: 6570 656e 6465 6e63 7920 6772 6170 6820  ependency graph 
-00022cb0: 666f 7220 6561 6368 206e 6f64 650a 2020  for each node.  
-00022cc0: 2020 2222 220a 2020 2020 6966 206e 6f74    """.    if not
-00022cd0: 2076 6973 6974 6564 3a0a 2020 2020 2020   visited:.      
-00022ce0: 2020 7669 7369 7465 6420 3d20 6c69 7374    visited = list
-00022cf0: 2829 0a20 2020 2069 6620 6e6f 7420 6b65  ().    if not ke
-00022d00: 7920 616e 6420 6c65 6e28 6465 705f 6d61  y and len(dep_ma
-00022d10: 705f 6b65 7973 2920 3d3d 2030 3a0a 2020  p_keys) == 0:.  
-00022d20: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00022d30: 2069 6620 6e6f 7420 6b65 793a 0a20 2020   if not key:.   
-00022d40: 2020 2020 206b 6579 203d 2064 6570 5f6d       key = dep_m
-00022d50: 6170 5f6b 6579 732e 706f 7028 290a 2020  ap_keys.pop().  
-00022d60: 2020 6966 206b 6579 206e 6f74 2069 6e20    if key not in 
-00022d70: 6465 705f 6d61 703a 0a20 2020 2020 2020  dep_map:.       
-00022d80: 2064 6570 5f6d 6170 5b6b 6579 5d20 3d20   dep_map[key] = 
-00022d90: 7365 7428 290a 2020 2020 656c 7365 3a0a  set().    else:.
-00022da0: 2020 2020 2020 2020 7669 7369 7465 642e          visited.
-00022db0: 6170 7065 6e64 286b 6579 290a 2020 2020  append(key).    
-00022dc0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00022dd0: 666f 7220 6465 7020 696e 2064 6f77 6e73  for dep in downs
-00022de0: 7472 6561 6d5f 6465 705f 6d61 702e 6765  tream_dep_map.ge
-00022df0: 7428 6b65 792c 207b 7d29 3a0a 2020 2020  t(key, {}):.    
-00022e00: 2020 2020 6966 2064 6570 206e 6f74 2069      if dep not i
-00022e10: 6e20 646f 776e 7374 7265 616d 5f64 6570  n downstream_dep
-00022e20: 5f6d 6170 3a0a 2020 2020 2020 2020 2020  _map:.          
-00022e30: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00022e40: 2020 2074 6f5f 7275 6e5b 6465 705d 203d     to_run[dep] =
-00022e50: 2061 6c6c 5f72 6573 6f75 7263 6573 2e67   all_resources.g
-00022e60: 6574 2864 6570 2c20 7b7d 290a 2020 2020  et(dep, {}).    
-00022e70: 2020 2020 7570 6461 7465 5f64 6570 5f6d      update_dep_m
-00022e80: 6170 5f72 6563 7572 7369 7665 6c79 280a  ap_recursively(.
-00022e90: 2020 2020 2020 2020 2020 2020 6465 705f              dep_
-00022ea0: 6d61 702c 2064 6f77 6e73 7472 6561 6d5f  map, downstream_
-00022eb0: 6465 705f 6d61 702c 2061 6c6c 5f72 6573  dep_map, all_res
-00022ec0: 6f75 7263 6573 2c20 746f 5f72 756e 2c20  ources, to_run, 
-00022ed0: 6465 705f 6d61 705f 6b65 7973 2c20 6b65  dep_map_keys, ke
-00022ee0: 793d 6465 702c 2076 6973 6974 6564 3d76  y=dep, visited=v
-00022ef0: 6973 6974 6564 0a20 2020 2020 2020 2029  isited.        )
-00022f00: 0a20 2020 2020 2020 2064 6570 5f6d 6170  .        dep_map
-00022f10: 5b6b 6579 5d2e 7570 6461 7465 2864 6f77  [key].update(dow
-00022f20: 6e73 7472 6561 6d5f 6465 705f 6d61 705b  nstream_dep_map[
-00022f30: 6465 705d 290a 2020 2020 2020 2020 6465  dep]).        de
-00022f40: 705f 6d61 705b 6b65 795d 2e75 7064 6174  p_map[key].updat
-00022f50: 6528 7b64 6570 7d29 0a20 2020 2020 2020  e({dep}).       
-00022f60: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00022f70: 2020 6465 705f 6d61 705b 6b65 795d 2e72    dep_map[key].r
-00022f80: 656d 6f76 6528 6b65 7929 0a20 2020 2020  emove(key).     
-00022f90: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-00022fa0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00022fb0: 7061 7373 0a0a 2020 2020 746f 5f72 756e  pass..    to_run
-00022fc0: 5b6b 6579 5d20 3d20 616c 6c5f 7265 736f  [key] = all_reso
-00022fd0: 7572 6365 732e 6765 7428 6b65 792c 207b  urces.get(key, {
-00022fe0: 7d29 0a20 2020 2075 7064 6174 655f 6465  }).    update_de
-00022ff0: 705f 6d61 705f 7265 6375 7273 6976 656c  p_map_recursivel
-00023000: 7928 0a20 2020 2020 2020 2064 6570 5f6d  y(.        dep_m
-00023010: 6170 2c20 646f 776e 7374 7265 616d 5f64  ap, downstream_d
-00023020: 6570 5f6d 6170 2c20 616c 6c5f 7265 736f  ep_map, all_reso
-00023030: 7572 6365 732c 2074 6f5f 7275 6e2c 2064  urces, to_run, d
-00023040: 6570 5f6d 6170 5f6b 6579 732c 206b 6579  ep_map_keys, key
-00023050: 3d4e 6f6e 652c 2076 6973 6974 6564 3d76  =None, visited=v
-00023060: 6973 6974 6564 0a20 2020 2029 0a0a 0a64  isited.    )...d
-00023070: 6566 2067 656e 6572 6174 655f 666f 726b  ef generate_fork
-00023080: 646f 776e 7374 7265 616d 5f67 7261 7068  downstream_graph
-00023090: 280a 2020 2020 616c 6c5f 6465 705f 6d61  (.    all_dep_ma
-000230a0: 703a 2044 6963 745b 7374 722c 2053 6574  p: Dict[str, Set
-000230b0: 5b73 7472 5d5d 2c0a 2020 2020 616c 6c5f  [str]],.    all_
-000230c0: 7265 736f 7572 6365 733a 2044 6963 745b  resources: Dict[
-000230d0: 7374 722c 2044 6963 745b 7374 722c 2041  str, Dict[str, A
-000230e0: 6e79 5d5d 2c0a 2020 2020 746f 5f72 756e  ny]],.    to_run
-000230f0: 3a20 4469 6374 5b73 7472 2c20 4469 6374  : Dict[str, Dict
-00023100: 5b73 7472 2c20 416e 795d 5d2c 0a20 2020  [str, Any]],.   
-00023110: 2064 6570 5f6d 6170 5f6b 6579 733a 204c   dep_map_keys: L
-00023120: 6973 745b 7374 725d 2c0a 2920 2d3e 2054  ist[str],.) -> T
-00023130: 7570 6c65 5b44 6963 745b 7374 722c 2053  uple[Dict[str, S
-00023140: 6574 5b73 7472 5d5d 2c20 4469 6374 5b73  et[str]], Dict[s
-00023150: 7472 2c20 4469 6374 5b73 7472 2c20 416e  tr, Dict[str, An
-00023160: 795d 5d5d 3a0a 2020 2020 2222 220a 2020  y]]]:.    """.  
-00023170: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
-00023180: 666f 7220 6120 6769 7665 6e20 6772 6170  for a given grap
-00023190: 6820 6f66 2064 6570 656e 6465 6e63 6965  h of dependencie
-000231a0: 7320 6672 6f6d 206c 6566 7420 746f 2072  s from left to r
-000231b0: 6967 6874 2e20 4974 2077 696c 6c20 6765  ight. It will ge
-000231c0: 6e65 7261 7465 2061 206e 6577 2067 7261  nerate a new gra
-000231d0: 7068 2077 6974 6820 7468 6520 6465 7065  ph with the depe
-000231e0: 6e64 656e 6369 6573 2066 726f 6d20 7269  ndencies from ri
-000231f0: 6768 7420 746f 206c 6566 742c 2062 7574  ght to left, but
-00023200: 2074 616b 696e 6720 696e 746f 2061 6363   taking into acc
-00023210: 6f75 6e74 2074 6861 7420 6576 656e 2069  ount that even i
-00023220: 6620 736f 6d65 206e 6f64 6573 2061 7265  f some nodes are
-00023230: 206e 6f74 2069 6e73 6964 6520 746f 5f72   not inside to_r
-00023240: 756e 2c20 7468 6579 2061 7265 2073 7469  un, they are sti
-00023250: 6c6c 2064 6570 656e 6465 6e63 6965 7320  ll dependencies 
-00023260: 7468 6174 206e 6565 6420 746f 2062 6520  that need to be 
-00023270: 6465 706c 6f79 6564 2e0a 0a20 2020 203e  deployed...    >
-00023280: 3e3e 2064 6570 732c 205f 203d 2067 656e  >> deps, _ = gen
-00023290: 6572 6174 655f 666f 726b 646f 776e 7374  erate_forkdownst
-000232a0: 7265 616d 5f67 7261 7068 280a 2020 2020  ream_graph(.    
-000232b0: 2e2e 2e20 2020 2020 7b0a 2020 2020 2e2e  ...     {.    ..
-000232c0: 2e20 2020 2020 2020 2020 2761 273a 207b  .         'a': {
-000232d0: 2762 277d 2c0a 2020 2020 2e2e 2e20 2020  'b'},.    ...   
-000232e0: 2020 2020 2020 2762 273a 207b 2763 277d        'b': {'c'}
-000232f0: 2c0a 2020 2020 2e2e 2e20 2020 2020 2020  ,.    ...       
-00023300: 2020 2763 273a 2073 6574 2829 2c0a 2020    'c': set(),.  
-00023310: 2020 2e2e 2e20 2020 2020 7d2c 0a20 2020    ...     },.   
-00023320: 202e 2e2e 2020 2020 207b 0a20 2020 202e   ...     {.    .
-00023330: 2e2e 2020 2020 2020 2020 2027 6127 3a20  ..         'a': 
-00023340: 7b27 7265 736f 7572 6365 5f6e 616d 6527  {'resource_name'
-00023350: 3a20 2761 277d 2c0a 2020 2020 2e2e 2e20  : 'a'},.    ... 
-00023360: 2020 2020 2020 2020 2762 273a 207b 2772          'b': {'r
-00023370: 6573 6f75 7263 655f 6e61 6d65 273a 2027  esource_name': '
-00023380: 6227 2c20 276e 6f64 6573 273a 205b 7b27  b', 'nodes': [{'
-00023390: 7061 7261 6d73 273a 207b 2774 7970 6527  params': {'type'
-000233a0: 3a20 276d 6174 6572 6961 6c69 7a65 6427  : 'materialized'
-000233b0: 2c20 2764 6174 6173 6f75 7263 6527 3a20  , 'datasource': 
-000233c0: 2763 277d 7d5d 207d 2c0a 2020 2020 2e2e  'c'}}] },.    ..
-000233d0: 2e20 2020 2020 2020 2020 2763 273a 207b  .         'c': {
-000233e0: 2772 6573 6f75 7263 655f 6e61 6d65 273a  'resource_name':
-000233f0: 2027 6327 7d2c 0a20 2020 202e 2e2e 2020   'c'},.    ...  
-00023400: 2020 207d 2c0a 2020 2020 2e2e 2e20 2020     },.    ...   
-00023410: 2020 7b0a 2020 2020 2e2e 2e20 2020 2020    {.    ...     
-00023420: 2020 2020 2761 273a 207b 2772 6573 6f75      'a': {'resou
-00023430: 7263 655f 6e61 6d65 273a 2027 6127 7d2c  rce_name': 'a'},
-00023440: 0a20 2020 202e 2e2e 2020 2020 207d 2c0a  .    ...     },.
-00023450: 2020 2020 2e2e 2e20 2020 2020 5b27 6127      ...     ['a'
-00023460: 2c20 2762 272c 2027 6327 5d2c 0a20 2020  , 'b', 'c'],.   
-00023470: 202e 2e2e 2029 0a20 2020 203e 3e3e 207b   ... ).    >>> {
-00023480: 6b3a 2073 6f72 7465 6428 7629 2066 6f72  k: sorted(v) for
-00023490: 206b 2c20 7620 696e 2064 6570 732e 6974   k, v in deps.it
-000234a0: 656d 7328 297d 0a20 2020 207b 2763 273a  ems()}.    {'c':
-000234b0: 205b 5d2c 2027 6227 3a20 5b27 6127 2c20   [], 'b': ['a', 
-000234c0: 2763 275d 2c20 2761 273a 205b 5d7d 0a0a  'c'], 'a': []}..
-000234d0: 2020 2020 3e3e 3e20 6465 7073 2c20 5f20      >>> deps, _ 
-000234e0: 3d20 6765 6e65 7261 7465 5f66 6f72 6b64  = generate_forkd
-000234f0: 6f77 6e73 7472 6561 6d5f 6772 6170 6828  ownstream_graph(
-00023500: 0a20 2020 202e 2e2e 2020 2020 207b 0a20  .    ...     {. 
-00023510: 2020 202e 2e2e 2020 2020 2020 2020 2027     ...         '
-00023520: 6127 3a20 7b27 6227 7d2c 0a20 2020 202e  a': {'b'},.    .
-00023530: 2e2e 2020 2020 2020 2020 2027 6227 3a20  ..         'b': 
-00023540: 7b27 6327 7d2c 0a20 2020 202e 2e2e 2020  {'c'},.    ...  
-00023550: 2020 2020 2020 2027 6327 3a20 7365 7428         'c': set(
-00023560: 292c 0a20 2020 202e 2e2e 2020 2020 207d  ),.    ...     }
-00023570: 2c0a 2020 2020 2e2e 2e20 2020 2020 7b0a  ,.    ...     {.
-00023580: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
-00023590: 2761 273a 207b 2772 6573 6f75 7263 655f  'a': {'resource_
-000235a0: 6e61 6d65 273a 2027 6127 7d2c 0a20 2020  name': 'a'},.   
-000235b0: 202e 2e2e 2020 2020 2020 2020 2027 6227   ...         'b'
-000235c0: 3a20 7b27 7265 736f 7572 6365 5f6e 616d  : {'resource_nam
-000235d0: 6527 3a20 2762 272c 2027 6e6f 6465 7327  e': 'b', 'nodes'
-000235e0: 3a20 5b7b 2770 6172 616d 7327 3a20 7b27  : [{'params': {'
-000235f0: 7479 7065 273a 2027 6d61 7465 7269 616c  type': 'material
-00023600: 697a 6564 272c 2027 6461 7461 736f 7572  ized', 'datasour
-00023610: 6365 273a 2027 6327 7d7d 5d20 7d2c 0a20  ce': 'c'}}] },. 
-00023620: 2020 202e 2e2e 2020 2020 2020 2020 2027     ...         '
-00023630: 6327 3a20 7b27 7265 736f 7572 6365 5f6e  c': {'resource_n
-00023640: 616d 6527 3a20 2763 277d 2c0a 2020 2020  ame': 'c'},.    
-00023650: 2e2e 2e20 2020 2020 7d2c 0a20 2020 202e  ...     },.    .
-00023660: 2e2e 2020 2020 207b 0a20 2020 202e 2e2e  ..     {.    ...
-00023670: 2020 2020 2020 2020 2027 6227 3a20 7b27           'b': {'
-00023680: 7265 736f 7572 6365 5f6e 616d 6527 3a20  resource_name': 
-00023690: 2762 277d 2c0a 2020 2020 2e2e 2e20 2020  'b'},.    ...   
-000236a0: 2020 7d2c 0a20 2020 202e 2e2e 2020 2020    },.    ...    
-000236b0: 205b 2761 272c 2027 6227 2c20 2763 275d   ['a', 'b', 'c']
-000236c0: 2c0a 2020 2020 2e2e 2e20 290a 2020 2020  ,.    ... ).    
-000236d0: 3e3e 3e20 7b6b 3a20 736f 7274 6564 2876  >>> {k: sorted(v
-000236e0: 2920 666f 7220 6b2c 2076 2069 6e20 6465  ) for k, v in de
-000236f0: 7073 2e69 7465 6d73 2829 7d0a 2020 2020  ps.items()}.    
-00023700: 7b27 6327 3a20 5b5d 2c20 2762 273a 205b  {'c': [], 'b': [
-00023710: 2761 272c 2027 6327 5d2c 2027 6127 3a20  'a', 'c'], 'a': 
-00023720: 5b5d 7d0a 0a20 2020 203e 3e3e 2064 6570  []}..    >>> dep
-00023730: 732c 205f 203d 2067 656e 6572 6174 655f  s, _ = generate_
-00023740: 666f 726b 646f 776e 7374 7265 616d 5f67  forkdownstream_g
-00023750: 7261 7068 280a 2020 2020 2e2e 2e20 2020  raph(.    ...   
-00023760: 2020 7b0a 2020 2020 2e2e 2e20 2020 2020    {.    ...     
-00023770: 2020 2020 276d 6967 7261 7465 645f 5f61      'migrated__a
-00023780: 273a 207b 2761 277d 2c0a 2020 2020 2e2e  ': {'a'},.    ..
-00023790: 2e20 2020 2020 2020 2020 2761 273a 207b  .         'a': {
-000237a0: 2762 277d 2c0a 2020 2020 2e2e 2e20 2020  'b'},.    ...   
-000237b0: 2020 2020 2020 2762 273a 207b 2763 277d        'b': {'c'}
-000237c0: 2c0a 2020 2020 2e2e 2e20 2020 2020 2020  ,.    ...       
-000237d0: 2020 2763 273a 2073 6574 2829 2c0a 2020    'c': set(),.  
-000237e0: 2020 2e2e 2e20 2020 2020 7d2c 0a20 2020    ...     },.   
-000237f0: 202e 2e2e 2020 2020 207b 0a20 2020 202e   ...     {.    .
-00023800: 2e2e 2020 2020 2020 2020 2027 6d69 6772  ..         'migr
-00023810: 6174 6564 5f5f 6127 3a20 7b27 7265 736f  ated__a': {'reso
-00023820: 7572 6365 5f6e 616d 6527 3a20 276d 6967  urce_name': 'mig
-00023830: 7261 7465 645f 5f61 272c 2027 6e6f 6465  rated__a', 'node
-00023840: 7327 3a20 5b7b 2770 6172 616d 7327 3a20  s': [{'params': 
-00023850: 7b27 7479 7065 273a 2027 6d61 7465 7269  {'type': 'materi
-00023860: 616c 697a 6564 272c 2027 6461 7461 736f  alized', 'dataso
-00023870: 7572 6365 273a 2027 6127 7d7d 5d7d 2c0a  urce': 'a'}}]},.
-00023880: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
-00023890: 2761 273a 207b 2772 6573 6f75 7263 655f  'a': {'resource_
-000238a0: 6e61 6d65 273a 2027 6127 7d2c 0a20 2020  name': 'a'},.   
-000238b0: 202e 2e2e 2020 2020 2020 2020 2027 6227   ...         'b'
-000238c0: 3a20 7b27 7265 736f 7572 6365 5f6e 616d  : {'resource_nam
-000238d0: 6527 3a20 2762 272c 2027 6e6f 6465 7327  e': 'b', 'nodes'
-000238e0: 3a20 5b7b 2770 6172 616d 7327 3a20 7b27  : [{'params': {'
-000238f0: 7479 7065 273a 2027 6d61 7465 7269 616c  type': 'material
-00023900: 697a 6564 272c 2027 6461 7461 736f 7572  ized', 'datasour
-00023910: 6365 273a 2027 6327 7d7d 5d20 7d2c 0a20  ce': 'c'}}] },. 
-00023920: 2020 202e 2e2e 2020 2020 2020 2020 2027     ...         '
-00023930: 6327 3a20 7b27 7265 736f 7572 6365 5f6e  c': {'resource_n
-00023940: 616d 6527 3a20 2763 277d 2c0a 2020 2020  ame': 'c'},.    
-00023950: 2e2e 2e20 2020 2020 7d2c 0a20 2020 202e  ...     },.    .
-00023960: 2e2e 2020 2020 207b 0a20 2020 202e 2e2e  ..     {.    ...
-00023970: 2020 2020 2020 2020 2027 6d69 6772 6174           'migrat
-00023980: 6564 5f5f 6127 3a20 7b27 7265 736f 7572  ed__a': {'resour
-00023990: 6365 5f6e 616d 6527 3a20 276d 6967 7261  ce_name': 'migra
-000239a0: 7465 645f 5f61 277d 2c0a 2020 2020 2e2e  ted__a'},.    ..
-000239b0: 2e20 2020 2020 2020 2020 2761 273a 207b  .         'a': {
-000239c0: 2772 6573 6f75 7263 655f 6e61 6d65 273a  'resource_name':
-000239d0: 2027 6127 7d2c 0a20 2020 202e 2e2e 2020   'a'},.    ...  
-000239e0: 2020 207d 2c0a 2020 2020 2e2e 2e20 2020     },.    ...   
-000239f0: 2020 5b27 6d69 6772 6174 6564 5f61 272c    ['migrated_a',
-00023a00: 2027 6127 2c20 2762 272c 2027 6327 5d2c   'a', 'b', 'c'],
-00023a10: 0a20 2020 202e 2e2e 2029 0a20 2020 203e  .    ... ).    >
-00023a20: 3e3e 207b 6b3a 2073 6f72 7465 6428 7629  >> {k: sorted(v)
-00023a30: 2066 6f72 206b 2c20 7620 696e 2064 6570   for k, v in dep
-00023a40: 732e 6974 656d 7328 297d 0a20 2020 207b  s.items()}.    {
-00023a50: 2763 273a 205b 5d2c 2027 6227 3a20 5b27  'c': [], 'b': ['
-00023a60: 6127 2c20 2763 275d 2c20 2761 273a 205b  a', 'c'], 'a': [
-00023a70: 5d2c 2027 6d69 6772 6174 6564 5f61 273a  ], 'migrated_a':
-00023a80: 205b 5d7d 0a20 2020 2022 2222 0a20 2020   []}.    """.   
-00023a90: 2064 6f77 6e73 7472 6561 6d5f 6465 705f   downstream_dep_
-00023aa0: 6d61 7020 3d20 6372 6561 7465 5f64 6f77  map = create_dow
-00023ab0: 6e73 7472 6561 6d5f 6465 7065 6e64 656e  nstream_dependen
-00023ac0: 6379 5f67 7261 7068 2861 6c6c 5f64 6570  cy_graph(all_dep
-00023ad0: 5f6d 6170 2c20 616c 6c5f 7265 736f 7572  _map, all_resour
-00023ae0: 6365 7329 0a20 2020 206e 6577 5f64 6570  ces).    new_dep
-00023af0: 5f6d 6170 3a20 4469 6374 5b73 7472 2c20  _map: Dict[str, 
-00023b00: 5365 745b 7374 725d 5d20 3d20 7b7d 0a20  Set[str]] = {}. 
-00023b10: 2020 206e 6577 5f74 6f5f 7275 6e20 3d20     new_to_run = 
-00023b20: 6465 6570 636f 7079 2874 6f5f 7275 6e29  deepcopy(to_run)
-00023b30: 0a20 2020 2075 7064 6174 655f 6465 705f  .    update_dep_
-00023b40: 6d61 705f 7265 6375 7273 6976 656c 7928  map_recursively(
-00023b50: 6e65 775f 6465 705f 6d61 702c 2064 6f77  new_dep_map, dow
-00023b60: 6e73 7472 6561 6d5f 6465 705f 6d61 702c  nstream_dep_map,
-00023b70: 2061 6c6c 5f72 6573 6f75 7263 6573 2c20   all_resources, 
-00023b80: 6e65 775f 746f 5f72 756e 2c20 6465 705f  new_to_run, dep_
-00023b90: 6d61 705f 6b65 7973 290a 2020 2020 7265  map_keys).    re
-00023ba0: 7475 726e 206e 6577 5f64 6570 5f6d 6170  turn new_dep_map
-00023bb0: 2c20 6e65 775f 746f 5f72 756e 0a0a 0a40  , new_to_run...@
-00023bc0: 6461 7461 636c 6173 730a 636c 6173 7320  dataclass.class 
-00023bd0: 4772 6170 6844 6570 656e 6465 6e63 6965  GraphDependencie
-00023be0: 733a 0a20 2020 2022 2222 0a20 2020 2054  s:.    """.    T
-00023bf0: 6869 7320 636c 6173 7320 6973 2075 7365  his class is use
-00023c00: 6420 746f 2073 746f 7265 2074 6865 2064  d to store the d
-00023c10: 6570 656e 6465 6e63 6965 7320 6772 6170  ependencies grap
-00023c20: 6820 616e 6420 7468 6520 7265 736f 7572  h and the resour
-00023c30: 6365 7320 7468 6174 2061 7265 2067 6f69  ces that are goi
-00023c40: 6e67 2074 6f20 6265 2064 6570 6c6f 7965  ng to be deploye
-00023c50: 640a 2020 2020 2222 220a 0a20 2020 2064  d.    """..    d
-00023c60: 6570 5f6d 6170 3a20 4469 6374 5b73 7472  ep_map: Dict[str
-00023c70: 2c20 5365 745b 7374 725d 5d0a 2020 2020  , Set[str]].    
-00023c80: 746f 5f72 756e 3a20 4469 6374 5b73 7472  to_run: Dict[str
-00023c90: 2c20 4469 6374 5b73 7472 2c20 416e 795d  , Dict[str, Any]
-00023ca0: 5d0a 0a20 2020 2023 2054 6865 2073 616d  ]..    # The sam
-00023cb0: 6520 6173 2061 626f 7665 2062 7574 2066  e as above but f
-00023cc0: 6f72 2074 6865 2077 686f 6c65 2070 726f  or the whole pro
-00023cd0: 6a65 6374 2c20 6e6f 7420 6a75 7374 2074  ject, not just t
-00023ce0: 6865 2072 6573 6f75 7263 6573 2061 6666  he resources aff
-00023cf0: 6563 7465 6420 6279 2074 6865 2063 7572  ected by the cur
-00023d00: 7265 6e74 2064 6570 6c6f 796d 656e 740a  rent deployment.
-00023d10: 2020 2020 616c 6c5f 6465 705f 6d61 703a      all_dep_map:
-00023d20: 2044 6963 745b 7374 722c 2053 6574 5b73   Dict[str, Set[s
-00023d30: 7472 5d5d 0a20 2020 2061 6c6c 5f72 6573  tr]].    all_res
-00023d40: 6f75 7263 6573 3a20 4469 6374 5b73 7472  ources: Dict[str
-00023d50: 2c20 4469 6374 5b73 7472 2c20 416e 795d  , Dict[str, Any]
-00023d60: 5d0a 0a0a 6173 796e 6320 6465 6620 6275  ]...async def bu
-00023d70: 696c 645f 6772 6170 6828 0a20 2020 2066  ild_graph(.    f
-00023d80: 696c 656e 616d 6573 3a20 4974 6572 6162  ilenames: Iterab
-00023d90: 6c65 5b73 7472 5d2c 0a20 2020 2074 625f  le[str],.    tb_
-00023da0: 636c 6965 6e74 3a20 5469 6e79 422c 0a20  client: TinyB,. 
-00023db0: 2020 2064 6972 5f70 6174 683a 204f 7074     dir_path: Opt
-00023dc0: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00023dd0: 652c 0a20 2020 2072 6573 6f75 7263 655f  e,.    resource_
-00023de0: 7665 7273 696f 6e73 3d4e 6f6e 652c 0a20  versions=None,. 
-00023df0: 2020 2077 6f72 6b73 7061 6365 5f6d 6170     workspace_map
-00023e00: 3a20 4f70 7469 6f6e 616c 5b44 6963 745d  : Optional[Dict]
-00023e10: 203d 204e 6f6e 652c 0a20 2020 2070 726f   = None,.    pro
-00023e20: 6365 7373 5f64 6570 656e 6465 6e63 6965  cess_dependencie
-00023e30: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-00023e40: 0a20 2020 2076 6572 626f 7365 3a20 626f  .    verbose: bo
-00023e50: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-00023e60: 736b 6970 5f63 6f6e 6e65 6374 6f72 733a  skip_connectors:
-00023e70: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00023e80: 2020 2077 6f72 6b73 7061 6365 5f6c 6962     workspace_lib
-00023e90: 5f70 6174 6873 3a20 4f70 7469 6f6e 616c  _paths: Optional
-00023ea0: 5b4c 6973 745b 5475 706c 655b 7374 722c  [List[Tuple[str,
-00023eb0: 2073 7472 5d5d 5d20 3d20 4e6f 6e65 2c0a   str]]] = None,.
-00023ec0: 2020 2020 6375 7272 656e 745f 7773 3a20      current_ws: 
-00023ed0: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
-00023ee0: 722c 2041 6e79 5d5d 203d 204e 6f6e 652c  r, Any]] = None,
-00023ef0: 0a20 2020 2063 6861 6e67 6564 3a20 4f70  .    changed: Op
-00023f00: 7469 6f6e 616c 5b44 6963 745b 7374 722c  tional[Dict[str,
-00023f10: 2041 6e79 5d5d 203d 204e 6f6e 652c 0a20   Any]] = None,. 
-00023f20: 2020 206f 6e6c 795f 6368 616e 6765 733a     only_changes:
-00023f30: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00023f40: 2020 2066 6f72 6b5f 646f 776e 7374 7265     fork_downstre
-00023f50: 616d 3a20 4f70 7469 6f6e 616c 5b62 6f6f  am: Optional[boo
-00023f60: 6c5d 203d 2046 616c 7365 2c0a 2020 2020  l] = False,.    
-00023f70: 6973 5f69 6e74 6572 6e61 6c3a 204f 7074  is_internal: Opt
-00023f80: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4661  ional[bool] = Fa
-00023f90: 6c73 652c 0a29 202d 3e20 4772 6170 6844  lse,.) -> GraphD
-00023fa0: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
-00023fb0: 2022 2222 0a20 2020 2054 6869 7320 6d65   """.    This me
-00023fc0: 7468 6f64 2077 696c 6c20 6765 6e65 7261  thod will genera
-00023fd0: 7465 2061 2064 6570 656e 6465 6e63 7920  te a dependency 
-00023fe0: 6772 6170 6820 666f 7220 7468 6520 6769  graph for the gi
-00023ff0: 7665 6e20 6669 6c65 732e 2049 7420 7769  ven files. It wi
-00024000: 6c6c 2061 6c73 6f20 7265 7475 726e 2061  ll also return a
-00024010: 206d 6170 206f 6620 616c 6c20 7468 6520   map of all the 
-00024020: 7265 736f 7572 6365 7320 7468 6174 2061  resources that a
-00024030: 7265 2067 6f69 6e67 2074 6f20 6265 2064  re going to be d
-00024040: 6570 6c6f 7965 642e 0a20 2020 2042 7920  eployed..    By 
-00024050: 6465 6661 756c 7420 6974 2077 696c 6c20  default it will 
-00024060: 6765 6e65 7261 7465 2074 6865 2067 7261  generate the gra
-00024070: 7068 2066 726f 6d20 6c65 6674 2074 6f20  ph from left to 
-00024080: 7269 6768 742c 2062 7574 2069 6620 666f  right, but if fo
-00024090: 726b 2d64 6f77 6e73 7472 6561 6d2c 2069  rk-downstream, i
-000240a0: 7420 7769 6c6c 2067 656e 6572 6174 6520  t will generate 
-000240b0: 7468 6520 6772 6170 6820 6672 6f6d 2072  the graph from r
-000240c0: 6967 6874 2074 6f20 6c65 6674 2e0a 2020  ight to left..  
-000240d0: 2020 2222 220a 2020 2020 746f 5f72 756e    """.    to_run
-000240e0: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
-000240f0: 203d 207b 7d0a 2020 2020 6465 7073 3a20   = {}.    deps: 
-00024100: 4c69 7374 5b73 7472 5d20 3d20 5b5d 0a20  List[str] = []. 
-00024110: 2020 2064 6570 5f6d 6170 3a20 4469 6374     dep_map: Dict
-00024120: 5b73 7472 2c20 416e 795d 203d 207b 7d0a  [str, Any] = {}.
-00024130: 2020 2020 656d 6265 6464 6564 5f64 6174      embedded_dat
-00024140: 6173 6f75 7263 6573 203d 207b 7d0a 2020  asources = {}.  
-00024150: 2020 6966 206e 6f74 2077 6f72 6b73 7061    if not workspa
-00024160: 6365 5f6d 6170 3a0a 2020 2020 2020 2020  ce_map:.        
-00024170: 776f 726b 7370 6163 655f 6d61 7020 3d20  workspace_map = 
-00024180: 7b7d 0a0a 2020 2020 2320 5468 6573 6520  {}..    # These 
-00024190: 6469 6374 696f 6e61 7269 6573 2061 7265  dictionaries are
-000241a0: 2075 7365 6420 746f 2073 746f 7265 2061   used to store a
-000241b0: 6c6c 2074 6865 2072 6573 6f75 7263 6573  ll the resources
-000241c0: 2061 6e64 2074 6865 7265 2064 6570 656e   and there depen
-000241d0: 6465 6e63 6965 7320 666f 7220 7468 6520  dencies for the 
-000241e0: 7768 6f6c 6520 7072 6f6a 6563 740a 2020  whole project.  
-000241f0: 2020 2320 5468 6973 2069 7320 7573 6564    # This is used
-00024200: 2066 6f72 2074 6865 2064 6f77 6e73 7472   for the downstr
-00024210: 6561 6d20 6465 7065 6e64 656e 6379 2067  eam dependency g
-00024220: 7261 7068 0a20 2020 2061 6c6c 5f64 6570  raph.    all_dep
-00024230: 5f6d 6170 3a20 4469 6374 5b73 7472 2c20  _map: Dict[str, 
-00024240: 5365 745b 7374 725d 5d20 3d20 7b7d 0a20  Set[str]] = {}. 
-00024250: 2020 2061 6c6c 5f72 6573 6f75 7263 6573     all_resources
-00024260: 3a20 4469 6374 5b73 7472 2c20 4469 6374  : Dict[str, Dict
-00024270: 5b73 7472 2c20 416e 795d 5d20 3d20 7b7d  [str, Any]] = {}
-00024280: 0a0a 2020 2020 6966 2064 6972 5f70 6174  ..    if dir_pat
-00024290: 6820 6973 204e 6f6e 653a 0a20 2020 2020  h is None:.     
-000242a0: 2020 2064 6972 5f70 6174 6820 3d20 6f73     dir_path = os
-000242b0: 2e67 6574 6377 6428 290a 0a20 2020 2023  .getcwd()..    #
-000242c0: 2057 6865 6e20 7573 696e 6720 666f 726b   When using fork
-000242d0: 2d64 6f77 6e73 7472 6561 6d20 6f72 202d  -downstream or -
-000242e0: 2d6f 6e6c 792d 6368 616e 6765 732c 2077  -only-changes, w
-000242f0: 6520 6e65 6564 2074 6f20 6765 6e65 7261  e need to genera
-00024300: 7465 2061 6c6c 2074 6865 2067 7261 7068  te all the graph
-00024310: 206f 6620 616c 6c20 7468 6520 7265 736f   of all the reso
-00024320: 7572 6365 7320 616e 6420 7468 6569 7220  urces and their 
-00024330: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
-00024340: 2023 2054 6869 7320 7761 7920 7765 2063   # This way we c
-00024350: 616e 2061 6464 206d 6f72 6520 7265 736f  an add more reso
-00024360: 7572 6365 7320 696e 746f 2074 6865 2074  urces into the t
-00024370: 6f5f 7275 6e20 6469 6374 696f 6e61 7279  o_run dictionary
-00024380: 2069 6620 6e65 6564 6564 2e0a 2020 2020   if needed..    
-00024390: 6966 2070 726f 6365 7373 5f64 6570 656e  if process_depen
-000243a0: 6465 6e63 6965 7320 616e 6420 6f6e 6c79  dencies and only
-000243b0: 5f63 6861 6e67 6573 3a0a 2020 2020 2020  _changes:.      
-000243c0: 2020 616c 6c5f 6465 7065 6e64 656e 6369    all_dependenci
-000243d0: 6573 5f67 7261 7068 203d 2061 7761 6974  es_graph = await
-000243e0: 2062 7569 6c64 5f67 7261 7068 280a 2020   build_graph(.  
-000243f0: 2020 2020 2020 2020 2020 6765 745f 7072            get_pr
-00024400: 6f6a 6563 745f 6669 6c65 6e61 6d65 7328  oject_filenames(
-00024410: 6469 725f 7061 7468 292c 0a20 2020 2020  dir_path),.     
-00024420: 2020 2020 2020 2074 625f 636c 6965 6e74         tb_client
-00024430: 2c0a 2020 2020 2020 2020 2020 2020 6469  ,.            di
-00024440: 725f 7061 7468 3d64 6972 5f70 6174 682c  r_path=dir_path,
-00024450: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-00024460: 6365 7373 5f64 6570 656e 6465 6e63 6965  cess_dependencie
-00024470: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-00024480: 2020 2020 7265 736f 7572 6365 5f76 6572      resource_ver
-00024490: 7369 6f6e 733d 7265 736f 7572 6365 5f76  sions=resource_v
-000244a0: 6572 7369 6f6e 732c 0a20 2020 2020 2020  ersions,.       
-000244b0: 2020 2020 2077 6f72 6b73 7061 6365 5f6d       workspace_m
-000244c0: 6170 3d77 6f72 6b73 7061 6365 5f6d 6170  ap=workspace_map
-000244d0: 2c0a 2020 2020 2020 2020 2020 2020 736b  ,.            sk
-000244e0: 6970 5f63 6f6e 6e65 6374 6f72 733d 5472  ip_connectors=Tr
-000244f0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-00024500: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
-00024510: 7468 733d 776f 726b 7370 6163 655f 6c69  ths=workspace_li
-00024520: 625f 7061 7468 732c 0a20 2020 2020 2020  b_paths,.       
-00024530: 2020 2020 2063 7572 7265 6e74 5f77 733d       current_ws=
-00024540: 6375 7272 656e 745f 7773 2c0a 2020 2020  current_ws,.    
-00024550: 2020 2020 2020 2020 6368 616e 6765 643d          changed=
-00024560: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00024570: 2020 6f6e 6c79 5f63 6861 6e67 6573 3d46    only_changes=F
-00024580: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00024590: 2020 6973 5f69 6e74 6572 6e61 6c3d 6973    is_internal=is
-000245a0: 5f69 6e74 6572 6e61 6c2c 0a20 2020 2020  _internal,.     
-000245b0: 2020 2029 0a20 2020 2020 2020 2061 6c6c     ).        all
-000245c0: 5f64 6570 5f6d 6170 203d 2061 6c6c 5f64  _dep_map = all_d
-000245d0: 6570 656e 6465 6e63 6965 735f 6772 6170  ependencies_grap
-000245e0: 682e 6465 705f 6d61 700a 2020 2020 2020  h.dep_map.      
-000245f0: 2020 616c 6c5f 7265 736f 7572 6365 7320    all_resources 
-00024600: 3d20 616c 6c5f 6465 7065 6e64 656e 6369  = all_dependenci
-00024610: 6573 5f67 7261 7068 2e74 6f5f 7275 6e0a  es_graph.to_run.
-00024620: 0a20 2020 2061 7379 6e63 2064 6566 2070  .    async def p
-00024630: 726f 6365 7373 280a 2020 2020 2020 2020  rocess(.        
-00024640: 6669 6c65 6e61 6d65 3a20 7374 722c 0a20  filename: str,. 
-00024650: 2020 2020 2020 2064 6570 733a 204c 6973         deps: Lis
-00024660: 745b 7374 725d 2c0a 2020 2020 2020 2020  t[str],.        
-00024670: 6465 705f 6d61 703a 2044 6963 745b 7374  dep_map: Dict[st
-00024680: 722c 2041 6e79 5d2c 0a20 2020 2020 2020  r, Any],.       
-00024690: 2074 6f5f 7275 6e3a 2044 6963 745b 7374   to_run: Dict[st
-000246a0: 722c 2041 6e79 5d2c 0a20 2020 2020 2020  r, Any],.       
-000246b0: 2077 6f72 6b73 7061 6365 5f6c 6962 5f70   workspace_lib_p
-000246c0: 6174 6873 3a20 4f70 7469 6f6e 616c 5b4c  aths: Optional[L
-000246d0: 6973 745b 5475 706c 655b 7374 722c 2073  ist[Tuple[str, s
-000246e0: 7472 5d5d 5d2c 0a20 2020 2029 3a0a 2020  tr]]],.    ):.  
-000246f0: 2020 2020 2020 6e61 6d65 2c20 6b69 6e64        name, kind
-00024700: 203d 2066 696c 656e 616d 652e 7273 706c   = filename.rspl
-00024710: 6974 2822 2e22 2c20 3129 0a0a 2020 2020  it(".", 1)..    
-00024720: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00024730: 2020 2020 2072 6573 203d 2061 7761 6974       res = await
-00024740: 2070 726f 6365 7373 5f66 696c 6528 0a20   process_file(. 
-00024750: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00024760: 696c 656e 616d 652c 0a20 2020 2020 2020  ilename,.       
-00024770: 2020 2020 2020 2020 2074 625f 636c 6965           tb_clie
-00024780: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-00024790: 2020 2020 7265 736f 7572 6365 5f76 6572      resource_ver
-000247a0: 7369 6f6e 733d 7265 736f 7572 6365 5f76  sions=resource_v
-000247b0: 6572 7369 6f6e 732c 0a20 2020 2020 2020  ersions,.       
-000247c0: 2020 2020 2020 2020 2073 6b69 705f 636f           skip_co
-000247d0: 6e6e 6563 746f 7273 3d73 6b69 705f 636f  nnectors=skip_co
-000247e0: 6e6e 6563 746f 7273 2c0a 2020 2020 2020  nnectors,.      
-000247f0: 2020 2020 2020 2020 2020 776f 726b 7370            worksp
-00024800: 6163 655f 6d61 703d 776f 726b 7370 6163  ace_map=workspac
-00024810: 655f 6d61 702c 0a20 2020 2020 2020 2020  e_map,.         
-00024820: 2020 2020 2020 2077 6f72 6b73 7061 6365         workspace
-00024830: 5f6c 6962 5f70 6174 6873 3d77 6f72 6b73  _lib_paths=works
-00024840: 7061 6365 5f6c 6962 5f70 6174 6873 2c0a  pace_lib_paths,.
-00024850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024860: 6375 7272 656e 745f 7773 3d63 7572 7265  current_ws=curre
-00024870: 6e74 5f77 732c 0a20 2020 2020 2020 2020  nt_ws,.         
-00024880: 2020 2029 0a20 2020 2020 2020 2065 7863     ).        exc
-00024890: 6570 7420 636c 6963 6b2e 436c 6963 6b45  ept click.ClickE
-000248a0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-000248b0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000248c0: 2065 0a20 2020 2020 2020 2065 7863 6570   e.        excep
-000248d0: 7420 496e 636c 7564 6546 696c 654e 6f74  t IncludeFileNot
-000248e0: 466f 756e 6445 7863 6570 7469 6f6e 2061  FoundException a
-000248f0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00024900: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
-00024910: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
-00024920: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
-00024930: 725f 6465 6c65 7465 645f 696e 636c 7564  r_deleted_includ
-00024940: 6528 696e 636c 7564 655f 6669 6c65 3d73  e(include_file=s
-00024950: 7472 2865 292c 2066 696c 656e 616d 653d  tr(e), filename=
-00024960: 6669 6c65 6e61 6d65 2929 0a20 2020 2020  filename)).     
-00024970: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00024980: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00024990: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
-000249a0: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
-000249b0: 2873 7472 2865 2929 0a0a 2020 2020 2020  (str(e))..      
-000249c0: 2020 666f 7220 7220 696e 2072 6573 3a0a    for r in res:.
-000249d0: 2020 2020 2020 2020 2020 2020 666e 203d              fn =
-000249e0: 2072 5b22 7265 736f 7572 6365 5f6e 616d   r["resource_nam
-000249f0: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
-00024a00: 6966 2063 6861 6e67 6564 2061 6e64 2066  if changed and f
-00024a10: 6e20 696e 2063 6861 6e67 6564 2061 6e64  n in changed and
-00024a20: 2028 6e6f 7420 6368 616e 6765 645b 666e   (not changed[fn
-00024a30: 5d20 6f72 2063 6861 6e67 6564 5b66 6e5d  ] or changed[fn]
-00024a40: 2069 6e20 5b22 7368 6172 6564 222c 2022   in ["shared", "
-00024a50: 7265 6d6f 7465 225d 293a 0a20 2020 2020  remote"]):.     
-00024a60: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00024a70: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-00024a80: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
-00024a90: 2020 2020 2020 666f 726b 5f64 6f77 6e73        fork_downs
-00024aa0: 7472 6561 6d0a 2020 2020 2020 2020 2020  tream.          
-00024ab0: 2020 2020 2020 616e 6420 722e 6765 7428        and r.get(
-00024ac0: 2272 6573 6f75 7263 6522 2c20 2222 2920  "resource", "") 
-00024ad0: 3d3d 2022 7069 7065 7322 0a20 2020 2020  == "pipes".     
-00024ae0: 2020 2020 2020 2020 2020 2061 6e64 2061             and a
-00024af0: 6e79 285b 2265 6e67 696e 6522 2069 6e20  ny(["engine" in 
-00024b00: 782e 6765 7428 2270 6172 616d 7322 2c20  x.get("params", 
-00024b10: 7b7d 2920 666f 7220 7820 696e 2072 2e67  {}) for x in r.g
-00024b20: 6574 2822 6e6f 6465 7322 2c20 5b5d 295d  et("nodes", [])]
-00024b30: 290a 2020 2020 2020 2020 2020 2020 293a  ).            ):
-00024b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024b50: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
-00024b60: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
-00024b70: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
-00024b80: 725f 666f 726b 646f 776e 7374 7265 616d  r_forkdownstream
-00024b90: 5f70 6970 6573 5f77 6974 685f 656e 6769  _pipes_with_engi
-00024ba0: 6e65 2870 6970 653d 666e 2929 0a0a 2020  ne(pipe=fn))..  
-00024bb0: 2020 2020 2020 2020 2020 746f 5f72 756e            to_run
-00024bc0: 5b66 6e5d 203d 2072 0a20 2020 2020 2020  [fn] = r.       
-00024bd0: 2020 2020 2066 696c 655f 6465 7073 203d       file_deps =
-00024be0: 2072 2e67 6574 2822 6465 7073 222c 205b   r.get("deps", [
-00024bf0: 5d29 0a20 2020 2020 2020 2020 2020 2064  ]).            d
-00024c00: 6570 7320 2b3d 2066 696c 655f 6465 7073  eps += file_deps
-00024c10: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-00024c20: 616c 6375 6c61 7465 2061 6e64 206c 6f6f  alculate and loo
-00024c30: 6b20 666f 7220 6465 7073 0a20 2020 2020  k for deps.     
-00024c40: 2020 2020 2020 2064 6570 5f6c 6973 7420         dep_list 
-00024c50: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00024c60: 2066 6f72 2078 2069 6e20 6669 6c65 5f64   for x in file_d
-00024c70: 6570 733a 0a20 2020 2020 2020 2020 2020  eps:.           
-00024c80: 2020 2020 2069 6620 7820 6e6f 7420 696e       if x not in
-00024c90: 2049 4e54 4552 4e41 4c5f 5441 424c 4553   INTERNAL_TABLES
-00024ca0: 206f 7220 6973 5f69 6e74 6572 6e61 6c3a   or is_internal:
-00024cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024cc0: 2020 2020 2066 2c20 6473 203d 2066 696e       f, ds = fin
-00024cd0: 645f 6669 6c65 5f62 795f 6e61 6d65 2864  d_file_by_name(d
-00024ce0: 6972 5f70 6174 682c 2078 2c20 7665 7262  ir_path, x, verb
-00024cf0: 6f73 652c 2077 6f72 6b73 7061 6365 5f6c  ose, workspace_l
-00024d00: 6962 5f70 6174 6873 3d77 6f72 6b73 7061  ib_paths=workspa
-00024d10: 6365 5f6c 6962 5f70 6174 6873 2c20 7265  ce_lib_paths, re
-00024d20: 736f 7572 6365 3d72 290a 2020 2020 2020  source=r).      
-00024d30: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00024d40: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
-00024d50: 2020 2020 2020 2020 2020 2020 6465 705f              dep_
-00024d60: 6c69 7374 2e61 7070 656e 6428 662e 7273  list.append(f.rs
-00024d70: 706c 6974 2822 2e22 2c20 3129 5b30 5d29  plit(".", 1)[0])
-00024d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024d90: 2020 2020 2069 6620 6473 3a0a 2020 2020       if ds:.    
-00024da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024db0: 2020 2020 6473 5f66 6e20 3d20 6473 5b22      ds_fn = ds["
-00024dc0: 7265 736f 7572 6365 5f6e 616d 6522 5d0a  resource_name"].
-00024dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024de0: 2020 2020 2020 2020 7072 6576 203d 2074          prev = t
-00024df0: 6f5f 7275 6e2e 6765 7428 6473 5f66 6e2c  o_run.get(ds_fn,
-00024e00: 207b 7d29 0a20 2020 2020 2020 2020 2020   {}).           
-00024e10: 2020 2020 2020 2020 2020 2020 2074 6f5f               to_
-00024e20: 7275 6e5b 6473 5f66 6e5d 203d 2064 6565  run[ds_fn] = dee
-00024e30: 7063 6f70 7928 7229 0a20 2020 2020 2020  pcopy(r).       
-00024e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024e50: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00024e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024e70: 2020 746f 5f72 756e 5b64 735f 666e 5d5b    to_run[ds_fn][
-00024e80: 2264 6570 7322 5d20 3d20 6c69 7374 280a  "deps"] = list(.
-00024e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024eb0: 7365 7428 746f 5f72 756e 5b64 735f 666e  set(to_run[ds_fn
-00024ec0: 5d2e 6765 7428 2264 6570 7322 2c20 5b5d  ].get("deps", []
-00024ed0: 2920 2b20 7072 6576 2e67 6574 2822 6465  ) + prev.get("de
-00024ee0: 7073 222c 205b 5d29 202b 205b 666e 5d29  ps", []) + [fn])
-00024ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024f00: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0001e230: 616e 6420 7061 7261 6d73 2e67 6574 2822  and params.get("
+0001e240: 636f 6e6e 6563 746f 7222 290a 2020 2020  connector").    
+0001e250: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+0001e260: 7061 7261 6d73 2e67 6574 2822 6275 636b  params.get("buck
+0001e270: 6574 5f75 7269 2229 0a20 2020 2020 2020  et_uri").       
+0001e280: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+0001e290: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
+0001e2a0: 7761 6974 2063 6c69 656e 742e 7072 6576  wait client.prev
+0001e2b0: 6965 775f 6275 636b 6574 2870 6172 616d  iew_bucket(param
+0001e2c0: 735b 2263 6f6e 6e65 6374 6f72 225d 2c20  s["connector"], 
+0001e2d0: 7061 7261 6d73 5b22 6275 636b 6574 5f75  params["bucket_u
+0001e2e0: 7269 225d 290a 2020 2020 2020 2020 2020  ri"]).          
+0001e2f0: 2020 2020 2020 6966 2064 6174 613a 0a20        if data:. 
+0001e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e310: 2020 2066 696c 6573 203d 2064 6174 612e     files = data.
+0001e320: 6765 7428 2266 696c 6573 222c 205b 5d29  get("files", [])
+0001e330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e340: 2020 2020 2069 6620 6c65 6e28 6669 6c65       if len(file
+0001e350: 7329 203e 2030 3a0a 2020 2020 2020 2020  s) > 0:.        
+0001e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e370: 6669 6c65 5f6e 616d 6520 3d20 6669 6c65  file_name = file
+0001e380: 735b 305d 2e67 6574 2822 6e61 6d65 222c  s[0].get("name",
+0001e390: 2022 2229 0a20 2020 2020 2020 2020 2020   "").           
+0001e3a0: 2020 2020 2020 2020 2020 2020 2065 7874               ext
+0001e3b0: 656e 7369 6f6e 203d 2066 696c 655f 6e61  ension = file_na
+0001e3c0: 6d65 2e73 706c 6974 2822 2e22 295b 2d31  me.split(".")[-1
+0001e3d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0001e3e0: 2020 2020 2020 2020 2020 7661 6c69 645f            valid_
+0001e3f0: 666f 726d 6174 7320 3d20 5b22 6373 7622  formats = ["csv"
+0001e400: 2c20 226e 646a 736f 6e22 2c20 2270 6172  , "ndjson", "par
+0001e410: 7175 6574 225d 0a20 2020 2020 2020 2020  quet"].         
+0001e420: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001e430: 6620 6578 7465 6e73 696f 6e20 6e6f 7420  f extension not 
+0001e440: 696e 2076 616c 6964 5f66 6f72 6d61 7473  in valid_formats
+0001e450: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e460: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0001e470: 6973 6520 4578 6365 7074 696f 6e28 0a20  ise Exception(. 
+0001e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e490: 2020 2020 2020 2020 2020 2020 2020 2046                 F
+0001e4a0: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
+0001e4b0: 7272 6f72 5f66 6f72 6d61 7428 6578 7465  rror_format(exte
+0001e4c0: 6e73 696f 6e3d 6578 7465 6e73 696f 6e2c  nsion=extension,
+0001e4d0: 2076 616c 6964 5f66 6f72 6d61 7473 3d76   valid_formats=v
+0001e4e0: 616c 6964 5f66 6f72 6d61 7473 290a 2020  alid_formats).  
+0001e4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e500: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e520: 2020 2020 7061 7261 6d73 5b22 666f 726d      params["form
+0001e530: 6174 225d 203d 2065 7874 656e 7369 6f6e  at"] = extension
+0001e540: 0a0a 2020 2020 2020 2020 2020 2020 6461  ..            da
+0001e550: 7461 736f 7572 6365 203d 2028 6177 6169  tasource = (awai
+0001e560: 7420 636c 6965 6e74 2e64 6174 6173 6f75  t client.datasou
+0001e570: 7263 655f 6372 6561 7465 5f66 726f 6d5f  rce_create_from_
+0001e580: 6465 6669 6e69 7469 6f6e 2870 6172 616d  definition(param
+0001e590: 7329 292e 6765 7428 2264 6174 6173 6f75  s)).get("datasou
+0001e5a0: 7263 6522 2c20 7b7d 290a 2020 2020 2020  rce", {}).      
+0001e5b0: 2020 2020 2020 6966 2022 746f 6b65 6e73        if "tokens
+0001e5c0: 2220 696e 2064 7320 616e 6420 6473 5b22  " in ds and ds["
+0001e5d0: 746f 6b65 6e73 225d 3a0a 2020 2020 2020  tokens"]:.      
+0001e5e0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0001e5f0: 6d61 6e61 6765 5f74 6f6b 656e 7328 290a  manage_tokens().
+0001e600: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001e610: 2273 6861 7265 645f 7769 7468 2220 696e  "shared_with" in
+0001e620: 2064 7320 616e 6420 6473 5b22 7368 6172   ds and ds["shar
+0001e630: 6564 5f77 6974 6822 5d3a 0a20 2020 2020  ed_with"]:.     
+0001e640: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0001e650: 7420 7573 6572 5f74 6f6b 656e 3a0a 2020  t user_token:.  
+0001e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e670: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
+0001e680: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
+0001e690: 6f5f 736b 6970 7069 6e67 5f73 6861 7265  o_skipping_share
+0001e6a0: 645f 7769 7468 5f65 6e74 7279 2829 290a  d_with_entry()).
+0001e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e6c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001e6d0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0001e6e0: 7368 6172 655f 616e 645f 756e 7368 6172  share_and_unshar
+0001e6f0: 655f 6461 7461 736f 7572 6365 280a 2020  e_datasource(.  
+0001e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e710: 2020 2020 2020 636c 6965 6e74 2c0a 2020        client,.  
+0001e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e730: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
+0001e740: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001e750: 2020 2020 2020 2020 2020 7573 6572 5f74            user_t
+0001e760: 6f6b 656e 2c0a 2020 2020 2020 2020 2020  oken,.          
+0001e770: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+0001e780: 726b 7370 6163 6573 5f63 7572 7265 6e74  rkspaces_current
+0001e790: 5f73 6861 7265 645f 7769 7468 3d5b 5d2c  _shared_with=[],
+0001e7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e7b0: 2020 2020 2020 2020 2077 6f72 6b73 7061           workspa
+0001e7c0: 6365 735f 746f 5f73 6861 7265 3d64 735b  ces_to_share=ds[
+0001e7d0: 2273 6861 7265 645f 7769 7468 225d 2c0a  "shared_with"],.
+0001e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e7f0: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+0001e800: 7773 3d63 7572 7265 6e74 5f77 732c 0a20  ws=current_ws,. 
+0001e810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e820: 2020 2029 0a0a 2020 2020 2020 2020 6578     )..        ex
+0001e830: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0001e840: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0001e850: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+0001e860: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
+0001e870: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+0001e880: 725f 6372 6561 7469 6e67 5f64 6174 6173  r_creating_datas
+0001e890: 6f75 7263 6528 6572 726f 723d 7374 7228  ource(error=str(
+0001e8a0: 6529 2929 0a20 2020 2020 2020 2072 6574  e))).        ret
+0001e8b0: 7572 6e0a 0a20 2020 2069 6620 6e6f 7420  urn..    if not 
+0001e8c0: 666f 7263 653a 0a20 2020 2020 2020 2072  force:.        r
+0001e8d0: 6169 7365 2063 6c69 636b 2e43 6c69 636b  aise click.Click
+0001e8e0: 4578 6365 7074 696f 6e28 4665 6564 6261  Exception(Feedba
+0001e8f0: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+0001e900: 6461 7461 736f 7572 6365 5f61 6c72 6561  datasource_alrea
+0001e910: 6479 5f65 7869 7374 7328 6461 7461 736f  dy_exists(dataso
+0001e920: 7572 6365 3d64 735f 6e61 6d65 2929 0a0a  urce=ds_name))..
+0001e930: 2020 2020 6966 2064 732e 6765 7428 2273      if ds.get("s
+0001e940: 6861 7265 645f 7769 7468 222c 205b 5d29  hared_with", [])
+0001e950: 206f 7220 6578 6973 7469 6e67 5f64 732e   or existing_ds.
+0001e960: 6765 7428 2273 6861 7265 645f 7769 7468  get("shared_with
+0001e970: 222c 205b 5d29 3a0a 2020 2020 2020 2020  ", []):.        
+0001e980: 6966 206e 6f74 2075 7365 725f 746f 6b65  if not user_toke
+0001e990: 6e3a 0a20 2020 2020 2020 2020 2020 2063  n:.            c
+0001e9a0: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
+0001e9b0: 636b 4d61 6e61 6765 722e 696e 666f 5f73  ckManager.info_s
+0001e9c0: 6b69 7070 696e 675f 7368 6172 6564 5f77  kipping_shared_w
+0001e9d0: 6974 685f 656e 7472 7928 2929 0a20 2020  ith_entry()).   
+0001e9e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001e9f0: 2020 2020 2020 2061 7761 6974 2073 6861         await sha
+0001ea00: 7265 5f61 6e64 5f75 6e73 6861 7265 5f64  re_and_unshare_d
+0001ea10: 6174 6173 6f75 7263 6528 0a20 2020 2020  atasource(.     
+0001ea20: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0001ea30: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0001ea40: 2020 2065 7869 7374 696e 675f 6473 2c0a     existing_ds,.
+0001ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea60: 7573 6572 5f74 6f6b 656e 2c0a 2020 2020  user_token,.    
+0001ea70: 2020 2020 2020 2020 2020 2020 6578 6973              exis
+0001ea80: 7469 6e67 5f64 732e 6765 7428 2273 6861  ting_ds.get("sha
+0001ea90: 7265 645f 7769 7468 222c 205b 5d29 2c0a  red_with", []),.
+0001eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eab0: 6473 2e67 6574 2822 7368 6172 6564 5f77  ds.get("shared_w
+0001eac0: 6974 6822 2c20 5b5d 292c 0a20 2020 2020  ith", []),.     
+0001ead0: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+0001eae0: 6e74 5f77 732c 0a20 2020 2020 2020 2020  nt_ws,.         
+0001eaf0: 2020 2029 0a0a 2020 2020 616c 7465 725f     )..    alter_
+0001eb00: 7265 7370 6f6e 7365 203d 204e 6f6e 650a  response = None.
+0001eb10: 2020 2020 616c 7465 725f 6572 726f 725f      alter_error_
+0001eb20: 6d65 7373 6167 6520 3d20 4e6f 6e65 0a20  message = None. 
+0001eb30: 2020 206e 6577 5f64 6573 6372 6970 7469     new_descripti
+0001eb40: 6f6e 203d 204e 6f6e 650a 2020 2020 6e65  on = None.    ne
+0001eb50: 775f 7363 6865 6d61 203d 204e 6f6e 650a  w_schema = None.
+0001eb60: 2020 2020 6e65 775f 696e 6469 6365 7320      new_indices 
+0001eb70: 3d20 4e6f 6e65 0a20 2020 206e 6577 5f74  = None.    new_t
+0001eb80: 746c 203d 204e 6f6e 650a 0a20 2020 2074  tl = None..    t
+0001eb90: 7279 3a0a 2020 2020 2020 2020 6966 2064  ry:.        if d
+0001eba0: 6174 6173 6f75 7263 655f 6578 6973 7473  atasource_exists
+0001ebb0: 2061 6e64 2064 735b 2270 6172 616d 7322   and ds["params"
+0001ebc0: 5d5b 2264 6573 6372 6970 7469 6f6e 225d  ]["description"]
+0001ebd0: 2021 3d20 6578 6973 7469 6e67 5f64 735b   != existing_ds[
+0001ebe0: 2264 6573 6372 6970 7469 6f6e 225d 3a0a  "description"]:.
+0001ebf0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+0001ec00: 6465 7363 7269 7074 696f 6e20 3d20 6473  description = ds
+0001ec10: 5b22 7061 7261 6d73 225d 5b22 6465 7363  ["params"]["desc
+0001ec20: 7269 7074 696f 6e22 5d0a 0a20 2020 2020  ription"]..     
+0001ec30: 2020 2069 6620 6461 7461 736f 7572 6365     if datasource
+0001ec40: 5f65 7869 7374 7320 616e 6420 6473 5b22  _exists and ds["
+0001ec50: 7061 7261 6d73 225d 2e67 6574 2822 656e  params"].get("en
+0001ec60: 6769 6e65 5f74 746c 2229 2021 3d20 6578  gine_ttl") != ex
+0001ec70: 6973 7469 6e67 5f64 735b 2265 6e67 696e  isting_ds["engin
+0001ec80: 6522 5d2e 6765 7428 2274 746c 2229 3a0a  e"].get("ttl"):.
+0001ec90: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+0001eca0: 7474 6c20 3d20 6473 5b22 7061 7261 6d73  ttl = ds["params
+0001ecb0: 225d 2e67 6574 2822 656e 6769 6e65 5f74  "].get("engine_t
+0001ecc0: 746c 222c 2022 6661 6c73 6522 290a 0a20  tl", "false").. 
+0001ecd0: 2020 2020 2020 2023 2053 6368 656d 6120         # Schema 
+0001ece0: 6669 7865 6420 6279 2074 6865 206b 6166  fixed by the kaf
+0001ecf0: 6b61 2063 6f6e 6e65 6374 6f72 0a20 2020  ka connector.   
+0001ed00: 2020 2020 2069 6620 6461 7461 736f 7572       if datasour
+0001ed10: 6365 5f65 7869 7374 7320 616e 6420 280a  ce_exists and (.
+0001ed20: 2020 2020 2020 2020 2020 2020 6473 5b22              ds["
+0001ed30: 7061 7261 6d73 225d 5b22 7363 6865 6d61  params"]["schema
+0001ed40: 225d 2e72 6570 6c61 6365 2822 2022 2c20  "].replace(" ", 
+0001ed50: 2222 2920 213d 2065 7869 7374 696e 675f  "") != existing_
+0001ed60: 6473 5b22 7363 6865 6d61 225d 5b22 7371  ds["schema"]["sq
+0001ed70: 6c5f 7363 6865 6d61 225d 2e72 6570 6c61  l_schema"].repla
+0001ed80: 6365 2822 2022 2c20 2222 290a 2020 2020  ce(" ", "").    
+0001ed90: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+0001eda0: 2020 206e 6577 5f73 6368 656d 6120 3d20     new_schema = 
+0001edb0: 6473 5b22 7061 7261 6d73 225d 5b22 7363  ds["params"]["sc
+0001edc0: 6865 6d61 225d 0a0a 2020 2020 2020 2020  hema"]..        
+0001edd0: 6966 2064 6174 6173 6f75 7263 655f 6578  if datasource_ex
+0001ede0: 6973 7473 3a0a 2020 2020 2020 2020 2020  ists:.          
+0001edf0: 2020 6e65 7720 3d20 5b61 7364 6963 7428    new = [asdict(
+0001ee00: 696e 6465 7829 2066 6f72 2069 6e64 6578  index) for index
+0001ee10: 2069 6e20 6473 2e67 6574 2822 7061 7261   in ds.get("para
+0001ee20: 6d73 222c 207b 7d29 2e67 6574 2822 696e  ms", {}).get("in
+0001ee30: 6465 7865 735f 6c69 7374 222c 205b 5d29  dexes_list", [])
+0001ee40: 5d0a 2020 2020 2020 2020 2020 2020 6578  ].            ex
+0001ee50: 6973 7469 6e67 203d 2065 7869 7374 696e  isting = existin
+0001ee60: 675f 6473 2e67 6574 2822 696e 6465 7865  g_ds.get("indexe
+0001ee70: 7322 2c20 5b5d 290a 2020 2020 2020 2020  s", []).        
+0001ee80: 2020 2020 6e65 772e 736f 7274 286b 6579      new.sort(key
+0001ee90: 3d6c 616d 6264 6120 783a 2078 5b22 6e61  =lambda x: x["na
+0001eea0: 6d65 225d 290a 2020 2020 2020 2020 2020  me"]).          
+0001eeb0: 2020 6578 6973 7469 6e67 2e73 6f72 7428    existing.sort(
+0001eec0: 6b65 793d 6c61 6d62 6461 2078 3a20 785b  key=lambda x: x[
+0001eed0: 226e 616d 6522 5d29 0a20 2020 2020 2020  "name"]).       
+0001eee0: 2020 2020 2069 6620 6c65 6e28 6578 6973       if len(exis
+0001eef0: 7469 6e67 2920 213d 206c 656e 286e 6577  ting) != len(new
+0001ef00: 2920 6f72 2061 6e79 285b 2864 2c20 6432  ) or any([(d, d2
+0001ef10: 2920 666f 7220 642c 2064 3220 696e 207a  ) for d, d2 in z
+0001ef20: 6970 286e 6577 2c20 6578 6973 7469 6e67  ip(new, existing
+0001ef30: 2920 6966 2064 2021 3d20 6432 5d29 3a0a  ) if d != d2]):.
+0001ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef50: 6e65 775f 696e 6469 6365 7320 3d20 6473  new_indices = ds
+0001ef60: 2e67 6574 2822 7061 7261 6d73 222c 207b  .get("params", {
+0001ef70: 7d29 2e67 6574 2822 696e 6465 7865 7322  }).get("indexes"
+0001ef80: 2920 6f72 2022 3022 0a20 2020 2020 2020  ) or "0".       
+0001ef90: 2069 6620 6e65 775f 6465 7363 7269 7074   if new_descript
+0001efa0: 696f 6e20 6f72 206e 6577 5f73 6368 656d  ion or new_schem
+0001efb0: 6120 6f72 206e 6577 5f74 746c 206f 7220  a or new_ttl or 
+0001efc0: 286e 6577 5f69 6e64 6963 6573 2069 7320  (new_indices is 
+0001efd0: 6e6f 7420 4e6f 6e65 2920 616e 6420 286e  not None) and (n
+0001efe0: 6f74 2066 6f72 6b5f 646f 776e 7374 7265  ot fork_downstre
+0001eff0: 616d 206f 7220 6e6f 7420 666f 726b 293a  am or not fork):
+0001f000: 0a20 2020 2020 2020 2020 2020 2061 6c74  .            alt
+0001f010: 6572 5f72 6573 706f 6e73 6520 3d20 6177  er_response = aw
+0001f020: 6169 7420 636c 6965 6e74 2e61 6c74 6572  ait client.alter
+0001f030: 5f64 6174 6173 6f75 7263 6528 0a20 2020  _datasource(.   
+0001f040: 2020 2020 2020 2020 2020 2020 2064 735f               ds_
+0001f050: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0001f060: 2020 2020 2020 6e65 775f 7363 6865 6d61        new_schema
+0001f070: 3d6e 6577 5f73 6368 656d 612c 0a20 2020  =new_schema,.   
+0001f080: 2020 2020 2020 2020 2020 2020 2064 6573               des
+0001f090: 6372 6970 7469 6f6e 3d6e 6577 5f64 6573  cription=new_des
+0001f0a0: 6372 6970 7469 6f6e 2c0a 2020 2020 2020  cription,.      
+0001f0b0: 2020 2020 2020 2020 2020 7474 6c3d 6e65            ttl=ne
+0001f0c0: 775f 7474 6c2c 0a20 2020 2020 2020 2020  w_ttl,.         
+0001f0d0: 2020 2020 2020 2064 7279 5f72 756e 3d54         dry_run=T
+0001f0e0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0001f0f0: 2020 2020 2069 6e64 6578 6573 3d6e 6577       indexes=new
+0001f100: 5f69 6e64 6963 6573 2c0a 2020 2020 2020  _indices,.      
+0001f110: 2020 2020 2020 290a 2020 2020 6578 6365        ).    exce
+0001f120: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+0001f130: 653a 0a20 2020 2020 2020 2069 6620 2254  e:.        if "T
+0001f140: 6865 7265 2077 6572 6520 6e6f 206f 7065  here were no ope
+0001f150: 7261 7469 6f6e 7320 746f 2070 6572 666f  rations to perfo
+0001f160: 726d 2220 696e 2073 7472 2865 293a 0a20  rm" in str(e):. 
+0001f170: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+0001f180: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001f190: 2020 2020 2020 2020 2020 616c 7465 725f            alter_
+0001f1a0: 6572 726f 725f 6d65 7373 6167 6520 3d20  error_message = 
+0001f1b0: 7374 7228 6529 0a0a 2020 2020 6966 2061  str(e)..    if a
+0001f1c0: 6c74 6572 5f72 6573 706f 6e73 653a 0a20  lter_response:. 
+0001f1d0: 2020 2020 2020 2069 6620 6769 745f 7265         if git_re
+0001f1e0: 6c65 6173 6520 616e 6420 6e6f 7420 736b  lease and not sk
+0001f1f0: 6970 5f63 6f6e 6669 726d 6174 696f 6e3a  ip_confirmation:
+0001f200: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+0001f210: 636b 2e65 6368 6f28 4665 6564 6261 636b  ck.echo(Feedback
+0001f220: 4d61 6e61 6765 722e 696e 666f 5f63 7573  Manager.info_cus
+0001f230: 746f 6d5f 6465 706c 6f79 6d65 6e74 2829  tom_deployment()
+0001f240: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
+0001f250: 6963 6b2e 6563 686f 2822 2a2a 2a2a 2a2a  ick.echo("******
+0001f260: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
+0001f270: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
+0001f280: 2a22 290a 2020 2020 2020 2020 2020 2020  *").            
+0001f290: 636c 6963 6b2e 6563 686f 2822 2a2a 2a2a  click.echo("****
+0001f2a0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
+0001f2b0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
+0001f2c0: 2a2a 2a22 290a 2020 2020 2020 2020 636c  ***").        cl
+0001f2d0: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
+0001f2e0: 6b4d 616e 6167 6572 2e69 6e66 6f5f 6461  kManager.info_da
+0001f2f0: 7461 736f 7572 6365 5f64 6f65 736e 745f  tasource_doesnt_
+0001f300: 6d61 7463 6828 6461 7461 736f 7572 6365  match(datasource
+0001f310: 3d64 735f 6e61 6d65 2929 0a20 2020 2020  =ds_name)).     
+0001f320: 2020 2066 6f72 206f 7065 7261 7469 6f6e     for operation
+0001f330: 2069 6e20 616c 7465 725f 7265 7370 6f6e   in alter_respon
+0001f340: 7365 5b22 6f70 6572 6174 696f 6e73 225d  se["operations"]
+0001f350: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+0001f360: 6963 6b2e 6563 686f 2866 222a 2a20 2020  ick.echo(f"**   
+0001f370: 2d20 207b 6f70 6572 6174 696f 6e7d 2229  -  {operation}")
+0001f380: 0a0a 2020 2020 2020 2020 6966 2073 6b69  ..        if ski
+0001f390: 705f 636f 6e66 6972 6d61 7469 6f6e 3a0a  p_confirmation:.
+0001f3a0: 2020 2020 2020 2020 2020 2020 6d61 6b65              make
+0001f3b0: 5f63 6861 6e67 6573 203d 2054 7275 650a  _changes = True.
+0001f3c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001f3d0: 2020 2020 2020 2020 2020 6d61 6b65 5f63            make_c
+0001f3e0: 6861 6e67 6573 203d 2063 6c69 636b 2e70  hanges = click.p
+0001f3f0: 726f 6d70 7428 4665 6564 6261 636b 4d61  rompt(FeedbackMa
+0001f400: 6e61 6765 722e 696e 666f 5f61 736b 5f66  nager.info_ask_f
+0001f410: 6f72 5f61 6c74 6572 5f63 6f6e 6669 726d  or_alter_confirm
+0001f420: 6174 696f 6e28 2929 2e6c 6f77 6572 2829  ation()).lower()
+0001f430: 203d 3d20 2279 220a 0a20 2020 2020 2020   == "y"..       
+0001f440: 2069 6620 6d61 6b65 5f63 6861 6e67 6573   if make_changes
+0001f450: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+0001f460: 6169 7420 636c 6965 6e74 2e61 6c74 6572  ait client.alter
+0001f470: 5f64 6174 6173 6f75 7263 6528 0a20 2020  _datasource(.   
+0001f480: 2020 2020 2020 2020 2020 2020 2064 735f               ds_
+0001f490: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0001f4a0: 2020 2020 2020 6e65 775f 7363 6865 6d61        new_schema
+0001f4b0: 3d6e 6577 5f73 6368 656d 612c 0a20 2020  =new_schema,.   
+0001f4c0: 2020 2020 2020 2020 2020 2020 2064 6573               des
+0001f4d0: 6372 6970 7469 6f6e 3d6e 6577 5f64 6573  cription=new_des
+0001f4e0: 6372 6970 7469 6f6e 2c0a 2020 2020 2020  cription,.      
+0001f4f0: 2020 2020 2020 2020 2020 7474 6c3d 6e65            ttl=ne
+0001f500: 775f 7474 6c2c 0a20 2020 2020 2020 2020  w_ttl,.         
+0001f510: 2020 2020 2020 2064 7279 5f72 756e 3d46         dry_run=F
+0001f520: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+0001f530: 2020 2020 2020 696e 6465 7865 733d 6e65        indexes=ne
+0001f540: 775f 696e 6469 6365 732c 0a20 2020 2020  w_indices,.     
+0001f550: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001f560: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001f570: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0001f580: 7375 6363 6573 735f 6461 7461 736f 7572  success_datasour
+0001f590: 6365 5f61 6c74 6572 2829 290a 2020 2020  ce_alter()).    
+0001f5a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001f5b0: 2020 2020 2020 616c 7465 725f 6572 726f        alter_erro
+0001f5c0: 725f 6d65 7373 6167 6520 3d20 2241 6c74  r_message = "Alt
+0001f5d0: 6572 2064 6174 6173 6f75 7263 6520 6361  er datasource ca
+0001f5e0: 6e63 656c 6c65 6422 0a0a 2020 2020 6966  ncelled"..    if
+0001f5f0: 2064 6174 6173 6f75 7263 655f 6578 6973   datasource_exis
+0001f600: 7473 2061 6e64 2064 735b 2270 6172 616d  ts and ds["param
+0001f610: 7322 5d2e 6765 7428 2262 6163 6b66 696c  s"].get("backfil
+0001f620: 6c5f 636f 6c75 6d6e 2229 2021 3d20 6578  l_column") != ex
+0001f630: 6973 7469 6e67 5f64 735b 2274 6167 7322  isting_ds["tags"
+0001f640: 5d2e 6765 7428 2262 6163 6b66 696c 6c5f  ].get("backfill_
+0001f650: 636f 6c75 6d6e 2229 3a0a 2020 2020 2020  column"):.      
+0001f660: 2020 7061 7261 6d73 203d 207b 0a20 2020    params = {.   
+0001f670: 2020 2020 2020 2020 2022 6261 636b 6669           "backfi
+0001f680: 6c6c 5f63 6f6c 756d 6e22 3a20 6473 5b22  ll_column": ds["
+0001f690: 7061 7261 6d73 225d 2e67 6574 2822 6261  params"].get("ba
+0001f6a0: 636b 6669 6c6c 5f63 6f6c 756d 6e22 292c  ckfill_column"),
+0001f6b0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0001f6c0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001f6d0: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+0001f6e0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+0001f6f0: 696e 666f 5f75 7064 6174 655f 6461 7461  info_update_data
+0001f700: 736f 7572 6365 2864 6174 6173 6f75 7263  source(datasourc
+0001f710: 653d 6473 5f6e 616d 652c 2070 6172 616d  e=ds_name, param
+0001f720: 733d 7061 7261 6d73 2929 0a20 2020 2020  s=params)).     
+0001f730: 2020 2020 2020 2061 7761 6974 2063 6c69         await cli
+0001f740: 656e 742e 7570 6461 7465 5f64 6174 6173  ent.update_datas
+0001f750: 6f75 7263 6528 6473 5f6e 616d 652c 2070  ource(ds_name, p
+0001f760: 6172 616d 7329 0a20 2020 2020 2020 2020  arams).         
+0001f770: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
+0001f780: 6564 6261 636b 4d61 6e61 6765 722e 7375  edbackManager.su
+0001f790: 6363 6573 735f 7570 6461 7465 5f64 6174  ccess_update_dat
+0001f7a0: 6173 6f75 7263 6528 6461 7461 736f 7572  asource(datasour
+0001f7b0: 6365 3d64 735f 6e61 6d65 2c20 7061 7261  ce=ds_name, para
+0001f7c0: 6d73 3d70 6172 616d 7329 290a 2020 2020  ms=params)).    
+0001f7d0: 2020 2020 2020 2020 6d61 6b65 5f63 6861          make_cha
+0001f7e0: 6e67 6573 203d 2054 7275 650a 2020 2020  nges = True.    
+0001f7f0: 2020 2020 2020 2020 616c 7465 725f 7265          alter_re
+0001f800: 7370 6f6e 7365 203d 2054 7275 650a 2020  sponse = True.  
+0001f810: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+0001f820: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+0001f830: 2020 2020 2020 2020 2072 6169 7365 2063           raise c
+0001f840: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
+0001f850: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
+0001f860: 6765 722e 6572 726f 725f 7570 6461 7469  ger.error_updati
+0001f870: 6e67 5f64 6174 6173 6f75 7263 6528 6461  ng_datasource(da
+0001f880: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
+0001f890: 2c20 6572 726f 723d 7374 7228 6529 2929  , error=str(e)))
+0001f8a0: 0a0a 2020 2020 636f 6e6e 6563 746f 725f  ..    connector_
+0001f8b0: 6461 7461 203d 204e 6f6e 650a 2020 2020  data = None.    
+0001f8c0: 7072 6f6d 6f74 655f 6572 726f 725f 6d65  promote_error_me
+0001f8d0: 7373 6167 6520 3d20 4e6f 6e65 0a0a 2020  ssage = None..  
+0001f8e0: 2020 6473 5f70 6172 616d 7320 3d20 6473    ds_params = ds
+0001f8f0: 5b22 7061 7261 6d73 225d 0a20 2020 2073  ["params"].    s
+0001f900: 6572 7669 6365 203d 2064 735f 7061 7261  ervice = ds_para
+0001f910: 6d73 2e67 6574 2822 7365 7276 6963 6522  ms.get("service"
+0001f920: 290a 2020 2020 4441 5441 534f 5552 4345  ).    DATASOURCE
+0001f930: 5f56 414c 4944 5f53 4552 5649 4345 535f  _VALID_SERVICES_
+0001f940: 544f 5f55 5044 4154 4520 3d20 5b22 6269  TO_UPDATE = ["bi
+0001f950: 6771 7565 7279 222c 2022 736e 6f77 666c  gquery", "snowfl
+0001f960: 616b 6522 5d0a 2020 2020 6966 2064 6174  ake"].    if dat
+0001f970: 6173 6f75 7263 655f 6578 6973 7473 2061  asource_exists a
+0001f980: 6e64 2073 6572 7669 6365 2061 6e64 2073  nd service and s
+0001f990: 6572 7669 6365 2069 6e20 5b2a 4441 5441  ervice in [*DATA
+0001f9a0: 534f 5552 4345 5f56 414c 4944 5f53 4552  SOURCE_VALID_SER
+0001f9b0: 5649 4345 535f 544f 5f55 5044 4154 452c  VICES_TO_UPDATE,
+0001f9c0: 202a 5052 4556 4945 575f 434f 4e4e 4543   *PREVIEW_CONNEC
+0001f9d0: 544f 525f 5345 5256 4943 4553 5d3a 0a20  TOR_SERVICES]:. 
+0001f9e0: 2020 2020 2020 2063 6f6e 6e65 6374 6f72         connector
+0001f9f0: 5f72 6571 7569 7265 645f 7061 7261 6d73  _required_params
+0001fa00: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0001fa10: 2022 6269 6771 7565 7279 223a 205b 2273   "bigquery": ["s
+0001fa20: 6572 7669 6365 222c 2022 6372 6f6e 222c  ervice", "cron",
+0001fa30: 2022 6578 7465 726e 616c 5f64 6174 615f   "external_data_
+0001fa40: 736f 7572 6365 225d 2c0a 2020 2020 2020  source"],.      
+0001fa50: 2020 2020 2020 2273 6e6f 7766 6c61 6b65        "snowflake
+0001fa60: 223a 205b 2263 6f6e 6e65 6374 6f72 222c  ": ["connector",
+0001fa70: 2022 7365 7276 6963 6522 2c20 2263 726f   "service", "cro
+0001fa80: 6e22 2c20 2265 7874 6572 6e61 6c5f 6461  n", "external_da
+0001fa90: 7461 5f73 6f75 7263 6522 5d2c 0a20 2020  ta_source"],.   
+0001faa0: 2020 2020 2020 2020 2022 7333 223a 205b           "s3": [
+0001fab0: 2263 6f6e 6e65 6374 6f72 222c 2022 7365  "connector", "se
+0001fac0: 7276 6963 6522 2c20 2263 726f 6e22 2c20  rvice", "cron", 
+0001fad0: 2262 7563 6b65 745f 7572 6922 5d2c 0a20  "bucket_uri"],. 
+0001fae0: 2020 2020 2020 2020 2020 2022 7333 5f69             "s3_i
+0001faf0: 616d 726f 6c65 223a 205b 2263 6f6e 6e65  amrole": ["conne
+0001fb00: 6374 6f72 222c 2022 7365 7276 6963 6522  ctor", "service"
+0001fb10: 2c20 2263 726f 6e22 2c20 2262 7563 6b65  , "cron", "bucke
+0001fb20: 745f 7572 6922 5d2c 0a20 2020 2020 2020  t_uri"],.       
+0001fb30: 2020 2020 2022 6763 7322 3a20 5b22 636f       "gcs": ["co
+0001fb40: 6e6e 6563 746f 7222 2c20 2273 6572 7669  nnector", "servi
+0001fb50: 6365 222c 2022 6372 6f6e 222c 2022 6275  ce", "cron", "bu
+0001fb60: 636b 6574 5f75 7269 225d 2c0a 2020 2020  cket_uri"],.    
+0001fb70: 2020 2020 7d2e 6765 7428 7365 7276 6963      }.get(servic
+0001fb80: 652c 205b 5d29 0a0a 2020 2020 2020 2020  e, [])..        
+0001fb90: 6966 206e 6f74 2061 6c6c 286b 6579 2069  if not all(key i
+0001fba0: 6e20 6473 5f70 6172 616d 7320 666f 7220  n ds_params for 
+0001fbb0: 6b65 7920 696e 2063 6f6e 6e65 6374 6f72  key in connector
+0001fbc0: 5f72 6571 7569 7265 645f 7061 7261 6d73  _required_params
+0001fbd0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0001fbe0: 6574 7572 6e0a 0a20 2020 2020 2020 2063  eturn..        c
+0001fbf0: 6f6e 6e65 6374 6f72 203d 2064 735f 7061  onnector = ds_pa
+0001fc00: 7261 6d73 2e67 6574 2822 636f 6e6e 6563  rams.get("connec
+0001fc10: 746f 7222 2c20 4e6f 6e65 290a 0a20 2020  tor", None)..   
+0001fc20: 2020 2020 2069 6620 7365 7276 6963 6520       if service 
+0001fc30: 696e 2050 5245 5649 4557 5f43 4f4e 4e45  in PREVIEW_CONNE
+0001fc40: 4354 4f52 5f53 4552 5649 4345 533a 0a20  CTOR_SERVICES:. 
+0001fc50: 2020 2020 2020 2020 2020 2063 6f6e 6e65             conne
+0001fc60: 6374 6f72 5f69 6420 3d20 6578 6973 7469  ctor_id = existi
+0001fc70: 6e67 5f64 732e 6765 7428 2263 6f6e 6e65  ng_ds.get("conne
+0001fc80: 6374 6f72 222c 2022 2229 0a20 2020 2020  ctor", "").     
+0001fc90: 2020 2020 2020 2069 6620 6e6f 7420 636f         if not co
+0001fca0: 6e6e 6563 746f 725f 6964 3a0a 2020 2020  nnector_id:.    
+0001fcb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001fcc0: 726e 0a0a 2020 2020 2020 2020 2020 2020  rn..            
+0001fcd0: 6375 7272 656e 745f 636f 6e6e 6563 746f  current_connecto
+0001fce0: 7220 3d20 6177 6169 7420 636c 6965 6e74  r = await client
+0001fcf0: 2e67 6574 5f63 6f6e 6e65 6374 6f72 5f62  .get_connector_b
+0001fd00: 795f 6964 2865 7869 7374 696e 675f 6473  y_id(existing_ds
+0001fd10: 2e67 6574 2822 636f 6e6e 6563 746f 7222  .get("connector"
+0001fd20: 2c20 2222 2929 0a20 2020 2020 2020 2020  , "")).         
+0001fd30: 2020 2069 6620 6e6f 7420 6375 7272 656e     if not curren
+0001fd40: 745f 636f 6e6e 6563 746f 723a 0a20 2020  t_connector:.   
+0001fd50: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001fd60: 7572 6e0a 0a20 2020 2020 2020 2020 2020  urn..           
+0001fd70: 2069 6620 6375 7272 656e 745f 636f 6e6e   if current_conn
+0001fd80: 6563 746f 725b 226e 616d 6522 5d20 213d  ector["name"] !=
+0001fd90: 2064 735f 7061 7261 6d73 5b22 636f 6e6e   ds_params["conn
+0001fda0: 6563 7469 6f6e 225d 3a0a 2020 2020 2020  ection"]:.      
+0001fdb0: 2020 2020 2020 2020 2020 7061 7261 6d20            param 
+0001fdc0: 3d20 2263 6f6e 6e65 6374 696f 6e22 0a20  = "connection". 
+0001fdd0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001fde0: 6174 6166 696c 655f 7061 7261 6d20 3d20  atafile_param = 
+0001fdf0: 496d 706f 7274 5265 706c 6163 656d 656e  ImportReplacemen
+0001fe00: 7473 2e67 6574 5f64 6174 6166 696c 655f  ts.get_datafile_
+0001fe10: 7061 7261 6d5f 666f 725f 6c69 6e6b 6572  param_for_linker
+0001fe20: 5f70 6172 616d 2873 6572 7669 6365 2c20  _param(service, 
+0001fe30: 7061 7261 6d29 206f 7220 7061 7261 6d0a  param) or param.
+0001fe40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe50: 7261 6973 6520 636c 6963 6b2e 436c 6963  raise click.Clic
+0001fe60: 6b45 7863 6570 7469 6f6e 2846 6565 6462  kException(Feedb
+0001fe70: 6163 6b4d 616e 6167 6572 2e65 7272 6f72  ackManager.error
+0001fe80: 5f75 7064 6174 696e 675f 636f 6e6e 6563  _updating_connec
+0001fe90: 746f 725f 6e6f 745f 7375 7070 6f72 7465  tor_not_supporte
+0001fea0: 6428 7061 7261 6d3d 6461 7461 6669 6c65  d(param=datafile
+0001feb0: 5f70 6172 616d 2929 0a0a 2020 2020 2020  _param))..      
+0001fec0: 2020 2020 2020 6c69 6e6b 6572 7320 3d20        linkers = 
+0001fed0: 6375 7272 656e 745f 636f 6e6e 6563 746f  current_connecto
+0001fee0: 722e 6765 7428 226c 696e 6b65 7273 222c  r.get("linkers",
+0001fef0: 205b 5d29 0a20 2020 2020 2020 2020 2020   []).           
+0001ff00: 206c 696e 6b65 7220 3d20 6e65 7874 2828   linker = next((
+0001ff10: 6c69 6e6b 6572 2066 6f72 206c 696e 6b65  linker for linke
+0001ff20: 7220 696e 206c 696e 6b65 7273 2069 6620  r in linkers if 
+0001ff30: 6c69 6e6b 6572 5b22 6461 7461 736f 7572  linker["datasour
+0001ff40: 6365 5f69 6422 5d20 3d3d 2065 7869 7374  ce_id"] == exist
+0001ff50: 696e 675f 6473 5b22 6964 225d 292c 204e  ing_ds["id"]), N
+0001ff60: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
+0001ff70: 2069 6620 6e6f 7420 6c69 6e6b 6572 3a0a   if not linker:.
+0001ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff90: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+0001ffa0: 2020 2020 6c69 6e6b 6572 5f73 6574 7469      linker_setti
+0001ffb0: 6e67 7320 3d20 6c69 6e6b 6572 2e67 6574  ngs = linker.get
+0001ffc0: 2822 7365 7474 696e 6773 222c 207b 7d29  ("settings", {})
+0001ffd0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001ffe0: 2070 6172 616d 2c20 7661 6c75 6520 696e   param, value in
+0001fff0: 206c 696e 6b65 725f 7365 7474 696e 6773   linker_settings
+00020000: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00020010: 2020 2020 2020 2020 2020 6473 5f70 6172            ds_par
+00020020: 616d 735f 7661 6c75 6520 3d20 6473 5f70  ams_value = ds_p
+00020030: 6172 616d 732e 6765 7428 7061 7261 6d2c  arams.get(param,
+00020040: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
+00020050: 2020 2020 2020 2069 6620 6473 5f70 6172         if ds_par
+00020060: 616d 735f 7661 6c75 6520 616e 6420 6473  ams_value and ds
+00020070: 5f70 6172 616d 735f 7661 6c75 6520 213d  _params_value !=
+00020080: 2076 616c 7565 3a0a 2020 2020 2020 2020   value:.        
+00020090: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000200a0: 6669 6c65 5f70 6172 616d 203d 2049 6d70  file_param = Imp
+000200b0: 6f72 7452 6570 6c61 6365 6d65 6e74 732e  ortReplacements.
+000200c0: 6765 745f 6461 7461 6669 6c65 5f70 6172  get_datafile_par
+000200d0: 616d 5f66 6f72 5f6c 696e 6b65 725f 7061  am_for_linker_pa
+000200e0: 7261 6d28 7365 7276 6963 652c 2070 6172  ram(service, par
+000200f0: 616d 2920 6f72 2070 6172 616d 0a20 2020  am) or param.   
+00020100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020110: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+00020120: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00020130: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+00020140: 636b 4d61 6e61 6765 722e 6572 726f 725f  ckManager.error_
+00020150: 7570 6461 7469 6e67 5f63 6f6e 6e65 6374  updating_connect
+00020160: 6f72 5f6e 6f74 5f73 7570 706f 7274 6564  or_not_supported
+00020170: 2870 6172 616d 3d64 6174 6166 696c 655f  (param=datafile_
+00020180: 7061 7261 6d2e 7570 7065 7228 2929 0a20  param.upper()). 
+00020190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201a0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000201b0: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+000201c0: 2063 6f6e 6e65 6374 6f72 5f64 6174 6120   connector_data 
+000201d0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+000201e0: 2263 6f6e 6e65 6374 6f72 223a 2063 6f6e  "connector": con
+000201f0: 6e65 6374 6f72 2c0a 2020 2020 2020 2020  nector,.        
+00020200: 2020 2020 2273 6572 7669 6365 223a 2073      "service": s
+00020210: 6572 7669 6365 2c0a 2020 2020 2020 2020  ervice,.        
+00020220: 2020 2020 2263 726f 6e22 3a20 6473 5f70      "cron": ds_p
+00020230: 6172 616d 732e 6765 7428 2263 726f 6e22  arams.get("cron"
+00020240: 2c20 4e6f 6e65 292c 0a20 2020 2020 2020  , None),.       
+00020250: 2020 2020 2022 6578 7465 726e 616c 5f64       "external_d
+00020260: 6174 615f 736f 7572 6365 223a 2064 735f  ata_source": ds_
+00020270: 7061 7261 6d73 2e67 6574 2822 6578 7465  params.get("exte
+00020280: 726e 616c 5f64 6174 615f 736f 7572 6365  rnal_data_source
+00020290: 222c 204e 6f6e 6529 2c0a 2020 2020 2020  ", None),.      
+000202a0: 2020 2020 2020 2262 7563 6b65 745f 7572        "bucket_ur
+000202b0: 6922 3a20 6473 5f70 6172 616d 732e 6765  i": ds_params.ge
+000202c0: 7428 2262 7563 6b65 745f 7572 6922 2c20  t("bucket_uri", 
+000202d0: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+000202e0: 2020 2022 6d6f 6465 223a 2064 735f 7061     "mode": ds_pa
+000202f0: 7261 6d73 2e67 6574 2822 6d6f 6465 222c  rams.get("mode",
+00020300: 2022 7265 706c 6163 6522 292c 0a20 2020   "replace"),.   
+00020310: 2020 2020 2020 2020 2022 7175 6572 7922           "query"
+00020320: 3a20 6473 5f70 6172 616d 732e 6765 7428  : ds_params.get(
+00020330: 2271 7565 7279 222c 204e 6f6e 6529 2c0a  "query", None),.
+00020340: 2020 2020 2020 2020 2020 2020 2269 6e67              "ing
+00020350: 6573 745f 6e6f 7722 3a20 6473 5f70 6172  est_now": ds_par
+00020360: 616d 732e 6765 7428 2269 6e67 6573 745f  ams.get("ingest_
+00020370: 6e6f 7722 2c20 4661 6c73 6529 2c0a 2020  now", False),.  
+00020380: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00020390: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000203a0: 2020 6177 6169 7420 636c 6965 6e74 2e75    await client.u
+000203b0: 7064 6174 655f 6461 7461 736f 7572 6365  pdate_datasource
+000203c0: 2864 735f 6e61 6d65 2c20 636f 6e6e 6563  (ds_name, connec
+000203d0: 746f 725f 6461 7461 290a 2020 2020 2020  tor_data).      
+000203e0: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
+000203f0: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
+00020400: 2e73 7563 6365 7373 5f70 726f 6d6f 7469  .success_promoti
+00020410: 6e67 5f64 6174 6173 6f75 7263 6528 6461  ng_datasource(da
+00020420: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
+00020430: 2929 0a20 2020 2020 2020 2020 2020 2072  )).            r
+00020440: 6574 7572 6e0a 2020 2020 2020 2020 6578  eturn.        ex
+00020450: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00020460: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00020470: 2070 726f 6d6f 7465 5f65 7272 6f72 5f6d   promote_error_m
+00020480: 6573 7361 6765 203d 2073 7472 2865 290a  essage = str(e).
+00020490: 0a20 2020 2069 6620 616c 7465 725f 7265  .    if alter_re
+000204a0: 7370 6f6e 7365 2061 6e64 206d 616b 655f  sponse and make_
+000204b0: 6368 616e 6765 733a 0a20 2020 2020 2020  changes:.       
+000204c0: 2023 2061 6c74 6572 206f 7065 7261 7469   # alter operati
+000204d0: 6f6e 2066 696e 6973 6865 640a 2020 2020  on finished.    
+000204e0: 2020 2020 7265 7475 726e 0a20 2020 2023      return.    #
+000204f0: 2072 656d 6f76 6564 2072 6570 6c61 6369   removed replaci
+00020500: 6e67 2062 7920 6465 6661 756c 742e 2057  ng by default. W
+00020510: 6865 6e20 6120 6461 7461 736f 7572 6365  hen a datasource
+00020520: 2069 7320 7265 6d6f 7665 6420 6461 7461   is removed data
+00020530: 2069 730a 2020 2020 2320 7265 6d6f 7665   is.    # remove
+00020540: 6420 616e 6420 616c 6c20 7468 6520 7265  d and all the re
+00020550: 6665 7265 6e63 6573 206e 6565 6473 2074  ferences needs t
+00020560: 6f20 6265 2075 7064 6174 6564 0a20 2020  o be updated.   
+00020570: 2069 6620 280a 2020 2020 2020 2020 6f73   if (.        os
+00020580: 2e67 6574 656e 7628 2254 425f 495f 4b4e  .getenv("TB_I_KN
+00020590: 4f57 5f57 4841 545f 495f 414d 5f44 4f49  OW_WHAT_I_AM_DOI
+000205a0: 4e47 2229 0a20 2020 2020 2020 2061 6e64  NG").        and
+000205b0: 2063 6c69 636b 2e70 726f 6d70 7428 4665   click.prompt(Fe
+000205c0: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
+000205d0: 666f 5f61 736b 5f66 6f72 5f64 6174 6173  fo_ask_for_datas
+000205e0: 6f75 7263 655f 636f 6e66 6972 6d61 7469  ource_confirmati
+000205f0: 6f6e 2829 2920 3d3d 2064 735f 6e61 6d65  on()) == ds_name
+00020600: 0a20 2020 2029 3a20 2023 2054 4f44 4f20  .    ):  # TODO 
+00020610: 6d6f 7665 2074 6f20 434c 490a 2020 2020  move to CLI.    
+00020620: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00020630: 2020 2020 2061 7761 6974 2063 6c69 656e       await clien
+00020640: 742e 6461 7461 736f 7572 6365 5f64 656c  t.datasource_del
+00020650: 6574 6528 6473 5f6e 616d 6529 0a20 2020  ete(ds_name).   
+00020660: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+00020670: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
+00020680: 6765 722e 7375 6363 6573 735f 6465 6c65  ger.success_dele
+00020690: 7465 5f64 6174 6173 6f75 7263 6528 6461  te_datasource(da
+000206a0: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
+000206b0: 2929 0a20 2020 2020 2020 2065 7863 6570  )).        excep
+000206c0: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+000206d0: 2020 2020 2020 2020 2072 6169 7365 2063           raise c
+000206e0: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
+000206f0: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
+00020700: 6765 722e 6572 726f 725f 7265 6d6f 7669  ger.error_removi
+00020710: 6e67 5f64 6174 6173 6f75 7263 6528 6461  ng_datasource(da
+00020720: 7461 736f 7572 6365 3d64 735f 6e61 6d65  tasource=ds_name
+00020730: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+00020740: 6e0a 2020 2020 656c 7365 3a0a 2020 2020  n.    else:.    
+00020750: 2020 2020 6966 2061 6c74 6572 5f65 7272      if alter_err
+00020760: 6f72 5f6d 6573 7361 6765 3a0a 2020 2020  or_message:.    
+00020770: 2020 2020 2020 2020 7261 6973 6520 636c          raise cl
+00020780: 6963 6b2e 436c 6963 6b45 7863 6570 7469  ick.ClickExcepti
+00020790: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+000207a0: 2020 2020 4665 6564 6261 636b 4d61 6e61      FeedbackMana
+000207b0: 6765 722e 6572 726f 725f 6461 7461 736f  ger.error_dataso
+000207c0: 7572 6365 5f61 6c72 6561 6479 5f65 7869  urce_already_exi
+000207d0: 7374 735f 616e 645f 616c 7465 725f 6661  sts_and_alter_fa
+000207e0: 696c 6564 280a 2020 2020 2020 2020 2020  iled(.          
+000207f0: 2020 2020 2020 2020 2020 6461 7461 736f            dataso
+00020800: 7572 6365 3d64 735f 6e61 6d65 2c20 616c  urce=ds_name, al
+00020810: 7465 725f 6572 726f 725f 6d65 7373 6167  ter_error_messag
+00020820: 653d 616c 7465 725f 6572 726f 725f 6d65  e=alter_error_me
+00020830: 7373 6167 650a 2020 2020 2020 2020 2020  ssage.          
+00020840: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00020850: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+00020860: 2070 726f 6d6f 7465 5f65 7272 6f72 5f6d   promote_error_m
+00020870: 6573 7361 6765 3a0a 2020 2020 2020 2020  essage:.        
+00020880: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
+00020890: 436c 6963 6b45 7863 6570 7469 6f6e 280a  ClickException(.
+000208a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000208b0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+000208c0: 6572 726f 725f 7072 6f6d 6f74 696e 675f  error_promoting_
+000208d0: 6461 7461 736f 7572 6365 2864 6174 6173  datasource(datas
+000208e0: 6f75 7263 653d 6473 5f6e 616d 652c 2065  ource=ds_name, e
+000208f0: 7272 6f72 3d70 726f 6d6f 7465 5f65 7272  rror=promote_err
+00020900: 6f72 5f6d 6573 7361 6765 290a 2020 2020  or_message).    
+00020910: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00020920: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00020930: 2020 2020 636c 6963 6b2e 6563 686f 2846      click.echo(F
+00020940: 6565 6462 6163 6b4d 616e 6167 6572 2e77  eedbackManager.w
+00020950: 6172 6e69 6e67 5f64 6174 6173 6f75 7263  arning_datasourc
+00020960: 655f 616c 7265 6164 795f 6578 6973 7473  e_already_exists
+00020970: 2864 6174 6173 6f75 7263 653d 6473 5f6e  (datasource=ds_n
+00020980: 616d 6529 290a 0a0a 6173 796e 6320 6465  ame))...async de
+00020990: 6620 6e65 775f 746f 6b65 6e28 746f 6b65  f new_token(toke
+000209a0: 6e3a 2044 6963 745b 7374 722c 2041 6e79  n: Dict[str, Any
+000209b0: 5d2c 2063 6c69 656e 743a 2054 696e 7942  ], client: TinyB
+000209c0: 2c20 666f 7263 653a 2062 6f6f 6c20 3d20  , force: bool = 
+000209d0: 4661 6c73 6529 3a0a 2020 2020 6578 6973  False):.    exis
+000209e0: 7469 6e67 5f74 6f6b 656e 203d 204e 6f6e  ting_token = Non
+000209f0: 650a 2020 2020 7472 793a 0a20 2020 2020  e.    try:.     
+00020a00: 2020 2065 7869 7374 696e 675f 746f 6b65     existing_toke
+00020a10: 6e20 3d20 6177 6169 7420 636c 6965 6e74  n = await client
+00020a20: 2e74 6f6b 656e 5f67 6574 2874 6f6b 656e  .token_get(token
+00020a30: 5b22 6e61 6d65 225d 290a 2020 2020 6578  ["name"]).    ex
+00020a40: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
+00020a50: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+00020a60: 2020 6966 206e 6f74 2065 7869 7374 696e    if not existin
+00020a70: 675f 746f 6b65 6e3a 0a20 2020 2020 2020  g_token:.       
+00020a80: 2061 7761 6974 2063 6c69 656e 742e 746f   await client.to
+00020a90: 6b65 6e5f 6372 6561 7465 2874 6f6b 656e  ken_create(token
+00020aa0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00020ab0: 0a0a 2020 2020 6966 2066 6f72 6365 3a0a  ..    if force:.
+00020ac0: 2020 2020 2020 2020 4144 4d49 4e5f 5343          ADMIN_SC
+00020ad0: 4f50 4553 203d 205b 2241 444d 494e 222c  OPES = ["ADMIN",
+00020ae0: 2022 4144 4d49 4e5f 5553 4552 225d 0a20   "ADMIN_USER"]. 
+00020af0: 2020 2020 2020 2069 6620 616e 7928 5b73         if any([s
+00020b00: 636f 7065 5b22 7479 7065 225d 2069 6e20  cope["type"] in 
+00020b10: 4144 4d49 4e5f 5343 4f50 4553 2066 6f72  ADMIN_SCOPES for
+00020b20: 2073 636f 7065 2069 6e20 6578 6973 7469   scope in existi
+00020b30: 6e67 5f74 6f6b 656e 5b22 7363 6f70 6573  ng_token["scopes
+00020b40: 225d 5d29 3a0a 2020 2020 2020 2020 2020  "]]):.          
+00020b50: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+00020b60: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
+00020b70: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
+00020b80: 6f72 5f74 6f6b 656e 5f63 616e 6e6f 745f  or_token_cannot_
+00020b90: 6265 5f6f 7665 7272 6964 656e 2874 6f6b  be_overriden(tok
+00020ba0: 656e 3d74 6f6b 656e 5b22 6e61 6d65 225d  en=token["name"]
+00020bb0: 2929 0a0a 2020 2020 2020 2020 6177 6169  ))..        awai
+00020bc0: 7420 636c 6965 6e74 2e74 6f6b 656e 5f75  t client.token_u
+00020bd0: 7064 6174 6528 746f 6b65 6e29 0a20 2020  pdate(token).   
+00020be0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00020bf0: 2072 6169 7365 2063 6c69 636b 2e43 6c69   raise click.Cli
+00020c00: 636b 4578 6365 7074 696f 6e28 4665 6564  ckException(Feed
+00020c10: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+00020c20: 725f 746f 6b65 6e5f 616c 7265 6164 795f  r_token_already_
+00020c30: 6578 6973 7473 2874 6f6b 656e 3d74 6f6b  exists(token=tok
+00020c40: 656e 5b22 6e61 6d65 225d 2929 0a0a 0a61  en["name"]))...a
+00020c50: 7379 6e63 2064 6566 2065 7865 635f 6669  sync def exec_fi
+00020c60: 6c65 280a 2020 2020 636f 6e66 6967 3a20  le(.    config: 
+00020c70: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
+00020c80: 722c 2041 6e79 5d5d 2c0a 2020 2020 723a  r, Any]],.    r:
+00020c90: 2044 6963 745b 7374 722c 2041 6e79 5d2c   Dict[str, Any],
+00020ca0: 0a20 2020 2074 625f 636c 6965 6e74 3a20  .    tb_client: 
+00020cb0: 5469 6e79 422c 0a20 2020 2066 6f72 6365  TinyB,.    force
+00020cc0: 3a20 626f 6f6c 2c0a 2020 2020 6368 6563  : bool,.    chec
+00020cd0: 6b3a 2062 6f6f 6c2c 0a20 2020 2064 6562  k: bool,.    deb
+00020ce0: 7567 3a20 626f 6f6c 2c0a 2020 2020 706f  ug: bool,.    po
+00020cf0: 7075 6c61 7465 3a20 626f 6f6c 2c0a 2020  pulate: bool,.  
+00020d00: 2020 706f 7075 6c61 7465 5f73 7562 7365    populate_subse
+00020d10: 742c 0a20 2020 2070 6f70 756c 6174 655f  t,.    populate_
+00020d20: 636f 6e64 6974 696f 6e2c 0a20 2020 2075  condition,.    u
+00020d30: 6e6c 696e 6b5f 6f6e 5f70 6f70 756c 6174  nlink_on_populat
+00020d40: 655f 6572 726f 722c 0a20 2020 2077 6169  e_error,.    wai
+00020d50: 745f 706f 7075 6c61 7465 2c0a 2020 2020  t_populate,.    
+00020d60: 7573 6572 5f74 6f6b 656e 3a20 4f70 7469  user_token: Opti
+00020d70: 6f6e 616c 5b73 7472 5d2c 0a20 2020 206f  onal[str],.    o
+00020d80: 7665 7272 6964 655f 6461 7461 736f 7572  verride_datasour
+00020d90: 6365 3a20 626f 6f6c 203d 2046 616c 7365  ce: bool = False
+00020da0: 2c0a 2020 2020 6967 6e6f 7265 5f73 716c  ,.    ignore_sql
+00020db0: 5f65 7272 6f72 733a 2062 6f6f 6c20 3d20  _errors: bool = 
+00020dc0: 4661 6c73 652c 0a20 2020 2073 6b69 705f  False,.    skip_
+00020dd0: 636f 6e66 6972 6d61 7469 6f6e 3a20 626f  confirmation: bo
+00020de0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00020df0: 6f6e 6c79 5f72 6573 706f 6e73 655f 7469  only_response_ti
+00020e00: 6d65 733a 2062 6f6f 6c20 3d20 4661 6c73  mes: bool = Fals
+00020e10: 652c 0a20 2020 2074 696d 656f 7574 3d4e  e,.    timeout=N
+00020e20: 6f6e 652c 0a20 2020 2072 756e 5f74 6573  one,.    run_tes
+00020e30: 7473 3d46 616c 7365 2c0a 2020 2020 6173  ts=False,.    as
+00020e40: 5f73 7461 6e64 6172 643d 4661 6c73 652c  _standard=False,
+00020e50: 0a20 2020 2074 6573 7473 5f74 6f5f 7275  .    tests_to_ru
+00020e60: 6e3a 2069 6e74 203d 2030 2c0a 2020 2020  n: int = 0,.    
+00020e70: 7465 7374 735f 746f 5f73 616d 706c 655f  tests_to_sample_
+00020e80: 6279 5f70 6172 616d 733a 2069 6e74 203d  by_params: int =
+00020e90: 2030 2c0a 2020 2020 7465 7374 735f 6669   0,.    tests_fi
+00020ea0: 6c74 6572 5f62 793a 204f 7074 696f 6e61  lter_by: Optiona
+00020eb0: 6c5b 4c69 7374 5b73 7472 5d5d 203d 204e  l[List[str]] = N
+00020ec0: 6f6e 652c 0a20 2020 2074 6573 7473 5f66  one,.    tests_f
+00020ed0: 6169 6c66 6173 743a 2062 6f6f 6c20 3d20  ailfast: bool = 
+00020ee0: 4661 6c73 652c 0a20 2020 2074 6573 7473  False,.    tests
+00020ef0: 5f69 676e 6f72 655f 6f72 6465 723a 2062  _ignore_order: b
+00020f00: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00020f10: 2074 6573 7473 5f76 616c 6964 6174 655f   tests_validate_
+00020f20: 7072 6f63 6573 7365 645f 6279 7465 733a  processed_bytes:
+00020f30: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00020f40: 2020 2074 6573 7473 5f63 6865 636b 5f72     tests_check_r
+00020f50: 6571 7565 7374 735f 6672 6f6d 5f62 7261  equests_from_bra
+00020f60: 6e63 683a 2062 6f6f 6c20 3d20 4661 6c73  nch: bool = Fals
+00020f70: 652c 0a20 2020 2063 7572 7265 6e74 5f77  e,.    current_w
+00020f80: 733a 204f 7074 696f 6e61 6c5b 4469 6374  s: Optional[Dict
+00020f90: 5b73 7472 2c20 416e 795d 5d20 3d20 4e6f  [str, Any]] = No
+00020fa0: 6e65 2c0a 2020 2020 666f 726b 5f64 6f77  ne,.    fork_dow
+00020fb0: 6e73 7472 6561 6d3a 204f 7074 696f 6e61  nstream: Optiona
+00020fc0: 6c5b 626f 6f6c 5d20 3d20 4661 6c73 652c  l[bool] = False,
+00020fd0: 0a20 2020 2066 6f72 6b3a 204f 7074 696f  .    fork: Optio
+00020fe0: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+00020ff0: 652c 0a20 2020 2067 6974 5f72 656c 6561  e,.    git_relea
+00021000: 7365 3a20 4f70 7469 6f6e 616c 5b62 6f6f  se: Optional[boo
+00021010: 6c5d 203d 2046 616c 7365 2c0a 293a 0a20  l] = False,.):. 
+00021020: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
+00021030: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+00021040: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+00021050: 6465 6275 675f 7275 6e6e 696e 675f 6669  debug_running_fi
+00021060: 6c65 2866 696c 653d 7070 2e70 666f 726d  le(file=pp.pform
+00021070: 6174 2872 2929 290a 2020 2020 6966 2072  at(r))).    if r
+00021080: 5b22 7265 736f 7572 6365 225d 203d 3d20  ["resource"] == 
+00021090: 2270 6970 6573 223a 0a20 2020 2020 2020  "pipes":.       
+000210a0: 2061 7761 6974 206e 6577 5f70 6970 6528   await new_pipe(
+000210b0: 0a20 2020 2020 2020 2020 2020 2072 2c0a  .            r,.
+000210c0: 2020 2020 2020 2020 2020 2020 7462 5f63              tb_c
+000210d0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
+000210e0: 2020 2066 6f72 6365 2c0a 2020 2020 2020     force,.      
+000210f0: 2020 2020 2020 6368 6563 6b2c 0a20 2020        check,.   
+00021100: 2020 2020 2020 2020 2070 6f70 756c 6174           populat
+00021110: 652c 0a20 2020 2020 2020 2020 2020 2070  e,.            p
+00021120: 6f70 756c 6174 655f 7375 6273 6574 2c0a  opulate_subset,.
+00021130: 2020 2020 2020 2020 2020 2020 706f 7075              popu
+00021140: 6c61 7465 5f63 6f6e 6469 7469 6f6e 2c0a  late_condition,.
+00021150: 2020 2020 2020 2020 2020 2020 756e 6c69              unli
+00021160: 6e6b 5f6f 6e5f 706f 7075 6c61 7465 5f65  nk_on_populate_e
+00021170: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
+00021180: 2020 7761 6974 5f70 6f70 756c 6174 652c    wait_populate,
+00021190: 0a20 2020 2020 2020 2020 2020 2069 676e  .            ign
+000211a0: 6f72 655f 7371 6c5f 6572 726f 7273 3d69  ore_sql_errors=i
+000211b0: 676e 6f72 655f 7371 6c5f 6572 726f 7273  gnore_sql_errors
+000211c0: 2c0a 2020 2020 2020 2020 2020 2020 6f6e  ,.            on
+000211d0: 6c79 5f72 6573 706f 6e73 655f 7469 6d65  ly_response_time
+000211e0: 733d 6f6e 6c79 5f72 6573 706f 6e73 655f  s=only_response_
+000211f0: 7469 6d65 732c 0a20 2020 2020 2020 2020  times,.         
+00021200: 2020 2074 696d 656f 7574 3d74 696d 656f     timeout=timeo
+00021210: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00021220: 7275 6e5f 7465 7374 733d 7275 6e5f 7465  run_tests=run_te
+00021230: 7374 732c 0a20 2020 2020 2020 2020 2020  sts,.           
+00021240: 2061 735f 7374 616e 6461 7264 3d61 735f   as_standard=as_
+00021250: 7374 616e 6461 7264 2c0a 2020 2020 2020  standard,.      
+00021260: 2020 2020 2020 7465 7374 735f 746f 5f72        tests_to_r
+00021270: 756e 3d74 6573 7473 5f74 6f5f 7275 6e2c  un=tests_to_run,
+00021280: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
+00021290: 7473 5f74 6f5f 7361 6d70 6c65 5f62 795f  ts_to_sample_by_
+000212a0: 7061 7261 6d73 3d74 6573 7473 5f74 6f5f  params=tests_to_
+000212b0: 7361 6d70 6c65 5f62 795f 7061 7261 6d73  sample_by_params
+000212c0: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
+000212d0: 7374 735f 6669 6c74 6572 5f62 793d 7465  sts_filter_by=te
+000212e0: 7374 735f 6669 6c74 6572 5f62 792c 0a20  sts_filter_by,. 
+000212f0: 2020 2020 2020 2020 2020 2074 6573 7473             tests
+00021300: 5f66 6169 6c66 6173 743d 7465 7374 735f  _failfast=tests_
+00021310: 6661 696c 6661 7374 2c0a 2020 2020 2020  failfast,.      
+00021320: 2020 2020 2020 7465 7374 735f 6967 6e6f        tests_igno
+00021330: 7265 5f6f 7264 6572 3d74 6573 7473 5f69  re_order=tests_i
+00021340: 676e 6f72 655f 6f72 6465 722c 0a20 2020  gnore_order,.   
+00021350: 2020 2020 2020 2020 2074 6573 7473 5f76           tests_v
+00021360: 616c 6964 6174 655f 7072 6f63 6573 7365  alidate_processe
+00021370: 645f 6279 7465 733d 7465 7374 735f 7661  d_bytes=tests_va
+00021380: 6c69 6461 7465 5f70 726f 6365 7373 6564  lidate_processed
+00021390: 5f62 7974 6573 2c0a 2020 2020 2020 2020  _bytes,.        
+000213a0: 2020 2020 6f76 6572 7269 6465 5f64 6174      override_dat
+000213b0: 6173 6f75 7263 653d 6f76 6572 7269 6465  asource=override
+000213c0: 5f64 6174 6173 6f75 7263 652c 0a20 2020  _datasource,.   
+000213d0: 2020 2020 2020 2020 2074 6573 7473 5f63           tests_c
+000213e0: 6865 636b 5f72 6571 7565 7374 735f 6672  heck_requests_fr
+000213f0: 6f6d 5f62 7261 6e63 683d 7465 7374 735f  om_branch=tests_
+00021400: 6368 6563 6b5f 7265 7175 6573 7473 5f66  check_requests_f
+00021410: 726f 6d5f 6272 616e 6368 2c0a 2020 2020  rom_branch,.    
+00021420: 2020 2020 2020 2020 666f 726b 5f64 6f77          fork_dow
+00021430: 6e73 7472 6561 6d3d 666f 726b 5f64 6f77  nstream=fork_dow
+00021440: 6e73 7472 6561 6d2c 0a20 2020 2020 2020  nstream,.       
+00021450: 2020 2020 2066 6f72 6b3d 666f 726b 2c0a       fork=fork,.
+00021460: 2020 2020 2020 2020 290a 2020 2020 656c          ).    el
+00021470: 6966 2072 5b22 7265 736f 7572 6365 225d  if r["resource"]
+00021480: 203d 3d20 2264 6174 6173 6f75 7263 6573   == "datasources
+00021490: 223a 0a20 2020 2020 2020 2061 7761 6974  ":.        await
+000214a0: 206e 6577 5f64 7328 0a20 2020 2020 2020   new_ds(.       
+000214b0: 2020 2020 2072 2c0a 2020 2020 2020 2020       r,.        
+000214c0: 2020 2020 7462 5f63 6c69 656e 742c 0a20      tb_client,. 
+000214d0: 2020 2020 2020 2020 2020 2075 7365 725f             user_
+000214e0: 746f 6b65 6e2c 0a20 2020 2020 2020 2020  token,.         
+000214f0: 2020 2066 6f72 6365 2c0a 2020 2020 2020     force,.      
+00021500: 2020 2020 2020 736b 6970 5f63 6f6e 6669        skip_confi
+00021510: 726d 6174 696f 6e3d 736b 6970 5f63 6f6e  rmation=skip_con
+00021520: 6669 726d 6174 696f 6e2c 0a20 2020 2020  firmation,.     
+00021530: 2020 2020 2020 2063 7572 7265 6e74 5f77         current_w
+00021540: 733d 6375 7272 656e 745f 7773 2c0a 2020  s=current_ws,.  
+00021550: 2020 2020 2020 2020 2020 666f 726b 5f64            fork_d
+00021560: 6f77 6e73 7472 6561 6d3d 666f 726b 5f64  ownstream=fork_d
+00021570: 6f77 6e73 7472 6561 6d2c 0a20 2020 2020  ownstream,.     
+00021580: 2020 2020 2020 2066 6f72 6b3d 666f 726b         fork=fork
+00021590: 2c0a 2020 2020 2020 2020 2020 2020 6769  ,.            gi
+000215a0: 745f 7265 6c65 6173 653d 6769 745f 7265  t_release=git_re
+000215b0: 6c65 6173 652c 0a20 2020 2020 2020 2029  lease,.        )
+000215c0: 0a20 2020 2065 6c69 6620 725b 2272 6573  .    elif r["res
+000215d0: 6f75 7263 6522 5d20 3d3d 2022 746f 6b65  ource"] == "toke
+000215e0: 6e73 223a 0a20 2020 2020 2020 2061 7761  ns":.        awa
+000215f0: 6974 206e 6577 5f74 6f6b 656e 2872 2c20  it new_token(r, 
+00021600: 7462 5f63 6c69 656e 742c 2066 6f72 6365  tb_client, force
+00021610: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00021620: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
+00021630: 436c 6963 6b45 7863 6570 7469 6f6e 2846  ClickException(F
+00021640: 6565 6462 6163 6b4d 616e 6167 6572 2e65  eedbackManager.e
+00021650: 7272 6f72 5f75 6e6b 6e6f 776e 5f72 6573  rror_unknown_res
+00021660: 6f75 7263 6528 7265 736f 7572 6365 3d72  ource(resource=r
+00021670: 5b22 7265 736f 7572 6365 225d 2929 0a0a  ["resource"]))..
+00021680: 0a64 6566 2067 6574 5f6e 616d 655f 7665  .def get_name_ve
+00021690: 7273 696f 6e28 6473 3a20 7374 7229 202d  rsion(ds: str) -
+000216a0: 3e20 4469 6374 5b73 7472 2c20 416e 795d  > Dict[str, Any]
+000216b0: 3a0a 2020 2020 2222 220a 2020 2020 4769  :.    """.    Gi
+000216c0: 7665 6e20 6120 6e61 6d65 206c 696b 6520  ven a name like 
+000216d0: 226e 616d 655f 5f64 6576 5f5f 7630 2220  "name__dev__v0" 
+000216e0: 7265 7475 726e 7320 5b27 6e61 6d65 272c  returns ['name',
+000216f0: 2027 6465 7627 2c20 2776 3027 5d0a 2020   'dev', 'v0'].  
+00021700: 2020 3e3e 3e20 6765 745f 6e61 6d65 5f76    >>> get_name_v
+00021710: 6572 7369 6f6e 2827 6465 765f 5f6e 616d  ersion('dev__nam
+00021720: 655f 5f76 3027 290a 2020 2020 7b27 6e61  e__v0').    {'na
+00021730: 6d65 273a 2027 6465 765f 5f6e 616d 6527  me': 'dev__name'
+00021740: 2c20 2776 6572 7369 6f6e 273a 2030 7d0a  , 'version': 0}.
+00021750: 2020 2020 3e3e 3e20 6765 745f 6e61 6d65      >>> get_name
+00021760: 5f76 6572 7369 6f6e 2827 6e61 6d65 5f5f  _version('name__
+00021770: 7630 2729 0a20 2020 207b 276e 616d 6527  v0').    {'name'
+00021780: 3a20 276e 616d 6527 2c20 2776 6572 7369  : 'name', 'versi
+00021790: 6f6e 273a 2030 7d0a 2020 2020 3e3e 3e20  on': 0}.    >>> 
+000217a0: 6765 745f 6e61 6d65 5f76 6572 7369 6f6e  get_name_version
+000217b0: 2827 6465 765f 5f6e 616d 6527 290a 2020  ('dev__name').  
+000217c0: 2020 7b27 6e61 6d65 273a 2027 6465 765f    {'name': 'dev_
+000217d0: 5f6e 616d 6527 2c20 2776 6572 7369 6f6e  _name', 'version
+000217e0: 273a 204e 6f6e 657d 0a20 2020 203e 3e3e  ': None}.    >>>
+000217f0: 2067 6574 5f6e 616d 655f 7665 7273 696f   get_name_versio
+00021800: 6e28 276e 616d 6527 290a 2020 2020 7b27  n('name').    {'
+00021810: 6e61 6d65 273a 2027 6e61 6d65 272c 2027  name': 'name', '
+00021820: 7665 7273 696f 6e27 3a20 4e6f 6e65 7d0a  version': None}.
+00021830: 2020 2020 3e3e 3e20 6765 745f 6e61 6d65      >>> get_name
+00021840: 5f76 6572 7369 6f6e 2827 686f 7261 7269  _version('horari
+00021850: 6f5f 5f33 5f5f 7069 7065 2729 0a20 2020  o__3__pipe').   
+00021860: 207b 276e 616d 6527 3a20 2768 6f72 6172   {'name': 'horar
+00021870: 696f 5f5f 335f 5f70 6970 6527 2c20 2776  io__3__pipe', 'v
+00021880: 6572 7369 6f6e 273a 204e 6f6e 657d 0a20  ersion': None}. 
+00021890: 2020 203e 3e3e 2067 6574 5f6e 616d 655f     >>> get_name_
+000218a0: 7665 7273 696f 6e28 2768 6f72 6172 696f  version('horario
+000218b0: 5f5f 6368 6563 6b65 7227 290a 2020 2020  __checker').    
+000218c0: 7b27 6e61 6d65 273a 2027 686f 7261 7269  {'name': 'horari
+000218d0: 6f5f 5f63 6865 636b 6572 272c 2027 7665  o__checker', 've
+000218e0: 7273 696f 6e27 3a20 4e6f 6e65 7d0a 2020  rsion': None}.  
+000218f0: 2020 3e3e 3e20 6765 745f 6e61 6d65 5f76    >>> get_name_v
+00021900: 6572 7369 6f6e 2827 6465 765f 5f68 6f72  ersion('dev__hor
+00021910: 6172 696f 5f5f 6368 6563 6b65 7227 290a  ario__checker').
+00021920: 2020 2020 7b27 6e61 6d65 273a 2027 6465      {'name': 'de
+00021930: 765f 5f68 6f72 6172 696f 5f5f 6368 6563  v__horario__chec
+00021940: 6b65 7227 2c20 2776 6572 7369 6f6e 273a  ker', 'version':
+00021950: 204e 6f6e 657d 0a20 2020 203e 3e3e 2067   None}.    >>> g
+00021960: 6574 5f6e 616d 655f 7665 7273 696f 6e28  et_name_version(
+00021970: 2774 675f 5f64 4163 7469 7669 6461 6465  'tg__dActividade
+00021980: 735f 5f76 305f 7069 7065 5f33 3930 3727  s__v0_pipe_3907'
+00021990: 290a 2020 2020 7b27 6e61 6d65 273a 2027  ).    {'name': '
+000219a0: 7467 5f5f 6441 6374 6976 6964 6164 6573  tg__dActividades
+000219b0: 272c 2027 7665 7273 696f 6e27 3a20 307d  ', 'version': 0}
+000219c0: 0a20 2020 203e 3e3e 2067 6574 5f6e 616d  .    >>> get_nam
+000219d0: 655f 7665 7273 696f 6e28 2774 675f 5f64  e_version('tg__d
+000219e0: 4163 7469 7669 6461 6465 735f 5f76 615f  Actividades__va_
+000219f0: 7069 7065 5f33 3930 3727 290a 2020 2020  pipe_3907').    
+00021a00: 7b27 6e61 6d65 273a 2027 7467 5f5f 6441  {'name': 'tg__dA
+00021a10: 6374 6976 6964 6164 6573 5f5f 7661 5f70  ctividades__va_p
+00021a20: 6970 655f 3339 3037 272c 2027 7665 7273  ipe_3907', 'vers
+00021a30: 696f 6e27 3a20 4e6f 6e65 7d0a 2020 2020  ion': None}.    
+00021a40: 3e3e 3e20 6765 745f 6e61 6d65 5f76 6572  >>> get_name_ver
+00021a50: 7369 6f6e 2827 7467 5f5f 6f72 6967 696e  sion('tg__origin
+00021a60: 5f77 6f72 6b73 7061 6365 2e73 6861 7265  _workspace.share
+00021a70: 645f 6473 5f5f 7633 3930 3727 290a 2020  d_ds__v3907').  
+00021a80: 2020 7b27 6e61 6d65 273a 2027 7467 5f5f    {'name': 'tg__
+00021a90: 6f72 6967 696e 5f77 6f72 6b73 7061 6365  origin_workspace
+00021aa0: 2e73 6861 7265 645f 6473 272c 2027 7665  .shared_ds', 've
+00021ab0: 7273 696f 6e27 3a20 3339 3037 7d0a 2020  rsion': 3907}.  
+00021ac0: 2020 3e3e 3e20 6765 745f 6e61 6d65 5f76    >>> get_name_v
+00021ad0: 6572 7369 6f6e 2827 746d 7068 3865 6774  ersion('tmph8egt
+00021ae0: 6c5f 5f27 290a 2020 2020 7b27 6e61 6d65  l__').    {'name
+00021af0: 273a 2027 746d 7068 3865 6774 6c5f 5f27  ': 'tmph8egtl__'
+00021b00: 2c20 2776 6572 7369 6f6e 273a 204e 6f6e  , 'version': Non
+00021b10: 657d 0a20 2020 203e 3e3e 2067 6574 5f6e  e}.    >>> get_n
+00021b20: 616d 655f 7665 7273 696f 6e28 2774 6d70  ame_version('tmp
+00021b30: 6838 6567 746c 5f5f 3132 335f 5f27 290a  h8egtl__123__').
+00021b40: 2020 2020 7b27 6e61 6d65 273a 2027 746d      {'name': 'tm
+00021b50: 7068 3865 6774 6c5f 5f31 3233 5f5f 272c  ph8egtl__123__',
+00021b60: 2027 7665 7273 696f 6e27 3a20 4e6f 6e65   'version': None
+00021b70: 7d0a 2020 2020 3e3e 3e20 6765 745f 6e61  }.    >>> get_na
+00021b80: 6d65 5f76 6572 7369 6f6e 2827 6465 765f  me_version('dev_
+00021b90: 5f6e 616d 655f 5f76 3027 290a 2020 2020  _name__v0').    
+00021ba0: 7b27 6e61 6d65 273a 2027 6465 765f 5f6e  {'name': 'dev__n
+00021bb0: 616d 6527 2c20 2776 6572 7369 6f6e 273a  ame', 'version':
+00021bc0: 2030 7d0a 2020 2020 3e3e 3e20 6765 745f   0}.    >>> get_
+00021bd0: 6e61 6d65 5f76 6572 7369 6f6e 2827 6e61  name_version('na
+00021be0: 6d65 5f5f 7630 2729 0a20 2020 207b 276e  me__v0').    {'n
+00021bf0: 616d 6527 3a20 276e 616d 6527 2c20 2776  ame': 'name', 'v
+00021c00: 6572 7369 6f6e 273a 2030 7d0a 2020 2020  ersion': 0}.    
+00021c10: 3e3e 3e20 6765 745f 6e61 6d65 5f76 6572  >>> get_name_ver
+00021c20: 7369 6f6e 2827 6465 765f 5f6e 616d 6527  sion('dev__name'
+00021c30: 290a 2020 2020 7b27 6e61 6d65 273a 2027  ).    {'name': '
+00021c40: 6465 765f 5f6e 616d 6527 2c20 2776 6572  dev__name', 'ver
+00021c50: 7369 6f6e 273a 204e 6f6e 657d 0a20 2020  sion': None}.   
+00021c60: 203e 3e3e 2067 6574 5f6e 616d 655f 7665   >>> get_name_ve
+00021c70: 7273 696f 6e28 276e 616d 6527 290a 2020  rsion('name').  
+00021c80: 2020 7b27 6e61 6d65 273a 2027 6e61 6d65    {'name': 'name
+00021c90: 272c 2027 7665 7273 696f 6e27 3a20 4e6f  ', 'version': No
+00021ca0: 6e65 7d0a 2020 2020 3e3e 3e20 6765 745f  ne}.    >>> get_
+00021cb0: 6e61 6d65 5f76 6572 7369 6f6e 2827 686f  name_version('ho
+00021cc0: 7261 7269 6f5f 5f33 5f5f 7069 7065 2729  rario__3__pipe')
+00021cd0: 0a20 2020 207b 276e 616d 6527 3a20 2768  .    {'name': 'h
+00021ce0: 6f72 6172 696f 5f5f 335f 5f70 6970 6527  orario__3__pipe'
+00021cf0: 2c20 2776 6572 7369 6f6e 273a 204e 6f6e  , 'version': Non
+00021d00: 657d 0a20 2020 203e 3e3e 2067 6574 5f6e  e}.    >>> get_n
+00021d10: 616d 655f 7665 7273 696f 6e28 2768 6f72  ame_version('hor
+00021d20: 6172 696f 5f5f 6368 6563 6b65 7227 290a  ario__checker').
+00021d30: 2020 2020 7b27 6e61 6d65 273a 2027 686f      {'name': 'ho
+00021d40: 7261 7269 6f5f 5f63 6865 636b 6572 272c  rario__checker',
+00021d50: 2027 7665 7273 696f 6e27 3a20 4e6f 6e65   'version': None
+00021d60: 7d0a 2020 2020 3e3e 3e20 6765 745f 6e61  }.    >>> get_na
+00021d70: 6d65 5f76 6572 7369 6f6e 2827 6465 765f  me_version('dev_
+00021d80: 5f68 6f72 6172 696f 5f5f 6368 6563 6b65  _horario__checke
+00021d90: 7227 290a 2020 2020 7b27 6e61 6d65 273a  r').    {'name':
+00021da0: 2027 6465 765f 5f68 6f72 6172 696f 5f5f   'dev__horario__
+00021db0: 6368 6563 6b65 7227 2c20 2776 6572 7369  checker', 'versi
+00021dc0: 6f6e 273a 204e 6f6e 657d 0a20 2020 203e  on': None}.    >
+00021dd0: 3e3e 2067 6574 5f6e 616d 655f 7665 7273  >> get_name_vers
+00021de0: 696f 6e28 2774 675f 5f64 4163 7469 7669  ion('tg__dActivi
+00021df0: 6461 6465 735f 5f76 305f 7069 7065 5f33  dades__v0_pipe_3
+00021e00: 3930 3727 290a 2020 2020 7b27 6e61 6d65  907').    {'name
+00021e10: 273a 2027 7467 5f5f 6441 6374 6976 6964  ': 'tg__dActivid
+00021e20: 6164 6573 272c 2027 7665 7273 696f 6e27  ades', 'version'
+00021e30: 3a20 307d 0a20 2020 203e 3e3e 2067 6574  : 0}.    >>> get
+00021e40: 5f6e 616d 655f 7665 7273 696f 6e28 2774  _name_version('t
+00021e50: 675f 5f6f 7269 6769 6e5f 776f 726b 7370  g__origin_worksp
+00021e60: 6163 652e 7368 6172 6564 5f64 735f 5f76  ace.shared_ds__v
+00021e70: 3339 3037 2729 0a20 2020 207b 276e 616d  3907').    {'nam
+00021e80: 6527 3a20 2774 675f 5f6f 7269 6769 6e5f  e': 'tg__origin_
+00021e90: 776f 726b 7370 6163 652e 7368 6172 6564  workspace.shared
+00021ea0: 5f64 7327 2c20 2776 6572 7369 6f6e 273a  _ds', 'version':
+00021eb0: 2033 3930 377d 0a20 2020 203e 3e3e 2067   3907}.    >>> g
+00021ec0: 6574 5f6e 616d 655f 7665 7273 696f 6e28  et_name_version(
+00021ed0: 2774 6d70 6838 6567 746c 5f5f 2729 0a20  'tmph8egtl__'). 
+00021ee0: 2020 207b 276e 616d 6527 3a20 2774 6d70     {'name': 'tmp
+00021ef0: 6838 6567 746c 5f5f 272c 2027 7665 7273  h8egtl__', 'vers
+00021f00: 696f 6e27 3a20 4e6f 6e65 7d0a 2020 2020  ion': None}.    
+00021f10: 3e3e 3e20 6765 745f 6e61 6d65 5f76 6572  >>> get_name_ver
+00021f20: 7369 6f6e 2827 746d 7068 3865 6774 6c5f  sion('tmph8egtl_
+00021f30: 5f31 3233 5f5f 2729 0a20 2020 207b 276e  _123__').    {'n
+00021f40: 616d 6527 3a20 2774 6d70 6838 6567 746c  ame': 'tmph8egtl
+00021f50: 5f5f 3132 335f 5f27 2c20 2776 6572 7369  __123__', 'versi
+00021f60: 6f6e 273a 204e 6f6e 657d 0a20 2020 2022  on': None}.    "
+00021f70: 2222 0a20 2020 2074 6b20 3d20 6473 2e72  "".    tk = ds.r
+00021f80: 7370 6c69 7428 225f 5f22 2c20 3229 0a20  split("__", 2). 
+00021f90: 2020 2069 6620 6c65 6e28 746b 2920 3d3d     if len(tk) ==
+00021fa0: 2031 3a0a 2020 2020 2020 2020 7265 7475   1:.        retu
+00021fb0: 726e 207b 226e 616d 6522 3a20 746b 5b30  rn {"name": tk[0
+00021fc0: 5d2c 2022 7665 7273 696f 6e22 3a20 4e6f  ], "version": No
+00021fd0: 6e65 7d0a 2020 2020 656c 6966 206c 656e  ne}.    elif len
+00021fe0: 2874 6b29 203d 3d20 323a 0a20 2020 2020  (tk) == 2:.     
+00021ff0: 2020 2069 6620 6c65 6e28 746b 5b31 5d29     if len(tk[1])
+00022000: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00022010: 2074 6b5b 315d 5b30 5d20 3d3d 2022 7622   tk[1][0] == "v"
+00022020: 2061 6e64 2072 652e 6d61 7463 6828 225b   and re.match("[
+00022030: 302d 395d 2b24 222c 2074 6b5b 315d 5b31  0-9]+$", tk[1][1
+00022040: 3a5d 293a 0a20 2020 2020 2020 2020 2020  :]):.           
+00022050: 2020 2020 2072 6574 7572 6e20 7b22 6e61       return {"na
+00022060: 6d65 223a 2074 6b5b 305d 2c20 2276 6572  me": tk[0], "ver
+00022070: 7369 6f6e 223a 2069 6e74 2874 6b5b 315d  sion": int(tk[1]
+00022080: 5b31 3a5d 297d 0a20 2020 2020 2020 2020  [1:])}.         
+00022090: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000220a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000220b0: 7b22 6e61 6d65 223a 2074 6b5b 305d 202b  {"name": tk[0] +
+000220c0: 2022 5f5f 2220 2b20 746b 5b31 5d2c 2022   "__" + tk[1], "
+000220d0: 7665 7273 696f 6e22 3a20 4e6f 6e65 7d0a  version": None}.
+000220e0: 2020 2020 656c 6966 206c 656e 2874 6b29      elif len(tk)
+000220f0: 203d 3d20 3320 616e 6420 6c65 6e28 746b   == 3 and len(tk
+00022100: 5b32 5d29 3a0a 2020 2020 2020 2020 6966  [2]):.        if
+00022110: 2074 6b5b 325d 203d 3d20 2263 6865 636b   tk[2] == "check
+00022120: 6572 223a 0a20 2020 2020 2020 2020 2020  er":.           
+00022130: 2072 6574 7572 6e20 7b22 6e61 6d65 223a   return {"name":
+00022140: 2074 6b5b 305d 202b 2022 5f5f 2220 2b20   tk[0] + "__" + 
+00022150: 746b 5b31 5d20 2b20 225f 5f22 202b 2074  tk[1] + "__" + t
+00022160: 6b5b 325d 2c20 2276 6572 7369 6f6e 223a  k[2], "version":
+00022170: 204e 6f6e 657d 0a20 2020 2020 2020 2069   None}.        i
+00022180: 6620 746b 5b32 5d5b 305d 203d 3d20 2276  f tk[2][0] == "v
+00022190: 223a 0a20 2020 2020 2020 2020 2020 2070  ":.            p
+000221a0: 6172 7473 203d 2074 6b5b 325d 2e73 706c  arts = tk[2].spl
+000221b0: 6974 2822 5f22 290a 2020 2020 2020 2020  it("_").        
+000221c0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000221d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000221e0: 7b22 6e61 6d65 223a 2074 6b5b 305d 202b  {"name": tk[0] +
+000221f0: 2022 5f5f 2220 2b20 746b 5b31 5d2c 2022   "__" + tk[1], "
+00022200: 7665 7273 696f 6e22 3a20 696e 7428 7061  version": int(pa
+00022210: 7274 735b 305d 5b31 3a5d 297d 0a20 2020  rts[0][1:])}.   
+00022220: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00022230: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
+00022240: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00022250: 726e 207b 226e 616d 6522 3a20 746b 5b30  rn {"name": tk[0
+00022260: 5d20 2b20 225f 5f22 202b 2074 6b5b 315d  ] + "__" + tk[1]
+00022270: 202b 2022 5f5f 2220 2b20 746b 5b32 5d2c   + "__" + tk[2],
+00022280: 2022 7665 7273 696f 6e22 3a20 4e6f 6e65   "version": None
+00022290: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
+000222a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000222b0: 726e 207b 226e 616d 6522 3a20 225f 5f22  rn {"name": "__"
+000222c0: 2e6a 6f69 6e28 746b 5b30 3a5d 292c 2022  .join(tk[0:]), "
+000222d0: 7665 7273 696f 6e22 3a20 4e6f 6e65 7d0a  version": None}.
+000222e0: 0a20 2020 2072 6574 7572 6e20 7b22 6e61  .    return {"na
+000222f0: 6d65 223a 2064 732c 2022 7665 7273 696f  me": ds, "versio
+00022300: 6e22 3a20 4e6f 6e65 7d0a 0a0a 6465 6620  n": None}...def 
+00022310: 6765 745f 7265 736f 7572 6365 5f76 6572  get_resource_ver
+00022320: 7369 6f6e 7328 6461 7461 736f 7572 6365  sions(datasource
+00022330: 733a 204c 6973 745b 7374 725d 293a 0a20  s: List[str]):. 
+00022340: 2020 2022 2222 0a20 2020 2072 6574 7572     """.    retur
+00022350: 6e20 7468 6520 6c61 7465 7374 2076 6572  n the latest ver
+00022360: 7369 6f6e 2066 6f72 2061 6c6c 2074 6865  sion for all the
+00022370: 2064 6174 6173 6f75 7263 6573 0a20 2020   datasources.   
+00022380: 2022 2222 0a20 2020 2076 6572 7369 6f6e   """.    version
+00022390: 7320 3d20 7b7d 0a20 2020 2066 6f72 2078  s = {}.    for x
+000223a0: 2069 6e20 6461 7461 736f 7572 6365 733a   in datasources:
+000223b0: 0a20 2020 2020 2020 2074 203d 2067 6574  .        t = get
+000223c0: 5f6e 616d 655f 7665 7273 696f 6e28 7829  _name_version(x)
+000223d0: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
+000223e0: 745b 226e 616d 6522 5d0a 2020 2020 2020  t["name"].      
+000223f0: 2020 6966 2074 2e67 6574 2822 7665 7273    if t.get("vers
+00022400: 696f 6e22 2c20 4e6f 6e65 2920 6973 206e  ion", None) is n
+00022410: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00022420: 2020 2020 2076 6572 7369 6f6e 735b 6e61       versions[na
+00022430: 6d65 5d20 3d20 745b 2276 6572 7369 6f6e  me] = t["version
+00022440: 225d 0a20 2020 2072 6574 7572 6e20 7665  "].    return ve
+00022450: 7273 696f 6e73 0a0a 0a64 6566 2067 6574  rsions...def get
+00022460: 5f72 656d 6f74 655f 7265 736f 7572 6365  _remote_resource
+00022470: 5f6e 616d 655f 7769 7468 6f75 745f 7665  _name_without_ve
+00022480: 7273 696f 6e28 7265 6d6f 7465 5f72 6573  rsion(remote_res
+00022490: 6f75 7263 655f 6e61 6d65 3a20 7374 7229  ource_name: str)
+000224a0: 202d 3e20 7374 723a 0a20 2020 2022 2222   -> str:.    """
+000224b0: 0a20 2020 203e 3e3e 2067 6574 5f72 656d  .    >>> get_rem
+000224c0: 6f74 655f 7265 736f 7572 6365 5f6e 616d  ote_resource_nam
+000224d0: 655f 7769 7468 6f75 745f 7665 7273 696f  e_without_versio
+000224e0: 6e28 2272 5f5f 6461 7461 736f 7572 6365  n("r__datasource
+000224f0: 2229 0a20 2020 2027 725f 5f64 6174 6173  ").    'r__datas
+00022500: 6f75 7263 6527 0a20 2020 203e 3e3e 2067  ource'.    >>> g
+00022510: 6574 5f72 656d 6f74 655f 7265 736f 7572  et_remote_resour
+00022520: 6365 5f6e 616d 655f 7769 7468 6f75 745f  ce_name_without_
+00022530: 7665 7273 696f 6e28 2272 5f5f 6461 7461  version("r__data
+00022540: 736f 7572 6365 5f5f 7630 2229 0a20 2020  source__v0").   
+00022550: 2027 725f 5f64 6174 6173 6f75 7263 6527   'r__datasource'
+00022560: 0a20 2020 203e 3e3e 2067 6574 5f72 656d  .    >>> get_rem
+00022570: 6f74 655f 7265 736f 7572 6365 5f6e 616d  ote_resource_nam
+00022580: 655f 7769 7468 6f75 745f 7665 7273 696f  e_without_versio
+00022590: 6e28 2264 6174 6173 6f75 7263 6522 290a  n("datasource").
+000225a0: 2020 2020 2764 6174 6173 6f75 7263 6527      'datasource'
+000225b0: 0a20 2020 2022 2222 0a20 2020 2070 6172  .    """.    par
+000225c0: 7473 203d 2067 6574 5f6e 616d 655f 7665  ts = get_name_ve
+000225d0: 7273 696f 6e28 7265 6d6f 7465 5f72 6573  rsion(remote_res
+000225e0: 6f75 7263 655f 6e61 6d65 290a 2020 2020  ource_name).    
+000225f0: 7265 7475 726e 2070 6172 7473 5b22 6e61  return parts["na
+00022600: 6d65 225d 0a0a 0a64 6566 2067 6574 5f64  me"]...def get_d
+00022610: 6570 5f66 726f 6d5f 7261 775f 7461 626c  ep_from_raw_tabl
+00022620: 6573 2878 3a20 7374 7229 202d 3e20 7374  es(x: str) -> st
+00022630: 723a 0a20 2020 2022 2222 0a20 2020 2064  r:.    """.    d
+00022640: 6174 6173 6f75 7263 6573 204b 4559 2063  atasources KEY c
+00022650: 6f6d 6d61 6e64 2067 656e 6572 6174 6573  ommand generates
+00022660: 2074 6162 6c65 732c 2074 6869 7320 7472   tables, this tr
+00022670: 616e 7366 6f72 6d20 7468 6520 7573 6564  ansform the used
+00022680: 2074 6162 6c65 2077 6974 6820 7468 6520   table with the 
+00022690: 736f 7572 6365 2066 696c 650a 2020 2020  source file.    
+000226a0: 3e3e 3e20 6765 745f 6465 705f 6672 6f6d  >>> get_dep_from
+000226b0: 5f72 6177 5f74 6162 6c65 7328 2774 6573  _raw_tables('tes
+000226c0: 7427 290a 2020 2020 2774 6573 7427 0a20  t').    'test'. 
+000226d0: 2020 203e 3e3e 2067 6574 5f64 6570 5f66     >>> get_dep_f
+000226e0: 726f 6d5f 7261 775f 7461 626c 6573 2827  rom_raw_tables('
+000226f0: 7465 7374 5f6a 6f69 6e5f 6279 5f63 6f6c  test_join_by_col
+00022700: 756d 6e27 290a 2020 2020 2774 6573 7427  umn').    'test'
+00022710: 0a20 2020 2022 2222 0a0a 2020 2020 7472  .    """..    tr
+00022720: 793a 0a20 2020 2020 2020 2072 6574 7572  y:.        retur
+00022730: 6e20 785b 3a20 782e 696e 6465 7828 225f  n x[: x.index("_
+00022740: 6a6f 696e 5f62 795f 2229 5d0a 2020 2020  join_by_")].    
+00022750: 6578 6365 7074 2056 616c 7565 4572 726f  except ValueErro
+00022760: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
+00022770: 6e20 780a 0a0a 6465 6620 6372 6561 7465  n x...def create
+00022780: 5f64 6f77 6e73 7472 6561 6d5f 6465 7065  _downstream_depe
+00022790: 6e64 656e 6379 5f67 7261 7068 2864 6570  ndency_graph(dep
+000227a0: 656e 6465 6e63 795f 6772 6170 683a 2044  endency_graph: D
+000227b0: 6963 745b 7374 722c 2053 6574 5b73 7472  ict[str, Set[str
+000227c0: 5d5d 2c20 616c 6c5f 7265 736f 7572 6365  ]], all_resource
+000227d0: 733a 2044 6963 745b 7374 722c 2044 6963  s: Dict[str, Dic
+000227e0: 745b 7374 722c 2041 6e79 5d5d 293a 0a20  t[str, Any]]):. 
+000227f0: 2020 2022 2222 0a20 2020 2054 6869 7320     """.    This 
+00022800: 6675 6e63 7469 6f6e 2072 6576 6572 7365  function reverse
+00022810: 7320 7468 6520 6465 7065 6e64 656e 6379  s the dependency
+00022820: 2067 7261 7068 206f 6274 6169 6e65 6420   graph obtained 
+00022830: 6672 6f6d 2062 7569 6c64 5f67 7261 7068  from build_graph
+00022840: 2073 6f20 796f 7520 6861 7665 2064 6f77   so you have dow
+00022850: 6e73 7472 6561 6d20 6465 7065 6e64 656e  nstream dependen
+00022860: 6369 6573 2066 6f72 2065 6163 6820 6e6f  cies for each no
+00022870: 6465 2069 6e20 7468 6520 6772 6170 682e  de in the graph.
+00022880: 0a0a 2020 2020 4164 6469 7469 6f6e 616c  ..    Additional
+00022890: 6c79 2074 616b 6573 2069 6e74 6f20 6163  ly takes into ac
+000228a0: 636f 756e 7420 7461 7267 6574 5f64 6174  count target_dat
+000228b0: 6173 6f75 7263 6520 6f66 206d 6174 6572  asource of mater
+000228c0: 6961 6c69 7a65 6420 7669 6577 730a 2020  ialized views.  
+000228d0: 2020 2222 220a 2020 2020 646f 776e 7374    """.    downst
+000228e0: 7265 616d 5f64 6570 656e 6465 6e63 795f  ream_dependency_
+000228f0: 6772 6170 683a 2044 6963 745b 7374 722c  graph: Dict[str,
+00022900: 2053 6574 5b73 7472 5d5d 203d 207b 6e6f   Set[str]] = {no
+00022910: 6465 3a20 7365 7428 2920 666f 7220 6e6f  de: set() for no
+00022920: 6465 2069 6e20 6465 7065 6e64 656e 6379  de in dependency
+00022930: 5f67 7261 7068 7d0a 0a20 2020 2066 6f72  _graph}..    for
+00022940: 206e 6f64 652c 2064 6570 656e 6465 6e63   node, dependenc
+00022950: 6965 7320 696e 2064 6570 656e 6465 6e63  ies in dependenc
+00022960: 795f 6772 6170 682e 6974 656d 7328 293a  y_graph.items():
+00022970: 0a20 2020 2020 2020 2066 6f72 2064 6570  .        for dep
+00022980: 656e 6465 6e63 7920 696e 2064 6570 656e  endency in depen
+00022990: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+000229a0: 2020 2020 2069 6620 6465 7065 6e64 656e       if dependen
+000229b0: 6379 206e 6f74 2069 6e20 646f 776e 7374  cy not in downst
+000229c0: 7265 616d 5f64 6570 656e 6465 6e63 795f  ream_dependency_
+000229d0: 6772 6170 683a 0a20 2020 2020 2020 2020  graph:.         
+000229e0: 2020 2020 2020 2023 2061 2073 6861 7265         # a share
+000229f0: 6420 6461 7461 2073 6f75 7263 652c 2077  d data source, w
+00022a00: 6520 6361 6e20 736b 6970 2069 740a 2020  e can skip it.  
+00022a10: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00022a20: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+00022a30: 2020 2064 6f77 6e73 7472 6561 6d5f 6465     downstream_de
+00022a40: 7065 6e64 656e 6379 5f67 7261 7068 5b64  pendency_graph[d
+00022a50: 6570 656e 6465 6e63 795d 2e61 6464 286e  ependency].add(n
+00022a60: 6f64 6529 0a0a 2020 2020 666f 7220 6b65  ode)..    for ke
+00022a70: 7920 696e 2064 6963 7428 646f 776e 7374  y in dict(downst
+00022a80: 7265 616d 5f64 6570 656e 6465 6e63 795f  ream_dependency_
+00022a90: 6772 6170 6829 3a0a 2020 2020 2020 2020  graph):.        
+00022aa0: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
+00022ab0: 6520 3d20 6765 745f 7461 7267 6574 5f6d  e = get_target_m
+00022ac0: 6174 6572 6961 6c69 7a65 645f 6461 7461  aterialized_data
+00022ad0: 5f73 6f75 7263 655f 6e61 6d65 2861 6c6c  _source_name(all
+00022ae0: 5f72 6573 6f75 7263 6573 5b6b 6579 5d29  _resources[key])
+00022af0: 0a20 2020 2020 2020 2069 6620 7461 7267  .        if targ
+00022b00: 6574 5f64 6174 6173 6f75 7263 653a 0a20  et_datasource:. 
+00022b10: 2020 2020 2020 2020 2020 2064 6f77 6e73             downs
+00022b20: 7472 6561 6d5f 6465 7065 6e64 656e 6379  tream_dependency
+00022b30: 5f67 7261 7068 5b6b 6579 5d2e 7570 6461  _graph[key].upda
+00022b40: 7465 287b 7461 7267 6574 5f64 6174 6173  te({target_datas
+00022b50: 6f75 7263 657d 290a 2020 2020 2020 2020  ource}).        
+00022b60: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00022b70: 2020 2020 2020 2020 2064 6f77 6e73 7472           downstr
+00022b80: 6561 6d5f 6465 7065 6e64 656e 6379 5f67  eam_dependency_g
+00022b90: 7261 7068 5b74 6172 6765 745f 6461 7461  raph[target_data
+00022ba0: 736f 7572 6365 5d2e 7265 6d6f 7665 286b  source].remove(k
+00022bb0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+00022bc0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+00022bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022be0: 2070 6173 730a 0a20 2020 2072 6574 7572   pass..    retur
+00022bf0: 6e20 646f 776e 7374 7265 616d 5f64 6570  n downstream_dep
+00022c00: 656e 6465 6e63 795f 6772 6170 680a 0a0a  endency_graph...
+00022c10: 6465 6620 7570 6461 7465 5f64 6570 5f6d  def update_dep_m
+00022c20: 6170 5f72 6563 7572 7369 7665 6c79 280a  ap_recursively(.
+00022c30: 2020 2020 6465 705f 6d61 703a 2044 6963      dep_map: Dic
+00022c40: 745b 7374 722c 2053 6574 5b73 7472 5d5d  t[str, Set[str]]
+00022c50: 2c0a 2020 2020 646f 776e 7374 7265 616d  ,.    downstream
+00022c60: 5f64 6570 5f6d 6170 3a20 4469 6374 5b73  _dep_map: Dict[s
+00022c70: 7472 2c20 5365 745b 7374 725d 5d2c 0a20  tr, Set[str]],. 
+00022c80: 2020 2061 6c6c 5f72 6573 6f75 7263 6573     all_resources
+00022c90: 3a20 4469 6374 5b73 7472 2c20 4469 6374  : Dict[str, Dict
+00022ca0: 5b73 7472 2c20 416e 795d 5d2c 0a20 2020  [str, Any]],.   
+00022cb0: 2074 6f5f 7275 6e3a 2044 6963 745b 7374   to_run: Dict[st
+00022cc0: 722c 2044 6963 745b 7374 722c 2041 6e79  r, Dict[str, Any
+00022cd0: 5d5d 2c0a 2020 2020 6465 705f 6d61 705f  ]],.    dep_map_
+00022ce0: 6b65 7973 3a20 4c69 7374 5b73 7472 5d2c  keys: List[str],
+00022cf0: 0a20 2020 206b 6579 3a20 4f70 7469 6f6e  .    key: Option
+00022d00: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+00022d10: 2020 2020 7669 7369 7465 643a 204f 7074      visited: Opt
+00022d20: 696f 6e61 6c5b 4c69 7374 5b73 7472 5d5d  ional[List[str]]
+00022d30: 203d 204e 6f6e 652c 0a29 3a0a 2020 2020   = None,.):.    
+00022d40: 2222 220a 2020 2020 4769 7665 6e20 6120  """.    Given a 
+00022d50: 646f 776e 7374 7265 616d 5f64 6570 5f6d  downstream_dep_m
+00022d60: 6170 206f 6274 6169 6e65 6420 6672 6f6d  ap obtained from
+00022d70: 2063 7265 6174 655f 646f 776e 7374 7265   create_downstre
+00022d80: 616d 5f64 6570 656e 6465 6e63 795f 6772  am_dependency_gr
+00022d90: 6170 6820 7468 6973 2066 756e 6374 696f  aph this functio
+00022da0: 6e20 7570 6461 7465 7320 6561 6368 206e  n updates each n
+00022db0: 6f64 6520 7265 6375 7273 6976 656c 7920  ode recursively 
+00022dc0: 746f 2063 6f6d 706c 6574 6520 7468 6520  to complete the 
+00022dd0: 646f 776e 7374 7265 616d 2064 6570 656e  downstream depen
+00022de0: 6465 6e63 7920 6772 6170 6820 666f 7220  dency graph for 
+00022df0: 6561 6368 206e 6f64 650a 2020 2020 2222  each node.    ""
+00022e00: 220a 2020 2020 6966 206e 6f74 2076 6973  ".    if not vis
+00022e10: 6974 6564 3a0a 2020 2020 2020 2020 7669  ited:.        vi
+00022e20: 7369 7465 6420 3d20 6c69 7374 2829 0a20  sited = list(). 
+00022e30: 2020 2069 6620 6e6f 7420 6b65 7920 616e     if not key an
+00022e40: 6420 6c65 6e28 6465 705f 6d61 705f 6b65  d len(dep_map_ke
+00022e50: 7973 2920 3d3d 2030 3a0a 2020 2020 2020  ys) == 0:.      
+00022e60: 2020 7265 7475 726e 0a20 2020 2069 6620    return.    if 
+00022e70: 6e6f 7420 6b65 793a 0a20 2020 2020 2020  not key:.       
+00022e80: 206b 6579 203d 2064 6570 5f6d 6170 5f6b   key = dep_map_k
+00022e90: 6579 732e 706f 7028 290a 2020 2020 6966  eys.pop().    if
+00022ea0: 206b 6579 206e 6f74 2069 6e20 6465 705f   key not in dep_
+00022eb0: 6d61 703a 0a20 2020 2020 2020 2064 6570  map:.        dep
+00022ec0: 5f6d 6170 5b6b 6579 5d20 3d20 7365 7428  _map[key] = set(
+00022ed0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00022ee0: 2020 2020 7669 7369 7465 642e 6170 7065      visited.appe
+00022ef0: 6e64 286b 6579 290a 2020 2020 2020 2020  nd(key).        
+00022f00: 7265 7475 726e 0a0a 2020 2020 666f 7220  return..    for 
+00022f10: 6465 7020 696e 2064 6f77 6e73 7472 6561  dep in downstrea
+00022f20: 6d5f 6465 705f 6d61 702e 6765 7428 6b65  m_dep_map.get(ke
+00022f30: 792c 207b 7d29 3a0a 2020 2020 2020 2020  y, {}):.        
+00022f40: 6966 2064 6570 206e 6f74 2069 6e20 646f  if dep not in do
+00022f50: 776e 7374 7265 616d 5f64 6570 5f6d 6170  wnstream_dep_map
+00022f60: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00022f70: 6e74 696e 7565 0a20 2020 2020 2020 2074  ntinue.        t
+00022f80: 6f5f 7275 6e5b 6465 705d 203d 2061 6c6c  o_run[dep] = all
+00022f90: 5f72 6573 6f75 7263 6573 2e67 6574 2864  _resources.get(d
+00022fa0: 6570 2c20 7b7d 290a 2020 2020 2020 2020  ep, {}).        
+00022fb0: 7570 6461 7465 5f64 6570 5f6d 6170 5f72  update_dep_map_r
+00022fc0: 6563 7572 7369 7665 6c79 280a 2020 2020  ecursively(.    
+00022fd0: 2020 2020 2020 2020 6465 705f 6d61 702c          dep_map,
+00022fe0: 2064 6f77 6e73 7472 6561 6d5f 6465 705f   downstream_dep_
+00022ff0: 6d61 702c 2061 6c6c 5f72 6573 6f75 7263  map, all_resourc
+00023000: 6573 2c20 746f 5f72 756e 2c20 6465 705f  es, to_run, dep_
+00023010: 6d61 705f 6b65 7973 2c20 6b65 793d 6465  map_keys, key=de
+00023020: 702c 2076 6973 6974 6564 3d76 6973 6974  p, visited=visit
+00023030: 6564 0a20 2020 2020 2020 2029 0a20 2020  ed.        ).   
+00023040: 2020 2020 2064 6570 5f6d 6170 5b6b 6579       dep_map[key
+00023050: 5d2e 7570 6461 7465 2864 6f77 6e73 7472  ].update(downstr
+00023060: 6561 6d5f 6465 705f 6d61 705b 6465 705d  eam_dep_map[dep]
+00023070: 290a 2020 2020 2020 2020 6465 705f 6d61  ).        dep_ma
+00023080: 705b 6b65 795d 2e75 7064 6174 6528 7b64  p[key].update({d
+00023090: 6570 7d29 0a20 2020 2020 2020 2074 7279  ep}).        try
+000230a0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
+000230b0: 705f 6d61 705b 6b65 795d 2e72 656d 6f76  p_map[key].remov
+000230c0: 6528 6b65 7929 0a20 2020 2020 2020 2065  e(key).        e
+000230d0: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
+000230e0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+000230f0: 0a0a 2020 2020 746f 5f72 756e 5b6b 6579  ..    to_run[key
+00023100: 5d20 3d20 616c 6c5f 7265 736f 7572 6365  ] = all_resource
+00023110: 732e 6765 7428 6b65 792c 207b 7d29 0a20  s.get(key, {}). 
+00023120: 2020 2075 7064 6174 655f 6465 705f 6d61     update_dep_ma
+00023130: 705f 7265 6375 7273 6976 656c 7928 0a20  p_recursively(. 
+00023140: 2020 2020 2020 2064 6570 5f6d 6170 2c20         dep_map, 
+00023150: 646f 776e 7374 7265 616d 5f64 6570 5f6d  downstream_dep_m
+00023160: 6170 2c20 616c 6c5f 7265 736f 7572 6365  ap, all_resource
+00023170: 732c 2074 6f5f 7275 6e2c 2064 6570 5f6d  s, to_run, dep_m
+00023180: 6170 5f6b 6579 732c 206b 6579 3d4e 6f6e  ap_keys, key=Non
+00023190: 652c 2076 6973 6974 6564 3d76 6973 6974  e, visited=visit
+000231a0: 6564 0a20 2020 2029 0a0a 0a64 6566 2067  ed.    )...def g
+000231b0: 656e 6572 6174 655f 666f 726b 646f 776e  enerate_forkdown
+000231c0: 7374 7265 616d 5f67 7261 7068 280a 2020  stream_graph(.  
+000231d0: 2020 616c 6c5f 6465 705f 6d61 703a 2044    all_dep_map: D
+000231e0: 6963 745b 7374 722c 2053 6574 5b73 7472  ict[str, Set[str
+000231f0: 5d5d 2c0a 2020 2020 616c 6c5f 7265 736f  ]],.    all_reso
+00023200: 7572 6365 733a 2044 6963 745b 7374 722c  urces: Dict[str,
+00023210: 2044 6963 745b 7374 722c 2041 6e79 5d5d   Dict[str, Any]]
+00023220: 2c0a 2020 2020 746f 5f72 756e 3a20 4469  ,.    to_run: Di
+00023230: 6374 5b73 7472 2c20 4469 6374 5b73 7472  ct[str, Dict[str
+00023240: 2c20 416e 795d 5d2c 0a20 2020 2064 6570  , Any]],.    dep
+00023250: 5f6d 6170 5f6b 6579 733a 204c 6973 745b  _map_keys: List[
+00023260: 7374 725d 2c0a 2920 2d3e 2054 7570 6c65  str],.) -> Tuple
+00023270: 5b44 6963 745b 7374 722c 2053 6574 5b73  [Dict[str, Set[s
+00023280: 7472 5d5d 2c20 4469 6374 5b73 7472 2c20  tr]], Dict[str, 
+00023290: 4469 6374 5b73 7472 2c20 416e 795d 5d5d  Dict[str, Any]]]
+000232a0: 3a0a 2020 2020 2222 220a 2020 2020 5468  :.    """.    Th
+000232b0: 6973 2066 756e 6374 696f 6e20 666f 7220  is function for 
+000232c0: 6120 6769 7665 6e20 6772 6170 6820 6f66  a given graph of
+000232d0: 2064 6570 656e 6465 6e63 6965 7320 6672   dependencies fr
+000232e0: 6f6d 206c 6566 7420 746f 2072 6967 6874  om left to right
+000232f0: 2e20 4974 2077 696c 6c20 6765 6e65 7261  . It will genera
+00023300: 7465 2061 206e 6577 2067 7261 7068 2077  te a new graph w
+00023310: 6974 6820 7468 6520 6465 7065 6e64 656e  ith the dependen
+00023320: 6369 6573 2066 726f 6d20 7269 6768 7420  cies from right 
+00023330: 746f 206c 6566 742c 2062 7574 2074 616b  to left, but tak
+00023340: 696e 6720 696e 746f 2061 6363 6f75 6e74  ing into account
+00023350: 2074 6861 7420 6576 656e 2069 6620 736f   that even if so
+00023360: 6d65 206e 6f64 6573 2061 7265 206e 6f74  me nodes are not
+00023370: 2069 6e73 6964 6520 746f 5f72 756e 2c20   inside to_run, 
+00023380: 7468 6579 2061 7265 2073 7469 6c6c 2064  they are still d
+00023390: 6570 656e 6465 6e63 6965 7320 7468 6174  ependencies that
+000233a0: 206e 6565 6420 746f 2062 6520 6465 706c   need to be depl
+000233b0: 6f79 6564 2e0a 0a20 2020 203e 3e3e 2064  oyed...    >>> d
+000233c0: 6570 732c 205f 203d 2067 656e 6572 6174  eps, _ = generat
+000233d0: 655f 666f 726b 646f 776e 7374 7265 616d  e_forkdownstream
+000233e0: 5f67 7261 7068 280a 2020 2020 2e2e 2e20  _graph(.    ... 
+000233f0: 2020 2020 7b0a 2020 2020 2e2e 2e20 2020      {.    ...   
+00023400: 2020 2020 2020 2761 273a 207b 2762 277d        'a': {'b'}
+00023410: 2c0a 2020 2020 2e2e 2e20 2020 2020 2020  ,.    ...       
+00023420: 2020 2762 273a 207b 2763 277d 2c0a 2020    'b': {'c'},.  
+00023430: 2020 2e2e 2e20 2020 2020 2020 2020 2763    ...         'c
+00023440: 273a 2073 6574 2829 2c0a 2020 2020 2e2e  ': set(),.    ..
+00023450: 2e20 2020 2020 7d2c 0a20 2020 202e 2e2e  .     },.    ...
+00023460: 2020 2020 207b 0a20 2020 202e 2e2e 2020       {.    ...  
+00023470: 2020 2020 2020 2027 6127 3a20 7b27 7265         'a': {'re
+00023480: 736f 7572 6365 5f6e 616d 6527 3a20 2761  source_name': 'a
+00023490: 277d 2c0a 2020 2020 2e2e 2e20 2020 2020  '},.    ...     
+000234a0: 2020 2020 2762 273a 207b 2772 6573 6f75      'b': {'resou
+000234b0: 7263 655f 6e61 6d65 273a 2027 6227 2c20  rce_name': 'b', 
+000234c0: 276e 6f64 6573 273a 205b 7b27 7061 7261  'nodes': [{'para
+000234d0: 6d73 273a 207b 2774 7970 6527 3a20 276d  ms': {'type': 'm
+000234e0: 6174 6572 6961 6c69 7a65 6427 2c20 2764  aterialized', 'd
+000234f0: 6174 6173 6f75 7263 6527 3a20 2763 277d  atasource': 'c'}
+00023500: 7d5d 207d 2c0a 2020 2020 2e2e 2e20 2020  }] },.    ...   
+00023510: 2020 2020 2020 2763 273a 207b 2772 6573        'c': {'res
+00023520: 6f75 7263 655f 6e61 6d65 273a 2027 6327  ource_name': 'c'
+00023530: 7d2c 0a20 2020 202e 2e2e 2020 2020 207d  },.    ...     }
+00023540: 2c0a 2020 2020 2e2e 2e20 2020 2020 7b0a  ,.    ...     {.
+00023550: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
+00023560: 2761 273a 207b 2772 6573 6f75 7263 655f  'a': {'resource_
+00023570: 6e61 6d65 273a 2027 6127 7d2c 0a20 2020  name': 'a'},.   
+00023580: 202e 2e2e 2020 2020 207d 2c0a 2020 2020   ...     },.    
+00023590: 2e2e 2e20 2020 2020 5b27 6127 2c20 2762  ...     ['a', 'b
+000235a0: 272c 2027 6327 5d2c 0a20 2020 202e 2e2e  ', 'c'],.    ...
+000235b0: 2029 0a20 2020 203e 3e3e 207b 6b3a 2073   ).    >>> {k: s
+000235c0: 6f72 7465 6428 7629 2066 6f72 206b 2c20  orted(v) for k, 
+000235d0: 7620 696e 2064 6570 732e 6974 656d 7328  v in deps.items(
+000235e0: 297d 0a20 2020 207b 2763 273a 205b 5d2c  )}.    {'c': [],
+000235f0: 2027 6227 3a20 5b27 6127 2c20 2763 275d   'b': ['a', 'c']
+00023600: 2c20 2761 273a 205b 5d7d 0a0a 2020 2020  , 'a': []}..    
+00023610: 3e3e 3e20 6465 7073 2c20 5f20 3d20 6765  >>> deps, _ = ge
+00023620: 6e65 7261 7465 5f66 6f72 6b64 6f77 6e73  nerate_forkdowns
+00023630: 7472 6561 6d5f 6772 6170 6828 0a20 2020  tream_graph(.   
+00023640: 202e 2e2e 2020 2020 207b 0a20 2020 202e   ...     {.    .
+00023650: 2e2e 2020 2020 2020 2020 2027 6127 3a20  ..         'a': 
+00023660: 7b27 6227 7d2c 0a20 2020 202e 2e2e 2020  {'b'},.    ...  
+00023670: 2020 2020 2020 2027 6227 3a20 7b27 6327         'b': {'c'
+00023680: 7d2c 0a20 2020 202e 2e2e 2020 2020 2020  },.    ...      
+00023690: 2020 2027 6327 3a20 7365 7428 292c 0a20     'c': set(),. 
+000236a0: 2020 202e 2e2e 2020 2020 207d 2c0a 2020     ...     },.  
+000236b0: 2020 2e2e 2e20 2020 2020 7b0a 2020 2020    ...     {.    
+000236c0: 2e2e 2e20 2020 2020 2020 2020 2761 273a  ...         'a':
+000236d0: 207b 2772 6573 6f75 7263 655f 6e61 6d65   {'resource_name
+000236e0: 273a 2027 6127 7d2c 0a20 2020 202e 2e2e  ': 'a'},.    ...
+000236f0: 2020 2020 2020 2020 2027 6227 3a20 7b27           'b': {'
+00023700: 7265 736f 7572 6365 5f6e 616d 6527 3a20  resource_name': 
+00023710: 2762 272c 2027 6e6f 6465 7327 3a20 5b7b  'b', 'nodes': [{
+00023720: 2770 6172 616d 7327 3a20 7b27 7479 7065  'params': {'type
+00023730: 273a 2027 6d61 7465 7269 616c 697a 6564  ': 'materialized
+00023740: 272c 2027 6461 7461 736f 7572 6365 273a  ', 'datasource':
+00023750: 2027 6327 7d7d 5d20 7d2c 0a20 2020 202e   'c'}}] },.    .
+00023760: 2e2e 2020 2020 2020 2020 2027 6327 3a20  ..         'c': 
+00023770: 7b27 7265 736f 7572 6365 5f6e 616d 6527  {'resource_name'
+00023780: 3a20 2763 277d 2c0a 2020 2020 2e2e 2e20  : 'c'},.    ... 
+00023790: 2020 2020 7d2c 0a20 2020 202e 2e2e 2020      },.    ...  
+000237a0: 2020 207b 0a20 2020 202e 2e2e 2020 2020     {.    ...    
+000237b0: 2020 2020 2027 6227 3a20 7b27 7265 736f       'b': {'reso
+000237c0: 7572 6365 5f6e 616d 6527 3a20 2762 277d  urce_name': 'b'}
+000237d0: 2c0a 2020 2020 2e2e 2e20 2020 2020 7d2c  ,.    ...     },
+000237e0: 0a20 2020 202e 2e2e 2020 2020 205b 2761  .    ...     ['a
+000237f0: 272c 2027 6227 2c20 2763 275d 2c0a 2020  ', 'b', 'c'],.  
+00023800: 2020 2e2e 2e20 290a 2020 2020 3e3e 3e20    ... ).    >>> 
+00023810: 7b6b 3a20 736f 7274 6564 2876 2920 666f  {k: sorted(v) fo
+00023820: 7220 6b2c 2076 2069 6e20 6465 7073 2e69  r k, v in deps.i
+00023830: 7465 6d73 2829 7d0a 2020 2020 7b27 6327  tems()}.    {'c'
+00023840: 3a20 5b5d 2c20 2762 273a 205b 2761 272c  : [], 'b': ['a',
+00023850: 2027 6327 5d2c 2027 6127 3a20 5b5d 7d0a   'c'], 'a': []}.
+00023860: 0a20 2020 203e 3e3e 2064 6570 732c 205f  .    >>> deps, _
+00023870: 203d 2067 656e 6572 6174 655f 666f 726b   = generate_fork
+00023880: 646f 776e 7374 7265 616d 5f67 7261 7068  downstream_graph
+00023890: 280a 2020 2020 2e2e 2e20 2020 2020 7b0a  (.    ...     {.
+000238a0: 2020 2020 2e2e 2e20 2020 2020 2020 2020      ...         
+000238b0: 276d 6967 7261 7465 645f 5f61 273a 207b  'migrated__a': {
+000238c0: 2761 277d 2c0a 2020 2020 2e2e 2e20 2020  'a'},.    ...   
+000238d0: 2020 2020 2020 2761 273a 207b 2762 277d        'a': {'b'}
+000238e0: 2c0a 2020 2020 2e2e 2e20 2020 2020 2020  ,.    ...       
+000238f0: 2020 2762 273a 207b 2763 277d 2c0a 2020    'b': {'c'},.  
+00023900: 2020 2e2e 2e20 2020 2020 2020 2020 2763    ...         'c
+00023910: 273a 2073 6574 2829 2c0a 2020 2020 2e2e  ': set(),.    ..
+00023920: 2e20 2020 2020 7d2c 0a20 2020 202e 2e2e  .     },.    ...
+00023930: 2020 2020 207b 0a20 2020 202e 2e2e 2020       {.    ...  
+00023940: 2020 2020 2020 2027 6d69 6772 6174 6564         'migrated
+00023950: 5f5f 6127 3a20 7b27 7265 736f 7572 6365  __a': {'resource
+00023960: 5f6e 616d 6527 3a20 276d 6967 7261 7465  _name': 'migrate
+00023970: 645f 5f61 272c 2027 6e6f 6465 7327 3a20  d__a', 'nodes': 
+00023980: 5b7b 2770 6172 616d 7327 3a20 7b27 7479  [{'params': {'ty
+00023990: 7065 273a 2027 6d61 7465 7269 616c 697a  pe': 'materializ
+000239a0: 6564 272c 2027 6461 7461 736f 7572 6365  ed', 'datasource
+000239b0: 273a 2027 6127 7d7d 5d7d 2c0a 2020 2020  ': 'a'}}]},.    
+000239c0: 2e2e 2e20 2020 2020 2020 2020 2761 273a  ...         'a':
+000239d0: 207b 2772 6573 6f75 7263 655f 6e61 6d65   {'resource_name
+000239e0: 273a 2027 6127 7d2c 0a20 2020 202e 2e2e  ': 'a'},.    ...
+000239f0: 2020 2020 2020 2020 2027 6227 3a20 7b27           'b': {'
+00023a00: 7265 736f 7572 6365 5f6e 616d 6527 3a20  resource_name': 
+00023a10: 2762 272c 2027 6e6f 6465 7327 3a20 5b7b  'b', 'nodes': [{
+00023a20: 2770 6172 616d 7327 3a20 7b27 7479 7065  'params': {'type
+00023a30: 273a 2027 6d61 7465 7269 616c 697a 6564  ': 'materialized
+00023a40: 272c 2027 6461 7461 736f 7572 6365 273a  ', 'datasource':
+00023a50: 2027 6327 7d7d 5d20 7d2c 0a20 2020 202e   'c'}}] },.    .
+00023a60: 2e2e 2020 2020 2020 2020 2027 6327 3a20  ..         'c': 
+00023a70: 7b27 7265 736f 7572 6365 5f6e 616d 6527  {'resource_name'
+00023a80: 3a20 2763 277d 2c0a 2020 2020 2e2e 2e20  : 'c'},.    ... 
+00023a90: 2020 2020 7d2c 0a20 2020 202e 2e2e 2020      },.    ...  
+00023aa0: 2020 207b 0a20 2020 202e 2e2e 2020 2020     {.    ...    
+00023ab0: 2020 2020 2027 6d69 6772 6174 6564 5f5f       'migrated__
+00023ac0: 6127 3a20 7b27 7265 736f 7572 6365 5f6e  a': {'resource_n
+00023ad0: 616d 6527 3a20 276d 6967 7261 7465 645f  ame': 'migrated_
+00023ae0: 5f61 277d 2c0a 2020 2020 2e2e 2e20 2020  _a'},.    ...   
+00023af0: 2020 2020 2020 2761 273a 207b 2772 6573        'a': {'res
+00023b00: 6f75 7263 655f 6e61 6d65 273a 2027 6127  ource_name': 'a'
+00023b10: 7d2c 0a20 2020 202e 2e2e 2020 2020 207d  },.    ...     }
+00023b20: 2c0a 2020 2020 2e2e 2e20 2020 2020 5b27  ,.    ...     ['
+00023b30: 6d69 6772 6174 6564 5f61 272c 2027 6127  migrated_a', 'a'
+00023b40: 2c20 2762 272c 2027 6327 5d2c 0a20 2020  , 'b', 'c'],.   
+00023b50: 202e 2e2e 2029 0a20 2020 203e 3e3e 207b   ... ).    >>> {
+00023b60: 6b3a 2073 6f72 7465 6428 7629 2066 6f72  k: sorted(v) for
+00023b70: 206b 2c20 7620 696e 2064 6570 732e 6974   k, v in deps.it
+00023b80: 656d 7328 297d 0a20 2020 207b 2763 273a  ems()}.    {'c':
+00023b90: 205b 5d2c 2027 6227 3a20 5b27 6127 2c20   [], 'b': ['a', 
+00023ba0: 2763 275d 2c20 2761 273a 205b 5d2c 2027  'c'], 'a': [], '
+00023bb0: 6d69 6772 6174 6564 5f61 273a 205b 5d7d  migrated_a': []}
+00023bc0: 0a20 2020 2022 2222 0a20 2020 2064 6f77  .    """.    dow
+00023bd0: 6e73 7472 6561 6d5f 6465 705f 6d61 7020  nstream_dep_map 
+00023be0: 3d20 6372 6561 7465 5f64 6f77 6e73 7472  = create_downstr
+00023bf0: 6561 6d5f 6465 7065 6e64 656e 6379 5f67  eam_dependency_g
+00023c00: 7261 7068 2861 6c6c 5f64 6570 5f6d 6170  raph(all_dep_map
+00023c10: 2c20 616c 6c5f 7265 736f 7572 6365 7329  , all_resources)
+00023c20: 0a20 2020 206e 6577 5f64 6570 5f6d 6170  .    new_dep_map
+00023c30: 3a20 4469 6374 5b73 7472 2c20 5365 745b  : Dict[str, Set[
+00023c40: 7374 725d 5d20 3d20 7b7d 0a20 2020 206e  str]] = {}.    n
+00023c50: 6577 5f74 6f5f 7275 6e20 3d20 6465 6570  ew_to_run = deep
+00023c60: 636f 7079 2874 6f5f 7275 6e29 0a20 2020  copy(to_run).   
+00023c70: 2075 7064 6174 655f 6465 705f 6d61 705f   update_dep_map_
+00023c80: 7265 6375 7273 6976 656c 7928 6e65 775f  recursively(new_
+00023c90: 6465 705f 6d61 702c 2064 6f77 6e73 7472  dep_map, downstr
+00023ca0: 6561 6d5f 6465 705f 6d61 702c 2061 6c6c  eam_dep_map, all
+00023cb0: 5f72 6573 6f75 7263 6573 2c20 6e65 775f  _resources, new_
+00023cc0: 746f 5f72 756e 2c20 6465 705f 6d61 705f  to_run, dep_map_
+00023cd0: 6b65 7973 290a 2020 2020 7265 7475 726e  keys).    return
+00023ce0: 206e 6577 5f64 6570 5f6d 6170 2c20 6e65   new_dep_map, ne
+00023cf0: 775f 746f 5f72 756e 0a0a 0a40 6461 7461  w_to_run...@data
+00023d00: 636c 6173 730a 636c 6173 7320 4772 6170  class.class Grap
+00023d10: 6844 6570 656e 6465 6e63 6965 733a 0a20  hDependencies:. 
+00023d20: 2020 2022 2222 0a20 2020 2054 6869 7320     """.    This 
+00023d30: 636c 6173 7320 6973 2075 7365 6420 746f  class is used to
+00023d40: 2073 746f 7265 2074 6865 2064 6570 656e   store the depen
+00023d50: 6465 6e63 6965 7320 6772 6170 6820 616e  dencies graph an
+00023d60: 6420 7468 6520 7265 736f 7572 6365 7320  d the resources 
+00023d70: 7468 6174 2061 7265 2067 6f69 6e67 2074  that are going t
+00023d80: 6f20 6265 2064 6570 6c6f 7965 640a 2020  o be deployed.  
+00023d90: 2020 2222 220a 0a20 2020 2064 6570 5f6d    """..    dep_m
+00023da0: 6170 3a20 4469 6374 5b73 7472 2c20 5365  ap: Dict[str, Se
+00023db0: 745b 7374 725d 5d0a 2020 2020 746f 5f72  t[str]].    to_r
+00023dc0: 756e 3a20 4469 6374 5b73 7472 2c20 4469  un: Dict[str, Di
+00023dd0: 6374 5b73 7472 2c20 416e 795d 5d0a 0a20  ct[str, Any]].. 
+00023de0: 2020 2023 2054 6865 2073 616d 6520 6173     # The same as
+00023df0: 2061 626f 7665 2062 7574 2066 6f72 2074   above but for t
+00023e00: 6865 2077 686f 6c65 2070 726f 6a65 6374  he whole project
+00023e10: 2c20 6e6f 7420 6a75 7374 2074 6865 2072  , not just the r
+00023e20: 6573 6f75 7263 6573 2061 6666 6563 7465  esources affecte
+00023e30: 6420 6279 2074 6865 2063 7572 7265 6e74  d by the current
+00023e40: 2064 6570 6c6f 796d 656e 740a 2020 2020   deployment.    
+00023e50: 616c 6c5f 6465 705f 6d61 703a 2044 6963  all_dep_map: Dic
+00023e60: 745b 7374 722c 2053 6574 5b73 7472 5d5d  t[str, Set[str]]
+00023e70: 0a20 2020 2061 6c6c 5f72 6573 6f75 7263  .    all_resourc
+00023e80: 6573 3a20 4469 6374 5b73 7472 2c20 4469  es: Dict[str, Di
+00023e90: 6374 5b73 7472 2c20 416e 795d 5d0a 0a0a  ct[str, Any]]...
+00023ea0: 6173 796e 6320 6465 6620 6275 696c 645f  async def build_
+00023eb0: 6772 6170 6828 0a20 2020 2066 696c 656e  graph(.    filen
+00023ec0: 616d 6573 3a20 4974 6572 6162 6c65 5b73  ames: Iterable[s
+00023ed0: 7472 5d2c 0a20 2020 2074 625f 636c 6965  tr],.    tb_clie
+00023ee0: 6e74 3a20 5469 6e79 422c 0a20 2020 2064  nt: TinyB,.    d
+00023ef0: 6972 5f70 6174 683a 204f 7074 696f 6e61  ir_path: Optiona
+00023f00: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
+00023f10: 2020 2072 6573 6f75 7263 655f 7665 7273     resource_vers
+00023f20: 696f 6e73 3d4e 6f6e 652c 0a20 2020 2077  ions=None,.    w
+00023f30: 6f72 6b73 7061 6365 5f6d 6170 3a20 4f70  orkspace_map: Op
+00023f40: 7469 6f6e 616c 5b44 6963 745d 203d 204e  tional[Dict] = N
+00023f50: 6f6e 652c 0a20 2020 2070 726f 6365 7373  one,.    process
+00023f60: 5f64 6570 656e 6465 6e63 6965 733a 2062  _dependencies: b
+00023f70: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00023f80: 2076 6572 626f 7365 3a20 626f 6f6c 203d   verbose: bool =
+00023f90: 2046 616c 7365 2c0a 2020 2020 736b 6970   False,.    skip
+00023fa0: 5f63 6f6e 6e65 6374 6f72 733a 2062 6f6f  _connectors: boo
+00023fb0: 6c20 3d20 4661 6c73 652c 0a20 2020 2077  l = False,.    w
+00023fc0: 6f72 6b73 7061 6365 5f6c 6962 5f70 6174  orkspace_lib_pat
+00023fd0: 6873 3a20 4f70 7469 6f6e 616c 5b4c 6973  hs: Optional[Lis
+00023fe0: 745b 5475 706c 655b 7374 722c 2073 7472  t[Tuple[str, str
+00023ff0: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
+00024000: 6375 7272 656e 745f 7773 3a20 4f70 7469  current_ws: Opti
+00024010: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
+00024020: 6e79 5d5d 203d 204e 6f6e 652c 0a20 2020  ny]] = None,.   
+00024030: 2063 6861 6e67 6564 3a20 4f70 7469 6f6e   changed: Option
+00024040: 616c 5b44 6963 745b 7374 722c 2041 6e79  al[Dict[str, Any
+00024050: 5d5d 203d 204e 6f6e 652c 0a20 2020 206f  ]] = None,.    o
+00024060: 6e6c 795f 6368 616e 6765 733a 2062 6f6f  nly_changes: boo
+00024070: 6c20 3d20 4661 6c73 652c 0a20 2020 2066  l = False,.    f
+00024080: 6f72 6b5f 646f 776e 7374 7265 616d 3a20  ork_downstream: 
+00024090: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+000240a0: 2046 616c 7365 2c0a 2020 2020 6973 5f69   False,.    is_i
+000240b0: 6e74 6572 6e61 6c3a 204f 7074 696f 6e61  nternal: Optiona
+000240c0: 6c5b 626f 6f6c 5d20 3d20 4661 6c73 652c  l[bool] = False,
+000240d0: 0a29 202d 3e20 4772 6170 6844 6570 656e  .) -> GraphDepen
+000240e0: 6465 6e63 6965 733a 0a20 2020 2022 2222  dencies:.    """
+000240f0: 0a20 2020 2054 6869 7320 6d65 7468 6f64  .    This method
+00024100: 2077 696c 6c20 6765 6e65 7261 7465 2061   will generate a
+00024110: 2064 6570 656e 6465 6e63 7920 6772 6170   dependency grap
+00024120: 6820 666f 7220 7468 6520 6769 7665 6e20  h for the given 
+00024130: 6669 6c65 732e 2049 7420 7769 6c6c 2061  files. It will a
+00024140: 6c73 6f20 7265 7475 726e 2061 206d 6170  lso return a map
+00024150: 206f 6620 616c 6c20 7468 6520 7265 736f   of all the reso
+00024160: 7572 6365 7320 7468 6174 2061 7265 2067  urces that are g
+00024170: 6f69 6e67 2074 6f20 6265 2064 6570 6c6f  oing to be deplo
+00024180: 7965 642e 0a20 2020 2042 7920 6465 6661  yed..    By defa
+00024190: 756c 7420 6974 2077 696c 6c20 6765 6e65  ult it will gene
+000241a0: 7261 7465 2074 6865 2067 7261 7068 2066  rate the graph f
+000241b0: 726f 6d20 6c65 6674 2074 6f20 7269 6768  rom left to righ
+000241c0: 742c 2062 7574 2069 6620 666f 726b 2d64  t, but if fork-d
+000241d0: 6f77 6e73 7472 6561 6d2c 2069 7420 7769  ownstream, it wi
+000241e0: 6c6c 2067 656e 6572 6174 6520 7468 6520  ll generate the 
+000241f0: 6772 6170 6820 6672 6f6d 2072 6967 6874  graph from right
+00024200: 2074 6f20 6c65 6674 2e0a 2020 2020 2222   to left..    ""
+00024210: 220a 2020 2020 746f 5f72 756e 3a20 4469  ".    to_run: Di
+00024220: 6374 5b73 7472 2c20 416e 795d 203d 207b  ct[str, Any] = {
+00024230: 7d0a 2020 2020 6465 7073 3a20 4c69 7374  }.    deps: List
+00024240: 5b73 7472 5d20 3d20 5b5d 0a20 2020 2064  [str] = [].    d
+00024250: 6570 5f6d 6170 3a20 4469 6374 5b73 7472  ep_map: Dict[str
+00024260: 2c20 416e 795d 203d 207b 7d0a 2020 2020  , Any] = {}.    
+00024270: 656d 6265 6464 6564 5f64 6174 6173 6f75  embedded_datasou
+00024280: 7263 6573 203d 207b 7d0a 2020 2020 6966  rces = {}.    if
+00024290: 206e 6f74 2077 6f72 6b73 7061 6365 5f6d   not workspace_m
+000242a0: 6170 3a0a 2020 2020 2020 2020 776f 726b  ap:.        work
+000242b0: 7370 6163 655f 6d61 7020 3d20 7b7d 0a0a  space_map = {}..
+000242c0: 2020 2020 2320 5468 6573 6520 6469 6374      # These dict
+000242d0: 696f 6e61 7269 6573 2061 7265 2075 7365  ionaries are use
+000242e0: 6420 746f 2073 746f 7265 2061 6c6c 2074  d to store all t
+000242f0: 6865 2072 6573 6f75 7263 6573 2061 6e64  he resources and
+00024300: 2074 6865 7265 2064 6570 656e 6465 6e63   there dependenc
+00024310: 6965 7320 666f 7220 7468 6520 7768 6f6c  ies for the whol
+00024320: 6520 7072 6f6a 6563 740a 2020 2020 2320  e project.    # 
+00024330: 5468 6973 2069 7320 7573 6564 2066 6f72  This is used for
+00024340: 2074 6865 2064 6f77 6e73 7472 6561 6d20   the downstream 
+00024350: 6465 7065 6e64 656e 6379 2067 7261 7068  dependency graph
+00024360: 0a20 2020 2061 6c6c 5f64 6570 5f6d 6170  .    all_dep_map
+00024370: 3a20 4469 6374 5b73 7472 2c20 5365 745b  : Dict[str, Set[
+00024380: 7374 725d 5d20 3d20 7b7d 0a20 2020 2061  str]] = {}.    a
+00024390: 6c6c 5f72 6573 6f75 7263 6573 3a20 4469  ll_resources: Di
+000243a0: 6374 5b73 7472 2c20 4469 6374 5b73 7472  ct[str, Dict[str
+000243b0: 2c20 416e 795d 5d20 3d20 7b7d 0a0a 2020  , Any]] = {}..  
+000243c0: 2020 6966 2064 6972 5f70 6174 6820 6973    if dir_path is
+000243d0: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
+000243e0: 6972 5f70 6174 6820 3d20 6f73 2e67 6574  ir_path = os.get
+000243f0: 6377 6428 290a 0a20 2020 2023 2057 6865  cwd()..    # Whe
+00024400: 6e20 7573 696e 6720 666f 726b 2d64 6f77  n using fork-dow
+00024410: 6e73 7472 6561 6d20 6f72 202d 2d6f 6e6c  nstream or --onl
+00024420: 792d 6368 616e 6765 732c 2077 6520 6e65  y-changes, we ne
+00024430: 6564 2074 6f20 6765 6e65 7261 7465 2061  ed to generate a
+00024440: 6c6c 2074 6865 2067 7261 7068 206f 6620  ll the graph of 
+00024450: 616c 6c20 7468 6520 7265 736f 7572 6365  all the resource
+00024460: 7320 616e 6420 7468 6569 7220 6465 7065  s and their depe
+00024470: 6e64 656e 6369 6573 0a20 2020 2023 2054  ndencies.    # T
+00024480: 6869 7320 7761 7920 7765 2063 616e 2061  his way we can a
+00024490: 6464 206d 6f72 6520 7265 736f 7572 6365  dd more resource
+000244a0: 7320 696e 746f 2074 6865 2074 6f5f 7275  s into the to_ru
+000244b0: 6e20 6469 6374 696f 6e61 7279 2069 6620  n dictionary if 
+000244c0: 6e65 6564 6564 2e0a 2020 2020 6966 2070  needed..    if p
+000244d0: 726f 6365 7373 5f64 6570 656e 6465 6e63  rocess_dependenc
+000244e0: 6965 7320 616e 6420 6f6e 6c79 5f63 6861  ies and only_cha
+000244f0: 6e67 6573 3a0a 2020 2020 2020 2020 616c  nges:.        al
+00024500: 6c5f 6465 7065 6e64 656e 6369 6573 5f67  l_dependencies_g
+00024510: 7261 7068 203d 2061 7761 6974 2062 7569  raph = await bui
+00024520: 6c64 5f67 7261 7068 280a 2020 2020 2020  ld_graph(.      
+00024530: 2020 2020 2020 6765 745f 7072 6f6a 6563        get_projec
+00024540: 745f 6669 6c65 6e61 6d65 7328 6469 725f  t_filenames(dir_
+00024550: 7061 7468 292c 0a20 2020 2020 2020 2020  path),.         
+00024560: 2020 2074 625f 636c 6965 6e74 2c0a 2020     tb_client,.  
+00024570: 2020 2020 2020 2020 2020 6469 725f 7061            dir_pa
+00024580: 7468 3d64 6972 5f70 6174 682c 0a20 2020  th=dir_path,.   
+00024590: 2020 2020 2020 2020 2070 726f 6365 7373           process
+000245a0: 5f64 6570 656e 6465 6e63 6965 733d 5472  _dependencies=Tr
+000245b0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+000245c0: 7265 736f 7572 6365 5f76 6572 7369 6f6e  resource_version
+000245d0: 733d 7265 736f 7572 6365 5f76 6572 7369  s=resource_versi
+000245e0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+000245f0: 2077 6f72 6b73 7061 6365 5f6d 6170 3d77   workspace_map=w
+00024600: 6f72 6b73 7061 6365 5f6d 6170 2c0a 2020  orkspace_map,.  
+00024610: 2020 2020 2020 2020 2020 736b 6970 5f63            skip_c
+00024620: 6f6e 6e65 6374 6f72 733d 5472 7565 2c0a  onnectors=True,.
+00024630: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00024640: 7370 6163 655f 6c69 625f 7061 7468 733d  space_lib_paths=
+00024650: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
+00024660: 7468 732c 0a20 2020 2020 2020 2020 2020  ths,.           
+00024670: 2063 7572 7265 6e74 5f77 733d 6375 7272   current_ws=curr
+00024680: 656e 745f 7773 2c0a 2020 2020 2020 2020  ent_ws,.        
+00024690: 2020 2020 6368 616e 6765 643d 4e6f 6e65      changed=None
+000246a0: 2c0a 2020 2020 2020 2020 2020 2020 6f6e  ,.            on
+000246b0: 6c79 5f63 6861 6e67 6573 3d46 616c 7365  ly_changes=False
+000246c0: 2c0a 2020 2020 2020 2020 2020 2020 6973  ,.            is
+000246d0: 5f69 6e74 6572 6e61 6c3d 6973 5f69 6e74  _internal=is_int
+000246e0: 6572 6e61 6c2c 0a20 2020 2020 2020 2029  ernal,.        )
+000246f0: 0a20 2020 2020 2020 2061 6c6c 5f64 6570  .        all_dep
+00024700: 5f6d 6170 203d 2061 6c6c 5f64 6570 656e  _map = all_depen
+00024710: 6465 6e63 6965 735f 6772 6170 682e 6465  dencies_graph.de
+00024720: 705f 6d61 700a 2020 2020 2020 2020 616c  p_map.        al
+00024730: 6c5f 7265 736f 7572 6365 7320 3d20 616c  l_resources = al
+00024740: 6c5f 6465 7065 6e64 656e 6369 6573 5f67  l_dependencies_g
+00024750: 7261 7068 2e74 6f5f 7275 6e0a 0a20 2020  raph.to_run..   
+00024760: 2061 7379 6e63 2064 6566 2070 726f 6365   async def proce
+00024770: 7373 280a 2020 2020 2020 2020 6669 6c65  ss(.        file
+00024780: 6e61 6d65 3a20 7374 722c 0a20 2020 2020  name: str,.     
+00024790: 2020 2064 6570 733a 204c 6973 745b 7374     deps: List[st
+000247a0: 725d 2c0a 2020 2020 2020 2020 6465 705f  r],.        dep_
+000247b0: 6d61 703a 2044 6963 745b 7374 722c 2041  map: Dict[str, A
+000247c0: 6e79 5d2c 0a20 2020 2020 2020 2074 6f5f  ny],.        to_
+000247d0: 7275 6e3a 2044 6963 745b 7374 722c 2041  run: Dict[str, A
+000247e0: 6e79 5d2c 0a20 2020 2020 2020 2077 6f72  ny],.        wor
+000247f0: 6b73 7061 6365 5f6c 6962 5f70 6174 6873  kspace_lib_paths
+00024800: 3a20 4f70 7469 6f6e 616c 5b4c 6973 745b  : Optional[List[
+00024810: 5475 706c 655b 7374 722c 2073 7472 5d5d  Tuple[str, str]]
+00024820: 5d2c 0a20 2020 2029 3a0a 2020 2020 2020  ],.    ):.      
+00024830: 2020 6e61 6d65 2c20 6b69 6e64 203d 2066    name, kind = f
+00024840: 696c 656e 616d 652e 7273 706c 6974 2822  ilename.rsplit("
+00024850: 2e22 2c20 3129 0a0a 2020 2020 2020 2020  .", 1)..        
+00024860: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00024870: 2072 6573 203d 2061 7761 6974 2070 726f   res = await pro
+00024880: 6365 7373 5f66 696c 6528 0a20 2020 2020  cess_file(.     
+00024890: 2020 2020 2020 2020 2020 2066 696c 656e             filen
+000248a0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+000248b0: 2020 2020 2074 625f 636c 6965 6e74 2c0a       tb_client,.
+000248c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000248d0: 7265 736f 7572 6365 5f76 6572 7369 6f6e  resource_version
+000248e0: 733d 7265 736f 7572 6365 5f76 6572 7369  s=resource_versi
+000248f0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00024900: 2020 2020 2073 6b69 705f 636f 6e6e 6563       skip_connec
+00024910: 746f 7273 3d73 6b69 705f 636f 6e6e 6563  tors=skip_connec
+00024920: 746f 7273 2c0a 2020 2020 2020 2020 2020  tors,.          
+00024930: 2020 2020 2020 776f 726b 7370 6163 655f        workspace_
+00024940: 6d61 703d 776f 726b 7370 6163 655f 6d61  map=workspace_ma
+00024950: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+00024960: 2020 2077 6f72 6b73 7061 6365 5f6c 6962     workspace_lib
+00024970: 5f70 6174 6873 3d77 6f72 6b73 7061 6365  _paths=workspace
+00024980: 5f6c 6962 5f70 6174 6873 2c0a 2020 2020  _lib_paths,.    
+00024990: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+000249a0: 656e 745f 7773 3d63 7572 7265 6e74 5f77  ent_ws=current_w
+000249b0: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+000249c0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+000249d0: 636c 6963 6b2e 436c 6963 6b45 7863 6570  click.ClickExcep
+000249e0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+000249f0: 2020 2020 2020 2072 6169 7365 2065 0a20         raise e. 
+00024a00: 2020 2020 2020 2065 7863 6570 7420 496e         except In
+00024a10: 636c 7564 6546 696c 654e 6f74 466f 756e  cludeFileNotFoun
+00024a20: 6445 7863 6570 7469 6f6e 2061 7320 653a  dException as e:
+00024a30: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00024a40: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
+00024a50: 6365 7074 696f 6e28 4665 6564 6261 636b  ception(Feedback
+00024a60: 4d61 6e61 6765 722e 6572 726f 725f 6465  Manager.error_de
+00024a70: 6c65 7465 645f 696e 636c 7564 6528 696e  leted_include(in
+00024a80: 636c 7564 655f 6669 6c65 3d73 7472 2865  clude_file=str(e
+00024a90: 292c 2066 696c 656e 616d 653d 6669 6c65  ), filename=file
+00024aa0: 6e61 6d65 2929 0a20 2020 2020 2020 2065  name)).        e
+00024ab0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00024ac0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00024ad0: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+00024ae0: 6963 6b45 7863 6570 7469 6f6e 2873 7472  ickException(str
+00024af0: 2865 2929 0a0a 2020 2020 2020 2020 666f  (e))..        fo
+00024b00: 7220 7220 696e 2072 6573 3a0a 2020 2020  r r in res:.    
+00024b10: 2020 2020 2020 2020 666e 203d 2072 5b22          fn = r["
+00024b20: 7265 736f 7572 6365 5f6e 616d 6522 5d0a  resource_name"].
+00024b30: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00024b40: 6861 6e67 6564 2061 6e64 2066 6e20 696e  hanged and fn in
+00024b50: 2063 6861 6e67 6564 2061 6e64 2028 6e6f   changed and (no
+00024b60: 7420 6368 616e 6765 645b 666e 5d20 6f72  t changed[fn] or
+00024b70: 2063 6861 6e67 6564 5b66 6e5d 2069 6e20   changed[fn] in 
+00024b80: 5b22 7368 6172 6564 222c 2022 7265 6d6f  ["shared", "remo
+00024b90: 7465 225d 293a 0a20 2020 2020 2020 2020  te"]):.         
+00024ba0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00024bb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00024bc0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00024bd0: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
+00024be0: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
+00024bf0: 2020 616e 6420 722e 6765 7428 2272 6573    and r.get("res
+00024c00: 6f75 7263 6522 2c20 2222 2920 3d3d 2022  ource", "") == "
+00024c10: 7069 7065 7322 0a20 2020 2020 2020 2020  pipes".         
+00024c20: 2020 2020 2020 2061 6e64 2061 6e79 285b         and any([
+00024c30: 2265 6e67 696e 6522 2069 6e20 782e 6765  "engine" in x.ge
+00024c40: 7428 2270 6172 616d 7322 2c20 7b7d 2920  t("params", {}) 
+00024c50: 666f 7220 7820 696e 2072 2e67 6574 2822  for x in r.get("
+00024c60: 6e6f 6465 7322 2c20 5b5d 295d 290a 2020  nodes", [])]).  
+00024c70: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+00024c80: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00024c90: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
+00024ca0: 6365 7074 696f 6e28 4665 6564 6261 636b  ception(Feedback
+00024cb0: 4d61 6e61 6765 722e 6572 726f 725f 666f  Manager.error_fo
+00024cc0: 726b 646f 776e 7374 7265 616d 5f70 6970  rkdownstream_pip
+00024cd0: 6573 5f77 6974 685f 656e 6769 6e65 2870  es_with_engine(p
+00024ce0: 6970 653d 666e 2929 0a0a 2020 2020 2020  ipe=fn))..      
+00024cf0: 2020 2020 2020 746f 5f72 756e 5b66 6e5d        to_run[fn]
+00024d00: 203d 2072 0a20 2020 2020 2020 2020 2020   = r.           
+00024d10: 2066 696c 655f 6465 7073 203d 2072 2e67   file_deps = r.g
+00024d20: 6574 2822 6465 7073 222c 205b 5d29 0a20  et("deps", []). 
+00024d30: 2020 2020 2020 2020 2020 2064 6570 7320             deps 
+00024d40: 2b3d 2066 696c 655f 6465 7073 0a20 2020  += file_deps.   
+00024d50: 2020 2020 2020 2020 2023 2063 616c 6375           # calcu
+00024d60: 6c61 7465 2061 6e64 206c 6f6f 6b20 666f  late and look fo
+00024d70: 7220 6465 7073 0a20 2020 2020 2020 2020  r deps.         
+00024d80: 2020 2064 6570 5f6c 6973 7420 3d20 5b5d     dep_list = []
+00024d90: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00024da0: 2078 2069 6e20 6669 6c65 5f64 6570 733a   x in file_deps:
+00024db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024dc0: 2069 6620 7820 6e6f 7420 696e 2049 4e54   if x not in INT
+00024dd0: 4552 4e41 4c5f 5441 424c 4553 206f 7220  ERNAL_TABLES or 
+00024de0: 6973 5f69 6e74 6572 6e61 6c3a 0a20 2020  is_internal:.   
+00024df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024e00: 2066 2c20 6473 203d 2066 696e 645f 6669   f, ds = find_fi
+00024e10: 6c65 5f62 795f 6e61 6d65 2864 6972 5f70  le_by_name(dir_p
+00024e20: 6174 682c 2078 2c20 7665 7262 6f73 652c  ath, x, verbose,
+00024e30: 2077 6f72 6b73 7061 6365 5f6c 6962 5f70   workspace_lib_p
+00024e40: 6174 6873 3d77 6f72 6b73 7061 6365 5f6c  aths=workspace_l
+00024e50: 6962 5f70 6174 6873 2c20 7265 736f 7572  ib_paths, resour
+00024e60: 6365 3d72 290a 2020 2020 2020 2020 2020  ce=r).          
+00024e70: 2020 2020 2020 2020 2020 6966 2066 3a0a            if f:.
+00024e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024e90: 2020 2020 2020 2020 6465 705f 6c69 7374          dep_list
+00024ea0: 2e61 7070 656e 6428 662e 7273 706c 6974  .append(f.rsplit
+00024eb0: 2822 2e22 2c20 3129 5b30 5d29 0a20 2020  (".", 1)[0]).   
+00024ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024ed0: 2069 6620 6473 3a0a 2020 2020 2020 2020   if ds:.        
+00024ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024ef0: 6473 5f66 6e20 3d20 6473 5b22 7265 736f  ds_fn = ds["reso
+00024f00: 7572 6365 5f6e 616d 6522 5d0a 2020 2020  urce_name"].    
 00024f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024f20: 2020 2020 2020 2065 7863 6570 7420 5661         except Va
-00024f30: 6c75 6545 7272 6f72 3a0a 2020 2020 2020  lueError:.      
-00024f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024f50: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-00024f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024f70: 2020 2065 6d62 6564 6465 645f 6461 7461     embedded_data
-00024f80: 736f 7572 6365 735b 785d 203d 2074 6f5f  sources[x] = to_
-00024f90: 7275 6e5b 6473 5f66 6e5d 0a20 2020 2020  run[ds_fn].     
-00024fa0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00024fb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00024fc0: 2020 2020 2020 2020 2020 2020 2065 5f64               e_d
-00024fd0: 7320 3d20 656d 6265 6464 6564 5f64 6174  s = embedded_dat
-00024fe0: 6173 6f75 7263 6573 2e67 6574 2878 2c20  asources.get(x, 
-00024ff0: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
-00025000: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00025010: 2065 5f64 733a 0a20 2020 2020 2020 2020   e_ds:.         
-00025020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025030: 2020 2064 6570 5f6c 6973 742e 6170 7065     dep_list.appe
-00025040: 6e64 2865 5f64 735b 2272 6573 6f75 7263  nd(e_ds["resourc
-00025050: 655f 6e61 6d65 225d 290a 0a20 2020 2020  e_name"])..     
-00025060: 2020 2020 2020 2023 2049 6e20 6361 7365         # In case
-00025070: 2074 6865 2064 6174 6173 6f75 7263 6520   the datasource 
-00025080: 6973 2074 6f20 6265 2073 6861 7265 6420  is to be shared 
-00025090: 616e 6420 7765 2068 6176 6520 6d61 7070  and we have mapp
-000250a0: 696e 672c 206c 6574 2773 2072 6570 6c61  ing, let's repla
-000250b0: 6365 2074 6865 206e 616d 650a 2020 2020  ce the name.    
-000250c0: 2020 2020 2020 2020 6966 2022 7368 6172          if "shar
-000250d0: 6564 5f77 6974 6822 2069 6e20 7220 616e  ed_with" in r an
-000250e0: 6420 776f 726b 7370 6163 655f 6d61 703a  d workspace_map:
+00024f20: 2020 2020 7072 6576 203d 2074 6f5f 7275      prev = to_ru
+00024f30: 6e2e 6765 7428 6473 5f66 6e2c 207b 7d29  n.get(ds_fn, {})
+00024f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024f50: 2020 2020 2020 2020 2074 6f5f 7275 6e5b           to_run[
+00024f60: 6473 5f66 6e5d 203d 2064 6565 7063 6f70  ds_fn] = deepcop
+00024f70: 7928 7229 0a20 2020 2020 2020 2020 2020  y(r).           
+00024f80: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00024f90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024fa0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00024fb0: 5f72 756e 5b64 735f 666e 5d5b 2264 6570  _run[ds_fn]["dep
+00024fc0: 7322 5d20 3d20 6c69 7374 280a 2020 2020  s"] = list(.    
+00024fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024fe0: 2020 2020 2020 2020 2020 2020 7365 7428              set(
+00024ff0: 746f 5f72 756e 5b64 735f 666e 5d2e 6765  to_run[ds_fn].ge
+00025000: 7428 2264 6570 7322 2c20 5b5d 2920 2b20  t("deps", []) + 
+00025010: 7072 6576 2e67 6574 2822 6465 7073 222c  prev.get("deps",
+00025020: 205b 5d29 202b 205b 666e 5d29 0a20 2020   []) + [fn]).   
+00025030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025040: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00025050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025060: 2020 2065 7863 6570 7420 5661 6c75 6545     except ValueE
+00025070: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00025080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025090: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+000250a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000250b0: 6d62 6564 6465 645f 6461 7461 736f 7572  mbedded_datasour
+000250c0: 6365 735b 785d 203d 2074 6f5f 7275 6e5b  ces[x] = to_run[
+000250d0: 6473 5f66 6e5d 0a20 2020 2020 2020 2020  ds_fn].         
+000250e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
 000250f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025100: 206d 6170 7065 645f 776f 726b 7370 6163   mapped_workspac
-00025110: 6573 3a20 4c69 7374 5b73 7472 5d20 3d20  es: List[str] = 
-00025120: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
-00025130: 2020 2066 6f72 2073 6861 7265 645f 7769     for shared_wi
-00025140: 7468 2069 6e20 725b 2273 6861 7265 645f  th in r["shared_
-00025150: 7769 7468 225d 3a0a 2020 2020 2020 2020  with"]:.        
-00025160: 2020 2020 2020 2020 2020 2020 6d61 7070              mapp
-00025170: 6564 5f77 6f72 6b73 7061 6365 732e 6170  ed_workspaces.ap
-00025180: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
-00025190: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-000251a0: 726b 7370 6163 655f 6d61 702e 6765 7428  rkspace_map.get(
-000251b0: 7368 6172 6564 5f77 6974 6829 0a20 2020  shared_with).   
-000251c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000251d0: 2020 2020 2069 6620 776f 726b 7370 6163       if workspac
-000251e0: 655f 6d61 702e 6765 7428 7368 6172 6564  e_map.get(shared
-000251f0: 5f77 6974 682c 204e 6f6e 6529 2069 7320  _with, None) is 
-00025200: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
-00025210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025220: 2065 6c73 6520 7368 6172 6564 5f77 6974   else shared_wit
-00025230: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-00025240: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00025250: 2020 2020 2020 2020 725b 2273 6861 7265          r["share
-00025260: 645f 7769 7468 225d 203d 206d 6170 7065  d_with"] = mappe
-00025270: 645f 776f 726b 7370 6163 6573 0a0a 2020  d_workspaces..  
-00025280: 2020 2020 2020 2020 2020 6465 705f 6d61            dep_ma
-00025290: 705b 666e 5d20 3d20 7365 7428 6465 705f  p[fn] = set(dep_
-000252a0: 6c69 7374 290a 2020 2020 2020 2020 7265  list).        re
-000252b0: 7475 726e 206f 732e 7061 7468 2e62 6173  turn os.path.bas
-000252c0: 656e 616d 6528 6e61 6d65 290a 0a20 2020  ename(name)..   
-000252d0: 2070 726f 6365 7373 6564 203d 2073 6574   processed = set
-000252e0: 2829 0a0a 2020 2020 6173 796e 6320 6465  ()..    async de
-000252f0: 6620 6765 745f 7072 6f63 6573 7365 6428  f get_processed(
-00025300: 6669 6c65 6e61 6d65 733a 2049 7465 7261  filenames: Itera
-00025310: 626c 655b 7374 725d 293a 0a20 2020 2020  ble[str]):.     
-00025320: 2020 2066 6f72 2066 696c 656e 616d 6520     for filename 
-00025330: 696e 2066 696c 656e 616d 6573 3a0a 2020  in filenames:.  
-00025340: 2020 2020 2020 2020 2020 2320 6a75 7374            # just
-00025350: 2070 726f 6365 7373 2063 6861 6e67 6564   process changed
-00025360: 2066 696c 656e 616d 6573 2028 7462 2064   filenames (tb d
-00025370: 6570 6c6f 7920 616e 6420 2d2d 6f6e 6c79  eploy and --only
-00025380: 2d63 6861 6e67 6573 290a 2020 2020 2020  -changes).      
-00025390: 2020 2020 2020 6966 2063 6861 6e67 6564        if changed
-000253a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000253b0: 2020 7265 736f 7572 6365 203d 2050 6174    resource = Pat
-000253c0: 6828 6669 6c65 6e61 6d65 292e 7265 736f  h(filename).reso
-000253d0: 6c76 6528 292e 7374 656d 0a20 2020 2020  lve().stem.     
-000253e0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-000253f0: 736f 7572 6365 2069 6e20 6368 616e 6765  source in change
-00025400: 6420 616e 6420 286e 6f74 2063 6861 6e67  d and (not chang
-00025410: 6564 5b72 6573 6f75 7263 655d 206f 7220  ed[resource] or 
-00025420: 6368 616e 6765 645b 7265 736f 7572 6365  changed[resource
-00025430: 5d20 696e 205b 2273 6861 7265 6422 2c20  ] in ["shared", 
-00025440: 2272 656d 6f74 6522 5d29 3a0a 2020 2020  "remote"]):.    
-00025450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025460: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00025470: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
-00025480: 6973 6469 7228 6669 6c65 6e61 6d65 293a  isdir(filename):
-00025490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000254a0: 2061 7761 6974 2067 6574 5f70 726f 6365   await get_proce
-000254b0: 7373 6564 2866 696c 656e 616d 6573 3d67  ssed(filenames=g
-000254c0: 6574 5f70 726f 6a65 6374 5f66 696c 656e  et_project_filen
-000254d0: 616d 6573 2866 696c 656e 616d 6529 290a  ames(filename)).
-000254e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000254f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00025500: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00025510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025520: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
-00025530: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
-00025540: 6f5f 7072 6f63 6573 7369 6e67 5f66 696c  o_processing_fil
-00025550: 6528 6669 6c65 6e61 6d65 3d66 696c 656e  e(filename=filen
-00025560: 616d 6529 290a 0a20 2020 2020 2020 2020  ame))..         
-00025570: 2020 2020 2020 2069 6620 222e 696e 636c         if ".incl
-00025580: 2220 696e 2066 696c 656e 616d 653a 0a20  " in filename:. 
-00025590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000255a0: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
-000255b0: 6564 6261 636b 4d61 6e61 6765 722e 7761  edbackManager.wa
-000255c0: 726e 696e 675f 736b 6970 7069 6e67 5f69  rning_skipping_i
-000255d0: 6e63 6c75 6465 5f66 696c 6528 6669 6c65  nclude_file(file
-000255e0: 3d66 696c 656e 616d 6529 290a 0a20 2020  =filename))..   
-000255f0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-00025600: 6520 3d20 6177 6169 7420 7072 6f63 6573  e = await proces
-00025610: 7328 6669 6c65 6e61 6d65 2c20 6465 7073  s(filename, deps
-00025620: 2c20 6465 705f 6d61 702c 2074 6f5f 7275  , dep_map, to_ru
-00025630: 6e2c 2077 6f72 6b73 7061 6365 5f6c 6962  n, workspace_lib
-00025640: 5f70 6174 6873 290a 2020 2020 2020 2020  _paths).        
-00025650: 2020 2020 2020 2020 7072 6f63 6573 7365          processe
-00025660: 642e 6164 6428 6e61 6d65 290a 0a20 2020  d.add(name)..   
-00025670: 2061 7761 6974 2067 6574 5f70 726f 6365   await get_proce
-00025680: 7373 6564 2866 696c 656e 616d 6573 3d66  ssed(filenames=f
-00025690: 696c 656e 616d 6573 290a 0a20 2020 2069  ilenames)..    i
-000256a0: 6620 7072 6f63 6573 735f 6465 7065 6e64  f process_depend
-000256b0: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-000256c0: 6966 206f 6e6c 795f 6368 616e 6765 733a  if only_changes:
-000256d0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000256e0: 206b 6579 2069 6e20 6469 6374 2874 6f5f   key in dict(to_
-000256f0: 7275 6e29 3a0a 2020 2020 2020 2020 2020  run):.          
-00025700: 2020 2020 2020 2320 6c6f 6f6b 2066 6f72        # look for
-00025710: 2064 6570 7320 7468 6174 2061 7265 2074   deps that are t
-00025720: 6865 2074 6172 6765 7420 6461 7461 2073  he target data s
-00025730: 6f75 7263 6520 6f66 2061 206d 6174 6572  ource of a mater
-00025740: 6961 6c69 7a65 6420 6e6f 6465 0a20 2020  ialized node.   
-00025750: 2020 2020 2020 2020 2020 2020 2074 6172               tar
-00025760: 6765 745f 6461 7461 736f 7572 6365 203d  get_datasource =
-00025770: 2067 6574 5f74 6172 6765 745f 6d61 7465   get_target_mate
-00025780: 7269 616c 697a 6564 5f64 6174 615f 736f  rialized_data_so
-00025790: 7572 6365 5f6e 616d 6528 746f 5f72 756e  urce_name(to_run
-000257a0: 5b6b 6579 5d29 0a20 2020 2020 2020 2020  [key]).         
-000257b0: 2020 2020 2020 2069 6620 7461 7267 6574         if target
-000257c0: 5f64 6174 6173 6f75 7263 653a 0a20 2020  _datasource:.   
-000257d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000257e0: 2023 206c 6f6f 6b20 696e 2061 6c6c 5f64   # look in all_d
-000257f0: 6570 5f6d 6170 2069 7465 6d73 2074 6861  ep_map items tha
-00025800: 7420 6861 7665 2061 7320 6120 6465 7065  t have as a depe
-00025810: 6e64 656e 6379 2074 6865 2074 6172 6765  ndency the targe
-00025820: 7420 6461 7461 2073 6f75 7263 6520 616e  t data source an
-00025830: 6420 6172 6520 616e 2065 6e64 706f 696e  d are an endpoin
-00025840: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00025850: 2020 2020 2020 666f 7220 5f6b 6579 2c20        for _key, 
-00025860: 5f64 6570 7320 696e 2061 6c6c 5f64 6570  _deps in all_dep
-00025870: 5f6d 6170 2e69 7465 6d73 2829 3a0a 2020  _map.items():.  
-00025880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025890: 2020 2020 2020 666f 7220 6465 7020 696e        for dep in
-000258a0: 205f 6465 7073 3a0a 2020 2020 2020 2020   _deps:.        
-000258b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000258c0: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
-000258d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000258e0: 2020 2020 2020 2020 2064 6570 203d 3d20           dep == 
-000258f0: 7461 7267 6574 5f64 6174 6173 6f75 7263  target_datasourc
-00025900: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00025910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025920: 2020 6f72 2028 6465 7020 3d3d 206b 6579    or (dep == key
-00025930: 2061 6e64 2074 6172 6765 745f 6461 7461   and target_data
-00025940: 736f 7572 6365 206e 6f74 2069 6e20 616c  source not in al
-00025950: 6c5f 6465 705f 6d61 702e 6765 7428 6b65  l_dep_map.get(ke
-00025960: 792c 205b 5d29 290a 2020 2020 2020 2020  y, [])).        
-00025970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025980: 2020 2020 2920 616e 6420 6973 5f65 6e64      ) and is_end
-00025990: 706f 696e 745f 7769 7468 5f6e 6f5f 6465  point_with_no_de
-000259a0: 7065 6e64 656e 6369 6573 280a 2020 2020  pendencies(.    
-000259b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000259c0: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
-000259d0: 7265 736f 7572 6365 732e 6765 7428 5f6b  resources.get(_k
-000259e0: 6579 2c20 7b7d 292c 2061 6c6c 5f64 6570  ey, {}), all_dep
-000259f0: 5f6d 6170 2c20 616c 6c5f 7265 736f 7572  _map, all_resour
-00025a00: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
+00025100: 2020 2020 2020 2020 2065 5f64 7320 3d20           e_ds = 
+00025110: 656d 6265 6464 6564 5f64 6174 6173 6f75  embedded_datasou
+00025120: 7263 6573 2e67 6574 2878 2c20 4e6f 6e65  rces.get(x, None
+00025130: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00025140: 2020 2020 2020 2020 2020 6966 2065 5f64            if e_d
+00025150: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00025160: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00025170: 6570 5f6c 6973 742e 6170 7065 6e64 2865  ep_list.append(e
+00025180: 5f64 735b 2272 6573 6f75 7263 655f 6e61  _ds["resource_na
+00025190: 6d65 225d 290a 0a20 2020 2020 2020 2020  me"])..         
+000251a0: 2020 2023 2049 6e20 6361 7365 2074 6865     # In case the
+000251b0: 2064 6174 6173 6f75 7263 6520 6973 2074   datasource is t
+000251c0: 6f20 6265 2073 6861 7265 6420 616e 6420  o be shared and 
+000251d0: 7765 2068 6176 6520 6d61 7070 696e 672c  we have mapping,
+000251e0: 206c 6574 2773 2072 6570 6c61 6365 2074   let's replace t
+000251f0: 6865 206e 616d 650a 2020 2020 2020 2020  he name.        
+00025200: 2020 2020 6966 2022 7368 6172 6564 5f77      if "shared_w
+00025210: 6974 6822 2069 6e20 7220 616e 6420 776f  ith" in r and wo
+00025220: 726b 7370 6163 655f 6d61 703a 0a20 2020  rkspace_map:.   
+00025230: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00025240: 7065 645f 776f 726b 7370 6163 6573 3a20  ped_workspaces: 
+00025250: 4c69 7374 5b73 7472 5d20 3d20 5b5d 0a20  List[str] = []. 
+00025260: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00025270: 6f72 2073 6861 7265 645f 7769 7468 2069  or shared_with i
+00025280: 6e20 725b 2273 6861 7265 645f 7769 7468  n r["shared_with
+00025290: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
+000252a0: 2020 2020 2020 2020 6d61 7070 6564 5f77          mapped_w
+000252b0: 6f72 6b73 7061 6365 732e 6170 7065 6e64  orkspaces.append
+000252c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000252d0: 2020 2020 2020 2020 2020 776f 726b 7370            worksp
+000252e0: 6163 655f 6d61 702e 6765 7428 7368 6172  ace_map.get(shar
+000252f0: 6564 5f77 6974 6829 0a20 2020 2020 2020  ed_with).       
+00025300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025310: 2069 6620 776f 726b 7370 6163 655f 6d61   if workspace_ma
+00025320: 702e 6765 7428 7368 6172 6564 5f77 6974  p.get(shared_wit
+00025330: 682c 204e 6f6e 6529 2069 7320 6e6f 7420  h, None) is not 
+00025340: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00025350: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00025360: 6520 7368 6172 6564 5f77 6974 680a 2020  e shared_with.  
+00025370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025380: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00025390: 2020 2020 725b 2273 6861 7265 645f 7769      r["shared_wi
+000253a0: 7468 225d 203d 206d 6170 7065 645f 776f  th"] = mapped_wo
+000253b0: 726b 7370 6163 6573 0a0a 2020 2020 2020  rkspaces..      
+000253c0: 2020 2020 2020 6465 705f 6d61 705b 666e        dep_map[fn
+000253d0: 5d20 3d20 7365 7428 6465 705f 6c69 7374  ] = set(dep_list
+000253e0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000253f0: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+00025400: 6528 6e61 6d65 290a 0a20 2020 2070 726f  e(name)..    pro
+00025410: 6365 7373 6564 203d 2073 6574 2829 0a0a  cessed = set()..
+00025420: 2020 2020 6173 796e 6320 6465 6620 6765      async def ge
+00025430: 745f 7072 6f63 6573 7365 6428 6669 6c65  t_processed(file
+00025440: 6e61 6d65 733a 2049 7465 7261 626c 655b  names: Iterable[
+00025450: 7374 725d 293a 0a20 2020 2020 2020 2066  str]):.        f
+00025460: 6f72 2066 696c 656e 616d 6520 696e 2066  or filename in f
+00025470: 696c 656e 616d 6573 3a0a 2020 2020 2020  ilenames:.      
+00025480: 2020 2020 2020 2320 6a75 7374 2070 726f        # just pro
+00025490: 6365 7373 2063 6861 6e67 6564 2066 696c  cess changed fil
+000254a0: 656e 616d 6573 2028 7462 2064 6570 6c6f  enames (tb deplo
+000254b0: 7920 616e 6420 2d2d 6f6e 6c79 2d63 6861  y and --only-cha
+000254c0: 6e67 6573 290a 2020 2020 2020 2020 2020  nges).          
+000254d0: 2020 6966 2063 6861 6e67 6564 3a0a 2020    if changed:.  
+000254e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000254f0: 736f 7572 6365 203d 2050 6174 6828 6669  source = Path(fi
+00025500: 6c65 6e61 6d65 292e 7265 736f 6c76 6528  lename).resolve(
+00025510: 292e 7374 656d 0a20 2020 2020 2020 2020  ).stem.         
+00025520: 2020 2020 2020 2069 6620 7265 736f 7572         if resour
+00025530: 6365 2069 6e20 6368 616e 6765 6420 616e  ce in changed an
+00025540: 6420 286e 6f74 2063 6861 6e67 6564 5b72  d (not changed[r
+00025550: 6573 6f75 7263 655d 206f 7220 6368 616e  esource] or chan
+00025560: 6765 645b 7265 736f 7572 6365 5d20 696e  ged[resource] in
+00025570: 205b 2273 6861 7265 6422 2c20 2272 656d   ["shared", "rem
+00025580: 6f74 6522 5d29 3a0a 2020 2020 2020 2020  ote"]):.        
+00025590: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+000255a0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+000255b0: 2069 6620 6f73 2e70 6174 682e 6973 6469   if os.path.isdi
+000255c0: 7228 6669 6c65 6e61 6d65 293a 0a20 2020  r(filename):.   
+000255d0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+000255e0: 6974 2067 6574 5f70 726f 6365 7373 6564  it get_processed
+000255f0: 2866 696c 656e 616d 6573 3d67 6574 5f70  (filenames=get_p
+00025600: 726f 6a65 6374 5f66 696c 656e 616d 6573  roject_filenames
+00025610: 2866 696c 656e 616d 6529 290a 2020 2020  (filename)).    
+00025620: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00025630: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00025640: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00025650: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+00025660: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
+00025670: 6b4d 616e 6167 6572 2e69 6e66 6f5f 7072  kManager.info_pr
+00025680: 6f63 6573 7369 6e67 5f66 696c 6528 6669  ocessing_file(fi
+00025690: 6c65 6e61 6d65 3d66 696c 656e 616d 6529  lename=filename)
+000256a0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+000256b0: 2020 2069 6620 222e 696e 636c 2220 696e     if ".incl" in
+000256c0: 2066 696c 656e 616d 653a 0a20 2020 2020   filename:.     
+000256d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000256e0: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
+000256f0: 636b 4d61 6e61 6765 722e 7761 726e 696e  ckManager.warnin
+00025700: 675f 736b 6970 7069 6e67 5f69 6e63 6c75  g_skipping_inclu
+00025710: 6465 5f66 696c 6528 6669 6c65 3d66 696c  de_file(file=fil
+00025720: 656e 616d 6529 290a 0a20 2020 2020 2020  ename))..       
+00025730: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
+00025740: 6177 6169 7420 7072 6f63 6573 7328 6669  await process(fi
+00025750: 6c65 6e61 6d65 2c20 6465 7073 2c20 6465  lename, deps, de
+00025760: 705f 6d61 702c 2074 6f5f 7275 6e2c 2077  p_map, to_run, w
+00025770: 6f72 6b73 7061 6365 5f6c 6962 5f70 6174  orkspace_lib_pat
+00025780: 6873 290a 2020 2020 2020 2020 2020 2020  hs).            
+00025790: 2020 2020 7072 6f63 6573 7365 642e 6164      processed.ad
+000257a0: 6428 6e61 6d65 290a 0a20 2020 2061 7761  d(name)..    awa
+000257b0: 6974 2067 6574 5f70 726f 6365 7373 6564  it get_processed
+000257c0: 2866 696c 656e 616d 6573 3d66 696c 656e  (filenames=filen
+000257d0: 616d 6573 290a 0a20 2020 2069 6620 7072  ames)..    if pr
+000257e0: 6f63 6573 735f 6465 7065 6e64 656e 6369  ocess_dependenci
+000257f0: 6573 3a0a 2020 2020 2020 2020 6966 206f  es:.        if o
+00025800: 6e6c 795f 6368 616e 6765 733a 0a20 2020  nly_changes:.   
+00025810: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+00025820: 2069 6e20 6469 6374 2874 6f5f 7275 6e29   in dict(to_run)
+00025830: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00025840: 2020 2320 6c6f 6f6b 2066 6f72 2064 6570    # look for dep
+00025850: 7320 7468 6174 2061 7265 2074 6865 2074  s that are the t
+00025860: 6172 6765 7420 6461 7461 2073 6f75 7263  arget data sourc
+00025870: 6520 6f66 2061 206d 6174 6572 6961 6c69  e of a materiali
+00025880: 7a65 6420 6e6f 6465 0a20 2020 2020 2020  zed node.       
+00025890: 2020 2020 2020 2020 2074 6172 6765 745f           target_
+000258a0: 6461 7461 736f 7572 6365 203d 2067 6574  datasource = get
+000258b0: 5f74 6172 6765 745f 6d61 7465 7269 616c  _target_material
+000258c0: 697a 6564 5f64 6174 615f 736f 7572 6365  ized_data_source
+000258d0: 5f6e 616d 6528 746f 5f72 756e 5b6b 6579  _name(to_run[key
+000258e0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+000258f0: 2020 2069 6620 7461 7267 6574 5f64 6174     if target_dat
+00025900: 6173 6f75 7263 653a 0a20 2020 2020 2020  asource:.       
+00025910: 2020 2020 2020 2020 2020 2020 2023 206c               # l
+00025920: 6f6f 6b20 696e 2061 6c6c 5f64 6570 5f6d  ook in all_dep_m
+00025930: 6170 2069 7465 6d73 2074 6861 7420 6861  ap items that ha
+00025940: 7665 2061 7320 6120 6465 7065 6e64 656e  ve as a dependen
+00025950: 6379 2074 6865 2074 6172 6765 7420 6461  cy the target da
+00025960: 7461 2073 6f75 7263 6520 616e 6420 6172  ta source and ar
+00025970: 6520 616e 2065 6e64 706f 696e 740a 2020  e an endpoint.  
+00025980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025990: 2020 666f 7220 5f6b 6579 2c20 5f64 6570    for _key, _dep
+000259a0: 7320 696e 2061 6c6c 5f64 6570 5f6d 6170  s in all_dep_map
+000259b0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+000259c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000259d0: 2020 666f 7220 6465 7020 696e 205f 6465    for dep in _de
+000259e0: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+000259f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025a00: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
 00025a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a20: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00025a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a40: 2020 2064 6570 5f6d 6170 5b5f 6b65 795d     dep_map[_key]
-00025a50: 203d 205f 6465 7073 0a20 2020 2020 2020   = _deps.       
-00025a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a70: 2020 2020 2020 2020 2074 6f5f 7275 6e5b           to_run[
-00025a80: 5f6b 6579 5d20 3d20 616c 6c5f 7265 736f  _key] = all_reso
-00025a90: 7572 6365 732e 6765 7428 5f6b 6579 290a  urces.get(_key).
-00025aa0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00025ab0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-00025ac0: 6c65 6e28 6465 7073 2920 3e20 303a 0a20  len(deps) > 0:. 
-00025ad0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00025ae0: 6570 203d 2064 6570 732e 706f 7028 290a  ep = deps.pop().
+00025a20: 2020 2020 2064 6570 203d 3d20 7461 7267       dep == targ
+00025a30: 6574 5f64 6174 6173 6f75 7263 650a 2020  et_datasource.  
+00025a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025a50: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+00025a60: 2028 6465 7020 3d3d 206b 6579 2061 6e64   (dep == key and
+00025a70: 2074 6172 6765 745f 6461 7461 736f 7572   target_datasour
+00025a80: 6365 206e 6f74 2069 6e20 616c 6c5f 6465  ce not in all_de
+00025a90: 705f 6d61 702e 6765 7428 6b65 792c 205b  p_map.get(key, [
+00025aa0: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
+00025ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025ac0: 2920 616e 6420 6973 5f65 6e64 706f 696e  ) and is_endpoin
+00025ad0: 745f 7769 7468 5f6e 6f5f 6465 7065 6e64  t_with_no_depend
+00025ae0: 656e 6369 6573 280a 2020 2020 2020 2020  encies(.        
 00025af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025b00: 6966 2064 6570 206e 6f74 2069 6e20 7072  if dep not in pr
-00025b10: 6f63 6573 7365 643a 0a20 2020 2020 2020  ocessed:.       
-00025b20: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-00025b30: 6365 7373 6564 2e61 6464 2864 6570 290a  cessed.add(dep).
+00025b00: 2020 2020 2020 2020 616c 6c5f 7265 736f          all_reso
+00025b10: 7572 6365 732e 6765 7428 5f6b 6579 2c20  urces.get(_key, 
+00025b20: 7b7d 292c 2061 6c6c 5f64 6570 5f6d 6170  {}), all_dep_map
+00025b30: 2c20 616c 6c5f 7265 736f 7572 6365 730a  , all_resources.
 00025b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025b50: 2020 2020 6620 3d20 6675 6c6c 5f70 6174      f = full_pat
-00025b60: 685f 6279 5f6e 616d 6528 6469 725f 7061  h_by_name(dir_pa
-00025b70: 7468 2c20 6465 702c 2077 6f72 6b73 7061  th, dep, workspa
-00025b80: 6365 5f6c 6962 5f70 6174 6873 290a 2020  ce_lib_paths).  
-00025b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025ba0: 2020 6966 2066 3a0a 2020 2020 2020 2020    if f:.        
-00025bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025bc0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00025bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025be0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00025bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025c00: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-00025c10: 6365 7373 6564 5f66 696c 656e 616d 6520  cessed_filename 
-00025c20: 3d20 662e 7265 6c61 7469 7665 5f74 6f28  = f.relative_to(
-00025c30: 6f73 2e67 6574 6377 6428 2929 0a20 2020  os.getcwd()).   
-00025c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025c50: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00025c60: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
-00025c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025c80: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
-00025c90: 6573 7365 645f 6669 6c65 6e61 6d65 203d  essed_filename =
-00025ca0: 2066 0a20 2020 2020 2020 2020 2020 2020   f.             
-00025cb0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00025cc0: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
-00025cd0: 636b 4d61 6e61 6765 722e 696e 666f 5f70  ckManager.info_p
-00025ce0: 726f 6365 7373 696e 675f 6669 6c65 2866  rocessing_file(f
-00025cf0: 696c 656e 616d 653d 7072 6f63 6573 7365  ilename=processe
-00025d00: 645f 6669 6c65 6e61 6d65 2929 0a20 2020  d_filename)).   
+00025b50: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+00025b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025b70: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00025b80: 6570 5f6d 6170 5b5f 6b65 795d 203d 205f  ep_map[_key] = _
+00025b90: 6465 7073 0a20 2020 2020 2020 2020 2020  deps.           
+00025ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025bb0: 2020 2020 2074 6f5f 7275 6e5b 5f6b 6579       to_run[_key
+00025bc0: 5d20 3d20 616c 6c5f 7265 736f 7572 6365  ] = all_resource
+00025bd0: 732e 6765 7428 5f6b 6579 290a 2020 2020  s.get(_key).    
+00025be0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00025bf0: 2020 2020 2020 7768 696c 6520 6c65 6e28        while len(
+00025c00: 6465 7073 2920 3e20 303a 0a20 2020 2020  deps) > 0:.     
+00025c10: 2020 2020 2020 2020 2020 2064 6570 203d             dep =
+00025c20: 2064 6570 732e 706f 7028 290a 2020 2020   deps.pop().    
+00025c30: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00025c40: 6570 206e 6f74 2069 6e20 7072 6f63 6573  ep not in proces
+00025c50: 7365 643a 0a20 2020 2020 2020 2020 2020  sed:.           
+00025c60: 2020 2020 2020 2020 2070 726f 6365 7373           process
+00025c70: 6564 2e61 6464 2864 6570 290a 2020 2020  ed.add(dep).    
+00025c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025c90: 6620 3d20 6675 6c6c 5f70 6174 685f 6279  f = full_path_by
+00025ca0: 5f6e 616d 6528 6469 725f 7061 7468 2c20  _name(dir_path, 
+00025cb0: 6465 702c 2077 6f72 6b73 7061 6365 5f6c  dep, workspace_l
+00025cc0: 6962 5f70 6174 6873 290a 2020 2020 2020  ib_paths).      
+00025cd0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00025ce0: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+00025cf0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+00025d00: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
 00025d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d20: 2020 2020 2061 7761 6974 2070 726f 6365       await proce
-00025d30: 7373 2873 7472 2866 292c 2064 6570 732c  ss(str(f), deps,
-00025d40: 2064 6570 5f6d 6170 2c20 746f 5f72 756e   dep_map, to_run
-00025d50: 2c20 776f 726b 7370 6163 655f 6c69 625f  , workspace_lib_
-00025d60: 7061 7468 7329 0a0a 2020 2020 7265 7475  paths)..    retu
-00025d70: 726e 2047 7261 7068 4465 7065 6e64 656e  rn GraphDependen
-00025d80: 6369 6573 2864 6570 5f6d 6170 2c20 746f  cies(dep_map, to
-00025d90: 5f72 756e 2c20 616c 6c5f 6465 705f 6d61  _run, all_dep_ma
-00025da0: 702c 2061 6c6c 5f72 6573 6f75 7263 6573  p, all_resources
-00025db0: 290a 0a0a 6173 796e 6320 6465 6620 6765  )...async def ge
-00025dc0: 745f 6368 616e 6765 735f 6672 6f6d 5f6d  t_changes_from_m
-00025dd0: 6169 6e28 0a20 2020 206f 6e6c 795f 6368  ain(.    only_ch
-00025de0: 616e 6765 733a 2062 6f6f 6c2c 0a20 2020  anges: bool,.   
-00025df0: 2063 6c69 656e 743a 2054 696e 7942 2c0a   client: TinyB,.
-00025e00: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
-00025e10: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
-00025e20: 6e79 5d5d 203d 204e 6f6e 652c 0a20 2020  ny]] = None,.   
-00025e30: 2063 7572 7265 6e74 5f77 733a 204f 7074   current_ws: Opt
-00025e40: 696f 6e61 6c5b 4469 6374 5b73 7472 2c20  ional[Dict[str, 
-00025e50: 416e 795d 5d20 3d20 4e6f 6e65 2c0a 2020  Any]] = None,.  
-00025e60: 2020 6669 6c65 6e61 6d65 733a 204f 7074    filenames: Opt
-00025e70: 696f 6e61 6c5b 4c69 7374 5b73 7472 5d5d  ional[List[str]]
-00025e80: 203d 204e 6f6e 652c 0a29 3a0a 2020 2020   = None,.):.    
-00025e90: 6368 616e 6765 6420 3d20 4e6f 6e65 0a20  changed = None. 
-00025ea0: 2020 2069 6620 6e6f 7420 6f6e 6c79 5f63     if not only_c
-00025eb0: 6861 6e67 6573 3a0a 2020 2020 2020 2020  hanges:.        
-00025ec0: 7265 7475 726e 2063 6861 6e67 6564 0a0a  return changed..
-00025ed0: 2020 2020 6966 2063 7572 7265 6e74 5f77      if current_w
-00025ee0: 7320 616e 6420 6e6f 7420 6375 7272 656e  s and not curren
-00025ef0: 745f 7773 2e67 6574 2822 6973 5f62 7261  t_ws.get("is_bra
-00025f00: 6e63 6822 293a 0a20 2020 2020 2020 2063  nch"):.        c
-00025f10: 6861 6e67 6564 203d 2061 7761 6974 2064  hanged = await d
-00025f20: 6966 665f 636f 6d6d 616e 6428 6669 6c65  iff_command(file
-00025f30: 6e61 6d65 732c 2054 7275 652c 2063 6c69  names, True, cli
-00025f40: 656e 742c 206e 6f5f 636f 6c6f 723d 5472  ent, no_color=Tr
-00025f50: 7565 2c20 7769 7468 5f70 7269 6e74 3d46  ue, with_print=F
-00025f60: 616c 7365 290a 2020 2020 656c 6966 2063  alse).    elif c
-00025f70: 6f6e 6669 6720 616e 6420 636f 6e66 6967  onfig and config
-00025f80: 2e67 6574 2822 686f 7374 2229 3a0a 2020  .get("host"):.  
-00025f90: 2020 2020 2020 776f 726b 7370 6163 6520        workspace 
-00025fa0: 3d20 6177 6169 7420 6765 745f 6375 7272  = await get_curr
-00025fb0: 656e 745f 6d61 696e 5f77 6f72 6b73 7061  ent_main_workspa
-00025fc0: 6365 2863 6c69 656e 742c 2063 6f6e 6669  ce(client, confi
-00025fd0: 6729 0a0a 2020 2020 2020 2020 6966 2077  g)..        if w
-00025fe0: 6f72 6b73 7061 6365 3a0a 2020 2020 2020  orkspace:.      
-00025ff0: 2020 2020 2020 7773 5f63 6c69 656e 7420        ws_client 
-00026000: 3d20 5f67 6574 5f74 625f 636c 6965 6e74  = _get_tb_client
-00026010: 2877 6f72 6b73 7061 6365 5b22 746f 6b65  (workspace["toke
-00026020: 6e22 5d2c 2063 6f6e 6669 675b 2268 6f73  n"], config["hos
-00026030: 7422 5d29 0a20 2020 2020 2020 2020 2020  t"]).           
-00026040: 2063 6861 6e67 6564 203d 2061 7761 6974   changed = await
-00026050: 2064 6966 665f 636f 6d6d 616e 6428 6669   diff_command(fi
-00026060: 6c65 6e61 6d65 732c 2054 7275 652c 2077  lenames, True, w
-00026070: 735f 636c 6965 6e74 2c20 6e6f 5f63 6f6c  s_client, no_col
-00026080: 6f72 3d54 7275 652c 2077 6974 685f 7072  or=True, with_pr
-00026090: 696e 743d 4661 6c73 6529 0a20 2020 2072  int=False).    r
-000260a0: 6574 7572 6e20 6368 616e 6765 640a 0a0a  eturn changed...
-000260b0: 6465 6620 6765 745f 7072 6f6a 6563 745f  def get_project_
-000260c0: 6669 6c65 6e61 6d65 7328 666f 6c64 6572  filenames(folder
-000260d0: 3a20 7374 722c 2077 6974 685f 7665 6e64  : str, with_vend
-000260e0: 6f72 3d46 616c 7365 2920 2d3e 204c 6973  or=False) -> Lis
-000260f0: 745b 7374 725d 3a0a 2020 2020 666f 6c64  t[str]:.    fold
-00026100: 6572 733a 204c 6973 745b 7374 725d 203d  ers: List[str] =
-00026110: 205b 0a20 2020 2020 2020 2066 227b 666f   [.        f"{fo
-00026120: 6c64 6572 7d2f 2a2e 6461 7461 736f 7572  lder}/*.datasour
-00026130: 6365 222c 0a20 2020 2020 2020 2066 227b  ce",.        f"{
-00026140: 666f 6c64 6572 7d2f 6461 7461 736f 7572  folder}/datasour
-00026150: 6365 732f 2a2e 6461 7461 736f 7572 6365  ces/*.datasource
-00026160: 222c 0a20 2020 2020 2020 2066 227b 666f  ",.        f"{fo
-00026170: 6c64 6572 7d2f 2a2e 7069 7065 222c 0a20  lder}/*.pipe",. 
-00026180: 2020 2020 2020 2066 227b 666f 6c64 6572         f"{folder
-00026190: 7d2f 7069 7065 732f 2a2e 7069 7065 222c  }/pipes/*.pipe",
-000261a0: 0a20 2020 2020 2020 2066 227b 666f 6c64  .        f"{fold
-000261b0: 6572 7d2f 656e 6470 6f69 6e74 732f 2a2e  er}/endpoints/*.
-000261c0: 7069 7065 222c 0a20 2020 2020 2020 2066  pipe",.        f
-000261d0: 227b 666f 6c64 6572 7d2f 2a2e 746f 6b65  "{folder}/*.toke
-000261e0: 6e22 2c0a 2020 2020 2020 2020 6622 7b66  n",.        f"{f
-000261f0: 6f6c 6465 727d 2f74 6f6b 656e 732f 2a2e  older}/tokens/*.
-00026200: 746f 6b65 6e22 2c0a 2020 2020 5d0a 2020  token",.    ].  
-00026210: 2020 6966 2077 6974 685f 7665 6e64 6f72    if with_vendor
-00026220: 3a0a 2020 2020 2020 2020 666f 6c64 6572  :.        folder
-00026230: 732e 6170 7065 6e64 2866 227b 666f 6c64  s.append(f"{fold
-00026240: 6572 7d2f 7665 6e64 6f72 2f2a 2a2f 2a2a  er}/vendor/**/**
-00026250: 2f2a 2e64 6174 6173 6f75 7263 6522 290a  /*.datasource").
-00026260: 2020 2020 6669 6c65 6e61 6d65 733a 204c      filenames: L
-00026270: 6973 745b 7374 725d 203d 205b 5d0a 2020  ist[str] = [].  
-00026280: 2020 666f 7220 7820 696e 2066 6f6c 6465    for x in folde
-00026290: 7273 3a0a 2020 2020 2020 2020 6669 6c65  rs:.        file
-000262a0: 6e61 6d65 7320 2b3d 2067 6c6f 622e 676c  names += glob.gl
-000262b0: 6f62 2878 290a 2020 2020 7265 7475 726e  ob(x).    return
-000262c0: 2066 696c 656e 616d 6573 0a0a 0a64 6566   filenames...def
-000262d0: 2069 735f 6e65 7728 0a20 2020 206e 616d   is_new(.    nam
-000262e0: 653a 2073 7472 2c0a 2020 2020 6368 616e  e: str,.    chan
-000262f0: 6765 643a 2044 6963 745b 7374 722c 2073  ged: Dict[str, s
-00026300: 7472 5d2c 0a20 2020 206e 6f72 6d61 6c5f  tr],.    normal_
-00026310: 6465 7065 6e64 656e 6379 3a20 4469 6374  dependency: Dict
-00026320: 5b73 7472 2c20 5365 745b 7374 725d 5d2c  [str, Set[str]],
-00026330: 0a20 2020 2066 6f72 6b5f 646f 776e 7374  .    fork_downst
-00026340: 7265 616d 5f64 6570 656e 6465 6e63 793a  ream_dependency:
-00026350: 2044 6963 745b 7374 722c 2053 6574 5b73   Dict[str, Set[s
-00026360: 7472 5d5d 2c0a 2920 2d3e 2062 6f6f 6c3a  tr]],.) -> bool:
-00026370: 0a20 2020 2064 6566 2069 735f 6769 745f  .    def is_git_
-00026380: 6e65 7728 6e61 6d65 3a20 7374 7229 3a0a  new(name: str):.
-00026390: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-000263a0: 6861 6e67 6564 2061 6e64 2063 6861 6e67  hanged and chang
-000263b0: 6564 2e67 6574 286e 616d 6529 203d 3d20  ed.get(name) == 
-000263c0: 2241 220a 0a20 2020 2069 6620 6e6f 7420  "A"..    if not 
-000263d0: 6973 5f67 6974 5f6e 6577 286e 616d 6529  is_git_new(name)
-000263e0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000263f0: 2046 616c 7365 0a0a 2020 2020 2320 6966   False..    # if
-00026400: 2073 686f 756c 6420 6e6f 7420 6465 7065   should not depe
-00026410: 6e64 206f 6e20 6120 6368 616e 6765 6420  nd on a changed 
-00026420: 7265 736f 7572 6365 0a20 2020 2069 6620  resource.    if 
-00026430: 6261 636b 5f64 6570 7320 3a3d 206e 6f72  back_deps := nor
-00026440: 6d61 6c5f 6465 7065 6e64 656e 6379 2e67  mal_dependency.g
-00026450: 6574 286e 616d 6529 3a0a 2020 2020 2020  et(name):.      
-00026460: 2020 666f 7220 6465 7020 696e 2062 6163    for dep in bac
-00026470: 6b5f 6465 7073 3a0a 2020 2020 2020 2020  k_deps:.        
-00026480: 2020 2020 6966 2064 6570 2069 6e20 666f      if dep in fo
-00026490: 726b 5f64 6f77 6e73 7472 6561 6d5f 6465  rk_downstream_de
-000264a0: 7065 6e64 656e 6379 2061 6e64 206e 6f74  pendency and not
-000264b0: 2069 735f 6769 745f 6e65 7728 6465 7029   is_git_new(dep)
-000264c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000264d0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-000264e0: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-000264f0: 0a0a 6173 796e 6320 6465 6620 666f 6c64  ..async def fold
-00026500: 6572 5f70 7573 6828 0a20 2020 2074 625f  er_push(.    tb_
-00026510: 636c 6965 6e74 3a20 5469 6e79 422c 0a20  client: TinyB,. 
-00026520: 2020 2066 696c 656e 616d 6573 3a20 4f70     filenames: Op
-00026530: 7469 6f6e 616c 5b4c 6973 745b 7374 725d  tional[List[str]
-00026540: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6472  ] = None,.    dr
-00026550: 795f 7275 6e3a 2062 6f6f 6c20 3d20 4661  y_run: bool = Fa
-00026560: 6c73 652c 0a20 2020 2063 6865 636b 3a20  lse,.    check: 
-00026570: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00026580: 2020 7075 7368 5f64 6570 733a 2062 6f6f    push_deps: boo
-00026590: 6c20 3d20 4661 6c73 652c 0a20 2020 206f  l = False,.    o
-000265a0: 6e6c 795f 6368 616e 6765 733a 2062 6f6f  nly_changes: boo
-000265b0: 6c20 3d20 4661 6c73 652c 0a20 2020 2067  l = False,.    g
-000265c0: 6974 5f72 656c 6561 7365 3a20 626f 6f6c  it_release: bool
-000265d0: 203d 2046 616c 7365 2c0a 2020 2020 6465   = False,.    de
-000265e0: 6275 673a 2062 6f6f 6c20 3d20 4661 6c73  bug: bool = Fals
-000265f0: 652c 0a20 2020 2066 6f72 6365 3a20 626f  e,.    force: bo
-00026600: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-00026610: 6f76 6572 7269 6465 5f64 6174 6173 6f75  override_datasou
-00026620: 7263 653a 2062 6f6f 6c20 3d20 4661 6c73  rce: bool = Fals
-00026630: 652c 0a20 2020 2066 6f6c 6465 723a 2073  e,.    folder: s
-00026640: 7472 203d 2022 2e22 2c0a 2020 2020 706f  tr = ".",.    po
-00026650: 7075 6c61 7465 3a20 626f 6f6c 203d 2046  pulate: bool = F
-00026660: 616c 7365 2c0a 2020 2020 706f 7075 6c61  alse,.    popula
-00026670: 7465 5f73 7562 7365 743d 4e6f 6e65 2c0a  te_subset=None,.
-00026680: 2020 2020 706f 7075 6c61 7465 5f63 6f6e      populate_con
-00026690: 6469 7469 6f6e 3a20 4f70 7469 6f6e 616c  dition: Optional
-000266a0: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-000266b0: 2020 756e 6c69 6e6b 5f6f 6e5f 706f 7075    unlink_on_popu
-000266c0: 6c61 7465 5f65 7272 6f72 3a20 626f 6f6c  late_error: bool
-000266d0: 203d 2046 616c 7365 2c0a 2020 2020 7570   = False,.    up
-000266e0: 6c6f 6164 5f66 6978 7475 7265 733a 2062  load_fixtures: b
-000266f0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-00026700: 2077 6169 743a 2062 6f6f 6c20 3d20 4661   wait: bool = Fa
-00026710: 6c73 652c 0a20 2020 2069 676e 6f72 655f  lse,.    ignore_
-00026720: 7371 6c5f 6572 726f 7273 3a20 626f 6f6c  sql_errors: bool
-00026730: 203d 2046 616c 7365 2c0a 2020 2020 736b   = False,.    sk
-00026740: 6970 5f63 6f6e 6669 726d 6174 696f 6e3a  ip_confirmation:
-00026750: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00026760: 2020 206f 6e6c 795f 7265 7370 6f6e 7365     only_response
-00026770: 5f74 696d 6573 3a20 626f 6f6c 203d 2046  _times: bool = F
-00026780: 616c 7365 2c0a 2020 2020 776f 726b 7370  alse,.    worksp
-00026790: 6163 655f 6d61 703d 4e6f 6e65 2c0a 2020  ace_map=None,.  
-000267a0: 2020 776f 726b 7370 6163 655f 6c69 625f    workspace_lib_
-000267b0: 7061 7468 733d 4e6f 6e65 2c0a 2020 2020  paths=None,.    
-000267c0: 6e6f 5f76 6572 7369 6f6e 733a 2062 6f6f  no_versions: boo
-000267d0: 6c20 3d20 4661 6c73 652c 0a20 2020 2074  l = False,.    t
-000267e0: 696d 656f 7574 3d4e 6f6e 652c 0a20 2020  imeout=None,.   
-000267f0: 2072 756e 5f74 6573 7473 3a20 626f 6f6c   run_tests: bool
-00026800: 203d 2046 616c 7365 2c0a 2020 2020 6173   = False,.    as
-00026810: 5f73 7461 6e64 6172 643a 2062 6f6f 6c20  _standard: bool 
-00026820: 3d20 4661 6c73 652c 0a20 2020 2072 6169  = False,.    rai
-00026830: 7365 5f6f 6e5f 6578 6973 7473 3a20 626f  se_on_exists: bo
-00026840: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-00026850: 7665 7262 6f73 653a 2062 6f6f 6c20 3d20  verbose: bool = 
-00026860: 5472 7565 2c0a 2020 2020 7465 7374 735f  True,.    tests_
-00026870: 746f 5f72 756e 3a20 696e 7420 3d20 302c  to_run: int = 0,
-00026880: 0a20 2020 2074 6573 7473 5f73 616d 706c  .    tests_sampl
-00026890: 655f 6279 5f70 6172 616d 733a 2069 6e74  e_by_params: int
-000268a0: 203d 2030 2c0a 2020 2020 7465 7374 735f   = 0,.    tests_
-000268b0: 6669 6c74 6572 5f62 793a 204f 7074 696f  filter_by: Optio
-000268c0: 6e61 6c5b 4c69 7374 5b73 7472 5d5d 203d  nal[List[str]] =
-000268d0: 204e 6f6e 652c 0a20 2020 2074 6573 7473   None,.    tests
-000268e0: 5f66 6169 6c66 6173 743a 2062 6f6f 6c20  _failfast: bool 
-000268f0: 3d20 4661 6c73 652c 0a20 2020 2074 6573  = False,.    tes
-00026900: 7473 5f69 676e 6f72 655f 6f72 6465 723a  ts_ignore_order:
-00026910: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00026920: 2020 2074 6573 7473 5f76 616c 6964 6174     tests_validat
-00026930: 655f 7072 6f63 6573 7365 645f 6279 7465  e_processed_byte
-00026940: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-00026950: 0a20 2020 2074 6573 7473 5f63 6865 636b  .    tests_check
-00026960: 5f72 6571 7565 7374 735f 6672 6f6d 5f62  _requests_from_b
-00026970: 7261 6e63 683a 2062 6f6f 6c20 3d20 4661  ranch: bool = Fa
-00026980: 6c73 652c 0a20 2020 2063 6f6e 6669 673a  lse,.    config:
-00026990: 204f 7074 696f 6e61 6c5b 4469 6374 5b73   Optional[Dict[s
-000269a0: 7472 2c20 416e 795d 5d20 3d20 4e6f 6e65  tr, Any]] = None
-000269b0: 2c0a 2020 2020 7573 6572 5f74 6f6b 656e  ,.    user_token
-000269c0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-000269d0: 3d20 4e6f 6e65 2c0a 2020 2020 666f 726b  = None,.    fork
-000269e0: 5f64 6f77 6e73 7472 6561 6d3a 204f 7074  _downstream: Opt
-000269f0: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4661  ional[bool] = Fa
-00026a00: 6c73 652c 0a20 2020 2066 6f72 6b3a 204f  lse,.    fork: O
-00026a10: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
-00026a20: 4661 6c73 652c 0a20 2020 2069 735f 696e  False,.    is_in
-00026a30: 7465 726e 616c 3a20 4f70 7469 6f6e 616c  ternal: Optional
-00026a40: 5b62 6f6f 6c5d 203d 2046 616c 7365 2c0a  [bool] = False,.
-00026a50: 2020 2020 7265 6c65 6173 655f 6372 6561      release_crea
-00026a60: 7465 643a 204f 7074 696f 6e61 6c5b 626f  ted: Optional[bo
-00026a70: 6f6c 5d20 3d20 4661 6c73 652c 0a20 2020  ol] = False,.   
-00026a80: 2061 7574 6f5f 7072 6f6d 6f74 653a 204f   auto_promote: O
-00026a90: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
-00026aa0: 4661 6c73 652c 0a20 2020 2063 6865 636b  False,.    check
-00026ab0: 5f62 6163 6b66 696c 6c5f 7265 7175 6972  _backfill_requir
-00026ac0: 6564 3a20 626f 6f6c 203d 2046 616c 7365  ed: bool = False
-00026ad0: 2c0a 2020 2020 7573 655f 6d61 696e 3a20  ,.    use_main: 
-00026ae0: 626f 6f6c 203d 2046 616c 7365 2c0a 293a  bool = False,.):
-00026af0: 2020 2320 6e6f 7161 3a20 4339 3031 0a20    # noqa: C901. 
-00026b00: 2020 2077 6f72 6b73 7061 6365 733a 204c     workspaces: L
-00026b10: 6973 745b 4469 6374 5b73 7472 2c20 416e  ist[Dict[str, An
-00026b20: 795d 5d20 3d20 2861 7761 6974 2074 625f  y]] = (await tb_
-00026b30: 636c 6965 6e74 2e75 7365 725f 776f 726b  client.user_work
-00026b40: 7370 6163 6573 5f61 6e64 5f62 7261 6e63  spaces_and_branc
-00026b50: 6865 7328 2929 2e67 6574 2822 776f 726b  hes()).get("work
-00026b60: 7370 6163 6573 222c 205b 5d29 0a20 2020  spaces", []).   
-00026b70: 2063 7572 7265 6e74 5f77 733a 2044 6963   current_ws: Dic
-00026b80: 745b 7374 722c 2041 6e79 5d20 3d20 6e65  t[str, Any] = ne
-00026b90: 7874 280a 2020 2020 2020 2020 2877 6f72  xt(.        (wor
-00026ba0: 6b73 7061 6365 2066 6f72 2077 6f72 6b73  kspace for works
-00026bb0: 7061 6365 2069 6e20 776f 726b 7370 6163  pace in workspac
-00026bc0: 6573 2069 6620 636f 6e66 6967 2061 6e64  es if config and
-00026bd0: 2077 6f72 6b73 7061 6365 2e67 6574 2822   workspace.get("
-00026be0: 6964 222c 2022 2e22 2920 3d3d 2063 6f6e  id", ".") == con
-00026bf0: 6669 672e 6765 7428 2269 6422 2c20 222e  fig.get("id", ".
-00026c00: 2e22 2929 2c20 7b7d 0a20 2020 2029 0a20  .")), {}.    ). 
-00026c10: 2020 2069 735f 6272 616e 6368 203d 2063     is_branch = c
-00026c20: 7572 7265 6e74 5f77 732e 6765 7428 2269  urrent_ws.get("i
-00026c30: 735f 6272 616e 6368 222c 2046 616c 7365  s_branch", False
-00026c40: 290a 2020 2020 6861 735f 7365 6d76 6572  ).    has_semver
-00026c50: 3a20 626f 6f6c 203d 2072 656c 6561 7365  : bool = release
-00026c60: 5f63 7265 6174 6564 206f 7220 4661 6c73  _created or Fals
-00026c70: 650a 0a20 2020 2064 6570 6c6f 796d 656e  e..    deploymen
-00026c80: 7420 3d20 4465 706c 6f79 6d65 6e74 2863  t = Deployment(c
-00026c90: 7572 7265 6e74 5f77 732c 2067 6974 5f72  urrent_ws, git_r
-00026ca0: 656c 6561 7365 2c20 7462 5f63 6c69 656e  elease, tb_clien
-00026cb0: 742c 2064 7279 5f72 756e 2c20 6f6e 6c79  t, dry_run, only
-00026cc0: 5f63 6861 6e67 6573 290a 0a20 2020 2069  _changes)..    i
-00026cd0: 6620 6e6f 7420 776f 726b 7370 6163 655f  f not workspace_
-00026ce0: 6d61 703a 0a20 2020 2020 2020 2077 6f72  map:.        wor
-00026cf0: 6b73 7061 6365 5f6d 6170 203d 207b 7d0a  kspace_map = {}.
-00026d00: 2020 2020 6966 206e 6f74 2077 6f72 6b73      if not works
-00026d10: 7061 6365 5f6c 6962 5f70 6174 6873 3a0a  pace_lib_paths:.
-00026d20: 2020 2020 2020 2020 776f 726b 7370 6163          workspac
-00026d30: 655f 6c69 625f 7061 7468 7320 3d20 5b5d  e_lib_paths = []
-00026d40: 0a0a 2020 2020 776f 726b 7370 6163 655f  ..    workspace_
-00026d50: 6c69 625f 7061 7468 7320 3d20 6c69 7374  lib_paths = list
-00026d60: 2877 6f72 6b73 7061 6365 5f6c 6962 5f70  (workspace_lib_p
-00026d70: 6174 6873 290a 2020 2020 2320 696e 636c  aths).    # incl
-00026d80: 7564 6520 7665 6e64 6f72 206c 6962 7320  ude vendor libs 
-00026d90: 7769 7468 6f75 7420 6f76 6572 7269 6469  without overridi
-00026da0: 6e67 2075 7365 7220 6f6e 6573 0a20 2020  ng user ones.   
-00026db0: 2065 7869 7374 696e 675f 776f 726b 7370   existing_worksp
-00026dc0: 6163 6573 203d 2073 6574 2878 5b31 5d20  aces = set(x[1] 
-00026dd0: 666f 7220 7820 696e 2077 6f72 6b73 7061  for x in workspa
-00026de0: 6365 5f6c 6962 5f70 6174 6873 290a 2020  ce_lib_paths).  
-00026df0: 2020 7665 6e64 6f72 5f70 6174 6820 3d20    vendor_path = 
-00026e00: 5061 7468 2822 7665 6e64 6f72 2229 0a20  Path("vendor"). 
-00026e10: 2020 2069 6620 7665 6e64 6f72 5f70 6174     if vendor_pat
-00026e20: 682e 6578 6973 7473 2829 3a0a 2020 2020  h.exists():.    
-00026e30: 2020 2020 666f 7220 7820 696e 2076 656e      for x in ven
-00026e40: 646f 725f 7061 7468 2e69 7465 7264 6972  dor_path.iterdir
-00026e50: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00026e60: 6966 2078 2e69 735f 6469 7228 2920 616e  if x.is_dir() an
-00026e70: 6420 782e 6e61 6d65 206e 6f74 2069 6e20  d x.name not in 
-00026e80: 6578 6973 7469 6e67 5f77 6f72 6b73 7061  existing_workspa
-00026e90: 6365 733a 0a20 2020 2020 2020 2020 2020  ces:.           
-00026ea0: 2020 2020 2077 6f72 6b73 7061 6365 5f6c       workspace_l
-00026eb0: 6962 5f70 6174 6873 2e61 7070 656e 6428  ib_paths.append(
-00026ec0: 2878 2e6e 616d 652c 2078 2929 0a0a 2020  (x.name, x))..  
-00026ed0: 2020 6461 7461 736f 7572 6365 733a 204c    datasources: L
-00026ee0: 6973 745b 4469 6374 5b73 7472 2c20 416e  ist[Dict[str, An
-00026ef0: 795d 5d20 3d20 6177 6169 7420 7462 5f63  y]] = await tb_c
-00026f00: 6c69 656e 742e 6461 7461 736f 7572 6365  lient.datasource
-00026f10: 7328 290a 2020 2020 7069 7065 733a 204c  s().    pipes: L
-00026f20: 6973 745b 4469 6374 5b73 7472 2c20 416e  ist[Dict[str, An
-00026f30: 795d 5d20 3d20 6177 6169 7420 7462 5f63  y]] = await tb_c
-00026f40: 6c69 656e 742e 7069 7065 7328 6465 7065  lient.pipes(depe
-00026f50: 6e64 656e 6369 6573 3d54 7275 6529 0a0a  ndencies=True)..
-00026f60: 2020 2020 6578 6973 7469 6e67 5f72 6573      existing_res
-00026f70: 6f75 7263 6573 3a20 4c69 7374 5b73 7472  ources: List[str
-00026f80: 5d20 3d20 5b78 5b22 6e61 6d65 225d 2066  ] = [x["name"] f
-00026f90: 6f72 2078 2069 6e20 6461 7461 736f 7572  or x in datasour
-00026fa0: 6365 735d 202b 205b 785b 226e 616d 6522  ces] + [x["name"
-00026fb0: 5d20 666f 7220 7820 696e 2070 6970 6573  ] for x in pipes
-00026fc0: 5d0a 2020 2020 2320 7265 706c 6163 6520  ].    # replace 
-00026fd0: 776f 726b 7370 6163 6520 6d61 7070 696e  workspace mappin
-00026fe0: 6720 6e61 6d65 730a 2020 2020 666f 7220  g names.    for 
-00026ff0: 6f6c 645f 7773 2c20 6e65 775f 7773 2069  old_ws, new_ws i
-00027000: 6e20 776f 726b 7370 6163 655f 6d61 702e  n workspace_map.
-00027010: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00027020: 2065 7869 7374 696e 675f 7265 736f 7572   existing_resour
-00027030: 6365 7320 3d20 5b72 652e 7375 6228 6622  ces = [re.sub(f"
-00027040: 5e7b 6f6c 645f 7773 7d5c 2e22 2c20 6622  ^{old_ws}\.", f"
-00027050: 7b6e 6577 5f77 737d 2e22 2c20 7829 2066  {new_ws}.", x) f
-00027060: 6f72 2078 2069 6e20 6578 6973 7469 6e67  or x in existing
-00027070: 5f72 6573 6f75 7263 6573 5d0a 0a20 2020  _resources]..   
-00027080: 2072 656d 6f74 655f 7265 736f 7572 6365   remote_resource
-00027090: 5f6e 616d 6573 203d 205b 6765 745f 7265  _names = [get_re
-000270a0: 6d6f 7465 5f72 6573 6f75 7263 655f 6e61  mote_resource_na
-000270b0: 6d65 5f77 6974 686f 7574 5f76 6572 7369  me_without_versi
-000270c0: 6f6e 2878 2920 666f 7220 7820 696e 2065  on(x) for x in e
-000270d0: 7869 7374 696e 675f 7265 736f 7572 6365  xisting_resource
-000270e0: 735d 0a0a 2020 2020 2320 7265 706c 6163  s]..    # replac
-000270f0: 6520 776f 726b 7370 6163 6520 6d61 7070  e workspace mapp
-00027100: 696e 6720 6e61 6d65 730a 2020 2020 666f  ing names.    fo
-00027110: 7220 6f6c 645f 7773 2c20 6e65 775f 7773  r old_ws, new_ws
-00027120: 2069 6e20 776f 726b 7370 6163 655f 6d61   in workspace_ma
-00027130: 702e 6974 656d 7328 293a 0a20 2020 2020  p.items():.     
-00027140: 2020 2072 656d 6f74 655f 7265 736f 7572     remote_resour
-00027150: 6365 5f6e 616d 6573 203d 205b 7265 2e73  ce_names = [re.s
-00027160: 7562 2866 225e 7b6f 6c64 5f77 737d 5c2e  ub(f"^{old_ws}\.
-00027170: 222c 2066 227b 6e65 775f 7773 7d2e 222c  ", f"{new_ws}.",
-00027180: 2078 2920 666f 7220 7820 696e 2072 656d   x) for x in rem
-00027190: 6f74 655f 7265 736f 7572 6365 5f6e 616d  ote_resource_nam
-000271a0: 6573 5d0a 0a20 2020 2069 6620 6e6f 7420  es]..    if not 
-000271b0: 6669 6c65 6e61 6d65 733a 0a20 2020 2020  filenames:.     
-000271c0: 2020 2066 696c 656e 616d 6573 203d 2067     filenames = g
-000271d0: 6574 5f70 726f 6a65 6374 5f66 696c 656e  et_project_filen
-000271e0: 616d 6573 2866 6f6c 6465 7229 0a0a 2020  ames(folder)..  
-000271f0: 2020 2320 6765 7420 7468 6520 6c69 7374    # get the list
-00027200: 206f 6620 6368 616e 6765 730a 2020 2020   of changes.    
-00027210: 6368 616e 6765 642c 2064 656c 6574 6564  changed, deleted
-00027220: 203d 2061 7761 6974 2064 6570 6c6f 796d   = await deploym
-00027230: 656e 742e 6465 7465 6374 5f63 6861 6e67  ent.detect_chang
-00027240: 6573 2866 696c 656e 616d 6573 2c20 6f6e  es(filenames, on
-00027250: 6c79 5f63 6861 6e67 6573 2c20 636f 6e66  ly_changes, conf
-00027260: 6967 2c20 7573 655f 6d61 696e 290a 0a20  ig, use_main).. 
-00027270: 2020 2064 6570 6c6f 796d 656e 742e 6368     deployment.ch
-00027280: 6563 6b5f 6368 616e 6765 7328 6368 616e  eck_changes(chan
-00027290: 6765 642c 2070 6970 6573 2c20 7265 6c65  ged, pipes, rele
-000272a0: 6173 655f 6372 6561 7465 6429 0a0a 2020  ase_created)..  
-000272b0: 2020 6465 706c 6f79 6d65 6e74 2e70 7265    deployment.pre
-000272c0: 7061 7269 6e67 5f72 656c 6561 7365 2829  paring_release()
-000272d0: 0a0a 2020 2020 2320 6275 696c 6420 6772  ..    # build gr
-000272e0: 6170 6820 746f 2067 6574 206e 6577 2076  aph to get new v
-000272f0: 6572 7369 6f6e 7320 666f 7220 616c 6c20  ersions for all 
-00027300: 7468 6520 6669 6c65 7320 696e 766f 6c76  the files involv
-00027310: 6564 2069 6e20 7468 6520 7175 6572 790a  ed in the query.
-00027320: 2020 2020 2320 6465 7065 6e64 656e 6369      # dependenci
-00027330: 6573 206e 6565 6420 746f 2062 6520 7072  es need to be pr
-00027340: 6f63 6573 7365 6420 616c 7761 7973 2074  ocessed always t
-00027350: 6f20 6765 7420 7468 6520 7665 7273 696f  o get the versio
-00027360: 6e73 0a20 2020 2064 6570 656e 6465 6e63  ns.    dependenc
-00027370: 6965 735f 6772 6170 6820 3d20 6177 6169  ies_graph = awai
-00027380: 7420 6275 696c 645f 6772 6170 6828 0a20  t build_graph(. 
-00027390: 2020 2020 2020 2066 696c 656e 616d 6573         filenames
-000273a0: 2c0a 2020 2020 2020 2020 7462 5f63 6c69  ,.        tb_cli
-000273b0: 656e 742c 0a20 2020 2020 2020 2064 6972  ent,.        dir
-000273c0: 5f70 6174 683d 666f 6c64 6572 2c0a 2020  _path=folder,.  
-000273d0: 2020 2020 2020 7072 6f63 6573 735f 6465        process_de
-000273e0: 7065 6e64 656e 6369 6573 3d54 7275 652c  pendencies=True,
-000273f0: 0a20 2020 2020 2020 2077 6f72 6b73 7061  .        workspa
-00027400: 6365 5f6d 6170 3d77 6f72 6b73 7061 6365  ce_map=workspace
-00027410: 5f6d 6170 2c0a 2020 2020 2020 2020 736b  _map,.        sk
-00027420: 6970 5f63 6f6e 6e65 6374 6f72 733d 5472  ip_connectors=Tr
-00027430: 7565 2c0a 2020 2020 2020 2020 776f 726b  ue,.        work
-00027440: 7370 6163 655f 6c69 625f 7061 7468 733d  space_lib_paths=
-00027450: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
-00027460: 7468 732c 0a20 2020 2020 2020 2063 7572  ths,.        cur
-00027470: 7265 6e74 5f77 733d 6375 7272 656e 745f  rent_ws=current_
-00027480: 7773 2c0a 2020 2020 2020 2020 6368 616e  ws,.        chan
-00027490: 6765 643d 6368 616e 6765 642c 0a20 2020  ged=changed,.   
-000274a0: 2020 2020 206f 6e6c 795f 6368 616e 6765       only_change
-000274b0: 733d 6f6e 6c79 5f63 6861 6e67 6573 206f  s=only_changes o
-000274c0: 7220 2864 6570 6c6f 796d 656e 742e 6973  r (deployment.is
-000274d0: 5f67 6974 5f72 656c 6561 7365 2061 6e64  _git_release and
-000274e0: 2068 6173 5f73 656d 7665 7229 2c0a 2020   has_semver),.  
-000274f0: 2020 2020 2020 666f 726b 5f64 6f77 6e73        fork_downs
-00027500: 7472 6561 6d3d 666f 726b 5f64 6f77 6e73  tream=fork_downs
-00027510: 7472 6561 6d2c 0a20 2020 2020 2020 2069  tream,.        i
-00027520: 735f 696e 7465 726e 616c 3d69 735f 696e  s_internal=is_in
-00027530: 7465 726e 616c 2c0a 2020 2020 290a 0a20  ternal,.    ).. 
-00027540: 2020 2023 2075 7064 6174 6520 6578 6973     # update exis
-00027550: 7469 6e67 2076 6572 7369 6f6e 730a 2020  ting versions.  
-00027560: 2020 6966 206e 6f74 206e 6f5f 7665 7273    if not no_vers
-00027570: 696f 6e73 3a0a 2020 2020 2020 2020 7265  ions:.        re
-00027580: 736f 7572 6365 5f76 6572 7369 6f6e 7320  source_versions 
-00027590: 3d20 6765 745f 7265 736f 7572 6365 5f76  = get_resource_v
-000275a0: 6572 7369 6f6e 7328 6578 6973 7469 6e67  ersions(existing
-000275b0: 5f72 6573 6f75 7263 6573 290a 2020 2020  _resources).    
-000275c0: 2020 2020 6c61 7465 7374 5f64 6174 6173      latest_datas
-000275d0: 6f75 7263 655f 7665 7273 696f 6e73 203d  ource_versions =
-000275e0: 2072 6573 6f75 7263 655f 7665 7273 696f   resource_versio
-000275f0: 6e73 2e63 6f70 7928 290a 0a20 2020 2020  ns.copy()..     
-00027600: 2020 2066 6f72 2064 6570 2069 6e20 6465     for dep in de
-00027610: 7065 6e64 656e 6369 6573 5f67 7261 7068  pendencies_graph
-00027620: 2e74 6f5f 7275 6e2e 7661 6c75 6573 2829  .to_run.values()
-00027630: 3a0a 2020 2020 2020 2020 2020 2020 6473  :.            ds
-00027640: 203d 2064 6570 5b22 7265 736f 7572 6365   = dep["resource
-00027650: 5f6e 616d 6522 5d0a 2020 2020 2020 2020  _name"].        
-00027660: 2020 2020 6966 2064 6570 5b22 7665 7273      if dep["vers
-00027670: 696f 6e22 5d20 6973 206e 6f74 204e 6f6e  ion"] is not Non
-00027680: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00027690: 2020 206c 6174 6573 745f 6461 7461 736f     latest_dataso
-000276a0: 7572 6365 5f76 6572 7369 6f6e 735b 6473  urce_versions[ds
-000276b0: 5d20 3d20 6465 705b 2276 6572 7369 6f6e  ] = dep["version
-000276c0: 225d 0a20 2020 2065 6c73 653a 0a20 2020  "].    else:.   
-000276d0: 2020 2020 2072 6573 6f75 7263 655f 7665       resource_ve
-000276e0: 7273 696f 6e73 203d 207b 7d0a 2020 2020  rsions = {}.    
-000276f0: 2020 2020 6c61 7465 7374 5f64 6174 6173      latest_datas
-00027700: 6f75 7263 655f 7665 7273 696f 6e73 203d  ource_versions =
-00027710: 207b 7d0a 0a20 2020 2023 2049 6620 7765   {}..    # If we
-00027720: 2068 6176 6520 6461 7461 736f 7572 6365   have datasource
-00027730: 7320 7573 696e 6720 5645 5253 494f 4e2c  s using VERSION,
-00027740: 206c 6574 2773 2074 7279 2074 6f20 6765   let's try to ge
-00027750: 7420 7468 6520 6c61 7465 7374 2076 6572  t the latest ver
-00027760: 7369 6f6e 0a20 2020 2064 6570 656e 6465  sion.    depende
-00027770: 6e63 6965 735f 6772 6170 6820 3d20 6177  ncies_graph = aw
-00027780: 6169 7420 6275 696c 645f 6772 6170 6828  ait build_graph(
-00027790: 0a20 2020 2020 2020 2066 696c 656e 616d  .        filenam
-000277a0: 6573 2c0a 2020 2020 2020 2020 7462 5f63  es,.        tb_c
-000277b0: 6c69 656e 742c 0a20 2020 2020 2020 2064  lient,.        d
-000277c0: 6972 5f70 6174 683d 666f 6c64 6572 2c0a  ir_path=folder,.
-000277d0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-000277e0: 5f76 6572 7369 6f6e 733d 6c61 7465 7374  _versions=latest
-000277f0: 5f64 6174 6173 6f75 7263 655f 7665 7273  _datasource_vers
-00027800: 696f 6e73 2c0a 2020 2020 2020 2020 776f  ions,.        wo
-00027810: 726b 7370 6163 655f 6d61 703d 776f 726b  rkspace_map=work
-00027820: 7370 6163 655f 6d61 702c 0a20 2020 2020  space_map,.     
-00027830: 2020 2070 726f 6365 7373 5f64 6570 656e     process_depen
-00027840: 6465 6e63 6965 733d 7075 7368 5f64 6570  dencies=push_dep
-00027850: 732c 0a20 2020 2020 2020 2076 6572 626f  s,.        verbo
-00027860: 7365 3d76 6572 626f 7365 2c0a 2020 2020  se=verbose,.    
-00027870: 2020 2020 776f 726b 7370 6163 655f 6c69      workspace_li
-00027880: 625f 7061 7468 733d 776f 726b 7370 6163  b_paths=workspac
-00027890: 655f 6c69 625f 7061 7468 732c 0a20 2020  e_lib_paths,.   
-000278a0: 2020 2020 2063 7572 7265 6e74 5f77 733d       current_ws=
-000278b0: 6375 7272 656e 745f 7773 2c0a 2020 2020  current_ws,.    
-000278c0: 2020 2020 6368 616e 6765 643d 6368 616e      changed=chan
-000278d0: 6765 642c 0a20 2020 2020 2020 206f 6e6c  ged,.        onl
-000278e0: 795f 6368 616e 6765 733d 6f6e 6c79 5f63  y_changes=only_c
-000278f0: 6861 6e67 6573 206f 7220 2864 6570 6c6f  hanges or (deplo
-00027900: 796d 656e 742e 6973 5f67 6974 5f72 656c  yment.is_git_rel
-00027910: 6561 7365 2061 6e64 2068 6173 5f73 656d  ease and has_sem
-00027920: 7665 7229 2c0a 2020 2020 2020 2020 666f  ver),.        fo
-00027930: 726b 5f64 6f77 6e73 7472 6561 6d3d 666f  rk_downstream=fo
-00027940: 726b 5f64 6f77 6e73 7472 6561 6d2c 0a20  rk_downstream,. 
-00027950: 2020 2020 2020 2069 735f 696e 7465 726e         is_intern
-00027960: 616c 3d69 735f 696e 7465 726e 616c 2c0a  al=is_internal,.
-00027970: 2020 2020 290a 0a20 2020 2069 6620 6465      )..    if de
-00027980: 6275 673a 0a20 2020 2020 2020 2070 702e  bug:.        pp.
-00027990: 7070 7269 6e74 2864 6570 656e 6465 6e63  pprint(dependenc
-000279a0: 6965 735f 6772 6170 682e 746f 5f72 756e  ies_graph.to_run
-000279b0: 290a 0a20 2020 2069 6620 7665 7262 6f73  )..    if verbos
-000279c0: 653a 0a20 2020 2020 2020 2063 6c69 636b  e:.        click
-000279d0: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
-000279e0: 6e61 6765 722e 696e 666f 5f62 7569 6c64  nager.info_build
-000279f0: 696e 675f 6465 7065 6e64 656e 6369 6573  ing_dependencies
-00027a00: 2829 290a 0a20 2020 2064 6570 6c6f 796d  ())..    deploym
-00027a10: 656e 742e 7072 6570 6172 696e 675f 6465  ent.preparing_de
-00027a20: 7065 6e64 656e 6369 6573 2863 6861 6e67  pendencies(chang
-00027a30: 6564 2c20 6465 7065 6e64 656e 6369 6573  ed, dependencies
-00027a40: 5f67 7261 7068 2e64 6570 5f6d 6170 2c20  _graph.dep_map, 
-00027a50: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
-00027a60: 655f 7665 7273 696f 6e73 290a 0a20 2020  e_versions)..   
-00027a70: 2064 6566 2073 686f 756c 645f 7075 7368   def should_push
-00027a80: 5f66 696c 6528 0a20 2020 2020 2020 206e  _file(.        n
-00027a90: 616d 653a 2073 7472 2c0a 2020 2020 2020  ame: str,.      
-00027aa0: 2020 7265 6d6f 7465 5f72 6573 6f75 7263    remote_resourc
-00027ab0: 655f 6e61 6d65 733a 204c 6973 745b 7374  e_names: List[st
-00027ac0: 725d 2c0a 2020 2020 2020 2020 6c61 7465  r],.        late
-00027ad0: 7374 5f64 6174 6173 6f75 7263 655f 7665  st_datasource_ve
-00027ae0: 7273 696f 6e73 3a20 4469 6374 5b73 7472  rsions: Dict[str
-00027af0: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
-00027b00: 666f 7263 653a 2062 6f6f 6c2c 0a20 2020  force: bool,.   
-00027b10: 2020 2020 2072 756e 5f74 6573 7473 3a20       run_tests: 
-00027b20: 626f 6f6c 2c0a 2020 2020 2920 2d3e 2062  bool,.    ) -> b
-00027b30: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
-00027b40: 0a20 2020 2020 2020 2046 756e 6374 696f  .        Functio
-00027b50: 6e20 746f 206b 6e6f 7720 6966 2077 6520  n to know if we 
-00027b60: 6e65 6564 2074 6f20 7275 6e20 6120 6669  need to run a fi
-00027b70: 6c65 206f 7220 6e6f 740a 2020 2020 2020  le or not.      
-00027b80: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-00027b90: 206e 616d 6520 6e6f 7420 696e 2072 656d   name not in rem
-00027ba0: 6f74 655f 7265 736f 7572 6365 5f6e 616d  ote_resource_nam
-00027bb0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00027bc0: 7265 7475 726e 2054 7275 650a 2020 2020  return True.    
-00027bd0: 2020 2020 2320 5768 656e 2077 6520 6e65      # When we ne
-00027be0: 6564 2074 6f20 7472 7920 746f 2070 7573  ed to try to pus
-00027bf0: 6820 6120 6669 6c65 2077 6865 6e20 6974  h a file when it
-00027c00: 2064 6f65 736e 2774 2065 7869 7374 2061   doesn't exist a
-00027c10: 6e64 2074 6865 2076 6572 7369 6f6e 2069  nd the version i
-00027c20: 7320 6469 6666 6572 656e 7420 7468 6174  s different that
-00027c30: 2074 6865 2065 7869 7374 696e 6720 6f6e   the existing on
-00027c40: 650a 2020 2020 2020 2020 7265 736f 7572  e.        resour
-00027c50: 6365 5f66 756c 6c5f 6e61 6d65 203d 2028  ce_full_name = (
-00027c60: 0a20 2020 2020 2020 2020 2020 2066 227b  .            f"{
-00027c70: 6e61 6d65 7d5f 5f76 7b6c 6174 6573 745f  name}__v{latest_
-00027c80: 6461 7461 736f 7572 6365 5f76 6572 7369  datasource_versi
-00027c90: 6f6e 732e 6765 7428 6e61 6d65 297d 2220  ons.get(name)}" 
-00027ca0: 6966 206e 616d 6520 696e 206c 6174 6573  if name in lates
-00027cb0: 745f 6461 7461 736f 7572 6365 5f76 6572  t_datasource_ver
-00027cc0: 7369 6f6e 7320 656c 7365 206e 616d 650a  sions else name.
-00027cd0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00027ce0: 2020 6966 2072 6573 6f75 7263 655f 6675    if resource_fu
-00027cf0: 6c6c 5f6e 616d 6520 6e6f 7420 696e 2065  ll_name not in e
-00027d00: 7869 7374 696e 675f 7265 736f 7572 6365  xisting_resource
-00027d10: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00027d20: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
-00027d30: 2020 2069 6620 666f 7263 6520 6f72 2072     if force or r
-00027d40: 756e 5f74 6573 7473 3a0a 2020 2020 2020  un_tests:.      
-00027d50: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-00027d60: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
-00027d70: 2046 616c 7365 0a0a 2020 2020 6173 796e   False..    asyn
-00027d80: 6320 6465 6620 7075 7368 280a 2020 2020  c def push(.    
-00027d90: 2020 2020 6e61 6d65 3a20 7374 722c 0a20      name: str,. 
-00027da0: 2020 2020 2020 2074 6f5f 7275 6e3a 2044         to_run: D
-00027db0: 6963 745b 7374 722c 2044 6963 745b 7374  ict[str, Dict[st
-00027dc0: 722c 2041 6e79 5d5d 2c0a 2020 2020 2020  r, Any]],.      
-00027dd0: 2020 7265 736f 7572 6365 5f76 6572 7369    resource_versi
-00027de0: 6f6e 733a 2044 6963 745b 7374 722c 2041  ons: Dict[str, A
-00027df0: 6e79 5d2c 0a20 2020 2020 2020 206c 6174  ny],.        lat
-00027e00: 6573 745f 6461 7461 736f 7572 6365 5f76  est_datasource_v
-00027e10: 6572 7369 6f6e 733a 2044 6963 745b 7374  ersions: Dict[st
-00027e20: 722c 2041 6e79 5d2c 0a20 2020 2020 2020  r, Any],.       
-00027e30: 2064 7279 5f72 756e 3a20 626f 6f6c 2c0a   dry_run: bool,.
-00027e40: 2020 2020 2020 2020 666f 726b 5f64 6f77          fork_dow
-00027e50: 6e73 7472 6561 6d3a 204f 7074 696f 6e61  nstream: Optiona
-00027e60: 6c5b 626f 6f6c 5d20 3d20 4661 6c73 652c  l[bool] = False,
-00027e70: 0a20 2020 2020 2020 2066 6f72 6b3a 204f  .        fork: O
-00027e80: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
-00027e90: 4661 6c73 652c 0a20 2020 2029 3a0a 2020  False,.    ):.  
-00027ea0: 2020 2020 2020 6966 206e 616d 6520 696e        if name in
-00027eb0: 2074 6f5f 7275 6e3a 0a20 2020 2020 2020   to_run:.       
-00027ec0: 2020 2020 2069 6620 6e6f 7420 6472 795f       if not dry_
-00027ed0: 7275 6e3a 0a20 2020 2020 2020 2020 2020  run:.           
-00027ee0: 2020 2020 2069 6620 7368 6f75 6c64 5f70       if should_p
-00027ef0: 7573 685f 6669 6c65 286e 616d 652c 2072  ush_file(name, r
-00027f00: 656d 6f74 655f 7265 736f 7572 6365 5f6e  emote_resource_n
-00027f10: 616d 6573 2c20 6c61 7465 7374 5f64 6174  ames, latest_dat
-00027f20: 6173 6f75 7263 655f 7665 7273 696f 6e73  asource_versions
-00027f30: 2c20 666f 7263 652c 2072 756e 5f74 6573  , force, run_tes
-00027f40: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
-00027f50: 2020 2020 2020 2020 2069 6620 6e61 6d65           if name
-00027f60: 206e 6f74 2069 6e20 7265 736f 7572 6365   not in resource
-00027f70: 5f76 6572 7369 6f6e 733a 0a20 2020 2020  _versions:.     
-00027f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027f90: 2020 2076 6572 7369 6f6e 203d 2022 220a     version = "".
-00027fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027fb0: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
-00027fc0: 696e 206c 6174 6573 745f 6461 7461 736f  in latest_dataso
-00027fd0: 7572 6365 5f76 6572 7369 6f6e 733a 0a20  urce_versions:. 
-00027fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ff0: 2020 2020 2020 2020 2020 2076 6572 7369             versi
-00028000: 6f6e 203d 2066 2228 767b 6c61 7465 7374  on = f"(v{latest
-00028010: 5f64 6174 6173 6f75 7263 655f 7665 7273  _datasource_vers
-00028020: 696f 6e73 5b6e 616d 655d 7d29 220a 2020  ions[name]})".  
-00028030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028040: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-00028050: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-00028060: 2e69 6e66 6f5f 7072 6f63 6573 7369 6e67  .info_processing
-00028070: 5f6e 6577 5f72 6573 6f75 7263 6528 6e61  _new_resource(na
-00028080: 6d65 3d6e 616d 652c 2076 6572 7369 6f6e  me=name, version
-00028090: 3d76 6572 7369 6f6e 2929 0a20 2020 2020  =version)).     
-000280a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000280b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000280c0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-000280d0: 636b 2e65 6368 6f28 0a20 2020 2020 2020  ck.echo(.       
+00025d20: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00025d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d40: 2020 2020 2020 2020 2070 726f 6365 7373           process
+00025d50: 6564 5f66 696c 656e 616d 6520 3d20 662e  ed_filename = f.
+00025d60: 7265 6c61 7469 7665 5f74 6f28 6f73 2e67  relative_to(os.g
+00025d70: 6574 6377 6428 2929 0a20 2020 2020 2020  etcwd()).       
+00025d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d90: 2020 2020 2065 7863 6570 7420 5661 6c75       except Valu
+00025da0: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+00025db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025dc0: 2020 2020 2020 2020 7072 6f63 6573 7365          processe
+00025dd0: 645f 6669 6c65 6e61 6d65 203d 2066 0a20  d_filename = f. 
+00025de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025df0: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+00025e00: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
+00025e10: 6e61 6765 722e 696e 666f 5f70 726f 6365  nager.info_proce
+00025e20: 7373 696e 675f 6669 6c65 2866 696c 656e  ssing_file(filen
+00025e30: 616d 653d 7072 6f63 6573 7365 645f 6669  ame=processed_fi
+00025e40: 6c65 6e61 6d65 2929 0a20 2020 2020 2020  lename)).       
+00025e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025e60: 2061 7761 6974 2070 726f 6365 7373 2873   await process(s
+00025e70: 7472 2866 292c 2064 6570 732c 2064 6570  tr(f), deps, dep
+00025e80: 5f6d 6170 2c20 746f 5f72 756e 2c20 776f  _map, to_run, wo
+00025e90: 726b 7370 6163 655f 6c69 625f 7061 7468  rkspace_lib_path
+00025ea0: 7329 0a0a 2020 2020 7265 7475 726e 2047  s)..    return G
+00025eb0: 7261 7068 4465 7065 6e64 656e 6369 6573  raphDependencies
+00025ec0: 2864 6570 5f6d 6170 2c20 746f 5f72 756e  (dep_map, to_run
+00025ed0: 2c20 616c 6c5f 6465 705f 6d61 702c 2061  , all_dep_map, a
+00025ee0: 6c6c 5f72 6573 6f75 7263 6573 290a 0a0a  ll_resources)...
+00025ef0: 6173 796e 6320 6465 6620 6765 745f 6368  async def get_ch
+00025f00: 616e 6765 735f 6672 6f6d 5f6d 6169 6e28  anges_from_main(
+00025f10: 0a20 2020 206f 6e6c 795f 6368 616e 6765  .    only_change
+00025f20: 733a 2062 6f6f 6c2c 0a20 2020 2063 6c69  s: bool,.    cli
+00025f30: 656e 743a 2054 696e 7942 2c0a 2020 2020  ent: TinyB,.    
+00025f40: 636f 6e66 6967 3a20 4f70 7469 6f6e 616c  config: Optional
+00025f50: 5b44 6963 745b 7374 722c 2041 6e79 5d5d  [Dict[str, Any]]
+00025f60: 203d 204e 6f6e 652c 0a20 2020 2063 7572   = None,.    cur
+00025f70: 7265 6e74 5f77 733a 204f 7074 696f 6e61  rent_ws: Optiona
+00025f80: 6c5b 4469 6374 5b73 7472 2c20 416e 795d  l[Dict[str, Any]
+00025f90: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 6669  ] = None,.    fi
+00025fa0: 6c65 6e61 6d65 733a 204f 7074 696f 6e61  lenames: Optiona
+00025fb0: 6c5b 4c69 7374 5b73 7472 5d5d 203d 204e  l[List[str]] = N
+00025fc0: 6f6e 652c 0a29 3a0a 2020 2020 6368 616e  one,.):.    chan
+00025fd0: 6765 6420 3d20 4e6f 6e65 0a20 2020 2069  ged = None.    i
+00025fe0: 6620 6e6f 7420 6f6e 6c79 5f63 6861 6e67  f not only_chang
+00025ff0: 6573 3a0a 2020 2020 2020 2020 7265 7475  es:.        retu
+00026000: 726e 2063 6861 6e67 6564 0a0a 2020 2020  rn changed..    
+00026010: 6966 2063 7572 7265 6e74 5f77 7320 616e  if current_ws an
+00026020: 6420 6e6f 7420 6375 7272 656e 745f 7773  d not current_ws
+00026030: 2e67 6574 2822 6973 5f62 7261 6e63 6822  .get("is_branch"
+00026040: 293a 0a20 2020 2020 2020 2063 6861 6e67  ):.        chang
+00026050: 6564 203d 2061 7761 6974 2064 6966 665f  ed = await diff_
+00026060: 636f 6d6d 616e 6428 6669 6c65 6e61 6d65  command(filename
+00026070: 732c 2054 7275 652c 2063 6c69 656e 742c  s, True, client,
+00026080: 206e 6f5f 636f 6c6f 723d 5472 7565 2c20   no_color=True, 
+00026090: 7769 7468 5f70 7269 6e74 3d46 616c 7365  with_print=False
+000260a0: 290a 2020 2020 656c 6966 2063 6f6e 6669  ).    elif confi
+000260b0: 6720 616e 6420 636f 6e66 6967 2e67 6574  g and config.get
+000260c0: 2822 686f 7374 2229 3a0a 2020 2020 2020  ("host"):.      
+000260d0: 2020 776f 726b 7370 6163 6520 3d20 6177    workspace = aw
+000260e0: 6169 7420 6765 745f 6375 7272 656e 745f  ait get_current_
+000260f0: 6d61 696e 5f77 6f72 6b73 7061 6365 2863  main_workspace(c
+00026100: 6c69 656e 742c 2063 6f6e 6669 6729 0a0a  lient, config)..
+00026110: 2020 2020 2020 2020 6966 2077 6f72 6b73          if works
+00026120: 7061 6365 3a0a 2020 2020 2020 2020 2020  pace:.          
+00026130: 2020 7773 5f63 6c69 656e 7420 3d20 5f67    ws_client = _g
+00026140: 6574 5f74 625f 636c 6965 6e74 2877 6f72  et_tb_client(wor
+00026150: 6b73 7061 6365 5b22 746f 6b65 6e22 5d2c  kspace["token"],
+00026160: 2063 6f6e 6669 675b 2268 6f73 7422 5d29   config["host"])
+00026170: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
+00026180: 6e67 6564 203d 2061 7761 6974 2064 6966  nged = await dif
+00026190: 665f 636f 6d6d 616e 6428 6669 6c65 6e61  f_command(filena
+000261a0: 6d65 732c 2054 7275 652c 2077 735f 636c  mes, True, ws_cl
+000261b0: 6965 6e74 2c20 6e6f 5f63 6f6c 6f72 3d54  ient, no_color=T
+000261c0: 7275 652c 2077 6974 685f 7072 696e 743d  rue, with_print=
+000261d0: 4661 6c73 6529 0a20 2020 2072 6574 7572  False).    retur
+000261e0: 6e20 6368 616e 6765 640a 0a0a 6465 6620  n changed...def 
+000261f0: 6765 745f 7072 6f6a 6563 745f 6669 6c65  get_project_file
+00026200: 6e61 6d65 7328 666f 6c64 6572 3a20 7374  names(folder: st
+00026210: 722c 2077 6974 685f 7665 6e64 6f72 3d46  r, with_vendor=F
+00026220: 616c 7365 2920 2d3e 204c 6973 745b 7374  alse) -> List[st
+00026230: 725d 3a0a 2020 2020 666f 6c64 6572 733a  r]:.    folders:
+00026240: 204c 6973 745b 7374 725d 203d 205b 0a20   List[str] = [. 
+00026250: 2020 2020 2020 2066 227b 666f 6c64 6572         f"{folder
+00026260: 7d2f 2a2e 6461 7461 736f 7572 6365 222c  }/*.datasource",
+00026270: 0a20 2020 2020 2020 2066 227b 666f 6c64  .        f"{fold
+00026280: 6572 7d2f 6461 7461 736f 7572 6365 732f  er}/datasources/
+00026290: 2a2e 6461 7461 736f 7572 6365 222c 0a20  *.datasource",. 
+000262a0: 2020 2020 2020 2066 227b 666f 6c64 6572         f"{folder
+000262b0: 7d2f 2a2e 7069 7065 222c 0a20 2020 2020  }/*.pipe",.     
+000262c0: 2020 2066 227b 666f 6c64 6572 7d2f 7069     f"{folder}/pi
+000262d0: 7065 732f 2a2e 7069 7065 222c 0a20 2020  pes/*.pipe",.   
+000262e0: 2020 2020 2066 227b 666f 6c64 6572 7d2f       f"{folder}/
+000262f0: 656e 6470 6f69 6e74 732f 2a2e 7069 7065  endpoints/*.pipe
+00026300: 222c 0a20 2020 2020 2020 2066 227b 666f  ",.        f"{fo
+00026310: 6c64 6572 7d2f 2a2e 746f 6b65 6e22 2c0a  lder}/*.token",.
+00026320: 2020 2020 2020 2020 6622 7b66 6f6c 6465          f"{folde
+00026330: 727d 2f74 6f6b 656e 732f 2a2e 746f 6b65  r}/tokens/*.toke
+00026340: 6e22 2c0a 2020 2020 5d0a 2020 2020 6966  n",.    ].    if
+00026350: 2077 6974 685f 7665 6e64 6f72 3a0a 2020   with_vendor:.  
+00026360: 2020 2020 2020 666f 6c64 6572 732e 6170        folders.ap
+00026370: 7065 6e64 2866 227b 666f 6c64 6572 7d2f  pend(f"{folder}/
+00026380: 7665 6e64 6f72 2f2a 2a2f 2a2a 2f2a 2e64  vendor/**/**/*.d
+00026390: 6174 6173 6f75 7263 6522 290a 2020 2020  atasource").    
+000263a0: 6669 6c65 6e61 6d65 733a 204c 6973 745b  filenames: List[
+000263b0: 7374 725d 203d 205b 5d0a 2020 2020 666f  str] = [].    fo
+000263c0: 7220 7820 696e 2066 6f6c 6465 7273 3a0a  r x in folders:.
+000263d0: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
+000263e0: 7320 2b3d 2067 6c6f 622e 676c 6f62 2878  s += glob.glob(x
+000263f0: 290a 2020 2020 7265 7475 726e 2066 696c  ).    return fil
+00026400: 656e 616d 6573 0a0a 0a64 6566 2069 735f  enames...def is_
+00026410: 6e65 7728 0a20 2020 206e 616d 653a 2073  new(.    name: s
+00026420: 7472 2c0a 2020 2020 6368 616e 6765 643a  tr,.    changed:
+00026430: 2044 6963 745b 7374 722c 2073 7472 5d2c   Dict[str, str],
+00026440: 0a20 2020 206e 6f72 6d61 6c5f 6465 7065  .    normal_depe
+00026450: 6e64 656e 6379 3a20 4469 6374 5b73 7472  ndency: Dict[str
+00026460: 2c20 5365 745b 7374 725d 5d2c 0a20 2020  , Set[str]],.   
+00026470: 2066 6f72 6b5f 646f 776e 7374 7265 616d   fork_downstream
+00026480: 5f64 6570 656e 6465 6e63 793a 2044 6963  _dependency: Dic
+00026490: 745b 7374 722c 2053 6574 5b73 7472 5d5d  t[str, Set[str]]
+000264a0: 2c0a 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ,.) -> bool:.   
+000264b0: 2064 6566 2069 735f 6769 745f 6e65 7728   def is_git_new(
+000264c0: 6e61 6d65 3a20 7374 7229 3a0a 2020 2020  name: str):.    
+000264d0: 2020 2020 7265 7475 726e 2063 6861 6e67      return chang
+000264e0: 6564 2061 6e64 2063 6861 6e67 6564 2e67  ed and changed.g
+000264f0: 6574 286e 616d 6529 203d 3d20 2241 220a  et(name) == "A".
+00026500: 0a20 2020 2069 6620 6e6f 7420 6973 5f67  .    if not is_g
+00026510: 6974 5f6e 6577 286e 616d 6529 3a0a 2020  it_new(name):.  
+00026520: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00026530: 7365 0a0a 2020 2020 2320 6966 2073 686f  se..    # if sho
+00026540: 756c 6420 6e6f 7420 6465 7065 6e64 206f  uld not depend o
+00026550: 6e20 6120 6368 616e 6765 6420 7265 736f  n a changed reso
+00026560: 7572 6365 0a20 2020 2069 6620 6261 636b  urce.    if back
+00026570: 5f64 6570 7320 3a3d 206e 6f72 6d61 6c5f  _deps := normal_
+00026580: 6465 7065 6e64 656e 6379 2e67 6574 286e  dependency.get(n
+00026590: 616d 6529 3a0a 2020 2020 2020 2020 666f  ame):.        fo
+000265a0: 7220 6465 7020 696e 2062 6163 6b5f 6465  r dep in back_de
+000265b0: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+000265c0: 6966 2064 6570 2069 6e20 666f 726b 5f64  if dep in fork_d
+000265d0: 6f77 6e73 7472 6561 6d5f 6465 7065 6e64  ownstream_depend
+000265e0: 656e 6379 2061 6e64 206e 6f74 2069 735f  ency and not is_
+000265f0: 6769 745f 6e65 7728 6465 7029 3a0a 2020  git_new(dep):.  
+00026600: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00026610: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+00026620: 7265 7475 726e 2054 7275 650a 0a0a 6173  return True...as
+00026630: 796e 6320 6465 6620 666f 6c64 6572 5f70  ync def folder_p
+00026640: 7573 6828 0a20 2020 2074 625f 636c 6965  ush(.    tb_clie
+00026650: 6e74 3a20 5469 6e79 422c 0a20 2020 2066  nt: TinyB,.    f
+00026660: 696c 656e 616d 6573 3a20 4f70 7469 6f6e  ilenames: Option
+00026670: 616c 5b4c 6973 745b 7374 725d 5d20 3d20  al[List[str]] = 
+00026680: 4e6f 6e65 2c0a 2020 2020 6472 795f 7275  None,.    dry_ru
+00026690: 6e3a 2062 6f6f 6c20 3d20 4661 6c73 652c  n: bool = False,
+000266a0: 0a20 2020 2063 6865 636b 3a20 626f 6f6c  .    check: bool
+000266b0: 203d 2046 616c 7365 2c0a 2020 2020 7075   = False,.    pu
+000266c0: 7368 5f64 6570 733a 2062 6f6f 6c20 3d20  sh_deps: bool = 
+000266d0: 4661 6c73 652c 0a20 2020 206f 6e6c 795f  False,.    only_
+000266e0: 6368 616e 6765 733a 2062 6f6f 6c20 3d20  changes: bool = 
+000266f0: 4661 6c73 652c 0a20 2020 2067 6974 5f72  False,.    git_r
+00026700: 656c 6561 7365 3a20 626f 6f6c 203d 2046  elease: bool = F
+00026710: 616c 7365 2c0a 2020 2020 6465 6275 673a  alse,.    debug:
+00026720: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00026730: 2020 2066 6f72 6365 3a20 626f 6f6c 203d     force: bool =
+00026740: 2046 616c 7365 2c0a 2020 2020 6f76 6572   False,.    over
+00026750: 7269 6465 5f64 6174 6173 6f75 7263 653a  ride_datasource:
+00026760: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+00026770: 2020 2066 6f6c 6465 723a 2073 7472 203d     folder: str =
+00026780: 2022 2e22 2c0a 2020 2020 706f 7075 6c61   ".",.    popula
+00026790: 7465 3a20 626f 6f6c 203d 2046 616c 7365  te: bool = False
+000267a0: 2c0a 2020 2020 706f 7075 6c61 7465 5f73  ,.    populate_s
+000267b0: 7562 7365 743d 4e6f 6e65 2c0a 2020 2020  ubset=None,.    
+000267c0: 706f 7075 6c61 7465 5f63 6f6e 6469 7469  populate_conditi
+000267d0: 6f6e 3a20 4f70 7469 6f6e 616c 5b73 7472  on: Optional[str
+000267e0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 756e  ] = None,.    un
+000267f0: 6c69 6e6b 5f6f 6e5f 706f 7075 6c61 7465  link_on_populate
+00026800: 5f65 7272 6f72 3a20 626f 6f6c 203d 2046  _error: bool = F
+00026810: 616c 7365 2c0a 2020 2020 7570 6c6f 6164  alse,.    upload
+00026820: 5f66 6978 7475 7265 733a 2062 6f6f 6c20  _fixtures: bool 
+00026830: 3d20 4661 6c73 652c 0a20 2020 2077 6169  = False,.    wai
+00026840: 743a 2062 6f6f 6c20 3d20 4661 6c73 652c  t: bool = False,
+00026850: 0a20 2020 2069 676e 6f72 655f 7371 6c5f  .    ignore_sql_
+00026860: 6572 726f 7273 3a20 626f 6f6c 203d 2046  errors: bool = F
+00026870: 616c 7365 2c0a 2020 2020 736b 6970 5f63  alse,.    skip_c
+00026880: 6f6e 6669 726d 6174 696f 6e3a 2062 6f6f  onfirmation: boo
+00026890: 6c20 3d20 4661 6c73 652c 0a20 2020 206f  l = False,.    o
+000268a0: 6e6c 795f 7265 7370 6f6e 7365 5f74 696d  nly_response_tim
+000268b0: 6573 3a20 626f 6f6c 203d 2046 616c 7365  es: bool = False
+000268c0: 2c0a 2020 2020 776f 726b 7370 6163 655f  ,.    workspace_
+000268d0: 6d61 703d 4e6f 6e65 2c0a 2020 2020 776f  map=None,.    wo
+000268e0: 726b 7370 6163 655f 6c69 625f 7061 7468  rkspace_lib_path
+000268f0: 733d 4e6f 6e65 2c0a 2020 2020 6e6f 5f76  s=None,.    no_v
+00026900: 6572 7369 6f6e 733a 2062 6f6f 6c20 3d20  ersions: bool = 
+00026910: 4661 6c73 652c 0a20 2020 2074 696d 656f  False,.    timeo
+00026920: 7574 3d4e 6f6e 652c 0a20 2020 2072 756e  ut=None,.    run
+00026930: 5f74 6573 7473 3a20 626f 6f6c 203d 2046  _tests: bool = F
+00026940: 616c 7365 2c0a 2020 2020 6173 5f73 7461  alse,.    as_sta
+00026950: 6e64 6172 643a 2062 6f6f 6c20 3d20 4661  ndard: bool = Fa
+00026960: 6c73 652c 0a20 2020 2072 6169 7365 5f6f  lse,.    raise_o
+00026970: 6e5f 6578 6973 7473 3a20 626f 6f6c 203d  n_exists: bool =
+00026980: 2046 616c 7365 2c0a 2020 2020 7665 7262   False,.    verb
+00026990: 6f73 653a 2062 6f6f 6c20 3d20 5472 7565  ose: bool = True
+000269a0: 2c0a 2020 2020 7465 7374 735f 746f 5f72  ,.    tests_to_r
+000269b0: 756e 3a20 696e 7420 3d20 302c 0a20 2020  un: int = 0,.   
+000269c0: 2074 6573 7473 5f73 616d 706c 655f 6279   tests_sample_by
+000269d0: 5f70 6172 616d 733a 2069 6e74 203d 2030  _params: int = 0
+000269e0: 2c0a 2020 2020 7465 7374 735f 6669 6c74  ,.    tests_filt
+000269f0: 6572 5f62 793a 204f 7074 696f 6e61 6c5b  er_by: Optional[
+00026a00: 4c69 7374 5b73 7472 5d5d 203d 204e 6f6e  List[str]] = Non
+00026a10: 652c 0a20 2020 2074 6573 7473 5f66 6169  e,.    tests_fai
+00026a20: 6c66 6173 743a 2062 6f6f 6c20 3d20 4661  lfast: bool = Fa
+00026a30: 6c73 652c 0a20 2020 2074 6573 7473 5f69  lse,.    tests_i
+00026a40: 676e 6f72 655f 6f72 6465 723a 2062 6f6f  gnore_order: boo
+00026a50: 6c20 3d20 4661 6c73 652c 0a20 2020 2074  l = False,.    t
+00026a60: 6573 7473 5f76 616c 6964 6174 655f 7072  ests_validate_pr
+00026a70: 6f63 6573 7365 645f 6279 7465 733a 2062  ocessed_bytes: b
+00026a80: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+00026a90: 2074 6573 7473 5f63 6865 636b 5f72 6571   tests_check_req
+00026aa0: 7565 7374 735f 6672 6f6d 5f62 7261 6e63  uests_from_branc
+00026ab0: 683a 2062 6f6f 6c20 3d20 4661 6c73 652c  h: bool = False,
+00026ac0: 0a20 2020 2063 6f6e 6669 673a 204f 7074  .    config: Opt
+00026ad0: 696f 6e61 6c5b 4469 6374 5b73 7472 2c20  ional[Dict[str, 
+00026ae0: 416e 795d 5d20 3d20 4e6f 6e65 2c0a 2020  Any]] = None,.  
+00026af0: 2020 7573 6572 5f74 6f6b 656e 3a20 4f70    user_token: Op
+00026b00: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00026b10: 6e65 2c0a 2020 2020 666f 726b 5f64 6f77  ne,.    fork_dow
+00026b20: 6e73 7472 6561 6d3a 204f 7074 696f 6e61  nstream: Optiona
+00026b30: 6c5b 626f 6f6c 5d20 3d20 4661 6c73 652c  l[bool] = False,
+00026b40: 0a20 2020 2066 6f72 6b3a 204f 7074 696f  .    fork: Optio
+00026b50: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+00026b60: 652c 0a20 2020 2069 735f 696e 7465 726e  e,.    is_intern
+00026b70: 616c 3a20 4f70 7469 6f6e 616c 5b62 6f6f  al: Optional[boo
+00026b80: 6c5d 203d 2046 616c 7365 2c0a 2020 2020  l] = False,.    
+00026b90: 7265 6c65 6173 655f 6372 6561 7465 643a  release_created:
+00026ba0: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+00026bb0: 3d20 4661 6c73 652c 0a20 2020 2061 7574  = False,.    aut
+00026bc0: 6f5f 7072 6f6d 6f74 653a 204f 7074 696f  o_promote: Optio
+00026bd0: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+00026be0: 652c 0a20 2020 2063 6865 636b 5f62 6163  e,.    check_bac
+00026bf0: 6b66 696c 6c5f 7265 7175 6972 6564 3a20  kfill_required: 
+00026c00: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00026c10: 2020 7573 655f 6d61 696e 3a20 626f 6f6c    use_main: bool
+00026c20: 203d 2046 616c 7365 2c0a 293a 2020 2320   = False,.):  # 
+00026c30: 6e6f 7161 3a20 4339 3031 0a20 2020 2077  noqa: C901.    w
+00026c40: 6f72 6b73 7061 6365 733a 204c 6973 745b  orkspaces: List[
+00026c50: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
+00026c60: 3d20 2861 7761 6974 2074 625f 636c 6965  = (await tb_clie
+00026c70: 6e74 2e75 7365 725f 776f 726b 7370 6163  nt.user_workspac
+00026c80: 6573 5f61 6e64 5f62 7261 6e63 6865 7328  es_and_branches(
+00026c90: 2929 2e67 6574 2822 776f 726b 7370 6163  )).get("workspac
+00026ca0: 6573 222c 205b 5d29 0a20 2020 2063 7572  es", []).    cur
+00026cb0: 7265 6e74 5f77 733a 2044 6963 745b 7374  rent_ws: Dict[st
+00026cc0: 722c 2041 6e79 5d20 3d20 6e65 7874 280a  r, Any] = next(.
+00026cd0: 2020 2020 2020 2020 2877 6f72 6b73 7061          (workspa
+00026ce0: 6365 2066 6f72 2077 6f72 6b73 7061 6365  ce for workspace
+00026cf0: 2069 6e20 776f 726b 7370 6163 6573 2069   in workspaces i
+00026d00: 6620 636f 6e66 6967 2061 6e64 2077 6f72  f config and wor
+00026d10: 6b73 7061 6365 2e67 6574 2822 6964 222c  kspace.get("id",
+00026d20: 2022 2e22 2920 3d3d 2063 6f6e 6669 672e   ".") == config.
+00026d30: 6765 7428 2269 6422 2c20 222e 2e22 2929  get("id", ".."))
+00026d40: 2c20 7b7d 0a20 2020 2029 0a20 2020 2069  , {}.    ).    i
+00026d50: 735f 6272 616e 6368 203d 2063 7572 7265  s_branch = curre
+00026d60: 6e74 5f77 732e 6765 7428 2269 735f 6272  nt_ws.get("is_br
+00026d70: 616e 6368 222c 2046 616c 7365 290a 2020  anch", False).  
+00026d80: 2020 6861 735f 7365 6d76 6572 3a20 626f    has_semver: bo
+00026d90: 6f6c 203d 2072 656c 6561 7365 5f63 7265  ol = release_cre
+00026da0: 6174 6564 206f 7220 4661 6c73 650a 0a20  ated or False.. 
+00026db0: 2020 2064 6570 6c6f 796d 656e 7420 3d20     deployment = 
+00026dc0: 4465 706c 6f79 6d65 6e74 2863 7572 7265  Deployment(curre
+00026dd0: 6e74 5f77 732c 2067 6974 5f72 656c 6561  nt_ws, git_relea
+00026de0: 7365 2c20 7462 5f63 6c69 656e 742c 2064  se, tb_client, d
+00026df0: 7279 5f72 756e 2c20 6f6e 6c79 5f63 6861  ry_run, only_cha
+00026e00: 6e67 6573 290a 0a20 2020 2069 6620 6e6f  nges)..    if no
+00026e10: 7420 776f 726b 7370 6163 655f 6d61 703a  t workspace_map:
+00026e20: 0a20 2020 2020 2020 2077 6f72 6b73 7061  .        workspa
+00026e30: 6365 5f6d 6170 203d 207b 7d0a 2020 2020  ce_map = {}.    
+00026e40: 6966 206e 6f74 2077 6f72 6b73 7061 6365  if not workspace
+00026e50: 5f6c 6962 5f70 6174 6873 3a0a 2020 2020  _lib_paths:.    
+00026e60: 2020 2020 776f 726b 7370 6163 655f 6c69      workspace_li
+00026e70: 625f 7061 7468 7320 3d20 5b5d 0a0a 2020  b_paths = []..  
+00026e80: 2020 776f 726b 7370 6163 655f 6c69 625f    workspace_lib_
+00026e90: 7061 7468 7320 3d20 6c69 7374 2877 6f72  paths = list(wor
+00026ea0: 6b73 7061 6365 5f6c 6962 5f70 6174 6873  kspace_lib_paths
+00026eb0: 290a 2020 2020 2320 696e 636c 7564 6520  ).    # include 
+00026ec0: 7665 6e64 6f72 206c 6962 7320 7769 7468  vendor libs with
+00026ed0: 6f75 7420 6f76 6572 7269 6469 6e67 2075  out overriding u
+00026ee0: 7365 7220 6f6e 6573 0a20 2020 2065 7869  ser ones.    exi
+00026ef0: 7374 696e 675f 776f 726b 7370 6163 6573  sting_workspaces
+00026f00: 203d 2073 6574 2878 5b31 5d20 666f 7220   = set(x[1] for 
+00026f10: 7820 696e 2077 6f72 6b73 7061 6365 5f6c  x in workspace_l
+00026f20: 6962 5f70 6174 6873 290a 2020 2020 7665  ib_paths).    ve
+00026f30: 6e64 6f72 5f70 6174 6820 3d20 5061 7468  ndor_path = Path
+00026f40: 2822 7665 6e64 6f72 2229 0a20 2020 2069  ("vendor").    i
+00026f50: 6620 7665 6e64 6f72 5f70 6174 682e 6578  f vendor_path.ex
+00026f60: 6973 7473 2829 3a0a 2020 2020 2020 2020  ists():.        
+00026f70: 666f 7220 7820 696e 2076 656e 646f 725f  for x in vendor_
+00026f80: 7061 7468 2e69 7465 7264 6972 2829 3a0a  path.iterdir():.
+00026f90: 2020 2020 2020 2020 2020 2020 6966 2078              if x
+00026fa0: 2e69 735f 6469 7228 2920 616e 6420 782e  .is_dir() and x.
+00026fb0: 6e61 6d65 206e 6f74 2069 6e20 6578 6973  name not in exis
+00026fc0: 7469 6e67 5f77 6f72 6b73 7061 6365 733a  ting_workspaces:
+00026fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026fe0: 2077 6f72 6b73 7061 6365 5f6c 6962 5f70   workspace_lib_p
+00026ff0: 6174 6873 2e61 7070 656e 6428 2878 2e6e  aths.append((x.n
+00027000: 616d 652c 2078 2929 0a0a 2020 2020 6461  ame, x))..    da
+00027010: 7461 736f 7572 6365 733a 204c 6973 745b  tasources: List[
+00027020: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
+00027030: 3d20 6177 6169 7420 7462 5f63 6c69 656e  = await tb_clien
+00027040: 742e 6461 7461 736f 7572 6365 7328 290a  t.datasources().
+00027050: 2020 2020 7069 7065 733a 204c 6973 745b      pipes: List[
+00027060: 4469 6374 5b73 7472 2c20 416e 795d 5d20  Dict[str, Any]] 
+00027070: 3d20 6177 6169 7420 7462 5f63 6c69 656e  = await tb_clien
+00027080: 742e 7069 7065 7328 6465 7065 6e64 656e  t.pipes(dependen
+00027090: 6369 6573 3d54 7275 6529 0a0a 2020 2020  cies=True)..    
+000270a0: 6578 6973 7469 6e67 5f72 6573 6f75 7263  existing_resourc
+000270b0: 6573 3a20 4c69 7374 5b73 7472 5d20 3d20  es: List[str] = 
+000270c0: 5b78 5b22 6e61 6d65 225d 2066 6f72 2078  [x["name"] for x
+000270d0: 2069 6e20 6461 7461 736f 7572 6365 735d   in datasources]
+000270e0: 202b 205b 785b 226e 616d 6522 5d20 666f   + [x["name"] fo
+000270f0: 7220 7820 696e 2070 6970 6573 5d0a 2020  r x in pipes].  
+00027100: 2020 2320 7265 706c 6163 6520 776f 726b    # replace work
+00027110: 7370 6163 6520 6d61 7070 696e 6720 6e61  space mapping na
+00027120: 6d65 730a 2020 2020 666f 7220 6f6c 645f  mes.    for old_
+00027130: 7773 2c20 6e65 775f 7773 2069 6e20 776f  ws, new_ws in wo
+00027140: 726b 7370 6163 655f 6d61 702e 6974 656d  rkspace_map.item
+00027150: 7328 293a 0a20 2020 2020 2020 2065 7869  s():.        exi
+00027160: 7374 696e 675f 7265 736f 7572 6365 7320  sting_resources 
+00027170: 3d20 5b72 652e 7375 6228 6622 5e7b 6f6c  = [re.sub(f"^{ol
+00027180: 645f 7773 7d5c 2e22 2c20 6622 7b6e 6577  d_ws}\.", f"{new
+00027190: 5f77 737d 2e22 2c20 7829 2066 6f72 2078  _ws}.", x) for x
+000271a0: 2069 6e20 6578 6973 7469 6e67 5f72 6573   in existing_res
+000271b0: 6f75 7263 6573 5d0a 0a20 2020 2072 656d  ources]..    rem
+000271c0: 6f74 655f 7265 736f 7572 6365 5f6e 616d  ote_resource_nam
+000271d0: 6573 203d 205b 6765 745f 7265 6d6f 7465  es = [get_remote
+000271e0: 5f72 6573 6f75 7263 655f 6e61 6d65 5f77  _resource_name_w
+000271f0: 6974 686f 7574 5f76 6572 7369 6f6e 2878  ithout_version(x
+00027200: 2920 666f 7220 7820 696e 2065 7869 7374  ) for x in exist
+00027210: 696e 675f 7265 736f 7572 6365 735d 0a0a  ing_resources]..
+00027220: 2020 2020 2320 7265 706c 6163 6520 776f      # replace wo
+00027230: 726b 7370 6163 6520 6d61 7070 696e 6720  rkspace mapping 
+00027240: 6e61 6d65 730a 2020 2020 666f 7220 6f6c  names.    for ol
+00027250: 645f 7773 2c20 6e65 775f 7773 2069 6e20  d_ws, new_ws in 
+00027260: 776f 726b 7370 6163 655f 6d61 702e 6974  workspace_map.it
+00027270: 656d 7328 293a 0a20 2020 2020 2020 2072  ems():.        r
+00027280: 656d 6f74 655f 7265 736f 7572 6365 5f6e  emote_resource_n
+00027290: 616d 6573 203d 205b 7265 2e73 7562 2866  ames = [re.sub(f
+000272a0: 225e 7b6f 6c64 5f77 737d 5c2e 222c 2066  "^{old_ws}\.", f
+000272b0: 227b 6e65 775f 7773 7d2e 222c 2078 2920  "{new_ws}.", x) 
+000272c0: 666f 7220 7820 696e 2072 656d 6f74 655f  for x in remote_
+000272d0: 7265 736f 7572 6365 5f6e 616d 6573 5d0a  resource_names].
+000272e0: 0a20 2020 2069 6620 6e6f 7420 6669 6c65  .    if not file
+000272f0: 6e61 6d65 733a 0a20 2020 2020 2020 2066  names:.        f
+00027300: 696c 656e 616d 6573 203d 2067 6574 5f70  ilenames = get_p
+00027310: 726f 6a65 6374 5f66 696c 656e 616d 6573  roject_filenames
+00027320: 2866 6f6c 6465 7229 0a0a 2020 2020 2320  (folder)..    # 
+00027330: 6765 7420 7468 6520 6c69 7374 206f 6620  get the list of 
+00027340: 6368 616e 6765 730a 2020 2020 6368 616e  changes.    chan
+00027350: 6765 642c 2064 656c 6574 6564 203d 2061  ged, deleted = a
+00027360: 7761 6974 2064 6570 6c6f 796d 656e 742e  wait deployment.
+00027370: 6465 7465 6374 5f63 6861 6e67 6573 2866  detect_changes(f
+00027380: 696c 656e 616d 6573 2c20 6f6e 6c79 5f63  ilenames, only_c
+00027390: 6861 6e67 6573 2c20 636f 6e66 6967 2c20  hanges, config, 
+000273a0: 7573 655f 6d61 696e 290a 0a20 2020 2064  use_main)..    d
+000273b0: 6570 6c6f 796d 656e 742e 6368 6563 6b5f  eployment.check_
+000273c0: 6368 616e 6765 7328 6368 616e 6765 642c  changes(changed,
+000273d0: 2070 6970 6573 2c20 7265 6c65 6173 655f   pipes, release_
+000273e0: 6372 6561 7465 6429 0a0a 2020 2020 6465  created)..    de
+000273f0: 706c 6f79 6d65 6e74 2e70 7265 7061 7269  ployment.prepari
+00027400: 6e67 5f72 656c 6561 7365 2829 0a0a 2020  ng_release()..  
+00027410: 2020 2320 6275 696c 6420 6772 6170 6820    # build graph 
+00027420: 746f 2067 6574 206e 6577 2076 6572 7369  to get new versi
+00027430: 6f6e 7320 666f 7220 616c 6c20 7468 6520  ons for all the 
+00027440: 6669 6c65 7320 696e 766f 6c76 6564 2069  files involved i
+00027450: 6e20 7468 6520 7175 6572 790a 2020 2020  n the query.    
+00027460: 2320 6465 7065 6e64 656e 6369 6573 206e  # dependencies n
+00027470: 6565 6420 746f 2062 6520 7072 6f63 6573  eed to be proces
+00027480: 7365 6420 616c 7761 7973 2074 6f20 6765  sed always to ge
+00027490: 7420 7468 6520 7665 7273 696f 6e73 0a20  t the versions. 
+000274a0: 2020 2064 6570 656e 6465 6e63 6965 735f     dependencies_
+000274b0: 6772 6170 6820 3d20 6177 6169 7420 6275  graph = await bu
+000274c0: 696c 645f 6772 6170 6828 0a20 2020 2020  ild_graph(.     
+000274d0: 2020 2066 696c 656e 616d 6573 2c0a 2020     filenames,.  
+000274e0: 2020 2020 2020 7462 5f63 6c69 656e 742c        tb_client,
+000274f0: 0a20 2020 2020 2020 2064 6972 5f70 6174  .        dir_pat
+00027500: 683d 666f 6c64 6572 2c0a 2020 2020 2020  h=folder,.      
+00027510: 2020 7072 6f63 6573 735f 6465 7065 6e64    process_depend
+00027520: 656e 6369 6573 3d54 7275 652c 0a20 2020  encies=True,.   
+00027530: 2020 2020 2077 6f72 6b73 7061 6365 5f6d       workspace_m
+00027540: 6170 3d77 6f72 6b73 7061 6365 5f6d 6170  ap=workspace_map
+00027550: 2c0a 2020 2020 2020 2020 736b 6970 5f63  ,.        skip_c
+00027560: 6f6e 6e65 6374 6f72 733d 5472 7565 2c0a  onnectors=True,.
+00027570: 2020 2020 2020 2020 776f 726b 7370 6163          workspac
+00027580: 655f 6c69 625f 7061 7468 733d 776f 726b  e_lib_paths=work
+00027590: 7370 6163 655f 6c69 625f 7061 7468 732c  space_lib_paths,
+000275a0: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
+000275b0: 5f77 733d 6375 7272 656e 745f 7773 2c0a  _ws=current_ws,.
+000275c0: 2020 2020 2020 2020 6368 616e 6765 643d          changed=
+000275d0: 6368 616e 6765 642c 0a20 2020 2020 2020  changed,.       
+000275e0: 206f 6e6c 795f 6368 616e 6765 733d 6f6e   only_changes=on
+000275f0: 6c79 5f63 6861 6e67 6573 206f 7220 2864  ly_changes or (d
+00027600: 6570 6c6f 796d 656e 742e 6973 5f67 6974  eployment.is_git
+00027610: 5f72 656c 6561 7365 2061 6e64 2068 6173  _release and has
+00027620: 5f73 656d 7665 7229 2c0a 2020 2020 2020  _semver),.      
+00027630: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
+00027640: 6d3d 666f 726b 5f64 6f77 6e73 7472 6561  m=fork_downstrea
+00027650: 6d2c 0a20 2020 2020 2020 2069 735f 696e  m,.        is_in
+00027660: 7465 726e 616c 3d69 735f 696e 7465 726e  ternal=is_intern
+00027670: 616c 2c0a 2020 2020 290a 0a20 2020 2023  al,.    )..    #
+00027680: 2075 7064 6174 6520 6578 6973 7469 6e67   update existing
+00027690: 2076 6572 7369 6f6e 730a 2020 2020 6966   versions.    if
+000276a0: 206e 6f74 206e 6f5f 7665 7273 696f 6e73   not no_versions
+000276b0: 3a0a 2020 2020 2020 2020 7265 736f 7572  :.        resour
+000276c0: 6365 5f76 6572 7369 6f6e 7320 3d20 6765  ce_versions = ge
+000276d0: 745f 7265 736f 7572 6365 5f76 6572 7369  t_resource_versi
+000276e0: 6f6e 7328 6578 6973 7469 6e67 5f72 6573  ons(existing_res
+000276f0: 6f75 7263 6573 290a 2020 2020 2020 2020  ources).        
+00027700: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
+00027710: 655f 7665 7273 696f 6e73 203d 2072 6573  e_versions = res
+00027720: 6f75 7263 655f 7665 7273 696f 6e73 2e63  ource_versions.c
+00027730: 6f70 7928 290a 0a20 2020 2020 2020 2066  opy()..        f
+00027740: 6f72 2064 6570 2069 6e20 6465 7065 6e64  or dep in depend
+00027750: 656e 6369 6573 5f67 7261 7068 2e74 6f5f  encies_graph.to_
+00027760: 7275 6e2e 7661 6c75 6573 2829 3a0a 2020  run.values():.  
+00027770: 2020 2020 2020 2020 2020 6473 203d 2064            ds = d
+00027780: 6570 5b22 7265 736f 7572 6365 5f6e 616d  ep["resource_nam
+00027790: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
+000277a0: 6966 2064 6570 5b22 7665 7273 696f 6e22  if dep["version"
+000277b0: 5d20 6973 206e 6f74 204e 6f6e 653a 0a20  ] is not None:. 
+000277c0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000277d0: 6174 6573 745f 6461 7461 736f 7572 6365  atest_datasource
+000277e0: 5f76 6572 7369 6f6e 735b 6473 5d20 3d20  _versions[ds] = 
+000277f0: 6465 705b 2276 6572 7369 6f6e 225d 0a20  dep["version"]. 
+00027800: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00027810: 2072 6573 6f75 7263 655f 7665 7273 696f   resource_versio
+00027820: 6e73 203d 207b 7d0a 2020 2020 2020 2020  ns = {}.        
+00027830: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
+00027840: 655f 7665 7273 696f 6e73 203d 207b 7d0a  e_versions = {}.
+00027850: 0a20 2020 2023 2049 6620 7765 2068 6176  .    # If we hav
+00027860: 6520 6461 7461 736f 7572 6365 7320 7573  e datasources us
+00027870: 696e 6720 5645 5253 494f 4e2c 206c 6574  ing VERSION, let
+00027880: 2773 2074 7279 2074 6f20 6765 7420 7468  's try to get th
+00027890: 6520 6c61 7465 7374 2076 6572 7369 6f6e  e latest version
+000278a0: 0a20 2020 2064 6570 656e 6465 6e63 6965  .    dependencie
+000278b0: 735f 6772 6170 6820 3d20 6177 6169 7420  s_graph = await 
+000278c0: 6275 696c 645f 6772 6170 6828 0a20 2020  build_graph(.   
+000278d0: 2020 2020 2066 696c 656e 616d 6573 2c0a       filenames,.
+000278e0: 2020 2020 2020 2020 7462 5f63 6c69 656e          tb_clien
+000278f0: 742c 0a20 2020 2020 2020 2064 6972 5f70  t,.        dir_p
+00027900: 6174 683d 666f 6c64 6572 2c0a 2020 2020  ath=folder,.    
+00027910: 2020 2020 7265 736f 7572 6365 5f76 6572      resource_ver
+00027920: 7369 6f6e 733d 6c61 7465 7374 5f64 6174  sions=latest_dat
+00027930: 6173 6f75 7263 655f 7665 7273 696f 6e73  asource_versions
+00027940: 2c0a 2020 2020 2020 2020 776f 726b 7370  ,.        worksp
+00027950: 6163 655f 6d61 703d 776f 726b 7370 6163  ace_map=workspac
+00027960: 655f 6d61 702c 0a20 2020 2020 2020 2070  e_map,.        p
+00027970: 726f 6365 7373 5f64 6570 656e 6465 6e63  rocess_dependenc
+00027980: 6965 733d 7075 7368 5f64 6570 732c 0a20  ies=push_deps,. 
+00027990: 2020 2020 2020 2076 6572 626f 7365 3d76         verbose=v
+000279a0: 6572 626f 7365 2c0a 2020 2020 2020 2020  erbose,.        
+000279b0: 776f 726b 7370 6163 655f 6c69 625f 7061  workspace_lib_pa
+000279c0: 7468 733d 776f 726b 7370 6163 655f 6c69  ths=workspace_li
+000279d0: 625f 7061 7468 732c 0a20 2020 2020 2020  b_paths,.       
+000279e0: 2063 7572 7265 6e74 5f77 733d 6375 7272   current_ws=curr
+000279f0: 656e 745f 7773 2c0a 2020 2020 2020 2020  ent_ws,.        
+00027a00: 6368 616e 6765 643d 6368 616e 6765 642c  changed=changed,
+00027a10: 0a20 2020 2020 2020 206f 6e6c 795f 6368  .        only_ch
+00027a20: 616e 6765 733d 6f6e 6c79 5f63 6861 6e67  anges=only_chang
+00027a30: 6573 206f 7220 2864 6570 6c6f 796d 656e  es or (deploymen
+00027a40: 742e 6973 5f67 6974 5f72 656c 6561 7365  t.is_git_release
+00027a50: 2061 6e64 2068 6173 5f73 656d 7665 7229   and has_semver)
+00027a60: 2c0a 2020 2020 2020 2020 666f 726b 5f64  ,.        fork_d
+00027a70: 6f77 6e73 7472 6561 6d3d 666f 726b 5f64  ownstream=fork_d
+00027a80: 6f77 6e73 7472 6561 6d2c 0a20 2020 2020  ownstream,.     
+00027a90: 2020 2069 735f 696e 7465 726e 616c 3d69     is_internal=i
+00027aa0: 735f 696e 7465 726e 616c 2c0a 2020 2020  s_internal,.    
+00027ab0: 290a 0a20 2020 2069 6620 6465 6275 673a  )..    if debug:
+00027ac0: 0a20 2020 2020 2020 2070 702e 7070 7269  .        pp.ppri
+00027ad0: 6e74 2864 6570 656e 6465 6e63 6965 735f  nt(dependencies_
+00027ae0: 6772 6170 682e 746f 5f72 756e 290a 0a20  graph.to_run).. 
+00027af0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+00027b00: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
+00027b10: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
+00027b20: 722e 696e 666f 5f62 7569 6c64 696e 675f  r.info_building_
+00027b30: 6465 7065 6e64 656e 6369 6573 2829 290a  dependencies()).
+00027b40: 0a20 2020 2064 6570 6c6f 796d 656e 742e  .    deployment.
+00027b50: 7072 6570 6172 696e 675f 6465 7065 6e64  preparing_depend
+00027b60: 656e 6369 6573 2863 6861 6e67 6564 2c20  encies(changed, 
+00027b70: 6465 7065 6e64 656e 6369 6573 5f67 7261  dependencies_gra
+00027b80: 7068 2e64 6570 5f6d 6170 2c20 6c61 7465  ph.dep_map, late
+00027b90: 7374 5f64 6174 6173 6f75 7263 655f 7665  st_datasource_ve
+00027ba0: 7273 696f 6e73 290a 0a20 2020 2064 6566  rsions)..    def
+00027bb0: 2073 686f 756c 645f 7075 7368 5f66 696c   should_push_fil
+00027bc0: 6528 0a20 2020 2020 2020 206e 616d 653a  e(.        name:
+00027bd0: 2073 7472 2c0a 2020 2020 2020 2020 7265   str,.        re
+00027be0: 6d6f 7465 5f72 6573 6f75 7263 655f 6e61  mote_resource_na
+00027bf0: 6d65 733a 204c 6973 745b 7374 725d 2c0a  mes: List[str],.
+00027c00: 2020 2020 2020 2020 6c61 7465 7374 5f64          latest_d
+00027c10: 6174 6173 6f75 7263 655f 7665 7273 696f  atasource_versio
+00027c20: 6e73 3a20 4469 6374 5b73 7472 2c20 416e  ns: Dict[str, An
+00027c30: 795d 2c0a 2020 2020 2020 2020 666f 7263  y],.        forc
+00027c40: 653a 2062 6f6f 6c2c 0a20 2020 2020 2020  e: bool,.       
+00027c50: 2072 756e 5f74 6573 7473 3a20 626f 6f6c   run_tests: bool
+00027c60: 2c0a 2020 2020 2920 2d3e 2062 6f6f 6c3a  ,.    ) -> bool:
+00027c70: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00027c80: 2020 2020 2046 756e 6374 696f 6e20 746f       Function to
+00027c90: 206b 6e6f 7720 6966 2077 6520 6e65 6564   know if we need
+00027ca0: 2074 6f20 7275 6e20 6120 6669 6c65 206f   to run a file o
+00027cb0: 7220 6e6f 740a 2020 2020 2020 2020 2222  r not.        ""
+00027cc0: 220a 2020 2020 2020 2020 6966 206e 616d  ".        if nam
+00027cd0: 6520 6e6f 7420 696e 2072 656d 6f74 655f  e not in remote_
+00027ce0: 7265 736f 7572 6365 5f6e 616d 6573 3a0a  resource_names:.
+00027cf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00027d00: 726e 2054 7275 650a 2020 2020 2020 2020  rn True.        
+00027d10: 2320 5768 656e 2077 6520 6e65 6564 2074  # When we need t
+00027d20: 6f20 7472 7920 746f 2070 7573 6820 6120  o try to push a 
+00027d30: 6669 6c65 2077 6865 6e20 6974 2064 6f65  file when it doe
+00027d40: 736e 2774 2065 7869 7374 2061 6e64 2074  sn't exist and t
+00027d50: 6865 2076 6572 7369 6f6e 2069 7320 6469  he version is di
+00027d60: 6666 6572 656e 7420 7468 6174 2074 6865  fferent that the
+00027d70: 2065 7869 7374 696e 6720 6f6e 650a 2020   existing one.  
+00027d80: 2020 2020 2020 7265 736f 7572 6365 5f66        resource_f
+00027d90: 756c 6c5f 6e61 6d65 203d 2028 0a20 2020  ull_name = (.   
+00027da0: 2020 2020 2020 2020 2066 227b 6e61 6d65           f"{name
+00027db0: 7d5f 5f76 7b6c 6174 6573 745f 6461 7461  }__v{latest_data
+00027dc0: 736f 7572 6365 5f76 6572 7369 6f6e 732e  source_versions.
+00027dd0: 6765 7428 6e61 6d65 297d 2220 6966 206e  get(name)}" if n
+00027de0: 616d 6520 696e 206c 6174 6573 745f 6461  ame in latest_da
+00027df0: 7461 736f 7572 6365 5f76 6572 7369 6f6e  tasource_version
+00027e00: 7320 656c 7365 206e 616d 650a 2020 2020  s else name.    
+00027e10: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+00027e20: 2072 6573 6f75 7263 655f 6675 6c6c 5f6e   resource_full_n
+00027e30: 616d 6520 6e6f 7420 696e 2065 7869 7374  ame not in exist
+00027e40: 696e 675f 7265 736f 7572 6365 733a 0a20  ing_resources:. 
+00027e50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00027e60: 6e20 5472 7565 0a20 2020 2020 2020 2069  n True.        i
+00027e70: 6620 666f 7263 6520 6f72 2072 756e 5f74  f force or run_t
+00027e80: 6573 7473 3a0a 2020 2020 2020 2020 2020  ests:.          
+00027e90: 2020 7265 7475 726e 2054 7275 650a 2020    return True.  
+00027ea0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00027eb0: 7365 0a0a 2020 2020 6173 796e 6320 6465  se..    async de
+00027ec0: 6620 7075 7368 280a 2020 2020 2020 2020  f push(.        
+00027ed0: 6e61 6d65 3a20 7374 722c 0a20 2020 2020  name: str,.     
+00027ee0: 2020 2074 6f5f 7275 6e3a 2044 6963 745b     to_run: Dict[
+00027ef0: 7374 722c 2044 6963 745b 7374 722c 2041  str, Dict[str, A
+00027f00: 6e79 5d5d 2c0a 2020 2020 2020 2020 7265  ny]],.        re
+00027f10: 736f 7572 6365 5f76 6572 7369 6f6e 733a  source_versions:
+00027f20: 2044 6963 745b 7374 722c 2041 6e79 5d2c   Dict[str, Any],
+00027f30: 0a20 2020 2020 2020 206c 6174 6573 745f  .        latest_
+00027f40: 6461 7461 736f 7572 6365 5f76 6572 7369  datasource_versi
+00027f50: 6f6e 733a 2044 6963 745b 7374 722c 2041  ons: Dict[str, A
+00027f60: 6e79 5d2c 0a20 2020 2020 2020 2064 7279  ny],.        dry
+00027f70: 5f72 756e 3a20 626f 6f6c 2c0a 2020 2020  _run: bool,.    
+00027f80: 2020 2020 666f 726b 5f64 6f77 6e73 7472      fork_downstr
+00027f90: 6561 6d3a 204f 7074 696f 6e61 6c5b 626f  eam: Optional[bo
+00027fa0: 6f6c 5d20 3d20 4661 6c73 652c 0a20 2020  ol] = False,.   
+00027fb0: 2020 2020 2066 6f72 6b3a 204f 7074 696f       fork: Optio
+00027fc0: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+00027fd0: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+00027fe0: 2020 6966 206e 616d 6520 696e 2074 6f5f    if name in to_
+00027ff0: 7275 6e3a 0a20 2020 2020 2020 2020 2020  run:.           
+00028000: 2069 6620 6e6f 7420 6472 795f 7275 6e3a   if not dry_run:
+00028010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028020: 2069 6620 7368 6f75 6c64 5f70 7573 685f   if should_push_
+00028030: 6669 6c65 286e 616d 652c 2072 656d 6f74  file(name, remot
+00028040: 655f 7265 736f 7572 6365 5f6e 616d 6573  e_resource_names
+00028050: 2c20 6c61 7465 7374 5f64 6174 6173 6f75  , latest_datasou
+00028060: 7263 655f 7665 7273 696f 6e73 2c20 666f  rce_versions, fo
+00028070: 7263 652c 2072 756e 5f74 6573 7473 293a  rce, run_tests):
+00028080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028090: 2020 2020 2069 6620 6e61 6d65 206e 6f74       if name not
+000280a0: 2069 6e20 7265 736f 7572 6365 5f76 6572   in resource_ver
+000280b0: 7369 6f6e 733a 0a20 2020 2020 2020 2020  sions:.         
+000280c0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+000280d0: 6572 7369 6f6e 203d 2022 220a 2020 2020  ersion = "".    
 000280e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000280f0: 2020 2020 2046 6565 6462 6163 6b4d 616e       FeedbackMan
-00028100: 6167 6572 2e69 6e66 6f5f 7072 6f63 6573  ager.info_proces
-00028110: 7369 6e67 5f72 6573 6f75 7263 6528 0a20  sing_resource(. 
+000280f0: 2020 2020 6966 206e 616d 6520 696e 206c      if name in l
+00028100: 6174 6573 745f 6461 7461 736f 7572 6365  atest_datasource
+00028110: 5f76 6572 7369 6f6e 733a 0a20 2020 2020  _versions:.     
 00028120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028130: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00028140: 616d 653d 6e61 6d65 2c0a 2020 2020 2020  ame=name,.      
-00028150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028160: 2020 2020 2020 2020 2020 7665 7273 696f            versio
-00028170: 6e3d 6c61 7465 7374 5f64 6174 6173 6f75  n=latest_datasou
-00028180: 7263 655f 7665 7273 696f 6e73 5b6e 616d  rce_versions[nam
-00028190: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
-000281a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000281b0: 2020 2020 6c61 7465 7374 5f76 6572 7369      latest_versi
-000281c0: 6f6e 3d72 6573 6f75 7263 655f 7665 7273  on=resource_vers
-000281d0: 696f 6e73 2e67 6574 286e 616d 6529 2c0a  ions.get(name),.
-000281e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000281f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00028200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028210: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00028220: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00028230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028240: 2020 2020 2020 2020 2061 7761 6974 2065           await e
-00028250: 7865 635f 6669 6c65 280a 2020 2020 2020  xec_file(.      
+00028130: 2020 2020 2020 2076 6572 7369 6f6e 203d         version =
+00028140: 2066 2228 767b 6c61 7465 7374 5f64 6174   f"(v{latest_dat
+00028150: 6173 6f75 7263 655f 7665 7273 696f 6e73  asource_versions
+00028160: 5b6e 616d 655d 7d29 220a 2020 2020 2020  [name]})".      
+00028170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028180: 2020 636c 6963 6b2e 6563 686f 2846 6565    click.echo(Fee
+00028190: 6462 6163 6b4d 616e 6167 6572 2e69 6e66  dbackManager.inf
+000281a0: 6f5f 7072 6f63 6573 7369 6e67 5f6e 6577  o_processing_new
+000281b0: 5f72 6573 6f75 7263 6528 6e61 6d65 3d6e  _resource(name=n
+000281c0: 616d 652c 2076 6572 7369 6f6e 3d76 6572  ame, version=ver
+000281d0: 7369 6f6e 2929 0a20 2020 2020 2020 2020  sion)).         
+000281e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000281f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028200: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+00028210: 6368 6f28 0a20 2020 2020 2020 2020 2020  cho(.           
+00028220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028230: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
+00028240: 2e69 6e66 6f5f 7072 6f63 6573 7369 6e67  .info_processing
+00028250: 5f72 6573 6f75 7263 6528 0a20 2020 2020  _resource(.     
 00028260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028270: 2020 2020 2020 636f 6e66 6967 2c0a 2020        config,.  
-00028280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028290: 2020 2020 2020 2020 2020 746f 5f72 756e            to_run
-000282a0: 5b6e 616d 655d 2c0a 2020 2020 2020 2020  [name],.        
-000282b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000282c0: 2020 2020 7462 5f63 6c69 656e 742c 0a20      tb_client,. 
+00028270: 2020 2020 2020 2020 2020 206e 616d 653d             name=
+00028280: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00028290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000282a0: 2020 2020 2020 7665 7273 696f 6e3d 6c61        version=la
+000282b0: 7465 7374 5f64 6174 6173 6f75 7263 655f  test_datasource_
+000282c0: 7665 7273 696f 6e73 5b6e 616d 655d 2c0a  versions[name],.
 000282d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000282e0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-000282f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00028300: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00028310: 6563 6b2c 0a20 2020 2020 2020 2020 2020  eck,.           
+000282e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000282f0: 6c61 7465 7374 5f76 6572 7369 6f6e 3d72  latest_version=r
+00028300: 6573 6f75 7263 655f 7665 7273 696f 6e73  esource_versions
+00028310: 2e67 6574 286e 616d 6529 2c0a 2020 2020  .get(name),.    
 00028320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028330: 2064 6562 7567 2061 6e64 2076 6572 626f   debug and verbo
-00028340: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-00028350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028360: 706f 7075 6c61 7465 2c0a 2020 2020 2020  populate,.      
+00028330: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00028340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028350: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00028360: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
 00028370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028380: 2020 2020 2020 706f 7075 6c61 7465 5f73        populate_s
-00028390: 7562 7365 742c 0a20 2020 2020 2020 2020  ubset,.         
+00028380: 2020 2020 2061 7761 6974 2065 7865 635f       await exec_
+00028390: 6669 6c65 280a 2020 2020 2020 2020 2020  file(.          
 000283a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000283b0: 2020 2070 6f70 756c 6174 655f 636f 6e64     populate_cond
-000283c0: 6974 696f 6e2c 0a20 2020 2020 2020 2020  ition,.         
-000283d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000283e0: 2020 2075 6e6c 696e 6b5f 6f6e 5f70 6f70     unlink_on_pop
-000283f0: 756c 6174 655f 6572 726f 722c 0a20 2020  ulate_error,.   
-00028400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028410: 2020 2020 2020 2020 2077 6169 742c 0a20           wait,. 
-00028420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028430: 2020 2020 2020 2020 2020 2075 7365 725f             user_
-00028440: 746f 6b65 6e2c 0a20 2020 2020 2020 2020  token,.         
-00028450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028460: 2020 206f 7665 7272 6964 655f 6461 7461     override_data
-00028470: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+000283b0: 2020 636f 6e66 6967 2c0a 2020 2020 2020    config,.      
+000283c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000283d0: 2020 2020 2020 746f 5f72 756e 5b6e 616d        to_run[nam
+000283e0: 655d 2c0a 2020 2020 2020 2020 2020 2020  e],.            
+000283f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028400: 7462 5f63 6c69 656e 742c 0a20 2020 2020  tb_client,.     
+00028410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028420: 2020 2020 2020 2066 6f72 6365 2c0a 2020         force,.  
+00028430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028440: 2020 2020 2020 2020 2020 6368 6563 6b2c            check,
+00028450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028460: 2020 2020 2020 2020 2020 2020 2064 6562               deb
+00028470: 7567 2061 6e64 2076 6572 626f 7365 2c0a  ug and verbose,.
 00028480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028490: 2020 2020 6967 6e6f 7265 5f73 716c 5f65      ignore_sql_e
-000284a0: 7272 6f72 732c 0a20 2020 2020 2020 2020  rrors,.         
+00028490: 2020 2020 2020 2020 2020 2020 706f 7075              popu
+000284a0: 6c61 7465 2c0a 2020 2020 2020 2020 2020  late,.          
 000284b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000284c0: 2020 2073 6b69 705f 636f 6e66 6972 6d61     skip_confirma
-000284d0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-000284e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000284f0: 2020 6f6e 6c79 5f72 6573 706f 6e73 655f    only_response_
-00028500: 7469 6d65 732c 0a20 2020 2020 2020 2020  times,.         
-00028510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028520: 2020 2074 696d 656f 7574 2c0a 2020 2020     timeout,.    
-00028530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028540: 2020 2020 2020 2020 7275 6e5f 7465 7374          run_test
-00028550: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00028560: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00028570: 735f 7374 616e 6461 7264 2c0a 2020 2020  s_standard,.    
-00028580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028590: 2020 2020 2020 2020 7465 7374 735f 746f          tests_to
-000285a0: 5f72 756e 2c0a 2020 2020 2020 2020 2020  _run,.          
-000285b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000285c0: 2020 7465 7374 735f 7361 6d70 6c65 5f62    tests_sample_b
-000285d0: 795f 7061 7261 6d73 2c0a 2020 2020 2020  y_params,.      
-000285e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000285f0: 2020 2020 2020 7465 7374 735f 6669 6c74        tests_filt
-00028600: 6572 5f62 792c 0a20 2020 2020 2020 2020  er_by,.         
-00028610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028620: 2020 2074 6573 7473 5f66 6169 6c66 6173     tests_failfas
-00028630: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00028640: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00028650: 6573 7473 5f69 676e 6f72 655f 6f72 6465  ests_ignore_orde
-00028660: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00028670: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00028680: 6573 7473 5f76 616c 6964 6174 655f 7072  ests_validate_pr
-00028690: 6f63 6573 7365 645f 6279 7465 732c 0a20  ocessed_bytes,. 
-000286a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000286b0: 2020 2020 2020 2020 2020 2074 6573 7473             tests
-000286c0: 5f63 6865 636b 5f72 6571 7565 7374 735f  _check_requests_
-000286d0: 6672 6f6d 5f62 7261 6e63 682c 0a20 2020  from_branch,.   
-000286e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000286f0: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00028700: 5f77 732c 0a20 2020 2020 2020 2020 2020  _ws,.           
-00028710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028720: 2066 6f72 6b5f 646f 776e 7374 7265 616d   fork_downstream
-00028730: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00028740: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00028750: 726b 2c0a 2020 2020 2020 2020 2020 2020  rk,.            
-00028760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028770: 6769 745f 7265 6c65 6173 652c 0a20 2020  git_release,.   
-00028780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028790: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000287a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000287b0: 6620 6e6f 7420 7275 6e5f 7465 7374 733a  f not run_tests:
-000287c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000287d0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-000287e0: 636b 2e65 6368 6f28 0a20 2020 2020 2020  ck.echo(.       
-000287f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028800: 2020 2020 2020 2020 2046 6565 6462 6163           Feedbac
-00028810: 6b4d 616e 6167 6572 2e73 7563 6365 7373  kManager.success
-00028820: 5f63 7265 6174 6528 0a20 2020 2020 2020  _create(.       
-00028830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028840: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-00028850: 653d 280a 2020 2020 2020 2020 2020 2020  e=(.            
-00028860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028870: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00028880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000284c0: 2020 706f 7075 6c61 7465 5f73 7562 7365    populate_subse
+000284d0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+000284e0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000284f0: 6f70 756c 6174 655f 636f 6e64 6974 696f  opulate_conditio
+00028500: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00028510: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00028520: 6e6c 696e 6b5f 6f6e 5f70 6f70 756c 6174  nlink_on_populat
+00028530: 655f 6572 726f 722c 0a20 2020 2020 2020  e_error,.       
+00028540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028550: 2020 2020 2077 6169 742c 0a20 2020 2020       wait,.     
+00028560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028570: 2020 2020 2020 2075 7365 725f 746f 6b65         user_toke
+00028580: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00028590: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000285a0: 7665 7272 6964 655f 6461 7461 736f 7572  verride_datasour
+000285b0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+000285c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000285d0: 6967 6e6f 7265 5f73 716c 5f65 7272 6f72  ignore_sql_error
+000285e0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+000285f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00028600: 6b69 705f 636f 6e66 6972 6d61 7469 6f6e  kip_confirmation
+00028610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00028620: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
+00028630: 6c79 5f72 6573 706f 6e73 655f 7469 6d65  ly_response_time
+00028640: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00028650: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00028660: 696d 656f 7574 2c0a 2020 2020 2020 2020  imeout,.        
+00028670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028680: 2020 2020 7275 6e5f 7465 7374 732c 0a20      run_tests,. 
+00028690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000286a0: 2020 2020 2020 2020 2020 2061 735f 7374             as_st
+000286b0: 616e 6461 7264 2c0a 2020 2020 2020 2020  andard,.        
+000286c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000286d0: 2020 2020 7465 7374 735f 746f 5f72 756e      tests_to_run
+000286e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000286f0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00028700: 7374 735f 7361 6d70 6c65 5f62 795f 7061  sts_sample_by_pa
+00028710: 7261 6d73 2c0a 2020 2020 2020 2020 2020  rams,.          
+00028720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028730: 2020 7465 7374 735f 6669 6c74 6572 5f62    tests_filter_b
+00028740: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+00028750: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00028760: 6573 7473 5f66 6169 6c66 6173 742c 0a20  ests_failfast,. 
+00028770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028780: 2020 2020 2020 2020 2020 2074 6573 7473             tests
+00028790: 5f69 676e 6f72 655f 6f72 6465 722c 0a20  _ignore_order,. 
+000287a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000287b0: 2020 2020 2020 2020 2020 2074 6573 7473             tests
+000287c0: 5f76 616c 6964 6174 655f 7072 6f63 6573  _validate_proces
+000287d0: 7365 645f 6279 7465 732c 0a20 2020 2020  sed_bytes,.     
+000287e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000287f0: 2020 2020 2020 2074 6573 7473 5f63 6865         tests_che
+00028800: 636b 5f72 6571 7565 7374 735f 6672 6f6d  ck_requests_from
+00028810: 5f62 7261 6e63 682c 0a20 2020 2020 2020  _branch,.       
+00028820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028830: 2020 2020 2063 7572 7265 6e74 5f77 732c       current_ws,
+00028840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028850: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00028860: 6b5f 646f 776e 7374 7265 616d 2c0a 2020  k_downstream,.  
+00028870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028880: 2020 2020 2020 2020 2020 666f 726b 2c0a            fork,.
 00028890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000288a0: 2020 2020 2020 2020 2069 6620 746f 5f72           if to_r
-000288b0: 756e 5b6e 616d 655d 5b22 7665 7273 696f  un[name]["versio
-000288c0: 6e22 5d20 6973 204e 6f6e 650a 2020 2020  n"] is None.    
-000288d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000288e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000288f0: 2020 2020 656c 7365 2066 277b 6e61 6d65      else f'{name
-00028900: 7d5f 5f76 7b74 6f5f 7275 6e5b 6e61 6d65  }__v{to_run[name
-00028910: 5d5b 2276 6572 7369 6f6e 225d 7d27 0a20  ]["version"]}'. 
-00028920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000288a0: 2020 2020 2020 2020 2020 2020 6769 745f              git_
+000288b0: 7265 6c65 6173 652c 0a20 2020 2020 2020  release,.       
+000288c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000288d0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000288e0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+000288f0: 7420 7275 6e5f 7465 7374 733a 0a20 2020  t run_tests:.   
+00028900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028910: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+00028920: 6368 6f28 0a20 2020 2020 2020 2020 2020  cho(.           
 00028930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028940: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00028950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028960: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00028940: 2020 2020 2046 6565 6462 6163 6b4d 616e       FeedbackMan
+00028950: 6167 6572 2e73 7563 6365 7373 5f63 7265  ager.success_cre
+00028960: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
 00028970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028980: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00028990: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-000289a0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-000289b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000289c0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-000289d0: 6e20 3d20 4665 6564 6261 636b 4d61 6e61  n = FeedbackMana
-000289e0: 6765 722e 6572 726f 725f 7075 7368 5f66  ger.error_push_f
-000289f0: 696c 655f 6578 6365 7074 696f 6e28 0a20  ile_exception(. 
-00028a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a10: 2020 2020 2020 2020 2020 2066 696c 656e             filen
-00028a20: 616d 653d 746f 5f72 756e 5b6e 616d 655d  ame=to_run[name]
-00028a30: 5b22 6669 6c65 6e61 6d65 225d 2c20 6572  ["filename"], er
-00028a40: 726f 723d 650a 2020 2020 2020 2020 2020  ror=e.          
-00028a50: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00028980: 2020 2020 2020 2020 206e 616d 653d 280a           name=(.
+00028990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000289a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000289b0: 2020 2020 2020 2020 6e61 6d65 0a20 2020          name.   
+000289c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000289d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000289e0: 2020 2020 2069 6620 746f 5f72 756e 5b6e       if to_run[n
+000289f0: 616d 655d 5b22 7665 7273 696f 6e22 5d20  ame]["version"] 
+00028a00: 6973 204e 6f6e 650a 2020 2020 2020 2020  is None.        
+00028a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028a30: 656c 7365 2066 277b 6e61 6d65 7d5f 5f76  else f'{name}__v
+00028a40: 7b74 6f5f 7275 6e5b 6e61 6d65 5d5b 2276  {to_run[name]["v
+00028a50: 6572 7369 6f6e 225d 7d27 0a20 2020 2020  ersion"]}'.     
 00028a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a70: 2020 2020 2020 2020 7261 6973 6520 636c          raise cl
-00028a80: 6963 6b2e 436c 6963 6b45 7863 6570 7469  ick.ClickExcepti
-00028a90: 6f6e 2865 7863 6570 7469 6f6e 290a 2020  on(exception).  
-00028aa0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00028ab0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00028ac0: 2020 2020 2020 2020 6966 2072 6169 7365          if raise
-00028ad0: 5f6f 6e5f 6578 6973 7473 3a0a 2020 2020  _on_exists:.    
-00028ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028af0: 2020 2020 7261 6973 6520 416c 7265 6164      raise Alread
-00028b00: 7945 7869 7374 7345 7863 6570 7469 6f6e  yExistsException
-00028b10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00028b20: 2020 2020 2020 2020 2020 2020 2020 4665                Fe
-00028b30: 6564 6261 636b 4d61 6e61 6765 722e 7761  edbackManager.wa
-00028b40: 726e 696e 675f 6e61 6d65 5f61 6c72 6561  rning_name_alrea
-00028b50: 6479 5f65 7869 7374 7328 0a20 2020 2020  dy_exists(.     
-00028b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b70: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-00028b80: 6e61 6d65 2069 6620 746f 5f72 756e 5b6e  name if to_run[n
-00028b90: 616d 655d 5b22 7665 7273 696f 6e22 5d20  ame]["version"] 
-00028ba0: 6973 204e 6f6e 6520 656c 7365 2066 277b  is None else f'{
-00028bb0: 6e61 6d65 7d5f 5f76 7b74 6f5f 7275 6e5b  name}__v{to_run[
-00028bc0: 6e61 6d65 5d5b 2276 6572 7369 6f6e 225d  name]["version"]
-00028bd0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-00028be0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00028bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028c00: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00028c10: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00028c20: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00028c30: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-00028c40: 636b 2e65 6368 6f28 0a20 2020 2020 2020  ck.echo(.       
+00028a70: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00028a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028aa0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00028ab0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00028ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028ad0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00028ae0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+00028af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b00: 2020 2020 6578 6365 7074 696f 6e20 3d20      exception = 
+00028b10: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+00028b20: 6572 726f 725f 7075 7368 5f66 696c 655f  error_push_file_
+00028b30: 6578 6365 7074 696f 6e28 0a20 2020 2020  exception(.     
+00028b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b50: 2020 2020 2020 2066 696c 656e 616d 653d         filename=
+00028b60: 746f 5f72 756e 5b6e 616d 655d 5b22 6669  to_run[name]["fi
+00028b70: 6c65 6e61 6d65 225d 2c20 6572 726f 723d  lename"], error=
+00028b80: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00028b90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00028ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028bb0: 2020 2020 7261 6973 6520 636c 6963 6b2e      raise click.
+00028bc0: 436c 6963 6b45 7863 6570 7469 6f6e 2865  ClickException(e
+00028bd0: 7863 6570 7469 6f6e 290a 2020 2020 2020  xception).      
+00028be0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00028bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028c00: 2020 2020 6966 2072 6169 7365 5f6f 6e5f      if raise_on_
+00028c10: 6578 6973 7473 3a0a 2020 2020 2020 2020  exists:.        
+00028c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028c30: 7261 6973 6520 416c 7265 6164 7945 7869  raise AlreadyExi
+00028c40: 7374 7345 7863 6570 7469 6f6e 280a 2020  stsException(.  
 00028c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c60: 2020 2020 2046 6565 6462 6163 6b4d 616e       FeedbackMan
-00028c70: 6167 6572 2e77 6172 6e69 6e67 5f6e 616d  ager.warning_nam
-00028c80: 655f 616c 7265 6164 795f 6578 6973 7473  e_already_exists
-00028c90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00028c60: 2020 2020 2020 2020 2020 4665 6564 6261            Feedba
+00028c70: 636b 4d61 6e61 6765 722e 7761 726e 696e  ckManager.warnin
+00028c80: 675f 6e61 6d65 5f61 6c72 6561 6479 5f65  g_name_already_e
+00028c90: 7869 7374 7328 0a20 2020 2020 2020 2020  xists(.         
 00028ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028cb0: 2020 6e61 6d65 3d6e 616d 6520 6966 2074    name=name if t
-00028cc0: 6f5f 7275 6e5b 6e61 6d65 5d5b 2276 6572  o_run[name]["ver
-00028cd0: 7369 6f6e 225d 2069 7320 4e6f 6e65 2065  sion"] is None e
-00028ce0: 6c73 6520 6627 7b6e 616d 657d 5f5f 767b  lse f'{name}__v{
-00028cf0: 746f 5f72 756e 5b6e 616d 655d 5b22 7665  to_run[name]["ve
-00028d00: 7273 696f 6e22 5d7d 270a 2020 2020 2020  rsion"]}'.      
+00028cb0: 2020 2020 2020 206e 616d 653d 6e61 6d65         name=name
+00028cc0: 2069 6620 746f 5f72 756e 5b6e 616d 655d   if to_run[name]
+00028cd0: 5b22 7665 7273 696f 6e22 5d20 6973 204e  ["version"] is N
+00028ce0: 6f6e 6520 656c 7365 2066 277b 6e61 6d65  one else f'{name
+00028cf0: 7d5f 5f76 7b74 6f5f 7275 6e5b 6e61 6d65  }__v{to_run[name
+00028d00: 5d5b 2276 6572 7369 6f6e 225d 7d27 0a20  ]["version"]}'. 
 00028d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028d20: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00028d20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
 00028d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028d40: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00028d50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00028d60: 2020 2020 6966 2073 686f 756c 645f 7075      if should_pu
-00028d70: 7368 5f66 696c 6528 6e61 6d65 2c20 7265  sh_file(name, re
-00028d80: 6d6f 7465 5f72 6573 6f75 7263 655f 6e61  mote_resource_na
-00028d90: 6d65 732c 206c 6174 6573 745f 6461 7461  mes, latest_data
-00028da0: 736f 7572 6365 5f76 6572 7369 6f6e 732c  source_versions,
-00028db0: 2066 6f72 6365 2c20 7275 6e5f 7465 7374   force, run_test
-00028dc0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00028dd0: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
-00028de0: 6e6f 7420 696e 2072 6573 6f75 7263 655f  not in resource_
-00028df0: 7665 7273 696f 6e73 3a0a 2020 2020 2020  versions:.      
-00028e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e10: 2020 7665 7273 696f 6e20 3d20 2222 0a20    version = "". 
-00028e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e30: 2020 2020 2020 2069 6620 6e61 6d65 2069         if name i
-00028e40: 6e20 6c61 7465 7374 5f64 6174 6173 6f75  n latest_datasou
-00028e50: 7263 655f 7665 7273 696f 6e73 3a0a 2020  rce_versions:.  
-00028e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e70: 2020 2020 2020 2020 2020 7665 7273 696f            versio
-00028e80: 6e20 3d20 6622 2876 7b6c 6174 6573 745f  n = f"(v{latest_
-00028e90: 6461 7461 736f 7572 6365 5f76 6572 7369  datasource_versi
-00028ea0: 6f6e 735b 6e61 6d65 5d7d 2922 0a20 2020  ons[name]})".   
-00028eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ec0: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
-00028ed0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-00028ee0: 696e 666f 5f64 7279 5f70 726f 6365 7373  info_dry_process
-00028ef0: 696e 675f 6e65 775f 7265 736f 7572 6365  ing_new_resource
-00028f00: 286e 616d 653d 6e61 6d65 2c20 7665 7273  (name=name, vers
-00028f10: 696f 6e3d 7665 7273 696f 6e29 290a 2020  ion=version)).  
-00028f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00028f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f50: 636c 6963 6b2e 6563 686f 280a 2020 2020  click.echo(.    
+00028d40: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00028d50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00028d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028d70: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+00028d80: 6368 6f28 0a20 2020 2020 2020 2020 2020  cho(.           
+00028d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028da0: 2046 6565 6462 6163 6b4d 616e 6167 6572   FeedbackManager
+00028db0: 2e77 6172 6e69 6e67 5f6e 616d 655f 616c  .warning_name_al
+00028dc0: 7265 6164 795f 6578 6973 7473 280a 2020  ready_exists(.  
+00028dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028de0: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+00028df0: 6d65 3d6e 616d 6520 6966 2074 6f5f 7275  me=name if to_ru
+00028e00: 6e5b 6e61 6d65 5d5b 2276 6572 7369 6f6e  n[name]["version
+00028e10: 225d 2069 7320 4e6f 6e65 2065 6c73 6520  "] is None else 
+00028e20: 6627 7b6e 616d 657d 5f5f 767b 746f 5f72  f'{name}__v{to_r
+00028e30: 756e 5b6e 616d 655d 5b22 7665 7273 696f  un[name]["versio
+00028e40: 6e22 5d7d 270a 2020 2020 2020 2020 2020  n"]}'.          
+00028e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028e60: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00028e70: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00028e80: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00028e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ea0: 6966 2073 686f 756c 645f 7075 7368 5f66  if should_push_f
+00028eb0: 696c 6528 6e61 6d65 2c20 7265 6d6f 7465  ile(name, remote
+00028ec0: 5f72 6573 6f75 7263 655f 6e61 6d65 732c  _resource_names,
+00028ed0: 206c 6174 6573 745f 6461 7461 736f 7572   latest_datasour
+00028ee0: 6365 5f76 6572 7369 6f6e 732c 2066 6f72  ce_versions, for
+00028ef0: 6365 2c20 7275 6e5f 7465 7374 7329 3a0a  ce, run_tests):.
+00028f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f10: 2020 2020 6966 206e 616d 6520 6e6f 7420      if name not 
+00028f20: 696e 2072 6573 6f75 7263 655f 7665 7273  in resource_vers
+00028f30: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+00028f40: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+00028f50: 7273 696f 6e20 3d20 2222 0a20 2020 2020  rsion = "".     
 00028f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f70: 2020 2020 2020 2020 4665 6564 6261 636b          Feedback
-00028f80: 4d61 6e61 6765 722e 696e 666f 5f64 7279  Manager.info_dry
-00028f90: 5f70 726f 6365 7373 696e 675f 7265 736f  _processing_reso
-00028fa0: 7572 6365 280a 2020 2020 2020 2020 2020  urce(.          
-00028fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028fc0: 2020 2020 2020 6e61 6d65 3d6e 616d 652c        name=name,
-00028fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ff0: 2076 6572 7369 6f6e 3d6c 6174 6573 745f   version=latest_
-00029000: 6461 7461 736f 7572 6365 5f76 6572 7369  datasource_versi
-00029010: 6f6e 735b 6e61 6d65 5d2c 0a20 2020 2020  ons[name],.     
-00029020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029030: 2020 2020 2020 2020 2020 206c 6174 6573             lates
-00029040: 745f 7665 7273 696f 6e3d 7265 736f 7572  t_version=resour
-00029050: 6365 5f76 6572 7369 6f6e 732e 6765 7428  ce_versions.get(
-00029060: 6e61 6d65 292c 0a20 2020 2020 2020 2020  name),.         
-00029070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029080: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00029090: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-000290a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000290b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000290c0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
-000290d0: 6368 6f28 4665 6564 6261 636b 4d61 6e61  cho(FeedbackMana
-000290e0: 6765 722e 7761 726e 696e 675f 6472 795f  ger.warning_dry_
-000290f0: 6e61 6d65 5f61 6c72 6561 6479 5f65 7869  name_already_exi
-00029100: 7374 7328 6e61 6d65 3d6e 616d 6529 290a  sts(name=name)).
-00029110: 0a20 2020 2061 7379 6e63 2064 6566 2070  .    async def p
-00029120: 7573 685f 6669 6c65 7328 0a20 2020 2020  ush_files(.     
-00029130: 2020 2064 6570 656e 6465 6e63 795f 6772     dependency_gr
-00029140: 6170 683a 2047 7261 7068 4465 7065 6e64  aph: GraphDepend
-00029150: 656e 6369 6573 2c0a 2020 2020 2020 2020  encies,.        
-00029160: 6472 795f 7275 6e3a 2062 6f6f 6c20 3d20  dry_run: bool = 
-00029170: 4661 6c73 652c 0a20 2020 2020 2020 2063  False,.        c
-00029180: 6865 636b 5f62 6163 6b66 696c 6c5f 7265  heck_backfill_re
-00029190: 7175 6972 6564 3a20 626f 6f6c 203d 2046  quired: bool = F
-000291a0: 616c 7365 2c0a 2020 2020 293a 0a20 2020  alse,.    ):.   
-000291b0: 2020 2020 2065 6e64 706f 696e 7473 5f64       endpoints_d
-000291c0: 6570 5f6d 6170 203d 2064 6963 7428 290a  ep_map = dict().
-000291d0: 2020 2020 2020 2020 7072 6f63 6573 7365          processe
-000291e0: 6420 3d20 7365 7428 290a 0a20 2020 2020  d = set()..     
-000291f0: 2020 2064 6570 656e 6465 6e63 6965 735f     dependencies_
-00029200: 6772 6170 6820 3d20 6465 7065 6e64 656e  graph = dependen
-00029210: 6379 5f67 7261 7068 2e64 6570 5f6d 6170  cy_graph.dep_map
-00029220: 0a20 2020 2020 2020 2072 6573 6f75 7263  .        resourc
-00029230: 6573 5f74 6f5f 7275 6e20 3d20 6465 7065  es_to_run = depe
-00029240: 6e64 656e 6379 5f67 7261 7068 2e74 6f5f  ndency_graph.to_
-00029250: 7275 6e0a 0a20 2020 2020 2020 2069 6620  run..        if 
-00029260: 6e6f 7420 666f 726b 5f64 6f77 6e73 7472  not fork_downstr
-00029270: 6561 6d3a 0a20 2020 2020 2020 2020 2020  eam:.           
-00029280: 2023 2046 6972 7374 2c20 7765 2077 696c   # First, we wil
-00029290: 6c20 6465 706c 6f79 2074 6865 2061 6c6c  l deploy the all
-000292a0: 2074 6865 2072 6573 6f75 7263 6573 2066   the resources f
-000292b0: 6f6c 6c6f 7769 6e67 2074 6865 2064 6570  ollowing the dep
-000292c0: 656e 6465 6e63 7920 6772 6170 6820 6578  endency graph ex
-000292d0: 6365 7074 2066 6f72 2074 6865 2065 6e64  cept for the end
-000292e0: 706f 696e 7473 0a20 2020 2020 2020 2020  points.         
-000292f0: 2020 2067 726f 7570 7320 3d20 5b67 726f     groups = [gro
-00029300: 7570 2066 6f72 2067 726f 7570 2069 6e20  up for group in 
-00029310: 746f 706f 736f 7274 2864 6570 656e 6465  toposort(depende
-00029320: 6e63 6965 735f 6772 6170 6829 5d0a 2020  ncies_graph)].  
-00029330: 2020 2020 2020 2020 2020 666f 7220 6772            for gr
-00029340: 6f75 7020 696e 2067 726f 7570 733a 0a20  oup in groups:. 
-00029350: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00029360: 6f72 206e 616d 6520 696e 2067 726f 7570  or name in group
-00029370: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00029380: 2020 2020 2020 6966 206e 616d 6520 696e        if name in
-00029390: 2070 726f 6365 7373 6564 3a0a 2020 2020   processed:.    
-000293a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293b0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-000293c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293d0: 2020 6966 2069 735f 656e 6470 6f69 6e74    if is_endpoint
-000293e0: 5f77 6974 685f 6e6f 5f64 6570 656e 6465  _with_no_depende
-000293f0: 6e63 6965 7328 0a20 2020 2020 2020 2020  ncies(.         
-00029400: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00029410: 6573 6f75 7263 6573 5f74 6f5f 7275 6e2e  esources_to_run.
-00029420: 6765 7428 6e61 6d65 2c20 7b7d 292c 0a20  get(name, {}),. 
-00029430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029440: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-00029450: 6965 735f 6772 6170 682c 0a20 2020 2020  ies_graph,.     
-00029460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029470: 2020 2072 6573 6f75 7263 6573 5f74 6f5f     resources_to_
-00029480: 7275 6e2c 0a20 2020 2020 2020 2020 2020  run,.           
-00029490: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
-000294a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000294b0: 2020 2020 656e 6470 6f69 6e74 735f 6465      endpoints_de
-000294c0: 705f 6d61 705b 6e61 6d65 5d20 3d20 6465  p_map[name] = de
-000294d0: 7065 6e64 656e 6369 6573 5f67 7261 7068  pendencies_graph
-000294e0: 5b6e 616d 655d 0a20 2020 2020 2020 2020  [name].         
-000294f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00029500: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-00029510: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-00029520: 6974 2070 7573 6828 0a20 2020 2020 2020  it push(.       
-00029530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029540: 206e 616d 652c 0a20 2020 2020 2020 2020   name,.         
-00029550: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00029560: 6573 6f75 7263 6573 5f74 6f5f 7275 6e2c  esources_to_run,
-00029570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029580: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
-00029590: 655f 7665 7273 696f 6e73 2c0a 2020 2020  e_versions,.    
-000295a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000295b0: 2020 2020 6c61 7465 7374 5f64 6174 6173      latest_datas
-000295c0: 6f75 7263 655f 7665 7273 696f 6e73 2c0a  ource_versions,.
-000295d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000295e0: 2020 2020 2020 2020 6472 795f 7275 6e2c          dry_run,
-000295f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029600: 2020 2020 2020 2020 2066 6f72 6b5f 646f           fork_do
-00029610: 776e 7374 7265 616d 2c0a 2020 2020 2020  wnstream,.      
-00029620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029630: 2020 666f 726b 2c0a 2020 2020 2020 2020    fork,.        
-00029640: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00029650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029660: 2020 7072 6f63 6573 7365 642e 6164 6428    processed.add(
-00029670: 6e61 6d65 290a 0a20 2020 2020 2020 2020  name)..         
-00029680: 2020 2023 2054 6865 6e2c 2077 6520 7769     # Then, we wi
-00029690: 6c6c 2064 6570 6c6f 7920 7468 6520 656e  ll deploy the en
-000296a0: 6470 6f69 6e74 7320 7468 6174 2061 7265  dpoints that are
-000296b0: 206f 6e20 7468 6520 6465 7065 6e64 656e   on the dependen
-000296c0: 6379 2067 7261 7068 0a20 2020 2020 2020  cy graph.       
-000296d0: 2020 2020 2067 726f 7570 7320 3d20 5b67       groups = [g
-000296e0: 726f 7570 2066 6f72 2067 726f 7570 2069  roup for group i
-000296f0: 6e20 746f 706f 736f 7274 2865 6e64 706f  n toposort(endpo
-00029700: 696e 7473 5f64 6570 5f6d 6170 295d 0a20  ints_dep_map)]. 
-00029710: 2020 2020 2020 2020 2020 2066 6f72 2067             for g
-00029720: 726f 7570 2069 6e20 6772 6f75 7073 3a0a  roup in groups:.
+00028f70: 2020 2069 6620 6e61 6d65 2069 6e20 6c61     if name in la
+00028f80: 7465 7374 5f64 6174 6173 6f75 7263 655f  test_datasource_
+00028f90: 7665 7273 696f 6e73 3a0a 2020 2020 2020  versions:.      
+00028fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028fb0: 2020 2020 2020 7665 7273 696f 6e20 3d20        version = 
+00028fc0: 6622 2876 7b6c 6174 6573 745f 6461 7461  f"(v{latest_data
+00028fd0: 736f 7572 6365 5f76 6572 7369 6f6e 735b  source_versions[
+00028fe0: 6e61 6d65 5d7d 2922 0a20 2020 2020 2020  name]})".       
+00028ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029000: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
+00029010: 6261 636b 4d61 6e61 6765 722e 696e 666f  backManager.info
+00029020: 5f64 7279 5f70 726f 6365 7373 696e 675f  _dry_processing_
+00029030: 6e65 775f 7265 736f 7572 6365 286e 616d  new_resource(nam
+00029040: 653d 6e61 6d65 2c20 7665 7273 696f 6e3d  e=name, version=
+00029050: 7665 7273 696f 6e29 290a 2020 2020 2020  version)).      
+00029060: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00029070: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00029080: 2020 2020 2020 2020 2020 2020 636c 6963              clic
+00029090: 6b2e 6563 686f 280a 2020 2020 2020 2020  k.echo(.        
+000290a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000290b0: 2020 2020 4665 6564 6261 636b 4d61 6e61      FeedbackMana
+000290c0: 6765 722e 696e 666f 5f64 7279 5f70 726f  ger.info_dry_pro
+000290d0: 6365 7373 696e 675f 7265 736f 7572 6365  cessing_resource
+000290e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000290f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029100: 2020 6e61 6d65 3d6e 616d 652c 0a20 2020    name=name,.   
+00029110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029120: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+00029130: 7369 6f6e 3d6c 6174 6573 745f 6461 7461  sion=latest_data
+00029140: 736f 7572 6365 5f76 6572 7369 6f6e 735b  source_versions[
+00029150: 6e61 6d65 5d2c 0a20 2020 2020 2020 2020  name],.         
+00029160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029170: 2020 2020 2020 206c 6174 6573 745f 7665         latest_ve
+00029180: 7273 696f 6e3d 7265 736f 7572 6365 5f76  rsion=resource_v
+00029190: 6572 7369 6f6e 732e 6765 7428 6e61 6d65  ersions.get(name
+000291a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000291b0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000291c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000291d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000291e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000291f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029200: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
+00029210: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
+00029220: 7761 726e 696e 675f 6472 795f 6e61 6d65  warning_dry_name
+00029230: 5f61 6c72 6561 6479 5f65 7869 7374 7328  _already_exists(
+00029240: 6e61 6d65 3d6e 616d 6529 290a 0a20 2020  name=name))..   
+00029250: 2061 7379 6e63 2064 6566 2070 7573 685f   async def push_
+00029260: 6669 6c65 7328 0a20 2020 2020 2020 2064  files(.        d
+00029270: 6570 656e 6465 6e63 795f 6772 6170 683a  ependency_graph:
+00029280: 2047 7261 7068 4465 7065 6e64 656e 6369   GraphDependenci
+00029290: 6573 2c0a 2020 2020 2020 2020 6472 795f  es,.        dry_
+000292a0: 7275 6e3a 2062 6f6f 6c20 3d20 4661 6c73  run: bool = Fals
+000292b0: 652c 0a20 2020 2020 2020 2063 6865 636b  e,.        check
+000292c0: 5f62 6163 6b66 696c 6c5f 7265 7175 6972  _backfill_requir
+000292d0: 6564 3a20 626f 6f6c 203d 2046 616c 7365  ed: bool = False
+000292e0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
+000292f0: 2065 6e64 706f 696e 7473 5f64 6570 5f6d   endpoints_dep_m
+00029300: 6170 203d 2064 6963 7428 290a 2020 2020  ap = dict().    
+00029310: 2020 2020 7072 6f63 6573 7365 6420 3d20      processed = 
+00029320: 7365 7428 290a 0a20 2020 2020 2020 2064  set()..        d
+00029330: 6570 656e 6465 6e63 6965 735f 6772 6170  ependencies_grap
+00029340: 6820 3d20 6465 7065 6e64 656e 6379 5f67  h = dependency_g
+00029350: 7261 7068 2e64 6570 5f6d 6170 0a20 2020  raph.dep_map.   
+00029360: 2020 2020 2072 6573 6f75 7263 6573 5f74       resources_t
+00029370: 6f5f 7275 6e20 3d20 6465 7065 6e64 656e  o_run = dependen
+00029380: 6379 5f67 7261 7068 2e74 6f5f 7275 6e0a  cy_graph.to_run.
+00029390: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000293a0: 666f 726b 5f64 6f77 6e73 7472 6561 6d3a  fork_downstream:
+000293b0: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+000293c0: 6972 7374 2c20 7765 2077 696c 6c20 6465  irst, we will de
+000293d0: 706c 6f79 2074 6865 2061 6c6c 2074 6865  ploy the all the
+000293e0: 2072 6573 6f75 7263 6573 2066 6f6c 6c6f   resources follo
+000293f0: 7769 6e67 2074 6865 2064 6570 656e 6465  wing the depende
+00029400: 6e63 7920 6772 6170 6820 6578 6365 7074  ncy graph except
+00029410: 2066 6f72 2074 6865 2065 6e64 706f 696e   for the endpoin
+00029420: 7473 0a20 2020 2020 2020 2020 2020 2067  ts.            g
+00029430: 726f 7570 7320 3d20 5b67 726f 7570 2066  roups = [group f
+00029440: 6f72 2067 726f 7570 2069 6e20 746f 706f  or group in topo
+00029450: 736f 7274 2864 6570 656e 6465 6e63 6965  sort(dependencie
+00029460: 735f 6772 6170 6829 5d0a 2020 2020 2020  s_graph)].      
+00029470: 2020 2020 2020 666f 7220 6772 6f75 7020        for group 
+00029480: 696e 2067 726f 7570 733a 0a20 2020 2020  in groups:.     
+00029490: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
+000294a0: 616d 6520 696e 2067 726f 7570 3a0a 2020  ame in group:.  
+000294b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000294c0: 2020 6966 206e 616d 6520 696e 2070 726f    if name in pro
+000294d0: 6365 7373 6564 3a0a 2020 2020 2020 2020  cessed:.        
+000294e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000294f0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+00029500: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00029510: 2069 735f 656e 6470 6f69 6e74 5f77 6974   is_endpoint_wit
+00029520: 685f 6e6f 5f64 6570 656e 6465 6e63 6965  h_no_dependencie
+00029530: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+00029540: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+00029550: 7263 6573 5f74 6f5f 7275 6e2e 6765 7428  rces_to_run.get(
+00029560: 6e61 6d65 2c20 7b7d 292c 0a20 2020 2020  name, {}),.     
+00029570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029580: 2020 2064 6570 656e 6465 6e63 6965 735f     dependencies_
+00029590: 6772 6170 682c 0a20 2020 2020 2020 2020  graph,.         
+000295a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000295b0: 6573 6f75 7263 6573 5f74 6f5f 7275 6e2c  esources_to_run,
+000295c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000295d0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+000295e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000295f0: 656e 6470 6f69 6e74 735f 6465 705f 6d61  endpoints_dep_ma
+00029600: 705b 6e61 6d65 5d20 3d20 6465 7065 6e64  p[name] = depend
+00029610: 656e 6369 6573 5f67 7261 7068 5b6e 616d  encies_graph[nam
+00029620: 655d 0a20 2020 2020 2020 2020 2020 2020  e].             
+00029630: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00029640: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+00029650: 2020 2020 2020 2020 2061 7761 6974 2070           await p
+00029660: 7573 6828 0a20 2020 2020 2020 2020 2020  ush(.           
+00029670: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+00029680: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00029690: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+000296a0: 7263 6573 5f74 6f5f 7275 6e2c 0a20 2020  rces_to_run,.   
+000296b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000296c0: 2020 2020 2072 6573 6f75 7263 655f 7665       resource_ve
+000296d0: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
+000296e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000296f0: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
+00029700: 655f 7665 7273 696f 6e73 2c0a 2020 2020  e_versions,.    
+00029710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029720: 2020 2020 6472 795f 7275 6e2c 0a20 2020      dry_run,.   
 00029730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029740: 666f 7220 6e61 6d65 2069 6e20 6772 6f75  for name in grou
-00029750: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-00029760: 2020 2020 2020 2069 6620 6e61 6d65 206e         if name n
-00029770: 6f74 2069 6e20 7072 6f63 6573 7365 643a  ot in processed:
-00029780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029790: 2020 2020 2020 2020 2061 7761 6974 2070           await p
-000297a0: 7573 6828 0a20 2020 2020 2020 2020 2020  ush(.           
-000297b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000297c0: 206e 616d 652c 0a20 2020 2020 2020 2020   name,.         
-000297d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000297e0: 2020 2072 6573 6f75 7263 6573 5f74 6f5f     resources_to_
-000297f0: 7275 6e2c 0a20 2020 2020 2020 2020 2020  run,.           
-00029800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029810: 2072 6573 6f75 7263 655f 7665 7273 696f   resource_versio
-00029820: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-00029830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029840: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
-00029850: 655f 7665 7273 696f 6e73 2c0a 2020 2020  e_versions,.    
-00029860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029870: 2020 2020 2020 2020 6472 795f 7275 6e2c          dry_run,
-00029880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029890: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000298a0: 6b5f 646f 776e 7374 7265 616d 2c0a 2020  k_downstream,.  
-000298b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000298c0: 2020 2020 2020 2020 2020 666f 726b 2c0a            fork,.
-000298d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000298e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000298f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029900: 2020 7072 6f63 6573 7365 642e 6164 6428    processed.add(
-00029910: 6e61 6d65 290a 2020 2020 2020 2020 656c  name).        el
-00029920: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00029930: 2320 5468 6973 2077 696c 6c20 6765 6e65  # This will gene
-00029940: 7261 7465 2074 6865 2067 7261 7068 2066  rate the graph f
-00029950: 726f 6d20 7269 6768 7420 746f 206c 6566  rom right to lef
-00029960: 7420 616e 6420 7769 6c6c 2066 696c 6c20  t and will fill 
-00029970: 7468 6520 6761 7073 206f 6620 7468 6520  the gaps of the 
-00029980: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
-00029990: 2020 2020 2020 2020 2023 2049 6620 7765           # If we
-000299a0: 2068 6176 6520 6120 6772 6170 6820 6c69   have a graph li
-000299b0: 6b65 2074 6869 733a 0a20 2020 2020 2020  ke this:.       
-000299c0: 2020 2020 2023 2041 202d 3e20 4220 2d3e       # A -> B ->
-000299d0: 2043 0a20 2020 2020 2020 2020 2020 2023   C.            #
-000299e0: 2049 6620 7765 206f 6e6c 7920 6d6f 6469   If we only modi
-000299f0: 6679 2041 2c20 7468 6520 6e6f 726d 616c  fy A, the normal
-00029a00: 2064 6570 656e 6465 6e63 6965 7320 6772   dependencies gr
-00029a10: 6170 6820 7769 6c6c 206f 6e6c 7920 636f  aph will only co
-00029a20: 6e74 6169 6e20 6120 6e6f 6465 206c 696b  ntain a node lik
-00029a30: 6520 5f7b 4120 3d3e 2042 7d0a 2020 2020  e _{A => B}.    
-00029a40: 2020 2020 2020 2020 2320 4275 7420 7765          # But we
-00029a50: 206e 6565 6420 6120 6772 6170 6820 7468   need a graph th
-00029a60: 6174 2063 6f6e 7461 696e 7320 412c 2042  at contains A, B
-00029a70: 2061 6e64 2043 2061 6e64 2074 6865 2064   and C and the d
-00029a80: 6570 656e 6465 6e63 6965 7320 6265 7477  ependencies betw
-00029a90: 6565 6e20 7468 656d 2074 6f20 6465 706c  een them to depl
-00029aa0: 6f79 2074 6865 6d20 696e 2074 6865 2072  oy them in the r
-00029ab0: 6967 6874 206f 7264 6572 0a20 2020 2020  ight order.     
-00029ac0: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-00029ad0: 6965 735f 6772 6170 685f 666f 726b 5f64  ies_graph_fork_d
-00029ae0: 6f77 6e73 7472 6561 6d2c 2072 6573 6f75  ownstream, resou
-00029af0: 7263 6573 5f74 6f5f 7275 6e5f 666f 726b  rces_to_run_fork
-00029b00: 5f64 6f77 6e73 7472 6561 6d20 3d20 6765  _downstream = ge
-00029b10: 6e65 7261 7465 5f66 6f72 6b64 6f77 6e73  nerate_forkdowns
-00029b20: 7472 6561 6d5f 6772 6170 6828 0a20 2020  tream_graph(.   
-00029b30: 2020 2020 2020 2020 2020 2020 2064 6570               dep
-00029b40: 656e 6465 6e63 795f 6772 6170 682e 616c  endency_graph.al
-00029b50: 6c5f 6465 705f 6d61 702c 0a20 2020 2020  l_dep_map,.     
-00029b60: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00029b70: 6465 6e63 795f 6772 6170 682e 616c 6c5f  dency_graph.all_
-00029b80: 7265 736f 7572 6365 732c 0a20 2020 2020  resources,.     
-00029b90: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
-00029ba0: 7263 6573 5f74 6f5f 7275 6e2c 0a20 2020  rces_to_run,.   
-00029bb0: 2020 2020 2020 2020 2020 2020 206c 6973               lis
-00029bc0: 7428 6465 7065 6e64 656e 6379 5f67 7261  t(dependency_gra
-00029bd0: 7068 2e64 6570 5f6d 6170 2e6b 6579 7328  ph.dep_map.keys(
-00029be0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00029bf0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00029c00: 2046 6972 7374 2c20 7765 2077 696c 6c20   First, we will 
-00029c10: 6465 706c 6f79 2074 6865 2064 6174 6173  deploy the datas
-00029c20: 6f75 7263 6573 2074 6861 7420 6e65 6564  ources that need
-00029c30: 2074 6f20 6265 2064 6570 6c6f 7965 642e   to be deployed.
-00029c40: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-00029c50: 6520 6e65 6564 2074 6f20 6465 706c 6f79  e need to deploy
-00029c60: 2074 6865 2064 6174 6173 6f75 7263 6573   the datasources
-00029c70: 2066 726f 6d20 6c65 6674 2074 6f20 7269   from left to ri
-00029c80: 6768 7420 6173 2073 6f6d 6520 6461 7461  ght as some data
-00029c90: 736f 7572 6365 7320 6d69 6768 7420 6861  sources might ha
-00029ca0: 7665 204d 5620 7468 6174 2064 6570 656e  ve MV that depen
-00029cb0: 6420 6f6e 2074 6865 2063 6f6c 756d 6e20  d on the column 
-00029cc0: 7479 7065 7320 6f66 2070 7265 7669 6f75  types of previou
-00029cd0: 7320 6461 7461 736f 7572 6365 732e 2045  s datasources. E
-00029ce0: 783a 2060 7465 7374 5f63 6861 6e67 655f  x: `test_change_
-00029cf0: 636f 6c75 6d6e 5f74 7970 655f 6c61 6e64  column_type_land
-00029d00: 696e 675f 6461 7461 736f 7572 6365 6020  ing_datasource` 
-00029d10: 7465 7374 0a20 2020 2020 2020 2020 2020  test.           
-00029d20: 2067 726f 7570 7320 3d20 5b67 726f 7570   groups = [group
-00029d30: 2066 6f72 2067 726f 7570 2069 6e20 746f   for group in to
-00029d40: 706f 736f 7274 2864 6570 656e 6465 6e63  posort(dependenc
-00029d50: 6965 735f 6772 6170 685f 666f 726b 5f64  ies_graph_fork_d
-00029d60: 6f77 6e73 7472 6561 6d29 5d0a 2020 2020  ownstream)].    
-00029d70: 2020 2020 2020 2020 6772 6f75 7073 2e72          groups.r
-00029d80: 6576 6572 7365 2829 0a20 2020 2020 2020  everse().       
-00029d90: 2020 2020 2066 6f72 2067 726f 7570 2069       for group i
-00029da0: 6e20 6772 6f75 7073 3a0a 2020 2020 2020  n groups:.      
-00029db0: 2020 2020 2020 2020 2020 666f 7220 6e61            for na
-00029dc0: 6d65 2069 6e20 6772 6f75 703a 0a20 2020  me in group:.   
-00029dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029de0: 2069 6620 6e61 6d65 2069 6e20 7072 6f63   if name in proc
-00029df0: 6573 7365 6420 6f72 206e 6f74 2069 735f  essed or not is_
-00029e00: 6461 7461 736f 7572 6365 2872 6573 6f75  datasource(resou
-00029e10: 7263 6573 5f74 6f5f 7275 6e5f 666f 726b  rces_to_run_fork
-00029e20: 5f64 6f77 6e73 7472 6561 6d5b 6e61 6d65  _downstream[name
-00029e30: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-00029e40: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00029e50: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-00029e60: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
-00029e70: 6865 2072 6573 6f75 7263 6520 6973 206e  he resource is n
-00029e80: 6577 2c20 7765 2077 696c 6c20 7573 6520  ew, we will use 
-00029e90: 7468 6520 6e6f 726d 616c 2072 6573 6f75  the normal resou
-00029ea0: 7263 6520 696e 666f 726d 6174 696f 6e20  rce information 
-00029eb0: 746f 2064 6570 6c6f 7920 6974 0a20 2020  to deploy it.   
-00029ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029ed0: 2023 2054 6869 7320 6973 206d 6f73 746c   # This is mostl
-00029ee0: 7920 7573 6564 2066 6f72 2064 6174 6173  y used for datas
-00029ef0: 6f75 7263 6573 2077 6974 6820 636f 6e6e  ources with conn
-00029f00: 6563 7469 6f6e 732e 0a20 2020 2020 2020  ections..       
-00029f10: 2020 2020 2020 2020 2020 2020 2023 2041               # A
-00029f20: 7420 7468 6520 6d6f 6d65 6e74 2c20 6072  t the moment, `r
-00029f30: 6573 6f75 7263 6573 5f74 6f5f 7275 6e5f  esources_to_run_
-00029f40: 666f 726b 5f64 6f77 6e73 7472 6561 6d60  fork_downstream`
-00029f50: 2069 7320 6765 6e65 7261 7465 6420 6279   is generated by
-00029f60: 2060 616c 6c5f 7265 736f 7572 6365 7360   `all_resources`
-00029f70: 2061 6e64 2074 6869 7320 6973 2067 656e   and this is gen
-00029f80: 6572 6174 6564 2075 7369 6e67 2074 6865  erated using the
-00029f90: 2070 6172 616d 6574 6572 2060 736b 6970   parameter `skip
-00029fa0: 5f63 6f6e 6e65 6374 6f72 733d 5472 7565  _connectors=True
-00029fb0: 600a 2020 2020 2020 2020 2020 2020 2020  `.              
-00029fc0: 2020 2020 2020 2320 544f 444f 3a20 5368        # TODO: Sh
-00029fd0: 6f75 6c64 2074 6865 2060 7265 736f 7572  ould the `resour
-00029fe0: 6365 735f 746f 5f72 756e 5f66 6f72 6b5f  ces_to_run_fork_
-00029ff0: 646f 776e 7374 7265 616d 6020 6265 2067  downstream` be g
-0002a000: 656e 6572 6174 6564 2075 7369 6e67 2074  enerated using t
-0002a010: 6865 2060 736b 6970 5f63 6f6e 6e65 6374  he `skip_connect
-0002a020: 6f72 7360 2070 6172 616d 6574 6572 3f0a  ors` parameter?.
-0002a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a040: 2020 2020 6966 2069 735f 6e65 7728 6e61      if is_new(na
-0002a050: 6d65 2c20 6368 616e 6765 642c 2064 6570  me, changed, dep
-0002a060: 656e 6465 6e63 6965 735f 6772 6170 685f  endencies_graph_
-0002a070: 666f 726b 5f64 6f77 6e73 7472 6561 6d2c  fork_downstream,
-0002a080: 2064 6570 656e 6465 6e63 6965 735f 6772   dependencies_gr
-0002a090: 6170 685f 666f 726b 5f64 6f77 6e73 7472  aph_fork_downstr
-0002a0a0: 6561 6d29 3a0a 2020 2020 2020 2020 2020  eam):.          
-0002a0b0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-0002a0c0: 6169 7420 7075 7368 280a 2020 2020 2020  ait push(.      
-0002a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a0e0: 2020 2020 2020 6e61 6d65 2c0a 2020 2020        name,.    
+00029740: 2020 2020 2066 6f72 6b5f 646f 776e 7374       fork_downst
+00029750: 7265 616d 2c0a 2020 2020 2020 2020 2020  ream,.          
+00029760: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00029770: 726b 2c0a 2020 2020 2020 2020 2020 2020  rk,.            
+00029780: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00029790: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000297a0: 6f63 6573 7365 642e 6164 6428 6e61 6d65  ocessed.add(name
+000297b0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+000297c0: 2054 6865 6e2c 2077 6520 7769 6c6c 2064   Then, we will d
+000297d0: 6570 6c6f 7920 7468 6520 656e 6470 6f69  eploy the endpoi
+000297e0: 6e74 7320 7468 6174 2061 7265 206f 6e20  nts that are on 
+000297f0: 7468 6520 6465 7065 6e64 656e 6379 2067  the dependency g
+00029800: 7261 7068 0a20 2020 2020 2020 2020 2020  raph.           
+00029810: 2067 726f 7570 7320 3d20 5b67 726f 7570   groups = [group
+00029820: 2066 6f72 2067 726f 7570 2069 6e20 746f   for group in to
+00029830: 706f 736f 7274 2865 6e64 706f 696e 7473  posort(endpoints
+00029840: 5f64 6570 5f6d 6170 295d 0a20 2020 2020  _dep_map)].     
+00029850: 2020 2020 2020 2066 6f72 2067 726f 7570         for group
+00029860: 2069 6e20 6772 6f75 7073 3a0a 2020 2020   in groups:.    
+00029870: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00029880: 6e61 6d65 2069 6e20 6772 6f75 703a 0a20  name in group:. 
+00029890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000298a0: 2020 2069 6620 6e61 6d65 206e 6f74 2069     if name not i
+000298b0: 6e20 7072 6f63 6573 7365 643a 0a20 2020  n processed:.   
+000298c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000298d0: 2020 2020 2061 7761 6974 2070 7573 6828       await push(
+000298e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000298f0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+00029900: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00029910: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00029920: 6573 6f75 7263 6573 5f74 6f5f 7275 6e2c  esources_to_run,
+00029930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029940: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00029950: 6f75 7263 655f 7665 7273 696f 6e73 2c0a  ource_versions,.
+00029960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029970: 2020 2020 2020 2020 2020 2020 6c61 7465              late
+00029980: 7374 5f64 6174 6173 6f75 7263 655f 7665  st_datasource_ve
+00029990: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
+000299a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000299b0: 2020 2020 6472 795f 7275 6e2c 0a20 2020      dry_run,.   
+000299c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000299d0: 2020 2020 2020 2020 2066 6f72 6b5f 646f           fork_do
+000299e0: 776e 7374 7265 616d 2c0a 2020 2020 2020  wnstream,.      
+000299f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029a00: 2020 2020 2020 666f 726b 2c0a 2020 2020        fork,.    
+00029a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029a20: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00029a30: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00029a40: 6f63 6573 7365 642e 6164 6428 6e61 6d65  ocessed.add(name
+00029a50: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00029a60: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+00029a70: 6973 2077 696c 6c20 6765 6e65 7261 7465  is will generate
+00029a80: 2074 6865 2067 7261 7068 2066 726f 6d20   the graph from 
+00029a90: 7269 6768 7420 746f 206c 6566 7420 616e  right to left an
+00029aa0: 6420 7769 6c6c 2066 696c 6c20 7468 6520  d will fill the 
+00029ab0: 6761 7073 206f 6620 7468 6520 6465 7065  gaps of the depe
+00029ac0: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
+00029ad0: 2020 2020 2023 2049 6620 7765 2068 6176       # If we hav
+00029ae0: 6520 6120 6772 6170 6820 6c69 6b65 2074  e a graph like t
+00029af0: 6869 733a 0a20 2020 2020 2020 2020 2020  his:.           
+00029b00: 2023 2041 202d 3e20 4220 2d3e 2043 0a20   # A -> B -> C. 
+00029b10: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+00029b20: 7765 206f 6e6c 7920 6d6f 6469 6679 2041  we only modify A
+00029b30: 2c20 7468 6520 6e6f 726d 616c 2064 6570  , the normal dep
+00029b40: 656e 6465 6e63 6965 7320 6772 6170 6820  endencies graph 
+00029b50: 7769 6c6c 206f 6e6c 7920 636f 6e74 6169  will only contai
+00029b60: 6e20 6120 6e6f 6465 206c 696b 6520 5f7b  n a node like _{
+00029b70: 4120 3d3e 2042 7d0a 2020 2020 2020 2020  A => B}.        
+00029b80: 2020 2020 2320 4275 7420 7765 206e 6565      # But we nee
+00029b90: 6420 6120 6772 6170 6820 7468 6174 2063  d a graph that c
+00029ba0: 6f6e 7461 696e 7320 412c 2042 2061 6e64  ontains A, B and
+00029bb0: 2043 2061 6e64 2074 6865 2064 6570 656e   C and the depen
+00029bc0: 6465 6e63 6965 7320 6265 7477 6565 6e20  dencies between 
+00029bd0: 7468 656d 2074 6f20 6465 706c 6f79 2074  them to deploy t
+00029be0: 6865 6d20 696e 2074 6865 2072 6967 6874  hem in the right
+00029bf0: 206f 7264 6572 0a20 2020 2020 2020 2020   order.         
+00029c00: 2020 2064 6570 656e 6465 6e63 6965 735f     dependencies_
+00029c10: 6772 6170 685f 666f 726b 5f64 6f77 6e73  graph_fork_downs
+00029c20: 7472 6561 6d2c 2072 6573 6f75 7263 6573  tream, resources
+00029c30: 5f74 6f5f 7275 6e5f 666f 726b 5f64 6f77  _to_run_fork_dow
+00029c40: 6e73 7472 6561 6d20 3d20 6765 6e65 7261  nstream = genera
+00029c50: 7465 5f66 6f72 6b64 6f77 6e73 7472 6561  te_forkdownstrea
+00029c60: 6d5f 6772 6170 6828 0a20 2020 2020 2020  m_graph(.       
+00029c70: 2020 2020 2020 2020 2064 6570 656e 6465           depende
+00029c80: 6e63 795f 6772 6170 682e 616c 6c5f 6465  ncy_graph.all_de
+00029c90: 705f 6d61 702c 0a20 2020 2020 2020 2020  p_map,.         
+00029ca0: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
+00029cb0: 795f 6772 6170 682e 616c 6c5f 7265 736f  y_graph.all_reso
+00029cc0: 7572 6365 732c 0a20 2020 2020 2020 2020  urces,.         
+00029cd0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+00029ce0: 5f74 6f5f 7275 6e2c 0a20 2020 2020 2020  _to_run,.       
+00029cf0: 2020 2020 2020 2020 206c 6973 7428 6465           list(de
+00029d00: 7065 6e64 656e 6379 5f67 7261 7068 2e64  pendency_graph.d
+00029d10: 6570 5f6d 6170 2e6b 6579 7328 2929 2c0a  ep_map.keys()),.
+00029d20: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00029d30: 2020 2020 2020 2020 2020 2023 2046 6972             # Fir
+00029d40: 7374 2c20 7765 2077 696c 6c20 6465 706c  st, we will depl
+00029d50: 6f79 2074 6865 2064 6174 6173 6f75 7263  oy the datasourc
+00029d60: 6573 2074 6861 7420 6e65 6564 2074 6f20  es that need to 
+00029d70: 6265 2064 6570 6c6f 7965 642e 0a20 2020  be deployed..   
+00029d80: 2020 2020 2020 2020 2023 2057 6520 6e65           # We ne
+00029d90: 6564 2074 6f20 6465 706c 6f79 2074 6865  ed to deploy the
+00029da0: 2064 6174 6173 6f75 7263 6573 2066 726f   datasources fro
+00029db0: 6d20 6c65 6674 2074 6f20 7269 6768 7420  m left to right 
+00029dc0: 6173 2073 6f6d 6520 6461 7461 736f 7572  as some datasour
+00029dd0: 6365 7320 6d69 6768 7420 6861 7665 204d  ces might have M
+00029de0: 5620 7468 6174 2064 6570 656e 6420 6f6e  V that depend on
+00029df0: 2074 6865 2063 6f6c 756d 6e20 7479 7065   the column type
+00029e00: 7320 6f66 2070 7265 7669 6f75 7320 6461  s of previous da
+00029e10: 7461 736f 7572 6365 732e 2045 783a 2060  tasources. Ex: `
+00029e20: 7465 7374 5f63 6861 6e67 655f 636f 6c75  test_change_colu
+00029e30: 6d6e 5f74 7970 655f 6c61 6e64 696e 675f  mn_type_landing_
+00029e40: 6461 7461 736f 7572 6365 6020 7465 7374  datasource` test
+00029e50: 0a20 2020 2020 2020 2020 2020 2067 726f  .            gro
+00029e60: 7570 7320 3d20 5b67 726f 7570 2066 6f72  ups = [group for
+00029e70: 2067 726f 7570 2069 6e20 746f 706f 736f   group in toposo
+00029e80: 7274 2864 6570 656e 6465 6e63 6965 735f  rt(dependencies_
+00029e90: 6772 6170 685f 666f 726b 5f64 6f77 6e73  graph_fork_downs
+00029ea0: 7472 6561 6d29 5d0a 2020 2020 2020 2020  tream)].        
+00029eb0: 2020 2020 6772 6f75 7073 2e72 6576 6572      groups.rever
+00029ec0: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
+00029ed0: 2066 6f72 2067 726f 7570 2069 6e20 6772   for group in gr
+00029ee0: 6f75 7073 3a0a 2020 2020 2020 2020 2020  oups:.          
+00029ef0: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
+00029f00: 6e20 6772 6f75 703a 0a20 2020 2020 2020  n group:.       
+00029f10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00029f20: 6e61 6d65 2069 6e20 7072 6f63 6573 7365  name in processe
+00029f30: 6420 6f72 206e 6f74 2069 735f 6461 7461  d or not is_data
+00029f40: 736f 7572 6365 2872 6573 6f75 7263 6573  source(resources
+00029f50: 5f74 6f5f 7275 6e5f 666f 726b 5f64 6f77  _to_run_fork_dow
+00029f60: 6e73 7472 6561 6d5b 6e61 6d65 5d29 3a0a  nstream[name]):.
+00029f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029f80: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00029f90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00029fa0: 2020 2020 2020 2320 4966 2074 6865 2072        # If the r
+00029fb0: 6573 6f75 7263 6520 6973 206e 6577 2c20  esource is new, 
+00029fc0: 7765 2077 696c 6c20 7573 6520 7468 6520  we will use the 
+00029fd0: 6e6f 726d 616c 2072 6573 6f75 7263 6520  normal resource 
+00029fe0: 696e 666f 726d 6174 696f 6e20 746f 2064  information to d
+00029ff0: 6570 6c6f 7920 6974 0a20 2020 2020 2020  eploy it.       
+0002a000: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+0002a010: 6869 7320 6973 206d 6f73 746c 7920 7573  his is mostly us
+0002a020: 6564 2066 6f72 2064 6174 6173 6f75 7263  ed for datasourc
+0002a030: 6573 2077 6974 6820 636f 6e6e 6563 7469  es with connecti
+0002a040: 6f6e 732e 0a20 2020 2020 2020 2020 2020  ons..           
+0002a050: 2020 2020 2020 2020 2023 2041 7420 7468           # At th
+0002a060: 6520 6d6f 6d65 6e74 2c20 6072 6573 6f75  e moment, `resou
+0002a070: 7263 6573 5f74 6f5f 7275 6e5f 666f 726b  rces_to_run_fork
+0002a080: 5f64 6f77 6e73 7472 6561 6d60 2069 7320  _downstream` is 
+0002a090: 6765 6e65 7261 7465 6420 6279 2060 616c  generated by `al
+0002a0a0: 6c5f 7265 736f 7572 6365 7360 2061 6e64  l_resources` and
+0002a0b0: 2074 6869 7320 6973 2067 656e 6572 6174   this is generat
+0002a0c0: 6564 2075 7369 6e67 2074 6865 2070 6172  ed using the par
+0002a0d0: 616d 6574 6572 2060 736b 6970 5f63 6f6e  ameter `skip_con
+0002a0e0: 6e65 6374 6f72 733d 5472 7565 600a 2020  nectors=True`.  
 0002a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a100: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-0002a110: 735f 746f 5f72 756e 2c0a 2020 2020 2020  s_to_run,.      
-0002a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a130: 2020 2020 2020 7265 736f 7572 6365 5f76        resource_v
-0002a140: 6572 7369 6f6e 732c 0a20 2020 2020 2020  ersions,.       
-0002a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a160: 2020 2020 206c 6174 6573 745f 6461 7461       latest_data
-0002a170: 736f 7572 6365 5f76 6572 7369 6f6e 732c  source_versions,
-0002a180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a190: 2020 2020 2020 2020 2020 2020 2064 7279               dry
-0002a1a0: 5f72 756e 2c0a 2020 2020 2020 2020 2020  _run,.          
-0002a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a1c0: 2020 666f 726b 5f64 6f77 6e73 7472 6561    fork_downstrea
-0002a1d0: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
-0002a1e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002a1f0: 6f72 6b2c 0a20 2020 2020 2020 2020 2020  ork,.           
-0002a200: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0002a100: 2020 2320 544f 444f 3a20 5368 6f75 6c64    # TODO: Should
+0002a110: 2074 6865 2060 7265 736f 7572 6365 735f   the `resources_
+0002a120: 746f 5f72 756e 5f66 6f72 6b5f 646f 776e  to_run_fork_down
+0002a130: 7374 7265 616d 6020 6265 2067 656e 6572  stream` be gener
+0002a140: 6174 6564 2075 7369 6e67 2074 6865 2060  ated using the `
+0002a150: 736b 6970 5f63 6f6e 6e65 6374 6f72 7360  skip_connectors`
+0002a160: 2070 6172 616d 6574 6572 3f0a 2020 2020   parameter?.    
+0002a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a180: 6966 2069 735f 6e65 7728 6e61 6d65 2c20  if is_new(name, 
+0002a190: 6368 616e 6765 642c 2064 6570 656e 6465  changed, depende
+0002a1a0: 6e63 6965 735f 6772 6170 685f 666f 726b  ncies_graph_fork
+0002a1b0: 5f64 6f77 6e73 7472 6561 6d2c 2064 6570  _downstream, dep
+0002a1c0: 656e 6465 6e63 6965 735f 6772 6170 685f  endencies_graph_
+0002a1d0: 666f 726b 5f64 6f77 6e73 7472 6561 6d29  fork_downstream)
+0002a1e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002a1f0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0002a200: 7075 7368 280a 2020 2020 2020 2020 2020  push(.          
 0002a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a220: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002a220: 2020 6e61 6d65 2c0a 2020 2020 2020 2020    name,.        
 0002a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a240: 2023 2049 6620 7765 2061 7265 2074 7279   # If we are try
-0002a250: 696e 6720 746f 206d 6f64 6966 7920 6120  ing to modify a 
-0002a260: 4b61 666b 6120 6f72 2043 444b 2064 6174  Kafka or CDK dat
-0002a270: 6173 6f75 7263 652c 2077 6520 6e65 6564  asource, we need
-0002a280: 2074 6f20 696e 666f 726d 2074 6865 2075   to inform the u
-0002a290: 7365 7220 7468 6174 2074 6865 2072 6573  ser that the res
-0002a2a0: 6f75 7263 6520 6e65 6564 7320 746f 2062  ource needs to b
-0002a2b0: 6520 706f 7374 2d72 656c 6561 7365 640a  e post-released.
+0002a240: 2020 2020 7265 736f 7572 6365 735f 746f      resources_to
+0002a250: 5f72 756e 2c0a 2020 2020 2020 2020 2020  _run,.          
+0002a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a270: 2020 7265 736f 7572 6365 5f76 6572 7369    resource_versi
+0002a280: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0002a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a2a0: 206c 6174 6573 745f 6461 7461 736f 7572   latest_datasour
+0002a2b0: 6365 5f76 6572 7369 6f6e 732c 0a20 2020  ce_versions,.   
 0002a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a2d0: 2020 2020 2020 2020 6b61 666b 615f 636f          kafka_co
-0002a2e0: 6e6e 6563 7469 6f6e 5f6e 616d 6520 3d20  nnection_name = 
-0002a2f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002a300: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0002a310: 736f 7572 6365 735f 746f 5f72 756e 5f66  sources_to_run_f
-0002a320: 6f72 6b5f 646f 776e 7374 7265 616d 5b6e  ork_downstream[n
-0002a330: 616d 655d 2e67 6574 2822 7061 7261 6d73  ame].get("params
-0002a340: 222c 207b 7d29 2e67 6574 2822 6b61 666b  ", {}).get("kafk
-0002a350: 615f 636f 6e6e 6563 7469 6f6e 5f6e 616d  a_connection_nam
-0002a360: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
-0002a370: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a390: 2020 2020 2020 7365 7276 6963 6520 3d20        service = 
-0002a3a0: 7265 736f 7572 6365 735f 746f 5f72 756e  resources_to_run
-0002a3b0: 5f66 6f72 6b5f 646f 776e 7374 7265 616d  _fork_downstream
-0002a3c0: 5b6e 616d 655d 2e67 6574 2822 7061 7261  [name].get("para
-0002a3d0: 6d73 222c 207b 7d29 2e67 6574 2822 696d  ms", {}).get("im
-0002a3e0: 706f 7274 5f73 6572 7669 6365 2229 0a20  port_service"). 
-0002a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a400: 2020 2020 2020 2069 6620 7265 6c65 6173         if releas
-0002a410: 655f 6372 6561 7465 6420 616e 6420 286b  e_created and (k
-0002a420: 6166 6b61 5f63 6f6e 6e65 6374 696f 6e5f  afka_connection_
-0002a430: 6e61 6d65 206f 7220 7365 7276 6963 6529  name or service)
-0002a440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002a450: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0002a460: 6e6e 6563 746f 7220 3d20 224b 6166 6b61  nnector = "Kafka
-0002a470: 2220 6966 206b 6166 6b61 5f63 6f6e 6e65  " if kafka_conne
-0002a480: 6374 696f 6e5f 6e61 6d65 2065 6c73 6520  ction_name else 
-0002a490: 7365 7276 6963 650a 2020 2020 2020 2020  service.        
+0002a2d0: 2020 2020 2020 2020 2064 7279 5f72 756e           dry_run
+0002a2e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002a2f0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0002a300: 726b 5f64 6f77 6e73 7472 6561 6d2c 0a20  rk_downstream,. 
+0002a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a320: 2020 2020 2020 2020 2020 2066 6f72 6b2c             fork,
+0002a330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a340: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002a350: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002a360: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002a370: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+0002a380: 6620 7765 2061 7265 2074 7279 696e 6720  f we are trying 
+0002a390: 746f 206d 6f64 6966 7920 6120 4b61 666b  to modify a Kafk
+0002a3a0: 6120 6f72 2043 444b 2064 6174 6173 6f75  a or CDK datasou
+0002a3b0: 7263 652c 2077 6520 6e65 6564 2074 6f20  rce, we need to 
+0002a3c0: 696e 666f 726d 2074 6865 2075 7365 7220  inform the user 
+0002a3d0: 7468 6174 2074 6865 2072 6573 6f75 7263  that the resourc
+0002a3e0: 6520 6e65 6564 7320 746f 2062 6520 706f  e needs to be po
+0002a3f0: 7374 2d72 656c 6561 7365 640a 2020 2020  st-released.    
+0002a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a410: 2020 2020 6b61 666b 615f 636f 6e6e 6563      kafka_connec
+0002a420: 7469 6f6e 5f6e 616d 6520 3d20 280a 2020  tion_name = (.  
+0002a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a440: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+0002a450: 6365 735f 746f 5f72 756e 5f66 6f72 6b5f  ces_to_run_fork_
+0002a460: 646f 776e 7374 7265 616d 5b6e 616d 655d  downstream[name]
+0002a470: 2e67 6574 2822 7061 7261 6d73 222c 207b  .get("params", {
+0002a480: 7d29 2e67 6574 2822 6b61 666b 615f 636f  }).get("kafka_co
+0002a490: 6e6e 6563 7469 6f6e 5f6e 616d 6522 290a  nnection_name").
 0002a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4b0: 2020 2020 6572 726f 725f 6d73 6720 3d20      error_msg = 
-0002a4c0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-0002a4d0: 6572 726f 725f 636f 6e6e 6563 746f 725f  error_connector_
-0002a4e0: 7265 7175 6972 655f 706f 7374 5f72 656c  require_post_rel
-0002a4f0: 6561 7365 2863 6f6e 6e65 6374 6f72 3d63  ease(connector=c
-0002a500: 6f6e 6e65 6374 6f72 290a 2020 2020 2020  onnector).      
-0002a510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a520: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
-0002a530: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
-0002a540: 2865 7272 6f72 5f6d 7367 290a 0a20 2020  (error_msg)..   
-0002a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a560: 2020 2020 2023 2049 6620 7765 2061 7265       # If we are
-0002a570: 2070 7573 6869 6e67 2061 206d 6f64 6966   pushing a modif
-0002a580: 6965 6420 6461 7461 736f 7572 6365 2c20  ied datasource, 
-0002a590: 696e 666f 726d 2061 626f 7574 2074 6865  inform about the
-0002a5a0: 2062 6163 6b66 696c 6c60 600a 2020 2020   backfill``.    
-0002a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5c0: 2020 2020 6966 2063 6865 636b 5f62 6163      if check_bac
-0002a5d0: 6b66 696c 6c5f 7265 7175 6972 6564 2061  kfill_required a
-0002a5e0: 6e64 2061 7574 6f5f 7072 6f6d 6f74 6520  nd auto_promote 
-0002a5f0: 616e 6420 7265 6c65 6173 655f 6372 6561  and release_crea
-0002a600: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
-0002a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a620: 2065 7272 6f72 5f6d 7367 203d 2046 6565   error_msg = Fee
-0002a630: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-0002a640: 6f72 5f63 6865 636b 5f62 6163 6b66 696c  or_check_backfil
-0002a650: 6c5f 7265 7175 6972 6564 2872 6573 6f75  l_required(resou
-0002a660: 7263 655f 6e61 6d65 3d6e 616d 6529 0a20  rce_name=name). 
-0002a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a680: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0002a690: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
-0002a6a0: 7074 696f 6e28 6572 726f 725f 6d73 6729  ption(error_msg)
-0002a6b0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002a6c0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0002a6d0: 7075 7368 280a 2020 2020 2020 2020 2020  push(.          
-0002a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a6f0: 2020 6e61 6d65 2c0a 2020 2020 2020 2020    name,.        
-0002a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a710: 2020 2020 7265 736f 7572 6365 735f 746f      resources_to
-0002a720: 5f72 756e 5f66 6f72 6b5f 646f 776e 7374  _run_fork_downst
-0002a730: 7265 616d 2c0a 2020 2020 2020 2020 2020  ream,.          
-0002a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a750: 2020 7265 736f 7572 6365 5f76 6572 7369    resource_versi
-0002a760: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-0002a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a780: 206c 6174 6573 745f 6461 7461 736f 7572   latest_datasour
-0002a790: 6365 5f76 6572 7369 6f6e 732c 0a20 2020  ce_versions,.   
-0002a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7b0: 2020 2020 2020 2020 2064 7279 5f72 756e           dry_run
-0002a7c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002a7d0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0002a7e0: 726b 5f64 6f77 6e73 7472 6561 6d2c 0a20  rk_downstream,. 
+0002a4b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002a4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4d0: 2020 7365 7276 6963 6520 3d20 7265 736f    service = reso
+0002a4e0: 7572 6365 735f 746f 5f72 756e 5f66 6f72  urces_to_run_for
+0002a4f0: 6b5f 646f 776e 7374 7265 616d 5b6e 616d  k_downstream[nam
+0002a500: 655d 2e67 6574 2822 7061 7261 6d73 222c  e].get("params",
+0002a510: 207b 7d29 2e67 6574 2822 696d 706f 7274   {}).get("import
+0002a520: 5f73 6572 7669 6365 2229 0a20 2020 2020  _service").     
+0002a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a540: 2020 2069 6620 7265 6c65 6173 655f 6372     if release_cr
+0002a550: 6561 7465 6420 616e 6420 286b 6166 6b61  eated and (kafka
+0002a560: 5f63 6f6e 6e65 6374 696f 6e5f 6e61 6d65  _connection_name
+0002a570: 206f 7220 7365 7276 6963 6529 3a0a 2020   or service):.  
+0002a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a590: 2020 2020 2020 2020 2020 636f 6e6e 6563            connec
+0002a5a0: 746f 7220 3d20 224b 6166 6b61 2220 6966  tor = "Kafka" if
+0002a5b0: 206b 6166 6b61 5f63 6f6e 6e65 6374 696f   kafka_connectio
+0002a5c0: 6e5f 6e61 6d65 2065 6c73 6520 7365 7276  n_name else serv
+0002a5d0: 6963 650a 2020 2020 2020 2020 2020 2020  ice.            
+0002a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a5f0: 6572 726f 725f 6d73 6720 3d20 4665 6564  error_msg = Feed
+0002a600: 6261 636b 4d61 6e61 6765 722e 6572 726f  backManager.erro
+0002a610: 725f 636f 6e6e 6563 746f 725f 7265 7175  r_connector_requ
+0002a620: 6972 655f 706f 7374 5f72 656c 6561 7365  ire_post_release
+0002a630: 2863 6f6e 6e65 6374 6f72 3d63 6f6e 6e65  (connector=conne
+0002a640: 6374 6f72 290a 2020 2020 2020 2020 2020  ctor).          
+0002a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a660: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+0002a670: 6963 6b45 7863 6570 7469 6f6e 2865 7272  ickException(err
+0002a680: 6f72 5f6d 7367 290a 0a20 2020 2020 2020  or_msg)..       
+0002a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6a0: 2023 2049 6620 7765 2061 7265 2070 7573   # If we are pus
+0002a6b0: 6869 6e67 2061 206d 6f64 6966 6965 6420  hing a modified 
+0002a6c0: 6461 7461 736f 7572 6365 2c20 696e 666f  datasource, info
+0002a6d0: 726d 2061 626f 7574 2074 6865 2062 6163  rm about the bac
+0002a6e0: 6b66 696c 6c60 600a 2020 2020 2020 2020  kfill``.        
+0002a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a700: 6966 2063 6865 636b 5f62 6163 6b66 696c  if check_backfil
+0002a710: 6c5f 7265 7175 6972 6564 2061 6e64 2061  l_required and a
+0002a720: 7574 6f5f 7072 6f6d 6f74 6520 616e 6420  uto_promote and 
+0002a730: 7265 6c65 6173 655f 6372 6561 7465 643a  release_created:
+0002a740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a750: 2020 2020 2020 2020 2020 2020 2065 7272               err
+0002a760: 6f72 5f6d 7367 203d 2046 6565 6462 6163  or_msg = Feedbac
+0002a770: 6b4d 616e 6167 6572 2e65 7272 6f72 5f63  kManager.error_c
+0002a780: 6865 636b 5f62 6163 6b66 696c 6c5f 7265  heck_backfill_re
+0002a790: 7175 6972 6564 2872 6573 6f75 7263 655f  quired(resource_
+0002a7a0: 6e61 6d65 3d6e 616d 6529 0a20 2020 2020  name=name).     
+0002a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7c0: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
+0002a7d0: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
+0002a7e0: 6e28 6572 726f 725f 6d73 6729 0a0a 2020  n(error_msg)..  
 0002a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a800: 2020 2020 2020 2020 2020 2066 6f72 6b2c             fork,
-0002a810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a820: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002a830: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0002a840: 726f 6365 7373 6564 2e61 6464 286e 616d  rocessed.add(nam
-0002a850: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
-0002a860: 2320 4e6f 772c 2077 6520 7769 6c6c 2063  # Now, we will c
-0002a870: 7265 6174 6520 6120 6d61 7020 6f66 2061  reate a map of a
-0002a880: 6c6c 2074 6865 2065 6e64 706f 696e 7473  ll the endpoints
-0002a890: 2061 6e64 2074 6865 7265 2064 6570 656e   and there depen
-0002a8a0: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
-0002a8b0: 2020 2020 2320 5765 2061 7265 2075 7369      # We are usi
-0002a8c0: 6e67 2074 6865 2066 6f72 6b64 6f77 6e73  ng the forkdowns
-0002a8d0: 7472 6561 6d20 6772 6170 6820 746f 2067  tream graph to g
-0002a8e0: 6574 2074 6865 2064 6570 656e 6465 6e63  et the dependenc
-0002a8f0: 6965 7320 6f66 2074 6865 2065 6e64 706f  ies of the endpo
-0002a900: 696e 7473 2061 7320 7468 6520 6e6f 726d  ints as the norm
-0002a910: 616c 2064 6570 656e 6465 6e63 6965 7320  al dependencies 
-0002a920: 6772 6170 6820 6f6e 6c79 2063 6f6e 7461  graph only conta
-0002a930: 696e 7320 7468 6520 7265 736f 7572 6365  ins the resource
-0002a940: 7320 7468 6174 2061 7265 2067 6f69 6e67  s that are going
-0002a950: 2074 6f20 6265 2064 6570 6c6f 7965 640a   to be deployed.
-0002a960: 2020 2020 2020 2020 2020 2020 2320 4275              # Bu
-0002a970: 7420 646f 6573 206e 6f74 2069 6e63 6c75  t does not inclu
-0002a980: 6465 2074 6865 206d 6973 7369 6e67 2067  de the missing g
-0002a990: 6170 730a 2020 2020 2020 2020 2020 2020  aps.            
-0002a9a0: 2320 4966 2077 6520 6861 7665 2045 4e44  # If we have END
-0002a9b0: 504f 494e 545f 4120 2d2d 2d2d 3e20 4d56  POINT_A ----> MV
-0002a9c0: 5f50 4950 455f 4220 2d2d 2d2d 2d3e 2044  _PIPE_B -----> D
-0002a9d0: 4154 4153 4f55 5243 455f 4220 2d2d 2d2d  ATASOURCE_B ----
-0002a9e0: 2d2d 3e20 454e 4450 4f49 4e54 5f43 0a20  --> ENDPOINT_C. 
-0002a9f0: 2020 2020 2020 2020 2020 2023 2057 6865             # Whe
-0002aa00: 7265 2065 6e64 706f 696e 7420 4120 6973  re endpoint A is
-0002aa10: 2062 6569 6e67 2075 7365 6420 696e 2074   being used in t
-0002aa20: 6865 204d 565f 5049 5045 5f42 2c20 6966  he MV_PIPE_B, if
-0002aa30: 2077 6520 6f6e 6c79 206d 6f64 6966 7920   we only modify 
-0002aa40: 7468 6520 656e 6470 6f69 6e74 2041 0a20  the endpoint A. 
-0002aa50: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-0002aa60: 2064 6570 656e 6465 6e63 6965 7320 6772   dependencies gr
-0002aa70: 6170 6820 7769 6c6c 206f 6e6c 7920 636f  aph will only co
-0002aa80: 6e74 6169 6e20 7468 6520 656e 6470 6f69  ntain the endpoi
-0002aa90: 6e74 2041 2061 6e64 2074 6865 204d 565f  nt A and the MV_
-0002aaa0: 5049 5045 5f42 2c20 6275 7420 6e6f 7420  PIPE_B, but not 
-0002aab0: 7468 6520 4441 5441 534f 5552 4345 5f42  the DATASOURCE_B
-0002aac0: 2061 6e64 2074 6865 2045 4e44 504f 494e   and the ENDPOIN
-0002aad0: 545f 430a 2020 2020 2020 2020 2020 2020  T_C.            
-0002aae0: 6772 6f75 7073 203d 205b 6772 6f75 7020  groups = [group 
-0002aaf0: 666f 7220 6772 6f75 7020 696e 2074 6f70  for group in top
-0002ab00: 6f73 6f72 7428 6465 7065 6e64 656e 6369  osort(dependenci
-0002ab10: 6573 5f67 7261 7068 5f66 6f72 6b5f 646f  es_graph_fork_do
-0002ab20: 776e 7374 7265 616d 295d 0a20 2020 2020  wnstream)].     
-0002ab30: 2020 2020 2020 2066 6f72 2067 726f 7570         for group
-0002ab40: 2069 6e20 6772 6f75 7073 3a0a 2020 2020   in groups:.    
-0002ab50: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002ab60: 6e61 6d65 2069 6e20 6772 6f75 703a 0a20  name in group:. 
-0002ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ab80: 2020 2069 6620 6e61 6d65 2069 6e20 7072     if name in pr
-0002ab90: 6f63 6573 7365 6420 6f72 206e 6f74 2069  ocessed or not i
-0002aba0: 735f 656e 6470 6f69 6e74 2872 6573 6f75  s_endpoint(resou
-0002abb0: 7263 6573 5f74 6f5f 7275 6e5f 666f 726b  rces_to_run_fork
-0002abc0: 5f64 6f77 6e73 7472 6561 6d5b 6e61 6d65  _downstream[name
-0002abd0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-0002abe0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0002abf0: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-0002ac00: 2020 2020 2020 2020 2020 656e 6470 6f69            endpoi
-0002ac10: 6e74 735f 6465 705f 6d61 705b 6e61 6d65  nts_dep_map[name
-0002ac20: 5d20 3d20 6465 7065 6e64 656e 6369 6573  ] = dependencies
-0002ac30: 5f67 7261 7068 5f66 6f72 6b5f 646f 776e  _graph_fork_down
-0002ac40: 7374 7265 616d 5b6e 616d 655d 0a0a 2020  stream[name]..  
-0002ac50: 2020 2020 2020 2020 2020 2320 4e6f 7720            # Now 
-0002ac60: 7468 6174 2077 6520 6861 7665 2074 6865  that we have the
-0002ac70: 2064 6570 656e 6465 6e63 6965 7320 6f66   dependencies of
-0002ac80: 2074 6865 2065 6e64 706f 696e 7473 2c20   the endpoints, 
-0002ac90: 7765 206e 6565 6420 746f 2063 6865 636b  we need to check
-0002aca0: 2074 6861 7420 7468 6520 7265 736f 7572   that the resour
-0002acb0: 6365 7320 6861 7320 6e6f 7420 6265 656e  ces has not been
-0002acc0: 2064 6570 6c6f 7965 6420 7965 7420 616e   deployed yet an
-0002acd0: 6420 6f6e 6c79 2063 6172 6520 6162 6f75  d only care abou
-0002ace0: 7420 7468 6520 656e 6470 6f69 6e74 7320  t the endpoints 
-0002acf0: 7468 6174 2064 6570 656e 6420 6f6e 2065  that depend on e
-0002ad00: 6e64 706f 696e 7473 0a20 2020 2020 2020  ndpoints.       
-0002ad10: 2020 2020 2067 726f 7570 7320 3d20 5b67       groups = [g
-0002ad20: 726f 7570 2066 6f72 2067 726f 7570 2069  roup for group i
-0002ad30: 6e20 746f 706f 736f 7274 2865 6e64 706f  n toposort(endpo
-0002ad40: 696e 7473 5f64 6570 5f6d 6170 295d 0a0a  ints_dep_map)]..
-0002ad50: 2020 2020 2020 2020 2020 2020 2320 4173              # As
-0002ad60: 2077 6520 6861 7665 2075 7365 6420 7468   we have used th
-0002ad70: 6520 666f 726b 646f 776e 7374 7265 616d  e forkdownstream
-0002ad80: 2067 7261 7068 2074 6f20 6765 7420 7468   graph to get th
-0002ad90: 6520 6465 7065 6e64 656e 6369 6573 206f  e dependencies o
-0002ada0: 6620 7468 6520 656e 6470 6f69 6e74 732c  f the endpoints,
-0002adb0: 2077 6520 6861 7665 2061 6c6c 2074 6865   we have all the
-0002adc0: 2064 6570 656e 6465 6e63 6965 7320 6f66   dependencies of
-0002add0: 2074 6865 2065 6e64 706f 696e 7473 0a20   the endpoints. 
-0002ade0: 2020 2020 2020 2020 2020 2023 2042 7574             # But
-0002adf0: 2077 6520 6e65 6564 2074 6f20 6465 706c   we need to depl
-0002ae00: 6f79 2074 6865 2065 6e64 706f 696e 7473  oy the endpoints
-0002ae10: 2061 6e64 2074 6865 2064 6570 656e 6465   and the depende
-0002ae20: 6e63 6965 7320 6f66 2074 6865 2065 6e64  ncies of the end
-0002ae30: 706f 696e 7473 2066 726f 6d20 6c65 6674  points from left
-0002ae40: 2074 6f20 7269 6768 740a 2020 2020 2020   to right.      
-0002ae50: 2020 2020 2020 2320 536f 2077 6520 6e65        # So we ne
-0002ae60: 6564 2074 6f20 7265 7665 7273 6520 7468  ed to reverse th
-0002ae70: 6520 6772 6f75 7073 0a20 2020 2020 2020  e groups.       
-0002ae80: 2020 2020 2067 726f 7570 732e 7265 7665       groups.reve
-0002ae90: 7273 6528 290a 2020 2020 2020 2020 2020  rse().          
-0002aea0: 2020 666f 7220 6772 6f75 7020 696e 2067    for group in g
-0002aeb0: 726f 7570 733a 0a20 2020 2020 2020 2020  roups:.         
-0002aec0: 2020 2020 2020 2066 6f72 206e 616d 6520         for name 
-0002aed0: 696e 2067 726f 7570 3a0a 2020 2020 2020  in group:.      
-0002aee0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002aef0: 206e 616d 6520 696e 2070 726f 6365 7373   name in process
-0002af00: 6564 206f 7220 6e6f 7420 6973 5f65 6e64  ed or not is_end
-0002af10: 706f 696e 7428 7265 736f 7572 6365 735f  point(resources_
-0002af20: 746f 5f72 756e 5f66 6f72 6b5f 646f 776e  to_run_fork_down
-0002af30: 7374 7265 616d 5b6e 616d 655d 293a 0a20  stream[name]):. 
-0002af40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002af50: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0002af60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002af70: 2020 2020 2061 7761 6974 2070 7573 6828       await push(
-0002af80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002af90: 2020 2020 2020 2020 206e 616d 652c 0a20           name,. 
-0002afa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002afb0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-0002afc0: 5f74 6f5f 7275 6e5f 666f 726b 5f64 6f77  _to_run_fork_dow
-0002afd0: 6e73 7472 6561 6d2c 0a20 2020 2020 2020  nstream,.       
-0002afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aff0: 2072 6573 6f75 7263 655f 7665 7273 696f   resource_versio
-0002b000: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-0002b010: 2020 2020 2020 2020 2020 2020 6c61 7465              late
-0002b020: 7374 5f64 6174 6173 6f75 7263 655f 7665  st_datasource_ve
-0002b030: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
-0002b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b050: 6472 795f 7275 6e2c 0a20 2020 2020 2020  dry_run,.       
-0002b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b070: 2066 6f72 6b5f 646f 776e 7374 7265 616d   fork_downstream
-0002b080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b090: 2020 2020 2020 2020 2020 666f 726b 2c0a            fork,.
+0002a800: 2020 2020 2020 6177 6169 7420 7075 7368        await push
+0002a810: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002a820: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+0002a830: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+0002a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a850: 7265 736f 7572 6365 735f 746f 5f72 756e  resources_to_run
+0002a860: 5f66 6f72 6b5f 646f 776e 7374 7265 616d  _fork_downstream
+0002a870: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002a880: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002a890: 736f 7572 6365 5f76 6572 7369 6f6e 732c  source_versions,
+0002a8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a8b0: 2020 2020 2020 2020 2020 2020 206c 6174               lat
+0002a8c0: 6573 745f 6461 7461 736f 7572 6365 5f76  est_datasource_v
+0002a8d0: 6572 7369 6f6e 732c 0a20 2020 2020 2020  ersions,.       
+0002a8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a8f0: 2020 2020 2064 7279 5f72 756e 2c0a 2020       dry_run,.  
+0002a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a910: 2020 2020 2020 2020 2020 666f 726b 5f64            fork_d
+0002a920: 6f77 6e73 7472 6561 6d2c 0a20 2020 2020  ownstream,.     
+0002a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a940: 2020 2020 2020 2066 6f72 6b2c 0a20 2020         fork,.   
+0002a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a960: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0002a970: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+0002a980: 7373 6564 2e61 6464 286e 616d 6529 0a0a  ssed.add(name)..
+0002a990: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
+0002a9a0: 772c 2077 6520 7769 6c6c 2063 7265 6174  w, we will creat
+0002a9b0: 6520 6120 6d61 7020 6f66 2061 6c6c 2074  e a map of all t
+0002a9c0: 6865 2065 6e64 706f 696e 7473 2061 6e64  he endpoints and
+0002a9d0: 2074 6865 7265 2064 6570 656e 6465 6e63   there dependenc
+0002a9e0: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
+0002a9f0: 2320 5765 2061 7265 2075 7369 6e67 2074  # We are using t
+0002aa00: 6865 2066 6f72 6b64 6f77 6e73 7472 6561  he forkdownstrea
+0002aa10: 6d20 6772 6170 6820 746f 2067 6574 2074  m graph to get t
+0002aa20: 6865 2064 6570 656e 6465 6e63 6965 7320  he dependencies 
+0002aa30: 6f66 2074 6865 2065 6e64 706f 696e 7473  of the endpoints
+0002aa40: 2061 7320 7468 6520 6e6f 726d 616c 2064   as the normal d
+0002aa50: 6570 656e 6465 6e63 6965 7320 6772 6170  ependencies grap
+0002aa60: 6820 6f6e 6c79 2063 6f6e 7461 696e 7320  h only contains 
+0002aa70: 7468 6520 7265 736f 7572 6365 7320 7468  the resources th
+0002aa80: 6174 2061 7265 2067 6f69 6e67 2074 6f20  at are going to 
+0002aa90: 6265 2064 6570 6c6f 7965 640a 2020 2020  be deployed.    
+0002aaa0: 2020 2020 2020 2020 2320 4275 7420 646f          # But do
+0002aab0: 6573 206e 6f74 2069 6e63 6c75 6465 2074  es not include t
+0002aac0: 6865 206d 6973 7369 6e67 2067 6170 730a  he missing gaps.
+0002aad0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0002aae0: 2077 6520 6861 7665 2045 4e44 504f 494e   we have ENDPOIN
+0002aaf0: 545f 4120 2d2d 2d2d 3e20 4d56 5f50 4950  T_A ----> MV_PIP
+0002ab00: 455f 4220 2d2d 2d2d 2d3e 2044 4154 4153  E_B -----> DATAS
+0002ab10: 4f55 5243 455f 4220 2d2d 2d2d 2d2d 3e20  OURCE_B ------> 
+0002ab20: 454e 4450 4f49 4e54 5f43 0a20 2020 2020  ENDPOINT_C.     
+0002ab30: 2020 2020 2020 2023 2057 6865 7265 2065         # Where e
+0002ab40: 6e64 706f 696e 7420 4120 6973 2062 6569  ndpoint A is bei
+0002ab50: 6e67 2075 7365 6420 696e 2074 6865 204d  ng used in the M
+0002ab60: 565f 5049 5045 5f42 2c20 6966 2077 6520  V_PIPE_B, if we 
+0002ab70: 6f6e 6c79 206d 6f64 6966 7920 7468 6520  only modify the 
+0002ab80: 656e 6470 6f69 6e74 2041 0a20 2020 2020  endpoint A.     
+0002ab90: 2020 2020 2020 2023 2054 6865 2064 6570         # The dep
+0002aba0: 656e 6465 6e63 6965 7320 6772 6170 6820  endencies graph 
+0002abb0: 7769 6c6c 206f 6e6c 7920 636f 6e74 6169  will only contai
+0002abc0: 6e20 7468 6520 656e 6470 6f69 6e74 2041  n the endpoint A
+0002abd0: 2061 6e64 2074 6865 204d 565f 5049 5045   and the MV_PIPE
+0002abe0: 5f42 2c20 6275 7420 6e6f 7420 7468 6520  _B, but not the 
+0002abf0: 4441 5441 534f 5552 4345 5f42 2061 6e64  DATASOURCE_B and
+0002ac00: 2074 6865 2045 4e44 504f 494e 545f 430a   the ENDPOINT_C.
+0002ac10: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0002ac20: 7073 203d 205b 6772 6f75 7020 666f 7220  ps = [group for 
+0002ac30: 6772 6f75 7020 696e 2074 6f70 6f73 6f72  group in toposor
+0002ac40: 7428 6465 7065 6e64 656e 6369 6573 5f67  t(dependencies_g
+0002ac50: 7261 7068 5f66 6f72 6b5f 646f 776e 7374  raph_fork_downst
+0002ac60: 7265 616d 295d 0a20 2020 2020 2020 2020  ream)].         
+0002ac70: 2020 2066 6f72 2067 726f 7570 2069 6e20     for group in 
+0002ac80: 6772 6f75 7073 3a0a 2020 2020 2020 2020  groups:.        
+0002ac90: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
+0002aca0: 2069 6e20 6772 6f75 703a 0a20 2020 2020   in group:.     
+0002acb0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002acc0: 6620 6e61 6d65 2069 6e20 7072 6f63 6573  f name in proces
+0002acd0: 7365 6420 6f72 206e 6f74 2069 735f 656e  sed or not is_en
+0002ace0: 6470 6f69 6e74 2872 6573 6f75 7263 6573  dpoint(resources
+0002acf0: 5f74 6f5f 7275 6e5f 666f 726b 5f64 6f77  _to_run_fork_dow
+0002ad00: 6e73 7472 6561 6d5b 6e61 6d65 5d29 3a0a  nstream[name]):.
+0002ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ad20: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0002ad30: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0002ad40: 2020 2020 2020 656e 6470 6f69 6e74 735f        endpoints_
+0002ad50: 6465 705f 6d61 705b 6e61 6d65 5d20 3d20  dep_map[name] = 
+0002ad60: 6465 7065 6e64 656e 6369 6573 5f67 7261  dependencies_gra
+0002ad70: 7068 5f66 6f72 6b5f 646f 776e 7374 7265  ph_fork_downstre
+0002ad80: 616d 5b6e 616d 655d 0a0a 2020 2020 2020  am[name]..      
+0002ad90: 2020 2020 2020 2320 4e6f 7720 7468 6174        # Now that
+0002ada0: 2077 6520 6861 7665 2074 6865 2064 6570   we have the dep
+0002adb0: 656e 6465 6e63 6965 7320 6f66 2074 6865  endencies of the
+0002adc0: 2065 6e64 706f 696e 7473 2c20 7765 206e   endpoints, we n
+0002add0: 6565 6420 746f 2063 6865 636b 2074 6861  eed to check tha
+0002ade0: 7420 7468 6520 7265 736f 7572 6365 7320  t the resources 
+0002adf0: 6861 7320 6e6f 7420 6265 656e 2064 6570  has not been dep
+0002ae00: 6c6f 7965 6420 7965 7420 616e 6420 6f6e  loyed yet and on
+0002ae10: 6c79 2063 6172 6520 6162 6f75 7420 7468  ly care about th
+0002ae20: 6520 656e 6470 6f69 6e74 7320 7468 6174  e endpoints that
+0002ae30: 2064 6570 656e 6420 6f6e 2065 6e64 706f   depend on endpo
+0002ae40: 696e 7473 0a20 2020 2020 2020 2020 2020  ints.           
+0002ae50: 2067 726f 7570 7320 3d20 5b67 726f 7570   groups = [group
+0002ae60: 2066 6f72 2067 726f 7570 2069 6e20 746f   for group in to
+0002ae70: 706f 736f 7274 2865 6e64 706f 696e 7473  posort(endpoints
+0002ae80: 5f64 6570 5f6d 6170 295d 0a0a 2020 2020  _dep_map)]..    
+0002ae90: 2020 2020 2020 2020 2320 4173 2077 6520          # As we 
+0002aea0: 6861 7665 2075 7365 6420 7468 6520 666f  have used the fo
+0002aeb0: 726b 646f 776e 7374 7265 616d 2067 7261  rkdownstream gra
+0002aec0: 7068 2074 6f20 6765 7420 7468 6520 6465  ph to get the de
+0002aed0: 7065 6e64 656e 6369 6573 206f 6620 7468  pendencies of th
+0002aee0: 6520 656e 6470 6f69 6e74 732c 2077 6520  e endpoints, we 
+0002aef0: 6861 7665 2061 6c6c 2074 6865 2064 6570  have all the dep
+0002af00: 656e 6465 6e63 6965 7320 6f66 2074 6865  endencies of the
+0002af10: 2065 6e64 706f 696e 7473 0a20 2020 2020   endpoints.     
+0002af20: 2020 2020 2020 2023 2042 7574 2077 6520         # But we 
+0002af30: 6e65 6564 2074 6f20 6465 706c 6f79 2074  need to deploy t
+0002af40: 6865 2065 6e64 706f 696e 7473 2061 6e64  he endpoints and
+0002af50: 2074 6865 2064 6570 656e 6465 6e63 6965   the dependencie
+0002af60: 7320 6f66 2074 6865 2065 6e64 706f 696e  s of the endpoin
+0002af70: 7473 2066 726f 6d20 6c65 6674 2074 6f20  ts from left to 
+0002af80: 7269 6768 740a 2020 2020 2020 2020 2020  right.          
+0002af90: 2020 2320 536f 2077 6520 6e65 6564 2074    # So we need t
+0002afa0: 6f20 7265 7665 7273 6520 7468 6520 6772  o reverse the gr
+0002afb0: 6f75 7073 0a20 2020 2020 2020 2020 2020  oups.           
+0002afc0: 2067 726f 7570 732e 7265 7665 7273 6528   groups.reverse(
+0002afd0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0002afe0: 7220 6772 6f75 7020 696e 2067 726f 7570  r group in group
+0002aff0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002b000: 2020 2066 6f72 206e 616d 6520 696e 2067     for name in g
+0002b010: 726f 7570 3a0a 2020 2020 2020 2020 2020  roup:.          
+0002b020: 2020 2020 2020 2020 2020 6966 206e 616d            if nam
+0002b030: 6520 696e 2070 726f 6365 7373 6564 206f  e in processed o
+0002b040: 7220 6e6f 7420 6973 5f65 6e64 706f 696e  r not is_endpoin
+0002b050: 7428 7265 736f 7572 6365 735f 746f 5f72  t(resources_to_r
+0002b060: 756e 5f66 6f72 6b5f 646f 776e 7374 7265  un_fork_downstre
+0002b070: 616d 5b6e 616d 655d 293a 0a20 2020 2020  am[name]):.     
+0002b080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b090: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
 0002b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b0b0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0002b0c0: 2020 2020 2020 2020 2020 7072 6f63 6573            proces
-0002b0d0: 7365 642e 6164 6428 6e61 6d65 290a 0a20  sed.add(name).. 
-0002b0e0: 2020 2020 2020 2020 2020 2023 204e 6f77             # Now
-0002b0f0: 2077 6520 7368 6f75 6c64 2068 6176 6520   we should have 
-0002b100: 7468 6520 656e 6470 6f69 6e74 7320 616e  the endpoints an
-0002b110: 6420 6461 7461 736f 7572 6365 7320 6465  d datasources de
-0002b120: 706c 6f79 6564 2c20 7765 2063 616e 2064  ployed, we can d
-0002b130: 6570 6c6f 7920 7468 6520 7265 7374 206f  eploy the rest o
-0002b140: 6620 7468 6520 7069 7065 7320 2863 6f70  f the pipes (cop
-0002b150: 7920 2620 7369 6e6b 7329 0a20 2020 2020  y & sinks).     
-0002b160: 2020 2020 2020 2023 2057 6520 6e65 6564         # We need
-0002b170: 2074 6f20 7265 6c79 206f 6e20 7468 6520   to rely on the 
-0002b180: 666f 726b 646f 776e 7374 7265 616d 2067  forkdownstream g
-0002b190: 7261 7068 2061 7320 6974 2063 6f6e 7461  raph as it conta
-0002b1a0: 696e 7320 616c 6c20 7468 6520 6d6f 6469  ins all the modi
-0002b1b0: 6669 6564 2070 6970 6573 2061 7320 7765  fied pipes as we
-0002b1c0: 6c6c 2061 7320 7468 6520 6465 7065 6e64  ll as the depend
-0002b1d0: 656e 6369 6573 206f 6620 7468 6520 7069  encies of the pi
-0002b1e0: 7065 730a 2020 2020 2020 2020 2020 2020  pes.            
-0002b1f0: 2320 496e 2074 6869 7320 6361 7365 2c20  # In this case, 
-0002b200: 7765 2064 6f6e 2774 206e 6565 6420 746f  we don't need to
-0002b210: 2067 656e 6572 6174 6520 6120 6e65 7720   generate a new 
-0002b220: 6772 6170 6820 6173 2077 6520 6469 6420  graph as we did 
-0002b230: 666f 7220 7468 6520 656e 6470 6f69 6e74  for the endpoint
-0002b240: 7320 6173 2074 6865 2070 6970 6573 2061  s as the pipes a
-0002b250: 7265 206e 6f74 2067 6f69 6e67 2074 6f20  re not going to 
-0002b260: 6265 2075 7365 6420 6173 2064 6570 656e  be used as depen
-0002b270: 6465 6e63 6965 7320 616e 6420 7468 6520  dencies and the 
-0002b280: 6461 7461 736f 7572 6365 7320 6172 6520  datasources are 
-0002b290: 616c 7265 6164 7920 6465 706c 6f79 6564  already deployed
-0002b2a0: 0a20 2020 2020 2020 2020 2020 2067 726f  .            gro
-0002b2b0: 7570 7320 3d20 5b67 726f 7570 2066 6f72  ups = [group for
-0002b2c0: 2067 726f 7570 2069 6e20 746f 706f 736f   group in toposo
-0002b2d0: 7274 2864 6570 656e 6465 6e63 6965 735f  rt(dependencies_
-0002b2e0: 6772 6170 685f 666f 726b 5f64 6f77 6e73  graph_fork_downs
-0002b2f0: 7472 6561 6d29 5d0a 2020 2020 2020 2020  tream)].        
-0002b300: 2020 2020 666f 7220 6772 6f75 7020 696e      for group in
-0002b310: 2067 726f 7570 733a 0a20 2020 2020 2020   groups:.       
-0002b320: 2020 2020 2020 2020 2066 6f72 206e 616d           for nam
-0002b330: 6520 696e 2067 726f 7570 3a0a 2020 2020  e in group:.    
-0002b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b350: 6966 206e 616d 6520 696e 2070 726f 6365  if name in proce
-0002b360: 7373 6564 206f 7220 6973 5f6d 6174 6572  ssed or is_mater
-0002b370: 6961 6c69 7a65 6428 7265 736f 7572 6365  ialized(resource
-0002b380: 735f 746f 5f72 756e 5f66 6f72 6b5f 646f  s_to_run_fork_do
-0002b390: 776e 7374 7265 616d 2e67 6574 286e 616d  wnstream.get(nam
-0002b3a0: 6529 293a 0a20 2020 2020 2020 2020 2020  e)):.           
-0002b3b0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0002b3c0: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-0002b3d0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0002b3e0: 2070 7573 6828 0a20 2020 2020 2020 2020   push(.         
-0002b3f0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0002b400: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0002b410: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0002b420: 6f75 7263 6573 5f74 6f5f 7275 6e5f 666f  ources_to_run_fo
-0002b430: 726b 5f64 6f77 6e73 7472 6561 6d2c 0a20  rk_downstream,. 
-0002b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b450: 2020 2020 2020 2072 6573 6f75 7263 655f         resource_
-0002b460: 7665 7273 696f 6e73 2c0a 2020 2020 2020  versions,.      
-0002b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b480: 2020 6c61 7465 7374 5f64 6174 6173 6f75    latest_datasou
-0002b490: 7263 655f 7665 7273 696f 6e73 2c0a 2020  rce_versions,.  
-0002b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4b0: 2020 2020 2020 6472 795f 7275 6e2c 0a20        dry_run,. 
-0002b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4d0: 2020 2020 2020 2066 6f72 6b5f 646f 776e         fork_down
-0002b4e0: 7374 7265 616d 2c0a 2020 2020 2020 2020  stream,.        
-0002b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b500: 666f 726b 2c0a 2020 2020 2020 2020 2020  fork,.          
-0002b510: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0002b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b530: 7072 6f63 6573 7365 642e 6164 6428 6e61  processed.add(na
-0002b540: 6d65 290a 0a20 2020 2020 2020 2020 2020  me)..           
-0002b550: 2023 2046 696e 616c 6c79 2c20 7765 206e   # Finally, we n
-0002b560: 6565 6420 746f 2064 6570 6c6f 7920 7468  eed to deploy th
-0002b570: 6520 6d61 7465 7269 616c 697a 6564 2076  e materialized v
-0002b580: 6965 7773 2066 726f 6d20 7269 6768 7420  iews from right 
-0002b590: 746f 206c 6566 742e 0a20 2020 2020 2020  to left..       
-0002b5a0: 2020 2020 2023 2057 6520 6e65 6564 2074       # We need t
-0002b5b0: 6f20 7265 6c79 206f 6e20 7468 6520 666f  o rely on the fo
-0002b5c0: 726b 646f 776e 7374 7265 616d 2067 7261  rkdownstream gra
-0002b5d0: 7068 2061 7320 6974 2063 6f6e 7461 696e  ph as it contain
-0002b5e0: 7320 616c 6c20 7468 6520 6d6f 6469 6669  s all the modifi
-0002b5f0: 6564 206d 6174 6572 6961 6c69 7a65 6420  ed materialized 
-0002b600: 7669 6577 7320 6173 2077 656c 6c20 6173  views as well as
-0002b610: 2074 6865 2064 6570 656e 6465 6e63 6965   the dependencie
-0002b620: 7320 6f66 2074 6865 206d 6174 6572 6961  s of the materia
-0002b630: 6c69 7a65 6420 7669 6577 730a 2020 2020  lized views.    
-0002b640: 2020 2020 2020 2020 2320 496e 2074 6869          # In thi
-0002b650: 7320 6361 7365 2c20 7765 2064 6f6e 2774  s case, we don't
-0002b660: 206e 6565 6420 746f 2067 656e 6572 6174   need to generat
-0002b670: 6520 6120 6e65 7720 6772 6170 6820 6173  e a new graph as
-0002b680: 2077 6520 6469 6420 666f 7220 7468 6520   we did for the 
-0002b690: 656e 6470 6f69 6e74 7320 6173 2074 6865  endpoints as the
-0002b6a0: 2070 6970 6573 2061 7265 206e 6f74 2067   pipes are not g
-0002b6b0: 6f69 6e67 2074 6f20 6265 2075 7365 6420  oing to be used 
-0002b6c0: 6173 2064 6570 656e 6465 6e63 6965 7320  as dependencies 
-0002b6d0: 616e 6420 7468 6520 6461 7461 736f 7572  and the datasour
-0002b6e0: 6365 7320 6172 6520 616c 7265 6164 7920  ces are already 
-0002b6f0: 6465 706c 6f79 6564 0a20 2020 2020 2020  deployed.       
-0002b700: 2020 2020 2067 726f 7570 7320 3d20 5b67       groups = [g
-0002b710: 726f 7570 2066 6f72 2067 726f 7570 2069  roup for group i
-0002b720: 6e20 746f 706f 736f 7274 2864 6570 656e  n toposort(depen
-0002b730: 6465 6e63 6965 735f 6772 6170 685f 666f  dencies_graph_fo
-0002b740: 726b 5f64 6f77 6e73 7472 6561 6d29 5d0a  rk_downstream)].
-0002b750: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002b760: 6772 6f75 7020 696e 2067 726f 7570 733a  group in groups:
-0002b770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b780: 2066 6f72 206e 616d 6520 696e 2067 726f   for name in gro
-0002b790: 7570 3a0a 2020 2020 2020 2020 2020 2020  up:.            
-0002b7a0: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
-0002b7b0: 696e 2070 726f 6365 7373 6564 206f 7220  in processed or 
-0002b7c0: 6e6f 7420 6973 5f6d 6174 6572 6961 6c69  not is_materiali
-0002b7d0: 7a65 6428 7265 736f 7572 6365 735f 746f  zed(resources_to
-0002b7e0: 5f72 756e 5f66 6f72 6b5f 646f 776e 7374  _run_fork_downst
-0002b7f0: 7265 616d 2e67 6574 286e 616d 6529 293a  ream.get(name)):
-0002b800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b810: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-0002b820: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-0002b830: 2020 2020 2020 2061 7761 6974 2070 7573         await pus
-0002b840: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
-0002b850: 2020 2020 2020 2020 2020 206e 616d 652c             name,
-0002b860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b870: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
-0002b880: 6573 5f74 6f5f 7275 6e5f 666f 726b 5f64  es_to_run_fork_d
-0002b890: 6f77 6e73 7472 6561 6d2c 0a20 2020 2020  ownstream,.     
-0002b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b8b0: 2020 2072 6573 6f75 7263 655f 7665 7273     resource_vers
-0002b8c0: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
-0002b8d0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0002b8e0: 7465 7374 5f64 6174 6173 6f75 7263 655f  test_datasource_
-0002b8f0: 7665 7273 696f 6e73 2c0a 2020 2020 2020  versions,.      
-0002b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b910: 2020 6472 795f 7275 6e2c 0a20 2020 2020    dry_run,.     
-0002b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b930: 2020 2066 6f72 6b5f 646f 776e 7374 7265     fork_downstre
-0002b940: 616d 2c0a 2020 2020 2020 2020 2020 2020  am,.            
-0002b950: 2020 2020 2020 2020 2020 2020 666f 726b              fork
-0002b960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b970: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002b980: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
-0002b990: 6573 7365 642e 6164 6428 6e61 6d65 290a  essed.add(name).
-0002b9a0: 0a20 2020 2069 6620 6465 706c 6f79 6d65  .    if deployme
-0002b9b0: 6e74 2e69 735f 6769 745f 7265 6c65 6173  nt.is_git_releas
-0002b9c0: 653a 0a20 2020 2020 2020 2064 6570 6c6f  e:.        deplo
-0002b9d0: 796d 656e 742e 6465 706c 6f79 696e 675f  yment.deploying_
-0002b9e0: 6472 795f 7275 6e28 290a 2020 2020 2020  dry_run().      
-0002b9f0: 2020 6177 6169 7420 7075 7368 5f66 696c    await push_fil
-0002ba00: 6573 2864 6570 656e 6465 6e63 6965 735f  es(dependencies_
-0002ba10: 6772 6170 682c 2064 7279 5f72 756e 3d54  graph, dry_run=T
-0002ba20: 7275 652c 2063 6865 636b 5f62 6163 6b66  rue, check_backf
-0002ba30: 696c 6c5f 7265 7175 6972 6564 3d63 6865  ill_required=che
-0002ba40: 636b 5f62 6163 6b66 696c 6c5f 7265 7175  ck_backfill_requ
-0002ba50: 6972 6564 290a 0a20 2020 2020 2020 2061  ired)..        a
-0002ba60: 7761 6974 2064 6570 6c6f 796d 656e 742e  wait deployment.
-0002ba70: 6465 6c65 7465 5f72 6573 6f75 7263 6573  delete_resources
-0002ba80: 2864 656c 6574 6564 2c20 7069 7065 732c  (deleted, pipes,
-0002ba90: 2064 7279 5f72 756e 3d54 7275 6529 0a20   dry_run=True). 
-0002baa0: 2020 2020 2020 2069 6620 6e6f 7420 6465         if not de
-0002bab0: 706c 6f79 6d65 6e74 2e64 7279 5f72 756e  ployment.dry_run
-0002bac0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
-0002bad0: 706c 6f79 6d65 6e74 2e64 6570 6c6f 7969  ployment.deployi
-0002bae0: 6e67 2829 0a20 2020 2020 2020 2020 2020  ng().           
-0002baf0: 2061 7761 6974 2070 7573 685f 6669 6c65   await push_file
-0002bb00: 7328 6465 7065 6e64 656e 6369 6573 5f67  s(dependencies_g
-0002bb10: 7261 7068 2c20 6472 795f 7275 6e29 0a20  raph, dry_run). 
-0002bb20: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0002bb30: 2064 6570 6c6f 796d 656e 742e 6465 6c65   deployment.dele
-0002bb40: 7465 5f72 6573 6f75 7263 6573 2864 656c  te_resources(del
-0002bb50: 6574 6564 2c20 7069 7065 7329 0a20 2020  eted, pipes).   
-0002bb60: 2065 6c73 653a 0a20 2020 2020 2020 2061   else:.        a
-0002bb70: 7761 6974 2070 7573 685f 6669 6c65 7328  wait push_files(
-0002bb80: 6465 7065 6e64 656e 6369 6573 5f67 7261  dependencies_gra
-0002bb90: 7068 2c20 6472 795f 7275 6e29 0a0a 2020  ph, dry_run)..  
-0002bba0: 2020 6966 206e 6f74 2064 7279 5f72 756e    if not dry_run
-0002bbb0: 2061 6e64 206e 6f74 2072 756e 5f74 6573   and not run_tes
-0002bbc0: 7473 3a0a 2020 2020 2020 2020 6966 2075  ts:.        if u
-0002bbd0: 706c 6f61 645f 6669 7874 7572 6573 3a0a  pload_fixtures:.
-0002bbe0: 2020 2020 2020 2020 2020 2020 636c 6963              clic
-0002bbf0: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
-0002bc00: 616e 6167 6572 2e69 6e66 6f5f 7075 7368  anager.info_push
-0002bc10: 696e 675f 6669 7874 7572 6573 2829 290a  ing_fixtures()).
-0002bc20: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-0002bc30: 6520 6e65 6564 2074 6f20 7570 6c6f 6164  e need to upload
-0002bc40: 2074 6865 2066 6978 7475 7265 7320 6576   the fixtures ev
-0002bc50: 656e 2069 6620 7468 6572 6520 6973 206e  en if there is n
-0002bc60: 6f20 6368 616e 6765 0a20 2020 2020 2020  o change.       
-0002bc70: 2020 2020 2069 6620 6973 5f62 7261 6e63       if is_branc
-0002bc80: 683a 0a20 2020 2020 2020 2020 2020 2020  h:.             
-0002bc90: 2020 2066 696c 656e 616d 6573 203d 2067     filenames = g
-0002bca0: 6574 5f70 726f 6a65 6374 5f66 696c 656e  et_project_filen
-0002bcb0: 616d 6573 2866 6f6c 6465 722c 2077 6974  ames(folder, wit
-0002bcc0: 685f 7665 6e64 6f72 3d54 7275 6529 0a20  h_vendor=True). 
-0002bcd0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0002bce0: 6570 656e 6465 6e63 6965 735f 6772 6170  ependencies_grap
-0002bcf0: 6820 3d20 6177 6169 7420 6275 696c 645f  h = await build_
-0002bd00: 6772 6170 6828 0a20 2020 2020 2020 2020  graph(.         
-0002bd10: 2020 2020 2020 2020 2020 2066 696c 656e             filen
-0002bd20: 616d 6573 2c0a 2020 2020 2020 2020 2020  ames,.          
-0002bd30: 2020 2020 2020 2020 2020 7462 5f63 6c69            tb_cli
-0002bd40: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-0002bd50: 2020 2020 2020 2020 2064 6972 5f70 6174           dir_pat
-0002bd60: 683d 666f 6c64 6572 2c0a 2020 2020 2020  h=folder,.      
-0002bd70: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0002bd80: 736f 7572 6365 5f76 6572 7369 6f6e 733d  source_versions=
-0002bd90: 6c61 7465 7374 5f64 6174 6173 6f75 7263  latest_datasourc
-0002bda0: 655f 7665 7273 696f 6e73 2c0a 2020 2020  e_versions,.    
-0002bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bdc0: 776f 726b 7370 6163 655f 6d61 703d 776f  workspace_map=wo
-0002bdd0: 726b 7370 6163 655f 6d61 702c 0a20 2020  rkspace_map,.   
-0002bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bdf0: 2070 726f 6365 7373 5f64 6570 656e 6465   process_depende
-0002be00: 6e63 6965 733d 7075 7368 5f64 6570 732c  ncies=push_deps,
-0002be10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002be20: 2020 2020 2076 6572 626f 7365 3d76 6572       verbose=ver
-0002be30: 626f 7365 2c0a 2020 2020 2020 2020 2020  bose,.          
-0002be40: 2020 2020 2020 2020 2020 776f 726b 7370            worksp
-0002be50: 6163 655f 6c69 625f 7061 7468 733d 776f  ace_lib_paths=wo
-0002be60: 726b 7370 6163 655f 6c69 625f 7061 7468  rkspace_lib_path
-0002be70: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0002be80: 2020 2020 2020 2063 7572 7265 6e74 5f77         current_w
-0002be90: 733d 6375 7272 656e 745f 7773 2c0a 2020  s=current_ws,.  
-0002bea0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0002beb0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-0002bec0: 6365 7373 6564 203d 2073 6574 2829 0a20  cessed = set(). 
-0002bed0: 2020 2020 2020 2020 2020 2066 6f72 2067             for g
-0002bee0: 726f 7570 2069 6e20 746f 706f 736f 7274  roup in toposort
-0002bef0: 2864 6570 656e 6465 6e63 6965 735f 6772  (dependencies_gr
-0002bf00: 6170 682e 6465 705f 6d61 7029 3a0a 2020  aph.dep_map):.  
-0002bf10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0002bf20: 7220 6620 696e 2067 726f 7570 3a0a 2020  r f in group:.  
-0002bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf40: 2020 6e61 6d65 203d 206f 732e 7061 7468    name = os.path
-0002bf50: 2e62 6173 656e 616d 6528 6629 0a20 2020  .basename(f).   
-0002bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf70: 2069 6620 6e61 6d65 206e 6f74 2069 6e20   if name not in 
-0002bf80: 7072 6f63 6573 7365 643a 0a20 2020 2020  processed:.     
-0002bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bfa0: 2020 2069 6620 6e61 6d65 2069 6e20 6465     if name in de
-0002bfb0: 7065 6e64 656e 6369 6573 5f67 7261 7068  pendencies_graph
-0002bfc0: 2e74 6f5f 7275 6e3a 0a20 2020 2020 2020  .to_run:.       
-0002bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bfe0: 2020 2020 2061 7761 6974 2063 6865 636b       await check
-0002bff0: 5f66 6978 7475 7265 735f 6461 7461 280a  _fixtures_data(.
-0002c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c020: 7462 5f63 6c69 656e 742c 0a20 2020 2020  tb_client,.     
-0002c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c040: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-0002c050: 6465 6e63 6965 735f 6772 6170 682e 746f  dencies_graph.to
-0002c060: 5f72 756e 5b6e 616d 655d 2c0a 2020 2020  _run[name],.    
-0002c070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c080: 2020 2020 2020 2020 2020 2020 6465 6275              debu
-0002c090: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
-0002c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c0b0: 2020 2066 6f6c 6465 722c 0a20 2020 2020     folder,.     
-0002c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c0d0: 2020 2020 2020 2020 2020 2066 6f72 6365             force
-0002c0e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c100: 2020 6d6f 6465 3d22 6170 7065 6e64 2220    mode="append" 
-0002c110: 6966 2069 735f 6272 616e 6368 2065 6c73  if is_branch els
-0002c120: 6520 2272 6570 6c61 6365 222c 0a20 2020  e "replace",.   
-0002c130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c140: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002c150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c160: 2020 2020 2020 2070 726f 6365 7373 6564         processed
-0002c170: 2e61 6464 286e 616d 6529 0a20 2020 2020  .add(name).     
-0002c180: 2020 2020 2020 2066 6f72 2066 2069 6e20         for f in 
-0002c190: 6465 7065 6e64 656e 6369 6573 5f67 7261  dependencies_gra
-0002c1a0: 7068 2e74 6f5f 7275 6e3a 0a20 2020 2020  ph.to_run:.     
-0002c1b0: 2020 2020 2020 2020 2020 2069 6620 6620             if f 
-0002c1c0: 6e6f 7420 696e 2070 726f 6365 7373 6564  not in processed
-0002c1d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002c1e0: 2020 2020 2020 6177 6169 7420 6368 6563        await chec
-0002c1f0: 6b5f 6669 7874 7572 6573 5f64 6174 6128  k_fixtures_data(
-0002c200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c210: 2020 2020 2020 2020 2074 625f 636c 6965           tb_clie
-0002c220: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0002c230: 2020 2020 2020 2020 2020 2020 6465 7065              depe
-0002c240: 6e64 656e 6369 6573 5f67 7261 7068 2e74  ndencies_graph.t
-0002c250: 6f5f 7275 6e5b 665d 2c0a 2020 2020 2020  o_run[f],.      
-0002c260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c270: 2020 6465 6275 672c 0a20 2020 2020 2020    debug,.       
-0002c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c290: 2066 6f6c 6465 722c 0a20 2020 2020 2020   folder,.       
-0002c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2b0: 2066 6f72 6365 2c0a 2020 2020 2020 2020   force,.        
-0002c2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2d0: 6d6f 6465 3d22 6170 7065 6e64 2220 6966  mode="append" if
-0002c2e0: 2069 735f 6272 616e 6368 2065 6c73 6520   is_branch else 
-0002c2f0: 2272 6570 6c61 6365 222c 0a20 2020 2020  "replace",.     
-0002c300: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0002c310: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0002c320: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-0002c330: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-0002c340: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
-0002c350: 6f28 4665 6564 6261 636b 4d61 6e61 6765  o(FeedbackManage
-0002c360: 722e 696e 666f 5f6e 6f74 5f70 7573 6869  r.info_not_pushi
-0002c370: 6e67 5f66 6978 7475 7265 7328 2929 0a0a  ng_fixtures())..
-0002c380: 2020 2020 6177 6169 7420 6465 706c 6f79      await deploy
-0002c390: 6d65 6e74 2e75 7064 6174 655f 7265 6c65  ment.update_rele
-0002c3a0: 6173 6528 6861 735f 7365 6d76 6572 3d68  ase(has_semver=h
-0002c3b0: 6173 5f73 656d 7665 722c 2072 656c 6561  as_semver, relea
-0002c3c0: 7365 5f63 7265 6174 6564 3d72 656c 6561  se_created=relea
-0002c3d0: 7365 5f63 7265 6174 6564 290a 0a20 2020  se_created)..   
-0002c3e0: 2072 6574 7572 6e20 6465 7065 6e64 656e   return dependen
-0002c3f0: 6369 6573 5f67 7261 7068 2e74 6f5f 7275  cies_graph.to_ru
-0002c400: 6e0a 0a0a 6173 796e 6320 6465 6620 6368  n...async def ch
-0002c410: 6563 6b5f 6669 7874 7572 6573 5f64 6174  eck_fixtures_dat
-0002c420: 6128 0a20 2020 2063 6c69 656e 743a 2054  a(.    client: T
-0002c430: 696e 7942 2c20 7265 736f 7572 6365 3a20  inyB, resource: 
-0002c440: 4469 6374 5b73 7472 2c20 416e 795d 2c20  Dict[str, Any], 
-0002c450: 6465 6275 673a 2062 6f6f 6c2c 2066 6f6c  debug: bool, fol
-0002c460: 6465 723a 2073 7472 203d 2022 222c 2066  der: str = "", f
-0002c470: 6f72 6365 3a20 626f 6f6c 203d 2046 616c  orce: bool = Fal
-0002c480: 7365 2c20 6d6f 6465 3a20 7374 7220 3d20  se, mode: str = 
-0002c490: 2272 6570 6c61 6365 220a 293a 0a20 2020  "replace".):.   
-0002c4a0: 2069 6620 6465 6275 673a 0a20 2020 2020   if debug:.     
-0002c4b0: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
-0002c4c0: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
-0002c4d0: 666f 5f63 6865 636b 696e 675f 6669 6c65  fo_checking_file
-0002c4e0: 2866 696c 653d 7070 2e70 666f 726d 6174  (file=pp.pformat
-0002c4f0: 2872 6573 6f75 7263 6529 2929 0a20 2020  (resource))).   
-0002c500: 2069 6620 7265 736f 7572 6365 5b22 7265   if resource["re
-0002c510: 736f 7572 6365 225d 2069 6e20 5b22 7069  source"] in ["pi
-0002c520: 7065 7322 2c20 2274 6f6b 656e 7322 5d3a  pes", "tokens"]:
-0002c530: 0a20 2020 2020 2020 2070 6173 730a 2020  .        pass.  
-0002c540: 2020 656c 6966 2072 6573 6f75 7263 655b    elif resource[
-0002c550: 2272 6573 6f75 7263 6522 5d20 3d3d 2022  "resource"] == "
-0002c560: 6461 7461 736f 7572 6365 7322 3a0a 2020  datasources":.  
-0002c570: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-0002c580: 5f6e 616d 6520 3d20 7265 736f 7572 6365  _name = resource
-0002c590: 5b22 7061 7261 6d73 225d 5b22 6e61 6d65  ["params"]["name
-0002c5a0: 225d 0a20 2020 2020 2020 206e 616d 6520  "].        name 
-0002c5b0: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-0002c5c0: 6d65 2872 6573 6f75 7263 655b 2266 696c  me(resource["fil
-0002c5d0: 656e 616d 6522 5d29 2e72 7370 6c69 7428  ename"]).rsplit(
-0002c5e0: 222e 222c 2031 295b 305d 0a20 2020 2020  ".", 1)[0].     
-0002c5f0: 2020 2066 6978 7475 7265 5f70 6174 6820     fixture_path 
-0002c600: 3d20 5061 7468 2866 6f6c 6465 7229 202f  = Path(folder) /
-0002c610: 2022 6669 7874 7572 6573 2220 2f20 6622   "fixtures" / f"
-0002c620: 7b6e 616d 657d 2e63 7376 220a 0a20 2020  {name}.csv"..   
-0002c630: 2020 2020 2069 6620 6e6f 7420 6669 7874       if not fixt
-0002c640: 7572 655f 7061 7468 2e65 7869 7374 7328  ure_path.exists(
-0002c650: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
-0002c660: 6978 7475 7265 5f70 6174 6820 3d20 5061  ixture_path = Pa
-0002c670: 7468 2866 6f6c 6465 7229 202f 2022 6461  th(folder) / "da
-0002c680: 7461 736f 7572 6365 7322 202f 2022 6669  tasources" / "fi
-0002c690: 7874 7572 6573 2220 2f20 6622 7b6e 616d  xtures" / f"{nam
-0002c6a0: 657d 2e63 7376 220a 2020 2020 2020 2020  e}.csv".        
-0002c6b0: 6966 206e 6f74 2066 6978 7475 7265 5f70  if not fixture_p
-0002c6c0: 6174 682e 6578 6973 7473 2829 3a0a 2020  ath.exists():.  
-0002c6d0: 2020 2020 2020 2020 2020 6669 7874 7572            fixtur
-0002c6e0: 655f 7061 7468 203d 2050 6174 6828 666f  e_path = Path(fo
-0002c6f0: 6c64 6572 2920 2f20 2264 6174 6173 6f75  lder) / "datasou
-0002c700: 7263 6573 2220 2f20 2266 6978 7475 7265  rces" / "fixture
-0002c710: 7322 202f 2066 227b 6e61 6d65 7d2e 6e64  s" / f"{name}.nd
-0002c720: 6a73 6f6e 220a 2020 2020 2020 2020 6966  json".        if
-0002c730: 206e 6f74 2066 6978 7475 7265 5f70 6174   not fixture_pat
-0002c740: 682e 6578 6973 7473 2829 3a0a 2020 2020  h.exists():.    
-0002c750: 2020 2020 2020 2020 6669 7874 7572 655f          fixture_
-0002c760: 7061 7468 203d 2050 6174 6828 666f 6c64  path = Path(fold
-0002c770: 6572 2920 2f20 2264 6174 6173 6f75 7263  er) / "datasourc
-0002c780: 6573 2220 2f20 2266 6978 7475 7265 7322  es" / "fixtures"
-0002c790: 202f 2066 227b 6e61 6d65 7d2e 7061 7271   / f"{name}.parq
-0002c7a0: 7565 7422 0a20 2020 2020 2020 2069 6620  uet".        if 
-0002c7b0: 6669 7874 7572 655f 7061 7468 2e65 7869  fixture_path.exi
-0002c7c0: 7374 7328 293a 0a20 2020 2020 2020 2020  sts():.         
-0002c7d0: 2020 2023 204c 6574 2773 2076 616c 6964     # Let's valid
-0002c7e0: 6174 6520 6f6e 6c79 2077 6865 6e20 7768  ate only when wh
-0002c7f0: 656e 2077 6520 6172 6520 676f 696e 6720  en we are going 
-0002c800: 746f 2072 6570 6c61 6365 2074 6865 2061  to replace the a
-0002c810: 6374 7561 6c20 6461 7461 0a20 2020 2020  ctual data.     
-0002c820: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0002c830: 6177 6169 7420 636c 6965 6e74 2e71 7565  await client.que
-0002c840: 7279 2873 716c 3d66 2253 454c 4543 5420  ry(sql=f"SELECT 
-0002c850: 636f 756e 7428 2920 6173 2063 2046 524f  count() as c FRO
-0002c860: 4d20 7b64 6174 6173 6f75 7263 655f 6e61  M {datasource_na
-0002c870: 6d65 7d20 464f 524d 4154 204a 534f 4e22  me} FORMAT JSON"
-0002c880: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
-0002c890: 756e 7420 3d20 7265 7375 6c74 5b22 6461  unt = result["da
-0002c8a0: 7461 225d 5b30 5d5b 2263 225d 0a0a 2020  ta"][0]["c"]..  
-0002c8b0: 2020 2020 2020 2020 2020 6966 2063 6f75            if cou
-0002c8c0: 6e74 203e 2030 2061 6e64 206e 6f74 2066  nt > 0 and not f
-0002c8d0: 6f72 6365 3a0a 2020 2020 2020 2020 2020  orce:.          
-0002c8e0: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
-0002c8f0: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
-0002c900: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002c910: 2020 2020 2020 4665 6564 6261 636b 4d61        FeedbackMa
-0002c920: 6e61 6765 722e 6572 726f 725f 7075 7368  nager.error_push
-0002c930: 5f66 6978 7475 7265 5f77 696c 6c5f 7265  _fixture_will_re
-0002c940: 706c 6163 655f 6461 7461 2864 6174 6173  place_data(datas
-0002c950: 6f75 7263 653d 6461 7461 736f 7572 6365  ource=datasource
-0002c960: 5f6e 616d 6529 0a20 2020 2020 2020 2020  _name).         
-0002c970: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0002c980: 2020 2020 2020 636c 6963 6b2e 6563 686f        click.echo
-0002c990: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002c9a0: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
-0002c9b0: 722e 696e 666f 5f63 6865 636b 696e 675f  r.info_checking_
-0002c9c0: 6669 6c65 5f73 697a 6528 0a20 2020 2020  file_size(.     
-0002c9d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002c9e0: 696c 656e 616d 653d 7265 736f 7572 6365  ilename=resource
-0002c9f0: 5b22 6669 6c65 6e61 6d65 225d 2c20 7369  ["filename"], si
-0002ca00: 7a65 3d73 697a 656f 665f 666d 7428 6f73  ze=sizeof_fmt(os
-0002ca10: 2e73 7461 7428 6669 7874 7572 655f 7061  .stat(fixture_pa
-0002ca20: 7468 292e 7374 5f73 697a 6529 0a20 2020  th).st_size).   
-0002ca30: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0002ca40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0002ca50: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
-0002ca60: 6f75 742e 666c 7573 6828 290a 2020 2020  out.flush().    
-0002ca70: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002ca80: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-0002ca90: 6974 2063 6c69 656e 742e 6461 7461 736f  it client.dataso
-0002caa0: 7572 6365 5f61 7070 656e 645f 6461 7461  urce_append_data
-0002cab0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002cac0: 2020 2020 2020 6461 7461 736f 7572 6365        datasource
-0002cad0: 5f6e 616d 653d 7265 736f 7572 6365 5b22  _name=resource["
-0002cae0: 7061 7261 6d73 225d 5b22 6e61 6d65 225d  params"]["name"]
-0002caf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002cb00: 2020 2020 2020 6669 6c65 3d66 6978 7475        file=fixtu
-0002cb10: 7265 5f70 6174 682c 0a20 2020 2020 2020  re_path,.       
-0002cb20: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0002cb30: 653d 6d6f 6465 2c0a 2020 2020 2020 2020  e=mode,.        
-0002cb40: 2020 2020 2020 2020 2020 2020 666f 726d              form
-0002cb50: 6174 3d66 6978 7475 7265 5f70 6174 682e  at=fixture_path.
-0002cb60: 7375 6666 6978 5b31 3a5d 2c0a 2020 2020  suffix[1:],.    
-0002cb70: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002cb80: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-0002cb90: 6963 6b2e 6563 686f 2846 6565 6462 6163  ick.echo(Feedbac
-0002cba0: 6b4d 616e 6167 6572 2e73 7563 6365 7373  kManager.success
-0002cbb0: 5f70 726f 6365 7373 696e 675f 6461 7461  _processing_data
-0002cbc0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-0002cbd0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0002cbe0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0002cbf0: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
-0002cc00: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
-0002cc10: 6e28 4665 6564 6261 636b 4d61 6e61 6765  n(FeedbackManage
-0002cc20: 722e 6572 726f 725f 7072 6f63 6573 7369  r.error_processi
-0002cc30: 6e67 5f62 6c6f 636b 7328 6572 726f 723d  ng_blocks(error=
-0002cc40: 6529 290a 0a20 2020 2020 2020 2065 6c73  e))..        els
-0002cc50: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-0002cc60: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
-0002cc70: 636b 4d61 6e61 6765 722e 7761 726e 696e  ckManager.warnin
-0002cc80: 675f 6669 7874 7572 655f 6e6f 745f 666f  g_fixture_not_fo
-0002cc90: 756e 6428 6461 7461 736f 7572 6365 5f6e  und(datasource_n
-0002cca0: 616d 653d 6e61 6d65 2929 0a20 2020 2065  ame=name)).    e
-0002ccb0: 6c73 653a 0a20 2020 2020 2020 2072 6169  lse:.        rai
-0002ccc0: 7365 2063 6c69 636b 2e43 6c69 636b 4578  se click.ClickEx
-0002ccd0: 6365 7074 696f 6e28 4665 6564 6261 636b  ception(Feedback
-0002cce0: 4d61 6e61 6765 722e 6572 726f 725f 756e  Manager.error_un
-0002ccf0: 6b6e 6f77 6e5f 7265 736f 7572 6365 2872  known_resource(r
-0002cd00: 6573 6f75 7263 653d 7265 736f 7572 6365  esource=resource
-0002cd10: 5b22 7265 736f 7572 6365 225d 2929 0a0a  ["resource"]))..
-0002cd20: 0a44 4154 4146 494c 455f 4e45 575f 4c49  .DATAFILE_NEW_LI
-0002cd30: 4e45 203d 2022 5c6e 220a 4441 5441 4649  NE = "\n".DATAFI
-0002cd40: 4c45 5f49 4e44 454e 5420 3d20 2220 2220  LE_INDENT = " " 
-0002cd50: 2a20 340a 0a0a 6465 6620 666f 726d 6174  * 4...def format
-0002cd60: 5f73 6368 656d 6128 6669 6c65 5f70 6172  _schema(file_par
-0002cd70: 7473 3a20 4c69 7374 5b73 7472 5d2c 206e  ts: List[str], n
-0002cd80: 6f64 653a 2044 6963 745b 7374 722c 2041  ode: Dict[str, A
-0002cd90: 6e79 5d29 202d 3e20 4c69 7374 5b73 7472  ny]) -> List[str
-0002cda0: 5d3a 0a20 2020 2069 6620 2273 6368 656d  ]:.    if "schem
-0002cdb0: 6122 2069 6e20 6e6f 6465 2061 6e64 206e  a" in node and n
-0002cdc0: 6f64 655b 2273 6368 656d 6122 5d3a 0a20  ode["schema"]:. 
-0002cdd0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002cde0: 732e 6170 7065 6e64 2822 5343 4845 4d41  s.append("SCHEMA
-0002cdf0: 203e 2229 0a20 2020 2020 2020 2066 696c   >").        fil
-0002ce00: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
-0002ce10: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
-0002ce20: 290a 2020 2020 2020 2020 636f 6c75 6d6e  ).        column
-0002ce30: 7320 3d20 7363 6865 6d61 5f74 6f5f 7371  s = schema_to_sq
-0002ce40: 6c5f 636f 6c75 6d6e 7328 6e6f 6465 5b22  l_columns(node["
-0002ce50: 636f 6c75 6d6e 7322 5d29 0a20 2020 2020  columns"]).     
-0002ce60: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
-0002ce70: 7065 6e64 2866 222c 7b44 4154 4146 494c  pend(f",{DATAFIL
-0002ce80: 455f 4e45 575f 4c49 4e45 7d22 2e6a 6f69  E_NEW_LINE}".joi
-0002ce90: 6e28 6d61 7028 6c61 6d62 6461 2078 3a20  n(map(lambda x: 
-0002cea0: 6622 2020 2020 7b78 7d22 2c20 636f 6c75  f"    {x}", colu
-0002ceb0: 6d6e 7329 2929 0a20 2020 2020 2020 2066  mns))).        f
-0002cec0: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002ced0: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002cee0: 4e45 290a 2020 2020 2020 2020 6669 6c65  NE).        file
-0002cef0: 5f70 6172 7473 2e61 7070 656e 6428 4441  _parts.append(DA
-0002cf00: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
-0002cf10: 0a0a 2020 2020 7265 7475 726e 2066 696c  ..    return fil
-0002cf20: 655f 7061 7274 730a 0a0a 6465 6620 666f  e_parts...def fo
-0002cf30: 726d 6174 5f69 6e64 6963 6573 2866 696c  rmat_indices(fil
-0002cf40: 655f 7061 7274 733a 204c 6973 745b 7374  e_parts: List[st
-0002cf50: 725d 2c20 6e6f 6465 3a20 4469 6374 5b73  r], node: Dict[s
-0002cf60: 7472 2c20 416e 795d 2920 2d3e 204c 6973  tr, Any]) -> Lis
-0002cf70: 745b 7374 725d 3a0a 2020 2020 6966 2022  t[str]:.    if "
-0002cf80: 696e 6465 7865 7322 2069 6e20 6e6f 6465  indexes" in node
-0002cf90: 2061 6e64 206e 6f64 655b 2269 6e64 6578   and node["index
-0002cfa0: 6573 225d 3a0a 2020 2020 2020 2020 696e  es"]:.        in
-0002cfb0: 6465 7865 7320 3d20 6e6f 6465 5b22 696e  dexes = node["in
-0002cfc0: 6465 7865 7322 5d0a 2020 2020 2020 2020  dexes"].        
-0002cfd0: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
-0002cfe0: 6428 2249 4e44 4558 4553 203e 2229 0a20  d("INDEXES >"). 
-0002cff0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002d000: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
-0002d010: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
-0002d020: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-0002d030: 7070 656e 6428 6622 7b44 4154 4146 494c  ppend(f"{DATAFIL
-0002d040: 455f 4e45 575f 4c49 4e45 7d22 2e6a 6f69  E_NEW_LINE}".joi
-0002d050: 6e28 6d61 7028 6c61 6d62 6461 2069 6e64  n(map(lambda ind
-0002d060: 6578 3a20 6622 2020 2020 7b69 6e64 6578  ex: f"    {index
-0002d070: 2e74 6f5f 6461 7461 6669 6c65 2829 7d22  .to_datafile()}"
-0002d080: 2c20 696e 6465 7865 7329 2929 0a20 2020  , indexes))).   
-0002d090: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
-0002d0a0: 6170 7065 6e64 2844 4154 4146 494c 455f  append(DATAFILE_
-0002d0b0: 4e45 575f 4c49 4e45 290a 2020 2020 2020  NEW_LINE).      
-0002d0c0: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002d0d0: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
-0002d0e0: 5f4c 494e 4529 0a0a 2020 2020 7265 7475  _LINE)..    retu
-0002d0f0: 726e 2066 696c 655f 7061 7274 730a 0a0a  rn file_parts...
-0002d100: 6465 6620 666f 726d 6174 5f64 6174 615f  def format_data_
-0002d110: 636f 6e6e 6563 746f 7228 6669 6c65 5f70  connector(file_p
-0002d120: 6172 7473 3a20 4c69 7374 5b73 7472 5d2c  arts: List[str],
-0002d130: 206e 6f64 653a 2044 6963 745b 7374 722c   node: Dict[str,
-0002d140: 2041 6e79 5d29 202d 3e20 4c69 7374 5b73   Any]) -> List[s
-0002d150: 7472 5d3a 0a20 2020 206c 6c20 3d20 6c65  tr]:.    ll = le
-0002d160: 6e28 6669 6c65 5f70 6172 7473 290a 2020  n(file_parts).  
-0002d170: 2020 7175 6f74 6573 203d 2022 2727 220a    quotes = "''".
-0002d180: 2020 2020 5b66 696c 655f 7061 7274 732e      [file_parts.
-0002d190: 6170 7065 6e64 2866 227b 6b2e 7570 7065  append(f"{k.uppe
-0002d1a0: 7228 297d 207b 7620 6f72 2071 756f 7465  r()} {v or quote
-0002d1b0: 737d 7b44 4154 4146 494c 455f 4e45 575f  s}{DATAFILE_NEW_
-0002d1c0: 4c49 4e45 7d22 2920 666f 7220 6b2c 2076  LINE}") for k, v
-0002d1d0: 2069 6e20 6e6f 6465 2e69 7465 6d73 2829   in node.items()
-0002d1e0: 2069 6620 226b 6166 6b61 2220 696e 206b   if "kafka" in k
-0002d1f0: 5d20 2023 2074 7970 653a 2069 676e 6f72  ]  # type: ignor
-0002d200: 650a 2020 2020 6966 206c 6c20 3c20 6c65  e.    if ll < le
-0002d210: 6e28 6669 6c65 5f70 6172 7473 293a 0a20  n(file_parts):. 
-0002d220: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002d230: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
-0002d240: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
-0002d250: 7265 7475 726e 2066 696c 655f 7061 7274  return file_part
-0002d260: 730a 0a0a 6465 6620 666f 726d 6174 5f69  s...def format_i
-0002d270: 6d70 6f72 745f 7365 7474 696e 6773 2866  mport_settings(f
-0002d280: 696c 655f 7061 7274 733a 204c 6973 745b  ile_parts: List[
-0002d290: 7374 725d 2c20 6e6f 6465 3a20 4469 6374  str], node: Dict
-0002d2a0: 5b73 7472 2c20 416e 795d 2920 2d3e 204c  [str, Any]) -> L
-0002d2b0: 6973 745b 7374 725d 3a0a 2020 2020 6c6c  ist[str]:.    ll
-0002d2c0: 203d 206c 656e 2866 696c 655f 7061 7274   = len(file_part
-0002d2d0: 7329 0a20 2020 205b 6669 6c65 5f70 6172  s).    [file_par
-0002d2e0: 7473 2e61 7070 656e 6428 6622 7b6b 2e75  ts.append(f"{k.u
-0002d2f0: 7070 6572 2829 7d20 7b76 7d7b 4441 5441  pper()} {v}{DATA
-0002d300: 4649 4c45 5f4e 4557 5f4c 494e 457d 2229  FILE_NEW_LINE}")
-0002d310: 2066 6f72 206b 2c20 7620 696e 206e 6f64   for k, v in nod
-0002d320: 652e 6974 656d 7328 2920 6966 2022 696d  e.items() if "im
-0002d330: 706f 7274 5f22 2069 6e20 6b5d 2020 2320  port_" in k]  # 
-0002d340: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-0002d350: 2069 6620 6c6c 203c 206c 656e 2866 696c   if ll < len(fil
-0002d360: 655f 7061 7274 7329 3a0a 2020 2020 2020  e_parts):.      
-0002d370: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002d380: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
-0002d390: 5f4c 494e 4529 0a20 2020 2072 6574 7572  _LINE).    retur
-0002d3a0: 6e20 6669 6c65 5f70 6172 7473 0a0a 0a64  n file_parts...d
-0002d3b0: 6566 2066 6f72 6d61 745f 696e 636c 7564  ef format_includ
-0002d3c0: 6528 6669 6c65 5f70 6172 7473 3a20 4c69  e(file_parts: Li
-0002d3d0: 7374 5b73 7472 5d2c 2064 6f63 3a20 4461  st[str], doc: Da
-0002d3e0: 7461 6669 6c65 2c20 756e 726f 6c6c 5f69  tafile, unroll_i
-0002d3f0: 6e63 6c75 6465 733a 2062 6f6f 6c20 3d20  ncludes: bool = 
-0002d400: 4661 6c73 6529 202d 3e20 4c69 7374 5b73  False) -> List[s
-0002d410: 7472 5d3a 0a20 2020 2069 6620 756e 726f  tr]:.    if unro
-0002d420: 6c6c 5f69 6e63 6c75 6465 733a 0a20 2020  ll_includes:.   
-0002d430: 2020 2020 2072 6574 7572 6e20 6669 6c65       return file
-0002d440: 5f70 6172 7473 0a0a 2020 2020 6173 7365  _parts..    asse
-0002d450: 7274 2064 6f63 2e72 6177 2069 7320 6e6f  rt doc.raw is no
-0002d460: 7420 4e6f 6e65 0a0a 2020 2020 696e 636c  t None..    incl
-0002d470: 7564 6520 3d20 5b6c 696e 6520 666f 7220  ude = [line for 
-0002d480: 6c69 6e65 2069 6e20 646f 632e 7261 7720  line in doc.raw 
-0002d490: 6966 2022 494e 434c 5544 4522 2069 6e20  if "INCLUDE" in 
-0002d4a0: 6c69 6e65 2061 6e64 2022 2e69 6e63 6c22  line and ".incl"
-0002d4b0: 2069 6e20 6c69 6e65 5d0a 2020 2020 6966   in line].    if
-0002d4c0: 206c 656e 2869 6e63 6c75 6465 293a 0a20   len(include):. 
-0002d4d0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002d4e0: 732e 6170 7065 6e64 2869 6e63 6c75 6465  s.append(include
-0002d4f0: 5b30 5d29 0a20 2020 2020 2020 2066 696c  [0]).        fil
-0002d500: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
-0002d510: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
-0002d520: 290a 2020 2020 7265 7475 726e 2066 696c  ).    return fil
-0002d530: 655f 7061 7274 730a 0a0a 6173 796e 6320  e_parts...async 
-0002d540: 6465 6620 666f 726d 6174 5f64 6174 6173  def format_datas
-0002d550: 6f75 7263 6528 0a20 2020 2066 696c 656e  ource(.    filen
-0002d560: 616d 653a 2073 7472 2c0a 2020 2020 756e  ame: str,.    un
-0002d570: 726f 6c6c 5f69 6e63 6c75 6465 733a 2062  roll_includes: b
-0002d580: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-0002d590: 2066 6f72 5f64 6966 663a 2062 6f6f 6c20   for_diff: bool 
-0002d5a0: 3d20 4661 6c73 652c 0a20 2020 2063 6c69  = False,.    cli
-0002d5b0: 656e 743a 204f 7074 696f 6e61 6c5b 5469  ent: Optional[Ti
-0002d5c0: 6e79 425d 203d 204e 6f6e 652c 0a20 2020  nyB] = None,.   
-0002d5d0: 2072 6570 6c61 6365 5f69 6e63 6c75 6465   replace_include
-0002d5e0: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-0002d5f0: 0a20 2020 2064 6174 6166 696c 653a 204f  .    datafile: O
-0002d600: 7074 696f 6e61 6c5b 4461 7461 6669 6c65  ptional[Datafile
-0002d610: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 666f  ] = None,.    fo
-0002d620: 725f 6465 706c 6f79 5f64 6966 663a 2062  r_deploy_diff: b
-0002d630: 6f6f 6c20 3d20 4661 6c73 652c 0a29 202d  ool = False,.) -
-0002d640: 3e20 7374 723a 0a20 2020 2069 6620 6461  > str:.    if da
-0002d650: 7461 6669 6c65 3a0a 2020 2020 2020 2020  tafile:.        
-0002d660: 646f 6320 3d20 6461 7461 6669 6c65 0a20  doc = datafile. 
-0002d670: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002d680: 2064 6f63 203d 2070 6172 7365 5f64 6174   doc = parse_dat
-0002d690: 6173 6f75 7263 6528 6669 6c65 6e61 6d65  asource(filename
-0002d6a0: 2c20 7265 706c 6163 655f 696e 636c 7564  , replace_includ
-0002d6b0: 6573 3d72 6570 6c61 6365 5f69 6e63 6c75  es=replace_inclu
-0002d6c0: 6465 7329 0a0a 2020 2020 6669 6c65 5f70  des)..    file_p
-0002d6d0: 6172 7473 3a20 4c69 7374 5b73 7472 5d20  arts: List[str] 
-0002d6e0: 3d20 5b5d 0a20 2020 2069 6620 666f 725f  = [].    if for_
-0002d6f0: 6469 6666 3a0a 2020 2020 2020 2020 6973  diff:.        is
-0002d700: 5f6b 6166 6b61 203d 2022 6b61 666b 615f  _kafka = "kafka_
-0002d710: 636f 6e6e 6563 7469 6f6e 5f6e 616d 6522  connection_name"
-0002d720: 2069 6e20 646f 632e 6e6f 6465 735b 305d   in doc.nodes[0]
-0002d730: 0a20 2020 2020 2020 2069 6620 6973 5f6b  .        if is_k
-0002d740: 6166 6b61 3a0a 2020 2020 2020 2020 2020  afka:.          
-0002d750: 2020 6b61 666b 615f 6d65 7461 6461 7461    kafka_metadata
-0002d760: 5f63 6f6c 756d 6e73 203d 205b 0a20 2020  _columns = [.   
-0002d770: 2020 2020 2020 2020 2020 2020 2022 5f5f               "__
-0002d780: 7661 6c75 6522 2c0a 2020 2020 2020 2020  value",.        
-0002d790: 2020 2020 2020 2020 225f 5f68 6561 6465          "__heade
-0002d7a0: 7273 222c 0a20 2020 2020 2020 2020 2020  rs",.           
-0002d7b0: 2020 2020 2022 5f5f 746f 7069 6322 2c0a       "__topic",.
-0002d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d7d0: 225f 5f70 6172 7469 7469 6f6e 222c 0a20  "__partition",. 
-0002d7e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002d7f0: 5f5f 6f66 6673 6574 222c 0a20 2020 2020  __offset",.     
-0002d800: 2020 2020 2020 2020 2020 2022 5f5f 7469             "__ti
-0002d810: 6d65 7374 616d 7022 2c0a 2020 2020 2020  mestamp",.      
-0002d820: 2020 2020 2020 2020 2020 225f 5f6b 6579            "__key
-0002d830: 222c 0a20 2020 2020 2020 2020 2020 205d  ",.            ]
-0002d840: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
-0002d850: 756d 6e73 203d 205b 6320 666f 7220 6320  umns = [c for c 
-0002d860: 696e 2064 6f63 2e6e 6f64 6573 5b30 5d5b  in doc.nodes[0][
-0002d870: 2263 6f6c 756d 6e73 225d 2069 6620 635b  "columns"] if c[
-0002d880: 226e 616d 6522 5d20 6e6f 7420 696e 206b  "name"] not in k
-0002d890: 6166 6b61 5f6d 6574 6164 6174 615f 636f  afka_metadata_co
-0002d8a0: 6c75 6d6e 735d 0a20 2020 2020 2020 2020  lumns].         
-0002d8b0: 2020 2064 6f63 2e6e 6f64 6573 5b30 5d2e     doc.nodes[0].
-0002d8c0: 7570 6461 7465 280a 2020 2020 2020 2020  update(.        
-0002d8d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0002d8e0: 2020 2020 2020 2020 2020 2020 2020 2263                "c
-0002d8f0: 6f6c 756d 6e73 223a 2063 6f6c 756d 6e73  olumns": columns
-0002d900: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002d910: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0002d920: 290a 2020 2020 2020 2020 666f 726d 6174  ).        format
-0002d930: 5f76 6572 7369 6f6e 2866 696c 655f 7061  _version(file_pa
-0002d940: 7274 732c 2064 6f63 290a 2020 2020 2020  rts, doc).      
-0002d950: 2020 6966 2066 6f72 5f64 6570 6c6f 795f    if for_deploy_
-0002d960: 6469 6666 3a0a 2020 2020 2020 2020 2020  diff:.          
-0002d970: 2020 666f 726d 6174 5f64 6573 6372 6970    format_descrip
-0002d980: 7469 6f6e 2866 696c 655f 7061 7274 732c  tion(file_parts,
-0002d990: 2064 6f63 290a 2020 2020 2020 2020 666f   doc).        fo
-0002d9a0: 726d 6174 5f74 6f6b 656e 7328 6669 6c65  rmat_tokens(file
-0002d9b0: 5f70 6172 7473 2c20 646f 6329 0a20 2020  _parts, doc).   
-0002d9c0: 2020 2020 2066 6f72 6d61 745f 7363 6865       format_sche
-0002d9d0: 6d61 2866 696c 655f 7061 7274 732c 2064  ma(file_parts, d
-0002d9e0: 6f63 2e6e 6f64 6573 5b30 5d29 0a20 2020  oc.nodes[0]).   
-0002d9f0: 2020 2020 2066 6f72 6d61 745f 696e 6469       format_indi
-0002da00: 6365 7328 6669 6c65 5f70 6172 7473 2c20  ces(file_parts, 
-0002da10: 646f 632e 6e6f 6465 735b 305d 290a 2020  doc.nodes[0]).  
-0002da20: 2020 2020 2020 6177 6169 7420 666f 726d        await form
-0002da30: 6174 5f65 6e67 696e 6528 6669 6c65 5f70  at_engine(file_p
-0002da40: 6172 7473 2c20 646f 632e 6e6f 6465 735b  arts, doc.nodes[
-0002da50: 305d 2c20 6f6e 6c79 5f74 746c 3d54 7275  0], only_ttl=Tru
-0002da60: 6520 6966 206e 6f74 2066 6f72 5f64 6570  e if not for_dep
-0002da70: 6c6f 795f 6469 6666 2065 6c73 6520 4661  loy_diff else Fa
-0002da80: 6c73 652c 2063 6c69 656e 743d 636c 6965  lse, client=clie
-0002da90: 6e74 290a 2020 2020 2020 2020 6966 2066  nt).        if f
-0002daa0: 6f72 5f64 6570 6c6f 795f 6469 6666 3a0a  or_deploy_diff:.
-0002dab0: 2020 2020 2020 2020 2020 2020 666f 726d              form
-0002dac0: 6174 5f69 6d70 6f72 745f 7365 7474 696e  at_import_settin
-0002dad0: 6773 2866 696c 655f 7061 7274 732c 2064  gs(file_parts, d
-0002dae0: 6f63 2e6e 6f64 6573 5b30 5d29 0a20 2020  oc.nodes[0]).   
-0002daf0: 2020 2020 2066 6f72 6d61 745f 7368 6172       format_shar
-0002db00: 6564 5f77 6974 6828 6669 6c65 5f70 6172  ed_with(file_par
-0002db10: 7473 2c20 646f 6329 0a0a 2020 2020 656c  ts, doc)..    el
-0002db20: 7365 3a0a 2020 2020 2020 2020 666f 726d  se:.        form
-0002db30: 6174 5f73 6f75 7263 6573 2866 696c 655f  at_sources(file_
-0002db40: 7061 7274 732c 2064 6f63 290a 2020 2020  parts, doc).    
-0002db50: 2020 2020 666f 726d 6174 5f6d 6169 6e74      format_maint
-0002db60: 6169 6e65 7228 6669 6c65 5f70 6172 7473  ainer(file_parts
-0002db70: 2c20 646f 6329 0a20 2020 2020 2020 2066  , doc).        f
-0002db80: 6f72 6d61 745f 7665 7273 696f 6e28 6669  ormat_version(fi
-0002db90: 6c65 5f70 6172 7473 2c20 646f 6329 0a20  le_parts, doc). 
-0002dba0: 2020 2020 2020 2066 6f72 6d61 745f 6465         format_de
-0002dbb0: 7363 7269 7074 696f 6e28 6669 6c65 5f70  scription(file_p
-0002dbc0: 6172 7473 2c20 646f 6329 0a20 2020 2020  arts, doc).     
-0002dbd0: 2020 2066 6f72 6d61 745f 746f 6b65 6e73     format_tokens
-0002dbe0: 2866 696c 655f 7061 7274 732c 2064 6f63  (file_parts, doc
-0002dbf0: 290a 2020 2020 2020 2020 666f 726d 6174  ).        format
-0002dc00: 5f73 6368 656d 6128 6669 6c65 5f70 6172  _schema(file_par
-0002dc10: 7473 2c20 646f 632e 6e6f 6465 735b 305d  ts, doc.nodes[0]
-0002dc20: 290a 2020 2020 2020 2020 666f 726d 6174  ).        format
-0002dc30: 5f69 6e64 6963 6573 2866 696c 655f 7061  _indices(file_pa
-0002dc40: 7274 732c 2064 6f63 2e6e 6f64 6573 5b30  rts, doc.nodes[0
-0002dc50: 5d29 0a20 2020 2020 2020 2061 7761 6974  ]).        await
-0002dc60: 2066 6f72 6d61 745f 656e 6769 6e65 2866   format_engine(f
-0002dc70: 696c 655f 7061 7274 732c 2064 6f63 2e6e  ile_parts, doc.n
-0002dc80: 6f64 6573 5b30 5d29 0a20 2020 2020 2020  odes[0]).       
-0002dc90: 2066 6f72 6d61 745f 696e 636c 7564 6528   format_include(
-0002dca0: 6669 6c65 5f70 6172 7473 2c20 646f 632c  file_parts, doc,
-0002dcb0: 2075 6e72 6f6c 6c5f 696e 636c 7564 6573   unroll_includes
-0002dcc0: 3d75 6e72 6f6c 6c5f 696e 636c 7564 6573  =unroll_includes
-0002dcd0: 290a 2020 2020 2020 2020 666f 726d 6174  ).        format
-0002dce0: 5f64 6174 615f 636f 6e6e 6563 746f 7228  _data_connector(
-0002dcf0: 6669 6c65 5f70 6172 7473 2c20 646f 632e  file_parts, doc.
-0002dd00: 6e6f 6465 735b 305d 290a 2020 2020 2020  nodes[0]).      
-0002dd10: 2020 666f 726d 6174 5f69 6d70 6f72 745f    format_import_
-0002dd20: 7365 7474 696e 6773 2866 696c 655f 7061  settings(file_pa
-0002dd30: 7274 732c 2064 6f63 2e6e 6f64 6573 5b30  rts, doc.nodes[0
-0002dd40: 5d29 0a20 2020 2020 2020 2066 6f72 6d61  ]).        forma
-0002dd50: 745f 7368 6172 6564 5f77 6974 6828 6669  t_shared_with(fi
-0002dd60: 6c65 5f70 6172 7473 2c20 646f 6329 0a20  le_parts, doc). 
-0002dd70: 2020 2072 6573 756c 7420 3d20 2222 2e6a     result = "".j
-0002dd80: 6f69 6e28 6669 6c65 5f70 6172 7473 290a  oin(file_parts).
-0002dd90: 2020 2020 7265 7375 6c74 203d 2072 6573      result = res
-0002dda0: 756c 742e 7273 7472 6970 2822 5c6e 2229  ult.rstrip("\n")
-0002ddb0: 202b 2022 5c6e 220a 2020 2020 7265 7475   + "\n".    retu
-0002ddc0: 726e 2072 6573 756c 740a 0a0a 6465 6620  rn result...def 
-0002ddd0: 666f 726d 6174 5f76 6572 7369 6f6e 2866  format_version(f
-0002dde0: 696c 655f 7061 7274 733a 204c 6973 745b  ile_parts: List[
-0002ddf0: 7374 725d 2c20 646f 633a 2044 6174 6166  str], doc: Dataf
-0002de00: 696c 6529 202d 3e20 4c69 7374 5b73 7472  ile) -> List[str
-0002de10: 5d3a 0a20 2020 2076 6572 7369 6f6e 203d  ]:.    version =
-0002de20: 2064 6f63 2e76 6572 7369 6f6e 2069 6620   doc.version if 
-0002de30: 646f 632e 7665 7273 696f 6e20 6973 206e  doc.version is n
-0002de40: 6f74 204e 6f6e 6520 656c 7365 2022 220a  ot None else "".
-0002de50: 2020 2020 6966 2076 6572 7369 6f6e 2021      if version !
-0002de60: 3d20 2222 3a0a 2020 2020 2020 2020 6669  = "":.        fi
-0002de70: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
-0002de80: 6622 5645 5253 494f 4e20 7b76 6572 7369  f"VERSION {versi
-0002de90: 6f6e 7d22 290a 2020 2020 2020 2020 6669  on}").        fi
-0002dea0: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
-0002deb0: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
-0002dec0: 4529 0a20 2020 2020 2020 2066 696c 655f  E).        file_
-0002ded0: 7061 7274 732e 6170 7065 6e64 2844 4154  parts.append(DAT
-0002dee0: 4146 494c 455f 4e45 575f 4c49 4e45 290a  AFILE_NEW_LINE).
-0002def0: 2020 2020 7265 7475 726e 2066 696c 655f      return file_
-0002df00: 7061 7274 730a 0a0a 6465 6620 666f 726d  parts...def form
-0002df10: 6174 5f6d 6169 6e74 6169 6e65 7228 6669  at_maintainer(fi
-0002df20: 6c65 5f70 6172 7473 3a20 4c69 7374 5b73  le_parts: List[s
-0002df30: 7472 5d2c 2064 6f63 3a20 4461 7461 6669  tr], doc: Datafi
-0002df40: 6c65 2920 2d3e 204c 6973 745b 7374 725d  le) -> List[str]
-0002df50: 3a0a 2020 2020 6d61 696e 7461 696e 6572  :.    maintainer
-0002df60: 203d 2064 6f63 2e6d 6169 6e74 6169 6e65   = doc.maintaine
-0002df70: 7220 6966 2064 6f63 2e6d 6169 6e74 6169  r if doc.maintai
-0002df80: 6e65 7220 6973 206e 6f74 204e 6f6e 6520  ner is not None 
-0002df90: 656c 7365 2022 220a 2020 2020 6966 206d  else "".    if m
-0002dfa0: 6169 6e74 6169 6e65 723a 0a20 2020 2020  aintainer:.     
-0002dfb0: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
-0002dfc0: 7065 6e64 2866 224d 4149 4e54 4149 4e45  pend(f"MAINTAINE
-0002dfd0: 5220 7b6d 6169 6e74 6169 6e65 727d 2229  R {maintainer}")
-0002dfe0: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-0002dff0: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
-0002e000: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
-0002e010: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
-0002e020: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
-0002e030: 5f4e 4557 5f4c 494e 4529 0a20 2020 2072  _NEW_LINE).    r
-0002e040: 6574 7572 6e20 6669 6c65 5f70 6172 7473  eturn file_parts
-0002e050: 0a0a 0a64 6566 2066 6f72 6d61 745f 736f  ...def format_so
-0002e060: 7572 6365 7328 6669 6c65 5f70 6172 7473  urces(file_parts
-0002e070: 3a20 4c69 7374 5b73 7472 5d2c 2064 6f63  : List[str], doc
-0002e080: 3a20 4461 7461 6669 6c65 2920 2d3e 204c  : Datafile) -> L
-0002e090: 6973 745b 7374 725d 3a0a 2020 2020 666f  ist[str]:.    fo
-0002e0a0: 7220 736f 7572 6365 2069 6e20 646f 632e  r source in doc.
-0002e0b0: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
-0002e0c0: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
-0002e0d0: 6e64 2866 2253 4f55 5243 4520 7b73 6f75  nd(f"SOURCE {sou
-0002e0e0: 7263 657d 2229 0a20 2020 2020 2020 2066  rce}").        f
-0002e0f0: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002e100: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002e110: 4e45 290a 2020 2020 7265 7475 726e 2066  NE).    return f
-0002e120: 696c 655f 7061 7274 730a 0a0a 6465 6620  ile_parts...def 
-0002e130: 666f 726d 6174 5f64 6573 6372 6970 7469  format_descripti
-0002e140: 6f6e 2866 696c 655f 7061 7274 733a 204c  on(file_parts: L
-0002e150: 6973 745b 7374 725d 2c20 646f 633a 2041  ist[str], doc: A
-0002e160: 6e79 2920 2d3e 204c 6973 745b 7374 725d  ny) -> List[str]
-0002e170: 3a0a 2020 2020 6465 7363 7269 7074 696f  :.    descriptio
-0002e180: 6e20 3d20 646f 632e 6465 7363 7269 7074  n = doc.descript
-0002e190: 696f 6e20 6966 2064 6f63 2e64 6573 6372  ion if doc.descr
-0002e1a0: 6970 7469 6f6e 2069 7320 6e6f 7420 4e6f  iption is not No
-0002e1b0: 6e65 2065 6c73 6520 2222 0a20 2020 2069  ne else "".    i
-0002e1c0: 6620 6465 7363 7269 7074 696f 6e3a 0a20  f description:. 
-0002e1d0: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002e1e0: 732e 6170 7065 6e64 2822 4445 5343 5249  s.append("DESCRI
-0002e1f0: 5054 494f 4e20 3e22 290a 2020 2020 2020  PTION >").      
-0002e200: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002e210: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
-0002e220: 5f4c 494e 4529 0a20 2020 2020 2020 205b  _LINE).        [
-0002e230: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
-0002e240: 6428 6622 7b44 4154 4146 494c 455f 494e  d(f"{DATAFILE_IN
-0002e250: 4445 4e54 7d7b 642e 7374 7269 7028 297d  DENT}{d.strip()}
-0002e260: 5c6e 2229 2066 6f72 2064 2069 6e20 6465  \n") for d in de
-0002e270: 7363 7269 7074 696f 6e2e 7370 6c69 7428  scription.split(
-0002e280: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
-0002e290: 4529 2069 6620 642e 7374 7269 7028 295d  E) if d.strip()]
-0002e2a0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-0002e2b0: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-0002e2c0: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
-0002e2d0: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
-0002e2e0: 2020 7265 7475 726e 2066 696c 655f 7061    return file_pa
-0002e2f0: 7274 730a 0a0a 6465 6620 666f 726d 6174  rts...def format
-0002e300: 5f74 6f6b 656e 7328 6669 6c65 5f70 6172  _tokens(file_par
-0002e310: 7473 3a20 4c69 7374 5b73 7472 5d2c 2064  ts: List[str], d
-0002e320: 6f63 3a20 4461 7461 6669 6c65 2920 2d3e  oc: Datafile) ->
-0002e330: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
-0002e340: 666f 7220 746f 6b65 6e20 696e 2064 6f63  for token in doc
-0002e350: 2e74 6f6b 656e 733a 0a20 2020 2020 2020  .tokens:.       
-0002e360: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
-0002e370: 6e64 2866 2754 4f4b 454e 2022 7b74 6f6b  nd(f'TOKEN "{tok
-0002e380: 656e 5b22 746f 6b65 6e5f 6e61 6d65 225d  en["token_name"]
-0002e390: 7d22 207b 746f 6b65 6e5b 2270 6572 6d69  }" {token["permi
-0002e3a0: 7373 696f 6e73 225d 7d27 290a 2020 2020  ssions"]}').    
-0002e3b0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-0002e3c0: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
-0002e3d0: 4557 5f4c 494e 4529 0a20 2020 2069 6620  EW_LINE).    if 
-0002e3e0: 6c65 6e28 646f 632e 746f 6b65 6e73 293a  len(doc.tokens):
-0002e3f0: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-0002e400: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
-0002e410: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
-0002e420: 2020 7265 7475 726e 2066 696c 655f 7061    return file_pa
-0002e430: 7274 730a 0a0a 6465 6620 666f 726d 6174  rts...def format
-0002e440: 5f6e 6f64 655f 7371 6c28 0a20 2020 2066  _node_sql(.    f
-0002e450: 696c 655f 7061 7274 733a 204c 6973 745b  ile_parts: List[
-0002e460: 7374 725d 2c20 6e6f 6465 3a20 4469 6374  str], node: Dict
-0002e470: 5b73 7472 2c20 416e 795d 2c20 6c69 6e65  [str, Any], line
-0002e480: 5f6c 656e 6774 683a 204f 7074 696f 6e61  _length: Optiona
-0002e490: 6c5b 696e 745d 203d 204e 6f6e 652c 206c  l[int] = None, l
-0002e4a0: 6f77 6572 5f6b 6579 776f 7264 733a 2062  ower_keywords: b
-0002e4b0: 6f6f 6c20 3d20 4661 6c73 650a 2920 2d3e  ool = False.) ->
-0002e4c0: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
-0002e4d0: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
-0002e4e0: 6428 2253 514c 203e 2229 0a20 2020 2066  d("SQL >").    f
-0002e4f0: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002e500: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002e510: 4e45 290a 2020 2020 6669 6c65 5f70 6172  NE).    file_par
-0002e520: 7473 2e61 7070 656e 6428 666f 726d 6174  ts.append(format
-0002e530: 5f73 716c 286e 6f64 655b 2273 716c 225d  _sql(node["sql"]
-0002e540: 2c20 4441 5441 4649 4c45 5f49 4e44 454e  , DATAFILE_INDEN
-0002e550: 542c 206c 696e 655f 6c65 6e67 7468 3d6c  T, line_length=l
-0002e560: 696e 655f 6c65 6e67 7468 2c20 6c6f 7765  ine_length, lowe
-0002e570: 725f 6b65 7977 6f72 6473 3d6c 6f77 6572  r_keywords=lower
-0002e580: 5f6b 6579 776f 7264 7329 290a 2020 2020  _keywords)).    
-0002e590: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
-0002e5a0: 6428 4441 5441 4649 4c45 5f4e 4557 5f4c  d(DATAFILE_NEW_L
-0002e5b0: 494e 4529 0a20 2020 2066 696c 655f 7061  INE).    file_pa
-0002e5c0: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
-0002e5d0: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
-0002e5e0: 2020 7265 7475 726e 2066 696c 655f 7061    return file_pa
-0002e5f0: 7274 730a 0a0a 6465 6620 666f 726d 6174  rts...def format
-0002e600: 5f73 6861 7265 645f 7769 7468 2866 696c  _shared_with(fil
-0002e610: 655f 7061 7274 733a 204c 6973 745b 7374  e_parts: List[st
-0002e620: 725d 2c20 646f 633a 2044 6174 6166 696c  r], doc: Datafil
-0002e630: 6529 202d 3e20 4c69 7374 5b73 7472 5d3a  e) -> List[str]:
-0002e640: 0a20 2020 2069 6620 646f 632e 7368 6172  .    if doc.shar
-0002e650: 6564 5f77 6974 683a 0a20 2020 2020 2020  ed_with:.       
-0002e660: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
-0002e670: 6e64 2822 5348 4152 4544 5f57 4954 4820  nd("SHARED_WITH 
-0002e680: 3e22 290a 2020 2020 2020 2020 6669 6c65  >").        file
-0002e690: 5f70 6172 7473 2e61 7070 656e 6428 4441  _parts.append(DA
-0002e6a0: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
-0002e6b0: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-0002e6c0: 7274 732e 6170 7065 6e64 2822 5c6e 222e  rts.append("\n".
-0002e6d0: 6a6f 696e 285b 6622 7b44 4154 4146 494c  join([f"{DATAFIL
-0002e6e0: 455f 494e 4445 4e54 7d7b 776f 726b 7370  E_INDENT}{worksp
-0002e6f0: 6163 655f 6e61 6d65 7d22 2066 6f72 2077  ace_name}" for w
-0002e700: 6f72 6b73 7061 6365 5f6e 616d 6520 696e  orkspace_name in
-0002e710: 2064 6f63 2e73 6861 7265 645f 7769 7468   doc.shared_with
-0002e720: 5d29 290a 2020 2020 7265 7475 726e 2066  ])).    return f
-0002e730: 696c 655f 7061 7274 730a 0a0a 6173 796e  ile_parts...asyn
-0002e740: 6320 6465 6620 666f 726d 6174 5f65 6e67  c def format_eng
-0002e750: 696e 6528 0a20 2020 2066 696c 655f 7061  ine(.    file_pa
-0002e760: 7274 733a 204c 6973 745b 7374 725d 2c20  rts: List[str], 
-0002e770: 6e6f 6465 3a20 4469 6374 5b73 7472 2c20  node: Dict[str, 
-0002e780: 416e 795d 2c20 6f6e 6c79 5f74 746c 3a20  Any], only_ttl: 
-0002e790: 626f 6f6c 203d 2046 616c 7365 2c20 636c  bool = False, cl
-0002e7a0: 6965 6e74 3a20 4f70 7469 6f6e 616c 5b54  ient: Optional[T
-0002e7b0: 696e 7942 5d20 3d20 4e6f 6e65 0a29 202d  inyB] = None.) -
-0002e7c0: 3e20 4c69 7374 5b73 7472 5d3a 0a20 2020  > List[str]:.   
-0002e7d0: 2069 6620 6f6e 6c79 5f74 746c 3a0a 2020   if only_ttl:.  
-0002e7e0: 2020 2020 2020 6966 206e 6f64 652e 6765        if node.ge
-0002e7f0: 7428 2265 6e67 696e 6522 2c20 4e6f 6e65  t("engine", None
-0002e800: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
-0002e810: 6f72 2061 7267 2069 6e20 736f 7274 6564  or arg in sorted
-0002e820: 286e 6f64 655b 2265 6e67 696e 6522 5d2e  (node["engine"].
-0002e830: 6765 7428 2261 7267 7322 2c20 5b5d 2929  get("args", []))
-0002e840: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002e850: 2020 6966 2061 7267 5b30 5d2e 7570 7065    if arg[0].uppe
-0002e860: 7228 2920 3d3d 2022 5454 4c22 3a0a 2020  r() == "TTL":.  
-0002e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e880: 2020 656c 656d 203d 2022 2c20 222e 6a6f    elem = ", ".jo
-0002e890: 696e 285b 782e 7374 7269 7028 2920 666f  in([x.strip() fo
-0002e8a0: 7220 7820 696e 2061 7267 5b31 5d2e 7370  r x in arg[1].sp
-0002e8b0: 6c69 7428 222c 2229 5d29 0a20 2020 2020  lit(",")]).     
-0002e8c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002e8d0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0002e8e0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0002e8f0: 6c69 656e 743a 0a20 2020 2020 2020 2020  lient:.         
-0002e900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e910: 2020 2074 746c 5f73 716c 203d 2061 7761     ttl_sql = awa
-0002e920: 6974 2063 6c69 656e 742e 7371 6c5f 6765  it client.sql_ge
-0002e930: 745f 666f 726d 6174 2866 2273 656c 6563  t_format(f"selec
-0002e940: 7420 7b65 6c65 6d7d 222c 2077 6974 685f  t {elem}", with_
-0002e950: 636c 6963 6b68 6f75 7365 5f66 6f72 6d61  clickhouse_forma
-0002e960: 743d 5472 7565 290a 2020 2020 2020 2020  t=True).        
-0002e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e980: 2020 2020 666f 726d 6174 7465 645f 7474      formatted_tt
-0002e990: 6c20 3d20 7474 6c5f 7371 6c5b 373a 5d0a  l = ttl_sql[7:].
-0002e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e9b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e9d0: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0002e9e0: 7465 645f 7474 6c20 3d20 656c 656d 0a20  ted_ttl = elem. 
-0002e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ea00: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0002ea10: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-0002ea20: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0002ea30: 6d61 7474 6564 5f74 746c 203d 2065 6c65  matted_ttl = ele
-0002ea40: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
-0002ea50: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
-0002ea60: 2e61 7070 656e 6428 6622 454e 4749 4e45  .append(f"ENGINE
-0002ea70: 5f7b 6172 675b 305d 2e75 7070 6572 2829  _{arg[0].upper()
-0002ea80: 7d20 7b66 6f72 6d61 7474 6564 5f74 746c  } {formatted_ttl
-0002ea90: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
-0002eaa0: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
-0002eab0: 7473 2e61 7070 656e 6428 4441 5441 4649  ts.append(DATAFI
-0002eac0: 4c45 5f4e 4557 5f4c 494e 4529 0a20 2020  LE_NEW_LINE).   
-0002ead0: 2020 2020 2020 2020 2066 696c 655f 7061           file_pa
-0002eae0: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
-0002eaf0: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
-0002eb00: 2020 2020 2020 7265 7475 726e 2066 696c        return fil
-0002eb10: 655f 7061 7274 730a 2020 2020 656c 7365  e_parts.    else
-0002eb20: 3a0a 2020 2020 2020 2020 6966 206e 6f64  :.        if nod
-0002eb30: 652e 6765 7428 2265 6e67 696e 6522 2c20  e.get("engine", 
-0002eb40: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
-0002eb50: 2020 2065 6d70 7479 203d 2027 2222 270a     empty = '""'.
-0002eb60: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-0002eb70: 5f70 6172 7473 2e61 7070 656e 6428 6627  _parts.append(f'
-0002eb80: 454e 4749 4e45 207b 6e6f 6465 5b22 656e  ENGINE {node["en
-0002eb90: 6769 6e65 225d 5b22 7479 7065 225d 7d27  gine"]["type"]}'
-0002eba0: 2069 6620 6e6f 6465 2e67 6574 2822 656e   if node.get("en
-0002ebb0: 6769 6e65 222c 207b 7d29 2e67 6574 2822  gine", {}).get("
-0002ebc0: 7479 7065 2229 2065 6c73 6520 656d 7074  type") else empt
-0002ebd0: 7929 0a20 2020 2020 2020 2020 2020 2066  y).            f
-0002ebe0: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
-0002ebf0: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
-0002ec00: 4e45 290a 2020 2020 2020 2020 2020 2020  NE).            
-0002ec10: 666f 7220 6172 6720 696e 2073 6f72 7465  for arg in sorte
-0002ec20: 6428 6e6f 6465 5b22 656e 6769 6e65 225d  d(node["engine"]
-0002ec30: 2e67 6574 2822 6172 6773 222c 205b 5d29  .get("args", [])
-0002ec40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002ec50: 2020 2065 6c65 6d20 3d20 222c 2022 2e6a     elem = ", ".j
-0002ec60: 6f69 6e28 5b78 2e73 7472 6970 2829 2066  oin([x.strip() f
-0002ec70: 6f72 2078 2069 6e20 6172 675b 315d 2e73  or x in arg[1].s
-0002ec80: 706c 6974 2822 2c22 295d 290a 2020 2020  plit(",")]).    
-0002ec90: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-0002eca0: 5f70 6172 7473 2e61 7070 656e 6428 6622  _parts.append(f"
-0002ecb0: 454e 4749 4e45 5f7b 6172 675b 305d 2e75  ENGINE_{arg[0].u
-0002ecc0: 7070 6572 2829 7d20 7b65 6c65 6d20 6966  pper()} {elem if
-0002ecd0: 2065 6c65 6d20 656c 7365 2065 6d70 7479   elem else empty
-0002ece0: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
-0002ecf0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-0002ed00: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
-0002ed10: 4557 5f4c 494e 4529 0a20 2020 2020 2020  EW_LINE).       
-0002ed20: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
-0002ed30: 6170 7065 6e64 2844 4154 4146 494c 455f  append(DATAFILE_
-0002ed40: 4e45 575f 4c49 4e45 290a 2020 2020 2020  NEW_LINE).      
-0002ed50: 2020 7265 7475 726e 2066 696c 655f 7061    return file_pa
-0002ed60: 7274 730a 0a0a 6173 796e 6320 6465 6620  rts...async def 
-0002ed70: 666f 726d 6174 5f6e 6f64 655f 7479 7065  format_node_type
-0002ed80: 2866 696c 655f 7061 7274 733a 204c 6973  (file_parts: Lis
-0002ed90: 745b 7374 725d 2c20 6e6f 6465 3a20 4469  t[str], node: Di
-0002eda0: 6374 5b73 7472 2c20 416e 795d 2920 2d3e  ct[str, Any]) ->
-0002edb0: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
-0002edc0: 6e6f 6465 5f74 7970 6520 3d20 6e6f 6465  node_type = node
-0002edd0: 2e67 6574 2822 7479 7065 222c 2022 2229  .get("type", "")
-0002ede0: 2e6c 6f77 6572 2829 0a20 2020 206e 6f64  .lower().    nod
-0002edf0: 655f 7479 7065 5f75 7070 6572 203d 2066  e_type_upper = f
-0002ee00: 2254 5950 4520 7b6e 6f64 655f 7479 7065  "TYPE {node_type
-0002ee10: 2e75 7070 6572 2829 7d22 0a0a 2020 2020  .upper()}"..    
-0002ee20: 2320 4d61 7465 7269 616c 697a 6564 2070  # Materialized p
-0002ee30: 6970 650a 2020 2020 6966 206e 6f64 655f  ipe.    if node_
-0002ee40: 7479 7065 203d 3d20 5069 7065 4e6f 6465  type == PipeNode
-0002ee50: 5479 7065 732e 4d41 5445 5249 414c 495a  Types.MATERIALIZ
-0002ee60: 4544 3a0a 2020 2020 2020 2020 6669 6c65  ED:.        file
-0002ee70: 5f70 6172 7473 2e61 7070 656e 6428 6e6f  _parts.append(no
-0002ee80: 6465 5f74 7970 655f 7570 7065 7229 0a20  de_type_upper). 
-0002ee90: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002eea0: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
-0002eeb0: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
-0002eec0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-0002eed0: 7070 656e 6428 6627 4441 5441 534f 5552  ppend(f'DATASOUR
-0002eee0: 4345 207b 6e6f 6465 5b22 6461 7461 736f  CE {node["dataso
-0002eef0: 7572 6365 225d 7d27 290a 2020 2020 2020  urce"]}').      
-0002ef00: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002ef10: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
-0002ef20: 5f4c 494e 4529 0a20 2020 2020 2020 2061  _LINE).        a
-0002ef30: 7761 6974 2066 6f72 6d61 745f 656e 6769  wait format_engi
-0002ef40: 6e65 2866 696c 655f 7061 7274 732c 206e  ne(file_parts, n
-0002ef50: 6f64 6529 0a0a 2020 2020 2320 436f 7079  ode)..    # Copy
-0002ef60: 2070 6970 650a 2020 2020 6966 206e 6f64   pipe.    if nod
-0002ef70: 655f 7479 7065 203d 3d20 5069 7065 4e6f  e_type == PipeNo
-0002ef80: 6465 5479 7065 732e 434f 5059 3a0a 2020  deTypes.COPY:.  
-0002ef90: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
-0002efa0: 2e61 7070 656e 6428 6e6f 6465 5f74 7970  .append(node_typ
-0002efb0: 655f 7570 7065 7229 0a20 2020 2020 2020  e_upper).       
-0002efc0: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
-0002efd0: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
-0002efe0: 4c49 4e45 290a 2020 2020 2020 2020 6669  LINE).        fi
-0002eff0: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
-0002f000: 6627 5441 5247 4554 5f44 4154 4153 4f55  f'TARGET_DATASOU
-0002f010: 5243 4520 7b6e 6f64 655b 2274 6172 6765  RCE {node["targe
-0002f020: 745f 6461 7461 736f 7572 6365 225d 7d27  t_datasource"]}'
-0002f030: 290a 2020 2020 2020 2020 6966 2043 6f70  ).        if Cop
-0002f040: 7950 6172 616d 6574 6572 732e 434f 5059  yParameters.COPY
-0002f050: 5f53 4348 4544 554c 4520 696e 206e 6f64  _SCHEDULE in nod
-0002f060: 6520 616e 6420 6e6f 6465 5b43 6f70 7950  e and node[CopyP
-0002f070: 6172 616d 6574 6572 732e 434f 5059 5f53  arameters.COPY_S
-0002f080: 4348 4544 554c 455d 3a0a 2020 2020 2020  CHEDULE]:.      
-0002f090: 2020 2020 2020 6973 5f6f 6e64 656d 616e        is_ondeman
-0002f0a0: 6420 3d20 6e6f 6465 5b43 6f70 7950 6172  d = node[CopyPar
-0002f0b0: 616d 6574 6572 732e 434f 5059 5f53 4348  ameters.COPY_SCH
-0002f0c0: 4544 554c 455d 2e6c 6f77 6572 2829 203d  EDULE].lower() =
-0002f0d0: 3d20 4f4e 5f44 454d 414e 440a 2020 2020  = ON_DEMAND.    
-0002f0e0: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
-0002f0f0: 7473 2e61 7070 656e 6428 4441 5441 4649  ts.append(DATAFI
-0002f100: 4c45 5f4e 4557 5f4c 494e 4529 0a20 2020  LE_NEW_LINE).   
-0002f110: 2020 2020 2020 2020 2066 696c 655f 7061           file_pa
-0002f120: 7274 732e 6170 7065 6e64 280a 2020 2020  rts.append(.    
-0002f130: 2020 2020 2020 2020 2020 2020 6622 7b43              f"{C
-0002f140: 6f70 7950 6172 616d 6574 6572 732e 434f  opyParameters.CO
-0002f150: 5059 5f53 4348 4544 554c 452e 7570 7065  PY_SCHEDULE.uppe
-0002f160: 7228 297d 207b 4f4e 5f44 454d 414e 4420  r()} {ON_DEMAND 
-0002f170: 6966 2069 735f 6f6e 6465 6d61 6e64 2065  if is_ondemand e
-0002f180: 6c73 6520 6e6f 6465 5b43 6f70 7950 6172  lse node[CopyPar
-0002f190: 616d 6574 6572 732e 434f 5059 5f53 4348  ameters.COPY_SCH
-0002f1a0: 4544 554c 455d 7d22 0a20 2020 2020 2020  EDULE]}".       
-0002f1b0: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
-0002f1c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002f1d0: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
-0002f1e0: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
-0002f1f0: 4c49 4e45 290a 2020 2020 2020 2020 2020  LINE).          
-0002f200: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002f210: 656e 6428 6622 7b43 6f70 7950 6172 616d  end(f"{CopyParam
+0002b0b0: 2061 7761 6974 2070 7573 6828 0a20 2020   await push(.   
+0002b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0d0: 2020 2020 206e 616d 652c 0a20 2020 2020       name,.     
+0002b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0f0: 2020 2072 6573 6f75 7263 6573 5f74 6f5f     resources_to_
+0002b100: 7275 6e5f 666f 726b 5f64 6f77 6e73 7472  run_fork_downstr
+0002b110: 6561 6d2c 0a20 2020 2020 2020 2020 2020  eam,.           
+0002b120: 2020 2020 2020 2020 2020 2020 2072 6573               res
+0002b130: 6f75 7263 655f 7665 7273 696f 6e73 2c0a  ource_versions,.
+0002b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b150: 2020 2020 2020 2020 6c61 7465 7374 5f64          latest_d
+0002b160: 6174 6173 6f75 7263 655f 7665 7273 696f  atasource_versio
+0002b170: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+0002b180: 2020 2020 2020 2020 2020 2020 6472 795f              dry_
+0002b190: 7275 6e2c 0a20 2020 2020 2020 2020 2020  run,.           
+0002b1a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0002b1b0: 6b5f 646f 776e 7374 7265 616d 2c0a 2020  k_downstream,.  
+0002b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1d0: 2020 2020 2020 666f 726b 2c0a 2020 2020        fork,.    
+0002b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002b200: 2020 2020 2020 7072 6f63 6573 7365 642e        processed.
+0002b210: 6164 6428 6e61 6d65 290a 0a20 2020 2020  add(name)..     
+0002b220: 2020 2020 2020 2023 204e 6f77 2077 6520         # Now we 
+0002b230: 7368 6f75 6c64 2068 6176 6520 7468 6520  should have the 
+0002b240: 656e 6470 6f69 6e74 7320 616e 6420 6461  endpoints and da
+0002b250: 7461 736f 7572 6365 7320 6465 706c 6f79  tasources deploy
+0002b260: 6564 2c20 7765 2063 616e 2064 6570 6c6f  ed, we can deplo
+0002b270: 7920 7468 6520 7265 7374 206f 6620 7468  y the rest of th
+0002b280: 6520 7069 7065 7320 2863 6f70 7920 2620  e pipes (copy & 
+0002b290: 7369 6e6b 7329 0a20 2020 2020 2020 2020  sinks).         
+0002b2a0: 2020 2023 2057 6520 6e65 6564 2074 6f20     # We need to 
+0002b2b0: 7265 6c79 206f 6e20 7468 6520 666f 726b  rely on the fork
+0002b2c0: 646f 776e 7374 7265 616d 2067 7261 7068  downstream graph
+0002b2d0: 2061 7320 6974 2063 6f6e 7461 696e 7320   as it contains 
+0002b2e0: 616c 6c20 7468 6520 6d6f 6469 6669 6564  all the modified
+0002b2f0: 2070 6970 6573 2061 7320 7765 6c6c 2061   pipes as well a
+0002b300: 7320 7468 6520 6465 7065 6e64 656e 6369  s the dependenci
+0002b310: 6573 206f 6620 7468 6520 7069 7065 730a  es of the pipes.
+0002b320: 2020 2020 2020 2020 2020 2020 2320 496e              # In
+0002b330: 2074 6869 7320 6361 7365 2c20 7765 2064   this case, we d
+0002b340: 6f6e 2774 206e 6565 6420 746f 2067 656e  on't need to gen
+0002b350: 6572 6174 6520 6120 6e65 7720 6772 6170  erate a new grap
+0002b360: 6820 6173 2077 6520 6469 6420 666f 7220  h as we did for 
+0002b370: 7468 6520 656e 6470 6f69 6e74 7320 6173  the endpoints as
+0002b380: 2074 6865 2070 6970 6573 2061 7265 206e   the pipes are n
+0002b390: 6f74 2067 6f69 6e67 2074 6f20 6265 2075  ot going to be u
+0002b3a0: 7365 6420 6173 2064 6570 656e 6465 6e63  sed as dependenc
+0002b3b0: 6965 7320 616e 6420 7468 6520 6461 7461  ies and the data
+0002b3c0: 736f 7572 6365 7320 6172 6520 616c 7265  sources are alre
+0002b3d0: 6164 7920 6465 706c 6f79 6564 0a20 2020  ady deployed.   
+0002b3e0: 2020 2020 2020 2020 2067 726f 7570 7320           groups 
+0002b3f0: 3d20 5b67 726f 7570 2066 6f72 2067 726f  = [group for gro
+0002b400: 7570 2069 6e20 746f 706f 736f 7274 2864  up in toposort(d
+0002b410: 6570 656e 6465 6e63 6965 735f 6772 6170  ependencies_grap
+0002b420: 685f 666f 726b 5f64 6f77 6e73 7472 6561  h_fork_downstrea
+0002b430: 6d29 5d0a 2020 2020 2020 2020 2020 2020  m)].            
+0002b440: 666f 7220 6772 6f75 7020 696e 2067 726f  for group in gro
+0002b450: 7570 733a 0a20 2020 2020 2020 2020 2020  ups:.           
+0002b460: 2020 2020 2066 6f72 206e 616d 6520 696e       for name in
+0002b470: 2067 726f 7570 3a0a 2020 2020 2020 2020   group:.        
+0002b480: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0002b490: 616d 6520 696e 2070 726f 6365 7373 6564  ame in processed
+0002b4a0: 206f 7220 6973 5f6d 6174 6572 6961 6c69   or is_materiali
+0002b4b0: 7a65 6428 7265 736f 7572 6365 735f 746f  zed(resources_to
+0002b4c0: 5f72 756e 5f66 6f72 6b5f 646f 776e 7374  _run_fork_downst
+0002b4d0: 7265 616d 2e67 6574 286e 616d 6529 293a  ream.get(name)):
+0002b4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b4f0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+0002b500: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+0002b510: 2020 2020 2020 2061 7761 6974 2070 7573         await pus
+0002b520: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
+0002b530: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+0002b540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b550: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
+0002b560: 6573 5f74 6f5f 7275 6e5f 666f 726b 5f64  es_to_run_fork_d
+0002b570: 6f77 6e73 7472 6561 6d2c 0a20 2020 2020  ownstream,.     
+0002b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b590: 2020 2072 6573 6f75 7263 655f 7665 7273     resource_vers
+0002b5a0: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0002b5b0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0002b5c0: 7465 7374 5f64 6174 6173 6f75 7263 655f  test_datasource_
+0002b5d0: 7665 7273 696f 6e73 2c0a 2020 2020 2020  versions,.      
+0002b5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b5f0: 2020 6472 795f 7275 6e2c 0a20 2020 2020    dry_run,.     
+0002b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b610: 2020 2066 6f72 6b5f 646f 776e 7374 7265     fork_downstre
+0002b620: 616d 2c0a 2020 2020 2020 2020 2020 2020  am,.            
+0002b630: 2020 2020 2020 2020 2020 2020 666f 726b              fork
+0002b640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b650: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002b660: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+0002b670: 6573 7365 642e 6164 6428 6e61 6d65 290a  essed.add(name).
+0002b680: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+0002b690: 696e 616c 6c79 2c20 7765 206e 6565 6420  inally, we need 
+0002b6a0: 746f 2064 6570 6c6f 7920 7468 6520 6d61  to deploy the ma
+0002b6b0: 7465 7269 616c 697a 6564 2076 6965 7773  terialized views
+0002b6c0: 2066 726f 6d20 7269 6768 7420 746f 206c   from right to l
+0002b6d0: 6566 742e 0a20 2020 2020 2020 2020 2020  eft..           
+0002b6e0: 2023 2057 6520 6e65 6564 2074 6f20 7265   # We need to re
+0002b6f0: 6c79 206f 6e20 7468 6520 666f 726b 646f  ly on the forkdo
+0002b700: 776e 7374 7265 616d 2067 7261 7068 2061  wnstream graph a
+0002b710: 7320 6974 2063 6f6e 7461 696e 7320 616c  s it contains al
+0002b720: 6c20 7468 6520 6d6f 6469 6669 6564 206d  l the modified m
+0002b730: 6174 6572 6961 6c69 7a65 6420 7669 6577  aterialized view
+0002b740: 7320 6173 2077 656c 6c20 6173 2074 6865  s as well as the
+0002b750: 2064 6570 656e 6465 6e63 6965 7320 6f66   dependencies of
+0002b760: 2074 6865 206d 6174 6572 6961 6c69 7a65   the materialize
+0002b770: 6420 7669 6577 730a 2020 2020 2020 2020  d views.        
+0002b780: 2020 2020 2320 496e 2074 6869 7320 6361      # In this ca
+0002b790: 7365 2c20 7765 2064 6f6e 2774 206e 6565  se, we don't nee
+0002b7a0: 6420 746f 2067 656e 6572 6174 6520 6120  d to generate a 
+0002b7b0: 6e65 7720 6772 6170 6820 6173 2077 6520  new graph as we 
+0002b7c0: 6469 6420 666f 7220 7468 6520 656e 6470  did for the endp
+0002b7d0: 6f69 6e74 7320 6173 2074 6865 2070 6970  oints as the pip
+0002b7e0: 6573 2061 7265 206e 6f74 2067 6f69 6e67  es are not going
+0002b7f0: 2074 6f20 6265 2075 7365 6420 6173 2064   to be used as d
+0002b800: 6570 656e 6465 6e63 6965 7320 616e 6420  ependencies and 
+0002b810: 7468 6520 6461 7461 736f 7572 6365 7320  the datasources 
+0002b820: 6172 6520 616c 7265 6164 7920 6465 706c  are already depl
+0002b830: 6f79 6564 0a20 2020 2020 2020 2020 2020  oyed.           
+0002b840: 2067 726f 7570 7320 3d20 5b67 726f 7570   groups = [group
+0002b850: 2066 6f72 2067 726f 7570 2069 6e20 746f   for group in to
+0002b860: 706f 736f 7274 2864 6570 656e 6465 6e63  posort(dependenc
+0002b870: 6965 735f 6772 6170 685f 666f 726b 5f64  ies_graph_fork_d
+0002b880: 6f77 6e73 7472 6561 6d29 5d0a 2020 2020  ownstream)].    
+0002b890: 2020 2020 2020 2020 666f 7220 6772 6f75          for grou
+0002b8a0: 7020 696e 2067 726f 7570 733a 0a20 2020  p in groups:.   
+0002b8b0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0002b8c0: 206e 616d 6520 696e 2067 726f 7570 3a0a   name in group:.
+0002b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b8e0: 2020 2020 6966 206e 616d 6520 696e 2070      if name in p
+0002b8f0: 726f 6365 7373 6564 206f 7220 6e6f 7420  rocessed or not 
+0002b900: 6973 5f6d 6174 6572 6961 6c69 7a65 6428  is_materialized(
+0002b910: 7265 736f 7572 6365 735f 746f 5f72 756e  resources_to_run
+0002b920: 5f66 6f72 6b5f 646f 776e 7374 7265 616d  _fork_downstream
+0002b930: 2e67 6574 286e 616d 6529 293a 0a20 2020  .get(name)):.   
+0002b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b950: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
+0002b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b970: 2020 2061 7761 6974 2070 7573 6828 0a20     await push(. 
+0002b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b990: 2020 2020 2020 206e 616d 652c 0a20 2020         name,.   
+0002b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b9b0: 2020 2020 2072 6573 6f75 7263 6573 5f74       resources_t
+0002b9c0: 6f5f 7275 6e5f 666f 726b 5f64 6f77 6e73  o_run_fork_downs
+0002b9d0: 7472 6561 6d2c 0a20 2020 2020 2020 2020  tream,.         
+0002b9e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002b9f0: 6573 6f75 7263 655f 7665 7273 696f 6e73  esource_versions
+0002ba00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002ba10: 2020 2020 2020 2020 2020 6c61 7465 7374            latest
+0002ba20: 5f64 6174 6173 6f75 7263 655f 7665 7273  _datasource_vers
+0002ba30: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0002ba40: 2020 2020 2020 2020 2020 2020 2020 6472                dr
+0002ba50: 795f 7275 6e2c 0a20 2020 2020 2020 2020  y_run,.         
+0002ba60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002ba70: 6f72 6b5f 646f 776e 7374 7265 616d 2c0a  ork_downstream,.
+0002ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ba90: 2020 2020 2020 2020 666f 726b 2c0a 2020          fork,.  
+0002baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bab0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0002bac0: 2020 2020 2020 2020 7072 6f63 6573 7365          processe
+0002bad0: 642e 6164 6428 6e61 6d65 290a 0a20 2020  d.add(name)..   
+0002bae0: 2069 6620 6465 706c 6f79 6d65 6e74 2e69   if deployment.i
+0002baf0: 735f 6769 745f 7265 6c65 6173 653a 0a20  s_git_release:. 
+0002bb00: 2020 2020 2020 2064 6570 6c6f 796d 656e         deploymen
+0002bb10: 742e 6465 706c 6f79 696e 675f 6472 795f  t.deploying_dry_
+0002bb20: 7275 6e28 290a 2020 2020 2020 2020 6177  run().        aw
+0002bb30: 6169 7420 7075 7368 5f66 696c 6573 2864  ait push_files(d
+0002bb40: 6570 656e 6465 6e63 6965 735f 6772 6170  ependencies_grap
+0002bb50: 682c 2064 7279 5f72 756e 3d54 7275 652c  h, dry_run=True,
+0002bb60: 2063 6865 636b 5f62 6163 6b66 696c 6c5f   check_backfill_
+0002bb70: 7265 7175 6972 6564 3d63 6865 636b 5f62  required=check_b
+0002bb80: 6163 6b66 696c 6c5f 7265 7175 6972 6564  ackfill_required
+0002bb90: 290a 0a20 2020 2020 2020 2061 7761 6974  )..        await
+0002bba0: 2064 6570 6c6f 796d 656e 742e 6465 6c65   deployment.dele
+0002bbb0: 7465 5f72 6573 6f75 7263 6573 2864 656c  te_resources(del
+0002bbc0: 6574 6564 2c20 7069 7065 732c 2064 7279  eted, pipes, dry
+0002bbd0: 5f72 756e 3d54 7275 6529 0a20 2020 2020  _run=True).     
+0002bbe0: 2020 2069 6620 6e6f 7420 6465 706c 6f79     if not deploy
+0002bbf0: 6d65 6e74 2e64 7279 5f72 756e 3a0a 2020  ment.dry_run:.  
+0002bc00: 2020 2020 2020 2020 2020 6465 706c 6f79            deploy
+0002bc10: 6d65 6e74 2e64 6570 6c6f 7969 6e67 2829  ment.deploying()
+0002bc20: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+0002bc30: 6974 2070 7573 685f 6669 6c65 7328 6465  it push_files(de
+0002bc40: 7065 6e64 656e 6369 6573 5f67 7261 7068  pendencies_graph
+0002bc50: 2c20 6472 795f 7275 6e29 0a20 2020 2020  , dry_run).     
+0002bc60: 2020 2020 2020 2061 7761 6974 2064 6570         await dep
+0002bc70: 6c6f 796d 656e 742e 6465 6c65 7465 5f72  loyment.delete_r
+0002bc80: 6573 6f75 7263 6573 2864 656c 6574 6564  esources(deleted
+0002bc90: 2c20 7069 7065 7329 0a20 2020 2065 6c73  , pipes).    els
+0002bca0: 653a 0a20 2020 2020 2020 2061 7761 6974  e:.        await
+0002bcb0: 2070 7573 685f 6669 6c65 7328 6465 7065   push_files(depe
+0002bcc0: 6e64 656e 6369 6573 5f67 7261 7068 2c20  ndencies_graph, 
+0002bcd0: 6472 795f 7275 6e29 0a0a 2020 2020 6966  dry_run)..    if
+0002bce0: 206e 6f74 2064 7279 5f72 756e 2061 6e64   not dry_run and
+0002bcf0: 206e 6f74 2072 756e 5f74 6573 7473 3a0a   not run_tests:.
+0002bd00: 2020 2020 2020 2020 6966 2075 706c 6f61          if uploa
+0002bd10: 645f 6669 7874 7572 6573 3a0a 2020 2020  d_fixtures:.    
+0002bd20: 2020 2020 2020 2020 636c 6963 6b2e 6563          click.ec
+0002bd30: 686f 2846 6565 6462 6163 6b4d 616e 6167  ho(FeedbackManag
+0002bd40: 6572 2e69 6e66 6f5f 7075 7368 696e 675f  er.info_pushing_
+0002bd50: 6669 7874 7572 6573 2829 290a 0a20 2020  fixtures())..   
+0002bd60: 2020 2020 2020 2020 2023 2057 6520 6e65           # We ne
+0002bd70: 6564 2074 6f20 7570 6c6f 6164 2074 6865  ed to upload the
+0002bd80: 2066 6978 7475 7265 7320 6576 656e 2069   fixtures even i
+0002bd90: 6620 7468 6572 6520 6973 206e 6f20 6368  f there is no ch
+0002bda0: 616e 6765 0a20 2020 2020 2020 2020 2020  ange.           
+0002bdb0: 2069 6620 6973 5f62 7261 6e63 683a 0a20   if is_branch:. 
+0002bdc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002bdd0: 696c 656e 616d 6573 203d 2067 6574 5f70  ilenames = get_p
+0002bde0: 726f 6a65 6374 5f66 696c 656e 616d 6573  roject_filenames
+0002bdf0: 2866 6f6c 6465 722c 2077 6974 685f 7665  (folder, with_ve
+0002be00: 6e64 6f72 3d54 7275 6529 0a20 2020 2020  ndor=True).     
+0002be10: 2020 2020 2020 2020 2020 2064 6570 656e             depen
+0002be20: 6465 6e63 6965 735f 6772 6170 6820 3d20  dencies_graph = 
+0002be30: 6177 6169 7420 6275 696c 645f 6772 6170  await build_grap
+0002be40: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
+0002be50: 2020 2020 2020 2066 696c 656e 616d 6573         filenames
+0002be60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002be70: 2020 2020 2020 7462 5f63 6c69 656e 742c        tb_client,
+0002be80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002be90: 2020 2020 2064 6972 5f70 6174 683d 666f       dir_path=fo
+0002bea0: 6c64 6572 2c0a 2020 2020 2020 2020 2020  lder,.          
+0002beb0: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+0002bec0: 6365 5f76 6572 7369 6f6e 733d 6c61 7465  ce_versions=late
+0002bed0: 7374 5f64 6174 6173 6f75 7263 655f 7665  st_datasource_ve
+0002bee0: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
+0002bef0: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0002bf00: 7370 6163 655f 6d61 703d 776f 726b 7370  space_map=worksp
+0002bf10: 6163 655f 6d61 702c 0a20 2020 2020 2020  ace_map,.       
+0002bf20: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+0002bf30: 6365 7373 5f64 6570 656e 6465 6e63 6965  cess_dependencie
+0002bf40: 733d 7075 7368 5f64 6570 732c 0a20 2020  s=push_deps,.   
+0002bf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf60: 2076 6572 626f 7365 3d76 6572 626f 7365   verbose=verbose
+0002bf70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002bf80: 2020 2020 2020 776f 726b 7370 6163 655f        workspace_
+0002bf90: 6c69 625f 7061 7468 733d 776f 726b 7370  lib_paths=worksp
+0002bfa0: 6163 655f 6c69 625f 7061 7468 732c 0a20  ace_lib_paths,. 
+0002bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bfc0: 2020 2063 7572 7265 6e74 5f77 733d 6375     current_ws=cu
+0002bfd0: 7272 656e 745f 7773 2c0a 2020 2020 2020  rrent_ws,.      
+0002bfe0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0002bff0: 2020 2020 2020 2020 2070 726f 6365 7373           process
+0002c000: 6564 203d 2073 6574 2829 0a20 2020 2020  ed = set().     
+0002c010: 2020 2020 2020 2066 6f72 2067 726f 7570         for group
+0002c020: 2069 6e20 746f 706f 736f 7274 2864 6570   in toposort(dep
+0002c030: 656e 6465 6e63 6965 735f 6772 6170 682e  endencies_graph.
+0002c040: 6465 705f 6d61 7029 3a0a 2020 2020 2020  dep_map):.      
+0002c050: 2020 2020 2020 2020 2020 666f 7220 6620            for f 
+0002c060: 696e 2067 726f 7570 3a0a 2020 2020 2020  in group:.      
+0002c070: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+0002c080: 6d65 203d 206f 732e 7061 7468 2e62 6173  me = os.path.bas
+0002c090: 656e 616d 6528 6629 0a20 2020 2020 2020  ename(f).       
+0002c0a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002c0b0: 6e61 6d65 206e 6f74 2069 6e20 7072 6f63  name not in proc
+0002c0c0: 6573 7365 643a 0a20 2020 2020 2020 2020  essed:.         
+0002c0d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002c0e0: 6620 6e61 6d65 2069 6e20 6465 7065 6e64  f name in depend
+0002c0f0: 656e 6369 6573 5f67 7261 7068 2e74 6f5f  encies_graph.to_
+0002c100: 7275 6e3a 0a20 2020 2020 2020 2020 2020  run:.           
+0002c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c120: 2061 7761 6974 2063 6865 636b 5f66 6978   await check_fix
+0002c130: 7475 7265 735f 6461 7461 280a 2020 2020  tures_data(.    
+0002c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c150: 2020 2020 2020 2020 2020 2020 7462 5f63              tb_c
+0002c160: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
+0002c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c180: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
+0002c190: 6965 735f 6772 6170 682e 746f 5f72 756e  ies_graph.to_run
+0002c1a0: 5b6e 616d 655d 2c0a 2020 2020 2020 2020  [name],.        
+0002c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c1c0: 2020 2020 2020 2020 6465 6275 672c 0a20          debug,. 
+0002c1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c1e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002c1f0: 6f6c 6465 722c 0a20 2020 2020 2020 2020  older,.         
+0002c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c210: 2020 2020 2020 2066 6f72 6365 2c0a 2020         force,.  
+0002c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c230: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+0002c240: 6465 3d22 6170 7065 6e64 2220 6966 2069  de="append" if i
+0002c250: 735f 6272 616e 6368 2065 6c73 6520 2272  s_branch else "r
+0002c260: 6570 6c61 6365 222c 0a20 2020 2020 2020  eplace",.       
+0002c270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c280: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0002c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c2a0: 2020 2070 726f 6365 7373 6564 2e61 6464     processed.add
+0002c2b0: 286e 616d 6529 0a20 2020 2020 2020 2020  (name).         
+0002c2c0: 2020 2066 6f72 2066 2069 6e20 6465 7065     for f in depe
+0002c2d0: 6e64 656e 6369 6573 5f67 7261 7068 2e74  ndencies_graph.t
+0002c2e0: 6f5f 7275 6e3a 0a20 2020 2020 2020 2020  o_run:.         
+0002c2f0: 2020 2020 2020 2069 6620 6620 6e6f 7420         if f not 
+0002c300: 696e 2070 726f 6365 7373 6564 3a0a 2020  in processed:.  
+0002c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c320: 2020 6177 6169 7420 6368 6563 6b5f 6669    await check_fi
+0002c330: 7874 7572 6573 5f64 6174 6128 0a20 2020  xtures_data(.   
+0002c340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c350: 2020 2020 2074 625f 636c 6965 6e74 2c0a       tb_client,.
+0002c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c370: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
+0002c380: 6369 6573 5f67 7261 7068 2e74 6f5f 7275  cies_graph.to_ru
+0002c390: 6e5b 665d 2c0a 2020 2020 2020 2020 2020  n[f],.          
+0002c3a0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0002c3b0: 6275 672c 0a20 2020 2020 2020 2020 2020  bug,.           
+0002c3c0: 2020 2020 2020 2020 2020 2020 2066 6f6c               fol
+0002c3d0: 6465 722c 0a20 2020 2020 2020 2020 2020  der,.           
+0002c3e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0002c3f0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0002c400: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0002c410: 3d22 6170 7065 6e64 2220 6966 2069 735f  ="append" if is_
+0002c420: 6272 616e 6368 2065 6c73 6520 2272 6570  branch else "rep
+0002c430: 6c61 6365 222c 0a20 2020 2020 2020 2020  lace",.         
+0002c440: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002c450: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002c460: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+0002c470: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002c480: 2020 2063 6c69 636b 2e65 6368 6f28 4665     click.echo(Fe
+0002c490: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
+0002c4a0: 666f 5f6e 6f74 5f70 7573 6869 6e67 5f66  fo_not_pushing_f
+0002c4b0: 6978 7475 7265 7328 2929 0a0a 2020 2020  ixtures())..    
+0002c4c0: 6177 6169 7420 6465 706c 6f79 6d65 6e74  await deployment
+0002c4d0: 2e75 7064 6174 655f 7265 6c65 6173 6528  .update_release(
+0002c4e0: 6861 735f 7365 6d76 6572 3d68 6173 5f73  has_semver=has_s
+0002c4f0: 656d 7665 722c 2072 656c 6561 7365 5f63  emver, release_c
+0002c500: 7265 6174 6564 3d72 656c 6561 7365 5f63  reated=release_c
+0002c510: 7265 6174 6564 290a 0a20 2020 2072 6574  reated)..    ret
+0002c520: 7572 6e20 6465 7065 6e64 656e 6369 6573  urn dependencies
+0002c530: 5f67 7261 7068 2e74 6f5f 7275 6e0a 0a0a  _graph.to_run...
+0002c540: 6173 796e 6320 6465 6620 6368 6563 6b5f  async def check_
+0002c550: 6669 7874 7572 6573 5f64 6174 6128 0a20  fixtures_data(. 
+0002c560: 2020 2063 6c69 656e 743a 2054 696e 7942     client: TinyB
+0002c570: 2c20 7265 736f 7572 6365 3a20 4469 6374  , resource: Dict
+0002c580: 5b73 7472 2c20 416e 795d 2c20 6465 6275  [str, Any], debu
+0002c590: 673a 2062 6f6f 6c2c 2066 6f6c 6465 723a  g: bool, folder:
+0002c5a0: 2073 7472 203d 2022 222c 2066 6f72 6365   str = "", force
+0002c5b0: 3a20 626f 6f6c 203d 2046 616c 7365 2c20  : bool = False, 
+0002c5c0: 6d6f 6465 3a20 7374 7220 3d20 2272 6570  mode: str = "rep
+0002c5d0: 6c61 6365 220a 293a 0a20 2020 2069 6620  lace".):.    if 
+0002c5e0: 6465 6275 673a 0a20 2020 2020 2020 2063  debug:.        c
+0002c5f0: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
+0002c600: 636b 4d61 6e61 6765 722e 696e 666f 5f63  ckManager.info_c
+0002c610: 6865 636b 696e 675f 6669 6c65 2866 696c  hecking_file(fil
+0002c620: 653d 7070 2e70 666f 726d 6174 2872 6573  e=pp.pformat(res
+0002c630: 6f75 7263 6529 2929 0a20 2020 2069 6620  ource))).    if 
+0002c640: 7265 736f 7572 6365 5b22 7265 736f 7572  resource["resour
+0002c650: 6365 225d 2069 6e20 5b22 7069 7065 7322  ce"] in ["pipes"
+0002c660: 2c20 2274 6f6b 656e 7322 5d3a 0a20 2020  , "tokens"]:.   
+0002c670: 2020 2020 2070 6173 730a 2020 2020 656c       pass.    el
+0002c680: 6966 2072 6573 6f75 7263 655b 2272 6573  if resource["res
+0002c690: 6f75 7263 6522 5d20 3d3d 2022 6461 7461  ource"] == "data
+0002c6a0: 736f 7572 6365 7322 3a0a 2020 2020 2020  sources":.      
+0002c6b0: 2020 6461 7461 736f 7572 6365 5f6e 616d    datasource_nam
+0002c6c0: 6520 3d20 7265 736f 7572 6365 5b22 7061  e = resource["pa
+0002c6d0: 7261 6d73 225d 5b22 6e61 6d65 225d 0a20  rams"]["name"]. 
+0002c6e0: 2020 2020 2020 206e 616d 6520 3d20 6f73         name = os
+0002c6f0: 2e70 6174 682e 6261 7365 6e61 6d65 2872  .path.basename(r
+0002c700: 6573 6f75 7263 655b 2266 696c 656e 616d  esource["filenam
+0002c710: 6522 5d29 2e72 7370 6c69 7428 222e 222c  e"]).rsplit(".",
+0002c720: 2031 295b 305d 0a20 2020 2020 2020 2066   1)[0].        f
+0002c730: 6978 7475 7265 5f70 6174 6820 3d20 5061  ixture_path = Pa
+0002c740: 7468 2866 6f6c 6465 7229 202f 2022 6669  th(folder) / "fi
+0002c750: 7874 7572 6573 2220 2f20 6622 7b6e 616d  xtures" / f"{nam
+0002c760: 657d 2e63 7376 220a 0a20 2020 2020 2020  e}.csv"..       
+0002c770: 2069 6620 6e6f 7420 6669 7874 7572 655f   if not fixture_
+0002c780: 7061 7468 2e65 7869 7374 7328 293a 0a20  path.exists():. 
+0002c790: 2020 2020 2020 2020 2020 2066 6978 7475             fixtu
+0002c7a0: 7265 5f70 6174 6820 3d20 5061 7468 2866  re_path = Path(f
+0002c7b0: 6f6c 6465 7229 202f 2022 6461 7461 736f  older) / "dataso
+0002c7c0: 7572 6365 7322 202f 2022 6669 7874 7572  urces" / "fixtur
+0002c7d0: 6573 2220 2f20 6622 7b6e 616d 657d 2e63  es" / f"{name}.c
+0002c7e0: 7376 220a 2020 2020 2020 2020 6966 206e  sv".        if n
+0002c7f0: 6f74 2066 6978 7475 7265 5f70 6174 682e  ot fixture_path.
+0002c800: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
+0002c810: 2020 2020 2020 6669 7874 7572 655f 7061        fixture_pa
+0002c820: 7468 203d 2050 6174 6828 666f 6c64 6572  th = Path(folder
+0002c830: 2920 2f20 2264 6174 6173 6f75 7263 6573  ) / "datasources
+0002c840: 2220 2f20 2266 6978 7475 7265 7322 202f  " / "fixtures" /
+0002c850: 2066 227b 6e61 6d65 7d2e 6e64 6a73 6f6e   f"{name}.ndjson
+0002c860: 220a 2020 2020 2020 2020 6966 206e 6f74  ".        if not
+0002c870: 2066 6978 7475 7265 5f70 6174 682e 6578   fixture_path.ex
+0002c880: 6973 7473 2829 3a0a 2020 2020 2020 2020  ists():.        
+0002c890: 2020 2020 6669 7874 7572 655f 7061 7468      fixture_path
+0002c8a0: 203d 2050 6174 6828 666f 6c64 6572 2920   = Path(folder) 
+0002c8b0: 2f20 2264 6174 6173 6f75 7263 6573 2220  / "datasources" 
+0002c8c0: 2f20 2266 6978 7475 7265 7322 202f 2066  / "fixtures" / f
+0002c8d0: 227b 6e61 6d65 7d2e 7061 7271 7565 7422  "{name}.parquet"
+0002c8e0: 0a20 2020 2020 2020 2069 6620 6669 7874  .        if fixt
+0002c8f0: 7572 655f 7061 7468 2e65 7869 7374 7328  ure_path.exists(
+0002c900: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0002c910: 204c 6574 2773 2076 616c 6964 6174 6520   Let's validate 
+0002c920: 6f6e 6c79 2077 6865 6e20 7768 656e 2077  only when when w
+0002c930: 6520 6172 6520 676f 696e 6720 746f 2072  e are going to r
+0002c940: 6570 6c61 6365 2074 6865 2061 6374 7561  eplace the actua
+0002c950: 6c20 6461 7461 0a20 2020 2020 2020 2020  l data.         
+0002c960: 2020 2072 6573 756c 7420 3d20 6177 6169     result = awai
+0002c970: 7420 636c 6965 6e74 2e71 7565 7279 2873  t client.query(s
+0002c980: 716c 3d66 2253 454c 4543 5420 636f 756e  ql=f"SELECT coun
+0002c990: 7428 2920 6173 2063 2046 524f 4d20 7b64  t() as c FROM {d
+0002c9a0: 6174 6173 6f75 7263 655f 6e61 6d65 7d20  atasource_name} 
+0002c9b0: 464f 524d 4154 204a 534f 4e22 290a 2020  FORMAT JSON").  
+0002c9c0: 2020 2020 2020 2020 2020 636f 756e 7420            count 
+0002c9d0: 3d20 7265 7375 6c74 5b22 6461 7461 225d  = result["data"]
+0002c9e0: 5b30 5d5b 2263 225d 0a0a 2020 2020 2020  [0]["c"]..      
+0002c9f0: 2020 2020 2020 6966 2063 6f75 6e74 203e        if count >
+0002ca00: 2030 2061 6e64 206e 6f74 2066 6f72 6365   0 and not force
+0002ca10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002ca20: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
+0002ca30: 6963 6b45 7863 6570 7469 6f6e 280a 2020  ickException(.  
+0002ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca50: 2020 4665 6564 6261 636b 4d61 6e61 6765    FeedbackManage
+0002ca60: 722e 6572 726f 725f 7075 7368 5f66 6978  r.error_push_fix
+0002ca70: 7475 7265 5f77 696c 6c5f 7265 706c 6163  ture_will_replac
+0002ca80: 655f 6461 7461 2864 6174 6173 6f75 7263  e_data(datasourc
+0002ca90: 653d 6461 7461 736f 7572 6365 5f6e 616d  e=datasource_nam
+0002caa0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0002cab0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0002cac0: 2020 636c 6963 6b2e 6563 686f 280a 2020    click.echo(.  
+0002cad0: 2020 2020 2020 2020 2020 2020 2020 4665                Fe
+0002cae0: 6564 6261 636b 4d61 6e61 6765 722e 696e  edbackManager.in
+0002caf0: 666f 5f63 6865 636b 696e 675f 6669 6c65  fo_checking_file
+0002cb00: 5f73 697a 6528 0a20 2020 2020 2020 2020  _size(.         
+0002cb10: 2020 2020 2020 2020 2020 2066 696c 656e             filen
+0002cb20: 616d 653d 7265 736f 7572 6365 5b22 6669  ame=resource["fi
+0002cb30: 6c65 6e61 6d65 225d 2c20 7369 7a65 3d73  lename"], size=s
+0002cb40: 697a 656f 665f 666d 7428 6f73 2e73 7461  izeof_fmt(os.sta
+0002cb50: 7428 6669 7874 7572 655f 7061 7468 292e  t(fixture_path).
+0002cb60: 7374 5f73 697a 6529 0a20 2020 2020 2020  st_size).       
+0002cb70: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002cb80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002cb90: 2020 2020 2073 7973 2e73 7464 6f75 742e       sys.stdout.
+0002cba0: 666c 7573 6828 290a 2020 2020 2020 2020  flush().        
+0002cbb0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0002cbc0: 2020 2020 2020 2020 2061 7761 6974 2063           await c
+0002cbd0: 6c69 656e 742e 6461 7461 736f 7572 6365  lient.datasource
+0002cbe0: 5f61 7070 656e 645f 6461 7461 280a 2020  _append_data(.  
+0002cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cc00: 2020 6461 7461 736f 7572 6365 5f6e 616d    datasource_nam
+0002cc10: 653d 7265 736f 7572 6365 5b22 7061 7261  e=resource["para
+0002cc20: 6d73 225d 5b22 6e61 6d65 225d 2c0a 2020  ms"]["name"],.  
+0002cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cc40: 2020 6669 6c65 3d66 6978 7475 7265 5f70    file=fixture_p
+0002cc50: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+0002cc60: 2020 2020 2020 2020 206d 6f64 653d 6d6f           mode=mo
+0002cc70: 6465 2c0a 2020 2020 2020 2020 2020 2020  de,.            
+0002cc80: 2020 2020 2020 2020 666f 726d 6174 3d66          format=f
+0002cc90: 6978 7475 7265 5f70 6174 682e 7375 6666  ixture_path.suff
+0002cca0: 6978 5b31 3a5d 2c0a 2020 2020 2020 2020  ix[1:],.        
+0002ccb0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002ccc0: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
+0002ccd0: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
+0002cce0: 6167 6572 2e73 7563 6365 7373 5f70 726f  ager.success_pro
+0002ccf0: 6365 7373 696e 675f 6461 7461 2829 290a  cessing_data()).
+0002cd00: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0002cd10: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+0002cd20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002cd30: 2020 2072 6169 7365 2063 6c69 636b 2e43     raise click.C
+0002cd40: 6c69 636b 4578 6365 7074 696f 6e28 4665  lickException(Fe
+0002cd50: 6564 6261 636b 4d61 6e61 6765 722e 6572  edbackManager.er
+0002cd60: 726f 725f 7072 6f63 6573 7369 6e67 5f62  ror_processing_b
+0002cd70: 6c6f 636b 7328 6572 726f 723d 6529 290a  locks(error=e)).
+0002cd80: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0002cd90: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+0002cda0: 2e65 6368 6f28 4665 6564 6261 636b 4d61  .echo(FeedbackMa
+0002cdb0: 6e61 6765 722e 7761 726e 696e 675f 6669  nager.warning_fi
+0002cdc0: 7874 7572 655f 6e6f 745f 666f 756e 6428  xture_not_found(
+0002cdd0: 6461 7461 736f 7572 6365 5f6e 616d 653d  datasource_name=
+0002cde0: 6e61 6d65 2929 0a20 2020 2065 6c73 653a  name)).    else:
+0002cdf0: 0a20 2020 2020 2020 2072 6169 7365 2063  .        raise c
+0002ce00: 6c69 636b 2e43 6c69 636b 4578 6365 7074  lick.ClickExcept
+0002ce10: 696f 6e28 4665 6564 6261 636b 4d61 6e61  ion(FeedbackMana
+0002ce20: 6765 722e 6572 726f 725f 756e 6b6e 6f77  ger.error_unknow
+0002ce30: 6e5f 7265 736f 7572 6365 2872 6573 6f75  n_resource(resou
+0002ce40: 7263 653d 7265 736f 7572 6365 5b22 7265  rce=resource["re
+0002ce50: 736f 7572 6365 225d 2929 0a0a 0a44 4154  source"]))...DAT
+0002ce60: 4146 494c 455f 4e45 575f 4c49 4e45 203d  AFILE_NEW_LINE =
+0002ce70: 2022 5c6e 220a 4441 5441 4649 4c45 5f49   "\n".DATAFILE_I
+0002ce80: 4e44 454e 5420 3d20 2220 2220 2a20 340a  NDENT = " " * 4.
+0002ce90: 0a0a 6465 6620 666f 726d 6174 5f73 6368  ..def format_sch
+0002cea0: 656d 6128 6669 6c65 5f70 6172 7473 3a20  ema(file_parts: 
+0002ceb0: 4c69 7374 5b73 7472 5d2c 206e 6f64 653a  List[str], node:
+0002cec0: 2044 6963 745b 7374 722c 2041 6e79 5d29   Dict[str, Any])
+0002ced0: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
+0002cee0: 2020 2069 6620 2273 6368 656d 6122 2069     if "schema" i
+0002cef0: 6e20 6e6f 6465 2061 6e64 206e 6f64 655b  n node and node[
+0002cf00: 2273 6368 656d 6122 5d3a 0a20 2020 2020  "schema"]:.     
+0002cf10: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
+0002cf20: 7065 6e64 2822 5343 4845 4d41 203e 2229  pend("SCHEMA >")
+0002cf30: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+0002cf40: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
+0002cf50: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
+0002cf60: 2020 2020 2020 636f 6c75 6d6e 7320 3d20        columns = 
+0002cf70: 7363 6865 6d61 5f74 6f5f 7371 6c5f 636f  schema_to_sql_co
+0002cf80: 6c75 6d6e 7328 6e6f 6465 5b22 636f 6c75  lumns(node["colu
+0002cf90: 6d6e 7322 5d29 0a20 2020 2020 2020 2066  mns"]).        f
+0002cfa0: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002cfb0: 2866 222c 7b44 4154 4146 494c 455f 4e45  (f",{DATAFILE_NE
+0002cfc0: 575f 4c49 4e45 7d22 2e6a 6f69 6e28 6d61  W_LINE}".join(ma
+0002cfd0: 7028 6c61 6d62 6461 2078 3a20 6622 2020  p(lambda x: f"  
+0002cfe0: 2020 7b78 7d22 2c20 636f 6c75 6d6e 7329    {x}", columns)
+0002cff0: 2929 0a20 2020 2020 2020 2066 696c 655f  )).        file_
+0002d000: 7061 7274 732e 6170 7065 6e64 2844 4154  parts.append(DAT
+0002d010: 4146 494c 455f 4e45 575f 4c49 4e45 290a  AFILE_NEW_LINE).
+0002d020: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
+0002d030: 7473 2e61 7070 656e 6428 4441 5441 4649  ts.append(DATAFI
+0002d040: 4c45 5f4e 4557 5f4c 494e 4529 0a0a 2020  LE_NEW_LINE)..  
+0002d050: 2020 7265 7475 726e 2066 696c 655f 7061    return file_pa
+0002d060: 7274 730a 0a0a 6465 6620 666f 726d 6174  rts...def format
+0002d070: 5f69 6e64 6963 6573 2866 696c 655f 7061  _indices(file_pa
+0002d080: 7274 733a 204c 6973 745b 7374 725d 2c20  rts: List[str], 
+0002d090: 6e6f 6465 3a20 4469 6374 5b73 7472 2c20  node: Dict[str, 
+0002d0a0: 416e 795d 2920 2d3e 204c 6973 745b 7374  Any]) -> List[st
+0002d0b0: 725d 3a0a 2020 2020 6966 2022 696e 6465  r]:.    if "inde
+0002d0c0: 7865 7322 2069 6e20 6e6f 6465 2061 6e64  xes" in node and
+0002d0d0: 206e 6f64 655b 2269 6e64 6578 6573 225d   node["indexes"]
+0002d0e0: 3a0a 2020 2020 2020 2020 696e 6465 7865  :.        indexe
+0002d0f0: 7320 3d20 6e6f 6465 5b22 696e 6465 7865  s = node["indexe
+0002d100: 7322 5d0a 2020 2020 2020 2020 6669 6c65  s"].        file
+0002d110: 5f70 6172 7473 2e61 7070 656e 6428 2249  _parts.append("I
+0002d120: 4e44 4558 4553 203e 2229 0a20 2020 2020  NDEXES >").     
+0002d130: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
+0002d140: 7065 6e64 2844 4154 4146 494c 455f 4e45  pend(DATAFILE_NE
+0002d150: 575f 4c49 4e45 290a 2020 2020 2020 2020  W_LINE).        
+0002d160: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
+0002d170: 6428 6622 7b44 4154 4146 494c 455f 4e45  d(f"{DATAFILE_NE
+0002d180: 575f 4c49 4e45 7d22 2e6a 6f69 6e28 6d61  W_LINE}".join(ma
+0002d190: 7028 6c61 6d62 6461 2069 6e64 6578 3a20  p(lambda index: 
+0002d1a0: 6622 2020 2020 7b69 6e64 6578 2e74 6f5f  f"    {index.to_
+0002d1b0: 6461 7461 6669 6c65 2829 7d22 2c20 696e  datafile()}", in
+0002d1c0: 6465 7865 7329 2929 0a20 2020 2020 2020  dexes))).       
+0002d1d0: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
+0002d1e0: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
+0002d1f0: 4c49 4e45 290a 2020 2020 2020 2020 6669  LINE).        fi
+0002d200: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002d210: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
+0002d220: 4529 0a0a 2020 2020 7265 7475 726e 2066  E)..    return f
+0002d230: 696c 655f 7061 7274 730a 0a0a 6465 6620  ile_parts...def 
+0002d240: 666f 726d 6174 5f64 6174 615f 636f 6e6e  format_data_conn
+0002d250: 6563 746f 7228 6669 6c65 5f70 6172 7473  ector(file_parts
+0002d260: 3a20 4c69 7374 5b73 7472 5d2c 206e 6f64  : List[str], nod
+0002d270: 653a 2044 6963 745b 7374 722c 2041 6e79  e: Dict[str, Any
+0002d280: 5d29 202d 3e20 4c69 7374 5b73 7472 5d3a  ]) -> List[str]:
+0002d290: 0a20 2020 206c 6c20 3d20 6c65 6e28 6669  .    ll = len(fi
+0002d2a0: 6c65 5f70 6172 7473 290a 2020 2020 7175  le_parts).    qu
+0002d2b0: 6f74 6573 203d 2022 2727 220a 2020 2020  otes = "''".    
+0002d2c0: 5b66 696c 655f 7061 7274 732e 6170 7065  [file_parts.appe
+0002d2d0: 6e64 2866 227b 6b2e 7570 7065 7228 297d  nd(f"{k.upper()}
+0002d2e0: 207b 7620 6f72 2071 756f 7465 737d 7b44   {v or quotes}{D
+0002d2f0: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
+0002d300: 7d22 2920 666f 7220 6b2c 2076 2069 6e20  }") for k, v in 
+0002d310: 6e6f 6465 2e69 7465 6d73 2829 2069 6620  node.items() if 
+0002d320: 226b 6166 6b61 2220 696e 206b 5d20 2023  "kafka" in k]  #
+0002d330: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
+0002d340: 2020 6966 206c 6c20 3c20 6c65 6e28 6669    if ll < len(fi
+0002d350: 6c65 5f70 6172 7473 293a 0a20 2020 2020  le_parts):.     
+0002d360: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
+0002d370: 7065 6e64 2844 4154 4146 494c 455f 4e45  pend(DATAFILE_NE
+0002d380: 575f 4c49 4e45 290a 2020 2020 7265 7475  W_LINE).    retu
+0002d390: 726e 2066 696c 655f 7061 7274 730a 0a0a  rn file_parts...
+0002d3a0: 6465 6620 666f 726d 6174 5f69 6d70 6f72  def format_impor
+0002d3b0: 745f 7365 7474 696e 6773 2866 696c 655f  t_settings(file_
+0002d3c0: 7061 7274 733a 204c 6973 745b 7374 725d  parts: List[str]
+0002d3d0: 2c20 6e6f 6465 3a20 4469 6374 5b73 7472  , node: Dict[str
+0002d3e0: 2c20 416e 795d 2920 2d3e 204c 6973 745b  , Any]) -> List[
+0002d3f0: 7374 725d 3a0a 2020 2020 6c6c 203d 206c  str]:.    ll = l
+0002d400: 656e 2866 696c 655f 7061 7274 7329 0a20  en(file_parts). 
+0002d410: 2020 205b 6669 6c65 5f70 6172 7473 2e61     [file_parts.a
+0002d420: 7070 656e 6428 6622 7b6b 2e75 7070 6572  ppend(f"{k.upper
+0002d430: 2829 7d20 7b76 7d7b 4441 5441 4649 4c45  ()} {v}{DATAFILE
+0002d440: 5f4e 4557 5f4c 494e 457d 2229 2066 6f72  _NEW_LINE}") for
+0002d450: 206b 2c20 7620 696e 206e 6f64 652e 6974   k, v in node.it
+0002d460: 656d 7328 2920 6966 2022 696d 706f 7274  ems() if "import
+0002d470: 5f22 2069 6e20 6b5d 2020 2320 7479 7065  _" in k]  # type
+0002d480: 3a20 6967 6e6f 7265 0a20 2020 2069 6620  : ignore.    if 
+0002d490: 6c6c 203c 206c 656e 2866 696c 655f 7061  ll < len(file_pa
+0002d4a0: 7274 7329 3a0a 2020 2020 2020 2020 6669  rts):.        fi
+0002d4b0: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002d4c0: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
+0002d4d0: 4529 0a20 2020 2072 6574 7572 6e20 6669  E).    return fi
+0002d4e0: 6c65 5f70 6172 7473 0a0a 0a64 6566 2066  le_parts...def f
+0002d4f0: 6f72 6d61 745f 696e 636c 7564 6528 6669  ormat_include(fi
+0002d500: 6c65 5f70 6172 7473 3a20 4c69 7374 5b73  le_parts: List[s
+0002d510: 7472 5d2c 2064 6f63 3a20 4461 7461 6669  tr], doc: Datafi
+0002d520: 6c65 2c20 756e 726f 6c6c 5f69 6e63 6c75  le, unroll_inclu
+0002d530: 6465 733a 2062 6f6f 6c20 3d20 4661 6c73  des: bool = Fals
+0002d540: 6529 202d 3e20 4c69 7374 5b73 7472 5d3a  e) -> List[str]:
+0002d550: 0a20 2020 2069 6620 756e 726f 6c6c 5f69  .    if unroll_i
+0002d560: 6e63 6c75 6465 733a 0a20 2020 2020 2020  ncludes:.       
+0002d570: 2072 6574 7572 6e20 6669 6c65 5f70 6172   return file_par
+0002d580: 7473 0a0a 2020 2020 6173 7365 7274 2064  ts..    assert d
+0002d590: 6f63 2e72 6177 2069 7320 6e6f 7420 4e6f  oc.raw is not No
+0002d5a0: 6e65 0a0a 2020 2020 696e 636c 7564 6520  ne..    include 
+0002d5b0: 3d20 5b6c 696e 6520 666f 7220 6c69 6e65  = [line for line
+0002d5c0: 2069 6e20 646f 632e 7261 7720 6966 2022   in doc.raw if "
+0002d5d0: 494e 434c 5544 4522 2069 6e20 6c69 6e65  INCLUDE" in line
+0002d5e0: 2061 6e64 2022 2e69 6e63 6c22 2069 6e20   and ".incl" in 
+0002d5f0: 6c69 6e65 5d0a 2020 2020 6966 206c 656e  line].    if len
+0002d600: 2869 6e63 6c75 6465 293a 0a20 2020 2020  (include):.     
+0002d610: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
+0002d620: 7065 6e64 2869 6e63 6c75 6465 5b30 5d29  pend(include[0])
+0002d630: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+0002d640: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
+0002d650: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
+0002d660: 2020 7265 7475 726e 2066 696c 655f 7061    return file_pa
+0002d670: 7274 730a 0a0a 6173 796e 6320 6465 6620  rts...async def 
+0002d680: 666f 726d 6174 5f64 6174 6173 6f75 7263  format_datasourc
+0002d690: 6528 0a20 2020 2066 696c 656e 616d 653a  e(.    filename:
+0002d6a0: 2073 7472 2c0a 2020 2020 756e 726f 6c6c   str,.    unroll
+0002d6b0: 5f69 6e63 6c75 6465 733a 2062 6f6f 6c20  _includes: bool 
+0002d6c0: 3d20 4661 6c73 652c 0a20 2020 2066 6f72  = False,.    for
+0002d6d0: 5f64 6966 663a 2062 6f6f 6c20 3d20 4661  _diff: bool = Fa
+0002d6e0: 6c73 652c 0a20 2020 2063 6c69 656e 743a  lse,.    client:
+0002d6f0: 204f 7074 696f 6e61 6c5b 5469 6e79 425d   Optional[TinyB]
+0002d700: 203d 204e 6f6e 652c 0a20 2020 2072 6570   = None,.    rep
+0002d710: 6c61 6365 5f69 6e63 6c75 6465 733a 2062  lace_includes: b
+0002d720: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+0002d730: 2064 6174 6166 696c 653a 204f 7074 696f   datafile: Optio
+0002d740: 6e61 6c5b 4461 7461 6669 6c65 5d20 3d20  nal[Datafile] = 
+0002d750: 4e6f 6e65 2c0a 2020 2020 666f 725f 6465  None,.    for_de
+0002d760: 706c 6f79 5f64 6966 663a 2062 6f6f 6c20  ploy_diff: bool 
+0002d770: 3d20 4661 6c73 652c 0a20 2020 2073 6b69  = False,.    ski
+0002d780: 705f 6576 616c 3a20 626f 6f6c 203d 2046  p_eval: bool = F
+0002d790: 616c 7365 2c0a 2920 2d3e 2073 7472 3a0a  alse,.) -> str:.
+0002d7a0: 2020 2020 6966 2064 6174 6166 696c 653a      if datafile:
+0002d7b0: 0a20 2020 2020 2020 2064 6f63 203d 2064  .        doc = d
+0002d7c0: 6174 6166 696c 650a 2020 2020 656c 7365  atafile.    else
+0002d7d0: 3a0a 2020 2020 2020 2020 646f 6320 3d20  :.        doc = 
+0002d7e0: 7061 7273 655f 6461 7461 736f 7572 6365  parse_datasource
+0002d7f0: 2866 696c 656e 616d 652c 2072 6570 6c61  (filename, repla
+0002d800: 6365 5f69 6e63 6c75 6465 733d 7265 706c  ce_includes=repl
+0002d810: 6163 655f 696e 636c 7564 6573 2c20 736b  ace_includes, sk
+0002d820: 6970 5f65 7661 6c3d 736b 6970 5f65 7661  ip_eval=skip_eva
+0002d830: 6c29 0a0a 2020 2020 6669 6c65 5f70 6172  l)..    file_par
+0002d840: 7473 3a20 4c69 7374 5b73 7472 5d20 3d20  ts: List[str] = 
+0002d850: 5b5d 0a20 2020 2069 6620 666f 725f 6469  [].    if for_di
+0002d860: 6666 3a0a 2020 2020 2020 2020 6973 5f6b  ff:.        is_k
+0002d870: 6166 6b61 203d 2022 6b61 666b 615f 636f  afka = "kafka_co
+0002d880: 6e6e 6563 7469 6f6e 5f6e 616d 6522 2069  nnection_name" i
+0002d890: 6e20 646f 632e 6e6f 6465 735b 305d 0a20  n doc.nodes[0]. 
+0002d8a0: 2020 2020 2020 2069 6620 6973 5f6b 6166         if is_kaf
+0002d8b0: 6b61 3a0a 2020 2020 2020 2020 2020 2020  ka:.            
+0002d8c0: 6b61 666b 615f 6d65 7461 6461 7461 5f63  kafka_metadata_c
+0002d8d0: 6f6c 756d 6e73 203d 205b 0a20 2020 2020  olumns = [.     
+0002d8e0: 2020 2020 2020 2020 2020 2022 5f5f 7661             "__va
+0002d8f0: 6c75 6522 2c0a 2020 2020 2020 2020 2020  lue",.          
+0002d900: 2020 2020 2020 225f 5f68 6561 6465 7273        "__headers
+0002d910: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0002d920: 2020 2022 5f5f 746f 7069 6322 2c0a 2020     "__topic",.  
+0002d930: 2020 2020 2020 2020 2020 2020 2020 225f                "_
+0002d940: 5f70 6172 7469 7469 6f6e 222c 0a20 2020  _partition",.   
+0002d950: 2020 2020 2020 2020 2020 2020 2022 5f5f               "__
+0002d960: 6f66 6673 6574 222c 0a20 2020 2020 2020  offset",.       
+0002d970: 2020 2020 2020 2020 2022 5f5f 7469 6d65           "__time
+0002d980: 7374 616d 7022 2c0a 2020 2020 2020 2020  stamp",.        
+0002d990: 2020 2020 2020 2020 225f 5f6b 6579 222c          "__key",
+0002d9a0: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
+0002d9b0: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+0002d9c0: 6e73 203d 205b 6320 666f 7220 6320 696e  ns = [c for c in
+0002d9d0: 2064 6f63 2e6e 6f64 6573 5b30 5d5b 2263   doc.nodes[0]["c
+0002d9e0: 6f6c 756d 6e73 225d 2069 6620 635b 226e  olumns"] if c["n
+0002d9f0: 616d 6522 5d20 6e6f 7420 696e 206b 6166  ame"] not in kaf
+0002da00: 6b61 5f6d 6574 6164 6174 615f 636f 6c75  ka_metadata_colu
+0002da10: 6d6e 735d 0a20 2020 2020 2020 2020 2020  mns].           
+0002da20: 2064 6f63 2e6e 6f64 6573 5b30 5d2e 7570   doc.nodes[0].up
+0002da30: 6461 7465 280a 2020 2020 2020 2020 2020  date(.          
+0002da40: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0002da50: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
+0002da60: 756d 6e73 223a 2063 6f6c 756d 6e73 2c0a  umns": columns,.
+0002da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002da80: 7d0a 2020 2020 2020 2020 2020 2020 290a  }.            ).
+0002da90: 2020 2020 2020 2020 666f 726d 6174 5f76          format_v
+0002daa0: 6572 7369 6f6e 2866 696c 655f 7061 7274  ersion(file_part
+0002dab0: 732c 2064 6f63 290a 2020 2020 2020 2020  s, doc).        
+0002dac0: 6966 2066 6f72 5f64 6570 6c6f 795f 6469  if for_deploy_di
+0002dad0: 6666 3a0a 2020 2020 2020 2020 2020 2020  ff:.            
+0002dae0: 666f 726d 6174 5f64 6573 6372 6970 7469  format_descripti
+0002daf0: 6f6e 2866 696c 655f 7061 7274 732c 2064  on(file_parts, d
+0002db00: 6f63 290a 2020 2020 2020 2020 666f 726d  oc).        form
+0002db10: 6174 5f74 6f6b 656e 7328 6669 6c65 5f70  at_tokens(file_p
+0002db20: 6172 7473 2c20 646f 6329 0a20 2020 2020  arts, doc).     
+0002db30: 2020 2066 6f72 6d61 745f 7363 6865 6d61     format_schema
+0002db40: 2866 696c 655f 7061 7274 732c 2064 6f63  (file_parts, doc
+0002db50: 2e6e 6f64 6573 5b30 5d29 0a20 2020 2020  .nodes[0]).     
+0002db60: 2020 2066 6f72 6d61 745f 696e 6469 6365     format_indice
+0002db70: 7328 6669 6c65 5f70 6172 7473 2c20 646f  s(file_parts, do
+0002db80: 632e 6e6f 6465 735b 305d 290a 2020 2020  c.nodes[0]).    
+0002db90: 2020 2020 6177 6169 7420 666f 726d 6174      await format
+0002dba0: 5f65 6e67 696e 6528 6669 6c65 5f70 6172  _engine(file_par
+0002dbb0: 7473 2c20 646f 632e 6e6f 6465 735b 305d  ts, doc.nodes[0]
+0002dbc0: 2c20 6f6e 6c79 5f74 746c 3d54 7275 6520  , only_ttl=True 
+0002dbd0: 6966 206e 6f74 2066 6f72 5f64 6570 6c6f  if not for_deplo
+0002dbe0: 795f 6469 6666 2065 6c73 6520 4661 6c73  y_diff else Fals
+0002dbf0: 652c 2063 6c69 656e 743d 636c 6965 6e74  e, client=client
+0002dc00: 290a 2020 2020 2020 2020 6966 2066 6f72  ).        if for
+0002dc10: 5f64 6570 6c6f 795f 6469 6666 3a0a 2020  _deploy_diff:.  
+0002dc20: 2020 2020 2020 2020 2020 666f 726d 6174            format
+0002dc30: 5f69 6d70 6f72 745f 7365 7474 696e 6773  _import_settings
+0002dc40: 2866 696c 655f 7061 7274 732c 2064 6f63  (file_parts, doc
+0002dc50: 2e6e 6f64 6573 5b30 5d29 0a20 2020 2020  .nodes[0]).     
+0002dc60: 2020 2066 6f72 6d61 745f 7368 6172 6564     format_shared
+0002dc70: 5f77 6974 6828 6669 6c65 5f70 6172 7473  _with(file_parts
+0002dc80: 2c20 646f 6329 0a0a 2020 2020 656c 7365  , doc)..    else
+0002dc90: 3a0a 2020 2020 2020 2020 666f 726d 6174  :.        format
+0002dca0: 5f73 6f75 7263 6573 2866 696c 655f 7061  _sources(file_pa
+0002dcb0: 7274 732c 2064 6f63 290a 2020 2020 2020  rts, doc).      
+0002dcc0: 2020 666f 726d 6174 5f6d 6169 6e74 6169    format_maintai
+0002dcd0: 6e65 7228 6669 6c65 5f70 6172 7473 2c20  ner(file_parts, 
+0002dce0: 646f 6329 0a20 2020 2020 2020 2066 6f72  doc).        for
+0002dcf0: 6d61 745f 7665 7273 696f 6e28 6669 6c65  mat_version(file
+0002dd00: 5f70 6172 7473 2c20 646f 6329 0a20 2020  _parts, doc).   
+0002dd10: 2020 2020 2066 6f72 6d61 745f 6465 7363       format_desc
+0002dd20: 7269 7074 696f 6e28 6669 6c65 5f70 6172  ription(file_par
+0002dd30: 7473 2c20 646f 6329 0a20 2020 2020 2020  ts, doc).       
+0002dd40: 2066 6f72 6d61 745f 746f 6b65 6e73 2866   format_tokens(f
+0002dd50: 696c 655f 7061 7274 732c 2064 6f63 290a  ile_parts, doc).
+0002dd60: 2020 2020 2020 2020 666f 726d 6174 5f73          format_s
+0002dd70: 6368 656d 6128 6669 6c65 5f70 6172 7473  chema(file_parts
+0002dd80: 2c20 646f 632e 6e6f 6465 735b 305d 290a  , doc.nodes[0]).
+0002dd90: 2020 2020 2020 2020 666f 726d 6174 5f69          format_i
+0002dda0: 6e64 6963 6573 2866 696c 655f 7061 7274  ndices(file_part
+0002ddb0: 732c 2064 6f63 2e6e 6f64 6573 5b30 5d29  s, doc.nodes[0])
+0002ddc0: 0a20 2020 2020 2020 2061 7761 6974 2066  .        await f
+0002ddd0: 6f72 6d61 745f 656e 6769 6e65 2866 696c  ormat_engine(fil
+0002dde0: 655f 7061 7274 732c 2064 6f63 2e6e 6f64  e_parts, doc.nod
+0002ddf0: 6573 5b30 5d29 0a20 2020 2020 2020 2066  es[0]).        f
+0002de00: 6f72 6d61 745f 696e 636c 7564 6528 6669  ormat_include(fi
+0002de10: 6c65 5f70 6172 7473 2c20 646f 632c 2075  le_parts, doc, u
+0002de20: 6e72 6f6c 6c5f 696e 636c 7564 6573 3d75  nroll_includes=u
+0002de30: 6e72 6f6c 6c5f 696e 636c 7564 6573 290a  nroll_includes).
+0002de40: 2020 2020 2020 2020 666f 726d 6174 5f64          format_d
+0002de50: 6174 615f 636f 6e6e 6563 746f 7228 6669  ata_connector(fi
+0002de60: 6c65 5f70 6172 7473 2c20 646f 632e 6e6f  le_parts, doc.no
+0002de70: 6465 735b 305d 290a 2020 2020 2020 2020  des[0]).        
+0002de80: 666f 726d 6174 5f69 6d70 6f72 745f 7365  format_import_se
+0002de90: 7474 696e 6773 2866 696c 655f 7061 7274  ttings(file_part
+0002dea0: 732c 2064 6f63 2e6e 6f64 6573 5b30 5d29  s, doc.nodes[0])
+0002deb0: 0a20 2020 2020 2020 2066 6f72 6d61 745f  .        format_
+0002dec0: 7368 6172 6564 5f77 6974 6828 6669 6c65  shared_with(file
+0002ded0: 5f70 6172 7473 2c20 646f 6329 0a20 2020  _parts, doc).   
+0002dee0: 2072 6573 756c 7420 3d20 2222 2e6a 6f69   result = "".joi
+0002def0: 6e28 6669 6c65 5f70 6172 7473 290a 2020  n(file_parts).  
+0002df00: 2020 7265 7375 6c74 203d 2072 6573 756c    result = resul
+0002df10: 742e 7273 7472 6970 2822 5c6e 2229 202b  t.rstrip("\n") +
+0002df20: 2022 5c6e 220a 2020 2020 7265 7475 726e   "\n".    return
+0002df30: 2072 6573 756c 740a 0a0a 6465 6620 666f   result...def fo
+0002df40: 726d 6174 5f76 6572 7369 6f6e 2866 696c  rmat_version(fil
+0002df50: 655f 7061 7274 733a 204c 6973 745b 7374  e_parts: List[st
+0002df60: 725d 2c20 646f 633a 2044 6174 6166 696c  r], doc: Datafil
+0002df70: 6529 202d 3e20 4c69 7374 5b73 7472 5d3a  e) -> List[str]:
+0002df80: 0a20 2020 2076 6572 7369 6f6e 203d 2064  .    version = d
+0002df90: 6f63 2e76 6572 7369 6f6e 2069 6620 646f  oc.version if do
+0002dfa0: 632e 7665 7273 696f 6e20 6973 206e 6f74  c.version is not
+0002dfb0: 204e 6f6e 6520 656c 7365 2022 220a 2020   None else "".  
+0002dfc0: 2020 6966 2076 6572 7369 6f6e 2021 3d20    if version != 
+0002dfd0: 2222 3a0a 2020 2020 2020 2020 6669 6c65  "":.        file
+0002dfe0: 5f70 6172 7473 2e61 7070 656e 6428 6622  _parts.append(f"
+0002dff0: 5645 5253 494f 4e20 7b76 6572 7369 6f6e  VERSION {version
+0002e000: 7d22 290a 2020 2020 2020 2020 6669 6c65  }").        file
+0002e010: 5f70 6172 7473 2e61 7070 656e 6428 4441  _parts.append(DA
+0002e020: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
+0002e030: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+0002e040: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
+0002e050: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
+0002e060: 2020 7265 7475 726e 2066 696c 655f 7061    return file_pa
+0002e070: 7274 730a 0a0a 6465 6620 666f 726d 6174  rts...def format
+0002e080: 5f6d 6169 6e74 6169 6e65 7228 6669 6c65  _maintainer(file
+0002e090: 5f70 6172 7473 3a20 4c69 7374 5b73 7472  _parts: List[str
+0002e0a0: 5d2c 2064 6f63 3a20 4461 7461 6669 6c65  ], doc: Datafile
+0002e0b0: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
+0002e0c0: 2020 2020 6d61 696e 7461 696e 6572 203d      maintainer =
+0002e0d0: 2064 6f63 2e6d 6169 6e74 6169 6e65 7220   doc.maintainer 
+0002e0e0: 6966 2064 6f63 2e6d 6169 6e74 6169 6e65  if doc.maintaine
+0002e0f0: 7220 6973 206e 6f74 204e 6f6e 6520 656c  r is not None el
+0002e100: 7365 2022 220a 2020 2020 6966 206d 6169  se "".    if mai
+0002e110: 6e74 6169 6e65 723a 0a20 2020 2020 2020  ntainer:.       
+0002e120: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
+0002e130: 6e64 2866 224d 4149 4e54 4149 4e45 5220  nd(f"MAINTAINER 
+0002e140: 7b6d 6169 6e74 6169 6e65 727d 2229 0a20  {maintainer}"). 
+0002e150: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002e160: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
+0002e170: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
+0002e180: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
+0002e190: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
+0002e1a0: 4557 5f4c 494e 4529 0a20 2020 2072 6574  EW_LINE).    ret
+0002e1b0: 7572 6e20 6669 6c65 5f70 6172 7473 0a0a  urn file_parts..
+0002e1c0: 0a64 6566 2066 6f72 6d61 745f 736f 7572  .def format_sour
+0002e1d0: 6365 7328 6669 6c65 5f70 6172 7473 3a20  ces(file_parts: 
+0002e1e0: 4c69 7374 5b73 7472 5d2c 2064 6f63 3a20  List[str], doc: 
+0002e1f0: 4461 7461 6669 6c65 2920 2d3e 204c 6973  Datafile) -> Lis
+0002e200: 745b 7374 725d 3a0a 2020 2020 666f 7220  t[str]:.    for 
+0002e210: 736f 7572 6365 2069 6e20 646f 632e 736f  source in doc.so
+0002e220: 7572 6365 733a 0a20 2020 2020 2020 2066  urces:.        f
+0002e230: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002e240: 2866 2253 4f55 5243 4520 7b73 6f75 7263  (f"SOURCE {sourc
+0002e250: 657d 2229 0a20 2020 2020 2020 2066 696c  e}").        fil
+0002e260: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
+0002e270: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
+0002e280: 290a 2020 2020 7265 7475 726e 2066 696c  ).    return fil
+0002e290: 655f 7061 7274 730a 0a0a 6465 6620 666f  e_parts...def fo
+0002e2a0: 726d 6174 5f64 6573 6372 6970 7469 6f6e  rmat_description
+0002e2b0: 2866 696c 655f 7061 7274 733a 204c 6973  (file_parts: Lis
+0002e2c0: 745b 7374 725d 2c20 646f 633a 2041 6e79  t[str], doc: Any
+0002e2d0: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
+0002e2e0: 2020 2020 6465 7363 7269 7074 696f 6e20      description 
+0002e2f0: 3d20 646f 632e 6465 7363 7269 7074 696f  = doc.descriptio
+0002e300: 6e20 6966 2064 6f63 2e64 6573 6372 6970  n if doc.descrip
+0002e310: 7469 6f6e 2069 7320 6e6f 7420 4e6f 6e65  tion is not None
+0002e320: 2065 6c73 6520 2222 0a20 2020 2069 6620   else "".    if 
+0002e330: 6465 7363 7269 7074 696f 6e3a 0a20 2020  description:.   
+0002e340: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
+0002e350: 6170 7065 6e64 2822 4445 5343 5249 5054  append("DESCRIPT
+0002e360: 494f 4e20 3e22 290a 2020 2020 2020 2020  ION >").        
+0002e370: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
+0002e380: 6428 4441 5441 4649 4c45 5f4e 4557 5f4c  d(DATAFILE_NEW_L
+0002e390: 494e 4529 0a20 2020 2020 2020 205b 6669  INE).        [fi
+0002e3a0: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002e3b0: 6622 7b44 4154 4146 494c 455f 494e 4445  f"{DATAFILE_INDE
+0002e3c0: 4e54 7d7b 642e 7374 7269 7028 297d 5c6e  NT}{d.strip()}\n
+0002e3d0: 2229 2066 6f72 2064 2069 6e20 6465 7363  ") for d in desc
+0002e3e0: 7269 7074 696f 6e2e 7370 6c69 7428 4441  ription.split(DA
+0002e3f0: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
+0002e400: 2069 6620 642e 7374 7269 7028 295d 2020   if d.strip()]  
+0002e410: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+0002e420: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002e430: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
+0002e440: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
+0002e450: 7265 7475 726e 2066 696c 655f 7061 7274  return file_part
+0002e460: 730a 0a0a 6465 6620 666f 726d 6174 5f74  s...def format_t
+0002e470: 6f6b 656e 7328 6669 6c65 5f70 6172 7473  okens(file_parts
+0002e480: 3a20 4c69 7374 5b73 7472 5d2c 2064 6f63  : List[str], doc
+0002e490: 3a20 4461 7461 6669 6c65 2920 2d3e 204c  : Datafile) -> L
+0002e4a0: 6973 745b 7374 725d 3a0a 2020 2020 666f  ist[str]:.    fo
+0002e4b0: 7220 746f 6b65 6e20 696e 2064 6f63 2e74  r token in doc.t
+0002e4c0: 6f6b 656e 733a 0a20 2020 2020 2020 2066  okens:.        f
+0002e4d0: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002e4e0: 2866 2754 4f4b 454e 2022 7b74 6f6b 656e  (f'TOKEN "{token
+0002e4f0: 5b22 746f 6b65 6e5f 6e61 6d65 225d 7d22  ["token_name"]}"
+0002e500: 207b 746f 6b65 6e5b 2270 6572 6d69 7373   {token["permiss
+0002e510: 696f 6e73 225d 7d27 290a 2020 2020 2020  ions"]}').      
+0002e520: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002e530: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
+0002e540: 5f4c 494e 4529 0a20 2020 2069 6620 6c65  _LINE).    if le
+0002e550: 6e28 646f 632e 746f 6b65 6e73 293a 0a20  n(doc.tokens):. 
+0002e560: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002e570: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
+0002e580: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
+0002e590: 7265 7475 726e 2066 696c 655f 7061 7274  return file_part
+0002e5a0: 730a 0a0a 6465 6620 666f 726d 6174 5f6e  s...def format_n
+0002e5b0: 6f64 655f 7371 6c28 0a20 2020 2066 696c  ode_sql(.    fil
+0002e5c0: 655f 7061 7274 733a 204c 6973 745b 7374  e_parts: List[st
+0002e5d0: 725d 2c20 6e6f 6465 3a20 4469 6374 5b73  r], node: Dict[s
+0002e5e0: 7472 2c20 416e 795d 2c20 6c69 6e65 5f6c  tr, Any], line_l
+0002e5f0: 656e 6774 683a 204f 7074 696f 6e61 6c5b  ength: Optional[
+0002e600: 696e 745d 203d 204e 6f6e 652c 206c 6f77  int] = None, low
+0002e610: 6572 5f6b 6579 776f 7264 733a 2062 6f6f  er_keywords: boo
+0002e620: 6c20 3d20 4661 6c73 650a 2920 2d3e 204c  l = False.) -> L
+0002e630: 6973 745b 7374 725d 3a0a 2020 2020 6669  ist[str]:.    fi
+0002e640: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002e650: 2253 514c 203e 2229 0a20 2020 2066 696c  "SQL >").    fil
+0002e660: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
+0002e670: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
+0002e680: 290a 2020 2020 6669 6c65 5f70 6172 7473  ).    file_parts
+0002e690: 2e61 7070 656e 6428 666f 726d 6174 5f73  .append(format_s
+0002e6a0: 716c 286e 6f64 655b 2273 716c 225d 2c20  ql(node["sql"], 
+0002e6b0: 4441 5441 4649 4c45 5f49 4e44 454e 542c  DATAFILE_INDENT,
+0002e6c0: 206c 696e 655f 6c65 6e67 7468 3d6c 696e   line_length=lin
+0002e6d0: 655f 6c65 6e67 7468 2c20 6c6f 7765 725f  e_length, lower_
+0002e6e0: 6b65 7977 6f72 6473 3d6c 6f77 6572 5f6b  keywords=lower_k
+0002e6f0: 6579 776f 7264 7329 290a 2020 2020 6669  eywords)).    fi
+0002e700: 6c65 5f70 6172 7473 2e61 7070 656e 6428  le_parts.append(
+0002e710: 4441 5441 4649 4c45 5f4e 4557 5f4c 494e  DATAFILE_NEW_LIN
+0002e720: 4529 0a20 2020 2066 696c 655f 7061 7274  E).    file_part
+0002e730: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
+0002e740: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
+0002e750: 7265 7475 726e 2066 696c 655f 7061 7274  return file_part
+0002e760: 730a 0a0a 6465 6620 666f 726d 6174 5f73  s...def format_s
+0002e770: 6861 7265 645f 7769 7468 2866 696c 655f  hared_with(file_
+0002e780: 7061 7274 733a 204c 6973 745b 7374 725d  parts: List[str]
+0002e790: 2c20 646f 633a 2044 6174 6166 696c 6529  , doc: Datafile)
+0002e7a0: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
+0002e7b0: 2020 2069 6620 646f 632e 7368 6172 6564     if doc.shared
+0002e7c0: 5f77 6974 683a 0a20 2020 2020 2020 2066  _with:.        f
+0002e7d0: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002e7e0: 2822 5348 4152 4544 5f57 4954 4820 3e22  ("SHARED_WITH >"
+0002e7f0: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
+0002e800: 6172 7473 2e61 7070 656e 6428 4441 5441  arts.append(DATA
+0002e810: 4649 4c45 5f4e 4557 5f4c 494e 4529 0a20  FILE_NEW_LINE). 
+0002e820: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002e830: 732e 6170 7065 6e64 2822 5c6e 222e 6a6f  s.append("\n".jo
+0002e840: 696e 285b 6622 7b44 4154 4146 494c 455f  in([f"{DATAFILE_
+0002e850: 494e 4445 4e54 7d7b 776f 726b 7370 6163  INDENT}{workspac
+0002e860: 655f 6e61 6d65 7d22 2066 6f72 2077 6f72  e_name}" for wor
+0002e870: 6b73 7061 6365 5f6e 616d 6520 696e 2064  kspace_name in d
+0002e880: 6f63 2e73 6861 7265 645f 7769 7468 5d29  oc.shared_with])
+0002e890: 290a 2020 2020 7265 7475 726e 2066 696c  ).    return fil
+0002e8a0: 655f 7061 7274 730a 0a0a 6173 796e 6320  e_parts...async 
+0002e8b0: 6465 6620 666f 726d 6174 5f65 6e67 696e  def format_engin
+0002e8c0: 6528 0a20 2020 2066 696c 655f 7061 7274  e(.    file_part
+0002e8d0: 733a 204c 6973 745b 7374 725d 2c20 6e6f  s: List[str], no
+0002e8e0: 6465 3a20 4469 6374 5b73 7472 2c20 416e  de: Dict[str, An
+0002e8f0: 795d 2c20 6f6e 6c79 5f74 746c 3a20 626f  y], only_ttl: bo
+0002e900: 6f6c 203d 2046 616c 7365 2c20 636c 6965  ol = False, clie
+0002e910: 6e74 3a20 4f70 7469 6f6e 616c 5b54 696e  nt: Optional[Tin
+0002e920: 7942 5d20 3d20 4e6f 6e65 0a29 202d 3e20  yB] = None.) -> 
+0002e930: 4c69 7374 5b73 7472 5d3a 0a20 2020 2069  List[str]:.    i
+0002e940: 6620 6f6e 6c79 5f74 746c 3a0a 2020 2020  f only_ttl:.    
+0002e950: 2020 2020 6966 206e 6f64 652e 6765 7428      if node.get(
+0002e960: 2265 6e67 696e 6522 2c20 4e6f 6e65 293a  "engine", None):
+0002e970: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0002e980: 2061 7267 2069 6e20 736f 7274 6564 286e   arg in sorted(n
+0002e990: 6f64 655b 2265 6e67 696e 6522 5d2e 6765  ode["engine"].ge
+0002e9a0: 7428 2261 7267 7322 2c20 5b5d 2929 3a0a  t("args", [])):.
+0002e9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e9c0: 6966 2061 7267 5b30 5d2e 7570 7065 7228  if arg[0].upper(
+0002e9d0: 2920 3d3d 2022 5454 4c22 3a0a 2020 2020  ) == "TTL":.    
+0002e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e9f0: 656c 656d 203d 2022 2c20 222e 6a6f 696e  elem = ", ".join
+0002ea00: 285b 782e 7374 7269 7028 2920 666f 7220  ([x.strip() for 
+0002ea10: 7820 696e 2061 7267 5b31 5d2e 7370 6c69  x in arg[1].spli
+0002ea20: 7428 222c 2229 5d29 0a20 2020 2020 2020  t(",")]).       
+0002ea30: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0002ea40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002ea50: 2020 2020 2020 2020 2020 6966 2063 6c69            if cli
+0002ea60: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
+0002ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ea80: 2074 746c 5f73 716c 203d 2061 7761 6974   ttl_sql = await
+0002ea90: 2063 6c69 656e 742e 7371 6c5f 6765 745f   client.sql_get_
+0002eaa0: 666f 726d 6174 2866 2273 656c 6563 7420  format(f"select 
+0002eab0: 7b65 6c65 6d7d 222c 2077 6974 685f 636c  {elem}", with_cl
+0002eac0: 6963 6b68 6f75 7365 5f66 6f72 6d61 743d  ickhouse_format=
+0002ead0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0002eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eaf0: 2020 666f 726d 6174 7465 645f 7474 6c20    formatted_ttl 
+0002eb00: 3d20 7474 6c5f 7371 6c5b 373a 5d0a 2020  = ttl_sql[7:].  
+0002eb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb20: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb40: 2020 2020 2020 2020 666f 726d 6174 7465          formatte
+0002eb50: 645f 7474 6c20 3d20 656c 656d 0a20 2020  d_ttl = elem.   
+0002eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb70: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0002eb80: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0002eb90: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+0002eba0: 7474 6564 5f74 746c 203d 2065 6c65 6d0a  tted_ttl = elem.
+0002ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ebc0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
+0002ebd0: 7070 656e 6428 6622 454e 4749 4e45 5f7b  ppend(f"ENGINE_{
+0002ebe0: 6172 675b 305d 2e75 7070 6572 2829 7d20  arg[0].upper()} 
+0002ebf0: 7b66 6f72 6d61 7474 6564 5f74 746c 7d22  {formatted_ttl}"
+0002ec00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002ec10: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
+0002ec20: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
+0002ec30: 5f4e 4557 5f4c 494e 4529 0a20 2020 2020  _NEW_LINE).     
+0002ec40: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002ec50: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
+0002ec60: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
+0002ec70: 2020 2020 7265 7475 726e 2066 696c 655f      return file_
+0002ec80: 7061 7274 730a 2020 2020 656c 7365 3a0a  parts.    else:.
+0002ec90: 2020 2020 2020 2020 6966 206e 6f64 652e          if node.
+0002eca0: 6765 7428 2265 6e67 696e 6522 2c20 4e6f  get("engine", No
+0002ecb0: 6e65 293a 0a20 2020 2020 2020 2020 2020  ne):.           
+0002ecc0: 2065 6d70 7479 203d 2027 2222 270a 2020   empty = '""'.  
+0002ecd0: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
+0002ece0: 6172 7473 2e61 7070 656e 6428 6627 454e  arts.append(f'EN
+0002ecf0: 4749 4e45 207b 6e6f 6465 5b22 656e 6769  GINE {node["engi
+0002ed00: 6e65 225d 5b22 7479 7065 225d 7d27 2069  ne"]["type"]}' i
+0002ed10: 6620 6e6f 6465 2e67 6574 2822 656e 6769  f node.get("engi
+0002ed20: 6e65 222c 207b 7d29 2e67 6574 2822 7479  ne", {}).get("ty
+0002ed30: 7065 2229 2065 6c73 6520 656d 7074 7929  pe") else empty)
+0002ed40: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+0002ed50: 655f 7061 7274 732e 6170 7065 6e64 2844  e_parts.append(D
+0002ed60: 4154 4146 494c 455f 4e45 575f 4c49 4e45  ATAFILE_NEW_LINE
+0002ed70: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0002ed80: 7220 6172 6720 696e 2073 6f72 7465 6428  r arg in sorted(
+0002ed90: 6e6f 6465 5b22 656e 6769 6e65 225d 2e67  node["engine"].g
+0002eda0: 6574 2822 6172 6773 222c 205b 5d29 293a  et("args", [])):
+0002edb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002edc0: 2065 6c65 6d20 3d20 222c 2022 2e6a 6f69   elem = ", ".joi
+0002edd0: 6e28 5b78 2e73 7472 6970 2829 2066 6f72  n([x.strip() for
+0002ede0: 2078 2069 6e20 6172 675b 315d 2e73 706c   x in arg[1].spl
+0002edf0: 6974 2822 2c22 295d 290a 2020 2020 2020  it(",")]).      
+0002ee00: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
+0002ee10: 6172 7473 2e61 7070 656e 6428 6622 454e  arts.append(f"EN
+0002ee20: 4749 4e45 5f7b 6172 675b 305d 2e75 7070  GINE_{arg[0].upp
+0002ee30: 6572 2829 7d20 7b65 6c65 6d20 6966 2065  er()} {elem if e
+0002ee40: 6c65 6d20 656c 7365 2065 6d70 7479 7d22  lem else empty}"
+0002ee50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002ee60: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002ee70: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
+0002ee80: 5f4c 494e 4529 0a20 2020 2020 2020 2020  _LINE).         
+0002ee90: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
+0002eea0: 7065 6e64 2844 4154 4146 494c 455f 4e45  pend(DATAFILE_NE
+0002eeb0: 575f 4c49 4e45 290a 2020 2020 2020 2020  W_LINE).        
+0002eec0: 7265 7475 726e 2066 696c 655f 7061 7274  return file_part
+0002eed0: 730a 0a0a 6173 796e 6320 6465 6620 666f  s...async def fo
+0002eee0: 726d 6174 5f6e 6f64 655f 7479 7065 2866  rmat_node_type(f
+0002eef0: 696c 655f 7061 7274 733a 204c 6973 745b  ile_parts: List[
+0002ef00: 7374 725d 2c20 6e6f 6465 3a20 4469 6374  str], node: Dict
+0002ef10: 5b73 7472 2c20 416e 795d 2920 2d3e 204c  [str, Any]) -> L
+0002ef20: 6973 745b 7374 725d 3a0a 2020 2020 6e6f  ist[str]:.    no
+0002ef30: 6465 5f74 7970 6520 3d20 6e6f 6465 2e67  de_type = node.g
+0002ef40: 6574 2822 7479 7065 222c 2022 2229 2e6c  et("type", "").l
+0002ef50: 6f77 6572 2829 0a20 2020 206e 6f64 655f  ower().    node_
+0002ef60: 7479 7065 5f75 7070 6572 203d 2066 2254  type_upper = f"T
+0002ef70: 5950 4520 7b6e 6f64 655f 7479 7065 2e75  YPE {node_type.u
+0002ef80: 7070 6572 2829 7d22 0a0a 2020 2020 2320  pper()}"..    # 
+0002ef90: 4d61 7465 7269 616c 697a 6564 2070 6970  Materialized pip
+0002efa0: 650a 2020 2020 6966 206e 6f64 655f 7479  e.    if node_ty
+0002efb0: 7065 203d 3d20 5069 7065 4e6f 6465 5479  pe == PipeNodeTy
+0002efc0: 7065 732e 4d41 5445 5249 414c 495a 4544  pes.MATERIALIZED
+0002efd0: 3a0a 2020 2020 2020 2020 6669 6c65 5f70  :.        file_p
+0002efe0: 6172 7473 2e61 7070 656e 6428 6e6f 6465  arts.append(node
+0002eff0: 5f74 7970 655f 7570 7065 7229 0a20 2020  _type_upper).   
+0002f000: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
+0002f010: 6170 7065 6e64 2844 4154 4146 494c 455f  append(DATAFILE_
+0002f020: 4e45 575f 4c49 4e45 290a 2020 2020 2020  NEW_LINE).      
+0002f030: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002f040: 656e 6428 6627 4441 5441 534f 5552 4345  end(f'DATASOURCE
+0002f050: 207b 6e6f 6465 5b22 6461 7461 736f 7572   {node["datasour
+0002f060: 6365 225d 7d27 290a 2020 2020 2020 2020  ce"]}').        
+0002f070: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
+0002f080: 6428 4441 5441 4649 4c45 5f4e 4557 5f4c  d(DATAFILE_NEW_L
+0002f090: 494e 4529 0a20 2020 2020 2020 2061 7761  INE).        awa
+0002f0a0: 6974 2066 6f72 6d61 745f 656e 6769 6e65  it format_engine
+0002f0b0: 2866 696c 655f 7061 7274 732c 206e 6f64  (file_parts, nod
+0002f0c0: 6529 0a0a 2020 2020 2320 436f 7079 2070  e)..    # Copy p
+0002f0d0: 6970 650a 2020 2020 6966 206e 6f64 655f  ipe.    if node_
+0002f0e0: 7479 7065 203d 3d20 5069 7065 4e6f 6465  type == PipeNode
+0002f0f0: 5479 7065 732e 434f 5059 3a0a 2020 2020  Types.COPY:.    
+0002f100: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
+0002f110: 7070 656e 6428 6e6f 6465 5f74 7970 655f  ppend(node_type_
+0002f120: 7570 7065 7229 0a20 2020 2020 2020 2066  upper).        f
+0002f130: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002f140: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
+0002f150: 4e45 290a 2020 2020 2020 2020 6669 6c65  NE).        file
+0002f160: 5f70 6172 7473 2e61 7070 656e 6428 6627  _parts.append(f'
+0002f170: 5441 5247 4554 5f44 4154 4153 4f55 5243  TARGET_DATASOURC
+0002f180: 4520 7b6e 6f64 655b 2274 6172 6765 745f  E {node["target_
+0002f190: 6461 7461 736f 7572 6365 225d 7d27 290a  datasource"]}').
+0002f1a0: 2020 2020 2020 2020 6966 2043 6f70 7950          if CopyP
+0002f1b0: 6172 616d 6574 6572 732e 434f 5059 5f53  arameters.COPY_S
+0002f1c0: 4348 4544 554c 4520 696e 206e 6f64 6520  CHEDULE in node 
+0002f1d0: 616e 6420 6e6f 6465 5b43 6f70 7950 6172  and node[CopyPar
+0002f1e0: 616d 6574 6572 732e 434f 5059 5f53 4348  ameters.COPY_SCH
+0002f1f0: 4544 554c 455d 3a0a 2020 2020 2020 2020  EDULE]:.        
+0002f200: 2020 2020 6973 5f6f 6e64 656d 616e 6420      is_ondemand 
+0002f210: 3d20 6e6f 6465 5b43 6f70 7950 6172 616d  = node[CopyParam
 0002f220: 6574 6572 732e 434f 5059 5f53 4348 4544  eters.COPY_SCHED
-0002f230: 554c 452e 7570 7065 7228 297d 207b 4f4e  ULE.upper()} {ON
-0002f240: 5f44 454d 414e 447d 2229 0a20 2020 2020  _DEMAND}").     
-0002f250: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
-0002f260: 7065 6e64 2844 4154 4146 494c 455f 4e45  pend(DATAFILE_NE
-0002f270: 575f 4c49 4e45 290a 0a20 2020 2023 2053  W_LINE)..    # S
-0002f280: 696e 6b20 7069 7065 0a20 2020 2069 6620  ink pipe.    if 
-0002f290: 4578 706f 7274 5265 706c 6163 656d 656e  ExportReplacemen
-0002f2a0: 7473 2e69 735f 6578 706f 7274 5f6e 6f64  ts.is_export_nod
-0002f2b0: 6528 6e6f 6465 293a 0a20 2020 2020 2020  e(node):.       
-0002f2c0: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
-0002f2d0: 6e64 286e 6f64 655f 7479 7065 5f75 7070  nd(node_type_upp
-0002f2e0: 6572 290a 2020 2020 2020 2020 6578 706f  er).        expo
-0002f2f0: 7274 5f70 6172 616d 7320 3d20 4578 706f  rt_params = Expo
-0002f300: 7274 5265 706c 6163 656d 656e 7473 2e67  rtReplacements.g
-0002f310: 6574 5f70 6172 616d 735f 6672 6f6d 5f64  et_params_from_d
-0002f320: 6174 6166 696c 6528 6e6f 6465 290a 2020  atafile(node).  
-0002f330: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
-0002f340: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
-0002f350: 5f4e 4557 5f4c 494e 4529 0a20 2020 2020  _NEW_LINE).     
-0002f360: 2020 2066 6f72 2070 6172 616d 2c20 7661     for param, va
-0002f370: 6c75 6520 696e 2065 7870 6f72 745f 7061  lue in export_pa
-0002f380: 7261 6d73 2e69 7465 6d73 2829 3a0a 2020  rams.items():.  
-0002f390: 2020 2020 2020 2020 2020 6966 2070 6172            if par
-0002f3a0: 616d 203d 3d20 2273 6368 6564 756c 655f  am == "schedule_
-0002f3b0: 6372 6f6e 2220 616e 6420 6e6f 7420 7661  cron" and not va
-0002f3c0: 6c75 653a 0a20 2020 2020 2020 2020 2020  lue:.           
-0002f3d0: 2020 2020 2076 616c 7565 203d 204f 4e5f       value = ON_
-0002f3e0: 4445 4d41 4e44 0a20 2020 2020 2020 2020  DEMAND.         
-0002f3f0: 2020 2064 6174 6166 696c 655f 6b65 7920     datafile_key 
-0002f400: 3d20 4578 706f 7274 5265 706c 6163 656d  = ExportReplacem
-0002f410: 656e 7473 2e67 6574 5f64 6174 6166 696c  ents.get_datafil
-0002f420: 655f 6b65 7928 7061 7261 6d29 0a20 2020  e_key(param).   
-0002f430: 2020 2020 2020 2020 2069 6620 6461 7461           if data
-0002f440: 6669 6c65 5f6b 6579 3a0a 2020 2020 2020  file_key:.      
-0002f450: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
-0002f460: 6172 7473 2e61 7070 656e 6428 6622 7b64  arts.append(f"{d
-0002f470: 6174 6166 696c 655f 6b65 797d 207b 7661  atafile_key} {va
-0002f480: 6c75 657d 2229 0a20 2020 2020 2020 2020  lue}").         
-0002f490: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-0002f4a0: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
-0002f4b0: 455f 4e45 575f 4c49 4e45 290a 0a20 2020  E_NEW_LINE)..   
-0002f4c0: 2072 6574 7572 6e20 6669 6c65 5f70 6172   return file_par
-0002f4d0: 7473 0a0a 0a64 6566 2066 6f72 6d61 745f  ts...def format_
-0002f4e0: 7069 7065 5f69 6e63 6c75 6465 2866 696c  pipe_include(fil
-0002f4f0: 655f 7061 7274 733a 204c 6973 745b 7374  e_parts: List[st
-0002f500: 725d 2c20 6e6f 6465 3a20 4469 6374 5b73  r], node: Dict[s
-0002f510: 7472 2c20 416e 795d 2c20 696e 636c 7564  tr, Any], includ
-0002f520: 6573 3a20 4469 6374 5b73 7472 2c20 416e  es: Dict[str, An
-0002f530: 795d 2920 2d3e 204c 6973 745b 7374 725d  y]) -> List[str]
-0002f540: 3a0a 2020 2020 6966 2069 6e63 6c75 6465  :.    if include
-0002f550: 733a 0a20 2020 2020 2020 2066 6f72 206b  s:.        for k
-0002f560: 2c20 7620 696e 2069 6e63 6c75 6465 732e  , v in includes.
-0002f570: 636f 7079 2829 2e69 7465 6d73 2829 3a0a  copy().items():.
-0002f580: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002f590: 6f64 655b 226e 616d 6522 5d20 696e 2076  ode["name"] in v
-0002f5a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f5b0: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
-0002f5c0: 656e 6428 6622 494e 434c 5544 4520 7b6b  end(f"INCLUDE {k
-0002f5d0: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
-0002f5e0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
-0002f5f0: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
-0002f600: 4557 5f4c 494e 4529 0a20 2020 2020 2020  EW_LINE).       
-0002f610: 2020 2020 2020 2020 2066 696c 655f 7061           file_pa
-0002f620: 7274 732e 6170 7065 6e64 2844 4154 4146  rts.append(DATAF
-0002f630: 494c 455f 4e45 575f 4c49 4e45 290a 2020  ILE_NEW_LINE).  
-0002f640: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0002f650: 6c20 696e 636c 7564 6573 5b6b 5d0a 2020  l includes[k].  
-0002f660: 2020 7265 7475 726e 2066 696c 655f 7061    return file_pa
-0002f670: 7274 730a 0a0a 6173 796e 6320 6465 6620  rts...async def 
-0002f680: 666f 726d 6174 5f6e 6f64 6528 0a20 2020  format_node(.   
-0002f690: 2066 696c 655f 7061 7274 733a 204c 6973   file_parts: Lis
-0002f6a0: 745b 7374 725d 2c0a 2020 2020 6e6f 6465  t[str],.    node
-0002f6b0: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
-0002f6c0: 2c0a 2020 2020 696e 636c 7564 6573 3a20  ,.    includes: 
-0002f6d0: 4469 6374 5b73 7472 2c20 416e 795d 2c0a  Dict[str, Any],.
-0002f6e0: 2020 2020 6c69 6e65 5f6c 656e 6774 683a      line_length:
-0002f6f0: 204f 7074 696f 6e61 6c5b 696e 745d 203d   Optional[int] =
-0002f700: 204e 6f6e 652c 0a20 2020 2075 6e72 6f6c   None,.    unrol
-0002f710: 6c5f 696e 636c 7564 6573 3a20 626f 6f6c  l_includes: bool
-0002f720: 203d 2046 616c 7365 2c0a 2020 2020 6c6f   = False,.    lo
-0002f730: 7765 725f 6b65 7977 6f72 6473 3a20 626f  wer_keywords: bo
-0002f740: 6f6c 203d 2046 616c 7365 2c0a 2920 2d3e  ol = False,.) ->
-0002f750: 204e 6f6e 653a 0a20 2020 2069 6620 6e6f   None:.    if no
-0002f760: 7420 756e 726f 6c6c 5f69 6e63 6c75 6465  t unroll_include
-0002f770: 733a 0a20 2020 2020 2020 2066 6f72 6d61  s:.        forma
-0002f780: 745f 7069 7065 5f69 6e63 6c75 6465 2866  t_pipe_include(f
-0002f790: 696c 655f 7061 7274 732c 206e 6f64 652c  ile_parts, node,
-0002f7a0: 2069 6e63 6c75 6465 7329 0a20 2020 2069   includes).    i
-0002f7b0: 7465 6d20 3d20 5b6b 2066 6f72 206b 2c20  tem = [k for k, 
-0002f7c0: 5f20 696e 2069 6e63 6c75 6465 732e 6974  _ in includes.it
-0002f7d0: 656d 7328 2920 6966 206e 6f64 655b 226e  ems() if node["n
-0002f7e0: 616d 6522 5d2e 7374 7269 7028 2920 696e  ame"].strip() in
-0002f7f0: 206b 5d0a 2020 2020 6966 2069 7465 6d20   k].    if item 
-0002f800: 616e 6420 6e6f 7420 756e 726f 6c6c 5f69  and not unroll_i
-0002f810: 6e63 6c75 6465 733a 0a20 2020 2020 2020  ncludes:.       
-0002f820: 2072 6574 7572 6e0a 0a20 2020 2066 696c   return..    fil
-0002f830: 655f 7061 7274 732e 6170 7065 6e64 2866  e_parts.append(f
-0002f840: 274e 4f44 4520 7b6e 6f64 655b 226e 616d  'NODE {node["nam
-0002f850: 6522 5d2e 7374 7269 7028 297d 2729 0a20  e"].strip()}'). 
-0002f860: 2020 2066 696c 655f 7061 7274 732e 6170     file_parts.ap
-0002f870: 7065 6e64 2844 4154 4146 494c 455f 4e45  pend(DATAFILE_NE
-0002f880: 575f 4c49 4e45 290a 0a20 2020 2066 726f  W_LINE)..    fro
-0002f890: 6d20 636f 6c6c 6563 7469 6f6e 7320 696d  m collections im
-0002f8a0: 706f 7274 206e 616d 6564 7475 706c 650a  port namedtuple.
-0002f8b0: 0a20 2020 2044 6f63 203d 206e 616d 6564  .    Doc = named
-0002f8c0: 7475 706c 6528 2244 6f63 222c 205b 2264  tuple("Doc", ["d
-0002f8d0: 6573 6372 6970 7469 6f6e 225d 290a 2020  escription"]).  
-0002f8e0: 2020 666f 726d 6174 5f64 6573 6372 6970    format_descrip
-0002f8f0: 7469 6f6e 2866 696c 655f 7061 7274 732c  tion(file_parts,
-0002f900: 2044 6f63 286e 6f64 652e 6765 7428 2264   Doc(node.get("d
-0002f910: 6573 6372 6970 7469 6f6e 222c 2022 2229  escription", "")
-0002f920: 2929 0a20 2020 2066 6f72 6d61 745f 6e6f  )).    format_no
-0002f930: 6465 5f73 716c 2866 696c 655f 7061 7274  de_sql(file_part
-0002f940: 732c 206e 6f64 652c 206c 696e 655f 6c65  s, node, line_le
-0002f950: 6e67 7468 3d6c 696e 655f 6c65 6e67 7468  ngth=line_length
-0002f960: 2c20 6c6f 7765 725f 6b65 7977 6f72 6473  , lower_keywords
-0002f970: 3d6c 6f77 6572 5f6b 6579 776f 7264 7329  =lower_keywords)
-0002f980: 0a20 2020 2061 7761 6974 2066 6f72 6d61  .    await forma
-0002f990: 745f 6e6f 6465 5f74 7970 6528 6669 6c65  t_node_type(file
-0002f9a0: 5f70 6172 7473 2c20 6e6f 6465 290a 0a0a  _parts, node)...
-0002f9b0: 6173 796e 6320 6465 6620 666f 726d 6174  async def format
-0002f9c0: 5f70 6970 6528 0a20 2020 2066 696c 656e  _pipe(.    filen
-0002f9d0: 616d 653a 2073 7472 2c0a 2020 2020 6c69  ame: str,.    li
-0002f9e0: 6e65 5f6c 656e 6774 683a 204f 7074 696f  ne_length: Optio
-0002f9f0: 6e61 6c5b 696e 745d 2c0a 2020 2020 756e  nal[int],.    un
-0002fa00: 726f 6c6c 5f69 6e63 6c75 6465 733a 2062  roll_includes: b
-0002fa10: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-0002fa20: 2072 6570 6c61 6365 5f69 6e63 6c75 6465   replace_include
-0002fa30: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-0002fa40: 0a20 2020 2064 6174 6166 696c 653a 204f  .    datafile: O
-0002fa50: 7074 696f 6e61 6c5b 4461 7461 6669 6c65  ptional[Datafile
-0002fa60: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 666f  ] = None,.    fo
-0002fa70: 725f 6465 706c 6f79 5f64 6966 663a 2062  r_deploy_diff: b
-0002fa80: 6f6f 6c20 3d20 4661 6c73 652c 0a29 202d  ool = False,.) -
-0002fa90: 3e20 7374 723a 0a20 2020 2069 6620 6461  > str:.    if da
-0002faa0: 7461 6669 6c65 3a0a 2020 2020 2020 2020  tafile:.        
-0002fab0: 646f 6320 3d20 6461 7461 6669 6c65 0a20  doc = datafile. 
-0002fac0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002fad0: 2064 6f63 203d 2070 6172 7365 5f70 6970   doc = parse_pip
-0002fae0: 6528 6669 6c65 6e61 6d65 2c20 7265 706c  e(filename, repl
-0002faf0: 6163 655f 696e 636c 7564 6573 3d72 6570  ace_includes=rep
-0002fb00: 6c61 6365 5f69 6e63 6c75 6465 7329 0a0a  lace_includes)..
-0002fb10: 2020 2020 6669 6c65 5f70 6172 7473 3a20      file_parts: 
-0002fb20: 4c69 7374 5b73 7472 5d20 3d20 5b5d 0a20  List[str] = []. 
-0002fb30: 2020 2066 6f72 6d61 745f 736f 7572 6365     format_source
-0002fb40: 7328 6669 6c65 5f70 6172 7473 2c20 646f  s(file_parts, do
-0002fb50: 6329 0a20 2020 2066 6f72 6d61 745f 6d61  c).    format_ma
-0002fb60: 696e 7461 696e 6572 2866 696c 655f 7061  intainer(file_pa
-0002fb70: 7274 732c 2064 6f63 290a 2020 2020 666f  rts, doc).    fo
-0002fb80: 726d 6174 5f76 6572 7369 6f6e 2866 696c  rmat_version(fil
-0002fb90: 655f 7061 7274 732c 2064 6f63 290a 2020  e_parts, doc).  
-0002fba0: 2020 666f 726d 6174 5f64 6573 6372 6970    format_descrip
-0002fbb0: 7469 6f6e 2866 696c 655f 7061 7274 732c  tion(file_parts,
-0002fbc0: 2064 6f63 290a 2020 2020 666f 726d 6174   doc).    format
-0002fbd0: 5f74 6f6b 656e 7328 6669 6c65 5f70 6172  _tokens(file_par
-0002fbe0: 7473 2c20 646f 6329 0a20 2020 2069 6620  ts, doc).    if 
-0002fbf0: 646f 632e 696e 636c 7564 6573 2061 6e64  doc.includes and
-0002fc00: 206e 6f74 2075 6e72 6f6c 6c5f 696e 636c   not unroll_incl
-0002fc10: 7564 6573 3a0a 2020 2020 2020 2020 666f  udes:.        fo
-0002fc20: 7220 6b20 696e 2064 6f63 2e69 6e63 6c75  r k in doc.inclu
-0002fc30: 6465 733a 0a20 2020 2020 2020 2020 2020  des:.           
-0002fc40: 2023 2057 6520 6669 6c74 6572 206f 6e6c   # We filter onl
-0002fc50: 7920 7468 6520 696e 636c 7564 6520 6669  y the include fi
-0002fc60: 6c65 7320 6173 2077 6520 6375 7272 656e  les as we curren
-0002fc70: 746c 7920 6861 7665 2032 2069 7465 6d73  tly have 2 items
-0002fc80: 2066 6f72 2065 6163 6820 696e 636c 7564   for each includ
-0002fc90: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-0002fca0: 7b20 2769 6e63 6c75 6465 5f66 696c 652e  { 'include_file.
-0002fcb0: 696e 636c 273a 2027 4669 7273 7420 6e6f  incl': 'First no
-0002fcc0: 6465 206f 6620 7468 6520 696e 636c 7564  de of the includ
-0002fcd0: 6522 207d 0a20 2020 2020 2020 2020 2020  e" }.           
-0002fce0: 2023 207b 2027 6669 7273 7420 6e6f 6465   # { 'first node
-0002fcf0: 206f 6620 7468 6520 7069 7065 2061 6674   of the pipe aft
-0002fd00: 6572 2074 6865 2069 6e63 6c75 6465 273a  er the include':
-0002fd10: 207d 0a20 2020 2020 2020 2020 2020 2069   }.            i
-0002fd20: 6620 222e 696e 636c 2220 6e6f 7420 696e  f ".incl" not in
-0002fd30: 206b 3a0a 2020 2020 2020 2020 2020 2020   k:.            
-0002fd40: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-0002fd50: 2020 2020 2020 2020 2020 2320 5765 2067            # We g
-0002fd60: 6574 2061 6c6c 2074 6865 206e 6f64 6573  et all the nodes
-0002fd70: 2069 6e73 6964 6520 7468 6520 696e 636c   inside the incl
-0002fd80: 7564 6520 616e 6420 7265 6d6f 7665 2074  ude and remove t
-0002fd90: 6865 6d20 6672 6f6d 2074 6865 2075 6e72  hem from the unr
-0002fda0: 6f6c 6c65 6420 7069 7065 2061 7320 7765  olled pipe as we
-0002fdb0: 2077 616e 7420 7468 696e 6773 2075 6e72   want things unr
-0002fdc0: 6f6c 6c65 640a 2020 2020 2020 2020 2020  olled.          
-0002fdd0: 2020 696e 636c 7564 655f 7061 7261 6d65    include_parame
-0002fde0: 7465 7273 203d 205f 756e 7175 6f74 6528  ters = _unquote(
-0002fdf0: 6b29 0a0a 2020 2020 2020 2020 2020 2020  k)..            
-0002fe00: 2320 4966 2074 6865 7920 7573 6520 616e  # If they use an
-0002fe10: 2069 6e63 6c75 6465 2077 6974 6820 7061   include with pa
-0002fe20: 7261 6d65 7465 7273 206c 696b 6520 6049  rameters like `I
-0002fe30: 4e43 4c55 4445 2022 7878 782e 696e 636c  NCLUDE "xxx.incl
-0002fe40: 2220 2247 524f 5550 5f43 4f4c 3d70 6174  " "GROUP_COL=pat
-0002fe50: 6822 2022 4d41 5445 5249 414c 495a 4544  h" "MATERIALIZED
-0002fe60: 5f56 4945 573d 7370 6565 645f 696e 7369  _VIEW=speed_insi
-0002fe70: 6768 7473 5f70 6174 685f 6461 696c 795f  ghts_path_daily_
-0002fe80: 6d76 2260 600a 2020 2020 2020 2020 2020  mv"``.          
-0002fe90: 2020 2320 5765 206a 7573 7420 7761 6e74    # We just want
-0002fea0: 2074 6865 2066 696c 6520 6e61 6d65 2074   the file name t
-0002feb0: 6f20 7461 6b65 206e 6f64 6573 0a20 2020  o take nodes.   
-0002fec0: 2020 2020 2020 2020 2069 6e63 6c75 6465           include
-0002fed0: 5f66 696c 6520 3d20 696e 636c 7564 655f  _file = include_
-0002fee0: 7061 7261 6d65 7465 7273 2e73 706c 6974  parameters.split
-0002fef0: 2827 2227 295b 305d 0a20 2020 2020 2020  ('"')[0].       
-0002ff00: 2020 2020 2069 6e63 6c75 6465 5f66 696c       include_fil
-0002ff10: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
-0002ff20: 2020 2020 2020 5061 7468 286f 732e 7061        Path(os.pa
-0002ff30: 7468 2e64 6972 6e61 6d65 2866 696c 656e  th.dirname(filen
-0002ff40: 616d 6529 2920 2f20 6576 616c 5f76 6172  ame)) / eval_var
-0002ff50: 2869 6e63 6c75 6465 5f66 696c 6529 0a20  (include_file). 
-0002ff60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002ff70: 6620 222e 2220 696e 2069 6e63 6c75 6465  f "." in include
-0002ff80: 5f66 696c 650a 2020 2020 2020 2020 2020  _file.          
-0002ff90: 2020 2020 2020 656c 7365 2065 7661 6c5f        else eval_
-0002ffa0: 7661 7228 696e 636c 7564 655f 6669 6c65  var(include_file
-0002ffb0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0002ffc0: 2020 2020 2020 2020 2020 2020 696e 636c              incl
-0002ffd0: 7564 6564 5f70 6970 6520 3d20 7061 7273  uded_pipe = pars
-0002ffe0: 655f 7069 7065 2869 6e63 6c75 6465 5f66  e_pipe(include_f
-0002fff0: 696c 6529 0a20 2020 2020 2020 2020 2020  ile).           
-00030000: 2070 6970 655f 6e6f 6465 7320 3d20 646f   pipe_nodes = do
-00030010: 632e 6e6f 6465 732e 636f 7079 2829 0a20  c.nodes.copy(). 
-00030020: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00030030: 6e63 6c75 6465 645f 6e6f 6465 2069 6e20  ncluded_node in 
-00030040: 696e 636c 7564 6564 5f70 6970 652e 6e6f  included_pipe.no
-00030050: 6465 732e 636f 7079 2829 3a0a 2020 2020  des.copy():.    
-00030060: 2020 2020 2020 2020 2020 2020 756e 726f              unro
-00030070: 6c6c 6564 5f69 6e63 6c75 6465 645f 6e6f  lled_included_no
-00030080: 6465 203d 206e 6578 7428 0a20 2020 2020  de = next(.     
-00030090: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000300a0: 6e6f 6465 2066 6f72 206e 6f64 6520 696e  node for node in
-000300b0: 2070 6970 655f 6e6f 6465 7320 6966 206e   pipe_nodes if n
-000300c0: 6f64 655b 226e 616d 6522 5d20 3d3d 2069  ode["name"] == i
-000300d0: 6e63 6c75 6465 645f 6e6f 6465 5b22 6e61  ncluded_node["na
-000300e0: 6d65 225d 292c 204e 6f6e 650a 2020 2020  me"]), None.    
-000300f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00030100: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00030110: 2075 6e72 6f6c 6c65 645f 696e 636c 7564   unrolled_includ
-00030120: 6564 5f6e 6f64 653a 0a20 2020 2020 2020  ed_node:.       
-00030130: 2020 2020 2020 2020 2020 2020 2064 6f63               doc
-00030140: 2e6e 6f64 6573 2e72 656d 6f76 6528 756e  .nodes.remove(un
-00030150: 726f 6c6c 6564 5f69 6e63 6c75 6465 645f  rolled_included_
-00030160: 6e6f 6465 290a 2020 2020 666f 7220 6e6f  node).    for no
-00030170: 6465 2069 6e20 646f 632e 6e6f 6465 733a  de in doc.nodes:
-00030180: 0a20 2020 2020 2020 2061 7761 6974 2066  .        await f
-00030190: 6f72 6d61 745f 6e6f 6465 280a 2020 2020  ormat_node(.    
-000301a0: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
-000301b0: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
-000301c0: 6e6f 6465 2c0a 2020 2020 2020 2020 2020  node,.          
-000301d0: 2020 646f 632e 696e 636c 7564 6573 2c0a    doc.includes,.
-000301e0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-000301f0: 5f6c 656e 6774 683d 6c69 6e65 5f6c 656e  _length=line_len
-00030200: 6774 682c 0a20 2020 2020 2020 2020 2020  gth,.           
-00030210: 2075 6e72 6f6c 6c5f 696e 636c 7564 6573   unroll_includes
-00030220: 3d75 6e72 6f6c 6c5f 696e 636c 7564 6573  =unroll_includes
-00030230: 2c0a 2020 2020 2020 2020 2020 2020 6c6f  ,.            lo
-00030240: 7765 725f 6b65 7977 6f72 6473 3d54 7275  wer_keywords=Tru
-00030250: 6520 6966 2066 6f72 5f64 6570 6c6f 795f  e if for_deploy_
-00030260: 6469 6666 2065 6c73 6520 4661 6c73 652c  diff else False,
-00030270: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00030280: 6966 206e 6f74 2075 6e72 6f6c 6c5f 696e  if not unroll_in
-00030290: 636c 7564 6573 3a0a 2020 2020 2020 2020  cludes:.        
-000302a0: 666f 7220 6b2c 205f 2069 6e20 646f 632e  for k, _ in doc.
-000302b0: 696e 636c 7564 6573 2e69 7465 6d73 2829  includes.items()
-000302c0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000302d0: 2022 2e69 6e63 6c22 206e 6f74 2069 6e20   ".incl" not in 
-000302e0: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
-000302f0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-00030300: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
-00030310: 7473 2e61 7070 656e 6428 6622 494e 434c  ts.append(f"INCL
-00030320: 5544 4520 7b6b 7d22 290a 2020 2020 2020  UDE {k}").      
-00030330: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
-00030340: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
-00030350: 5f4e 4557 5f4c 494e 4529 0a20 2020 2020  _NEW_LINE).     
-00030360: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
-00030370: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
-00030380: 455f 4e45 575f 4c49 4e45 290a 0a20 2020  E_NEW_LINE)..   
-00030390: 2072 6573 756c 7420 3d20 2222 2e6a 6f69   result = "".joi
-000303a0: 6e28 6669 6c65 5f70 6172 7473 290a 2020  n(file_parts).  
-000303b0: 2020 7265 7375 6c74 203d 2072 6573 756c    result = resul
-000303c0: 742e 7273 7472 6970 2822 5c6e 2229 202b  t.rstrip("\n") +
-000303d0: 2022 5c6e 220a 2020 2020 7265 7475 726e   "\n".    return
-000303e0: 2072 6573 756c 740a 0a0a 6465 6620 666f   result...def fo
-000303f0: 726d 6174 5f73 716c 2873 716c 3a20 7374  rmat_sql(sql: st
-00030400: 722c 2044 4154 4146 494c 455f 494e 4445  r, DATAFILE_INDE
-00030410: 4e54 3a20 7374 722c 206c 696e 655f 6c65  NT: str, line_le
-00030420: 6e67 7468 3a20 4f70 7469 6f6e 616c 5b69  ngth: Optional[i
-00030430: 6e74 5d20 3d20 4e6f 6e65 2c20 6c6f 7765  nt] = None, lowe
-00030440: 725f 6b65 7977 6f72 6473 3a20 626f 6f6c  r_keywords: bool
-00030450: 203d 2046 616c 7365 2920 2d3e 2073 7472   = False) -> str
-00030460: 3a0a 2020 2020 7371 6c20 3d20 666f 726d  :.    sql = form
-00030470: 6174 5f73 716c 5f74 656d 706c 6174 6528  at_sql_template(
-00030480: 7371 6c2e 7374 7269 7028 292c 206c 696e  sql.strip(), lin
-00030490: 655f 6c65 6e67 7468 3d6c 696e 655f 6c65  e_length=line_le
-000304a0: 6e67 7468 2c20 6c6f 7765 725f 6b65 7977  ngth, lower_keyw
-000304b0: 6f72 6473 3d6c 6f77 6572 5f6b 6579 776f  ords=lower_keywo
-000304c0: 7264 7329 0a20 2020 2072 6574 7572 6e20  rds).    return 
-000304d0: 225c 6e22 2e6a 6f69 6e28 5b66 227b 4441  "\n".join([f"{DA
-000304e0: 5441 4649 4c45 5f49 4e44 454e 547d 7b70  TAFILE_INDENT}{p
-000304f0: 6172 747d 2220 666f 7220 7061 7274 2069  art}" for part i
-00030500: 6e20 7371 6c2e 7370 6c69 7428 225c 6e22  n sql.split("\n"
-00030510: 2920 6966 206c 656e 2870 6172 742e 7374  ) if len(part.st
-00030520: 7269 7028 2929 5d29 0a0a 0a61 7379 6e63  rip())])...async
-00030530: 2064 6566 205f 6761 7468 6572 5f77 6974   def _gather_wit
-00030540: 685f 636f 6e63 7572 7265 6e63 7928 6e2c  h_concurrency(n,
-00030550: 202a 7461 736b 7329 3a0a 2020 2020 7365   *tasks):.    se
-00030560: 6d61 7068 6f72 6520 3d20 5365 6d61 7068  maphore = Semaph
-00030570: 6f72 6528 6e29 0a0a 2020 2020 6173 796e  ore(n)..    asyn
-00030580: 6320 6465 6620 7365 6d5f 7461 736b 2874  c def sem_task(t
-00030590: 6173 6b29 3a0a 2020 2020 2020 2020 6173  ask):.        as
-000305a0: 796e 6320 7769 7468 2073 656d 6170 686f  ync with semapho
-000305b0: 7265 3a0a 2020 2020 2020 2020 2020 2020  re:.            
-000305c0: 7265 7475 726e 2061 7761 6974 2074 6173  return await tas
-000305d0: 6b0a 0a20 2020 2072 6574 7572 6e20 6177  k..    return aw
-000305e0: 6169 7420 6761 7468 6572 282a 2873 656d  ait gather(*(sem
-000305f0: 5f74 6173 6b28 7461 736b 2920 666f 7220  _task(task) for 
-00030600: 7461 736b 2069 6e20 7461 736b 7329 290a  task in tasks)).
-00030610: 0a0a 6173 796e 6320 6465 6620 666f 6c64  ..async def fold
-00030620: 6572 5f70 756c 6c28 0a20 2020 2063 6c69  er_pull(.    cli
-00030630: 656e 743a 2054 696e 7942 2c0a 2020 2020  ent: TinyB,.    
-00030640: 666f 6c64 6572 3a20 7374 722c 0a20 2020  folder: str,.   
-00030650: 2061 7574 6f3a 2062 6f6f 6c2c 0a20 2020   auto: bool,.   
-00030660: 206d 6174 6368 3a20 4f70 7469 6f6e 616c   match: Optional
-00030670: 5b73 7472 5d2c 0a20 2020 2066 6f72 6365  [str],.    force
-00030680: 3a20 626f 6f6c 2c0a 2020 2020 7665 7262  : bool,.    verb
-00030690: 6f73 653a 2062 6f6f 6c20 3d20 5472 7565  ose: bool = True
-000306a0: 2c0a 2020 2020 7072 6f67 7265 7373 5f62  ,.    progress_b
-000306b0: 6172 3a20 626f 6f6c 203d 2046 616c 7365  ar: bool = False
-000306c0: 2c0a 293a 2020 2320 6e6f 7161 3a20 4339  ,.):  # noqa: C9
-000306d0: 3031 0a20 2020 2070 6174 7465 726e 203d  01.    pattern =
-000306e0: 2072 652e 636f 6d70 696c 6528 6d61 7463   re.compile(matc
-000306f0: 6829 2069 6620 6d61 7463 6820 656c 7365  h) if match else
-00030700: 204e 6f6e 650a 0a20 2020 2064 6566 205f   None..    def _
-00030710: 6765 745f 6c61 7465 7374 5f76 6572 7369  get_latest_versi
-00030720: 6f6e 7328 7265 736f 7572 6365 733a 204c  ons(resources: L
-00030730: 6973 745b 7374 725d 293a 0a20 2020 2020  ist[str]):.     
-00030740: 2020 2076 6572 7369 6f6e 733a 2044 6963     versions: Dic
-00030750: 745b 7374 722c 2041 6e79 5d20 3d20 7b7d  t[str, Any] = {}
-00030760: 0a0a 2020 2020 2020 2020 666f 7220 7820  ..        for x 
-00030770: 696e 2072 6573 6f75 7263 6573 3a0a 2020  in resources:.  
-00030780: 2020 2020 2020 2020 2020 7420 3d20 6765            t = ge
-00030790: 745f 6e61 6d65 5f76 6572 7369 6f6e 2878  t_name_version(x
-000307a0: 290a 2020 2020 2020 2020 2020 2020 745b  ).            t[
-000307b0: 226f 7269 6769 6e61 6c5f 6e61 6d65 225d  "original_name"]
-000307c0: 203d 2078 0a20 2020 2020 2020 2020 2020   = x.           
-000307d0: 2069 6620 745b 2276 6572 7369 6f6e 225d   if t["version"]
-000307e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000307f0: 2020 2020 2020 2020 2020 745b 2276 6572            t["ver
-00030800: 7369 6f6e 225d 203d 202d 310a 2020 2020  sion"] = -1.    
-00030810: 2020 2020 2020 2020 6e61 6d65 203d 2074          name = t
-00030820: 5b22 6e61 6d65 225d 0a0a 2020 2020 2020  ["name"]..      
-00030830: 2020 2020 2020 6966 206e 616d 6520 6e6f        if name no
-00030840: 7420 696e 2076 6572 7369 6f6e 7320 6f72  t in versions or
-00030850: 206e 616d 6520 3d3d 2078 206f 7220 7665   name == x or ve
-00030860: 7273 696f 6e73 5b6e 616d 655d 5b22 7665  rsions[name]["ve
-00030870: 7273 696f 6e22 5d20 3c20 745b 2276 6572  rsion"] < t["ver
-00030880: 7369 6f6e 225d 3a0a 2020 2020 2020 2020  sion"]:.        
-00030890: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
-000308a0: 5b6e 616d 655d 203d 2074 0a20 2020 2020  [name] = t.     
-000308b0: 2020 2072 6574 7572 6e20 7665 7273 696f     return versio
-000308c0: 6e73 0a0a 2020 2020 6465 6620 6765 745f  ns..    def get_
-000308d0: 6669 6c65 5f66 6f6c 6465 7228 6578 7465  file_folder(exte
-000308e0: 6e73 696f 6e3a 2073 7472 293a 0a20 2020  nsion: str):.   
-000308f0: 2020 2020 2069 6620 6e6f 7420 6175 746f       if not auto
-00030900: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00030910: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
-00030920: 2020 6966 2065 7874 656e 7369 6f6e 203d    if extension =
-00030930: 3d20 2264 6174 6173 6f75 7263 6522 3a0a  = "datasource":.
-00030940: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00030950: 726e 2022 6461 7461 736f 7572 6365 7322  rn "datasources"
-00030960: 0a20 2020 2020 2020 2069 6620 6578 7465  .        if exte
-00030970: 6e73 696f 6e20 3d3d 2022 7069 7065 223a  nsion == "pipe":
-00030980: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00030990: 7572 6e20 2270 6970 6573 220a 2020 2020  urn "pipes".    
-000309a0: 2020 2020 6966 2065 7874 656e 7369 6f6e      if extension
-000309b0: 203d 3d20 2274 6f6b 656e 223a 0a20 2020   == "token":.   
-000309c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000309d0: 2274 6f6b 656e 7322 0a20 2020 2020 2020  "tokens".       
-000309e0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-000309f0: 2020 6173 796e 6320 6465 6620 7772 6974    async def writ
-00030a00: 655f 6669 6c65 7328 0a20 2020 2020 2020  e_files(.       
-00030a10: 2076 6572 7369 6f6e 733a 2044 6963 745b   versions: Dict[
-00030a20: 7374 722c 2041 6e79 5d2c 0a20 2020 2020  str, Any],.     
-00030a30: 2020 2072 6573 6f75 7263 6573 3a20 4c69     resources: Li
-00030a40: 7374 5b73 7472 5d2c 0a20 2020 2020 2020  st[str],.       
-00030a50: 2065 7874 656e 7369 6f6e 3a20 7374 722c   extension: str,
-00030a60: 0a20 2020 2020 2020 2067 6574 5f72 6573  .        get_res
-00030a70: 6f75 7263 655f 6675 6e63 7469 6f6e 3a20  ource_function: 
-00030a80: 7374 722c 0a20 2020 2020 2020 2070 726f  str,.        pro
-00030a90: 6772 6573 735f 6261 723a 2062 6f6f 6c20  gress_bar: bool 
-00030aa0: 3d20 4661 6c73 652c 0a20 2020 2029 3a0a  = False,.    ):.
-00030ab0: 2020 2020 2020 2020 6173 796e 6320 6465          async de
-00030ac0: 6620 7772 6974 655f 7265 736f 7572 6365  f write_resource
-00030ad0: 286b 3a20 4469 6374 5b73 7472 2c20 416e  (k: Dict[str, An
-00030ae0: 795d 293a 0a20 2020 2020 2020 2020 2020  y]):.           
-00030af0: 206e 616d 6520 3d20 6622 7b6b 5b27 6e61   name = f"{k['na
-00030b00: 6d65 275d 7d2e 7b65 7874 656e 7369 6f6e  me']}.{extension
-00030b10: 7d22 0a20 2020 2020 2020 2020 2020 2074  }".            t
-00030b20: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00030b30: 2020 2020 6966 2070 6174 7465 726e 2061      if pattern a
-00030b40: 6e64 206e 6f74 2070 6174 7465 726e 2e73  nd not pattern.s
-00030b50: 6561 7263 6828 6e61 6d65 293a 0a20 2020  earch(name):.   
-00030b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b70: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
-00030b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b90: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
-00030ba0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-00030bb0: 696e 666f 5f73 6b69 7070 696e 675f 7265  info_skipping_re
-00030bc0: 736f 7572 6365 2872 6573 6f75 7263 653d  source(resource=
-00030bd0: 6e61 6d65 2929 0a20 2020 2020 2020 2020  name)).         
-00030be0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00030bf0: 6e0a 0a20 2020 2020 2020 2020 2020 2020  n..             
-00030c00: 2020 2072 6573 6f75 7263 6520 3d20 6177     resource = aw
-00030c10: 6169 7420 6765 7461 7474 7228 636c 6965  ait getattr(clie
-00030c20: 6e74 2c20 6765 745f 7265 736f 7572 6365  nt, get_resource
-00030c30: 5f66 756e 6374 696f 6e29 286b 5b22 6f72  _function)(k["or
-00030c40: 6967 696e 616c 5f6e 616d 6522 5d29 0a0a  iginal_name"])..
-00030c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c60: 6465 7374 5f66 6f6c 6465 7220 3d20 666f  dest_folder = fo
-00030c70: 6c64 6572 0a20 2020 2020 2020 2020 2020  lder.           
-00030c80: 2020 2020 2069 6620 222e 2220 696e 206b       if "." in k
-00030c90: 5b22 6e61 6d65 225d 2061 6e64 2065 7874  ["name"] and ext
-00030ca0: 656e 7369 6f6e 2021 3d20 2274 6f6b 656e  ension != "token
-00030cb0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00030cc0: 2020 2020 2020 2064 6573 745f 666f 6c64         dest_fold
-00030cd0: 6572 203d 2050 6174 6828 666f 6c64 6572  er = Path(folder
-00030ce0: 2920 2f20 2276 656e 646f 7222 202f 206b  ) / "vendor" / k
-00030cf0: 5b22 6e61 6d65 225d 2e73 706c 6974 2822  ["name"].split("
-00030d00: 2e22 2c20 3129 5b30 5d0a 2020 2020 2020  .", 1)[0].      
-00030d10: 2020 2020 2020 2020 2020 2020 2020 6e61                na
-00030d20: 6d65 203d 2066 227b 6b5b 276e 616d 6527  me = f"{k['name'
-00030d30: 5d2e 7370 6c69 7428 272e 272c 2031 295b  ].split('.', 1)[
-00030d40: 315d 7d2e 7b65 7874 656e 7369 6f6e 7d22  1]}.{extension}"
-00030d50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00030d60: 2020 6669 6c65 5f66 6f6c 6465 7220 3d20    file_folder = 
-00030d70: 6765 745f 6669 6c65 5f66 6f6c 6465 7228  get_file_folder(
-00030d80: 6578 7465 6e73 696f 6e29 0a20 2020 2020  extension).     
-00030d90: 2020 2020 2020 2020 2020 2066 203d 2050             f = P
-00030da0: 6174 6828 6465 7374 5f66 6f6c 6465 7229  ath(dest_folder)
-00030db0: 202f 2066 696c 655f 666f 6c64 6572 2069   / file_folder i
-00030dc0: 6620 6669 6c65 5f66 6f6c 6465 7220 6973  f file_folder is
-00030dd0: 206e 6f74 204e 6f6e 6520 656c 7365 2050   not None else P
-00030de0: 6174 6828 6465 7374 5f66 6f6c 6465 7229  ath(dest_folder)
-00030df0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00030e00: 2020 6966 206e 6f74 2066 2e65 7869 7374    if not f.exist
-00030e10: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00030e20: 2020 2020 2020 2020 2066 2e6d 6b64 6972           f.mkdir
-00030e30: 2870 6172 656e 7473 3d54 7275 6529 0a0a  (parents=True)..
-00030e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030e50: 6620 3d20 6620 2f20 6e61 6d65 0a20 2020  f = f / name.   
-00030e60: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00030e70: 6f75 7263 655f 6e61 6d65 7320 3d20 5b78  ource_names = [x
-00030e80: 2e73 706c 6974 2822 2e22 295b 2d31 5d20  .split(".")[-1] 
-00030e90: 666f 7220 7820 696e 2072 6573 6f75 7263  for x in resourc
-00030ea0: 6573 5d0a 0a20 2020 2020 2020 2020 2020  es]..           
-00030eb0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-00030ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030ed0: 2020 2020 2063 6c69 636b 2e65 6368 6f28       click.echo(
-00030ee0: 4665 6564 6261 636b 4d61 6e61 6765 722e  FeedbackManager.
-00030ef0: 696e 666f 5f77 7269 7469 6e67 5f72 6573  info_writing_res
-00030f00: 6f75 7263 6528 7265 736f 7572 6365 3d66  ource(resource=f
-00030f10: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00030f20: 2020 2069 6620 6e6f 7420 662e 6578 6973     if not f.exis
-00030f30: 7473 2829 206f 7220 666f 7263 653a 0a20  ts() or force:. 
+0002f230: 554c 455d 2e6c 6f77 6572 2829 203d 3d20  ULE].lower() == 
+0002f240: 4f4e 5f44 454d 414e 440a 2020 2020 2020  ON_DEMAND.      
+0002f250: 2020 2020 2020 6669 6c65 5f70 6172 7473        file_parts
+0002f260: 2e61 7070 656e 6428 4441 5441 4649 4c45  .append(DATAFILE
+0002f270: 5f4e 4557 5f4c 494e 4529 0a20 2020 2020  _NEW_LINE).     
+0002f280: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002f290: 732e 6170 7065 6e64 280a 2020 2020 2020  s.append(.      
+0002f2a0: 2020 2020 2020 2020 2020 6622 7b43 6f70            f"{Cop
+0002f2b0: 7950 6172 616d 6574 6572 732e 434f 5059  yParameters.COPY
+0002f2c0: 5f53 4348 4544 554c 452e 7570 7065 7228  _SCHEDULE.upper(
+0002f2d0: 297d 207b 4f4e 5f44 454d 414e 4420 6966  )} {ON_DEMAND if
+0002f2e0: 2069 735f 6f6e 6465 6d61 6e64 2065 6c73   is_ondemand els
+0002f2f0: 6520 6e6f 6465 5b43 6f70 7950 6172 616d  e node[CopyParam
+0002f300: 6574 6572 732e 434f 5059 5f53 4348 4544  eters.COPY_SCHED
+0002f310: 554c 455d 7d22 0a20 2020 2020 2020 2020  ULE]}".         
+0002f320: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
+0002f330: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+0002f340: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002f350: 2844 4154 4146 494c 455f 4e45 575f 4c49  (DATAFILE_NEW_LI
+0002f360: 4e45 290a 2020 2020 2020 2020 2020 2020  NE).            
+0002f370: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
+0002f380: 6428 6622 7b43 6f70 7950 6172 616d 6574  d(f"{CopyParamet
+0002f390: 6572 732e 434f 5059 5f53 4348 4544 554c  ers.COPY_SCHEDUL
+0002f3a0: 452e 7570 7065 7228 297d 207b 4f4e 5f44  E.upper()} {ON_D
+0002f3b0: 454d 414e 447d 2229 0a20 2020 2020 2020  EMAND}").       
+0002f3c0: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
+0002f3d0: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
+0002f3e0: 4c49 4e45 290a 0a20 2020 2023 2053 696e  LINE)..    # Sin
+0002f3f0: 6b20 7069 7065 0a20 2020 2069 6620 4578  k pipe.    if Ex
+0002f400: 706f 7274 5265 706c 6163 656d 656e 7473  portReplacements
+0002f410: 2e69 735f 6578 706f 7274 5f6e 6f64 6528  .is_export_node(
+0002f420: 6e6f 6465 293a 0a20 2020 2020 2020 2066  node):.        f
+0002f430: 696c 655f 7061 7274 732e 6170 7065 6e64  ile_parts.append
+0002f440: 286e 6f64 655f 7479 7065 5f75 7070 6572  (node_type_upper
+0002f450: 290a 2020 2020 2020 2020 6578 706f 7274  ).        export
+0002f460: 5f70 6172 616d 7320 3d20 4578 706f 7274  _params = Export
+0002f470: 5265 706c 6163 656d 656e 7473 2e67 6574  Replacements.get
+0002f480: 5f70 6172 616d 735f 6672 6f6d 5f64 6174  _params_from_dat
+0002f490: 6166 696c 6528 6e6f 6465 290a 2020 2020  afile(node).    
+0002f4a0: 2020 2020 6669 6c65 5f70 6172 7473 2e61      file_parts.a
+0002f4b0: 7070 656e 6428 4441 5441 4649 4c45 5f4e  ppend(DATAFILE_N
+0002f4c0: 4557 5f4c 494e 4529 0a20 2020 2020 2020  EW_LINE).       
+0002f4d0: 2066 6f72 2070 6172 616d 2c20 7661 6c75   for param, valu
+0002f4e0: 6520 696e 2065 7870 6f72 745f 7061 7261  e in export_para
+0002f4f0: 6d73 2e69 7465 6d73 2829 3a0a 2020 2020  ms.items():.    
+0002f500: 2020 2020 2020 2020 6966 2070 6172 616d          if param
+0002f510: 203d 3d20 2273 6368 6564 756c 655f 6372   == "schedule_cr
+0002f520: 6f6e 2220 616e 6420 6e6f 7420 7661 6c75  on" and not valu
+0002f530: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002f540: 2020 2076 616c 7565 203d 204f 4e5f 4445     value = ON_DE
+0002f550: 4d41 4e44 0a20 2020 2020 2020 2020 2020  MAND.           
+0002f560: 2064 6174 6166 696c 655f 6b65 7920 3d20   datafile_key = 
+0002f570: 4578 706f 7274 5265 706c 6163 656d 656e  ExportReplacemen
+0002f580: 7473 2e67 6574 5f64 6174 6166 696c 655f  ts.get_datafile_
+0002f590: 6b65 7928 7061 7261 6d29 0a20 2020 2020  key(param).     
+0002f5a0: 2020 2020 2020 2069 6620 6461 7461 6669         if datafi
+0002f5b0: 6c65 5f6b 6579 3a0a 2020 2020 2020 2020  le_key:.        
+0002f5c0: 2020 2020 2020 2020 6669 6c65 5f70 6172          file_par
+0002f5d0: 7473 2e61 7070 656e 6428 6622 7b64 6174  ts.append(f"{dat
+0002f5e0: 6166 696c 655f 6b65 797d 207b 7661 6c75  afile_key} {valu
+0002f5f0: 657d 2229 0a20 2020 2020 2020 2020 2020  e}").           
+0002f600: 2020 2020 2066 696c 655f 7061 7274 732e       file_parts.
+0002f610: 6170 7065 6e64 2844 4154 4146 494c 455f  append(DATAFILE_
+0002f620: 4e45 575f 4c49 4e45 290a 0a20 2020 2072  NEW_LINE)..    r
+0002f630: 6574 7572 6e20 6669 6c65 5f70 6172 7473  eturn file_parts
+0002f640: 0a0a 0a64 6566 2066 6f72 6d61 745f 7069  ...def format_pi
+0002f650: 7065 5f69 6e63 6c75 6465 2866 696c 655f  pe_include(file_
+0002f660: 7061 7274 733a 204c 6973 745b 7374 725d  parts: List[str]
+0002f670: 2c20 6e6f 6465 3a20 4469 6374 5b73 7472  , node: Dict[str
+0002f680: 2c20 416e 795d 2c20 696e 636c 7564 6573  , Any], includes
+0002f690: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
+0002f6a0: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
+0002f6b0: 2020 2020 6966 2069 6e63 6c75 6465 733a      if includes:
+0002f6c0: 0a20 2020 2020 2020 2066 6f72 206b 2c20  .        for k, 
+0002f6d0: 7620 696e 2069 6e63 6c75 6465 732e 636f  v in includes.co
+0002f6e0: 7079 2829 2e69 7465 6d73 2829 3a0a 2020  py().items():.  
+0002f6f0: 2020 2020 2020 2020 2020 6966 206e 6f64            if nod
+0002f700: 655b 226e 616d 6522 5d20 696e 2076 3a0a  e["name"] in v:.
+0002f710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f720: 6669 6c65 5f70 6172 7473 2e61 7070 656e  file_parts.appen
+0002f730: 6428 6622 494e 434c 5544 4520 7b6b 7d22  d(f"INCLUDE {k}"
+0002f740: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002f750: 2020 6669 6c65 5f70 6172 7473 2e61 7070    file_parts.app
+0002f760: 656e 6428 4441 5441 4649 4c45 5f4e 4557  end(DATAFILE_NEW
+0002f770: 5f4c 494e 4529 0a20 2020 2020 2020 2020  _LINE).         
+0002f780: 2020 2020 2020 2066 696c 655f 7061 7274         file_part
+0002f790: 732e 6170 7065 6e64 2844 4154 4146 494c  s.append(DATAFIL
+0002f7a0: 455f 4e45 575f 4c49 4e45 290a 2020 2020  E_NEW_LINE).    
+0002f7b0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+0002f7c0: 696e 636c 7564 6573 5b6b 5d0a 2020 2020  includes[k].    
+0002f7d0: 7265 7475 726e 2066 696c 655f 7061 7274  return file_part
+0002f7e0: 730a 0a0a 6173 796e 6320 6465 6620 666f  s...async def fo
+0002f7f0: 726d 6174 5f6e 6f64 6528 0a20 2020 2066  rmat_node(.    f
+0002f800: 696c 655f 7061 7274 733a 204c 6973 745b  ile_parts: List[
+0002f810: 7374 725d 2c0a 2020 2020 6e6f 6465 3a20  str],.    node: 
+0002f820: 4469 6374 5b73 7472 2c20 416e 795d 2c0a  Dict[str, Any],.
+0002f830: 2020 2020 696e 636c 7564 6573 3a20 4469      includes: Di
+0002f840: 6374 5b73 7472 2c20 416e 795d 2c0a 2020  ct[str, Any],.  
+0002f850: 2020 6c69 6e65 5f6c 656e 6774 683a 204f    line_length: O
+0002f860: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
+0002f870: 6f6e 652c 0a20 2020 2075 6e72 6f6c 6c5f  one,.    unroll_
+0002f880: 696e 636c 7564 6573 3a20 626f 6f6c 203d  includes: bool =
+0002f890: 2046 616c 7365 2c0a 2020 2020 6c6f 7765   False,.    lowe
+0002f8a0: 725f 6b65 7977 6f72 6473 3a20 626f 6f6c  r_keywords: bool
+0002f8b0: 203d 2046 616c 7365 2c0a 2920 2d3e 204e   = False,.) -> N
+0002f8c0: 6f6e 653a 0a20 2020 2069 6620 6e6f 7420  one:.    if not 
+0002f8d0: 756e 726f 6c6c 5f69 6e63 6c75 6465 733a  unroll_includes:
+0002f8e0: 0a20 2020 2020 2020 2066 6f72 6d61 745f  .        format_
+0002f8f0: 7069 7065 5f69 6e63 6c75 6465 2866 696c  pipe_include(fil
+0002f900: 655f 7061 7274 732c 206e 6f64 652c 2069  e_parts, node, i
+0002f910: 6e63 6c75 6465 7329 0a20 2020 2069 7465  ncludes).    ite
+0002f920: 6d20 3d20 5b6b 2066 6f72 206b 2c20 5f20  m = [k for k, _ 
+0002f930: 696e 2069 6e63 6c75 6465 732e 6974 656d  in includes.item
+0002f940: 7328 2920 6966 206e 6f64 655b 226e 616d  s() if node["nam
+0002f950: 6522 5d2e 7374 7269 7028 2920 696e 206b  e"].strip() in k
+0002f960: 5d0a 2020 2020 6966 2069 7465 6d20 616e  ].    if item an
+0002f970: 6420 6e6f 7420 756e 726f 6c6c 5f69 6e63  d not unroll_inc
+0002f980: 6c75 6465 733a 0a20 2020 2020 2020 2072  ludes:.        r
+0002f990: 6574 7572 6e0a 0a20 2020 2066 696c 655f  eturn..    file_
+0002f9a0: 7061 7274 732e 6170 7065 6e64 2866 274e  parts.append(f'N
+0002f9b0: 4f44 4520 7b6e 6f64 655b 226e 616d 6522  ODE {node["name"
+0002f9c0: 5d2e 7374 7269 7028 297d 2729 0a20 2020  ].strip()}').   
+0002f9d0: 2066 696c 655f 7061 7274 732e 6170 7065   file_parts.appe
+0002f9e0: 6e64 2844 4154 4146 494c 455f 4e45 575f  nd(DATAFILE_NEW_
+0002f9f0: 4c49 4e45 290a 0a20 2020 2066 726f 6d20  LINE)..    from 
+0002fa00: 636f 6c6c 6563 7469 6f6e 7320 696d 706f  collections impo
+0002fa10: 7274 206e 616d 6564 7475 706c 650a 0a20  rt namedtuple.. 
+0002fa20: 2020 2044 6f63 203d 206e 616d 6564 7475     Doc = namedtu
+0002fa30: 706c 6528 2244 6f63 222c 205b 2264 6573  ple("Doc", ["des
+0002fa40: 6372 6970 7469 6f6e 225d 290a 2020 2020  cription"]).    
+0002fa50: 666f 726d 6174 5f64 6573 6372 6970 7469  format_descripti
+0002fa60: 6f6e 2866 696c 655f 7061 7274 732c 2044  on(file_parts, D
+0002fa70: 6f63 286e 6f64 652e 6765 7428 2264 6573  oc(node.get("des
+0002fa80: 6372 6970 7469 6f6e 222c 2022 2229 2929  cription", "")))
+0002fa90: 0a20 2020 2066 6f72 6d61 745f 6e6f 6465  .    format_node
+0002faa0: 5f73 716c 2866 696c 655f 7061 7274 732c  _sql(file_parts,
+0002fab0: 206e 6f64 652c 206c 696e 655f 6c65 6e67   node, line_leng
+0002fac0: 7468 3d6c 696e 655f 6c65 6e67 7468 2c20  th=line_length, 
+0002fad0: 6c6f 7765 725f 6b65 7977 6f72 6473 3d6c  lower_keywords=l
+0002fae0: 6f77 6572 5f6b 6579 776f 7264 7329 0a20  ower_keywords). 
+0002faf0: 2020 2061 7761 6974 2066 6f72 6d61 745f     await format_
+0002fb00: 6e6f 6465 5f74 7970 6528 6669 6c65 5f70  node_type(file_p
+0002fb10: 6172 7473 2c20 6e6f 6465 290a 0a0a 6173  arts, node)...as
+0002fb20: 796e 6320 6465 6620 666f 726d 6174 5f70  ync def format_p
+0002fb30: 6970 6528 0a20 2020 2066 696c 656e 616d  ipe(.    filenam
+0002fb40: 653a 2073 7472 2c0a 2020 2020 6c69 6e65  e: str,.    line
+0002fb50: 5f6c 656e 6774 683a 204f 7074 696f 6e61  _length: Optiona
+0002fb60: 6c5b 696e 745d 2c0a 2020 2020 756e 726f  l[int],.    unro
+0002fb70: 6c6c 5f69 6e63 6c75 6465 733a 2062 6f6f  ll_includes: boo
+0002fb80: 6c20 3d20 4661 6c73 652c 0a20 2020 2072  l = False,.    r
+0002fb90: 6570 6c61 6365 5f69 6e63 6c75 6465 733a  eplace_includes:
+0002fba0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
+0002fbb0: 2020 2064 6174 6166 696c 653a 204f 7074     datafile: Opt
+0002fbc0: 696f 6e61 6c5b 4461 7461 6669 6c65 5d20  ional[Datafile] 
+0002fbd0: 3d20 4e6f 6e65 2c0a 2020 2020 666f 725f  = None,.    for_
+0002fbe0: 6465 706c 6f79 5f64 6966 663a 2062 6f6f  deploy_diff: boo
+0002fbf0: 6c20 3d20 4661 6c73 652c 0a20 2020 2073  l = False,.    s
+0002fc00: 6b69 705f 6576 616c 3a20 626f 6f6c 203d  kip_eval: bool =
+0002fc10: 2046 616c 7365 2c0a 2920 2d3e 2073 7472   False,.) -> str
+0002fc20: 3a0a 2020 2020 6966 2064 6174 6166 696c  :.    if datafil
+0002fc30: 653a 0a20 2020 2020 2020 2064 6f63 203d  e:.        doc =
+0002fc40: 2064 6174 6166 696c 650a 2020 2020 656c   datafile.    el
+0002fc50: 7365 3a0a 2020 2020 2020 2020 646f 6320  se:.        doc 
+0002fc60: 3d20 7061 7273 655f 7069 7065 2866 696c  = parse_pipe(fil
+0002fc70: 656e 616d 652c 2072 6570 6c61 6365 5f69  ename, replace_i
+0002fc80: 6e63 6c75 6465 733d 7265 706c 6163 655f  ncludes=replace_
+0002fc90: 696e 636c 7564 6573 2c20 736b 6970 5f65  includes, skip_e
+0002fca0: 7661 6c3d 736b 6970 5f65 7661 6c29 0a0a  val=skip_eval)..
+0002fcb0: 2020 2020 6669 6c65 5f70 6172 7473 3a20      file_parts: 
+0002fcc0: 4c69 7374 5b73 7472 5d20 3d20 5b5d 0a20  List[str] = []. 
+0002fcd0: 2020 2066 6f72 6d61 745f 736f 7572 6365     format_source
+0002fce0: 7328 6669 6c65 5f70 6172 7473 2c20 646f  s(file_parts, do
+0002fcf0: 6329 0a20 2020 2066 6f72 6d61 745f 6d61  c).    format_ma
+0002fd00: 696e 7461 696e 6572 2866 696c 655f 7061  intainer(file_pa
+0002fd10: 7274 732c 2064 6f63 290a 2020 2020 666f  rts, doc).    fo
+0002fd20: 726d 6174 5f76 6572 7369 6f6e 2866 696c  rmat_version(fil
+0002fd30: 655f 7061 7274 732c 2064 6f63 290a 2020  e_parts, doc).  
+0002fd40: 2020 666f 726d 6174 5f64 6573 6372 6970    format_descrip
+0002fd50: 7469 6f6e 2866 696c 655f 7061 7274 732c  tion(file_parts,
+0002fd60: 2064 6f63 290a 2020 2020 666f 726d 6174   doc).    format
+0002fd70: 5f74 6f6b 656e 7328 6669 6c65 5f70 6172  _tokens(file_par
+0002fd80: 7473 2c20 646f 6329 0a20 2020 2069 6620  ts, doc).    if 
+0002fd90: 646f 632e 696e 636c 7564 6573 2061 6e64  doc.includes and
+0002fda0: 206e 6f74 2075 6e72 6f6c 6c5f 696e 636c   not unroll_incl
+0002fdb0: 7564 6573 3a0a 2020 2020 2020 2020 666f  udes:.        fo
+0002fdc0: 7220 6b20 696e 2064 6f63 2e69 6e63 6c75  r k in doc.inclu
+0002fdd0: 6465 733a 0a20 2020 2020 2020 2020 2020  des:.           
+0002fde0: 2023 2057 6520 6669 6c74 6572 206f 6e6c   # We filter onl
+0002fdf0: 7920 7468 6520 696e 636c 7564 6520 6669  y the include fi
+0002fe00: 6c65 7320 6173 2077 6520 6375 7272 656e  les as we curren
+0002fe10: 746c 7920 6861 7665 2032 2069 7465 6d73  tly have 2 items
+0002fe20: 2066 6f72 2065 6163 6820 696e 636c 7564   for each includ
+0002fe30: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+0002fe40: 7b20 2769 6e63 6c75 6465 5f66 696c 652e  { 'include_file.
+0002fe50: 696e 636c 273a 2027 4669 7273 7420 6e6f  incl': 'First no
+0002fe60: 6465 206f 6620 7468 6520 696e 636c 7564  de of the includ
+0002fe70: 6522 207d 0a20 2020 2020 2020 2020 2020  e" }.           
+0002fe80: 2023 207b 2027 6669 7273 7420 6e6f 6465   # { 'first node
+0002fe90: 206f 6620 7468 6520 7069 7065 2061 6674   of the pipe aft
+0002fea0: 6572 2074 6865 2069 6e63 6c75 6465 273a  er the include':
+0002feb0: 207d 0a20 2020 2020 2020 2020 2020 2069   }.            i
+0002fec0: 6620 222e 696e 636c 2220 6e6f 7420 696e  f ".incl" not in
+0002fed0: 206b 3a0a 2020 2020 2020 2020 2020 2020   k:.            
+0002fee0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+0002fef0: 2020 2020 2020 2020 2020 2320 5765 2067            # We g
+0002ff00: 6574 2061 6c6c 2074 6865 206e 6f64 6573  et all the nodes
+0002ff10: 2069 6e73 6964 6520 7468 6520 696e 636c   inside the incl
+0002ff20: 7564 6520 616e 6420 7265 6d6f 7665 2074  ude and remove t
+0002ff30: 6865 6d20 6672 6f6d 2074 6865 2075 6e72  hem from the unr
+0002ff40: 6f6c 6c65 6420 7069 7065 2061 7320 7765  olled pipe as we
+0002ff50: 2077 616e 7420 7468 696e 6773 2075 6e72   want things unr
+0002ff60: 6f6c 6c65 640a 2020 2020 2020 2020 2020  olled.          
+0002ff70: 2020 696e 636c 7564 655f 7061 7261 6d65    include_parame
+0002ff80: 7465 7273 203d 205f 756e 7175 6f74 6528  ters = _unquote(
+0002ff90: 6b29 0a0a 2020 2020 2020 2020 2020 2020  k)..            
+0002ffa0: 2320 4966 2074 6865 7920 7573 6520 616e  # If they use an
+0002ffb0: 2069 6e63 6c75 6465 2077 6974 6820 7061   include with pa
+0002ffc0: 7261 6d65 7465 7273 206c 696b 6520 6049  rameters like `I
+0002ffd0: 4e43 4c55 4445 2022 7878 782e 696e 636c  NCLUDE "xxx.incl
+0002ffe0: 2220 2247 524f 5550 5f43 4f4c 3d70 6174  " "GROUP_COL=pat
+0002fff0: 6822 2022 4d41 5445 5249 414c 495a 4544  h" "MATERIALIZED
+00030000: 5f56 4945 573d 7370 6565 645f 696e 7369  _VIEW=speed_insi
+00030010: 6768 7473 5f70 6174 685f 6461 696c 795f  ghts_path_daily_
+00030020: 6d76 2260 600a 2020 2020 2020 2020 2020  mv"``.          
+00030030: 2020 2320 5765 206a 7573 7420 7761 6e74    # We just want
+00030040: 2074 6865 2066 696c 6520 6e61 6d65 2074   the file name t
+00030050: 6f20 7461 6b65 206e 6f64 6573 0a20 2020  o take nodes.   
+00030060: 2020 2020 2020 2020 2069 6e63 6c75 6465           include
+00030070: 5f66 696c 6520 3d20 696e 636c 7564 655f  _file = include_
+00030080: 7061 7261 6d65 7465 7273 2e73 706c 6974  parameters.split
+00030090: 2827 2227 295b 305d 0a20 2020 2020 2020  ('"')[0].       
+000300a0: 2020 2020 2069 6e63 6c75 6465 5f66 696c       include_fil
+000300b0: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
+000300c0: 2020 2020 2020 5061 7468 286f 732e 7061        Path(os.pa
+000300d0: 7468 2e64 6972 6e61 6d65 2866 696c 656e  th.dirname(filen
+000300e0: 616d 6529 2920 2f20 6576 616c 5f76 6172  ame)) / eval_var
+000300f0: 2869 6e63 6c75 6465 5f66 696c 6529 0a20  (include_file). 
+00030100: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00030110: 6620 222e 2220 696e 2069 6e63 6c75 6465  f "." in include
+00030120: 5f66 696c 650a 2020 2020 2020 2020 2020  _file.          
+00030130: 2020 2020 2020 656c 7365 2065 7661 6c5f        else eval_
+00030140: 7661 7228 696e 636c 7564 655f 6669 6c65  var(include_file
+00030150: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
+00030160: 2020 2020 2020 2020 2020 2020 696e 636c              incl
+00030170: 7564 6564 5f70 6970 6520 3d20 7061 7273  uded_pipe = pars
+00030180: 655f 7069 7065 2869 6e63 6c75 6465 5f66  e_pipe(include_f
+00030190: 696c 652c 2073 6b69 705f 6576 616c 3d73  ile, skip_eval=s
+000301a0: 6b69 705f 6576 616c 290a 2020 2020 2020  kip_eval).      
+000301b0: 2020 2020 2020 7069 7065 5f6e 6f64 6573        pipe_nodes
+000301c0: 203d 2064 6f63 2e6e 6f64 6573 2e63 6f70   = doc.nodes.cop
+000301d0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+000301e0: 666f 7220 696e 636c 7564 6564 5f6e 6f64  for included_nod
+000301f0: 6520 696e 2069 6e63 6c75 6465 645f 7069  e in included_pi
+00030200: 7065 2e6e 6f64 6573 2e63 6f70 7928 293a  pe.nodes.copy():
+00030210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030220: 2075 6e72 6f6c 6c65 645f 696e 636c 7564   unrolled_includ
+00030230: 6564 5f6e 6f64 6520 3d20 6e65 7874 280a  ed_node = next(.
+00030240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030250: 2020 2020 286e 6f64 6520 666f 7220 6e6f      (node for no
+00030260: 6465 2069 6e20 7069 7065 5f6e 6f64 6573  de in pipe_nodes
+00030270: 2069 6620 6e6f 6465 5b22 6e61 6d65 225d   if node["name"]
+00030280: 203d 3d20 696e 636c 7564 6564 5f6e 6f64   == included_nod
+00030290: 655b 226e 616d 6522 5d29 2c20 4e6f 6e65  e["name"]), None
+000302a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000302b0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000302c0: 2020 2069 6620 756e 726f 6c6c 6564 5f69     if unrolled_i
+000302d0: 6e63 6c75 6465 645f 6e6f 6465 3a0a 2020  ncluded_node:.  
+000302e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302f0: 2020 646f 632e 6e6f 6465 732e 7265 6d6f    doc.nodes.remo
+00030300: 7665 2875 6e72 6f6c 6c65 645f 696e 636c  ve(unrolled_incl
+00030310: 7564 6564 5f6e 6f64 6529 0a20 2020 2066  uded_node).    f
+00030320: 6f72 206e 6f64 6520 696e 2064 6f63 2e6e  or node in doc.n
+00030330: 6f64 6573 3a0a 2020 2020 2020 2020 6177  odes:.        aw
+00030340: 6169 7420 666f 726d 6174 5f6e 6f64 6528  ait format_node(
+00030350: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+00030360: 655f 7061 7274 732c 0a20 2020 2020 2020  e_parts,.       
+00030370: 2020 2020 206e 6f64 652c 0a20 2020 2020       node,.     
+00030380: 2020 2020 2020 2064 6f63 2e69 6e63 6c75         doc.inclu
+00030390: 6465 732c 0a20 2020 2020 2020 2020 2020  des,.           
+000303a0: 206c 696e 655f 6c65 6e67 7468 3d6c 696e   line_length=lin
+000303b0: 655f 6c65 6e67 7468 2c0a 2020 2020 2020  e_length,.      
+000303c0: 2020 2020 2020 756e 726f 6c6c 5f69 6e63        unroll_inc
+000303d0: 6c75 6465 733d 756e 726f 6c6c 5f69 6e63  ludes=unroll_inc
+000303e0: 6c75 6465 732c 0a20 2020 2020 2020 2020  ludes,.         
+000303f0: 2020 206c 6f77 6572 5f6b 6579 776f 7264     lower_keyword
+00030400: 733d 5472 7565 2069 6620 666f 725f 6465  s=True if for_de
+00030410: 706c 6f79 5f64 6966 6620 656c 7365 2046  ploy_diff else F
+00030420: 616c 7365 2c0a 2020 2020 2020 2020 290a  alse,.        ).
+00030430: 0a20 2020 2069 6620 6e6f 7420 756e 726f  .    if not unro
+00030440: 6c6c 5f69 6e63 6c75 6465 733a 0a20 2020  ll_includes:.   
+00030450: 2020 2020 2066 6f72 206b 2c20 5f20 696e       for k, _ in
+00030460: 2064 6f63 2e69 6e63 6c75 6465 732e 6974   doc.includes.it
+00030470: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+00030480: 2020 2069 6620 222e 696e 636c 2220 6e6f     if ".incl" no
+00030490: 7420 696e 206b 3a0a 2020 2020 2020 2020  t in k:.        
+000304a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+000304b0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+000304c0: 655f 7061 7274 732e 6170 7065 6e64 2866  e_parts.append(f
+000304d0: 2249 4e43 4c55 4445 207b 6b7d 2229 0a20  "INCLUDE {k}"). 
+000304e0: 2020 2020 2020 2020 2020 2066 696c 655f             file_
+000304f0: 7061 7274 732e 6170 7065 6e64 2844 4154  parts.append(DAT
+00030500: 4146 494c 455f 4e45 575f 4c49 4e45 290a  AFILE_NEW_LINE).
+00030510: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+00030520: 5f70 6172 7473 2e61 7070 656e 6428 4441  _parts.append(DA
+00030530: 5441 4649 4c45 5f4e 4557 5f4c 494e 4529  TAFILE_NEW_LINE)
+00030540: 0a0a 2020 2020 7265 7375 6c74 203d 2022  ..    result = "
+00030550: 222e 6a6f 696e 2866 696c 655f 7061 7274  ".join(file_part
+00030560: 7329 0a20 2020 2072 6573 756c 7420 3d20  s).    result = 
+00030570: 7265 7375 6c74 2e72 7374 7269 7028 225c  result.rstrip("\
+00030580: 6e22 2920 2b20 225c 6e22 0a20 2020 2072  n") + "\n".    r
+00030590: 6574 7572 6e20 7265 7375 6c74 0a0a 0a64  eturn result...d
+000305a0: 6566 2066 6f72 6d61 745f 7371 6c28 7371  ef format_sql(sq
+000305b0: 6c3a 2073 7472 2c20 4441 5441 4649 4c45  l: str, DATAFILE
+000305c0: 5f49 4e44 454e 543a 2073 7472 2c20 6c69  _INDENT: str, li
+000305d0: 6e65 5f6c 656e 6774 683a 204f 7074 696f  ne_length: Optio
+000305e0: 6e61 6c5b 696e 745d 203d 204e 6f6e 652c  nal[int] = None,
+000305f0: 206c 6f77 6572 5f6b 6579 776f 7264 733a   lower_keywords:
+00030600: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
+00030610: 3e20 7374 723a 0a20 2020 2073 716c 203d  > str:.    sql =
+00030620: 2066 6f72 6d61 745f 7371 6c5f 7465 6d70   format_sql_temp
+00030630: 6c61 7465 2873 716c 2e73 7472 6970 2829  late(sql.strip()
+00030640: 2c20 6c69 6e65 5f6c 656e 6774 683d 6c69  , line_length=li
+00030650: 6e65 5f6c 656e 6774 682c 206c 6f77 6572  ne_length, lower
+00030660: 5f6b 6579 776f 7264 733d 6c6f 7765 725f  _keywords=lower_
+00030670: 6b65 7977 6f72 6473 290a 2020 2020 7265  keywords).    re
+00030680: 7475 726e 2022 5c6e 222e 6a6f 696e 285b  turn "\n".join([
+00030690: 6622 7b44 4154 4146 494c 455f 494e 4445  f"{DATAFILE_INDE
+000306a0: 4e54 7d7b 7061 7274 7d22 2066 6f72 2070  NT}{part}" for p
+000306b0: 6172 7420 696e 2073 716c 2e73 706c 6974  art in sql.split
+000306c0: 2822 5c6e 2229 2069 6620 6c65 6e28 7061  ("\n") if len(pa
+000306d0: 7274 2e73 7472 6970 2829 295d 290a 0a0a  rt.strip())])...
+000306e0: 6173 796e 6320 6465 6620 5f67 6174 6865  async def _gathe
+000306f0: 725f 7769 7468 5f63 6f6e 6375 7272 656e  r_with_concurren
+00030700: 6379 286e 2c20 2a74 6173 6b73 293a 0a20  cy(n, *tasks):. 
+00030710: 2020 2073 656d 6170 686f 7265 203d 2053     semaphore = S
+00030720: 656d 6170 686f 7265 286e 290a 0a20 2020  emaphore(n)..   
+00030730: 2061 7379 6e63 2064 6566 2073 656d 5f74   async def sem_t
+00030740: 6173 6b28 7461 736b 293a 0a20 2020 2020  ask(task):.     
+00030750: 2020 2061 7379 6e63 2077 6974 6820 7365     async with se
+00030760: 6d61 7068 6f72 653a 0a20 2020 2020 2020  maphore:.       
+00030770: 2020 2020 2072 6574 7572 6e20 6177 6169       return awai
+00030780: 7420 7461 736b 0a0a 2020 2020 7265 7475  t task..    retu
+00030790: 726e 2061 7761 6974 2067 6174 6865 7228  rn await gather(
+000307a0: 2a28 7365 6d5f 7461 736b 2874 6173 6b29  *(sem_task(task)
+000307b0: 2066 6f72 2074 6173 6b20 696e 2074 6173   for task in tas
+000307c0: 6b73 2929 0a0a 0a61 7379 6e63 2064 6566  ks))...async def
+000307d0: 2066 6f6c 6465 725f 7075 6c6c 280a 2020   folder_pull(.  
+000307e0: 2020 636c 6965 6e74 3a20 5469 6e79 422c    client: TinyB,
+000307f0: 0a20 2020 2066 6f6c 6465 723a 2073 7472  .    folder: str
+00030800: 2c0a 2020 2020 6175 746f 3a20 626f 6f6c  ,.    auto: bool
+00030810: 2c0a 2020 2020 6d61 7463 683a 204f 7074  ,.    match: Opt
+00030820: 696f 6e61 6c5b 7374 725d 2c0a 2020 2020  ional[str],.    
+00030830: 666f 7263 653a 2062 6f6f 6c2c 0a20 2020  force: bool,.   
+00030840: 2076 6572 626f 7365 3a20 626f 6f6c 203d   verbose: bool =
+00030850: 2054 7275 652c 0a20 2020 2070 726f 6772   True,.    progr
+00030860: 6573 735f 6261 723a 2062 6f6f 6c20 3d20  ess_bar: bool = 
+00030870: 4661 6c73 652c 0a29 3a20 2023 206e 6f71  False,.):  # noq
+00030880: 613a 2043 3930 310a 2020 2020 7061 7474  a: C901.    patt
+00030890: 6572 6e20 3d20 7265 2e63 6f6d 7069 6c65  ern = re.compile
+000308a0: 286d 6174 6368 2920 6966 206d 6174 6368  (match) if match
+000308b0: 2065 6c73 6520 4e6f 6e65 0a0a 2020 2020   else None..    
+000308c0: 6465 6620 5f67 6574 5f6c 6174 6573 745f  def _get_latest_
+000308d0: 7665 7273 696f 6e73 2872 6573 6f75 7263  versions(resourc
+000308e0: 6573 3a20 4c69 7374 5b73 7472 5d29 3a0a  es: List[str]):.
+000308f0: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
+00030900: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
+00030910: 203d 207b 7d0a 0a20 2020 2020 2020 2066   = {}..        f
+00030920: 6f72 2078 2069 6e20 7265 736f 7572 6365  or x in resource
+00030930: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+00030940: 203d 2067 6574 5f6e 616d 655f 7665 7273   = get_name_vers
+00030950: 696f 6e28 7829 0a20 2020 2020 2020 2020  ion(x).         
+00030960: 2020 2074 5b22 6f72 6967 696e 616c 5f6e     t["original_n
+00030970: 616d 6522 5d20 3d20 780a 2020 2020 2020  ame"] = x.      
+00030980: 2020 2020 2020 6966 2074 5b22 7665 7273        if t["vers
+00030990: 696f 6e22 5d20 6973 204e 6f6e 653a 0a20  ion"] is None:. 
+000309a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000309b0: 5b22 7665 7273 696f 6e22 5d20 3d20 2d31  ["version"] = -1
+000309c0: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+000309d0: 6520 3d20 745b 226e 616d 6522 5d0a 0a20  e = t["name"].. 
+000309e0: 2020 2020 2020 2020 2020 2069 6620 6e61             if na
+000309f0: 6d65 206e 6f74 2069 6e20 7665 7273 696f  me not in versio
+00030a00: 6e73 206f 7220 6e61 6d65 203d 3d20 7820  ns or name == x 
+00030a10: 6f72 2076 6572 7369 6f6e 735b 6e61 6d65  or versions[name
+00030a20: 5d5b 2276 6572 7369 6f6e 225d 203c 2074  ]["version"] < t
+00030a30: 5b22 7665 7273 696f 6e22 5d3a 0a20 2020  ["version"]:.   
+00030a40: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+00030a50: 7369 6f6e 735b 6e61 6d65 5d20 3d20 740a  sions[name] = t.
+00030a60: 2020 2020 2020 2020 7265 7475 726e 2076          return v
+00030a70: 6572 7369 6f6e 730a 0a20 2020 2064 6566  ersions..    def
+00030a80: 2067 6574 5f66 696c 655f 666f 6c64 6572   get_file_folder
+00030a90: 2865 7874 656e 7369 6f6e 3a20 7374 7229  (extension: str)
+00030aa0: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+00030ab0: 2061 7574 6f3a 0a20 2020 2020 2020 2020   auto:.         
+00030ac0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
+00030ad0: 2020 2020 2020 2069 6620 6578 7465 6e73         if extens
+00030ae0: 696f 6e20 3d3d 2022 6461 7461 736f 7572  ion == "datasour
+00030af0: 6365 223a 0a20 2020 2020 2020 2020 2020  ce":.           
+00030b00: 2072 6574 7572 6e20 2264 6174 6173 6f75   return "datasou
+00030b10: 7263 6573 220a 2020 2020 2020 2020 6966  rces".        if
+00030b20: 2065 7874 656e 7369 6f6e 203d 3d20 2270   extension == "p
+00030b30: 6970 6522 3a0a 2020 2020 2020 2020 2020  ipe":.          
+00030b40: 2020 7265 7475 726e 2022 7069 7065 7322    return "pipes"
+00030b50: 0a20 2020 2020 2020 2069 6620 6578 7465  .        if exte
+00030b60: 6e73 696f 6e20 3d3d 2022 746f 6b65 6e22  nsion == "token"
+00030b70: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00030b80: 7475 726e 2022 746f 6b65 6e73 220a 2020  turn "tokens".  
+00030b90: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00030ba0: 650a 0a20 2020 2061 7379 6e63 2064 6566  e..    async def
+00030bb0: 2077 7269 7465 5f66 696c 6573 280a 2020   write_files(.  
+00030bc0: 2020 2020 2020 7665 7273 696f 6e73 3a20        versions: 
+00030bd0: 4469 6374 5b73 7472 2c20 416e 795d 2c0a  Dict[str, Any],.
+00030be0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+00030bf0: 733a 204c 6973 745b 7374 725d 2c0a 2020  s: List[str],.  
+00030c00: 2020 2020 2020 6578 7465 6e73 696f 6e3a        extension:
+00030c10: 2073 7472 2c0a 2020 2020 2020 2020 6765   str,.        ge
+00030c20: 745f 7265 736f 7572 6365 5f66 756e 6374  t_resource_funct
+00030c30: 696f 6e3a 2073 7472 2c0a 2020 2020 2020  ion: str,.      
+00030c40: 2020 7072 6f67 7265 7373 5f62 6172 3a20    progress_bar: 
+00030c50: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00030c60: 2020 293a 0a20 2020 2020 2020 2061 7379    ):.        asy
+00030c70: 6e63 2064 6566 2077 7269 7465 5f72 6573  nc def write_res
+00030c80: 6f75 7263 6528 6b3a 2044 6963 745b 7374  ource(k: Dict[st
+00030c90: 722c 2041 6e79 5d29 3a0a 2020 2020 2020  r, Any]):.      
+00030ca0: 2020 2020 2020 6e61 6d65 203d 2066 227b        name = f"{
+00030cb0: 6b5b 276e 616d 6527 5d7d 2e7b 6578 7465  k['name']}.{exte
+00030cc0: 6e73 696f 6e7d 220a 2020 2020 2020 2020  nsion}".        
+00030cd0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00030ce0: 2020 2020 2020 2020 2069 6620 7061 7474           if patt
+00030cf0: 6572 6e20 616e 6420 6e6f 7420 7061 7474  ern and not patt
+00030d00: 6572 6e2e 7365 6172 6368 286e 616d 6529  ern.search(name)
+00030d10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00030d20: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00030d30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00030d40: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
+00030d50: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
+00030d60: 6167 6572 2e69 6e66 6f5f 736b 6970 7069  ager.info_skippi
+00030d70: 6e67 5f72 6573 6f75 7263 6528 7265 736f  ng_resource(reso
+00030d80: 7572 6365 3d6e 616d 6529 290a 2020 2020  urce=name)).    
+00030d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030da0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+00030db0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+00030dc0: 203d 2061 7761 6974 2067 6574 6174 7472   = await getattr
+00030dd0: 2863 6c69 656e 742c 2067 6574 5f72 6573  (client, get_res
+00030de0: 6f75 7263 655f 6675 6e63 7469 6f6e 2928  ource_function)(
+00030df0: 6b5b 226f 7269 6769 6e61 6c5f 6e61 6d65  k["original_name
+00030e00: 225d 290a 0a20 2020 2020 2020 2020 2020  "])..           
+00030e10: 2020 2020 2064 6573 745f 666f 6c64 6572       dest_folder
+00030e20: 203d 2066 6f6c 6465 720a 2020 2020 2020   = folder.      
+00030e30: 2020 2020 2020 2020 2020 6966 2022 2e22            if "."
+00030e40: 2069 6e20 6b5b 226e 616d 6522 5d20 616e   in k["name"] an
+00030e50: 6420 6578 7465 6e73 696f 6e20 213d 2022  d extension != "
+00030e60: 746f 6b65 6e22 3a0a 2020 2020 2020 2020  token":.        
+00030e70: 2020 2020 2020 2020 2020 2020 6465 7374              dest
+00030e80: 5f66 6f6c 6465 7220 3d20 5061 7468 2866  _folder = Path(f
+00030e90: 6f6c 6465 7229 202f 2022 7665 6e64 6f72  older) / "vendor
+00030ea0: 2220 2f20 6b5b 226e 616d 6522 5d2e 7370  " / k["name"].sp
+00030eb0: 6c69 7428 222e 222c 2031 295b 305d 0a20  lit(".", 1)[0]. 
+00030ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ed0: 2020 206e 616d 6520 3d20 6622 7b6b 5b27     name = f"{k['
+00030ee0: 6e61 6d65 275d 2e73 706c 6974 2827 2e27  name'].split('.'
+00030ef0: 2c20 3129 5b31 5d7d 2e7b 6578 7465 6e73  , 1)[1]}.{extens
+00030f00: 696f 6e7d 220a 0a20 2020 2020 2020 2020  ion}"..         
+00030f10: 2020 2020 2020 2066 696c 655f 666f 6c64         file_fold
+00030f20: 6572 203d 2067 6574 5f66 696c 655f 666f  er = get_file_fo
+00030f30: 6c64 6572 2865 7874 656e 7369 6f6e 290a  lder(extension).
 00030f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030f50: 2020 2077 6974 6820 6f70 656e 2866 2c20     with open(f, 
-00030f60: 2277 2229 2061 7320 6664 3a0a 2020 2020  "w") as fd:.    
-00030f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030f80: 2020 2020 2320 7665 7273 696f 6e73 2061      # versions a
-00030f90: 7265 2061 2063 6c69 656e 7420 6f6e 6c79  re a client only
-00030fa0: 2074 6869 6e67 2073 6f0a 2020 2020 2020   thing so.      
-00030fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030fc0: 2020 2320 6461 7461 6669 6c65 7320 6672    # datafiles fr
-00030fd0: 6f6d 2074 6865 2073 6572 7665 7220 646f  om the server do
-00030fe0: 206e 6f74 2063 6f6e 7461 696e 7320 696e   not contains in
-00030ff0: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
-00031000: 7665 7273 696f 6e73 0a20 2020 2020 2020  versions.       
-00031010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031020: 2069 6620 6b5b 2276 6572 7369 6f6e 225d   if k["version"]
-00031030: 203e 3d20 303a 0a20 2020 2020 2020 2020   >= 0:.         
-00031040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031050: 2020 2072 6573 6f75 7263 6520 3d20 6622     resource = f"
-00031060: 5645 5253 494f 4e20 7b6b 5b27 7665 7273  VERSION {k['vers
-00031070: 696f 6e27 5d7d 5c6e 2220 2b20 7265 736f  ion']}\n" + reso
-00031080: 7572 6365 0a20 2020 2020 2020 2020 2020  urce.           
-00031090: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000310a0: 7265 736f 7572 6365 3a0a 2020 2020 2020  resource:.      
-000310b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310c0: 2020 2020 2020 6d61 7463 6865 7320 3d20        matches = 
-000310d0: 7265 2e66 696e 6461 6c6c 2872 2228 5b5e  re.findall(r"([^
-000310e0: 5c73 5c2e 5d2a 5f5f 765c 642b 2922 2c20  \s\.]*__v\d+)", 
-000310f0: 7265 736f 7572 6365 290a 2020 2020 2020  resource).      
-00031100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031110: 2020 2020 2020 666f 7220 6d61 7463 6820        for match 
-00031120: 696e 2073 6574 286d 6174 6368 6573 293a  in set(matches):
-00031130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031150: 206d 203d 206d 6174 6368 2e73 706c 6974   m = match.split
-00031160: 2822 5f5f 7622 295b 305d 0a20 2020 2020  ("__v")[0].     
-00031170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031180: 2020 2020 2020 2020 2020 2069 6620 6d20             if m 
-00031190: 696e 2072 6573 6f75 7263 6573 206f 7220  in resources or 
-000311a0: 6d20 696e 2072 6573 6f75 7263 655f 6e61  m in resource_na
-000311b0: 6d65 733a 0a20 2020 2020 2020 2020 2020  mes:.           
+00030f50: 6620 3d20 5061 7468 2864 6573 745f 666f  f = Path(dest_fo
+00030f60: 6c64 6572 2920 2f20 6669 6c65 5f66 6f6c  lder) / file_fol
+00030f70: 6465 7220 6966 2066 696c 655f 666f 6c64  der if file_fold
+00030f80: 6572 2069 7320 6e6f 7420 4e6f 6e65 2065  er is not None e
+00030f90: 6c73 6520 5061 7468 2864 6573 745f 666f  lse Path(dest_fo
+00030fa0: 6c64 6572 290a 0a20 2020 2020 2020 2020  lder)..         
+00030fb0: 2020 2020 2020 2069 6620 6e6f 7420 662e         if not f.
+00030fc0: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
+00030fd0: 2020 2020 2020 2020 2020 2020 2020 662e                f.
+00030fe0: 6d6b 6469 7228 7061 7265 6e74 733d 5472  mkdir(parents=Tr
+00030ff0: 7565 290a 0a20 2020 2020 2020 2020 2020  ue)..           
+00031000: 2020 2020 2066 203d 2066 202f 206e 616d       f = f / nam
+00031010: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00031020: 2020 7265 736f 7572 6365 5f6e 616d 6573    resource_names
+00031030: 203d 205b 782e 7370 6c69 7428 222e 2229   = [x.split(".")
+00031040: 5b2d 315d 2066 6f72 2078 2069 6e20 7265  [-1] for x in re
+00031050: 736f 7572 6365 735d 0a0a 2020 2020 2020  sources]..      
+00031060: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+00031070: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+00031080: 2020 2020 2020 2020 2020 636c 6963 6b2e            click.
+00031090: 6563 686f 2846 6565 6462 6163 6b4d 616e  echo(FeedbackMan
+000310a0: 6167 6572 2e69 6e66 6f5f 7772 6974 696e  ager.info_writin
+000310b0: 675f 7265 736f 7572 6365 2872 6573 6f75  g_resource(resou
+000310c0: 7263 653d 6629 290a 2020 2020 2020 2020  rce=f)).        
+000310d0: 2020 2020 2020 2020 6966 206e 6f74 2066          if not f
+000310e0: 2e65 7869 7374 7328 2920 6f72 2066 6f72  .exists() or for
+000310f0: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+00031100: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
+00031110: 6e28 662c 2022 7722 2920 6173 2066 643a  n(f, "w") as fd:
+00031120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031130: 2020 2020 2020 2020 2023 2076 6572 7369           # versi
+00031140: 6f6e 7320 6172 6520 6120 636c 6965 6e74  ons are a client
+00031150: 206f 6e6c 7920 7468 696e 6720 736f 0a20   only thing so. 
+00031160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031170: 2020 2020 2020 2023 2064 6174 6166 696c         # datafil
+00031180: 6573 2066 726f 6d20 7468 6520 7365 7276  es from the serv
+00031190: 6572 2064 6f20 6e6f 7420 636f 6e74 6169  er do not contai
+000311a0: 6e73 2069 6e66 6f72 6d61 7469 6f6e 2061  ns information a
+000311b0: 626f 7574 2076 6572 7369 6f6e 730a 2020  bout versions.  
 000311c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000311d0: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
-000311e0: 6520 3d20 7265 736f 7572 6365 2e72 6570  e = resource.rep
-000311f0: 6c61 6365 286d 6174 6368 2c20 6d29 0a20  lace(match, m). 
-00031200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031210: 2020 2020 2020 2020 2020 2066 642e 7772             fd.wr
-00031220: 6974 6528 7265 736f 7572 6365 290a 2020  ite(resource).  
-00031230: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00031240: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00031250: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-00031260: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00031270: 2020 2020 2020 2020 2020 2020 636c 6963              clic
-00031280: 6b2e 6563 686f 2846 6565 6462 6163 6b4d  k.echo(FeedbackM
-00031290: 616e 6167 6572 2e69 6e66 6f5f 736b 6970  anager.info_skip
-000312a0: 5f61 6c72 6561 6479 5f65 7869 7374 7328  _already_exists(
-000312b0: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-000312c0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-000312d0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-000312e0: 2020 2020 2020 7261 6973 6520 636c 6963        raise clic
-000312f0: 6b2e 436c 6963 6b45 7863 6570 7469 6f6e  k.ClickException
-00031300: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-00031310: 2e65 7272 6f72 5f65 7863 6570 7469 6f6e  .error_exception
-00031320: 2865 7272 6f72 3d65 2929 0a0a 2020 2020  (error=e))..    
-00031330: 2020 2020 7661 6c75 6573 203d 2076 6572      values = ver
-00031340: 7369 6f6e 732e 7661 6c75 6573 2829 0a0a  sions.values()..
-00031350: 2020 2020 2020 2020 6966 2070 726f 6772          if progr
-00031360: 6573 735f 6261 723a 0a20 2020 2020 2020  ess_bar:.       
-00031370: 2020 2020 2077 6974 6820 636c 6963 6b2e       with click.
-00031380: 7072 6f67 7265 7373 6261 7228 7661 6c75  progressbar(valu
-00031390: 6573 2c20 6c61 6265 6c3d 6622 5075 6c6c  es, label=f"Pull
-000313a0: 696e 6720 7b65 7874 656e 7369 6f6e 7d73  ing {extension}s
-000313b0: 2229 2061 7320 7661 6c75 6573 3a20 2023  ") as values:  #
-000313c0: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-000313d0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-000313e0: 7220 6b20 696e 2076 616c 7565 733a 0a20  r k in values:. 
-000313f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031400: 2020 2061 7761 6974 2077 7269 7465 5f72     await write_r
-00031410: 6573 6f75 7263 6528 6b29 0a20 2020 2020  esource(k).     
-00031420: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00031430: 2020 2020 2074 6173 6b73 203d 205b 7772       tasks = [wr
-00031440: 6974 655f 7265 736f 7572 6365 286b 2920  ite_resource(k) 
-00031450: 666f 7220 6b20 696e 2076 616c 7565 735d  for k in values]
-00031460: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00031470: 6974 205f 6761 7468 6572 5f77 6974 685f  it _gather_with_
-00031480: 636f 6e63 7572 7265 6e63 7928 352c 202a  concurrency(5, *
-00031490: 7461 736b 7329 0a0a 2020 2020 7472 793a  tasks)..    try:
-000314a0: 0a20 2020 2020 2020 2064 6174 6173 6f75  .        datasou
-000314b0: 7263 6573 203d 2061 7761 6974 2063 6c69  rces = await cli
-000314c0: 656e 742e 6461 7461 736f 7572 6365 7328  ent.datasources(
-000314d0: 290a 2020 2020 2020 2020 7265 6d6f 7465  ).        remote
-000314e0: 5f64 6174 6173 6f75 7263 6573 203d 2073  _datasources = s
-000314f0: 6f72 7465 6428 5b78 5b22 6e61 6d65 225d  orted([x["name"]
-00031500: 2066 6f72 2078 2069 6e20 6461 7461 736f   for x in dataso
-00031510: 7572 6365 735d 290a 2020 2020 2020 2020  urces]).        
-00031520: 6461 7461 736f 7572 6365 735f 7665 7273  datasources_vers
-00031530: 696f 6e73 203d 205f 6765 745f 6c61 7465  ions = _get_late
-00031540: 7374 5f76 6572 7369 6f6e 7328 7265 6d6f  st_versions(remo
-00031550: 7465 5f64 6174 6173 6f75 7263 6573 290a  te_datasources).
-00031560: 0a20 2020 2020 2020 2070 6970 6573 203d  .        pipes =
-00031570: 2061 7761 6974 2063 6c69 656e 742e 7069   await client.pi
-00031580: 7065 7328 290a 2020 2020 2020 2020 7265  pes().        re
-00031590: 6d6f 7465 5f70 6970 6573 203d 2073 6f72  mote_pipes = sor
-000315a0: 7465 6428 5b78 5b22 6e61 6d65 225d 2066  ted([x["name"] f
-000315b0: 6f72 2078 2069 6e20 7069 7065 735d 290a  or x in pipes]).
-000315c0: 2020 2020 2020 2020 7069 7065 735f 7665          pipes_ve
-000315d0: 7273 696f 6e73 203d 205f 6765 745f 6c61  rsions = _get_la
-000315e0: 7465 7374 5f76 6572 7369 6f6e 7328 7265  test_versions(re
-000315f0: 6d6f 7465 5f70 6970 6573 290a 0a20 2020  mote_pipes)..   
-00031600: 2020 2020 2072 6573 6f75 7263 6573 203d       resources =
-00031610: 206c 6973 7428 6461 7461 736f 7572 6365   list(datasource
-00031620: 735f 7665 7273 696f 6e73 2e6b 6579 7328  s_versions.keys(
-00031630: 2929 202b 206c 6973 7428 7069 7065 735f  )) + list(pipes_
-00031640: 7665 7273 696f 6e73 2e6b 6579 7328 2929  versions.keys())
-00031650: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
-00031660: 7772 6974 655f 6669 6c65 7328 6461 7461  write_files(data
-00031670: 736f 7572 6365 735f 7665 7273 696f 6e73  sources_versions
-00031680: 2c20 7265 736f 7572 6365 732c 2022 6461  , resources, "da
-00031690: 7461 736f 7572 6365 222c 2022 6461 7461  tasource", "data
-000316a0: 736f 7572 6365 5f66 696c 6522 2c20 7072  source_file", pr
-000316b0: 6f67 7265 7373 5f62 6172 3d70 726f 6772  ogress_bar=progr
-000316c0: 6573 735f 6261 7229 0a20 2020 2020 2020  ess_bar).       
-000316d0: 2061 7761 6974 2077 7269 7465 5f66 696c   await write_fil
-000316e0: 6573 2870 6970 6573 5f76 6572 7369 6f6e  es(pipes_version
-000316f0: 732c 2072 6573 6f75 7263 6573 2c20 2270  s, resources, "p
-00031700: 6970 6522 2c20 2270 6970 655f 6669 6c65  ipe", "pipe_file
-00031710: 222c 2070 726f 6772 6573 735f 6261 723d  ", progress_bar=
-00031720: 7072 6f67 7265 7373 5f62 6172 290a 0a20  progress_bar).. 
-00031730: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00031740: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00031750: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00031760: 2020 7261 6973 6520 636c 6963 6b2e 436c    raise click.Cl
-00031770: 6963 6b45 7863 6570 7469 6f6e 2846 6565  ickException(Fee
-00031780: 6462 6163 6b4d 616e 6167 6572 2e65 7272  dbackManager.err
-00031790: 6f72 5f70 756c 6c28 6572 726f 723d 7374  or_pull(error=st
-000317a0: 7228 6529 2929 0a0a 0a64 6566 2063 6f6c  r(e)))...def col
-000317b0: 6f72 5f64 6966 6628 6469 6666 3a20 4974  or_diff(diff: It
-000317c0: 6572 6162 6c65 5b73 7472 5d29 202d 3e20  erable[str]) -> 
-000317d0: 4765 6e65 7261 746f 725b 7374 722c 2041  Generator[str, A
-000317e0: 6e79 2c20 4e6f 6e65 5d3a 0a20 2020 2066  ny, None]:.    f
-000317f0: 6f72 206c 696e 6520 696e 2064 6966 663a  or line in diff:
-00031800: 0a20 2020 2020 2020 2069 6620 6c69 6e65  .        if line
-00031810: 2e73 7461 7274 7377 6974 6828 222b 2229  .startswith("+")
-00031820: 3a0a 2020 2020 2020 2020 2020 2020 7969  :.            yi
-00031830: 656c 6420 466f 7265 2e47 5245 454e 202b  eld Fore.GREEN +
-00031840: 206c 696e 6520 2b20 466f 7265 2e52 4553   line + Fore.RES
-00031850: 4554 0a20 2020 2020 2020 2065 6c69 6620  ET.        elif 
-00031860: 6c69 6e65 2e73 7461 7274 7377 6974 6828  line.startswith(
-00031870: 222d 2229 3a0a 2020 2020 2020 2020 2020  "-"):.          
-00031880: 2020 7969 656c 6420 466f 7265 2e52 4544    yield Fore.RED
-00031890: 202b 206c 696e 6520 2b20 466f 7265 2e52   + line + Fore.R
-000318a0: 4553 4554 0a20 2020 2020 2020 2065 6c69  ESET.        eli
-000318b0: 6620 6c69 6e65 2e73 7461 7274 7377 6974  f line.startswit
-000318c0: 6828 225e 2229 3a0a 2020 2020 2020 2020  h("^"):.        
-000318d0: 2020 2020 7969 656c 6420 466f 7265 2e42      yield Fore.B
-000318e0: 4c55 4520 2b20 6c69 6e65 202b 2046 6f72  LUE + line + For
-000318f0: 652e 5245 5345 540a 2020 2020 2020 2020  e.RESET.        
-00031900: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00031910: 2020 7969 656c 6420 6c69 6e65 0a0a 0a64    yield line...d
-00031920: 6566 2070 6565 6b28 6974 6572 6162 6c65  ef peek(iterable
-00031930: 293a 0a20 2020 2074 7279 3a0a 2020 2020  ):.    try:.    
-00031940: 2020 2020 6669 7273 7420 3d20 6e65 7874      first = next
-00031950: 2869 7465 7261 626c 6529 0a20 2020 2065  (iterable).    e
-00031960: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-00031970: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00031980: 4e6f 6e65 2c20 4e6f 6e65 0a20 2020 2072  None, None.    r
-00031990: 6574 7572 6e20 6669 7273 742c 2069 7465  eturn first, ite
-000319a0: 7274 6f6f 6c73 2e63 6861 696e 285b 6669  rtools.chain([fi
-000319b0: 7273 745d 2c20 6974 6572 6162 6c65 290a  rst], iterable).
-000319c0: 0a0a 6173 796e 6320 6465 6620 6469 6666  ..async def diff
-000319d0: 5f63 6f6d 6d61 6e64 280a 2020 2020 6669  _command(.    fi
-000319e0: 6c65 6e61 6d65 733a 204f 7074 696f 6e61  lenames: Optiona
-000319f0: 6c5b 4c69 7374 5b73 7472 5d5d 2c0a 2020  l[List[str]],.  
-00031a00: 2020 666d 743a 2062 6f6f 6c2c 0a20 2020    fmt: bool,.   
-00031a10: 2063 6c69 656e 743a 2054 696e 7942 2c0a   client: TinyB,.
-00031a20: 2020 2020 6e6f 5f63 6f6c 6f72 3a20 4f70      no_color: Op
-00031a30: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2046  tional[bool] = F
-00031a40: 616c 7365 2c0a 2020 2020 7769 7468 5f70  alse,.    with_p
-00031a50: 7269 6e74 3a20 4f70 7469 6f6e 616c 5b62  rint: Optional[b
-00031a60: 6f6f 6c5d 203d 2054 7275 652c 0a20 2020  ool] = True,.   
-00031a70: 2076 6572 626f 7365 3a20 4f70 7469 6f6e   verbose: Option
-00031a80: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
-00031a90: 0a20 2020 2063 6c65 616e 5f75 703a 204f  .    clean_up: O
-00031aa0: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
-00031ab0: 4661 6c73 652c 0a20 2020 2070 726f 6772  False,.    progr
-00031ac0: 6573 735f 6261 723a 2062 6f6f 6c20 3d20  ess_bar: bool = 
-00031ad0: 4661 6c73 652c 0a20 2020 2066 6f72 5f64  False,.    for_d
-00031ae0: 6570 6c6f 793a 2062 6f6f 6c20 3d20 4661  eploy: bool = Fa
-00031af0: 6c73 652c 0a29 3a0a 2020 2020 6465 6620  lse,.):.    def 
-00031b00: 6973 5f73 6861 7265 645f 6461 7461 736f  is_shared_dataso
-00031b10: 7572 6365 286e 616d 6529 3a0a 2020 2020  urce(name):.    
-00031b20: 2020 2020 7265 7475 726e 2022 2e22 2069      return "." i
-00031b30: 6e20 6e61 6d65 0a0a 2020 2020 7769 7468  n name..    with
-00031b40: 5f65 7870 6c69 6369 745f 6669 6c65 6e61  _explicit_filena
-00031b50: 6d65 7320 3d20 6669 6c65 6e61 6d65 730a  mes = filenames.
-00031b60: 2020 2020 7665 7262 6f73 6520 3d20 5472      verbose = Tr
-00031b70: 7565 2069 6620 7665 7262 6f73 6520 6973  ue if verbose is
-00031b80: 204e 6f6e 6520 656c 7365 2076 6572 626f   None else verbo
-00031b90: 7365 0a0a 2020 2020 7461 7267 6574 5f64  se..    target_d
-00031ba0: 6972 203d 2067 6574 6377 6428 2920 2b20  ir = getcwd() + 
-00031bb0: 6f73 2e70 6174 682e 7365 7020 2b20 222e  os.path.sep + ".
-00031bc0: 6469 6666 5f74 6d70 220a 2020 2020 5061  diff_tmp".    Pa
-00031bd0: 7468 2874 6172 6765 745f 6469 7229 2e6d  th(target_dir).m
-00031be0: 6b64 6972 2870 6172 656e 7473 3d54 7275  kdir(parents=Tru
-00031bf0: 652c 2065 7869 7374 5f6f 6b3d 5472 7565  e, exist_ok=True
-00031c00: 290a 0a20 2020 2069 6620 6669 6c65 6e61  )..    if filena
-00031c10: 6d65 733a 0a20 2020 2020 2020 2069 6620  mes:.        if 
-00031c20: 6c65 6e28 6669 6c65 6e61 6d65 7329 203d  len(filenames) =
-00031c30: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-00031c40: 2066 696c 656e 616d 6573 203d 205b 6669   filenames = [fi
-00031c50: 6c65 6e61 6d65 735b 305d 5d20 2b20 6765  lenames[0]] + ge
-00031c60: 745f 7072 6f6a 6563 745f 6669 6c65 6e61  t_project_filena
-00031c70: 6d65 7328 6669 6c65 6e61 6d65 735b 305d  mes(filenames[0]
-00031c80: 290a 2020 2020 2020 2020 6177 6169 7420  ).        await 
-00031c90: 666f 6c64 6572 5f70 756c 6c28 636c 6965  folder_pull(clie
-00031ca0: 6e74 2c20 7461 7267 6574 5f64 6972 2c20  nt, target_dir, 
-00031cb0: 4661 6c73 652c 204e 6f6e 652c 2054 7275  False, None, Tru
-00031cc0: 652c 2076 6572 626f 7365 3d46 616c 7365  e, verbose=False
-00031cd0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-00031ce0: 2020 2020 6669 6c65 6e61 6d65 7320 3d20      filenames = 
-00031cf0: 6765 745f 7072 6f6a 6563 745f 6669 6c65  get_project_file
-00031d00: 6e61 6d65 7328 222e 2229 0a20 2020 2020  names(".").     
-00031d10: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-00031d20: 2020 2020 2020 2020 2020 2063 6c69 636b             click
-00031d30: 2e65 6368 6f28 2253 6176 696e 6720 7265  .echo("Saving re
-00031d40: 6d6f 7465 2072 6573 6f75 7263 6573 2069  mote resources i
-00031d50: 6e20 2e64 6966 665f 746d 7020 666f 6c64  n .diff_tmp fold
-00031d60: 6572 2e5c 6e22 290a 2020 2020 2020 2020  er.\n").        
-00031d70: 6177 6169 7420 666f 6c64 6572 5f70 756c  await folder_pul
-00031d80: 6c28 636c 6965 6e74 2c20 7461 7267 6574  l(client, target
-00031d90: 5f64 6972 2c20 4661 6c73 652c 204e 6f6e  _dir, False, Non
-00031da0: 652c 2054 7275 652c 2076 6572 626f 7365  e, True, verbose
-00031db0: 3d76 6572 626f 7365 2c20 7072 6f67 7265  =verbose, progre
-00031dc0: 7373 5f62 6172 3d70 726f 6772 6573 735f  ss_bar=progress_
-00031dd0: 6261 7229 0a0a 2020 2020 7265 6d6f 7465  bar)..    remote
-00031de0: 5f64 6174 6173 6f75 7263 6573 3a20 4c69  _datasources: Li
-00031df0: 7374 5b44 6963 745b 7374 722c 2041 6e79  st[Dict[str, Any
-00031e00: 5d5d 203d 2061 7761 6974 2063 6c69 656e  ]] = await clien
-00031e10: 742e 6461 7461 736f 7572 6365 7328 290a  t.datasources().
-00031e20: 2020 2020 7265 6d6f 7465 5f70 6970 6573      remote_pipes
-00031e30: 3a20 4c69 7374 5b44 6963 745b 7374 722c  : List[Dict[str,
-00031e40: 2041 6e79 5d5d 203d 2061 7761 6974 2063   Any]] = await c
-00031e50: 6c69 656e 742e 7069 7065 7328 290a 0a20  lient.pipes().. 
-00031e60: 2020 206c 6f63 616c 5f72 6573 6f75 7263     local_resourc
-00031e70: 6573 203d 207b 0a20 2020 2020 2020 2050  es = {.        P
-00031e80: 6174 6828 6669 6c65 292e 7265 736f 6c76  ath(file).resolv
-00031e90: 6528 292e 7374 656d 3a20 6669 6c65 0a20  e().stem: file. 
-00031ea0: 2020 2020 2020 2066 6f72 2066 696c 6520         for file 
-00031eb0: 696e 2066 696c 656e 616d 6573 0a20 2020  in filenames.   
-00031ec0: 2020 2020 2069 6620 2822 2e64 6174 6173       if (".datas
-00031ed0: 6f75 7263 6522 2069 6e20 6669 6c65 206f  ource" in file o
-00031ee0: 7220 222e 7069 7065 2220 696e 2066 696c  r ".pipe" in fil
-00031ef0: 6529 2061 6e64 2022 2e69 6e63 6c22 206e  e) and ".incl" n
-00031f00: 6f74 2069 6e20 6669 6c65 0a20 2020 207d  ot in file.    }
-00031f10: 0a0a 2020 2020 6368 616e 6765 6420 3d20  ..    changed = 
-00031f20: 7b7d 0a20 2020 2066 6f72 2072 6573 6f75  {}.    for resou
-00031f30: 7263 6520 696e 2072 656d 6f74 655f 6461  rce in remote_da
-00031f40: 7461 736f 7572 6365 7320 2b20 7265 6d6f  tasources + remo
-00031f50: 7465 5f70 6970 6573 3a0a 2020 2020 2020  te_pipes:.      
-00031f60: 2020 7072 6f70 6572 7469 6573 3a20 4469    properties: Di
-00031f70: 6374 5b73 7472 2c20 416e 795d 203d 2067  ct[str, Any] = g
-00031f80: 6574 5f6e 616d 655f 7665 7273 696f 6e28  et_name_version(
-00031f90: 7265 736f 7572 6365 5b22 6e61 6d65 225d  resource["name"]
-00031fa0: 290a 2020 2020 2020 2020 6e61 6d65 203d  ).        name =
-00031fb0: 2070 726f 7065 7274 6965 732e 6765 7428   properties.get(
-00031fc0: 226e 616d 6522 2c20 4e6f 6e65 290a 2020  "name", None).  
-00031fd0: 2020 2020 2020 6966 206e 616d 653a 0a20        if name:. 
-00031fe0: 2020 2020 2020 2020 2020 2028 7266 696c             (rfil
-00031ff0: 656e 616d 652c 2066 696c 6529 203d 206e  ename, file) = n
-00032000: 6578 7428 0a20 2020 2020 2020 2020 2020  ext(.           
-00032010: 2020 2020 2028 2872 6669 6c65 6e61 6d65       ((rfilename
-00032020: 2c20 6669 6c65 2920 666f 7220 2872 6669  , file) for (rfi
-00032030: 6c65 6e61 6d65 2c20 6669 6c65 2920 696e  lename, file) in
-00032040: 206c 6f63 616c 5f72 6573 6f75 7263 6573   local_resources
-00032050: 2e69 7465 6d73 2829 2069 6620 6e61 6d65  .items() if name
-00032060: 203d 3d20 7266 696c 656e 616d 6529 2c0a   == rfilename),.
-00032070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032080: 2822 222c 204e 6f6e 6529 2c0a 2020 2020  ("", None),.    
-00032090: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000320a0: 2020 2020 2020 6966 206e 6f74 2066 696c        if not fil
-000320b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000320c0: 2020 2069 6620 6e6f 7420 7769 7468 5f65     if not with_e
-000320d0: 7870 6c69 6369 745f 6669 6c65 6e61 6d65  xplicit_filename
-000320e0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-000320f0: 2020 2020 2020 2069 6620 7769 7468 5f70         if with_p
-00032100: 7269 6e74 3a0a 2020 2020 2020 2020 2020  rint:.          
-00032110: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00032120: 6963 6b2e 6563 686f 2866 227b 7265 736f  ick.echo(f"{reso
-00032130: 7572 6365 5b27 6e61 6d65 275d 7d20 6f6e  urce['name']} on
-00032140: 6c79 2065 7869 7374 7320 7265 6d6f 7465  ly exists remote
-00032150: 6c79 5c6e 2229 0a20 2020 2020 2020 2020  ly\n").         
-00032160: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00032170: 5f73 6861 7265 645f 6461 7461 736f 7572  _shared_datasour
-00032180: 6365 2872 6573 6f75 7263 655b 226e 616d  ce(resource["nam
-00032190: 6522 5d29 3a0a 2020 2020 2020 2020 2020  e"]):.          
-000321a0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-000321b0: 616e 6765 645b 7265 736f 7572 6365 5b22  anged[resource["
-000321c0: 6e61 6d65 225d 5d20 3d20 2273 6861 7265  name"]] = "share
-000321d0: 6422 0a20 2020 2020 2020 2020 2020 2020  d".             
-000321e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000321f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032200: 2020 2020 2063 6861 6e67 6564 5b72 6573       changed[res
-00032210: 6f75 7263 655b 226e 616d 6522 5d5d 203d  ource["name"]] =
-00032220: 2022 7265 6d6f 7465 220a 2020 2020 2020   "remote".      
-00032230: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00032240: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
-00032250: 7375 6666 6978 203d 2022 2e64 6174 6173  suffix = ".datas
-00032260: 6f75 7263 6522 2069 6620 222e 6461 7461  ource" if ".data
-00032270: 736f 7572 6365 2220 696e 2066 696c 6520  source" in file 
-00032280: 656c 7365 2022 2e70 6970 6522 0a20 2020  else ".pipe".   
-00032290: 2020 2020 2020 2020 2074 6172 6765 7420           target 
-000322a0: 3d20 7461 7267 6574 5f64 6972 202b 206f  = target_dir + o
-000322b0: 732e 7061 7468 2e73 6570 202b 2072 6669  s.path.sep + rfi
-000322c0: 6c65 6e61 6d65 202b 2073 7566 6669 780a  lename + suffix.
-000322d0: 0a20 2020 2020 2020 2020 2020 2064 6966  .            dif
-000322e0: 665f 6c69 6e65 7320 3d20 6177 6169 7420  f_lines = await 
-000322f0: 6469 6666 5f66 696c 6573 280a 2020 2020  diff_files(.    
-00032300: 2020 2020 2020 2020 2020 2020 7461 7267              targ
-00032310: 6574 2c20 6669 6c65 2c20 7769 7468 5f66  et, file, with_f
-00032320: 6f72 6d61 743d 666d 742c 2077 6974 685f  ormat=fmt, with_
-00032330: 636f 6c6f 723d 286e 6f74 206e 6f5f 636f  color=(not no_co
-00032340: 6c6f 7229 2c20 636c 6965 6e74 3d63 6c69  lor), client=cli
-00032350: 656e 742c 2066 6f72 5f64 6570 6c6f 793d  ent, for_deploy=
-00032360: 666f 725f 6465 706c 6f79 0a20 2020 2020  for_deploy.     
-00032370: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00032380: 2020 2020 206e 6f74 5f65 6d70 7479 2c20       not_empty, 
-00032390: 6469 6666 5f6c 696e 6573 203d 2070 6565  diff_lines = pee
-000323a0: 6b28 6469 6666 5f6c 696e 6573 290a 2020  k(diff_lines).  
+000311d0: 2020 2020 2020 6966 206b 5b22 7665 7273        if k["vers
+000311e0: 696f 6e22 5d20 3e3d 2030 3a0a 2020 2020  ion"] >= 0:.    
+000311f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031200: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+00031210: 203d 2066 2256 4552 5349 4f4e 207b 6b5b   = f"VERSION {k[
+00031220: 2776 6572 7369 6f6e 275d 7d5c 6e22 202b  'version']}\n" +
+00031230: 2072 6573 6f75 7263 650a 2020 2020 2020   resource.      
+00031240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031250: 2020 6966 2072 6573 6f75 7263 653a 0a20    if resource:. 
+00031260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031270: 2020 2020 2020 2020 2020 206d 6174 6368             match
+00031280: 6573 203d 2072 652e 6669 6e64 616c 6c28  es = re.findall(
+00031290: 7222 285b 5e5c 735c 2e5d 2a5f 5f76 5c64  r"([^\s\.]*__v\d
+000312a0: 2b29 222c 2072 6573 6f75 7263 6529 0a20  +)", resource). 
+000312b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312c0: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
+000312d0: 6174 6368 2069 6e20 7365 7428 6d61 7463  atch in set(matc
+000312e0: 6865 7329 3a0a 2020 2020 2020 2020 2020  hes):.          
+000312f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031300: 2020 2020 2020 6d20 3d20 6d61 7463 682e        m = match.
+00031310: 7370 6c69 7428 225f 5f76 2229 5b30 5d0a  split("__v")[0].
+00031320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031340: 6966 206d 2069 6e20 7265 736f 7572 6365  if m in resource
+00031350: 7320 6f72 206d 2069 6e20 7265 736f 7572  s or m in resour
+00031360: 6365 5f6e 616d 6573 3a0a 2020 2020 2020  ce_names:.      
+00031370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031380: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00031390: 736f 7572 6365 203d 2072 6573 6f75 7263  source = resourc
+000313a0: 652e 7265 706c 6163 6528 6d61 7463 682c  e.replace(match,
+000313b0: 206d 290a 2020 2020 2020 2020 2020 2020   m).            
+000313c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313d0: 6664 2e77 7269 7465 2872 6573 6f75 7263  fd.write(resourc
+000313e0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+000313f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00031400: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00031410: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+00031420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031430: 2063 6c69 636b 2e65 6368 6f28 4665 6564   click.echo(Feed
+00031440: 6261 636b 4d61 6e61 6765 722e 696e 666f  backManager.info
+00031450: 5f73 6b69 705f 616c 7265 6164 795f 6578  _skip_already_ex
+00031460: 6973 7473 2829 290a 2020 2020 2020 2020  ists()).        
+00031470: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00031480: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00031490: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000314a0: 2063 6c69 636b 2e43 6c69 636b 4578 6365   click.ClickExce
+000314b0: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+000314c0: 6e61 6765 722e 6572 726f 725f 6578 6365  nager.error_exce
+000314d0: 7074 696f 6e28 6572 726f 723d 6529 290a  ption(error=e)).
+000314e0: 0a20 2020 2020 2020 2076 616c 7565 7320  .        values 
+000314f0: 3d20 7665 7273 696f 6e73 2e76 616c 7565  = versions.value
+00031500: 7328 290a 0a20 2020 2020 2020 2069 6620  s()..        if 
+00031510: 7072 6f67 7265 7373 5f62 6172 3a0a 2020  progress_bar:.  
+00031520: 2020 2020 2020 2020 2020 7769 7468 2063            with c
+00031530: 6c69 636b 2e70 726f 6772 6573 7362 6172  lick.progressbar
+00031540: 2876 616c 7565 732c 206c 6162 656c 3d66  (values, label=f
+00031550: 2250 756c 6c69 6e67 207b 6578 7465 6e73  "Pulling {extens
+00031560: 696f 6e7d 7322 2920 6173 2076 616c 7565  ion}s") as value
+00031570: 733a 2020 2320 7479 7065 3a20 6967 6e6f  s:  # type: igno
+00031580: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+00031590: 2020 2066 6f72 206b 2069 6e20 7661 6c75     for k in valu
+000315a0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000315b0: 2020 2020 2020 2020 6177 6169 7420 7772          await wr
+000315c0: 6974 655f 7265 736f 7572 6365 286b 290a  ite_resource(k).
+000315d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000315e0: 2020 2020 2020 2020 2020 7461 736b 7320            tasks 
+000315f0: 3d20 5b77 7269 7465 5f72 6573 6f75 7263  = [write_resourc
+00031600: 6528 6b29 2066 6f72 206b 2069 6e20 7661  e(k) for k in va
+00031610: 6c75 6573 5d0a 2020 2020 2020 2020 2020  lues].          
+00031620: 2020 6177 6169 7420 5f67 6174 6865 725f    await _gather_
+00031630: 7769 7468 5f63 6f6e 6375 7272 656e 6379  with_concurrency
+00031640: 2835 2c20 2a74 6173 6b73 290a 0a20 2020  (5, *tasks)..   
+00031650: 2074 7279 3a0a 2020 2020 2020 2020 6461   try:.        da
+00031660: 7461 736f 7572 6365 7320 3d20 6177 6169  tasources = awai
+00031670: 7420 636c 6965 6e74 2e64 6174 6173 6f75  t client.datasou
+00031680: 7263 6573 2829 0a20 2020 2020 2020 2072  rces().        r
+00031690: 656d 6f74 655f 6461 7461 736f 7572 6365  emote_datasource
+000316a0: 7320 3d20 736f 7274 6564 285b 785b 226e  s = sorted([x["n
+000316b0: 616d 6522 5d20 666f 7220 7820 696e 2064  ame"] for x in d
+000316c0: 6174 6173 6f75 7263 6573 5d29 0a20 2020  atasources]).   
+000316d0: 2020 2020 2064 6174 6173 6f75 7263 6573       datasources
+000316e0: 5f76 6572 7369 6f6e 7320 3d20 5f67 6574  _versions = _get
+000316f0: 5f6c 6174 6573 745f 7665 7273 696f 6e73  _latest_versions
+00031700: 2872 656d 6f74 655f 6461 7461 736f 7572  (remote_datasour
+00031710: 6365 7329 0a0a 2020 2020 2020 2020 7069  ces)..        pi
+00031720: 7065 7320 3d20 6177 6169 7420 636c 6965  pes = await clie
+00031730: 6e74 2e70 6970 6573 2829 0a20 2020 2020  nt.pipes().     
+00031740: 2020 2072 656d 6f74 655f 7069 7065 7320     remote_pipes 
+00031750: 3d20 736f 7274 6564 285b 785b 226e 616d  = sorted([x["nam
+00031760: 6522 5d20 666f 7220 7820 696e 2070 6970  e"] for x in pip
+00031770: 6573 5d29 0a20 2020 2020 2020 2070 6970  es]).        pip
+00031780: 6573 5f76 6572 7369 6f6e 7320 3d20 5f67  es_versions = _g
+00031790: 6574 5f6c 6174 6573 745f 7665 7273 696f  et_latest_versio
+000317a0: 6e73 2872 656d 6f74 655f 7069 7065 7329  ns(remote_pipes)
+000317b0: 0a0a 2020 2020 2020 2020 7265 736f 7572  ..        resour
+000317c0: 6365 7320 3d20 6c69 7374 2864 6174 6173  ces = list(datas
+000317d0: 6f75 7263 6573 5f76 6572 7369 6f6e 732e  ources_versions.
+000317e0: 6b65 7973 2829 2920 2b20 6c69 7374 2870  keys()) + list(p
+000317f0: 6970 6573 5f76 6572 7369 6f6e 732e 6b65  ipes_versions.ke
+00031800: 7973 2829 290a 0a20 2020 2020 2020 2061  ys())..        a
+00031810: 7761 6974 2077 7269 7465 5f66 696c 6573  wait write_files
+00031820: 2864 6174 6173 6f75 7263 6573 5f76 6572  (datasources_ver
+00031830: 7369 6f6e 732c 2072 6573 6f75 7263 6573  sions, resources
+00031840: 2c20 2264 6174 6173 6f75 7263 6522 2c20  , "datasource", 
+00031850: 2264 6174 6173 6f75 7263 655f 6669 6c65  "datasource_file
+00031860: 222c 2070 726f 6772 6573 735f 6261 723d  ", progress_bar=
+00031870: 7072 6f67 7265 7373 5f62 6172 290a 2020  progress_bar).  
+00031880: 2020 2020 2020 6177 6169 7420 7772 6974        await writ
+00031890: 655f 6669 6c65 7328 7069 7065 735f 7665  e_files(pipes_ve
+000318a0: 7273 696f 6e73 2c20 7265 736f 7572 6365  rsions, resource
+000318b0: 732c 2022 7069 7065 222c 2022 7069 7065  s, "pipe", "pipe
+000318c0: 5f66 696c 6522 2c20 7072 6f67 7265 7373  _file", progress
+000318d0: 5f62 6172 3d70 726f 6772 6573 735f 6261  _bar=progress_ba
+000318e0: 7229 0a0a 2020 2020 2020 2020 7265 7475  r)..        retu
+000318f0: 726e 0a0a 2020 2020 6578 6365 7074 2045  rn..    except E
+00031900: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+00031910: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
+00031920: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
+00031930: 6e28 4665 6564 6261 636b 4d61 6e61 6765  n(FeedbackManage
+00031940: 722e 6572 726f 725f 7075 6c6c 2865 7272  r.error_pull(err
+00031950: 6f72 3d73 7472 2865 2929 290a 0a0a 6465  or=str(e)))...de
+00031960: 6620 636f 6c6f 725f 6469 6666 2864 6966  f color_diff(dif
+00031970: 663a 2049 7465 7261 626c 655b 7374 725d  f: Iterable[str]
+00031980: 2920 2d3e 2047 656e 6572 6174 6f72 5b73  ) -> Generator[s
+00031990: 7472 2c20 416e 792c 204e 6f6e 655d 3a0a  tr, Any, None]:.
+000319a0: 2020 2020 666f 7220 6c69 6e65 2069 6e20      for line in 
+000319b0: 6469 6666 3a0a 2020 2020 2020 2020 6966  diff:.        if
+000319c0: 206c 696e 652e 7374 6172 7473 7769 7468   line.startswith
+000319d0: 2822 2b22 293a 0a20 2020 2020 2020 2020  ("+"):.         
+000319e0: 2020 2079 6965 6c64 2046 6f72 652e 4752     yield Fore.GR
+000319f0: 4545 4e20 2b20 6c69 6e65 202b 2046 6f72  EEN + line + For
+00031a00: 652e 5245 5345 540a 2020 2020 2020 2020  e.RESET.        
+00031a10: 656c 6966 206c 696e 652e 7374 6172 7473  elif line.starts
+00031a20: 7769 7468 2822 2d22 293a 0a20 2020 2020  with("-"):.     
+00031a30: 2020 2020 2020 2079 6965 6c64 2046 6f72         yield For
+00031a40: 652e 5245 4420 2b20 6c69 6e65 202b 2046  e.RED + line + F
+00031a50: 6f72 652e 5245 5345 540a 2020 2020 2020  ore.RESET.      
+00031a60: 2020 656c 6966 206c 696e 652e 7374 6172    elif line.star
+00031a70: 7473 7769 7468 2822 5e22 293a 0a20 2020  tswith("^"):.   
+00031a80: 2020 2020 2020 2020 2079 6965 6c64 2046           yield F
+00031a90: 6f72 652e 424c 5545 202b 206c 696e 6520  ore.BLUE + line 
+00031aa0: 2b20 466f 7265 2e52 4553 4554 0a20 2020  + Fore.RESET.   
+00031ab0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00031ac0: 2020 2020 2020 2079 6965 6c64 206c 696e         yield lin
+00031ad0: 650a 0a0a 6465 6620 7065 656b 2869 7465  e...def peek(ite
+00031ae0: 7261 626c 6529 3a0a 2020 2020 7472 793a  rable):.    try:
+00031af0: 0a20 2020 2020 2020 2066 6972 7374 203d  .        first =
+00031b00: 206e 6578 7428 6974 6572 6162 6c65 290a   next(iterable).
+00031b10: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00031b20: 7469 6f6e 3a0a 2020 2020 2020 2020 7265  tion:.        re
+00031b30: 7475 726e 204e 6f6e 652c 204e 6f6e 650a  turn None, None.
+00031b40: 2020 2020 7265 7475 726e 2066 6972 7374      return first
+00031b50: 2c20 6974 6572 746f 6f6c 732e 6368 6169  , itertools.chai
+00031b60: 6e28 5b66 6972 7374 5d2c 2069 7465 7261  n([first], itera
+00031b70: 626c 6529 0a0a 0a61 7379 6e63 2064 6566  ble)...async def
+00031b80: 2064 6966 665f 636f 6d6d 616e 6428 0a20   diff_command(. 
+00031b90: 2020 2066 696c 656e 616d 6573 3a20 4f70     filenames: Op
+00031ba0: 7469 6f6e 616c 5b4c 6973 745b 7374 725d  tional[List[str]
+00031bb0: 5d2c 0a20 2020 2066 6d74 3a20 626f 6f6c  ],.    fmt: bool
+00031bc0: 2c0a 2020 2020 636c 6965 6e74 3a20 5469  ,.    client: Ti
+00031bd0: 6e79 422c 0a20 2020 206e 6f5f 636f 6c6f  nyB,.    no_colo
+00031be0: 723a 204f 7074 696f 6e61 6c5b 626f 6f6c  r: Optional[bool
+00031bf0: 5d20 3d20 4661 6c73 652c 0a20 2020 2077  ] = False,.    w
+00031c00: 6974 685f 7072 696e 743a 204f 7074 696f  ith_print: Optio
+00031c10: 6e61 6c5b 626f 6f6c 5d20 3d20 5472 7565  nal[bool] = True
+00031c20: 2c0a 2020 2020 7665 7262 6f73 653a 204f  ,.    verbose: O
+00031c30: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00031c40: 4e6f 6e65 2c0a 2020 2020 636c 6561 6e5f  None,.    clean_
+00031c50: 7570 3a20 4f70 7469 6f6e 616c 5b62 6f6f  up: Optional[boo
+00031c60: 6c5d 203d 2046 616c 7365 2c0a 2020 2020  l] = False,.    
+00031c70: 7072 6f67 7265 7373 5f62 6172 3a20 626f  progress_bar: bo
+00031c80: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00031c90: 666f 725f 6465 706c 6f79 3a20 626f 6f6c  for_deploy: bool
+00031ca0: 203d 2046 616c 7365 2c0a 293a 0a20 2020   = False,.):.   
+00031cb0: 2064 6566 2069 735f 7368 6172 6564 5f64   def is_shared_d
+00031cc0: 6174 6173 6f75 7263 6528 6e61 6d65 293a  atasource(name):
+00031cd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00031ce0: 222e 2220 696e 206e 616d 650a 0a20 2020  "." in name..   
+00031cf0: 2077 6974 685f 6578 706c 6963 6974 5f66   with_explicit_f
+00031d00: 696c 656e 616d 6573 203d 2066 696c 656e  ilenames = filen
+00031d10: 616d 6573 0a20 2020 2076 6572 626f 7365  ames.    verbose
+00031d20: 203d 2054 7275 6520 6966 2076 6572 626f   = True if verbo
+00031d30: 7365 2069 7320 4e6f 6e65 2065 6c73 6520  se is None else 
+00031d40: 7665 7262 6f73 650a 0a20 2020 2074 6172  verbose..    tar
+00031d50: 6765 745f 6469 7220 3d20 6765 7463 7764  get_dir = getcwd
+00031d60: 2829 202b 206f 732e 7061 7468 2e73 6570  () + os.path.sep
+00031d70: 202b 2022 2e64 6966 665f 746d 7022 0a20   + ".diff_tmp". 
+00031d80: 2020 2050 6174 6828 7461 7267 6574 5f64     Path(target_d
+00031d90: 6972 292e 6d6b 6469 7228 7061 7265 6e74  ir).mkdir(parent
+00031da0: 733d 5472 7565 2c20 6578 6973 745f 6f6b  s=True, exist_ok
+00031db0: 3d54 7275 6529 0a0a 2020 2020 6966 2066  =True)..    if f
+00031dc0: 696c 656e 616d 6573 3a0a 2020 2020 2020  ilenames:.      
+00031dd0: 2020 6966 206c 656e 2866 696c 656e 616d    if len(filenam
+00031de0: 6573 2920 3d3d 2031 3a0a 2020 2020 2020  es) == 1:.      
+00031df0: 2020 2020 2020 6669 6c65 6e61 6d65 7320        filenames 
+00031e00: 3d20 5b66 696c 656e 616d 6573 5b30 5d5d  = [filenames[0]]
+00031e10: 202b 2067 6574 5f70 726f 6a65 6374 5f66   + get_project_f
+00031e20: 696c 656e 616d 6573 2866 696c 656e 616d  ilenames(filenam
+00031e30: 6573 5b30 5d29 0a20 2020 2020 2020 2061  es[0]).        a
+00031e40: 7761 6974 2066 6f6c 6465 725f 7075 6c6c  wait folder_pull
+00031e50: 2863 6c69 656e 742c 2074 6172 6765 745f  (client, target_
+00031e60: 6469 722c 2046 616c 7365 2c20 4e6f 6e65  dir, False, None
+00031e70: 2c20 5472 7565 2c20 7665 7262 6f73 653d  , True, verbose=
+00031e80: 4661 6c73 6529 0a20 2020 2065 6c73 653a  False).    else:
+00031e90: 0a20 2020 2020 2020 2066 696c 656e 616d  .        filenam
+00031ea0: 6573 203d 2067 6574 5f70 726f 6a65 6374  es = get_project
+00031eb0: 5f66 696c 656e 616d 6573 2822 2e22 290a  _filenames(".").
+00031ec0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00031ed0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00031ee0: 636c 6963 6b2e 6563 686f 2822 5361 7669  click.echo("Savi
+00031ef0: 6e67 2072 656d 6f74 6520 7265 736f 7572  ng remote resour
+00031f00: 6365 7320 696e 202e 6469 6666 5f74 6d70  ces in .diff_tmp
+00031f10: 2066 6f6c 6465 722e 5c6e 2229 0a20 2020   folder.\n").   
+00031f20: 2020 2020 2061 7761 6974 2066 6f6c 6465       await folde
+00031f30: 725f 7075 6c6c 2863 6c69 656e 742c 2074  r_pull(client, t
+00031f40: 6172 6765 745f 6469 722c 2046 616c 7365  arget_dir, False
+00031f50: 2c20 4e6f 6e65 2c20 5472 7565 2c20 7665  , None, True, ve
+00031f60: 7262 6f73 653d 7665 7262 6f73 652c 2070  rbose=verbose, p
+00031f70: 726f 6772 6573 735f 6261 723d 7072 6f67  rogress_bar=prog
+00031f80: 7265 7373 5f62 6172 290a 0a20 2020 2072  ress_bar)..    r
+00031f90: 656d 6f74 655f 6461 7461 736f 7572 6365  emote_datasource
+00031fa0: 733a 204c 6973 745b 4469 6374 5b73 7472  s: List[Dict[str
+00031fb0: 2c20 416e 795d 5d20 3d20 6177 6169 7420  , Any]] = await 
+00031fc0: 636c 6965 6e74 2e64 6174 6173 6f75 7263  client.datasourc
+00031fd0: 6573 2829 0a20 2020 2072 656d 6f74 655f  es().    remote_
+00031fe0: 7069 7065 733a 204c 6973 745b 4469 6374  pipes: List[Dict
+00031ff0: 5b73 7472 2c20 416e 795d 5d20 3d20 6177  [str, Any]] = aw
+00032000: 6169 7420 636c 6965 6e74 2e70 6970 6573  ait client.pipes
+00032010: 2829 0a0a 2020 2020 6c6f 6361 6c5f 7265  ()..    local_re
+00032020: 736f 7572 6365 7320 3d20 7b0a 2020 2020  sources = {.    
+00032030: 2020 2020 5061 7468 2866 696c 6529 2e72      Path(file).r
+00032040: 6573 6f6c 7665 2829 2e73 7465 6d3a 2066  esolve().stem: f
+00032050: 696c 650a 2020 2020 2020 2020 666f 7220  ile.        for 
+00032060: 6669 6c65 2069 6e20 6669 6c65 6e61 6d65  file in filename
+00032070: 730a 2020 2020 2020 2020 6966 2028 222e  s.        if (".
+00032080: 6461 7461 736f 7572 6365 2220 696e 2066  datasource" in f
+00032090: 696c 6520 6f72 2022 2e70 6970 6522 2069  ile or ".pipe" i
+000320a0: 6e20 6669 6c65 2920 616e 6420 222e 696e  n file) and ".in
+000320b0: 636c 2220 6e6f 7420 696e 2066 696c 650a  cl" not in file.
+000320c0: 2020 2020 7d0a 0a20 2020 2063 6861 6e67      }..    chang
+000320d0: 6564 203d 207b 7d0a 2020 2020 666f 7220  ed = {}.    for 
+000320e0: 7265 736f 7572 6365 2069 6e20 7265 6d6f  resource in remo
+000320f0: 7465 5f64 6174 6173 6f75 7263 6573 202b  te_datasources +
+00032100: 2072 656d 6f74 655f 7069 7065 733a 0a20   remote_pipes:. 
+00032110: 2020 2020 2020 2070 726f 7065 7274 6965         propertie
+00032120: 733a 2044 6963 745b 7374 722c 2041 6e79  s: Dict[str, Any
+00032130: 5d20 3d20 6765 745f 6e61 6d65 5f76 6572  ] = get_name_ver
+00032140: 7369 6f6e 2872 6573 6f75 7263 655b 226e  sion(resource["n
+00032150: 616d 6522 5d29 0a20 2020 2020 2020 206e  ame"]).        n
+00032160: 616d 6520 3d20 7072 6f70 6572 7469 6573  ame = properties
+00032170: 2e67 6574 2822 6e61 6d65 222c 204e 6f6e  .get("name", Non
+00032180: 6529 0a20 2020 2020 2020 2069 6620 6e61  e).        if na
+00032190: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
+000321a0: 2872 6669 6c65 6e61 6d65 2c20 6669 6c65  (rfilename, file
+000321b0: 2920 3d20 6e65 7874 280a 2020 2020 2020  ) = next(.      
+000321c0: 2020 2020 2020 2020 2020 2828 7266 696c            ((rfil
+000321d0: 656e 616d 652c 2066 696c 6529 2066 6f72  ename, file) for
+000321e0: 2028 7266 696c 656e 616d 652c 2066 696c   (rfilename, fil
+000321f0: 6529 2069 6e20 6c6f 6361 6c5f 7265 736f  e) in local_reso
+00032200: 7572 6365 732e 6974 656d 7328 2920 6966  urces.items() if
+00032210: 206e 616d 6520 3d3d 2072 6669 6c65 6e61   name == rfilena
+00032220: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
+00032230: 2020 2020 2028 2222 2c20 4e6f 6e65 292c       ("", None),
+00032240: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00032250: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00032260: 7420 6669 6c65 3a0a 2020 2020 2020 2020  t file:.        
+00032270: 2020 2020 2020 2020 6966 206e 6f74 2077          if not w
+00032280: 6974 685f 6578 706c 6963 6974 5f66 696c  ith_explicit_fil
+00032290: 656e 616d 6573 3a0a 2020 2020 2020 2020  enames:.        
+000322a0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+000322b0: 6974 685f 7072 696e 743a 0a20 2020 2020  ith_print:.     
+000322c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322d0: 2020 2063 6c69 636b 2e65 6368 6f28 6622     click.echo(f"
+000322e0: 7b72 6573 6f75 7263 655b 276e 616d 6527  {resource['name'
+000322f0: 5d7d 206f 6e6c 7920 6578 6973 7473 2072  ]} only exists r
+00032300: 656d 6f74 656c 795c 6e22 290a 2020 2020  emotely\n").    
+00032310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032320: 6966 2069 735f 7368 6172 6564 5f64 6174  if is_shared_dat
+00032330: 6173 6f75 7263 6528 7265 736f 7572 6365  asource(resource
+00032340: 5b22 6e61 6d65 225d 293a 0a20 2020 2020  ["name"]):.     
+00032350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032360: 2020 2063 6861 6e67 6564 5b72 6573 6f75     changed[resou
+00032370: 7263 655b 226e 616d 6522 5d5d 203d 2022  rce["name"]] = "
+00032380: 7368 6172 6564 220a 2020 2020 2020 2020  shared".        
+00032390: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000323a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
 000323b0: 2020 2020 2020 2020 2020 6368 616e 6765            change
-000323c0: 645b 7266 696c 656e 616d 655d 203d 206e  d[rfilename] = n
-000323d0: 6f74 5f65 6d70 7479 0a20 2020 2020 2020  ot_empty.       
-000323e0: 2020 2020 2069 6620 6e6f 745f 656d 7074       if not_empt
-000323f0: 7920 616e 6420 7769 7468 5f70 7269 6e74  y and with_print
-00032400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00032410: 2020 7379 732e 7374 646f 7574 2e77 7269    sys.stdout.wri
-00032420: 7465 6c69 6e65 7328 6469 6666 5f6c 696e  telines(diff_lin
-00032430: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-00032440: 2020 2020 636c 6963 6b2e 6563 686f 2822      click.echo("
-00032450: 2229 0a0a 2020 2020 666f 7220 7266 696c  ")..    for rfil
-00032460: 656e 616d 652c 205f 2069 6e20 6c6f 6361  ename, _ in loca
-00032470: 6c5f 7265 736f 7572 6365 732e 6974 656d  l_resources.item
-00032480: 7328 293a 0a20 2020 2020 2020 2069 6620  s():.        if 
-00032490: 7266 696c 656e 616d 6520 6e6f 7420 696e  rfilename not in
-000324a0: 2063 6861 6e67 6564 3a0a 2020 2020 2020   changed:.      
-000324b0: 2020 2020 2020 666f 7220 7265 736f 7572        for resour
-000324c0: 6365 2069 6e20 7265 6d6f 7465 5f64 6174  ce in remote_dat
-000324d0: 6173 6f75 7263 6573 202b 2072 656d 6f74  asources + remot
-000324e0: 655f 7069 7065 733a 0a20 2020 2020 2020  e_pipes:.       
-000324f0: 2020 2020 2020 2020 2070 726f 7065 7274           propert
-00032500: 6965 7320 3d20 6765 745f 6e61 6d65 5f76  ies = get_name_v
-00032510: 6572 7369 6f6e 2872 6573 6f75 7263 655b  ersion(resource[
-00032520: 226e 616d 6522 5d29 0a20 2020 2020 2020  "name"]).       
-00032530: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
-00032540: 7072 6f70 6572 7469 6573 2e67 6574 2822  properties.get("
-00032550: 6e61 6d65 222c 204e 6f6e 6529 0a20 2020  name", None).   
-00032560: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00032570: 6e61 6d65 2061 6e64 206e 616d 6520 3d3d  name and name ==
-00032580: 2072 6669 6c65 6e61 6d65 3a0a 2020 2020   rfilename:.    
-00032590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325a0: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
-000325b0: 2020 2020 2020 2069 6620 7769 7468 5f70         if with_p
-000325c0: 7269 6e74 2061 6e64 2072 6669 6c65 6e61  rint and rfilena
-000325d0: 6d65 206e 6f74 2069 6e20 6368 616e 6765  me not in change
-000325e0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-000325f0: 2020 2020 2020 2063 6c69 636b 2e65 6368         click.ech
-00032600: 6f28 6622 7b72 6669 6c65 6e61 6d65 7d20  o(f"{rfilename} 
-00032610: 6f6e 6c79 2065 7869 7374 7320 6c6f 6361  only exists loca
-00032620: 6c6c 795c 6e22 290a 2020 2020 2020 2020  lly\n").        
-00032630: 2020 2020 2020 2020 6368 616e 6765 645b          changed[
-00032640: 7266 696c 656e 616d 655d 203d 2022 6c6f  rfilename] = "lo
-00032650: 6361 6c22 0a20 2020 2069 6620 636c 6561  cal".    if clea
-00032660: 6e5f 7570 3a0a 2020 2020 2020 2020 7368  n_up:.        sh
-00032670: 7574 696c 2e72 6d74 7265 6528 7461 7267  util.rmtree(targ
-00032680: 6574 5f64 6972 290a 0a20 2020 2072 6574  et_dir)..    ret
-00032690: 7572 6e20 6368 616e 6765 640a 0a0a 6173  urn changed...as
-000326a0: 796e 6320 6465 6620 6469 6666 5f66 696c  ync def diff_fil
-000326b0: 6573 280a 2020 2020 6672 6f6d 5f66 696c  es(.    from_fil
-000326c0: 653a 2073 7472 2c0a 2020 2020 746f 5f66  e: str,.    to_f
-000326d0: 696c 653a 2073 7472 2c0a 2020 2020 6672  ile: str,.    fr
-000326e0: 6f6d 5f66 696c 655f 7375 6666 6978 3a20  om_file_suffix: 
-000326f0: 7374 7220 3d20 225b 7265 6d6f 7465 5d22  str = "[remote]"
-00032700: 2c0a 2020 2020 746f 5f66 696c 655f 7375  ,.    to_file_su
-00032710: 6666 6978 3a20 7374 7220 3d20 225b 6c6f  ffix: str = "[lo
-00032720: 6361 6c5d 222c 0a20 2020 2077 6974 685f  cal]",.    with_
-00032730: 666f 726d 6174 3a20 626f 6f6c 203d 2054  format: bool = T
-00032740: 7275 652c 0a20 2020 2077 6974 685f 636f  rue,.    with_co
-00032750: 6c6f 723a 2062 6f6f 6c20 3d20 4661 6c73  lor: bool = Fals
-00032760: 652c 0a20 2020 2063 6c69 656e 743a 204f  e,.    client: O
-00032770: 7074 696f 6e61 6c5b 5469 6e79 425d 203d  ptional[TinyB] =
-00032780: 204e 6f6e 652c 0a20 2020 2066 6f72 5f64   None,.    for_d
-00032790: 6570 6c6f 793a 2062 6f6f 6c20 3d20 4661  eploy: bool = Fa
-000327a0: 6c73 652c 0a29 3a0a 2020 2020 6465 6620  lse,.):.    def 
-000327b0: 6669 6c65 5f6c 696e 6573 2866 696c 656e  file_lines(filen
-000327c0: 616d 6529 3a0a 2020 2020 2020 2020 7769  ame):.        wi
-000327d0: 7468 206f 7065 6e28 6669 6c65 6e61 6d65  th open(filename
-000327e0: 2920 6173 2066 696c 653a 0a20 2020 2020  ) as file:.     
-000327f0: 2020 2020 2020 2072 6574 7572 6e20 6669         return fi
-00032800: 6c65 2e72 6561 646c 696e 6573 2829 0a0a  le.readlines()..
-00032810: 2020 2020 6173 796e 6320 6465 6620 7061      async def pa
-00032820: 7273 6528 6669 6c65 6e61 6d65 2c20 7769  rse(filename, wi
-00032830: 7468 5f66 6f72 6d61 743d 5472 7565 2c20  th_format=True, 
-00032840: 756e 726f 6c6c 5f69 6e63 6c75 6465 733d  unroll_includes=
-00032850: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
-00032860: 6578 7465 6e73 696f 6e73 203d 2050 6174  extensions = Pat
-00032870: 6828 6669 6c65 6e61 6d65 292e 7375 6666  h(filename).suff
-00032880: 6978 6573 0a20 2020 2020 2020 206c 696e  ixes.        lin
-00032890: 6573 203d 204e 6f6e 650a 2020 2020 2020  es = None.      
-000328a0: 2020 6966 2069 735f 6669 6c65 5f61 5f64    if is_file_a_d
-000328b0: 6174 6173 6f75 7263 6528 6669 6c65 6e61  atasource(filena
-000328c0: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
-000328d0: 206c 696e 6573 203d 2028 0a20 2020 2020   lines = (.     
-000328e0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000328f0: 2066 6f72 6d61 745f 6461 7461 736f 7572   format_datasour
-00032900: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
-00032910: 2020 2020 2020 2020 6669 6c65 6e61 6d65          filename
-00032920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032930: 2020 2020 2020 756e 726f 6c6c 5f69 6e63        unroll_inc
-00032940: 6c75 6465 733d 756e 726f 6c6c 5f69 6e63  ludes=unroll_inc
-00032950: 6c75 6465 732c 0a20 2020 2020 2020 2020  ludes,.         
-00032960: 2020 2020 2020 2020 2020 2066 6f72 5f64             for_d
-00032970: 6966 663d 5472 7565 2c0a 2020 2020 2020  iff=True,.      
-00032980: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00032990: 6965 6e74 3d63 6c69 656e 742c 0a20 2020  ient=client,.   
-000329a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000329b0: 2072 6570 6c61 6365 5f69 6e63 6c75 6465   replace_include
-000329c0: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-000329d0: 2020 2020 2020 2020 2020 2020 666f 725f              for_
-000329e0: 6465 706c 6f79 5f64 6966 663d 666f 725f  deploy_diff=for_
-000329f0: 6465 706c 6f79 2c0a 2020 2020 2020 2020  deploy,.        
-00032a00: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00032a10: 2020 2020 2020 2020 2020 6966 2077 6974            if wit
-00032a20: 685f 666f 726d 6174 0a20 2020 2020 2020  h_format.       
-00032a30: 2020 2020 2020 2020 2065 6c73 6520 6669           else fi
-00032a40: 6c65 5f6c 696e 6573 2866 696c 656e 616d  le_lines(filenam
-00032a50: 6529 0a20 2020 2020 2020 2020 2020 2029  e).            )
-00032a60: 0a20 2020 2020 2020 2065 6c69 6620 2822  .        elif ("
-00032a70: 2e70 6970 6522 2069 6e20 6578 7465 6e73  .pipe" in extens
-00032a80: 696f 6e73 2920 6f72 2028 222e 696e 636c  ions) or (".incl
-00032a90: 2220 696e 2065 7874 656e 7369 6f6e 7329  " in extensions)
-00032aa0: 3a0a 2020 2020 2020 2020 2020 2020 6c69  :.            li
-00032ab0: 6e65 7320 3d20 280a 2020 2020 2020 2020  nes = (.        
-00032ac0: 2020 2020 2020 2020 6177 6169 7420 666f          await fo
-00032ad0: 726d 6174 5f70 6970 6528 0a20 2020 2020  rmat_pipe(.     
-00032ae0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00032af0: 696c 656e 616d 652c 0a20 2020 2020 2020  ilename,.       
-00032b00: 2020 2020 2020 2020 2020 2020 2044 4546               DEF
-00032b10: 4155 4c54 5f46 4d54 5f4c 494e 455f 4c45  AULT_FMT_LINE_LE
-00032b20: 4e47 5448 2c0a 2020 2020 2020 2020 2020  NGTH,.          
-00032b30: 2020 2020 2020 2020 2020 756e 726f 6c6c            unroll
-00032b40: 5f69 6e63 6c75 6465 733d 756e 726f 6c6c  _includes=unroll
-00032b50: 5f69 6e63 6c75 6465 732c 0a20 2020 2020  _includes,.     
-00032b60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00032b70: 6570 6c61 6365 5f69 6e63 6c75 6465 733d  eplace_includes=
-00032b80: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-00032b90: 2020 2020 2020 2020 2020 666f 725f 6465            for_de
-00032ba0: 706c 6f79 5f64 6966 663d 666f 725f 6465  ploy_diff=for_de
-00032bb0: 706c 6f79 2c0a 2020 2020 2020 2020 2020  ploy,.          
-00032bc0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00032bd0: 2020 2020 2020 2020 6966 2077 6974 685f          if with_
-00032be0: 666f 726d 6174 0a20 2020 2020 2020 2020  format.         
-00032bf0: 2020 2020 2020 2065 6c73 6520 6669 6c65         else file
-00032c00: 5f6c 696e 6573 2866 696c 656e 616d 6529  _lines(filename)
-00032c10: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00032c20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00032c30: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
-00032c40: 6368 6f28 6622 556e 7375 7070 6f72 7465  cho(f"Unsupporte
-00032c50: 6420 6669 6c65 2074 7970 653a 207b 6669  d file type: {fi
-00032c60: 6c65 6e61 6d65 7d22 290a 2020 2020 2020  lename}").      
-00032c70: 2020 6966 206c 696e 6573 3a0a 2020 2020    if lines:.    
-00032c80: 2020 2020 2020 2020 7265 7475 726e 205b          return [
-00032c90: 6622 7b6c 7d5c 6e22 2066 6f72 206c 2069  f"{l}\n" for l i
-00032ca0: 6e20 6c69 6e65 732e 7370 6c69 7428 225c  n lines.split("\
-00032cb0: 6e22 295d 2069 6620 7769 7468 5f66 6f72  n")] if with_for
-00032cc0: 6d61 7420 656c 7365 206c 696e 6573 2020  mat else lines  
-00032cd0: 2320 6e6f 7161 3a20 4537 3431 0a0a 2020  # noqa: E741..  
-00032ce0: 2020 7472 793a 0a20 2020 2020 2020 206c    try:.        l
-00032cf0: 696e 6573 3120 3d20 6177 6169 7420 7061  ines1 = await pa
-00032d00: 7273 6528 6672 6f6d 5f66 696c 652c 2077  rse(from_file, w
-00032d10: 6974 685f 666f 726d 6174 290a 2020 2020  ith_format).    
-00032d20: 2020 2020 6c69 6e65 7332 203d 2061 7761      lines2 = awa
-00032d30: 6974 2070 6172 7365 2874 6f5f 6669 6c65  it parse(to_file
-00032d40: 2c20 7769 7468 5f66 6f72 6d61 742c 2075  , with_format, u
-00032d50: 6e72 6f6c 6c5f 696e 636c 7564 6573 3d54  nroll_includes=T
-00032d60: 7275 6529 0a20 2020 2065 7863 6570 7420  rue).    except 
-00032d70: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-00032d80: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
-00032d90: 6669 6c65 6e61 6d65 203d 206f 732e 7061  filename = os.pa
-00032da0: 7468 2e62 6173 656e 616d 6528 7374 7228  th.basename(str(
-00032db0: 6529 292e 7374 7269 7028 2227 2229 0a20  e)).strip("'"). 
-00032dc0: 2020 2020 2020 2072 6169 7365 2063 6c69         raise cli
-00032dd0: 636b 2e43 6c69 636b 4578 6365 7074 696f  ck.ClickExceptio
-00032de0: 6e28 4665 6564 6261 636b 4d61 6e61 6765  n(FeedbackManage
-00032df0: 722e 6572 726f 725f 6469 6666 5f66 696c  r.error_diff_fil
-00032e00: 6528 6669 6c65 6e61 6d65 3d66 696c 656e  e(filename=filen
-00032e10: 616d 6529 290a 0a20 2020 2069 6620 6e6f  ame))..    if no
-00032e20: 7420 6c69 6e65 7331 206f 7220 6e6f 7420  t lines1 or not 
-00032e30: 6c69 6e65 7332 3a0a 2020 2020 2020 2020  lines2:.        
-00032e40: 7265 7475 726e 0a0a 2020 2020 6469 6666  return..    diff
-00032e50: 203d 2064 6966 666c 6962 2e75 6e69 6669   = difflib.unifi
-00032e60: 6564 5f64 6966 6628 0a20 2020 2020 2020  ed_diff(.       
-00032e70: 206c 696e 6573 312c 206c 696e 6573 322c   lines1, lines2,
-00032e80: 2066 726f 6d66 696c 653d 6622 7b50 6174   fromfile=f"{Pat
-00032e90: 6828 6672 6f6d 5f66 696c 6529 2e6e 616d  h(from_file).nam
-00032ea0: 657d 207b 6672 6f6d 5f66 696c 655f 7375  e} {from_file_su
-00032eb0: 6666 6978 7d22 2c20 746f 6669 6c65 3d66  ffix}", tofile=f
-00032ec0: 227b 746f 5f66 696c 657d 207b 746f 5f66  "{to_file} {to_f
-00032ed0: 696c 655f 7375 6666 6978 7d22 0a20 2020  ile_suffix}".   
-00032ee0: 2029 0a0a 2020 2020 6966 2077 6974 685f   )..    if with_
-00032ef0: 636f 6c6f 723a 0a20 2020 2020 2020 2064  color:.        d
-00032f00: 6966 6620 3d20 636f 6c6f 725f 6469 6666  iff = color_diff
-00032f10: 2864 6966 6629 0a0a 2020 2020 7265 7475  (diff)..    retu
-00032f20: 726e 2064 6966 660a 0a0a 6465 6620 6973  rn diff...def is
-00032f30: 5f65 6e64 706f 696e 7428 7265 736f 7572  _endpoint(resour
-00032f40: 6365 3a20 4f70 7469 6f6e 616c 5b44 6963  ce: Optional[Dic
-00032f50: 745b 7374 722c 2041 6e79 5d5d 2920 2d3e  t[str, Any]]) ->
-00032f60: 2062 6f6f 6c3a 0a20 2020 2069 6620 7265   bool:.    if re
-00032f70: 736f 7572 6365 2061 6e64 206c 656e 2872  source and len(r
-00032f80: 6573 6f75 7263 652e 6765 7428 2274 6f6b  esource.get("tok
-00032f90: 656e 7322 2c20 5b5d 2929 2021 3d20 3020  ens", [])) != 0 
-00032fa0: 616e 6420 7265 736f 7572 6365 2e67 6574  and resource.get
-00032fb0: 2822 7265 736f 7572 6365 2229 203d 3d20  ("resource") == 
-00032fc0: 2270 6970 6573 223a 0a20 2020 2020 2020  "pipes":.       
-00032fd0: 2072 6574 7572 6e20 5472 7565 0a20 2020   return True.   
-00032fe0: 2072 6574 7572 6e20 4661 6c73 650a 0a0a   return False...
-00032ff0: 6465 6620 6973 5f6d 6174 6572 6961 6c69  def is_materiali
-00033000: 7a65 6428 7265 736f 7572 6365 3a20 4f70  zed(resource: Op
-00033010: 7469 6f6e 616c 5b44 6963 745b 7374 722c  tional[Dict[str,
-00033020: 2041 6e79 5d5d 2920 2d3e 2062 6f6f 6c3a   Any]]) -> bool:
-00033030: 0a20 2020 2069 6620 6e6f 7420 7265 736f  .    if not reso
-00033040: 7572 6365 3a0a 2020 2020 2020 2020 7265  urce:.        re
-00033050: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-00033060: 6973 5f6d 6174 6572 6961 6c69 7a65 6420  is_materialized 
-00033070: 3d20 616e 7928 0a20 2020 2020 2020 205b  = any(.        [
-00033080: 6e6f 6465 2e67 6574 2822 7061 7261 6d73  node.get("params
-00033090: 222c 207b 7d29 2e67 6574 2822 7479 7065  ", {}).get("type
-000330a0: 222c 204e 6f6e 6529 203d 3d20 226d 6174  ", None) == "mat
-000330b0: 6572 6961 6c69 7a65 6422 2066 6f72 206e  erialized" for n
-000330c0: 6f64 6520 696e 2072 6573 6f75 7263 652e  ode in resource.
-000330d0: 6765 7428 226e 6f64 6573 222c 205b 5d29  get("nodes", [])
-000330e0: 206f 7220 5b5d 5d0a 2020 2020 290a 2020   or []].    ).  
-000330f0: 2020 7265 7475 726e 2069 735f 6d61 7465    return is_mate
-00033100: 7269 616c 697a 6564 0a0a 0a64 6566 2069  rialized...def i
-00033110: 735f 656e 6470 6f69 6e74 5f77 6974 685f  s_endpoint_with_
-00033120: 6e6f 5f64 6570 656e 6465 6e63 6965 7328  no_dependencies(
-00033130: 0a20 2020 2072 6573 6f75 7263 653a 2044  .    resource: D
-00033140: 6963 745b 7374 722c 2041 6e79 5d2c 2064  ict[str, Any], d
-00033150: 6570 5f6d 6170 3a20 4469 6374 5b73 7472  ep_map: Dict[str
-00033160: 2c20 5365 745b 7374 725d 5d2c 2074 6f5f  , Set[str]], to_
-00033170: 7275 6e3a 2044 6963 745b 7374 722c 2044  run: Dict[str, D
-00033180: 6963 745b 7374 722c 2041 6e79 5d5d 0a29  ict[str, Any]].)
-00033190: 202d 3e20 626f 6f6c 3a0a 2020 2020 6966   -> bool:.    if
-000331a0: 206e 6f74 2072 6573 6f75 7263 6520 6f72   not resource or
-000331b0: 2072 6573 6f75 7263 652e 6765 7428 2272   resource.get("r
-000331c0: 6573 6f75 7263 6522 2920 3d3d 2022 6461  esource") == "da
-000331d0: 7461 736f 7572 6365 7322 3a0a 2020 2020  tasources":.    
-000331e0: 2020 2020 7265 7475 726e 2046 616c 7365      return False
-000331f0: 0a0a 2020 2020 666f 7220 6e6f 6465 2069  ..    for node i
-00033200: 6e20 7265 736f 7572 6365 2e67 6574 2822  n resource.get("
-00033210: 6e6f 6465 7322 2c20 5b5d 293a 0a20 2020  nodes", []):.   
-00033220: 2020 2020 2023 2046 4958 4d45 3a20 6874       # FIXME: ht
-00033230: 7470 733a 2f2f 6769 746c 6162 2e63 6f6d  tps://gitlab.com
-00033240: 2f74 696e 7962 6972 642f 616e 616c 7974  /tinybird/analyt
-00033250: 6963 732f 2d2f 6973 7375 6573 2f32 3339  ics/-/issues/239
-00033260: 310a 2020 2020 2020 2020 6966 206e 6f64  1.        if nod
-00033270: 652e 6765 7428 2270 6172 616d 7322 2c20  e.get("params", 
-00033280: 7b7d 292e 6765 7428 2274 7970 6522 2c20  {}).get("type", 
-00033290: 2222 292e 6c6f 7765 7228 2920 696e 205b  "").lower() in [
-000332a0: 0a20 2020 2020 2020 2020 2020 2050 6970  .            Pip
-000332b0: 654e 6f64 6554 7970 6573 2e4d 4154 4552  eNodeTypes.MATER
-000332c0: 4941 4c49 5a45 442c 0a20 2020 2020 2020  IALIZED,.       
-000332d0: 2020 2020 2050 6970 654e 6f64 6554 7970       PipeNodeTyp
-000332e0: 6573 2e43 4f50 592c 0a20 2020 2020 2020  es.COPY,.       
-000332f0: 2020 2020 2050 6970 654e 6f64 6554 7970       PipeNodeTyp
-00033300: 6573 2e44 4154 415f 5349 4e4b 2c0a 2020  es.DATA_SINK,.  
-00033310: 2020 2020 2020 5d3a 0a20 2020 2020 2020        ]:.       
-00033320: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-00033330: 650a 0a20 2020 2066 6f72 206b 6579 2c20  e..    for key, 
-00033340: 7661 6c75 6573 2069 6e20 6465 705f 6d61  values in dep_ma
-00033350: 702e 6974 656d 7328 293a 0a20 2020 2020  p.items():.     
-00033360: 2020 2069 6620 7265 736f 7572 6365 5b22     if resource["
-00033370: 7265 736f 7572 6365 5f6e 616d 6522 5d20  resource_name"] 
-00033380: 696e 2076 616c 7565 733a 0a20 2020 2020  in values:.     
-00033390: 2020 2020 2020 2072 203d 2074 6f5f 7275         r = to_ru
-000333a0: 6e2e 6765 7428 6b65 792c 204e 6f6e 6529  n.get(key, None)
-000333b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000333c0: 6e6f 7420 723a 0a20 2020 2020 2020 2020  not r:.         
-000333d0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-000333e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000333f0: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
-00033400: 7073 203d 2064 6570 5f6d 6170 2e67 6574  ps = dep_map.get
-00033410: 2872 6573 6f75 7263 655b 2272 6573 6f75  (resource["resou
-00033420: 7263 655f 6e61 6d65 225d 290a 2020 2020  rce_name"]).    
-00033430: 6966 206e 6f74 2064 6570 733a 0a20 2020  if not deps:.   
-00033440: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-00033450: 0a0a 2020 2020 666f 7220 6465 7020 696e  ..    for dep in
-00033460: 2064 6570 733a 0a20 2020 2020 2020 2072   deps:.        r
-00033470: 203d 2074 6f5f 7275 6e2e 6765 7428 6465   = to_run.get(de
-00033480: 702c 204e 6f6e 6529 0a20 2020 2020 2020  p, None).       
-00033490: 2069 6620 6973 5f65 6e64 706f 696e 7428   if is_endpoint(
-000334a0: 7229 206f 7220 6973 5f6d 6174 6572 6961  r) or is_materia
-000334b0: 6c69 7a65 6428 7229 3a0a 2020 2020 2020  lized(r):.      
-000334c0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-000334d0: 7365 0a0a 2020 2020 7265 7475 726e 2054  se..    return T
-000334e0: 7275 650a 0a0a 6465 6620 6765 745f 7461  rue...def get_ta
-000334f0: 7267 6574 5f6d 6174 6572 6961 6c69 7a65  rget_materialize
-00033500: 645f 6461 7461 5f73 6f75 7263 655f 6e61  d_data_source_na
-00033510: 6d65 2872 6573 6f75 7263 653a 204f 7074  me(resource: Opt
-00033520: 696f 6e61 6c5b 4469 6374 5b73 7472 2c20  ional[Dict[str, 
-00033530: 416e 795d 5d29 202d 3e20 4f70 7469 6f6e  Any]]) -> Option
-00033540: 616c 5b73 7472 5d3a 0a20 2020 2069 6620  al[str]:.    if 
-00033550: 6e6f 7420 7265 736f 7572 6365 3a0a 2020  not resource:.  
-00033560: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00033570: 650a 0a20 2020 2066 6f72 206e 6f64 6520  e..    for node 
-00033580: 696e 2072 6573 6f75 7263 652e 6765 7428  in resource.get(
-00033590: 226e 6f64 6573 222c 205b 5d29 3a0a 2020  "nodes", []):.  
-000335a0: 2020 2020 2020 2320 4649 584d 453a 2068        # FIXME: h
-000335b0: 7474 7073 3a2f 2f67 6974 6c61 622e 636f  ttps://gitlab.co
-000335c0: 6d2f 7469 6e79 6269 7264 2f61 6e61 6c79  m/tinybird/analy
-000335d0: 7469 6373 2f2d 2f69 7373 7565 732f 3233  tics/-/issues/23
-000335e0: 3931 0a20 2020 2020 2020 2069 6620 6e6f  91.        if no
-000335f0: 6465 2e67 6574 2822 7061 7261 6d73 222c  de.get("params",
-00033600: 207b 7d29 2e67 6574 2822 7479 7065 222c   {}).get("type",
-00033610: 2022 2229 2e6c 6f77 6572 2829 203d 3d20   "").lower() == 
-00033620: 5069 7065 4e6f 6465 5479 7065 732e 4d41  PipeNodeTypes.MA
-00033630: 5445 5249 414c 495a 4544 3a0a 2020 2020  TERIALIZED:.    
-00033640: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-00033650: 6f64 652e 6765 7428 2270 6172 616d 7322  ode.get("params"
-00033660: 295b 2264 6174 6173 6f75 7263 6522 5d2e  )["datasource"].
-00033670: 7370 6c69 7428 225f 5f76 2229 5b30 5d0a  split("__v")[0].
-00033680: 0a20 2020 2072 6574 7572 6e20 4e6f 6e65  .    return None
-00033690: 0a0a 0a64 6566 2069 735f 6461 7461 736f  ...def is_dataso
-000336a0: 7572 6365 2872 6573 6f75 7263 653a 204f  urce(resource: O
-000336b0: 7074 696f 6e61 6c5b 4469 6374 5b73 7472  ptional[Dict[str
-000336c0: 2c20 416e 795d 5d29 202d 3e20 626f 6f6c  , Any]]) -> bool
-000336d0: 3a0a 2020 2020 6966 2072 6573 6f75 7263  :.    if resourc
-000336e0: 6520 616e 6420 7265 736f 7572 6365 2e67  e and resource.g
-000336f0: 6574 2822 7265 736f 7572 6365 2229 203d  et("resource") =
-00033700: 3d20 2264 6174 6173 6f75 7263 6573 223a  = "datasources":
-00033710: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00033720: 5472 7565 0a20 2020 2072 6574 7572 6e20  True.    return 
-00033730: 4661 6c73 650a 0a0a 6173 796e 6320 6465  False...async de
-00033740: 6620 6372 6561 7465 5f72 656c 6561 7365  f create_release
-00033750: 280a 2020 2020 636c 6965 6e74 3a20 5469  (.    client: Ti
-00033760: 6e79 422c 2063 6f6e 6669 673a 2055 6e69  nyB, config: Uni
-00033770: 6f6e 5b44 6963 745b 7374 722c 2041 6e79  on[Dict[str, Any
-00033780: 5d2c 2043 4c49 436f 6e66 6967 5d2c 2073  ], CLIConfig], s
-00033790: 656d 7665 723a 2073 7472 2c20 666f 6c64  emver: str, fold
-000337a0: 6572 3a20 4f70 7469 6f6e 616c 5b73 7472  er: Optional[str
-000337b0: 5d20 3d20 4e6f 6e65 0a29 202d 3e20 4e6f  ] = None.) -> No
-000337c0: 6e65 3a0a 2020 2020 6966 206e 6f74 2066  ne:.    if not f
-000337d0: 6f6c 6465 723a 0a20 2020 2020 2020 2066  older:.        f
-000337e0: 6f6c 6465 7220 3d20 6765 7463 7764 2829  older = getcwd()
-000337f0: 0a20 2020 2063 6c69 5f67 6974 5f72 656c  .    cli_git_rel
-00033800: 6561 7365 203d 204e 6f6e 650a 2020 2020  ease = None.    
-00033810: 7472 793a 0a20 2020 2020 2020 2063 6c69  try:.        cli
-00033820: 5f67 6974 5f72 656c 6561 7365 203d 2043  _git_release = C
-00033830: 4c49 4769 7452 656c 6561 7365 2870 6174  LIGitRelease(pat
-00033840: 683d 666f 6c64 6572 290a 2020 2020 2020  h=folder).      
-00033850: 2020 636f 6d6d 6974 203d 2063 6c69 5f67    commit = cli_g
-00033860: 6974 5f72 656c 6561 7365 2e68 6561 645f  it_release.head_
-00033870: 636f 6d6d 6974 2829 0a20 2020 2065 7863  commit().    exc
-00033880: 6570 7420 434c 4947 6974 5265 6c65 6173  ept CLIGitReleas
-00033890: 6545 7863 6570 7469 6f6e 3a0a 2020 2020  eException:.    
-000338a0: 2020 2020 7261 6973 6520 434c 4947 6974      raise CLIGit
-000338b0: 5265 6c65 6173 6545 7863 6570 7469 6f6e  ReleaseException
-000338c0: 2846 6565 6462 6163 6b4d 616e 6167 6572  (FeedbackManager
-000338d0: 2e65 7272 6f72 5f6e 6f5f 6769 745f 7265  .error_no_git_re
-000338e0: 706f 5f66 6f72 5f69 6e69 7428 7265 706f  po_for_init(repo
-000338f0: 5f70 6174 683d 666f 6c64 6572 2929 0a0a  _path=folder))..
-00033900: 2020 2020 6177 6169 7420 636c 6965 6e74      await client
-00033910: 2e72 656c 6561 7365 5f6e 6577 2863 6f6e  .release_new(con
-00033920: 6669 675b 2269 6422 5d2c 2073 656d 7665  fig["id"], semve
-00033930: 722c 2063 6f6d 6d69 7429 0a20 2020 2063  r, commit).    c
-00033940: 6c69 636b 2e65 6368 6f28 4665 6564 6261  lick.echo(Feedba
-00033950: 636b 4d61 6e61 6765 722e 7375 6363 6573  ckManager.succes
-00033960: 735f 6465 706c 6f79 6d65 6e74 5f72 656c  s_deployment_rel
-00033970: 6561 7365 2873 656d 7665 723d 7365 6d76  ease(semver=semv
-00033980: 6572 2929 0a0a 0a64 6566 2068 6173 5f69  er))...def has_i
-00033990: 6e74 6572 6e61 6c5f 6461 7461 6669 6c65  nternal_datafile
-000339a0: 7328 666f 6c64 6572 3a20 7374 7229 202d  s(folder: str) -
-000339b0: 3e20 626f 6f6c 3a0a 2020 2020 666f 6c64  > bool:.    fold
-000339c0: 6572 203d 2066 6f6c 6465 7220 6f72 2022  er = folder or "
-000339d0: 2e22 0a20 2020 2066 696c 656e 616d 6573  .".    filenames
-000339e0: 203d 2067 6574 5f70 726f 6a65 6374 5f66   = get_project_f
-000339f0: 696c 656e 616d 6573 2866 6f6c 6465 7229  ilenames(folder)
-00033a00: 0a20 2020 2072 6574 7572 6e20 616e 7928  .    return any(
-00033a10: 5b66 2066 6f72 2066 2069 6e20 6669 6c65  [f for f in file
-00033a20: 6e61 6d65 7320 6966 2022 7370 616e 7322  names if "spans"
-00033a30: 2069 6e20 7374 7228 6629 2061 6e64 2022   in str(f) and "
-00033a40: 7665 6e64 6f72 2220 6e6f 7420 696e 2073  vendor" not in s
-00033a50: 7472 2866 295d 290a 0a0a 6465 6620 6973  tr(f)])...def is
-00033a60: 5f66 696c 655f 615f 6461 7461 736f 7572  _file_a_datasour
-00033a70: 6365 2866 696c 656e 616d 653a 2073 7472  ce(filename: str
-00033a80: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2065  ) -> bool:.    e
-00033a90: 7874 656e 7369 6f6e 7320 3d20 5061 7468  xtensions = Path
-00033aa0: 2866 696c 656e 616d 6529 2e73 7566 6669  (filename).suffi
-00033ab0: 7865 730a 2020 2020 6966 2022 2e64 6174  xes.    if ".dat
-00033ac0: 6173 6f75 7263 6522 2069 6e20 6578 7465  asource" in exte
-00033ad0: 6e73 696f 6e73 3a20 2023 2041 6363 6570  nsions:  # Accep
-00033ae0: 7473 2027 2e64 6174 6173 6f75 7263 6527  ts '.datasource'
-00033af0: 2061 6e64 2027 2e64 6174 6173 6f75 7263   and '.datasourc
-00033b00: 652e 696e 636c 270a 2020 2020 2020 2020  e.incl'.        
-00033b10: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
-00033b20: 2069 6620 222e 696e 636c 2220 696e 2065   if ".incl" in e
-00033b30: 7874 656e 7369 6f6e 733a 0a20 2020 2020  xtensions:.     
-00033b40: 2020 206c 696e 6573 203d 205b 5d0a 2020     lines = [].  
-00033b50: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
-00033b60: 6669 6c65 6e61 6d65 2920 6173 2066 696c  filename) as fil
-00033b70: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-00033b80: 696e 6573 203d 2066 696c 652e 7265 6164  ines = file.read
-00033b90: 6c69 6e65 7328 290a 0a20 2020 2020 2020  lines()..       
-00033ba0: 2066 6f72 206c 696e 6520 696e 206c 696e   for line in lin
-00033bb0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00033bc0: 7472 696d 6d65 645f 6c69 6e65 203d 206c  trimmed_line = l
-00033bd0: 696e 652e 7374 7269 7028 292e 6c6f 7765  ine.strip().lowe
-00033be0: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
-00033bf0: 6966 2074 7269 6d6d 6564 5f6c 696e 652e  if trimmed_line.
-00033c00: 7374 6172 7473 7769 7468 2822 7363 6865  startswith("sche
-00033c10: 6d61 2229 206f 7220 7472 696d 6d65 645f  ma") or trimmed_
-00033c20: 6c69 6e65 2e73 7461 7274 7377 6974 6828  line.startswith(
-00033c30: 2265 6e67 696e 6522 293a 0a20 2020 2020  "engine"):.     
-00033c40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00033c50: 6e20 5472 7565 0a0a 2020 2020 7265 7475  n True..    retu
-00033c60: 726e 2046 616c 7365 0a                   rn False.
+000323c0: 645b 7265 736f 7572 6365 5b22 6e61 6d65  d[resource["name
+000323d0: 225d 5d20 3d20 2272 656d 6f74 6522 0a20  "]] = "remote". 
+000323e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000323f0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+00032400: 2020 2020 2073 7566 6669 7820 3d20 222e       suffix = ".
+00032410: 6461 7461 736f 7572 6365 2220 6966 2022  datasource" if "
+00032420: 2e64 6174 6173 6f75 7263 6522 2069 6e20  .datasource" in 
+00032430: 6669 6c65 2065 6c73 6520 222e 7069 7065  file else ".pipe
+00032440: 220a 2020 2020 2020 2020 2020 2020 7461  ".            ta
+00032450: 7267 6574 203d 2074 6172 6765 745f 6469  rget = target_di
+00032460: 7220 2b20 6f73 2e70 6174 682e 7365 7020  r + os.path.sep 
+00032470: 2b20 7266 696c 656e 616d 6520 2b20 7375  + rfilename + su
+00032480: 6666 6978 0a0a 2020 2020 2020 2020 2020  ffix..          
+00032490: 2020 6469 6666 5f6c 696e 6573 203d 2061    diff_lines = a
+000324a0: 7761 6974 2064 6966 665f 6669 6c65 7328  wait diff_files(
+000324b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000324c0: 2074 6172 6765 742c 2066 696c 652c 2077   target, file, w
+000324d0: 6974 685f 666f 726d 6174 3d66 6d74 2c20  ith_format=fmt, 
+000324e0: 7769 7468 5f63 6f6c 6f72 3d28 6e6f 7420  with_color=(not 
+000324f0: 6e6f 5f63 6f6c 6f72 292c 2063 6c69 656e  no_color), clien
+00032500: 743d 636c 6965 6e74 2c20 666f 725f 6465  t=client, for_de
+00032510: 706c 6f79 3d66 6f72 5f64 6570 6c6f 790a  ploy=for_deploy.
+00032520: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00032530: 2020 2020 2020 2020 2020 6e6f 745f 656d            not_em
+00032540: 7074 792c 2064 6966 665f 6c69 6e65 7320  pty, diff_lines 
+00032550: 3d20 7065 656b 2864 6966 665f 6c69 6e65  = peek(diff_line
+00032560: 7329 0a20 2020 2020 2020 2020 2020 2063  s).            c
+00032570: 6861 6e67 6564 5b72 6669 6c65 6e61 6d65  hanged[rfilename
+00032580: 5d20 3d20 6e6f 745f 656d 7074 790a 2020  ] = not_empty.  
+00032590: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000325a0: 5f65 6d70 7479 2061 6e64 2077 6974 685f  _empty and with_
+000325b0: 7072 696e 743a 0a20 2020 2020 2020 2020  print:.         
+000325c0: 2020 2020 2020 2073 7973 2e73 7464 6f75         sys.stdou
+000325d0: 742e 7772 6974 656c 696e 6573 2864 6966  t.writelines(dif
+000325e0: 665f 6c69 6e65 7329 0a20 2020 2020 2020  f_lines).       
+000325f0: 2020 2020 2020 2020 2063 6c69 636b 2e65           click.e
+00032600: 6368 6f28 2222 290a 0a20 2020 2066 6f72  cho("")..    for
+00032610: 2072 6669 6c65 6e61 6d65 2c20 5f20 696e   rfilename, _ in
+00032620: 206c 6f63 616c 5f72 6573 6f75 7263 6573   local_resources
+00032630: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00032640: 2020 6966 2072 6669 6c65 6e61 6d65 206e    if rfilename n
+00032650: 6f74 2069 6e20 6368 616e 6765 643a 0a20  ot in changed:. 
+00032660: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
+00032670: 6573 6f75 7263 6520 696e 2072 656d 6f74  esource in remot
+00032680: 655f 6461 7461 736f 7572 6365 7320 2b20  e_datasources + 
+00032690: 7265 6d6f 7465 5f70 6970 6573 3a0a 2020  remote_pipes:.  
+000326a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000326b0: 6f70 6572 7469 6573 203d 2067 6574 5f6e  operties = get_n
+000326c0: 616d 655f 7665 7273 696f 6e28 7265 736f  ame_version(reso
+000326d0: 7572 6365 5b22 6e61 6d65 225d 290a 2020  urce["name"]).  
+000326e0: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+000326f0: 6d65 203d 2070 726f 7065 7274 6965 732e  me = properties.
+00032700: 6765 7428 226e 616d 6522 2c20 4e6f 6e65  get("name", None
+00032710: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00032720: 2020 6966 206e 616d 6520 616e 6420 6e61    if name and na
+00032730: 6d65 203d 3d20 7266 696c 656e 616d 653a  me == rfilename:
+00032740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032750: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+00032760: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+00032770: 6974 685f 7072 696e 7420 616e 6420 7266  ith_print and rf
+00032780: 696c 656e 616d 6520 6e6f 7420 696e 2063  ilename not in c
+00032790: 6861 6e67 6564 3a0a 2020 2020 2020 2020  hanged:.        
+000327a0: 2020 2020 2020 2020 2020 2020 636c 6963              clic
+000327b0: 6b2e 6563 686f 2866 227b 7266 696c 656e  k.echo(f"{rfilen
+000327c0: 616d 657d 206f 6e6c 7920 6578 6973 7473  ame} only exists
+000327d0: 206c 6f63 616c 6c79 5c6e 2229 0a20 2020   locally\n").   
+000327e0: 2020 2020 2020 2020 2020 2020 2063 6861               cha
+000327f0: 6e67 6564 5b72 6669 6c65 6e61 6d65 5d20  nged[rfilename] 
+00032800: 3d20 226c 6f63 616c 220a 2020 2020 6966  = "local".    if
+00032810: 2063 6c65 616e 5f75 703a 0a20 2020 2020   clean_up:.     
+00032820: 2020 2073 6875 7469 6c2e 726d 7472 6565     shutil.rmtree
+00032830: 2874 6172 6765 745f 6469 7229 0a0a 2020  (target_dir)..  
+00032840: 2020 7265 7475 726e 2063 6861 6e67 6564    return changed
+00032850: 0a0a 0a61 7379 6e63 2064 6566 2064 6966  ...async def dif
+00032860: 665f 6669 6c65 7328 0a20 2020 2066 726f  f_files(.    fro
+00032870: 6d5f 6669 6c65 3a20 7374 722c 0a20 2020  m_file: str,.   
+00032880: 2074 6f5f 6669 6c65 3a20 7374 722c 0a20   to_file: str,. 
+00032890: 2020 2066 726f 6d5f 6669 6c65 5f73 7566     from_file_suf
+000328a0: 6669 783a 2073 7472 203d 2022 5b72 656d  fix: str = "[rem
+000328b0: 6f74 655d 222c 0a20 2020 2074 6f5f 6669  ote]",.    to_fi
+000328c0: 6c65 5f73 7566 6669 783a 2073 7472 203d  le_suffix: str =
+000328d0: 2022 5b6c 6f63 616c 5d22 2c0a 2020 2020   "[local]",.    
+000328e0: 7769 7468 5f66 6f72 6d61 743a 2062 6f6f  with_format: boo
+000328f0: 6c20 3d20 5472 7565 2c0a 2020 2020 7769  l = True,.    wi
+00032900: 7468 5f63 6f6c 6f72 3a20 626f 6f6c 203d  th_color: bool =
+00032910: 2046 616c 7365 2c0a 2020 2020 636c 6965   False,.    clie
+00032920: 6e74 3a20 4f70 7469 6f6e 616c 5b54 696e  nt: Optional[Tin
+00032930: 7942 5d20 3d20 4e6f 6e65 2c0a 2020 2020  yB] = None,.    
+00032940: 666f 725f 6465 706c 6f79 3a20 626f 6f6c  for_deploy: bool
+00032950: 203d 2046 616c 7365 2c0a 293a 0a20 2020   = False,.):.   
+00032960: 2064 6566 2066 696c 655f 6c69 6e65 7328   def file_lines(
+00032970: 6669 6c65 6e61 6d65 293a 0a20 2020 2020  filename):.     
+00032980: 2020 2077 6974 6820 6f70 656e 2866 696c     with open(fil
+00032990: 656e 616d 6529 2061 7320 6669 6c65 3a0a  ename) as file:.
+000329a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000329b0: 726e 2066 696c 652e 7265 6164 6c69 6e65  rn file.readline
+000329c0: 7328 290a 0a20 2020 2061 7379 6e63 2064  s()..    async d
+000329d0: 6566 2070 6172 7365 2866 696c 656e 616d  ef parse(filenam
+000329e0: 652c 2077 6974 685f 666f 726d 6174 3d54  e, with_format=T
+000329f0: 7275 652c 2075 6e72 6f6c 6c5f 696e 636c  rue, unroll_incl
+00032a00: 7564 6573 3d46 616c 7365 293a 0a20 2020  udes=False):.   
+00032a10: 2020 2020 2065 7874 656e 7369 6f6e 7320       extensions 
+00032a20: 3d20 5061 7468 2866 696c 656e 616d 6529  = Path(filename)
+00032a30: 2e73 7566 6669 7865 730a 2020 2020 2020  .suffixes.      
+00032a40: 2020 6c69 6e65 7320 3d20 4e6f 6e65 0a20    lines = None. 
+00032a50: 2020 2020 2020 2069 6620 6973 5f66 696c         if is_fil
+00032a60: 655f 615f 6461 7461 736f 7572 6365 2866  e_a_datasource(f
+00032a70: 696c 656e 616d 6529 3a0a 2020 2020 2020  ilename):.      
+00032a80: 2020 2020 2020 6c69 6e65 7320 3d20 280a        lines = (.
+00032a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032aa0: 6177 6169 7420 666f 726d 6174 5f64 6174  await format_dat
+00032ab0: 6173 6f75 7263 6528 0a20 2020 2020 2020  asource(.       
+00032ac0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+00032ad0: 656e 616d 652c 0a20 2020 2020 2020 2020  ename,.         
+00032ae0: 2020 2020 2020 2020 2020 2075 6e72 6f6c             unrol
+00032af0: 6c5f 696e 636c 7564 6573 3d75 6e72 6f6c  l_includes=unrol
+00032b00: 6c5f 696e 636c 7564 6573 2c0a 2020 2020  l_includes,.    
+00032b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b20: 666f 725f 6469 6666 3d54 7275 652c 0a20  for_diff=True,. 
+00032b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b40: 2020 2063 6c69 656e 743d 636c 6965 6e74     client=client
+00032b50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00032b60: 2020 2020 2020 7265 706c 6163 655f 696e        replace_in
+00032b70: 636c 7564 6573 3d54 7275 652c 0a20 2020  cludes=True,.   
+00032b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b90: 2066 6f72 5f64 6570 6c6f 795f 6469 6666   for_deploy_diff
+00032ba0: 3d66 6f72 5f64 6570 6c6f 792c 0a20 2020  =for_deploy,.   
+00032bb0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00032bc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00032bd0: 6620 7769 7468 5f66 6f72 6d61 740a 2020  f with_format.  
+00032be0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00032bf0: 7365 2066 696c 655f 6c69 6e65 7328 6669  se file_lines(fi
+00032c00: 6c65 6e61 6d65 290a 2020 2020 2020 2020  lename).        
+00032c10: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+00032c20: 6966 2028 222e 7069 7065 2220 696e 2065  if (".pipe" in e
+00032c30: 7874 656e 7369 6f6e 7329 206f 7220 2822  xtensions) or ("
+00032c40: 2e69 6e63 6c22 2069 6e20 6578 7465 6e73  .incl" in extens
+00032c50: 696f 6e73 293a 0a20 2020 2020 2020 2020  ions):.         
+00032c60: 2020 206c 696e 6573 203d 2028 0a20 2020     lines = (.   
+00032c70: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+00032c80: 6974 2066 6f72 6d61 745f 7069 7065 280a  it format_pipe(.
+00032c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032ca0: 2020 2020 6669 6c65 6e61 6d65 2c0a 2020      filename,.  
+00032cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032cc0: 2020 4445 4641 554c 545f 464d 545f 4c49    DEFAULT_FMT_LI
+00032cd0: 4e45 5f4c 454e 4754 482c 0a20 2020 2020  NE_LENGTH,.     
+00032ce0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00032cf0: 6e72 6f6c 6c5f 696e 636c 7564 6573 3d75  nroll_includes=u
+00032d00: 6e72 6f6c 6c5f 696e 636c 7564 6573 2c0a  nroll_includes,.
+00032d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032d20: 2020 2020 7265 706c 6163 655f 696e 636c      replace_incl
+00032d30: 7564 6573 3d54 7275 652c 0a20 2020 2020  udes=True,.     
+00032d40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00032d50: 6f72 5f64 6570 6c6f 795f 6469 6666 3d66  or_deploy_diff=f
+00032d60: 6f72 5f64 6570 6c6f 792c 0a20 2020 2020  or_deploy,.     
+00032d70: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00032d80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00032d90: 7769 7468 5f66 6f72 6d61 740a 2020 2020  with_format.    
+00032da0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00032db0: 2066 696c 655f 6c69 6e65 7328 6669 6c65   file_lines(file
+00032dc0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00032dd0: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
+00032de0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00032df0: 6963 6b2e 6563 686f 2866 2255 6e73 7570  ick.echo(f"Unsup
+00032e00: 706f 7274 6564 2066 696c 6520 7479 7065  ported file type
+00032e10: 3a20 7b66 696c 656e 616d 657d 2229 0a20  : {filename}"). 
+00032e20: 2020 2020 2020 2069 6620 6c69 6e65 733a         if lines:
+00032e30: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00032e40: 7572 6e20 5b66 227b 6c7d 5c6e 2220 666f  urn [f"{l}\n" fo
+00032e50: 7220 6c20 696e 206c 696e 6573 2e73 706c  r l in lines.spl
+00032e60: 6974 2822 5c6e 2229 5d20 6966 2077 6974  it("\n")] if wit
+00032e70: 685f 666f 726d 6174 2065 6c73 6520 6c69  h_format else li
+00032e80: 6e65 7320 2023 206e 6f71 613a 2045 3734  nes  # noqa: E74
+00032e90: 310a 0a20 2020 2074 7279 3a0a 2020 2020  1..    try:.    
+00032ea0: 2020 2020 6c69 6e65 7331 203d 2061 7761      lines1 = awa
+00032eb0: 6974 2070 6172 7365 2866 726f 6d5f 6669  it parse(from_fi
+00032ec0: 6c65 2c20 7769 7468 5f66 6f72 6d61 7429  le, with_format)
+00032ed0: 0a20 2020 2020 2020 206c 696e 6573 3220  .        lines2 
+00032ee0: 3d20 6177 6169 7420 7061 7273 6528 746f  = await parse(to
+00032ef0: 5f66 696c 652c 2077 6974 685f 666f 726d  _file, with_form
+00032f00: 6174 2c20 756e 726f 6c6c 5f69 6e63 6c75  at, unroll_inclu
+00032f10: 6465 733d 5472 7565 290a 2020 2020 6578  des=True).    ex
+00032f20: 6365 7074 2046 696c 654e 6f74 466f 756e  cept FileNotFoun
+00032f30: 6445 7272 6f72 2061 7320 653a 0a20 2020  dError as e:.   
+00032f40: 2020 2020 2066 696c 656e 616d 6520 3d20       filename = 
+00032f50: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
+00032f60: 2873 7472 2865 2929 2e73 7472 6970 2822  (str(e)).strip("
+00032f70: 2722 290a 2020 2020 2020 2020 7261 6973  '").        rais
+00032f80: 6520 636c 6963 6b2e 436c 6963 6b45 7863  e click.ClickExc
+00032f90: 6570 7469 6f6e 2846 6565 6462 6163 6b4d  eption(FeedbackM
+00032fa0: 616e 6167 6572 2e65 7272 6f72 5f64 6966  anager.error_dif
+00032fb0: 665f 6669 6c65 2866 696c 656e 616d 653d  f_file(filename=
+00032fc0: 6669 6c65 6e61 6d65 2929 0a0a 2020 2020  filename))..    
+00032fd0: 6966 206e 6f74 206c 696e 6573 3120 6f72  if not lines1 or
+00032fe0: 206e 6f74 206c 696e 6573 323a 0a20 2020   not lines2:.   
+00032ff0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00033000: 2064 6966 6620 3d20 6469 6666 6c69 622e   diff = difflib.
+00033010: 756e 6966 6965 645f 6469 6666 280a 2020  unified_diff(.  
+00033020: 2020 2020 2020 6c69 6e65 7331 2c20 6c69        lines1, li
+00033030: 6e65 7332 2c20 6672 6f6d 6669 6c65 3d66  nes2, fromfile=f
+00033040: 227b 5061 7468 2866 726f 6d5f 6669 6c65  "{Path(from_file
+00033050: 292e 6e61 6d65 7d20 7b66 726f 6d5f 6669  ).name} {from_fi
+00033060: 6c65 5f73 7566 6669 787d 222c 2074 6f66  le_suffix}", tof
+00033070: 696c 653d 6622 7b74 6f5f 6669 6c65 7d20  ile=f"{to_file} 
+00033080: 7b74 6f5f 6669 6c65 5f73 7566 6669 787d  {to_file_suffix}
+00033090: 220a 2020 2020 290a 0a20 2020 2069 6620  ".    )..    if 
+000330a0: 7769 7468 5f63 6f6c 6f72 3a0a 2020 2020  with_color:.    
+000330b0: 2020 2020 6469 6666 203d 2063 6f6c 6f72      diff = color
+000330c0: 5f64 6966 6628 6469 6666 290a 0a20 2020  _diff(diff)..   
+000330d0: 2072 6574 7572 6e20 6469 6666 0a0a 0a64   return diff...d
+000330e0: 6566 2069 735f 656e 6470 6f69 6e74 2872  ef is_endpoint(r
+000330f0: 6573 6f75 7263 653a 204f 7074 696f 6e61  esource: Optiona
+00033100: 6c5b 4469 6374 5b73 7472 2c20 416e 795d  l[Dict[str, Any]
+00033110: 5d29 202d 3e20 626f 6f6c 3a0a 2020 2020  ]) -> bool:.    
+00033120: 6966 2072 6573 6f75 7263 6520 616e 6420  if resource and 
+00033130: 6c65 6e28 7265 736f 7572 6365 2e67 6574  len(resource.get
+00033140: 2822 746f 6b65 6e73 222c 205b 5d29 2920  ("tokens", [])) 
+00033150: 213d 2030 2061 6e64 2072 6573 6f75 7263  != 0 and resourc
+00033160: 652e 6765 7428 2272 6573 6f75 7263 6522  e.get("resource"
+00033170: 2920 3d3d 2022 7069 7065 7322 3a0a 2020  ) == "pipes":.  
+00033180: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+00033190: 650a 2020 2020 7265 7475 726e 2046 616c  e.    return Fal
+000331a0: 7365 0a0a 0a64 6566 2069 735f 6d61 7465  se...def is_mate
+000331b0: 7269 616c 697a 6564 2872 6573 6f75 7263  rialized(resourc
+000331c0: 653a 204f 7074 696f 6e61 6c5b 4469 6374  e: Optional[Dict
+000331d0: 5b73 7472 2c20 416e 795d 5d29 202d 3e20  [str, Any]]) -> 
+000331e0: 626f 6f6c 3a0a 2020 2020 6966 206e 6f74  bool:.    if not
+000331f0: 2072 6573 6f75 7263 653a 0a20 2020 2020   resource:.     
+00033200: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00033210: 0a20 2020 2069 735f 6d61 7465 7269 616c  .    is_material
+00033220: 697a 6564 203d 2061 6e79 280a 2020 2020  ized = any(.    
+00033230: 2020 2020 5b6e 6f64 652e 6765 7428 2270      [node.get("p
+00033240: 6172 616d 7322 2c20 7b7d 292e 6765 7428  arams", {}).get(
+00033250: 2274 7970 6522 2c20 4e6f 6e65 2920 3d3d  "type", None) ==
+00033260: 2022 6d61 7465 7269 616c 697a 6564 2220   "materialized" 
+00033270: 666f 7220 6e6f 6465 2069 6e20 7265 736f  for node in reso
+00033280: 7572 6365 2e67 6574 2822 6e6f 6465 7322  urce.get("nodes"
+00033290: 2c20 5b5d 2920 6f72 205b 5d5d 0a20 2020  , []) or []].   
+000332a0: 2029 0a20 2020 2072 6574 7572 6e20 6973   ).    return is
+000332b0: 5f6d 6174 6572 6961 6c69 7a65 640a 0a0a  _materialized...
+000332c0: 6465 6620 6973 5f65 6e64 706f 696e 745f  def is_endpoint_
+000332d0: 7769 7468 5f6e 6f5f 6465 7065 6e64 656e  with_no_dependen
+000332e0: 6369 6573 280a 2020 2020 7265 736f 7572  cies(.    resour
+000332f0: 6365 3a20 4469 6374 5b73 7472 2c20 416e  ce: Dict[str, An
+00033300: 795d 2c20 6465 705f 6d61 703a 2044 6963  y], dep_map: Dic
+00033310: 745b 7374 722c 2053 6574 5b73 7472 5d5d  t[str, Set[str]]
+00033320: 2c20 746f 5f72 756e 3a20 4469 6374 5b73  , to_run: Dict[s
+00033330: 7472 2c20 4469 6374 5b73 7472 2c20 416e  tr, Dict[str, An
+00033340: 795d 5d0a 2920 2d3e 2062 6f6f 6c3a 0a20  y]].) -> bool:. 
+00033350: 2020 2069 6620 6e6f 7420 7265 736f 7572     if not resour
+00033360: 6365 206f 7220 7265 736f 7572 6365 2e67  ce or resource.g
+00033370: 6574 2822 7265 736f 7572 6365 2229 203d  et("resource") =
+00033380: 3d20 2264 6174 6173 6f75 7263 6573 223a  = "datasources":
+00033390: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000333a0: 4661 6c73 650a 0a20 2020 2066 6f72 206e  False..    for n
+000333b0: 6f64 6520 696e 2072 6573 6f75 7263 652e  ode in resource.
+000333c0: 6765 7428 226e 6f64 6573 222c 205b 5d29  get("nodes", [])
+000333d0: 3a0a 2020 2020 2020 2020 2320 4649 584d  :.        # FIXM
+000333e0: 453a 2068 7474 7073 3a2f 2f67 6974 6c61  E: https://gitla
+000333f0: 622e 636f 6d2f 7469 6e79 6269 7264 2f61  b.com/tinybird/a
+00033400: 6e61 6c79 7469 6373 2f2d 2f69 7373 7565  nalytics/-/issue
+00033410: 732f 3233 3931 0a20 2020 2020 2020 2069  s/2391.        i
+00033420: 6620 6e6f 6465 2e67 6574 2822 7061 7261  f node.get("para
+00033430: 6d73 222c 207b 7d29 2e67 6574 2822 7479  ms", {}).get("ty
+00033440: 7065 222c 2022 2229 2e6c 6f77 6572 2829  pe", "").lower()
+00033450: 2069 6e20 5b0a 2020 2020 2020 2020 2020   in [.          
+00033460: 2020 5069 7065 4e6f 6465 5479 7065 732e    PipeNodeTypes.
+00033470: 4d41 5445 5249 414c 495a 4544 2c0a 2020  MATERIALIZED,.  
+00033480: 2020 2020 2020 2020 2020 5069 7065 4e6f            PipeNo
+00033490: 6465 5479 7065 732e 434f 5059 2c0a 2020  deTypes.COPY,.  
+000334a0: 2020 2020 2020 2020 2020 5069 7065 4e6f            PipeNo
+000334b0: 6465 5479 7065 732e 4441 5441 5f53 494e  deTypes.DATA_SIN
+000334c0: 4b2c 0a20 2020 2020 2020 205d 3a0a 2020  K,.        ]:.  
+000334d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000334e0: 2046 616c 7365 0a0a 2020 2020 666f 7220   False..    for 
+000334f0: 6b65 792c 2076 616c 7565 7320 696e 2064  key, values in d
+00033500: 6570 5f6d 6170 2e69 7465 6d73 2829 3a0a  ep_map.items():.
+00033510: 2020 2020 2020 2020 6966 2072 6573 6f75          if resou
+00033520: 7263 655b 2272 6573 6f75 7263 655f 6e61  rce["resource_na
+00033530: 6d65 225d 2069 6e20 7661 6c75 6573 3a0a  me"] in values:.
+00033540: 2020 2020 2020 2020 2020 2020 7220 3d20              r = 
+00033550: 746f 5f72 756e 2e67 6574 286b 6579 2c20  to_run.get(key, 
+00033560: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+00033570: 2020 6966 206e 6f74 2072 3a0a 2020 2020    if not r:.    
+00033580: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00033590: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+000335a0: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
+000335b0: 2020 2064 6570 7320 3d20 6465 705f 6d61     deps = dep_ma
+000335c0: 702e 6765 7428 7265 736f 7572 6365 5b22  p.get(resource["
+000335d0: 7265 736f 7572 6365 5f6e 616d 6522 5d29  resource_name"])
+000335e0: 0a20 2020 2069 6620 6e6f 7420 6465 7073  .    if not deps
+000335f0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00033600: 2054 7275 650a 0a20 2020 2066 6f72 2064   True..    for d
+00033610: 6570 2069 6e20 6465 7073 3a0a 2020 2020  ep in deps:.    
+00033620: 2020 2020 7220 3d20 746f 5f72 756e 2e67      r = to_run.g
+00033630: 6574 2864 6570 2c20 4e6f 6e65 290a 2020  et(dep, None).  
+00033640: 2020 2020 2020 6966 2069 735f 656e 6470        if is_endp
+00033650: 6f69 6e74 2872 2920 6f72 2069 735f 6d61  oint(r) or is_ma
+00033660: 7465 7269 616c 697a 6564 2872 293a 0a20  terialized(r):. 
+00033670: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00033680: 6e20 4661 6c73 650a 0a20 2020 2072 6574  n False..    ret
+00033690: 7572 6e20 5472 7565 0a0a 0a64 6566 2067  urn True...def g
+000336a0: 6574 5f74 6172 6765 745f 6d61 7465 7269  et_target_materi
+000336b0: 616c 697a 6564 5f64 6174 615f 736f 7572  alized_data_sour
+000336c0: 6365 5f6e 616d 6528 7265 736f 7572 6365  ce_name(resource
+000336d0: 3a20 4f70 7469 6f6e 616c 5b44 6963 745b  : Optional[Dict[
+000336e0: 7374 722c 2041 6e79 5d5d 2920 2d3e 204f  str, Any]]) -> O
+000336f0: 7074 696f 6e61 6c5b 7374 725d 3a0a 2020  ptional[str]:.  
+00033700: 2020 6966 206e 6f74 2072 6573 6f75 7263    if not resourc
+00033710: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+00033720: 6e20 4e6f 6e65 0a0a 2020 2020 666f 7220  n None..    for 
+00033730: 6e6f 6465 2069 6e20 7265 736f 7572 6365  node in resource
+00033740: 2e67 6574 2822 6e6f 6465 7322 2c20 5b5d  .get("nodes", []
+00033750: 293a 0a20 2020 2020 2020 2023 2046 4958  ):.        # FIX
+00033760: 4d45 3a20 6874 7470 733a 2f2f 6769 746c  ME: https://gitl
+00033770: 6162 2e63 6f6d 2f74 696e 7962 6972 642f  ab.com/tinybird/
+00033780: 616e 616c 7974 6963 732f 2d2f 6973 7375  analytics/-/issu
+00033790: 6573 2f32 3339 310a 2020 2020 2020 2020  es/2391.        
+000337a0: 6966 206e 6f64 652e 6765 7428 2270 6172  if node.get("par
+000337b0: 616d 7322 2c20 7b7d 292e 6765 7428 2274  ams", {}).get("t
+000337c0: 7970 6522 2c20 2222 292e 6c6f 7765 7228  ype", "").lower(
+000337d0: 2920 3d3d 2050 6970 654e 6f64 6554 7970  ) == PipeNodeTyp
+000337e0: 6573 2e4d 4154 4552 4941 4c49 5a45 443a  es.MATERIALIZED:
+000337f0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00033800: 7572 6e20 6e6f 6465 2e67 6574 2822 7061  urn node.get("pa
+00033810: 7261 6d73 2229 5b22 6461 7461 736f 7572  rams")["datasour
+00033820: 6365 225d 2e73 706c 6974 2822 5f5f 7622  ce"].split("__v"
+00033830: 295b 305d 0a0a 2020 2020 7265 7475 726e  )[0]..    return
+00033840: 204e 6f6e 650a 0a0a 6465 6620 6973 5f64   None...def is_d
+00033850: 6174 6173 6f75 7263 6528 7265 736f 7572  atasource(resour
+00033860: 6365 3a20 4f70 7469 6f6e 616c 5b44 6963  ce: Optional[Dic
+00033870: 745b 7374 722c 2041 6e79 5d5d 2920 2d3e  t[str, Any]]) ->
+00033880: 2062 6f6f 6c3a 0a20 2020 2069 6620 7265   bool:.    if re
+00033890: 736f 7572 6365 2061 6e64 2072 6573 6f75  source and resou
+000338a0: 7263 652e 6765 7428 2272 6573 6f75 7263  rce.get("resourc
+000338b0: 6522 2920 3d3d 2022 6461 7461 736f 7572  e") == "datasour
+000338c0: 6365 7322 3a0a 2020 2020 2020 2020 7265  ces":.        re
+000338d0: 7475 726e 2054 7275 650a 2020 2020 7265  turn True.    re
+000338e0: 7475 726e 2046 616c 7365 0a0a 0a61 7379  turn False...asy
+000338f0: 6e63 2064 6566 2063 7265 6174 655f 7265  nc def create_re
+00033900: 6c65 6173 6528 0a20 2020 2063 6c69 656e  lease(.    clien
+00033910: 743a 2054 696e 7942 2c20 636f 6e66 6967  t: TinyB, config
+00033920: 3a20 556e 696f 6e5b 4469 6374 5b73 7472  : Union[Dict[str
+00033930: 2c20 416e 795d 2c20 434c 4943 6f6e 6669  , Any], CLIConfi
+00033940: 675d 2c20 7365 6d76 6572 3a20 7374 722c  g], semver: str,
+00033950: 2066 6f6c 6465 723a 204f 7074 696f 6e61   folder: Optiona
+00033960: 6c5b 7374 725d 203d 204e 6f6e 650a 2920  l[str] = None.) 
+00033970: 2d3e 204e 6f6e 653a 0a20 2020 2069 6620  -> None:.    if 
+00033980: 6e6f 7420 666f 6c64 6572 3a0a 2020 2020  not folder:.    
+00033990: 2020 2020 666f 6c64 6572 203d 2067 6574      folder = get
+000339a0: 6377 6428 290a 2020 2020 636c 695f 6769  cwd().    cli_gi
+000339b0: 745f 7265 6c65 6173 6520 3d20 4e6f 6e65  t_release = None
+000339c0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+000339d0: 2020 636c 695f 6769 745f 7265 6c65 6173    cli_git_releas
+000339e0: 6520 3d20 434c 4947 6974 5265 6c65 6173  e = CLIGitReleas
+000339f0: 6528 7061 7468 3d66 6f6c 6465 7229 0a20  e(path=folder). 
+00033a00: 2020 2020 2020 2063 6f6d 6d69 7420 3d20         commit = 
+00033a10: 636c 695f 6769 745f 7265 6c65 6173 652e  cli_git_release.
+00033a20: 6865 6164 5f63 6f6d 6d69 7428 290a 2020  head_commit().  
+00033a30: 2020 6578 6365 7074 2043 4c49 4769 7452    except CLIGitR
+00033a40: 656c 6561 7365 4578 6365 7074 696f 6e3a  eleaseException:
+00033a50: 0a20 2020 2020 2020 2072 6169 7365 2043  .        raise C
+00033a60: 4c49 4769 7452 656c 6561 7365 4578 6365  LIGitReleaseExce
+00033a70: 7074 696f 6e28 4665 6564 6261 636b 4d61  ption(FeedbackMa
+00033a80: 6e61 6765 722e 6572 726f 725f 6e6f 5f67  nager.error_no_g
+00033a90: 6974 5f72 6570 6f5f 666f 725f 696e 6974  it_repo_for_init
+00033aa0: 2872 6570 6f5f 7061 7468 3d66 6f6c 6465  (repo_path=folde
+00033ab0: 7229 290a 0a20 2020 2061 7761 6974 2063  r))..    await c
+00033ac0: 6c69 656e 742e 7265 6c65 6173 655f 6e65  lient.release_ne
+00033ad0: 7728 636f 6e66 6967 5b22 6964 225d 2c20  w(config["id"], 
+00033ae0: 7365 6d76 6572 2c20 636f 6d6d 6974 290a  semver, commit).
+00033af0: 2020 2020 636c 6963 6b2e 6563 686f 2846      click.echo(F
+00033b00: 6565 6462 6163 6b4d 616e 6167 6572 2e73  eedbackManager.s
+00033b10: 7563 6365 7373 5f64 6570 6c6f 796d 656e  uccess_deploymen
+00033b20: 745f 7265 6c65 6173 6528 7365 6d76 6572  t_release(semver
+00033b30: 3d73 656d 7665 7229 290a 0a0a 6465 6620  =semver))...def 
+00033b40: 6861 735f 696e 7465 726e 616c 5f64 6174  has_internal_dat
+00033b50: 6166 696c 6573 2866 6f6c 6465 723a 2073  afiles(folder: s
+00033b60: 7472 2920 2d3e 2062 6f6f 6c3a 0a20 2020  tr) -> bool:.   
+00033b70: 2066 6f6c 6465 7220 3d20 666f 6c64 6572   folder = folder
+00033b80: 206f 7220 222e 220a 2020 2020 6669 6c65   or ".".    file
+00033b90: 6e61 6d65 7320 3d20 6765 745f 7072 6f6a  names = get_proj
+00033ba0: 6563 745f 6669 6c65 6e61 6d65 7328 666f  ect_filenames(fo
+00033bb0: 6c64 6572 290a 2020 2020 7265 7475 726e  lder).    return
+00033bc0: 2061 6e79 285b 6620 666f 7220 6620 696e   any([f for f in
+00033bd0: 2066 696c 656e 616d 6573 2069 6620 2273   filenames if "s
+00033be0: 7061 6e73 2220 696e 2073 7472 2866 2920  pans" in str(f) 
+00033bf0: 616e 6420 2276 656e 646f 7222 206e 6f74  and "vendor" not
+00033c00: 2069 6e20 7374 7228 6629 5d29 0a0a 0a64   in str(f)])...d
+00033c10: 6566 2069 735f 6669 6c65 5f61 5f64 6174  ef is_file_a_dat
+00033c20: 6173 6f75 7263 6528 6669 6c65 6e61 6d65  asource(filename
+00033c30: 3a20 7374 7229 202d 3e20 626f 6f6c 3a0a  : str) -> bool:.
+00033c40: 2020 2020 6578 7465 6e73 696f 6e73 203d      extensions =
+00033c50: 2050 6174 6828 6669 6c65 6e61 6d65 292e   Path(filename).
+00033c60: 7375 6666 6978 6573 0a20 2020 2069 6620  suffixes.    if 
+00033c70: 222e 6461 7461 736f 7572 6365 2220 696e  ".datasource" in
+00033c80: 2065 7874 656e 7369 6f6e 733a 2020 2320   extensions:  # 
+00033c90: 4163 6365 7074 7320 272e 6461 7461 736f  Accepts '.dataso
+00033ca0: 7572 6365 2720 616e 6420 272e 6461 7461  urce' and '.data
+00033cb0: 736f 7572 6365 2e69 6e63 6c27 0a20 2020  source.incl'.   
+00033cc0: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+00033cd0: 0a0a 2020 2020 6966 2022 2e69 6e63 6c22  ..    if ".incl"
+00033ce0: 2069 6e20 6578 7465 6e73 696f 6e73 3a0a   in extensions:.
+00033cf0: 2020 2020 2020 2020 6c69 6e65 7320 3d20          lines = 
+00033d00: 5b5d 0a20 2020 2020 2020 2077 6974 6820  [].        with 
+00033d10: 6f70 656e 2866 696c 656e 616d 6529 2061  open(filename) a
+00033d20: 7320 6669 6c65 3a0a 2020 2020 2020 2020  s file:.        
+00033d30: 2020 2020 6c69 6e65 7320 3d20 6669 6c65      lines = file
+00033d40: 2e72 6561 646c 696e 6573 2829 0a0a 2020  .readlines()..  
+00033d50: 2020 2020 2020 666f 7220 6c69 6e65 2069        for line i
+00033d60: 6e20 6c69 6e65 733a 0a20 2020 2020 2020  n lines:.       
+00033d70: 2020 2020 2074 7269 6d6d 6564 5f6c 696e       trimmed_lin
+00033d80: 6520 3d20 6c69 6e65 2e73 7472 6970 2829  e = line.strip()
+00033d90: 2e6c 6f77 6572 2829 0a20 2020 2020 2020  .lower().       
+00033da0: 2020 2020 2069 6620 7472 696d 6d65 645f       if trimmed_
+00033db0: 6c69 6e65 2e73 7461 7274 7377 6974 6828  line.startswith(
+00033dc0: 2273 6368 656d 6122 2920 6f72 2074 7269  "schema") or tri
+00033dd0: 6d6d 6564 5f6c 696e 652e 7374 6172 7473  mmed_line.starts
+00033de0: 7769 7468 2822 656e 6769 6e65 2229 3a0a  with("engine"):.
+00033df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033e00: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+00033e10: 2072 6574 7572 6e20 4661 6c73 650a        return False.
```

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/datatypes.py` & `tinybird-cli-3.8.2.dev1/tinybird/datatypes.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/feedback_manager.py` & `tinybird-cli-3.8.2.dev1/tinybird/feedback_manager.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/git_settings.py` & `tinybird-cli-3.8.2.dev1/tinybird/git_settings.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/sql.py` & `tinybird-cli-3.8.2.dev1/tinybird/sql.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/sql_template.py` & `tinybird-cli-3.8.2.dev1/tinybird/sql_template.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/sql_template_fmt.py` & `tinybird-cli-3.8.2.dev1/tinybird/sql_template_fmt.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/sql_toolset.py` & `tinybird-cli-3.8.2.dev1/tinybird/sql_toolset.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/syncasync.py` & `tinybird-cli-3.8.2.dev1/tinybird/syncasync.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/auth.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/auth.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/branch.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/branch.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/cicd.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/cicd.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/cli.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/cli.py`

 * *Files 1% similar despite different names*

```diff
@@ -793,17 +793,17 @@
     result = ""
     failed = []
     for filename in filenames:
         if not diff:
             click.echo(filename)
         extensions = Path(filename).suffixes
         if is_file_a_datasource(filename):
-            result = await format_datasource(filename)
+            result = await format_datasource(filename, skip_eval=True)
         elif (".pipe" in extensions) or (".incl" in extensions):
-            result = await format_pipe(filename, line_length)
+            result = await format_pipe(filename, line_length, skip_eval=True)
         else:
             click.echo("Unsupported file type. Supported files types are: .pipe, .incl and .datasource")
             return None
 
         if diff:
             result = result.rstrip("\n")
             lines_fmt = [f"{line}\n" for line in result.split("\n")]
```

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/common.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/common.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/config.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/config.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/connection.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/connection.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/datasource.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/datasource.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/exceptions.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/exceptions.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/job.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/job.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/pipe.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/pipe.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/regions.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/regions.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/telemetry.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/telemetry.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/test.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/test.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/tinyunit/tinyunit.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/tinyunit/tinyunit.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/tinyunit/tinyunit_lib.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/tinyunit/tinyunit_lib.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/token.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/token.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/workspace.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/workspace.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tb_cli_modules/workspace_members.py` & `tinybird-cli-3.8.2.dev1/tinybird/tb_cli_modules/workspace_members.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird/tornado_template.py` & `tinybird-cli-3.8.2.dev1/tinybird/tornado_template.py`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/PKG-INFO` & `tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: tinybird-cli
-Version: 3.8.1.dev1
+Version: 3.8.2.dev1
 Summary: Tinybird Command Line Tool
 Home-page: https://www.tinybird.co/docs/cli/introduction.html
 Author: Tinybird
 Author-email: support@tinybird.co
 Requires-Python: >=3.8, <3.12
 Description-Content-Type: text/x-rst
 Provides-Extra: bigquery
@@ -15,14 +15,20 @@
 
 The Tinybird command-line tool allows you to use all the Tinybird functionality directly from the command line. Additionally, it includes several functions to create and manage data projects easily.
 
 Changelog
 
 ---------
 
+3.8.1
+************
+
+- `Fixed` Avoid system vars evaluation when doing `tb fmt`
+- `Fixed` environment variables substitution for Data Source engine parameters.
+
 3.8.0
 ************
 
 - `Added` Support for S3IAM role for ingest
 - `Changed` Upgrade clickhouse-toolset to 0.30dev0
 - `Changed` Decouple cli from connector_settings module
```

### Comparing `tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/SOURCES.txt` & `tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `tinybird-cli-3.8.1.dev1/tinybird_cli.egg-info/requires.txt` & `tinybird-cli-3.8.2.dev1/tinybird_cli.egg-info/requires.txt`

 * *Files identical despite different names*

